# =============================================================================
# Render Blueprint - Jorss-GBO Tax Platform
# =============================================================================
# Deploy with: https://render.com/deploy
#
# This uses FREE tier resources:
# - Web Service: Free (sleeps after 15 min inactivity)
# - Database: Use external Neon (permanent free tier)
# - Redis: Use external Upstash (free tier)
#
# After deploy, set these in the Render dashboard:
#   DATABASE_URL   — Neon PostgreSQL connection string (sslmode=require)
#   REDIS_URL      — Upstash Redis URL (rediss:// for TLS)
#   OPENAI_API_KEY — OpenAI API key for AI features
#   CORS_ORIGINS   — Your production domain(s), comma-separated
#   SENDGRID_API_KEY — SendGrid API key for email notifications
#   SENTRY_DSN     — Sentry DSN for error tracking
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Main Web Application
  # ---------------------------------------------------------------------------
  - type: web
    name: jorss-gbo
    runtime: python
    region: oregon
    plan: free

    # Build configuration
    buildCommand: chmod +x scripts/build.sh && ./scripts/build.sh

    # Start command — PYTHONPATH=src is required for internal imports
    startCommand: >-
      PYTHONPATH=src gunicorn src.web.app:app
      --bind 0.0.0.0:$PORT
      --workers ${WORKERS:-2}
      --worker-class uvicorn.workers.UvicornWorker
      --timeout 120
      --keep-alive 5

    # Health check
    healthCheckPath: /api/health

    # Environment variables
    envVars:
      # ----- Core Application -----
      - key: APP_ENVIRONMENT
        value: production
      - key: ENVIRONMENT
        value: production
      - key: PYTHONUNBUFFERED
        value: "1"
      - key: PYTHONPATH
        value: src
      - key: LOG_LEVEL
        value: INFO

      # ----- Auth & Database Mode -----
      - key: AUTH_USE_DATABASE
        value: "true"
      - key: SESSION_STORAGE_TYPE
        value: redis

      # ----- Security Enforcement -----
      - key: APP_ENFORCE_HTTPS
        value: "true"
      - key: APP_ENABLE_RATE_LIMITING
        value: "true"

      # ----- Feature Flags -----
      - key: UNIFIED_FILING
        value: "true"
      - key: DB_PERSISTENCE
        value: "true"
      - key: NEW_LANDING
        value: "true"
      - key: APP_ENABLE_CACHING
        value: "true"
      - key: APP_ENABLE_BACKGROUND_TASKS
        value: "true"
      - key: AI_CHAT_ENABLED
        value: "true"
      - key: AI_SAFETY_CHECKS
        value: "true"

      # ----- Database — Neon PostgreSQL (set in dashboard) -----
      - key: DATABASE_URL
        sync: false

      # ----- Redis — Upstash (set in dashboard) -----
      - key: REDIS_URL
        sync: false

      # ----- CORS (set in dashboard: https://yourdomain.com) -----
      - key: CORS_ORIGINS
        sync: false

      # ----- Security Secrets (auto-generated by Render) -----
      - key: APP_SECRET_KEY
        generateValue: true
      - key: JWT_SECRET
        generateValue: true
      - key: CSRF_SECRET_KEY
        generateValue: true
      - key: ENCRYPTION_MASTER_KEY
        generateValue: true
      - key: SSN_HASH_SECRET
        generateValue: true
      - key: AUTH_SECRET_KEY
        generateValue: true
      - key: PASSWORD_SALT
        generateValue: true
      - key: SERIALIZER_SECRET_KEY
        generateValue: true
      - key: AUDIT_HMAC_KEY
        generateValue: true

      # ----- External Services (set in dashboard) -----
      - key: OPENAI_API_KEY
        sync: false
      - key: SENTRY_DSN
        sync: false
      - key: SENDGRID_API_KEY
        sync: false

      # ----- Branding (customize in dashboard) -----
      - key: PLATFORM_NAME
        value: "Tax Platform"
      - key: COMPANY_NAME
        value: "Your Company"
      - key: SUPPORT_EMAIL
        value: "support@example.com"
