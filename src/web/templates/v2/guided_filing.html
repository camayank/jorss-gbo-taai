{% extends 'v2/base.html' %}
{% from 'macros/icons.html' import icon %}

{% block title %}Guided Tax Filing{% endblock %}
{% block meta_description %}Complete your tax return step by step with our guided filing wizard.{% endblock %}

{% block extra_styles %}
<style>
  /* Override base page styles for full-height wizard */
  .page-main {
    padding: 0;
    display: flex;
    flex-direction: column;
    min-height: calc(100vh - var(--header-height, 64px));
  }

  .guided-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--color-gray-50);
  }

  /* Progress Header */
  .guided-header {
    background: white;
    border-bottom: 1px solid var(--color-gray-200);
    padding: var(--space-4) 0;
    position: sticky;
    top: 64px;
    z-index: var(--z-sticky);
  }

  .progress-wrapper {
    height: 4px;
    background: var(--color-gray-200);
    border-radius: var(--radius-full);
    margin-bottom: var(--space-4);
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary-500), var(--color-accent-500));
    border-radius: var(--radius-full);
    transition: width 0.3s ease;
  }

  .step-indicators {
    display: flex;
    justify-content: space-between;
    gap: var(--space-2);
  }

  .step-indicator {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    color: var(--color-gray-400);
    transition: color var(--transition-fast);
  }

  .step-indicator.completed {
    color: var(--color-success-600);
  }

  .step-indicator.active {
    color: var(--color-primary-600);
    font-weight: var(--font-semibold);
  }

  .step-number {
    width: 28px;
    height: 28px;
    border-radius: var(--radius-full);
    background: var(--color-gray-200);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: var(--font-semibold);
    font-size: var(--text-sm);
    transition: all var(--transition-fast);
  }

  .step-indicator.completed .step-number {
    background: var(--color-success-500);
    color: white;
  }

  .step-indicator.active .step-number {
    background: var(--color-primary-500);
    color: white;
  }

  /* Main Content */
  .guided-main {
    flex: 1;
    padding: var(--space-8) var(--space-4);
  }

  .step-section {
    max-width: 700px;
    margin: 0 auto;
  }

  .step-title {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--color-gray-900);
    margin-bottom: var(--space-2);
  }

  .step-subtitle {
    font-size: var(--text-base);
    color: var(--color-gray-600);
    margin-bottom: var(--space-8);
  }

  /* Form Styles */
  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .form-group label {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--color-gray-700);
  }

  .form-group input,
  .form-group select {
    padding: var(--space-3);
    border: 1px solid var(--color-gray-300);
    border-radius: var(--radius-lg);
    font-size: var(--text-base);
    transition: all var(--transition-fast);
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--color-primary-500);
    box-shadow: 0 0 0 3px var(--color-primary-100);
  }

  .help-text {
    font-size: var(--text-xs);
    color: var(--color-gray-500);
  }

  /* Option Cards (Filing Status, etc.) */
  .option-cards {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .option-card {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-4);
    background: white;
    border: 2px solid var(--color-gray-200);
    border-radius: var(--radius-xl);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .option-card:hover {
    border-color: var(--color-primary-300);
  }

  .option-card.selected {
    border-color: var(--color-primary-500);
    background: var(--color-primary-50);
  }

  .option-icon {
    font-size: var(--text-2xl);
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-gray-100);
    border-radius: var(--radius-lg);
  }

  .option-card.selected .option-icon {
    background: var(--color-primary-100);
  }

  .option-content {
    flex: 1;
  }

  .option-content h3 {
    font-weight: var(--font-semibold);
    color: var(--color-gray-900);
    margin-bottom: var(--space-1);
  }

  .option-content p {
    font-size: var(--text-sm);
    color: var(--color-gray-600);
  }

  .option-check {
    width: 24px;
    height: 24px;
    background: var(--color-primary-500);
    color: white;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: var(--font-bold);
  }

  /* Checkbox Grid (Income Types) */
  .checkbox-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-3);
  }

  .checkbox-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-4);
    background: white;
    border: 2px solid var(--color-gray-200);
    border-radius: var(--radius-xl);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-align: center;
  }

  .checkbox-card input {
    display: none;
  }

  .checkbox-card.selected {
    border-color: var(--color-primary-500);
    background: var(--color-primary-50);
  }

  .checkbox-icon {
    font-size: var(--text-2xl);
    margin-bottom: var(--space-2);
  }

  .checkbox-label {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--color-gray-700);
  }

  /* Income/Deduction Details */
  .income-details,
  .itemized-details {
    margin-top: var(--space-6);
    padding: var(--space-5);
    background: white;
    border-radius: var(--radius-xl);
    border: 1px solid var(--color-gray-200);
  }

  .income-details h3,
  .itemized-details h3 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    margin-bottom: var(--space-4);
  }

  /* Deduction Choice */
  .deduction-choice {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  .deduction-choice .option-card {
    flex-direction: column;
    text-align: center;
  }

  .deduction-choice .amount {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--color-primary-600);
    margin: var(--space-2) 0;
  }

  /* Credit Cards */
  .credit-cards {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
  }

  .credit-card {
    padding: var(--space-5);
    background: white;
    border: 2px solid var(--color-gray-200);
    border-radius: var(--radius-xl);
    transition: all var(--transition-fast);
  }

  .credit-card.selected {
    border-color: var(--color-success-500);
    background: var(--color-success-50);
  }

  .credit-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-2);
  }

  .credit-icon {
    font-size: var(--text-xl);
  }

  .credit-header h3 {
    font-weight: var(--font-semibold);
  }

  .credit-value {
    font-size: var(--text-sm);
    color: var(--color-success-600);
    margin: var(--space-2) 0;
  }

  /* Review Summary */
  .review-summary {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-6);
  }

  .summary-card {
    background: white;
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    box-shadow: var(--shadow-md);
  }

  .summary-card h3 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    margin-bottom: var(--space-4);
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    padding: var(--space-3) 0;
    border-bottom: 1px solid var(--color-gray-100);
  }

  .summary-row:last-child {
    border-bottom: none;
  }

  .summary-row.highlight {
    font-weight: var(--font-semibold);
    font-size: var(--text-lg);
  }

  .summary-row.refund .amount {
    color: var(--color-success-600);
  }

  .summary-row.owe .amount {
    color: var(--color-error-600);
  }

  .review-sections {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .review-section {
    padding: var(--space-4);
    background: white;
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-gray-200);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .review-section:hover {
    border-color: var(--color-primary-300);
  }

  .review-section h4 {
    font-weight: var(--font-medium);
    color: var(--color-gray-900);
  }

  .review-section p {
    font-size: var(--text-sm);
    color: var(--color-gray-600);
  }

  .edit-link {
    color: var(--color-primary-600);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
  }

  /* Complete Section */
  .complete-section {
    text-align: center;
    padding: var(--space-12) 0;
  }

  .success-icon {
    width: 80px;
    height: 80px;
    background: var(--color-success-500);
    color: white;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-4xl);
    margin: 0 auto var(--space-6);
  }

  .action-cards {
    display: flex;
    gap: var(--space-4);
    justify-content: center;
    margin-top: var(--space-8);
  }

  .action-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-6) var(--space-8);
    background: white;
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-xl);
    text-decoration: none;
    color: var(--color-gray-900);
    transition: all var(--transition-fast);
  }

  .action-card:hover {
    border-color: var(--color-primary-500);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .action-icon {
    font-size: var(--text-2xl);
  }

  /* Loading State */
  .loading-state {
    text-align: center;
    padding: var(--space-12) 0;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-gray-200);
    border-top-color: var(--color-primary-500);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto var(--space-4);
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Footer Navigation */
  .guided-footer {
    background: white;
    border-top: 1px solid var(--color-gray-200);
    padding: var(--space-4) 0;
    position: sticky;
    bottom: 0;
  }

  .guided-footer .container {
    max-width: 700px;
    margin: 0 auto;
    padding: 0 var(--space-4);
    display: flex;
    justify-content: space-between;
    gap: var(--space-4);
  }

  .guided-footer .btn {
    min-width: 140px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .form-grid,
    .deduction-choice,
    .credit-cards,
    .review-summary {
      grid-template-columns: 1fr;
    }

    .checkbox-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .step-label {
      display: none;
    }

    .action-cards {
      flex-direction: column;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="guided-container" x-data="guidedFiling()">
  <!-- Progress Header -->
  <header class="guided-header">
    <div class="container" style="max-width: 900px; margin: 0 auto; padding: 0 var(--space-4);">
      <div class="progress-wrapper">
        <div class="progress-bar" :style="`width: ${progressPercent}%`"></div>
      </div>
      <div class="step-indicators">
        <template x-for="(step, index) in steps" :key="step.id">
          <div class="step-indicator"
               :class="{
                 'completed': index < currentStepIndex,
                 'active': index === currentStepIndex,
                 'upcoming': index > currentStepIndex
               }">
            <span class="step-number">
              <template x-if="index < currentStepIndex">{{ icon('check') }}</template>
              <template x-if="index >= currentStepIndex" x-text="index + 1"></template>
            </span>
            <span class="step-label" x-text="step.label"></span>
          </div>
        </template>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="guided-main">
    <div class="step-content" x-show="!loading">

      <!-- Step: Personal Information -->
      <template x-if="currentStep.id === 'personal'">
        <div class="step-section">
          <h1 class="step-title">Let's start with your personal information</h1>
          <p class="step-subtitle">This helps us identify you on your tax return.</p>

          <div class="form-grid">
            <div class="form-group">
              <label for="firstName">First Name</label>
              <input type="text" id="firstName" x-model="formData.personal.firstName"
                     placeholder="Enter your first name" required>
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input type="text" id="lastName" x-model="formData.personal.lastName"
                     placeholder="Enter your last name" required>
            </div>
            <div class="form-group">
              <label for="ssn">Social Security Number</label>
              <input type="text" id="ssn" x-model="formData.personal.ssn"
                     placeholder="XXX-XX-XXXX" maxlength="11"
                     @input="formatSSN($event)">
              <span class="help-text">{{ icon('lock-closed') }} Your SSN is encrypted and never shared.</span>
            </div>
            <div class="form-group">
              <label for="dob">Date of Birth</label>
              <input type="date" id="dob" x-model="formData.personal.dateOfBirth">
            </div>
          </div>
        </div>
      </template>

      <!-- Step: Filing Status -->
      <template x-if="currentStep.id === 'filing_status'">
        <div class="step-section">
          <h1 class="step-title">What's your filing status?</h1>
          <p class="step-subtitle">This affects your tax brackets and standard deduction.</p>

          <div class="option-cards">
            <template x-for="status in filingStatuses" :key="status.value">
              <div class="option-card"
                   :class="{ 'selected': formData.filingStatus === status.value }"
                   @click="formData.filingStatus = status.value">
                <div class="option-icon" x-text="status.icon"></div>
                <div class="option-content">
                  <h3 x-text="status.label"></h3>
                  <p x-text="status.description"></p>
                </div>
                <div class="option-check" x-show="formData.filingStatus === status.value">{{ icon('check') }}</div>
              </div>
            </template>
          </div>
        </div>
      </template>

      <!-- Step: Income -->
      <template x-if="currentStep.id === 'income'">
        <div class="step-section">
          <h1 class="step-title">Tell us about your income</h1>
          <p class="step-subtitle">Select all types of income you received this year.</p>

          <div class="checkbox-grid">
            <template x-for="income in incomeTypes" :key="income.value">
              <label class="checkbox-card"
                     :class="{ 'selected': formData.incomeTypes.includes(income.value) }">
                <input type="checkbox" :value="income.value" x-model="formData.incomeTypes">
                <span class="checkbox-icon" x-text="income.icon"></span>
                <span class="checkbox-label" x-text="income.label"></span>
              </label>
            </template>
          </div>

          <!-- W-2 Income Details -->
          <template x-if="formData.incomeTypes.includes('w2')">
            <div class="income-details">
              <h3>{{ icon('briefcase') }} W-2 Wage Income</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label>Employer Name</label>
                  <input type="text" x-model="formData.income.w2.employerName" placeholder="Company name">
                </div>
                <div class="form-group">
                  <label>Wages (Box 1)</label>
                  <input type="text" x-model="formData.income.w2.wages" @input="formatCurrency($event)" placeholder="$0.00">
                </div>
                <div class="form-group">
                  <label>Federal Tax Withheld (Box 2)</label>
                  <input type="text" x-model="formData.income.w2.federalWithheld" @input="formatCurrency($event)" placeholder="$0.00">
                </div>
              </div>
            </div>
          </template>
        </div>
      </template>

      <!-- Step: Deductions -->
      <template x-if="currentStep.id === 'deductions'">
        <div class="step-section">
          <h1 class="step-title">Do you want to itemize deductions?</h1>
          <p class="step-subtitle">We'll compare to the standard deduction and recommend the best option.</p>

          <div class="deduction-choice">
            <div class="option-card"
                 :class="{ 'selected': formData.deductionMethod === 'standard' }"
                 @click="formData.deductionMethod = 'standard'">
              <h3>Standard Deduction</h3>
              <p class="amount" x-text="'$' + standardDeduction.toLocaleString()"></p>
              <p>Quick and easy - recommended for most filers.</p>
            </div>
            <div class="option-card"
                 :class="{ 'selected': formData.deductionMethod === 'itemized' }"
                 @click="formData.deductionMethod = 'itemized'">
              <h3>Itemize Deductions</h3>
              <p class="amount">Calculate</p>
              <p>If you have significant deductible expenses.</p>
            </div>
          </div>

          <template x-if="formData.deductionMethod === 'itemized'">
            <div class="itemized-details">
              <h3>Enter your deductible expenses</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label>Mortgage Interest</label>
                  <input type="text" x-model="formData.deductions.mortgageInterest" @input="formatCurrency($event)">
                </div>
                <div class="form-group">
                  <label>State & Local Taxes (SALT)</label>
                  <input type="text" x-model="formData.deductions.salt" @input="formatCurrency($event)">
                  <span class="help-text">Limited to $10,000</span>
                </div>
                <div class="form-group">
                  <label>Charitable Contributions</label>
                  <input type="text" x-model="formData.deductions.charitable" @input="formatCurrency($event)">
                </div>
                <div class="form-group">
                  <label>Medical Expenses</label>
                  <input type="text" x-model="formData.deductions.medical" @input="formatCurrency($event)">
                  <span class="help-text">Only amounts exceeding 7.5% of AGI</span>
                </div>
              </div>
            </div>
          </template>
        </div>
      </template>

      <!-- Step: Credits -->
      <template x-if="currentStep.id === 'credits'">
        <div class="step-section">
          <h1 class="step-title">Check for tax credits you may qualify for</h1>
          <p class="step-subtitle">Credits directly reduce your tax bill.</p>

          <div class="credit-cards">
            <template x-for="credit in availableCredits" :key="credit.id">
              <div class="credit-card" :class="{ 'selected': formData.credits[credit.id]?.claimed }">
                <div class="credit-header">
                  <span class="credit-icon" x-text="credit.icon"></span>
                  <h3 x-text="credit.name"></h3>
                </div>
                <p x-text="credit.description"></p>
                <p class="credit-value">Worth up to <strong x-text="'$' + credit.maxValue.toLocaleString()"></strong></p>
                <button class="btn btn-sm" :class="formData.credits[credit.id]?.claimed ? 'btn-secondary' : 'btn-primary'"
                        @click="toggleCredit(credit.id)"
                        x-text="formData.credits[credit.id]?.claimed ? 'Remove' : 'Add'">
                </button>
              </div>
            </template>
          </div>
        </div>
      </template>

      <!-- Step: Review -->
      <template x-if="currentStep.id === 'review'">
        <div class="step-section">
          <h1 class="step-title">Review your tax return</h1>
          <p class="step-subtitle">Please verify all information is correct before submitting.</p>

          <div class="review-summary">
            <div class="summary-card">
              <h3>Your Tax Summary</h3>
              <div class="summary-row">
                <span>Total Income</span>
                <span class="amount" x-text="'$' + calculateTotalIncome().toLocaleString()"></span>
              </div>
              <div class="summary-row">
                <span>Deductions</span>
                <span class="amount" x-text="'-$' + calculateDeductions().toLocaleString()"></span>
              </div>
              <div class="summary-row">
                <span>Taxable Income</span>
                <span class="amount" x-text="'$' + calculateTaxableIncome().toLocaleString()"></span>
              </div>
              <hr style="margin: var(--space-2) 0;">
              <div class="summary-row highlight">
                <span>Estimated Tax</span>
                <span class="amount" x-text="'$' + calculateTax().toLocaleString()"></span>
              </div>
              <div class="summary-row" :class="{ 'refund': calculateRefund() > 0, 'owe': calculateRefund() < 0 }">
                <span x-text="calculateRefund() >= 0 ? 'Estimated Refund' : 'Amount Owed'"></span>
                <span class="amount" x-text="'$' + Math.abs(calculateRefund()).toLocaleString()"></span>
              </div>
            </div>

            <div class="review-sections">
              <div class="review-section" @click="goToStep('personal')">
                <div>
                  <h4>Personal Information</h4>
                  <p x-text="formData.personal.firstName + ' ' + formData.personal.lastName"></p>
                </div>
                <span class="edit-link">Edit {{ icon('pencil') }}</span>
              </div>
              <div class="review-section" @click="goToStep('filing_status')">
                <div>
                  <h4>Filing Status</h4>
                  <p x-text="getFilingStatusLabel()"></p>
                </div>
                <span class="edit-link">Edit {{ icon('pencil') }}</span>
              </div>
              <div class="review-section" @click="goToStep('income')">
                <div>
                  <h4>Income</h4>
                  <p x-text="formData.incomeTypes.length + ' income source(s)'"></p>
                </div>
                <span class="edit-link">Edit {{ icon('pencil') }}</span>
              </div>
            </div>
          </div>
        </div>
      </template>

      <!-- Step: Complete -->
      <template x-if="currentStep.id === 'complete'">
        <div class="step-section complete-section">
          <div class="success-icon">{{ icon('check') }}</div>
          <h1 class="step-title">Your return is ready!</h1>
          <p class="step-subtitle">Your tax return has been prepared and is ready for review by your CPA.</p>

          <div class="action-cards">
            <a href="/api/filing/{{ session_id }}/export/pdf" class="action-card" download>
              <span class="action-icon">{{ icon('document-arrow-down') }}</span>
              <span>Download PDF</span>
            </a>
            <a href="/cpa/review" class="action-card">
              <span class="action-icon">{{ icon('eye') }}</span>
              <span>View in CPA Portal</span>
            </a>
          </div>
        </div>
      </template>
    </div>

    <!-- Loading State -->
    <div class="loading-state" x-show="loading">
      <div class="spinner"></div>
      <p>Saving your progress...</p>
    </div>
  </main>

  <!-- Navigation Footer -->
  <footer class="guided-footer" x-show="currentStep.id !== 'complete'">
    <div class="container">
      <button class="btn btn-secondary" @click="previousStep()" :disabled="currentStepIndex === 0">
        {{ icon('arrow-left') }} Back
      </button>
      <button class="btn btn-primary" @click="nextStep()" :disabled="!canProceed">
        <span x-text="currentStep.id === 'review' ? 'Submit Return' : 'Continue'"></span>
        {{ icon('arrow-right') }}
      </button>
    </div>
  </footer>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Alpine.js -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<script>
function guidedFiling() {
  return {
    loading: false,
    sessionId: '{{ session_id | default("") }}',
    currentStepIndex: 0,

    steps: [
      { id: 'personal', label: 'Personal Info' },
      { id: 'filing_status', label: 'Filing Status' },
      { id: 'income', label: 'Income' },
      { id: 'deductions', label: 'Deductions' },
      { id: 'credits', label: 'Credits' },
      { id: 'review', label: 'Review' },
      { id: 'complete', label: 'Complete' }
    ],

    formData: {
      personal: { firstName: '', lastName: '', ssn: '', dateOfBirth: '' },
      filingStatus: '',
      incomeTypes: [],
      income: {
        w2: { employerName: '', wages: '', federalWithheld: '' },
        selfEmployment: { grossIncome: '', expenses: '' },
        investments: { dividends: '', capitalGains: '' }
      },
      deductionMethod: 'standard',
      deductions: { mortgageInterest: '', salt: '', charitable: '', medical: '' },
      credits: {}
    },

    filingStatuses: [
      { value: 'single', label: 'Single', icon: 'ðŸ‘¤', description: 'Unmarried or legally separated' },
      { value: 'mfj', label: 'Married Filing Jointly', icon: 'ðŸ‘«', description: 'Married and filing together' },
      { value: 'mfs', label: 'Married Filing Separately', icon: 'â†”ï¸', description: 'Married but filing separate returns' },
      { value: 'hoh', label: 'Head of Household', icon: 'ðŸ ', description: 'Unmarried with qualifying dependent' },
      { value: 'qw', label: 'Qualifying Widow(er)', icon: 'ðŸ¤²', description: 'Spouse died within past 2 years' }
    ],

    incomeTypes: [
      { value: 'w2', label: 'W-2 Wages', icon: 'ðŸ’¼' },
      { value: 'self_employment', label: 'Self-Employment', icon: 'ðŸ¢' },
      { value: '1099_int', label: 'Interest (1099-INT)', icon: 'ðŸ¦' },
      { value: '1099_div', label: 'Dividends (1099-DIV)', icon: 'ðŸ“ˆ' },
      { value: '1099_misc', label: 'Other Income (1099)', icon: 'ðŸ“„' },
      { value: 'rental', label: 'Rental Income', icon: 'ðŸ˜ï¸' }
    ],

    availableCredits: [
      { id: 'eitc', name: 'Earned Income Tax Credit', icon: 'ðŸ’µ', description: 'For low-to-moderate income workers', maxValue: 7430 },
      { id: 'ctc', name: 'Child Tax Credit', icon: 'ðŸ‘¶', description: 'Per qualifying child under 17', maxValue: 2000 },
      { id: 'aotc', name: 'American Opportunity Credit', icon: 'ðŸŽ“', description: 'For college education expenses', maxValue: 2500 },
      { id: 'savers', name: "Saver's Credit", icon: 'ðŸ¦', description: 'For retirement contributions', maxValue: 1000 }
    ],

    get currentStep() { return this.steps[this.currentStepIndex]; },
    get progressPercent() { return ((this.currentStepIndex) / (this.steps.length - 1)) * 100; },
    get standardDeduction() {
      const deductions = { single: 14600, mfj: 29200, mfs: 14600, hoh: 21900, qw: 29200 };
      return deductions[this.formData.filingStatus] || 14600;
    },
    get canProceed() {
      const step = this.currentStep.id;
      if (step === 'personal') return this.formData.personal.firstName && this.formData.personal.lastName;
      if (step === 'filing_status') return this.formData.filingStatus;
      return true;
    },

    formatSSN(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 3) value = value.slice(0, 3) + '-' + value.slice(3);
      if (value.length > 6) value = value.slice(0, 6) + '-' + value.slice(6);
      e.target.value = value.slice(0, 11);
      this.formData.personal.ssn = e.target.value;
    },

    formatCurrency(e) {
      let value = e.target.value.replace(/[^\d.]/g, '');
      if (value) {
        const num = parseFloat(value);
        e.target.value = isNaN(num) ? '' : '$' + num.toLocaleString();
      }
    },

    async nextStep() {
      if (this.currentStepIndex < this.steps.length - 1) {
        this.loading = true;
        await this.saveProgress();
        this.currentStepIndex++;
        this.loading = false;
        window.scrollTo(0, 0);
      }
    },

    previousStep() {
      if (this.currentStepIndex > 0) {
        this.currentStepIndex--;
        window.scrollTo(0, 0);
      }
    },

    goToStep(stepId) {
      const index = this.steps.findIndex(s => s.id === stepId);
      if (index >= 0 && index < this.currentStepIndex) this.currentStepIndex = index;
    },

    toggleCredit(creditId) {
      if (!this.formData.credits[creditId]) {
        this.formData.credits[creditId] = { claimed: true };
      } else {
        this.formData.credits[creditId].claimed = !this.formData.credits[creditId].claimed;
      }
    },

    getFilingStatusLabel() {
      const status = this.filingStatuses.find(s => s.value === this.formData.filingStatus);
      return status ? status.label : 'Not selected';
    },

    calculateTotalIncome() {
      let total = 0;
      if (this.formData.income.w2.wages) {
        total += parseFloat(this.formData.income.w2.wages.replace(/[^\d.]/g, '')) || 0;
      }
      return total;
    },

    calculateDeductions() {
      if (this.formData.deductionMethod === 'standard') return this.standardDeduction;
      let total = 0;
      for (const key in this.formData.deductions) {
        const val = this.formData.deductions[key];
        if (val) total += parseFloat(val.replace(/[^\d.]/g, '')) || 0;
      }
      return Math.max(total, this.standardDeduction);
    },

    calculateTaxableIncome() { return Math.max(0, this.calculateTotalIncome() - this.calculateDeductions()); },

    calculateTax() {
      const income = this.calculateTaxableIncome();
      if (income <= 11600) return income * 0.10;
      if (income <= 47150) return 1160 + (income - 11600) * 0.12;
      if (income <= 100525) return 5426 + (income - 47150) * 0.22;
      return 17168.50 + (income - 100525) * 0.24;
    },

    calculateRefund() {
      const tax = this.calculateTax();
      const withheld = parseFloat((this.formData.income.w2.federalWithheld || '').replace(/[^\d.]/g, '')) || 0;
      return withheld - tax;
    },

    async saveProgress() {
      if (!this.sessionId) return;
      try {
        await fetch(`/api/filing/guided/${this.sessionId}/progress`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ step: this.currentStep.id, data: this.formData, ux_version: 'v2' })
        });
      } catch (e) { console.error('Failed to save progress:', e); }
    },

    async init() {
      if (this.sessionId) {
        try {
          const response = await fetch(`/api/filing/guided/${this.sessionId}/progress`);
          if (response.ok) {
            const data = await response.json();
            if (data.formData) this.formData = { ...this.formData, ...data.formData };
            if (data.currentStep) {
              const index = this.steps.findIndex(s => s.id === data.currentStep);
              if (index >= 0) this.currentStepIndex = index;
            }
          }
        } catch (e) { console.error('Failed to load progress:', e); }
      }
    }
  };
}
</script>
{% endblock %}
