{% extends 'cpa/base.html' %}
{% from 'macros/icons.html' import icon %}
{% from 'components/layout/card.html' import card, stat_card %}
{% from 'components/feedback/alert.html' import alert %}

{% block title %}CPA Workspace{% endblock %}

{% block meta_description %}CPA Workspace for managing tax clients and decisions{% endblock %}

{% block extra_styles %}
<style>
  /* CPA Dashboard specific styles using design system tokens */
  .dashboard-header {
    background: var(--card-bg);
    border-bottom: 1px solid var(--border-color);
    padding: var(--space-4) var(--space-6);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: var(--z-sticky);
  }

  .dashboard-logo {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .dashboard-logo-icon {
    width: 40px;
    height: 40px;
    background: var(--color-primary-500);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: var(--font-bold);
    font-size: var(--text-lg);
  }

  .dashboard-logo-text {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
  }

  .dashboard-logo-subtitle {
    font-size: var(--text-xs);
    color: var(--text-tertiary);
    font-weight: var(--font-medium);
  }

  .dashboard-actions {
    display: flex;
    align-items: center;
    gap: var(--space-4);
  }

  .preparer-name {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    font-weight: var(--font-medium);
  }

  /* Main Content */
  .dashboard-main {
    max-width: 1400px;
    margin: 0 auto;
    padding: var(--space-6);
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .stat-card {
    background: var(--card-bg);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
  }

  .stat-label {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
    font-weight: var(--font-medium);
    margin-bottom: var(--space-2);
  }

  .stat-value {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    color: var(--text-primary);
  }

  .stat-value.success { color: var(--color-success-500); }
  .stat-value.warning { color: var(--color-warning-500); }

  /* Controls Bar */
  .controls-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-4);
    gap: var(--space-4);
    flex-wrap: wrap;
  }

  .search-box {
    display: flex;
    align-items: center;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--space-2) var(--space-3);
    width: 300px;
  }

  .search-box input {
    border: none;
    outline: none;
    font-size: var(--text-sm);
    width: 100%;
    background: transparent;
    color: var(--text-primary);
  }

  .search-box input::placeholder {
    color: var(--text-muted);
  }

  .search-icon {
    color: var(--text-muted);
    margin-right: var(--space-2);
    flex-shrink: 0;
  }

  /* Client Table */
  .client-table-container {
    background: var(--card-bg);
    border-radius: var(--radius-xl);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }

  .client-table {
    width: 100%;
    border-collapse: collapse;
  }

  .client-table th,
  .client-table td {
    padding: var(--space-3) var(--space-4);
    text-align: left;
    border-bottom: 1px solid var(--border-color);
  }

  .client-table th {
    background: var(--color-gray-50);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wide);
  }

  .client-table tbody tr {
    transition: background var(--transition-fast);
  }

  .client-table tbody tr:hover {
    background: var(--color-gray-50);
  }

  .client-table tbody tr:last-child td {
    border-bottom: none;
  }

  .client-name {
    font-weight: var(--font-semibold);
    color: var(--text-primary);
  }

  .client-email {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
  }

  .client-id {
    font-size: var(--text-sm);
    color: var(--text-muted);
    font-family: var(--font-mono);
  }

  /* Status Badge */
  .status-badge {
    display: inline-flex;
    align-items: center;
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    border-radius: var(--radius-full);
  }

  .status-new {
    background: var(--color-info-100);
    color: var(--color-info-700);
  }

  .status-in_progress {
    background: var(--color-warning-100);
    color: var(--color-warning-700);
  }

  .status-ready_for_review {
    background: var(--color-primary-100);
    color: var(--color-primary-700);
  }

  .status-reviewed {
    background: var(--color-success-100);
    color: var(--color-success-700);
  }

  .status-delivered {
    background: var(--color-accent-100);
    color: var(--color-accent-700);
  }

  .status-archived {
    background: var(--color-gray-100);
    color: var(--color-gray-600);
  }

  /* Metrics */
  .metric-cell {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
  }

  .metric-positive {
    color: var(--color-success-600);
    font-weight: var(--font-semibold);
  }

  .metric-negative {
    color: var(--color-error-600);
    font-weight: var(--font-semibold);
  }

  /* Action Button */
  .action-btn {
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .action-btn:hover {
    background: var(--color-primary-500);
    color: white;
    border-color: var(--color-primary-500);
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: var(--space-16) var(--space-5);
  }

  .empty-state-icon {
    font-size: var(--text-5xl);
    margin-bottom: var(--space-4);
  }

  .empty-state-title {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-2);
  }

  .empty-state-text {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
    margin-bottom: var(--space-5);
  }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: var(--z-modal);
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.active {
    display: flex;
  }

  .modal {
    background: var(--card-bg);
    border-radius: var(--radius-2xl);
    width: 100%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
  }

  .modal-header {
    padding: var(--space-5) var(--space-6);
    border-bottom: 1px solid var(--border-color);
  }

  .modal-title {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
  }

  .modal-body {
    padding: var(--space-6);
  }

  .modal-footer {
    padding: var(--space-4) var(--space-6);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: var(--space-3);
  }

  /* Form */
  .form-group {
    margin-bottom: var(--space-4);
  }

  .form-label {
    display: block;
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--text-secondary);
    margin-bottom: var(--space-1);
  }

  .form-input {
    width: 100%;
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-sm);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    background: var(--card-bg);
    color: var(--text-primary);
    transition: border-color var(--transition-fast);
  }

  .form-input:focus {
    outline: none;
    border-color: var(--color-primary-500);
    box-shadow: 0 0 0 3px var(--color-primary-100);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4);
    border-top: 1px solid var(--border-color);
  }

  .pagination-info {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
  }

  .pagination-buttons {
    display: flex;
    gap: var(--space-2);
  }

  .page-btn {
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-sm);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-secondary);
    cursor: pointer;
  }

  .page-btn:hover:not(:disabled) {
    background: var(--color-gray-100);
  }

  .page-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Toast Notifications */
  .toast-container {
    position: fixed;
    bottom: var(--space-6);
    right: var(--space-6);
    z-index: var(--z-toast);
  }

  .toast {
    background: var(--color-gray-900);
    color: white;
    padding: var(--space-3) var(--space-5);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    box-shadow: var(--shadow-lg);
    margin-top: var(--space-2);
    animation: slideIn 0.3s ease;
  }

  .toast.success {
    background: var(--color-success-500);
  }

  .toast.error {
    background: var(--color-error-500);
  }

  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .dashboard-header {
      padding: var(--space-3) var(--space-4);
      flex-wrap: wrap;
      gap: var(--space-3);
    }

    .dashboard-logo-icon {
      width: 36px;
      height: 36px;
      font-size: var(--text-base);
    }

    .dashboard-logo-text {
      font-size: var(--text-base);
    }

    .dashboard-main {
      padding: var(--space-4);
    }

    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
    }

    .stat-card {
      padding: var(--space-4);
    }

    .stat-value {
      font-size: var(--text-2xl);
    }

    .search-box {
      width: 100%;
      order: 3;
    }

    .controls-bar {
      flex-wrap: wrap;
    }

    /* Tables scroll horizontally */
    .client-table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
  }

  @media (max-width: 480px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .btn {
      width: 100%;
      justify-content: center;
    }
  }

  /* Screen reader only */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>
{% endblock %}

{% block content %}
<!-- Skip Link for Keyboard Navigation -->
<a href="#main-content" class="skip-link sr-only" style="position:absolute;top:-40px;left:0;background:var(--color-primary-500);color:white;padding:8px 16px;z-index:1000;transition:top 0.3s;" onfocus="this.style.top='0'" onblur="this.style.top='-40px'">Skip to main content</a>

<!-- Dashboard Header -->
<header class="dashboard-header" role="banner">
  <div class="dashboard-logo">
    <div class="dashboard-logo-icon" id="logo-icon" aria-hidden="true">TDI</div>
    <div>
      <div class="dashboard-logo-text" id="firm-name">Tax Decision Intelligence</div>
      <div class="dashboard-logo-subtitle">CPA Workspace</div>
    </div>
  </div>
  <nav class="dashboard-actions" role="navigation" aria-label="User actions">
    <span class="preparer-name" id="preparer-name" aria-live="polite">Loading...</span>
    <button class="btn btn-secondary" onclick="showSettings()" aria-label="Open settings">
      {{ icon('cog-6-tooth') }} Settings
    </button>
  </nav>
</header>

<!-- Main Content -->
<main class="dashboard-main" id="main-content" role="main">
  <!-- Stats Grid -->
  <section class="stats-grid" id="stats-grid" aria-label="Dashboard statistics">
    <div class="stat-card" role="group" aria-labelledby="label-total-clients">
      <div class="stat-label" id="label-total-clients">Total Clients</div>
      <div class="stat-value" id="stat-total-clients" aria-live="polite">-</div>
    </div>
    <div class="stat-card" role="group" aria-labelledby="label-in-progress">
      <div class="stat-label" id="label-in-progress">In Progress</div>
      <div class="stat-value warning" id="stat-in-progress" aria-live="polite">-</div>
    </div>
    <div class="stat-card" role="group" aria-labelledby="label-ready-review">
      <div class="stat-label" id="label-ready-review">Ready for Review</div>
      <div class="stat-value" id="stat-ready-review" aria-live="polite">-</div>
    </div>
    <div class="stat-card" role="group" aria-labelledby="label-savings">
      <div class="stat-label" id="label-savings">Potential Savings</div>
      <div class="stat-value success" id="stat-savings" aria-live="polite">-</div>
    </div>
  </section>

  <!-- Controls -->
  <div class="controls-bar" role="toolbar" aria-label="Client list controls">
    <div class="search-box" role="search">
      <span class="search-icon">{{ icon('magnifying-glass', size=18) }}</span>
      <label for="search-input" class="sr-only">Search clients</label>
      <input type="search" id="search-input" placeholder="Search clients..." onkeyup="debounceSearch()" aria-label="Search clients by name or ID">
    </div>
    <div style="display: flex; gap: var(--space-3);">
      <label for="status-filter" class="sr-only">Filter by status</label>
      <select class="btn btn-secondary" id="status-filter" onchange="loadClients()" aria-label="Filter clients by status">
        <option value="">All Statuses</option>
        <option value="new">New</option>
        <option value="in_progress">In Progress</option>
        <option value="ready_for_review">Ready for Review</option>
        <option value="reviewed">Reviewed</option>
        <option value="delivered">Delivered</option>
        <option value="archived">Archived</option>
      </select>
      <button class="btn btn-primary" onclick="showAddClientModal()" aria-haspopup="dialog">
        {{ icon('plus') }}
        Add Client
      </button>
    </div>
  </div>

  <!-- Client Table -->
  <section class="client-table-container" aria-label="Client list">
    <table class="client-table" role="grid" aria-describedby="pagination-info">
      <caption class="sr-only">Tax client list with status, documents, and financial information</caption>
      <thead>
        <tr>
          <th scope="col">Client</th>
          <th scope="col">ID</th>
          <th scope="col">Status</th>
          <th scope="col">Documents</th>
          <th scope="col">Est. Refund/Owed</th>
          <th scope="col">Savings</th>
          <th scope="col">Last Accessed</th>
          <th scope="col"><span class="sr-only">Actions</span></th>
        </tr>
      </thead>
      <tbody id="client-table-body" aria-live="polite">
        <tr>
          <td colspan="8">
            <div class="empty-state" role="status" aria-live="polite">
              <div class="empty-state-icon" aria-hidden="true">{{ icon('document-text', size=48) }}</div>
              <div class="empty-state-title">Loading clients...</div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <nav class="pagination" id="pagination" role="navigation" aria-label="Table pagination">
      <div class="pagination-info" id="pagination-info" aria-live="polite">Showing 0 of 0 clients</div>
      <div class="pagination-buttons" role="group" aria-label="Pagination controls">
        <button class="page-btn" id="prev-btn" onclick="prevPage()" disabled aria-label="Previous page">Previous</button>
        <button class="page-btn" id="next-btn" onclick="nextPage()" disabled aria-label="Next page">Next</button>
      </div>
    </nav>
  </section>
</main>

<!-- Add Client Modal -->
<div class="modal-overlay" id="add-client-modal" role="dialog" aria-modal="true" aria-labelledby="add-client-modal-title" aria-describedby="add-client-modal-desc">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title" id="add-client-modal-title">Add New Client</h2>
      <p id="add-client-modal-desc" class="sr-only">Form to add a new tax client to your workspace</p>
    </div>
    <form id="add-client-form" onsubmit="submitAddClient(event)" novalidate>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="client-first-name">First Name <span aria-hidden="true">*</span><span class="sr-only">(required)</span></label>
            <input type="text" class="form-input" id="client-first-name" name="first_name" required aria-required="true" autocomplete="given-name">
          </div>
          <div class="form-group">
            <label class="form-label" for="client-last-name">Last Name <span aria-hidden="true">*</span><span class="sr-only">(required)</span></label>
            <input type="text" class="form-input" id="client-last-name" name="last_name" required aria-required="true" autocomplete="family-name">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="client-email">Email</label>
          <input type="email" class="form-input" id="client-email" name="email" autocomplete="email" aria-describedby="email-hint">
          <span id="email-hint" class="sr-only">Optional email address for client communication</span>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="client-external-id">Client ID (your reference)</label>
            <input type="text" class="form-input" id="client-external-id" name="external_id" placeholder="e.g., 2025-001" aria-describedby="external-id-hint">
            <span id="external-id-hint" class="sr-only">Your internal reference number for this client</span>
          </div>
          <div class="form-group">
            <label class="form-label" for="client-phone">Phone</label>
            <input type="tel" class="form-input" id="client-phone" name="phone" autocomplete="tel">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="client-street">Street Address</label>
          <input type="text" class="form-input" id="client-street" name="street_address" autocomplete="street-address">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="client-city">City</label>
            <input type="text" class="form-input" id="client-city" name="city" autocomplete="address-level2">
          </div>
          <div class="form-group">
            <label class="form-label" for="client-state">State</label>
            <input type="text" class="form-input" id="client-state" name="state" maxlength="2" placeholder="CA" autocomplete="address-level1">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal('add-client-modal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Client</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container" role="region" aria-live="polite" aria-label="Notifications"></div>
{% endblock %}

{% block extra_scripts %}
<script>
  // ================================================================
  // SECURITY: XSS Prevention - Always use this for user-generated content
  // ================================================================
  function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
  }

  // State
  let preparerId = null;
  let currentPage = 0;
  let pageSize = 50;
  let totalClients = 0;
  let searchTimeout = null;

  // Initialize
  document.addEventListener('DOMContentLoaded', async () => {
    await loadPreparer();
    await loadDashboard();
    await loadClients();
  });

  // Load preparer profile
  async function loadPreparer() {
    try {
      const response = await fetch('/api/workspace/preparer/me');
      if (response.status === 401) {
        showRegistrationPrompt();
        return;
      }
      const data = await response.json();
      if (data.success) {
        preparerId = data.preparer.preparer_id;
        document.getElementById('preparer-name').textContent = data.preparer.display_name || data.preparer.full_name;
        if (data.preparer.firm_name) {
          document.getElementById('firm-name').textContent = data.preparer.firm_name;
        }
        if (data.preparer.branding?.primary_color) {
          document.documentElement.style.setProperty('--color-primary-500', data.preparer.branding.primary_color);
        }
      }
    } catch (error) {
      console.error('Failed to load preparer:', error);
    }
  }

  // Load dashboard stats
  async function loadDashboard() {
    try {
      const response = await fetch('/api/workspace/dashboard?tax_year=2025');
      const data = await response.json();
      if (data.success) {
        document.getElementById('stat-total-clients').textContent = data.stats.total_clients;
        document.getElementById('stat-in-progress').textContent = data.stats.status_breakdown.in_progress || 0;
        document.getElementById('stat-ready-review').textContent = data.stats.status_breakdown.ready_for_review || 0;
        document.getElementById('stat-savings').textContent = formatCurrency(data.stats.total_potential_savings);
      }
    } catch (error) {
      console.error('Failed to load dashboard:', error);
    }
  }

  // Load clients
  async function loadClients() {
    const search = document.getElementById('search-input').value;
    const status = document.getElementById('status-filter').value;
    const params = new URLSearchParams({
      tax_year: 2025,
      limit: pageSize,
      offset: currentPage * pageSize,
    });
    if (search) params.append('search', search);
    if (status) params.append('status', status);

    try {
      const response = await fetch(`/api/workspace/clients?${params}`);
      const data = await response.json();
      if (data.success) {
        totalClients = data.total;
        renderClients(data.clients);
        updatePagination(data);
      }
    } catch (error) {
      console.error('Failed to load clients:', error);
      renderEmptyState('Failed to load clients. Please try again.');
    }
  }

  // Render clients table
  function renderClients(clients) {
    const tbody = document.getElementById('client-table-body');

    if (clients.length === 0) {
      renderEmptyState('No clients found. Add your first client to get started.');
      return;
    }

    tbody.innerHTML = clients.map(client => {
      const session = client.session;
      const statusClass = session ? `status-${session.status}` : 'status-new';
      const statusText = session ? formatStatus(session.status) : 'No Session';
      const documents = session?.progress?.documents_processed || 0;
      const refund = session?.metrics?.estimated_refund;
      const owed = session?.metrics?.estimated_tax_owed;
      const savings = session?.metrics?.potential_savings;
      const lastAccessed = session?.last_accessed_at ? formatDate(session.last_accessed_at) : '-';

      let refundOwed = '-';
      let refundClass = '';
      if (refund && refund > 0) {
        refundOwed = formatCurrency(refund);
        refundClass = 'metric-positive';
      } else if (owed && owed > 0) {
        refundOwed = formatCurrency(-owed);
        refundClass = 'metric-negative';
      }

      const safeName = escapeHtml(client.full_name);
      const safeEmail = escapeHtml(client.email || '');
      const safeExternalId = escapeHtml(client.external_id || client.client_id.slice(0, 8));
      const safeClientId = escapeHtml(client.client_id);

      return `
        <tr role="row">
          <td role="gridcell">
            <div class="client-name">${safeName}</div>
            ${client.email ? `<div class="client-email">${safeEmail}</div>` : ''}
          </td>
          <td role="gridcell"><span class="client-id">${safeExternalId}</span></td>
          <td role="gridcell"><span class="status-badge ${statusClass}" role="status">${statusText}</span></td>
          <td role="gridcell">${documents}</td>
          <td role="gridcell" class="metric-cell ${refundClass}" aria-label="Estimated ${refund > 0 ? 'refund' : 'owed'}: ${refundOwed}">${refundOwed}</td>
          <td role="gridcell" class="metric-cell ${savings ? 'metric-positive' : ''}" aria-label="Potential savings: ${savings ? formatCurrency(savings) : 'none'}">${savings ? formatCurrency(savings) : '-'}</td>
          <td role="gridcell" style="color: var(--text-tertiary); font-size: var(--text-sm);">${lastAccessed}</td>
          <td role="gridcell">
            <button class="action-btn" onclick="openClient('${safeClientId}')" aria-label="Open ${safeName}'s tax return">Open</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  function renderEmptyState(message) {
    document.getElementById('client-table-body').innerHTML = `
      <tr>
        <td colspan="8">
          <div class="empty-state" role="status" aria-live="polite">
            <div class="empty-state-icon" aria-hidden="true">&#128203;</div>
            <div class="empty-state-title">${escapeHtml(message)}</div>
            <button class="btn btn-primary" onclick="showAddClientModal()" aria-haspopup="dialog">Add Client</button>
          </div>
        </td>
      </tr>
    `;
  }

  function updatePagination(data) {
    const start = data.offset + 1;
    const end = Math.min(data.offset + data.clients.length, data.total);
    document.getElementById('pagination-info').textContent = `Showing ${start}-${end} of ${data.total} clients`;
    document.getElementById('prev-btn').disabled = currentPage === 0;
    document.getElementById('next-btn').disabled = !data.has_more;
  }

  function prevPage() {
    if (currentPage > 0) {
      currentPage--;
      loadClients();
    }
  }

  function nextPage() {
    currentPage++;
    loadClients();
  }

  function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      currentPage = 0;
      loadClients();
    }, 300);
  }

  // Modal functionality
  let previousActiveElement = null;

  function showAddClientModal() {
    previousActiveElement = document.activeElement;
    const modal = document.getElementById('add-client-modal');
    modal.classList.add('active');
    setTimeout(() => {
      const firstInput = modal.querySelector('input, button, select, textarea');
      if (firstInput) firstInput.focus();
    }, 100);
    document.addEventListener('keydown', handleModalKeydown);
  }

  function closeModal(id) {
    const modal = document.getElementById(id);
    modal.classList.remove('active');
    document.removeEventListener('keydown', handleModalKeydown);
    if (previousActiveElement) {
      previousActiveElement.focus();
      previousActiveElement = null;
    }
  }

  function handleModalKeydown(e) {
    if (e.key === 'Escape') {
      closeModal('add-client-modal');
    }
    if (e.key === 'Tab') {
      const modal = document.querySelector('.modal-overlay.active .modal');
      if (!modal) return;
      const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];
      if (e.shiftKey && document.activeElement === firstElement) {
        e.preventDefault();
        lastElement.focus();
      } else if (!e.shiftKey && document.activeElement === lastElement) {
        e.preventDefault();
        firstElement.focus();
      }
    }
  }

  async function submitAddClient(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    Object.keys(data).forEach(key => {
      if (!data[key]) delete data[key];
    });

    try {
      const response = await fetch('/api/workspace/clients', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      const result = await response.json();

      if (result.success) {
        showToast('Client added successfully', 'success');
        closeModal('add-client-modal');
        form.reset();
        loadClients();
        loadDashboard();
      } else {
        showToast(result.detail || 'Failed to add client', 'error');
      }
    } catch (error) {
      showToast('Failed to add client', 'error');
    }
  }

  async function openClient(clientId) {
    try {
      const response = await fetch('/api/workspace/sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ client_id: clientId, tax_year: 2025 }),
      });
      const data = await response.json();

      if (data.success) {
        window.location.href = `/?session_id=${data.session.session_id}&client_id=${clientId}`;
      }
    } catch (error) {
      showToast('Failed to open client', 'error');
    }
  }

  function showRegistrationPrompt() {
    document.getElementById('client-table-body').innerHTML = `
      <tr>
        <td colspan="8">
          <div class="empty-state">
            <div class="empty-state-icon">&#128100;</div>
            <div class="empty-state-title">Welcome! Let's set up your workspace</div>
            <div class="empty-state-text">Register as a preparer to start managing clients.</div>
            <button class="btn btn-primary" onclick="showRegistrationModal()">Register Now</button>
          </div>
        </td>
      </tr>
    `;
  }

  // Utilities
  function formatCurrency(amount) {
    if (amount === null || amount === undefined) return '-';
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(amount);
  }

  function formatStatus(status) {
    const statusMap = {
      'new': 'New',
      'in_progress': 'In Progress',
      'ready_for_review': 'Ready for Review',
      'reviewed': 'Reviewed',
      'delivered': 'Delivered',
      'archived': 'Archived',
    };
    return statusMap[status] || status;
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;

    if (diff < 60000) return 'Just now';
    if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
    if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;

    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.setAttribute('role', type === 'error' ? 'alert' : 'status');
    toast.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
    toast.textContent = message;
    container.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  function showSettings() {
    showToast('Settings coming soon', 'info');
  }

  function showRegistrationModal() {
    showToast('Registration modal coming soon', 'info');
  }
</script>
{% endblock %}
