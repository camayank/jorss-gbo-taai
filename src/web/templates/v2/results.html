{% extends 'v2/base.html' %}
{% from 'macros/icons.html' import icon %}
{% from 'components/layout/card.html' import card, stat_card %}
{% from 'components/feedback/alert.html' import alert %}

{% block title %}Your Tax Return Results{% endblock %}

{% block meta_description %}Your tax return is complete. View your refund or tax owed amount and next steps.{% endblock %}

{% block extra_styles %}
<style>
  .results-hero {
    text-align: center;
    padding: var(--space-8) var(--space-4);
    background: linear-gradient(135deg, var(--color-primary-50) 0%, var(--color-accent-50) 100%);
    margin: calc(-1 * var(--space-8)) calc(-1 * var(--space-4)) var(--space-8);
  }

  .results-hero h1 {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    color: var(--color-gray-900);
    margin-bottom: var(--space-2);
  }

  .results-hero .subtitle {
    color: var(--color-gray-600);
    font-size: var(--text-lg);
  }

  .results-container {
    max-width: 900px;
    margin: 0 auto;
  }

  /* Main result display */
  .result-amount {
    text-align: center;
    padding: var(--space-8);
  }

  .amount-label {
    font-size: var(--text-base);
    color: var(--color-gray-500);
    margin-bottom: var(--space-2);
  }

  .amount-value {
    font-size: var(--text-5xl);
    font-weight: var(--font-bold);
    margin-bottom: var(--space-3);
  }

  .amount-value.refund {
    color: var(--color-success-600);
  }

  .amount-value.owed {
    color: var(--color-error-600);
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
  }

  .status-badge.draft {
    background: var(--color-warning-100);
    color: var(--color-warning-700);
  }

  .status-badge.complete {
    background: var(--color-success-100);
    color: var(--color-success-700);
  }

  /* Stats grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-4);
    padding: var(--space-6);
    border-top: 1px solid var(--color-gray-200);
  }

  .stat-item {
    text-align: center;
    padding: var(--space-4);
    background: var(--color-gray-50);
    border-radius: var(--radius-lg);
  }

  .stat-value {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--color-gray-900);
    margin-bottom: var(--space-1);
  }

  .stat-label {
    font-size: var(--text-sm);
    color: var(--color-gray-500);
  }

  /* Actions */
  .result-actions {
    display: flex;
    gap: var(--space-4);
    padding: var(--space-6);
    border-top: 1px solid var(--color-gray-200);
  }

  .result-actions .btn {
    flex: 1;
  }

  /* Optimization CTA */
  .optimization-cta {
    background: linear-gradient(135deg, var(--color-accent-500) 0%, var(--color-primary-600) 100%);
    color: white;
    padding: var(--space-8);
    border-radius: var(--radius-xl);
    text-align: center;
    margin-top: var(--space-6);
  }

  .optimization-cta h3 {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    margin-bottom: var(--space-2);
  }

  .optimization-cta p {
    opacity: 0.9;
    margin-bottom: var(--space-4);
  }

  .optimization-cta .btn {
    background: white;
    color: var(--color-primary-600);
  }

  /* Next steps */
  .next-steps {
    margin-top: var(--space-8);
  }

  .next-steps h2 {
    font-size: var(--text-xl);
    font-weight: var(--font-semibold);
    color: var(--color-gray-900);
    margin-bottom: var(--space-6);
  }

  .step {
    display: flex;
    align-items: flex-start;
    gap: var(--space-4);
    padding: var(--space-5);
    background: var(--color-gray-50);
    border-left: 4px solid var(--color-primary-500);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
  }

  .step-number {
    width: 32px;
    height: 32px;
    background: var(--color-primary-500);
    color: white;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: var(--font-bold);
    flex-shrink: 0;
  }

  .step-content {
    flex: 1;
  }

  .step-title {
    font-weight: var(--font-semibold);
    color: var(--color-gray-900);
    margin-bottom: var(--space-1);
  }

  .step-description {
    font-size: var(--text-sm);
    color: var(--color-gray-600);
  }

  .step.highlight {
    border-left-color: var(--color-accent-500);
  }

  .step.highlight .step-number {
    background: var(--color-accent-500);
  }

  /* Legal notice */
  .legal-notice {
    margin-top: var(--space-8);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .results-hero h1 {
      font-size: var(--text-2xl);
    }

    .amount-value {
      font-size: var(--text-4xl);
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }

    .result-actions {
      flex-direction: column;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="results-container">
  <!-- Hero -->
  <div class="results-hero">
    <h1>Your Tax Return is Complete!</h1>
    <p class="subtitle">Return ID: <span id="return-id">{{ return_id }}</span></p>
  </div>

  <!-- Main Results Card -->
  <div class="card">
    <div class="result-amount">
      <div class="amount-label">
        {% if refund %}
          Expected Refund
        {% else %}
          Tax Owed
        {% endif %}
      </div>
      <div class="amount-value {% if refund %}refund{% else %}owed{% endif %}">
        ${{ "{:,.2f}".format(refund if refund else tax_owed) }}
      </div>
      <span class="status-badge {{ 'complete' if return_data.get('status') == 'COMPLETE' else 'draft' }}">
        {% if return_data.get('status') == 'COMPLETE' %}
          {{ icon('check-circle') }} Complete
        {% else %}
          {{ icon('pencil') }} Draft
        {% endif %}
      </span>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-value">${{ "{:,.2f}".format(return_data.get('total_income', 0)) }}</div>
        <div class="stat-label">Total Income</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${{ "{:,.2f}".format(return_data.get('total_tax', 0)) }}</div>
        <div class="stat-label">Total Tax</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">{{ "{:.1f}".format(return_data.get('effective_rate', 0)) }}%</div>
        <div class="stat-label">Effective Rate</div>
      </div>
    </div>

    <!-- Actions -->
    <div class="result-actions">
      <a href="/api/tax-returns/{{ session_id }}/pdf" class="btn btn-primary" download>
        {{ icon('arrow-down-tray') }} Download PDF
      </a>
      <a href="/file/review?session_id={{ session_id }}" class="btn btn-secondary">
        {{ icon('document-text') }} Review Details
      </a>
    </div>

    <!-- Optimization CTA -->
    <div class="optimization-cta">
      <h3>Want to explore what-if scenarios?</h3>
      <p>See how different deductions and credits could affect your return</p>
      <a href="/scenarios?session_id={{ session_id }}" class="btn">
        Explore Scenarios {{ icon('arrow-right') }}
      </a>
    </div>
  </div>

  <!-- Next Steps -->
  <div class="next-steps card">
    <div class="card-body">
      <h2>Next Steps</h2>

      <div class="step">
        <span class="step-number">1</span>
        <div class="step-content">
          <div class="step-title">Review Your Return</div>
          <div class="step-description">
            Double-check all information is accurate before submitting for CPA review
          </div>
        </div>
      </div>

      <div class="step">
        <span class="step-number">2</span>
        <div class="step-content">
          <div class="step-title">Submit for CPA Review</div>
          <div class="step-description">
            A licensed CPA will review your return to ensure accuracy and maximize deductions
          </div>
        </div>
      </div>

      <div class="step">
        <span class="step-number">3</span>
        <div class="step-content">
          <div class="step-title">E-File When Ready</div>
          <div class="step-description">
            Once approved by CPA, we'll e-file your return directly with the IRS
          </div>
        </div>
      </div>

      <div class="step highlight">
        <span class="step-number">{{ icon('chart-bar') }}</span>
        <div class="step-content">
          <div class="step-title">Plan Ahead for 2025</div>
          <div class="step-description">
            Based on your 2024 return, see your 5-year tax projection
            <br>
            <a href="/projections?session_id={{ session_id }}" style="color: var(--color-accent-600); font-weight: 600;">
              View Projections {{ icon('arrow-right') }}
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Legal Notice -->
  <div class="legal-notice">
    {{ alert(
      type='warning',
      title='Important Notice',
      message='This is a DRAFT for reference only. Do NOT file this with the IRS. Always consult a licensed CPA before making any tax decisions.'
    ) }}
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Display return ID from URL or template
  const urlParams = new URLSearchParams(window.location.search);
  const sessionId = urlParams.get('session_id') || '{{ session_id }}';

  // Auto-save session ID
  if (sessionId) {
    localStorage.setItem('completed_return_id', sessionId);
  }

  // Track completion event (for analytics)
  if (window.gtag) {
    gtag('event', 'filing_completed', {
      'session_id': sessionId,
      'workflow_type': '{{ return_data.get("workflow_type", "unknown") }}',
      'refund_amount': {{ refund if refund else 0 }},
      'tax_owed': {{ tax_owed if tax_owed else 0 }},
      'ux_version': 'v2'
    });
  }
</script>
{% endblock %}
