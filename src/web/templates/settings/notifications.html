{% extends "base_modern.html" %}

{% block title %}Notification Preferences - {{ config.APP_NAME }}{% endblock %}

{% block extra_css %}
<style>
    .notifications-page {
        padding: var(--space-6);
        max-width: 900px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: var(--space-6);
    }

    .breadcrumb {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-sm);
        color: var(--color-gray-500);
        margin-bottom: var(--space-2);
    }

    .breadcrumb a {
        color: var(--color-primary-600);
        text-decoration: none;
    }

    .breadcrumb a:hover {
        text-decoration: underline;
    }

    .page-title {
        font-size: var(--text-2xl);
        font-weight: var(--font-semibold);
        color: var(--color-gray-900);
    }

    .page-description {
        font-size: var(--text-sm);
        color: var(--color-gray-500);
        margin-top: var(--space-2);
    }

    /* Settings Card */
    .settings-card {
        background: white;
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-gray-200);
        margin-bottom: var(--space-6);
    }

    .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-4) var(--space-6);
        border-bottom: 1px solid var(--color-gray-200);
    }

    .settings-title {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
        color: var(--color-gray-900);
    }

    .settings-subtitle {
        font-size: var(--text-sm);
        color: var(--color-gray-500);
        margin-top: var(--space-1);
    }

    .master-toggle {
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .toggle-label {
        font-size: var(--text-sm);
        color: var(--color-gray-600);
    }

    /* Toggle Switch */
    .toggle {
        position: relative;
        width: var(--space-11);

        height: var(--space-6);

    }

    .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--color-gray-300);
        transition: 0.3s;
        border-radius: var(--radius-3xl);

    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .toggle input:checked + .toggle-slider {
        background-color: var(--color-primary-600);
    }

    .toggle input:checked + .toggle-slider:before {
        transform: translateX(20px);
    }

    /* Settings Section */
    .settings-section {
        padding: var(--space-4) var(--space-6);
        border-bottom: 1px solid var(--color-gray-100);
    }

    .settings-section:last-child {
        border-bottom: none;
    }

    .section-label {
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--color-gray-900);
        margin-bottom: var(--space-4);
    }

    /* Notification Item */
    .notification-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: var(--space-4) 0;
        border-bottom: 1px solid var(--color-gray-100);
    }

    .notification-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }

    .notification-item:first-child {
        padding-top: 0;
    }

    .notification-info {
        flex: 1;
        padding-right: var(--space-4);
    }

    .notification-name {
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--color-gray-900);
        margin-bottom: var(--space-1);
    }

    .notification-desc {
        font-size: var(--text-xs);
        color: var(--color-gray-500);
    }

    .notification-channels {
        display: flex;
        gap: var(--space-4);
    }

    .channel-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--space-1);
    }

    .channel-label {
        font-size: var(--text-xs);
        color: var(--color-gray-500);
    }

    /* Checkbox */
    .checkbox {
        display: flex;
        align-items: center;
        justify-content: center;
        width: var(--space-5);

        height: var(--space-5);

        border: 2px solid var(--color-gray-300);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all 0.2s;
    }

    .checkbox.checked {
        background: var(--color-primary-600);
        border-color: var(--color-primary-600);
    }

    .checkbox.checked svg {
        display: block;
    }

    .checkbox svg {
        display: none;
        color: white;
    }

    /* Frequency Settings */
    .frequency-section {
        padding: var(--space-6);
    }

    .frequency-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-4);
    }

    .frequency-option {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        padding: var(--space-4);
        border: 2px solid var(--color-gray-200);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s;
    }

    .frequency-option:hover {
        border-color: var(--color-gray-300);
    }

    .frequency-option.selected {
        border-color: var(--color-primary-500);
        background: var(--color-primary-50);
    }

    .frequency-option input {
        display: none;
    }

    .frequency-radio {
        width: var(--space-5);

        height: var(--space-5);

        border: 2px solid var(--color-gray-300);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-top: var(--space-0-5);

    }

    .frequency-option.selected .frequency-radio {
        border-color: var(--color-primary-600);
    }

    .frequency-option.selected .frequency-radio::after {
        content: '';
        width: var(--space-2-5);

        height: var(--space-2-5);

        background: var(--color-primary-600);
        border-radius: 50%;
    }

    .frequency-info {
        flex: 1;
    }

    .frequency-name {
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--color-gray-900);
        margin-bottom: var(--space-1);
    }

    .frequency-desc {
        font-size: var(--text-xs);
        color: var(--color-gray-500);
    }

    /* Quiet Hours */
    .quiet-hours {
        padding: var(--space-6);
        background: var(--color-gray-50);
    }

    .quiet-hours-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-4);
    }

    .quiet-hours-title {
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--color-gray-900);
    }

    .quiet-hours-content {
        display: flex;
        gap: var(--space-4);
        align-items: center;
    }

    .time-input-group {
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .time-label {
        font-size: var(--text-sm);
        color: var(--color-gray-600);
    }

    .time-input {
        padding: var(--space-2) var(--space-3);
        border: 1px solid var(--color-gray-300);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        width: 100px;
    }

    .time-input:focus {
        outline: none;
        border-color: var(--color-primary-500);
        box-shadow: 0 0 0 3px var(--color-primary-100);
    }

    /* Save Button */
    .save-section {
        display: flex;
        justify-content: flex-end;
        padding: var(--space-4) var(--space-6);
        border-top: 1px solid var(--color-gray-200);
        background: var(--color-gray-50);
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2-5) var(--space-4);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .btn-primary {
        background: var(--color-primary-600);
        color: white;
    }

    .btn-primary:hover {
        background: var(--color-primary-700);
    }

    .btn-secondary {
        background: white;
        color: var(--color-gray-700);
        border: 1px solid var(--color-gray-300);
        margin-right: var(--space-3);
    }

    .btn-secondary:hover {
        background: var(--color-gray-50);
    }

    /* Alert */
    .alert {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        padding: var(--space-4);
        background: var(--color-info-50);
        border: 1px solid var(--color-info-100);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-6);
    }

    .alert-icon {
        color: var(--color-info-600);
        flex-shrink: 0;
    }

    .alert-content {
        flex: 1;
    }

    .alert-title {
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--color-info-800);
        margin-bottom: var(--space-1);
    }

    .alert-text {
        font-size: var(--text-sm);
        color: var(--color-info-700);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .notifications-page {
            padding: var(--space-4);
        }

        .frequency-grid {
            grid-template-columns: 1fr;
        }

        .notification-item {
            flex-direction: column;
            gap: var(--space-3);
        }

        .notification-info {
            padding-right: 0;
        }

        .quiet-hours-content {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="notifications-page">
    <div class="page-header">
        <div class="breadcrumb">
            <a href="/settings">Settings</a>
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M9 5l7 7-7 7"/>
            </svg>
            <span>Notifications</span>
        </div>
        <h1 class="page-title">Notification Preferences</h1>
        <p class="page-description">Manage how and when you receive notifications about your tax activities.</p>
    </div>

    <!-- Info Alert -->
    <div class="alert">
        <svg class="alert-icon" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4M12 8h.01"/>
        </svg>
        <div class="alert-content">
            <div class="alert-title">Important notifications cannot be disabled</div>
            <div class="alert-text">Some notifications like security alerts and billing reminders are always sent to ensure you don't miss critical information.</div>
        </div>
    </div>

    <form>
        <!-- Email Notifications -->
        <div class="settings-card">
            <div class="settings-header">
                <div>
                    <h2 class="settings-title">Email Notifications</h2>
                    <p class="settings-subtitle">Notifications sent to your registered email address</p>
                </div>
                <div class="master-toggle">
                    <span class="toggle-label">Enable all</span>
                    <label class="toggle">
                        <input type="checkbox" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-section">
                <div class="section-label">Tax Return Updates</div>
                <div class="notification-item">
                    <div class="notification-info">
                        <div class="notification-name">Return Status Changes</div>
                        <div class="notification-desc">When your tax return status changes (submitted, under review, accepted, rejected)</div>
                    </div>
                    <div class="notification-channels">
                        <div class="channel-option">
                            <span class="channel-label">Email</span>
                            <div class="checkbox checked" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                        <div class="channel-option">
                            <span class="channel-label">Push</span>
                            <div class="checkbox checked" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                        <div class="channel-option">
                            <span class="channel-label">SMS</span>
                            <div class="checkbox" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="notification-item">
                    <div class="notification-info">
                        <div class="notification-name">Document Requests</div>
                        <div class="notification-desc">When your CPA requests additional documents for your return</div>
                    </div>
                    <div class="notification-channels">
                        <div class="channel-option">
                            <span class="channel-label">Email</span>
                            <div class="checkbox checked" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                        <div class="channel-option">
                            <span class="channel-label">Push</span>
                            <div class="checkbox checked" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                        <div class="channel-option">
                            <span class="channel-label">SMS</span>
                            <div class="checkbox checked" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="section-label">Deadlines & Reminders</div>
                <div class="notification-item">
                    <div class="notification-info">
                        <div class="notification-name">Upcoming Deadlines</div>
                        <div class="notification-desc">Reminders for tax filing deadlines and estimated tax payments</div>
                    </div>
                    <div class="notification-channels">
                        <div class="channel-option">
                            <span class="channel-label">Email</span>
                            <div class="checkbox checked" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                        <div class="channel-option">
                            <span class="channel-label">Push</span>
                            <div class="checkbox checked" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                        <div class="channel-option">
                            <span class="channel-label">SMS</span>
                            <div class="checkbox" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="notification-item">
                    <div class="notification-info">
                        <div class="notification-name">Appointment Reminders</div>
                        <div class="notification-desc">Reminders before your scheduled CPA appointments</div>
                    </div>
                    <div class="notification-channels">
                        <div class="channel-option">
                            <span class="channel-label">Email</span>
                            <div class="checkbox checked" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                        <div class="channel-option">
                            <span class="channel-label">Push</span>
                            <div class="checkbox checked" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                        <div class="channel-option">
                            <span class="channel-label">SMS</span>
                            <div class="checkbox checked" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="section-label">Communications</div>
                <div class="notification-item">
                    <div class="notification-info">
                        <div class="notification-name">Messages from CPA</div>
                        <div class="notification-desc">When your CPA sends you a message or comment</div>
                    </div>
                    <div class="notification-channels">
                        <div class="channel-option">
                            <span class="channel-label">Email</span>
                            <div class="checkbox checked" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                        <div class="channel-option">
                            <span class="channel-label">Push</span>
                            <div class="checkbox checked" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                        <div class="channel-option">
                            <span class="channel-label">SMS</span>
                            <div class="checkbox" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="notification-item">
                    <div class="notification-info">
                        <div class="notification-name">Support Ticket Updates</div>
                        <div class="notification-desc">Replies and status changes on your support tickets</div>
                    </div>
                    <div class="notification-channels">
                        <div class="channel-option">
                            <span class="channel-label">Email</span>
                            <div class="checkbox checked" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                        <div class="channel-option">
                            <span class="channel-label">Push</span>
                            <div class="checkbox" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                        <div class="channel-option">
                            <span class="channel-label">SMS</span>
                            <div class="checkbox" onclick="this.classList.toggle('checked')">
                                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                                    <path d="M20 6L9 17l-5-5"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Digest Frequency -->
        <div class="settings-card">
            <div class="settings-header">
                <div>
                    <h2 class="settings-title">Email Digest</h2>
                    <p class="settings-subtitle">How often to receive summary emails</p>
                </div>
            </div>
            <div class="frequency-section">
                <div class="frequency-grid">
                    <label class="frequency-option">
                        <input type="radio" name="digest" value="realtime">
                        <span class="frequency-radio"></span>
                        <div class="frequency-info">
                            <div class="frequency-name">Real-time</div>
                            <div class="frequency-desc">Get notified immediately as events happen</div>
                        </div>
                    </label>
                    <label class="frequency-option selected">
                        <input type="radio" name="digest" value="daily" checked>
                        <span class="frequency-radio"></span>
                        <div class="frequency-info">
                            <div class="frequency-name">Daily Digest</div>
                            <div class="frequency-desc">One email per day with all updates</div>
                        </div>
                    </label>
                    <label class="frequency-option">
                        <input type="radio" name="digest" value="weekly">
                        <span class="frequency-radio"></span>
                        <div class="frequency-info">
                            <div class="frequency-name">Weekly Summary</div>
                            <div class="frequency-desc">One email per week on Monday</div>
                        </div>
                    </label>
                    <label class="frequency-option">
                        <input type="radio" name="digest" value="none">
                        <span class="frequency-radio"></span>
                        <div class="frequency-info">
                            <div class="frequency-name">Critical Only</div>
                            <div class="frequency-desc">Only security and billing alerts</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Quiet Hours -->
            <div class="quiet-hours">
                <div class="quiet-hours-header">
                    <span class="quiet-hours-title">Quiet Hours (No push notifications)</span>
                    <label class="toggle">
                        <input type="checkbox" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="quiet-hours-content">
                    <div class="time-input-group">
                        <span class="time-label">From</span>
                        <input type="time" class="time-input" value="22:00">
                    </div>
                    <div class="time-input-group">
                        <span class="time-label">To</span>
                        <input type="time" class="time-input" value="07:00">
                    </div>
                </div>
            </div>

            <div class="save-section">
                <button type="button" class="btn btn-secondary">Reset to Defaults</button>
                <button type="submit" class="btn btn-primary">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                        <path d="M17 21v-8H7v8M7 3v5h8"/>
                    </svg>
                    Save Preferences
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Frequency option selection
    document.querySelectorAll('.frequency-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.frequency-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
        });
    });

    function getAuthHeaders() {
        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
        if (token) headers['Authorization'] = 'Bearer ' + token;
        const csrf = document.querySelector('meta[name="csrf-token"]');
        if (csrf) headers['X-CSRFToken'] = csrf.content;
        return headers;
    }

    // Collect all notification preferences from the form
    function collectPreferences() {
        const prefs = { notifications: {}, digest_frequency: 'daily', quiet_hours: { enabled: false, from: '22:00', to: '07:00' } };

        // Collect per-item channel states
        document.querySelectorAll('.notification-item').forEach(item => {
            const name = item.querySelector('.notification-name');
            if (!name) return;
            const key = name.textContent.trim().toLowerCase().replace(/\s+/g, '_');
            const channels = {};
            item.querySelectorAll('.channel-option').forEach(ch => {
                const label = ch.querySelector('.channel-label').textContent.trim().toLowerCase();
                const checked = ch.querySelector('.checkbox').classList.contains('checked');
                channels[label] = checked;
            });
            prefs.notifications[key] = channels;
        });

        // Master toggle
        const masterToggle = document.querySelector('.master-toggle input[type="checkbox"]');
        if (masterToggle) prefs.email_enabled = masterToggle.checked;

        // Digest frequency
        const selectedDigest = document.querySelector('input[name="digest"]:checked');
        if (selectedDigest) prefs.digest_frequency = selectedDigest.value;

        // Quiet hours
        const quietToggle = document.querySelector('.quiet-hours-header input[type="checkbox"]');
        if (quietToggle) prefs.quiet_hours.enabled = quietToggle.checked;
        const fromInput = document.querySelector('.quiet-hours-content .time-input');
        const toInput = document.querySelectorAll('.quiet-hours-content .time-input')[1];
        if (fromInput) prefs.quiet_hours.from = fromInput.value;
        if (toInput) prefs.quiet_hours.to = toInput.value;

        return prefs;
    }

    // Save preferences
    document.querySelector('form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        const origText = btn.innerHTML;
        btn.innerHTML = 'Saving...';
        btn.disabled = true;

        try {
            const resp = await fetch('/api/cpa/notifications/preferences', {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(collectPreferences())
            });
            if (resp.status === 401) {
                window.location.href = '/cpa/login';
                return;
            }
            if (!resp.ok) throw new Error('Failed to save');
            btn.innerHTML = 'Saved!';
            setTimeout(() => { btn.innerHTML = origText; }, 2000);
        } catch (err) {
            alert('Failed to save preferences. Please try again.');
            btn.innerHTML = origText;
        } finally {
            btn.disabled = false;
        }
    });

    // Reset to defaults
    document.querySelector('.btn-secondary').addEventListener('click', function() {
        // Check all checkboxes
        document.querySelectorAll('.checkbox').forEach(cb => cb.classList.add('checked'));
        // Set digest to daily
        document.querySelector('input[name="digest"][value="daily"]').checked = true;
        document.querySelectorAll('.frequency-option').forEach(o => o.classList.remove('selected'));
        document.querySelector('input[name="digest"][value="daily"]').closest('.frequency-option').classList.add('selected');
        // Enable quiet hours with defaults
        document.querySelector('.quiet-hours-header input[type="checkbox"]').checked = true;
        document.querySelectorAll('.quiet-hours-content .time-input')[0].value = '22:00';
        document.querySelectorAll('.quiet-hours-content .time-input')[1].value = '07:00';
        // Enable master toggle
        document.querySelector('.master-toggle input[type="checkbox"]').checked = true;
    });
</script>
{% endblock %}
