{% extends 'base_modern.html' %}

{% block title %}Tax Scenario Comparison{% endblock %}
{% block theme %}default{% endblock %}

{% block content %}
<div x-data="scenarioManager()" x-cloak style="max-width: 1400px; margin: 0 auto; padding: var(--space-8) var(--space-6);">

  <!-- ============================================
       PAGE HEADER
       ============================================ -->
  <header style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-8); flex-wrap: wrap; gap: var(--space-4);">
    <div>
      <h1 style="font-size: 28px; font-weight: var(--font-bold); color: var(--color-primary-500); margin: 0; line-height: 1.2;">Scenario Comparison</h1>
      <p style="font-size: 15px; color: #6b7280; margin-top: var(--space-1-5); font-weight: var(--font-normal);">Compare different tax strategies side-by-side</p>
    </div>
    <button
      @click="showCreateModal = true"
      style="display: inline-flex; align-items: center; gap: var(--space-2); padding: var(--space-2-5) var(--space-5); background: var(--color-primary-500); color: white; border: none; border-radius: var(--radius-lg); font-size: var(--text-sm); font-weight: var(--font-medium); cursor: pointer; transition: background 0.15s ease;"
      onmouseover="this.style.background='#162d4a'"
      onmouseout="this.style.background='#1e3a5f'"
    >
      <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
      New Scenario
    </button>
  </header>

  <!-- ============================================
       QUICK ANALYSIS CARDS
       ============================================ -->
  <section style="margin-bottom: var(--space-8);">
    <h2 style="font-size: var(--text-base); font-weight: var(--font-semibold); color: var(--color-gray-700); margin-bottom: var(--space-4);">Quick Analysis</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-4);">

      <!-- Filing Status Comparison -->
      <div
        @click="quickAnalysis('filing-status')"
        style="background: white; border: 1px solid var(--color-gray-200); border-radius: var(--radius-xl); padding: var(--space-6); cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden;"
        onmouseover="this.style.borderColor='#14b8a6'; this.style.boxShadow='0 4px 12px rgba(20,184,166,0.1)'"
        onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
      >
        <div style="display: flex; align-items: flex-start; gap: var(--space-4);">
          <div style="width: 44px; height: 44px; background: linear-gradient(135deg, var(--color-info-50), var(--color-info-100)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <svg width="22" height="22" fill="none" stroke="#1e3a5f" stroke-width="2" viewBox="0 0 24 24">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
          </div>
          <div>
            <h3 style="font-size: 15px; font-weight: var(--font-semibold); color: var(--color-gray-800); margin: 0 0 var(--space-1) 0;">Filing Status Comparison</h3>
            <p style="font-size: 13px; color: #6b7280; margin: 0; line-height: var(--leading-normal);">Compare tax impact of different filing statuses</p>
          </div>
        </div>
        <div style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: #9ca3af;">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"></path></svg>
        </div>
      </div>

      <!-- Retirement Contributions -->
      <div
        @click="quickAnalysis('retirement')"
        style="background: white; border: 1px solid var(--color-gray-200); border-radius: var(--radius-xl); padding: var(--space-6); cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden;"
        onmouseover="this.style.borderColor='#14b8a6'; this.style.boxShadow='0 4px 12px rgba(20,184,166,0.1)'"
        onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
      >
        <div style="display: flex; align-items: flex-start; gap: var(--space-4);">
          <div style="width: 44px; height: 44px; background: linear-gradient(135deg, var(--color-success-50), var(--color-success-100)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <svg width="22" height="22" fill="none" stroke="#10b981" stroke-width="2" viewBox="0 0 24 24">
              <path d="M12 1v22"></path>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
          </div>
          <div>
            <h3 style="font-size: 15px; font-weight: var(--font-semibold); color: var(--color-gray-800); margin: 0 0 var(--space-1) 0;">Retirement Contributions</h3>
            <p style="font-size: 13px; color: #6b7280; margin: 0; line-height: var(--leading-normal);">Optimize IRA/401k contribution strategies</p>
          </div>
        </div>
        <div style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: #9ca3af;">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"></path></svg>
        </div>
      </div>

      <!-- What-If Analysis -->
      <div
        @click="quickAnalysis('what-if')"
        style="background: white; border: 1px solid var(--color-gray-200); border-radius: var(--radius-xl); padding: var(--space-6); cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden;"
        onmouseover="this.style.borderColor='#14b8a6'; this.style.boxShadow='0 4px 12px rgba(20,184,166,0.1)'"
        onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
      >
        <div style="display: flex; align-items: flex-start; gap: var(--space-4);">
          <div style="width: 44px; height: 44px; background: linear-gradient(135deg, var(--color-warning-100), var(--color-warning-200)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <svg width="22" height="22" fill="none" stroke="#d97706" stroke-width="2" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
          </div>
          <div>
            <h3 style="font-size: 15px; font-weight: var(--font-semibold); color: var(--color-gray-800); margin: 0 0 var(--space-1) 0;">What-If Analysis</h3>
            <p style="font-size: 13px; color: #6b7280; margin: 0; line-height: var(--leading-normal);">Quick tax impact of a single change</p>
          </div>
        </div>
        <div style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: #9ca3af;">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"></path></svg>
        </div>
      </div>

    </div>
  </section>

  <!-- ============================================
       LOADING STATE
       ============================================ -->
  <div x-show="loading" style="text-align: center; padding: 60px var(--space-5);">
    <div style="display: inline-block; width: 40px; height: 40px; border: 3px solid var(--color-gray-200); border-top-color: var(--color-primary-500); border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
    <p style="margin-top: var(--space-4); color: #6b7280; font-size: var(--text-sm);">Loading scenarios...</p>
  </div>

  <!-- ============================================
       EMPTY STATE (no scenarios)
       ============================================ -->
  <div x-show="!loading && scenarios.length === 0" style="background: white; border: 1px solid var(--color-gray-200); border-radius: var(--radius-xl); padding: 60px var(--space-6); text-align: center; margin-bottom: var(--space-8);">
    <div style="width: 64px; height: 64px; background: var(--color-gray-100); border-radius: var(--radius-2xl); display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-5) auto;">
      <svg width="32" height="32" fill="none" stroke="#9ca3af" stroke-width="1.5" viewBox="0 0 24 24">
        <path d="M9 17H7A5 5 0 0 1 7 7h2"></path>
        <path d="M15 7h2a5 5 0 1 1 0 10h-2"></path>
        <line x1="8" y1="12" x2="16" y2="12"></line>
      </svg>
    </div>
    <h3 style="font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--color-gray-800); margin: 0 0 var(--space-2) 0;">No scenarios yet</h3>
    <p style="font-size: var(--text-sm); color: #6b7280; margin: 0 0 var(--space-6) 0; max-width: 400px; margin-left: auto; margin-right: auto;">Create your first tax scenario to start comparing strategies and finding the optimal filing approach.</p>
    <button
      @click="showCreateModal = true"
      style="display: inline-flex; align-items: center; gap: var(--space-2); padding: var(--space-2-5) var(--space-5); background: var(--color-primary-500); color: white; border: none; border-radius: var(--radius-lg); font-size: var(--text-sm); font-weight: var(--font-medium); cursor: pointer; transition: background 0.15s ease;"
      onmouseover="this.style.background='#162d4a'"
      onmouseout="this.style.background='#1e3a5f'"
    >
      <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
      Create First Scenario
    </button>
  </div>

  <!-- ============================================
       SCENARIO LIST
       ============================================ -->
  <section x-show="!loading && scenarios.length > 0" style="margin-bottom: var(--space-8);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4); flex-wrap: wrap; gap: var(--space-3);">
      <h2 style="font-size: var(--text-base); font-weight: var(--font-semibold); color: var(--color-gray-700); margin: 0;">
        Your Scenarios
        <span style="font-weight: var(--font-normal); color: #9ca3af; margin-left: var(--space-2);" x-text="'(' + scenarios.length + ')'"></span>
      </h2>
      <button
        @click="compareScenarios()"
        :disabled="selectedScenarios.length < 2"
        style="display: inline-flex; align-items: center; gap: var(--space-2); padding: var(--space-2-5) var(--space-5); border: none; border-radius: var(--radius-lg); font-size: var(--text-sm); font-weight: var(--font-medium); cursor: pointer; transition: all 0.15s ease;"
        :style="selectedScenarios.length >= 2
          ? 'background: #14b8a6; color: #ffffff;'
          : 'background: #f3f4f6; color: #9ca3af; cursor: not-allowed;'"
      >
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M16 3h5v5"></path>
          <line x1="21" y1="3" x2="14" y2="10"></line>
          <path d="M8 21H3v-5"></path>
          <line x1="3" y1="21" x2="10" y2="14"></line>
        </svg>
        Compare Selected (<span x-text="selectedScenarios.length"></span>)
      </button>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: var(--space-4);">
      <template x-for="scenario in scenarios" :key="scenario.id">
        <div
          @click="toggleSelect(scenario.id)"
          style="background: white; border-radius: var(--radius-xl); padding: var(--space-5); cursor: pointer; transition: all 0.2s ease; position: relative;"
          :style="selectedScenarios.includes(scenario.id)
            ? 'border: 2px solid #14b8a6; box-shadow: 0 0 0 3px rgba(20,184,166,0.1);'
            : 'border: 1px solid #e5e7eb;'"
        >
          <!-- Selection indicator -->
          <div
            style="position: absolute; top: 12px; right: 12px; width: 24px; height: 24px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; transition: all 0.15s ease;"
            :style="selectedScenarios.includes(scenario.id)
              ? 'background: #14b8a6; border: none;'
              : 'background: #ffffff; border: 2px solid #d1d5db;'"
          >
            <svg x-show="selectedScenarios.includes(scenario.id)" width="14" height="14" fill="none" stroke="#ffffff" stroke-width="2.5" viewBox="0 0 24 24">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </div>

          <!-- Scenario info -->
          <div style="padding-right: var(--space-9);">
            <div style="display: flex; align-items: center; gap: var(--space-2-5); margin-bottom: var(--space-2);">
              <h3 style="font-size: 15px; font-weight: var(--font-semibold); color: var(--color-gray-800); margin: 0;" x-text="scenario.name"></h3>
              <span
                style="display: inline-flex; align-items: center; padding: var(--space-0-5) var(--space-2-5); font-size: 11px; font-weight: var(--font-medium); border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px;"
                :style="scenario.status === 'calculated'
                  ? 'background: #ecfdf5; color: #10b981;'
                  : 'background: #f3f4f6; color: #6b7280;'"
                x-text="scenario.status || 'draft'"
              ></span>
            </div>
            <p
              style="font-size: 13px; color: #6b7280; margin: 0 0 var(--space-3) 0; line-height: var(--leading-normal);"
              x-text="scenario.description || 'No description'"
            ></p>
            <div style="display: flex; align-items: center; gap: var(--space-4); font-size: var(--text-xs); color: #9ca3af;">
              <span style="display: inline-flex; align-items: center; gap: var(--space-1);">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span x-text="scenario.created_at ? new Date(scenario.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A'"></span>
              </span>
              <span
                x-show="scenario.filing_status"
                style="display: inline-flex; align-items: center; gap: var(--space-1);"
                x-text="scenario.filing_status"
              ></span>
            </div>
          </div>

          <!-- Action buttons -->
          <div style="display: flex; gap: var(--space-2); margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--color-gray-100);" @click.stop>
            <button
              @click="calculateScenario(scenario.id)"
              style="flex: 1; padding: var(--space-2) var(--space-3); font-size: 13px; font-weight: var(--font-medium); border-radius: var(--radius-md); border: 1px solid var(--color-gray-200); background: white; color: var(--color-gray-700); cursor: pointer; transition: all 0.15s ease; display: inline-flex; align-items: center; justify-content: center; gap: var(--space-1-5);"
              onmouseover="this.style.background='#f9fafb'"
              onmouseout="this.style.background='#ffffff'"
            >
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <rect x="4" y="2" width="16" height="20" rx="2"></rect>
                <line x1="8" y1="6" x2="16" y2="6"></line>
                <line x1="8" y1="10" x2="16" y2="10"></line>
                <line x1="8" y1="14" x2="12" y2="14"></line>
              </svg>
              Calculate
            </button>
            <button
              @click="toggleSelect(scenario.id)"
              style="flex: 1; padding: var(--space-2) var(--space-3); font-size: 13px; font-weight: var(--font-medium); border-radius: var(--radius-md); border: 1px solid var(--color-gray-200); background: white; color: var(--color-gray-700); cursor: pointer; transition: all 0.15s ease; display: inline-flex; align-items: center; justify-content: center; gap: var(--space-1-5);"
              :style="selectedScenarios.includes(scenario.id)
                ? 'background: #f0fdfa; color: #14b8a6; border-color: #14b8a6;'
                : ''"
              onmouseover="if(!this.style.borderColor || this.style.borderColor === 'rgb(229, 231, 235)') this.style.background='#f9fafb'"
              onmouseout="if(!this.style.borderColor || this.style.borderColor === 'rgb(229, 231, 235)') this.style.background='#ffffff'"
            >
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M16 3h5v5"></path>
                <line x1="21" y1="3" x2="14" y2="10"></line>
                <path d="M8 21H3v-5"></path>
                <line x1="3" y1="21" x2="10" y2="14"></line>
              </svg>
              Compare
            </button>
            <button
              @click="deleteScenario(scenario.id)"
              style="padding: var(--space-2) var(--space-3); font-size: 13px; font-weight: var(--font-medium); border-radius: var(--radius-md); border: 1px solid var(--color-gray-200); background: white; color: #6b7280; cursor: pointer; transition: all 0.15s ease; display: inline-flex; align-items: center; justify-content: center;"
              onmouseover="this.style.background='#fef2f2'; this.style.color='#ef4444'; this.style.borderColor='#fecaca'"
              onmouseout="this.style.background='#ffffff'; this.style.color='#6b7280'; this.style.borderColor='#e5e7eb'"
            >
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
            </button>
          </div>
        </div>
      </template>
    </div>
  </section>

  <!-- ============================================
       COMPARISON RESULT PANEL
       ============================================ -->
  <section x-show="comparisonResult" x-cloak style="margin-bottom: var(--space-8);">
    <div style="background: white; border: 1px solid var(--color-gray-200); border-radius: var(--radius-xl); overflow: hidden;">

      <!-- Comparison Header -->
      <div style="padding: var(--space-5) var(--space-6); border-bottom: 1px solid var(--color-gray-200); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #f8fafc, #f0f9ff);">
        <div>
          <h2 style="font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--color-primary-500); margin: 0;">Comparison Results</h2>
          <p style="font-size: 13px; color: #6b7280; margin: var(--space-1) 0 0 0;">Side-by-side tax strategy analysis</p>
        </div>
        <button
          @click="comparisonResult = null"
          style="padding: var(--space-2) var(--space-4); font-size: 13px; font-weight: var(--font-medium); border-radius: var(--radius-md); border: 1px solid var(--color-gray-200); background: white; color: #6b7280; cursor: pointer; transition: all 0.15s ease;"
          onmouseover="this.style.background='#f3f4f6'"
          onmouseout="this.style.background='#ffffff'"
        >
          Dismiss
        </button>
      </div>

      <!-- Comparison Table -->
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
          <thead>
            <tr style="background: var(--color-gray-50);">
              <th style="padding: var(--space-3-5) var(--space-5); text-align: left; font-size: var(--text-xs); font-weight: var(--font-semibold); color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--color-gray-200); width: 200px;">Metric</th>
              <template x-for="(result, index) in (comparisonResult?.scenarios || [])" :key="index">
                <th
                  style="padding: var(--space-3-5) var(--space-5); text-align: right; font-size: 13px; font-weight: var(--font-semibold); border-bottom: 1px solid var(--color-gray-200);"
                  :style="result.is_winner ? 'color: #10b981;' : 'color: #374151;'"
                >
                  <div style="display: flex; align-items: center; justify-content: flex-end; gap: var(--space-2);">
                    <span x-text="result.name"></span>
                    <span
                      x-show="result.is_winner"
                      style="display: inline-flex; align-items: center; gap: 3px; padding: var(--space-0-5) var(--space-2); background: var(--color-success-50); color: var(--color-success-500); border-radius: 20px; font-size: 10px; font-weight: var(--font-semibold); text-transform: uppercase; letter-spacing: 0.5px;"
                    >
                      <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
                      Best
                    </span>
                  </div>
                </th>
              </template>
            </tr>
          </thead>
          <tbody>
            <!-- Filing Status -->
            <tr>
              <td style="padding: var(--space-3-5) var(--space-5); font-size: var(--text-sm); font-weight: var(--font-medium); color: var(--color-gray-700); border-bottom: 1px solid var(--color-gray-100);">Filing Status</td>
              <template x-for="(result, index) in (comparisonResult?.scenarios || [])" :key="'fs-' + index">
                <td style="padding: var(--space-3-5) var(--space-5); text-align: right; font-size: var(--text-sm); color: var(--color-gray-600); border-bottom: 1px solid var(--color-gray-100);" x-text="result.filing_status || 'N/A'"></td>
              </template>
            </tr>
            <!-- Total Income -->
            <tr>
              <td style="padding: var(--space-3-5) var(--space-5); font-size: var(--text-sm); font-weight: var(--font-medium); color: var(--color-gray-700); border-bottom: 1px solid var(--color-gray-100);">Total Income</td>
              <template x-for="(result, index) in (comparisonResult?.scenarios || [])" :key="'inc-' + index">
                <td style="padding: var(--space-3-5) var(--space-5); text-align: right; font-size: var(--text-sm); font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; color: var(--color-gray-700); border-bottom: 1px solid var(--color-gray-100);" x-text="formatCurrency(result.total_income)"></td>
              </template>
            </tr>
            <!-- Taxable Income -->
            <tr>
              <td style="padding: var(--space-3-5) var(--space-5); font-size: var(--text-sm); font-weight: var(--font-medium); color: var(--color-gray-700); border-bottom: 1px solid var(--color-gray-100);">Taxable Income</td>
              <template x-for="(result, index) in (comparisonResult?.scenarios || [])" :key="'ti-' + index">
                <td style="padding: var(--space-3-5) var(--space-5); text-align: right; font-size: var(--text-sm); font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; color: var(--color-gray-700); border-bottom: 1px solid var(--color-gray-100);" x-text="formatCurrency(result.taxable_income)"></td>
              </template>
            </tr>
            <!-- Total Tax Liability -->
            <tr>
              <td style="padding: var(--space-3-5) var(--space-5); font-size: var(--text-sm); font-weight: var(--font-semibold); color: var(--color-gray-800); border-bottom: 1px solid var(--color-gray-100);">Total Tax Liability</td>
              <template x-for="(result, index) in (comparisonResult?.scenarios || [])" :key="'ttl-' + index">
                <td
                  style="padding: var(--space-3-5) var(--space-5); text-align: right; font-size: 15px; font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; font-weight: var(--font-semibold); border-bottom: 1px solid var(--color-gray-100);"
                  :style="result.is_winner ? 'color: #10b981;' : 'color: #1f2937;'"
                  x-text="formatCurrency(result.total_tax)"
                ></td>
              </template>
            </tr>
            <!-- Effective Tax Rate -->
            <tr>
              <td style="padding: var(--space-3-5) var(--space-5); font-size: var(--text-sm); font-weight: var(--font-medium); color: var(--color-gray-700); border-bottom: 1px solid var(--color-gray-100);">Effective Tax Rate</td>
              <template x-for="(result, index) in (comparisonResult?.scenarios || [])" :key="'etr-' + index">
                <td
                  style="padding: var(--space-3-5) var(--space-5); text-align: right; font-size: var(--text-sm); font-weight: var(--font-medium); border-bottom: 1px solid var(--color-gray-100);"
                  :style="result.is_winner ? 'color: #10b981;' : 'color: #4b5563;'"
                  x-text="formatPercent(result.effective_rate)"
                ></td>
              </template>
            </tr>
            <!-- Marginal Rate -->
            <tr>
              <td style="padding: var(--space-3-5) var(--space-5); font-size: var(--text-sm); font-weight: var(--font-medium); color: var(--color-gray-700); border-bottom: 1px solid var(--color-gray-100);">Marginal Rate</td>
              <template x-for="(result, index) in (comparisonResult?.scenarios || [])" :key="'mr-' + index">
                <td style="padding: var(--space-3-5) var(--space-5); text-align: right; font-size: var(--text-sm); color: var(--color-gray-600); border-bottom: 1px solid var(--color-gray-100);" x-text="formatPercent(result.marginal_rate)"></td>
              </template>
            </tr>
            <!-- Savings Row -->
            <tr x-show="comparisonResult?.savings != null" style="background: #f0fdf4;">
              <td style="padding: var(--space-4) var(--space-5); font-size: var(--text-sm); font-weight: var(--font-semibold); color: #166534;">
                <div style="display: flex; align-items: center; gap: var(--space-2);">
                  <svg width="18" height="18" fill="none" stroke="#10b981" stroke-width="2" viewBox="0 0 24 24">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                    <polyline points="17 6 23 6 23 12"></polyline>
                  </svg>
                  Potential Savings
                </div>
              </td>
              <td
                :colspan="(comparisonResult?.scenarios || []).length"
                style="padding: var(--space-4) var(--space-5); text-align: right; font-size: var(--text-lg); font-weight: var(--font-bold); color: var(--color-success-500); font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;"
                x-text="formatCurrency(comparisonResult?.savings)"
              ></td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </section>

  <!-- ============================================
       CREATE SCENARIO MODAL
       ============================================ -->
  <div
    x-show="showCreateModal"
    x-cloak
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; padding: var(--space-6);"
    @click.self="showCreateModal = false"
    @keydown.escape.window="showCreateModal = false"
  >
    <div
      @click.stop
      style="background: white; border-radius: var(--radius-2xl); width: 100%; max-width: 580px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);"
    >
      <!-- Modal Header -->
      <div style="padding: var(--space-6) var(--space-6) 0 var(--space-6);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div>
            <h2 style="font-size: var(--text-xl); font-weight: var(--font-semibold); color: var(--color-gray-800); margin: 0;">Create New Scenario</h2>
            <p style="font-size: 13px; color: #6b7280; margin: var(--space-1-5) 0 0 0;">Define a tax scenario to explore different strategies</p>
          </div>
          <button
            @click="showCreateModal = false"
            style="padding: var(--space-1-5); border: none; background: none; color: #9ca3af; cursor: pointer; border-radius: var(--radius-md); transition: all 0.15s ease;"
            onmouseover="this.style.background='#f3f4f6'; this.style.color='#374151'"
            onmouseout="this.style.background='none'; this.style.color='#9ca3af'"
          >
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
        </div>
      </div>

      <!-- Modal Body -->
      <div style="padding: var(--space-6);">

        <!-- Name -->
        <div style="margin-bottom: var(--space-5);">
          <label style="display: block; font-size: 13px; font-weight: var(--font-medium); color: var(--color-gray-700); margin-bottom: var(--space-1-5);">
            Scenario Name <span style="color: var(--color-error-500);">*</span>
          </label>
          <input
            type="text"
            x-model="newScenario.name"
            placeholder="e.g., Max 401k Contributions"
            style="width: 100%; padding: var(--space-2-5) var(--space-3-5); font-size: var(--text-sm); border: 1px solid var(--color-gray-200); border-radius: var(--radius-lg); background: white; color: var(--color-gray-800); outline: none; transition: border-color 0.15s ease; font-family: 'Inter', sans-serif;"
            onfocus="this.style.borderColor='#1e3a5f'; this.style.boxShadow='0 0 0 3px rgba(30,58,95,0.08)'"
            onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
          >
        </div>

        <!-- Description -->
        <div style="margin-bottom: var(--space-5);">
          <label style="display: block; font-size: 13px; font-weight: var(--font-medium); color: var(--color-gray-700); margin-bottom: var(--space-1-5);">Description</label>
          <textarea
            x-model="newScenario.description"
            placeholder="Describe what this scenario explores..."
            rows="3"
            style="width: 100%; padding: var(--space-2-5) var(--space-3-5); font-size: var(--text-sm); border: 1px solid var(--color-gray-200); border-radius: var(--radius-lg); background: white; color: var(--color-gray-800); outline: none; transition: border-color 0.15s ease; font-family: 'Inter', sans-serif; resize: vertical;"
            onfocus="this.style.borderColor='#1e3a5f'; this.style.boxShadow='0 0 0 3px rgba(30,58,95,0.08)'"
            onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
          ></textarea>
        </div>

        <!-- Base Return ID -->
        <div style="margin-bottom: var(--space-5);">
          <label style="display: block; font-size: 13px; font-weight: var(--font-medium); color: var(--color-gray-700); margin-bottom: var(--space-1-5);">Base Return ID</label>
          <input
            type="text"
            x-model="newScenario.base_return_id"
            placeholder="Optional - link to existing return"
            style="width: 100%; padding: var(--space-2-5) var(--space-3-5); font-size: var(--text-sm); border: 1px solid var(--color-gray-200); border-radius: var(--radius-lg); background: white; color: var(--color-gray-800); outline: none; transition: border-color 0.15s ease; font-family: 'Inter', sans-serif;"
            onfocus="this.style.borderColor='#1e3a5f'; this.style.boxShadow='0 0 0 3px rgba(30,58,95,0.08)'"
            onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
          >
        </div>

        <!-- Filing Status -->
        <div style="margin-bottom: var(--space-5);">
          <label style="display: block; font-size: 13px; font-weight: var(--font-medium); color: var(--color-gray-700); margin-bottom: var(--space-1-5);">
            Filing Status <span style="color: var(--color-error-500);">*</span>
          </label>
          <select
            x-model="newScenario.filing_status"
            style="width: 100%; padding: var(--space-2-5) var(--space-3-5); font-size: var(--text-sm); border: 1px solid var(--color-gray-200); border-radius: var(--radius-lg); background: white; color: var(--color-gray-800); outline: none; transition: border-color 0.15s ease; font-family: 'Inter', sans-serif; cursor: pointer; appearance: none; background-image: url('data:image/svg+xml,<svg width=&quot;12&quot; height=&quot;8&quot; viewBox=&quot;0 0 12 8&quot; fill=&quot;none&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;><path d=&quot;M1 1.5L6 6.5L11 1.5&quot; stroke=&quot;%236b7280&quot; stroke-width=&quot;2&quot; stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot;/></svg>'); background-repeat: no-repeat; background-position: right 14px center;"
            onfocus="this.style.borderColor='#1e3a5f'; this.style.boxShadow='0 0 0 3px rgba(30,58,95,0.08)'"
            onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'"
          >
            <option value="single">Single</option>
            <option value="married_filing_jointly">Married Filing Jointly</option>
            <option value="married_filing_separately">Married Filing Separately</option>
            <option value="head_of_household">Head of Household</option>
            <option value="qualifying_surviving_spouse">Qualifying Surviving Spouse</option>
          </select>
        </div>

        <!-- Income Adjustments -->
        <div style="margin-bottom: var(--space-5);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2-5);">
            <label style="font-size: 13px; font-weight: var(--font-medium); color: var(--color-gray-700);">Income Adjustments</label>
            <button
              @click="newScenario.adjustments.push({ type: 'income', label: '', amount: 0 })"
              type="button"
              style="display: inline-flex; align-items: center; gap: var(--space-1); padding: var(--space-1) var(--space-2-5); font-size: var(--text-xs); font-weight: var(--font-medium); border-radius: var(--radius-md); border: 1px solid var(--color-gray-200); background: white; color: var(--color-accent-500); cursor: pointer; transition: all 0.15s ease;"
              onmouseover="this.style.background='#f0fdfa'"
              onmouseout="this.style.background='#ffffff'"
            >
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
              Add
            </button>
          </div>
          <template x-for="(adj, idx) in newScenario.adjustments.filter(a => a.type === 'income')" :key="'inc-adj-' + idx">
            <div style="display: flex; gap: var(--space-2-5); margin-bottom: var(--space-2); align-items: center;">
              <input
                type="text"
                x-model="adj.label"
                placeholder="Label (e.g., Side Income)"
                style="flex: 1; padding: var(--space-2) var(--space-3); font-size: 13px; border: 1px solid var(--color-gray-200); border-radius: var(--radius-md); background: white; color: var(--color-gray-800); outline: none; font-family: 'Inter', sans-serif;"
                onfocus="this.style.borderColor='#1e3a5f'"
                onblur="this.style.borderColor='#e5e7eb'"
              >
              <div style="position: relative; width: 140px;">
                <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 13px;">$</span>
                <input
                  type="number"
                  x-model.number="adj.amount"
                  placeholder="0"
                  style="width: 100%; padding: var(--space-2) var(--space-3) var(--space-2) 22px; font-size: 13px; border: 1px solid var(--color-gray-200); border-radius: var(--radius-md); background: white; color: var(--color-gray-800); outline: none; font-family: 'Inter', sans-serif;"
                  onfocus="this.style.borderColor='#1e3a5f'"
                  onblur="this.style.borderColor='#e5e7eb'"
                >
              </div>
              <button
                @click="newScenario.adjustments = newScenario.adjustments.filter((_, i) => newScenario.adjustments.indexOf(adj) !== newScenario.adjustments.indexOf(newScenario.adjustments[i]) || adj !== newScenario.adjustments[i]); newScenario.adjustments.splice(newScenario.adjustments.indexOf(adj), 1)"
                type="button"
                style="padding: var(--space-1-5); border: none; background: none; color: var(--color-gray-300); cursor: pointer; border-radius: 4px; transition: color 0.15s ease;"
                onmouseover="this.style.color='#ef4444'"
                onmouseout="this.style.color='#d1d5db'"
              >
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
            </div>
          </template>
          <p
            x-show="newScenario.adjustments.filter(a => a.type === 'income').length === 0"
            style="font-size: var(--text-xs); color: #9ca3af; font-style: italic; padding: var(--space-2) 0;"
          >No income adjustments added</p>
        </div>

        <!-- Deduction Adjustments -->
        <div style="margin-bottom: var(--space-5);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2-5);">
            <label style="font-size: 13px; font-weight: var(--font-medium); color: var(--color-gray-700);">Deduction Adjustments</label>
            <button
              @click="newScenario.adjustments.push({ type: 'deduction', label: '', amount: 0 })"
              type="button"
              style="display: inline-flex; align-items: center; gap: var(--space-1); padding: var(--space-1) var(--space-2-5); font-size: var(--text-xs); font-weight: var(--font-medium); border-radius: var(--radius-md); border: 1px solid var(--color-gray-200); background: white; color: var(--color-accent-500); cursor: pointer; transition: all 0.15s ease;"
              onmouseover="this.style.background='#f0fdfa'"
              onmouseout="this.style.background='#ffffff'"
            >
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
              Add
            </button>
          </div>
          <template x-for="(adj, idx) in newScenario.adjustments.filter(a => a.type === 'deduction')" :key="'ded-adj-' + idx">
            <div style="display: flex; gap: var(--space-2-5); margin-bottom: var(--space-2); align-items: center;">
              <input
                type="text"
                x-model="adj.label"
                placeholder="Label (e.g., Charitable Donation)"
                style="flex: 1; padding: var(--space-2) var(--space-3); font-size: 13px; border: 1px solid var(--color-gray-200); border-radius: var(--radius-md); background: white; color: var(--color-gray-800); outline: none; font-family: 'Inter', sans-serif;"
                onfocus="this.style.borderColor='#1e3a5f'"
                onblur="this.style.borderColor='#e5e7eb'"
              >
              <div style="position: relative; width: 140px;">
                <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 13px;">$</span>
                <input
                  type="number"
                  x-model.number="adj.amount"
                  placeholder="0"
                  style="width: 100%; padding: var(--space-2) var(--space-3) var(--space-2) 22px; font-size: 13px; border: 1px solid var(--color-gray-200); border-radius: var(--radius-md); background: white; color: var(--color-gray-800); outline: none; font-family: 'Inter', sans-serif;"
                  onfocus="this.style.borderColor='#1e3a5f'"
                  onblur="this.style.borderColor='#e5e7eb'"
                >
              </div>
              <button
                @click="newScenario.adjustments.splice(newScenario.adjustments.indexOf(adj), 1)"
                type="button"
                style="padding: var(--space-1-5); border: none; background: none; color: var(--color-gray-300); cursor: pointer; border-radius: 4px; transition: color 0.15s ease;"
                onmouseover="this.style.color='#ef4444'"
                onmouseout="this.style.color='#d1d5db'"
              >
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
              </button>
            </div>
          </template>
          <p
            x-show="newScenario.adjustments.filter(a => a.type === 'deduction').length === 0"
            style="font-size: var(--text-xs); color: #9ca3af; font-style: italic; padding: var(--space-2) 0;"
          >No deduction adjustments added</p>
        </div>

      </div>

      <!-- Modal Footer -->
      <div style="padding: var(--space-4) var(--space-6); border-top: 1px solid var(--color-gray-200); display: flex; justify-content: flex-end; gap: var(--space-3); background: var(--color-gray-50); border-radius: 0 0 var(--radius-2xl) var(--radius-2xl);">
        <button
          @click="showCreateModal = false"
          style="padding: var(--space-2-5) var(--space-5); font-size: var(--text-sm); font-weight: var(--font-medium); border-radius: var(--radius-lg); border: 1px solid var(--color-gray-200); background: white; color: var(--color-gray-700); cursor: pointer; transition: all 0.15s ease;"
          onmouseover="this.style.background='#f3f4f6'"
          onmouseout="this.style.background='#ffffff'"
        >
          Cancel
        </button>
        <button
          @click="createScenario()"
          :disabled="!newScenario.name.trim()"
          style="padding: var(--space-2-5) var(--space-5); font-size: var(--text-sm); font-weight: var(--font-medium); border-radius: var(--radius-lg); border: none; cursor: pointer; transition: all 0.15s ease; display: inline-flex; align-items: center; gap: var(--space-2);"
          :style="newScenario.name.trim()
            ? 'background: #1e3a5f; color: #ffffff;'
            : 'background: #e5e7eb; color: #9ca3af; cursor: not-allowed;'"
        >
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
          Save Scenario
        </button>
      </div>
    </div>
  </div>

  <!-- ============================================
       TOAST NOTIFICATIONS
       ============================================ -->
  <div
    x-show="toastMessage"
    x-cloak
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0 transform translate-y-2"
    x-transition:enter-end="opacity-100 transform translate-y-0"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    style="position: fixed; bottom: 24px; right: 24px; z-index: 300; padding: var(--space-3-5) var(--space-5); border-radius: 10px; font-size: var(--text-sm); font-weight: var(--font-medium); color: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); max-width: 400px;"
    :style="toastType === 'error' ? 'background: #ef4444;' : toastType === 'success' ? 'background: #10b981;' : 'background: #1f2937;'"
    x-text="toastMessage"
  ></div>

</div>

<!-- Spin animation -->
<style>
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

{% endblock %}

{% block scripts_extra %}
<script>
function scenarioManager() {
    return {
        scenarios: [],
        selectedScenarios: [],
        comparisonResult: null,
        showCreateModal: false,
        loading: false,
        toastMessage: '',
        toastType: 'info',
        newScenario: {
            name: '',
            description: '',
            base_return_id: '',
            filing_status: 'single',
            adjustments: []
        },

        async init() {
            await this.loadScenarios();
        },

        async loadScenarios() {
            this.loading = true;
            try {
                const res = await fetch('/api/scenarios');
                if (res.ok) {
                    this.scenarios = await res.json();
                }
            } catch (e) {
                console.error('Failed to load scenarios:', e);
            } finally {
                this.loading = false;
            }
        },

        async createScenario() {
            if (!this.newScenario.name.trim()) {
                this.showToast('Please enter a scenario name', 'error');
                return;
            }
            try {
                const res = await fetch('/api/scenarios', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newScenario)
                });
                if (res.ok) {
                    this.showCreateModal = false;
                    this.newScenario = {
                        name: '',
                        description: '',
                        base_return_id: '',
                        filing_status: 'single',
                        adjustments: []
                    };
                    await this.loadScenarios();
                    this.showToast('Scenario created successfully', 'success');
                } else {
                    const err = await res.json().catch(() => ({}));
                    this.showToast(err.detail || 'Failed to create scenario', 'error');
                }
            } catch (e) {
                this.showToast('Failed to create scenario', 'error');
            }
        },

        toggleSelect(id) {
            const idx = this.selectedScenarios.indexOf(id);
            if (idx > -1) {
                this.selectedScenarios.splice(idx, 1);
            } else if (this.selectedScenarios.length < 3) {
                this.selectedScenarios.push(id);
            } else {
                this.showToast('You can compare up to 3 scenarios at a time', 'error');
            }
        },

        async calculateScenario(id) {
            try {
                const res = await fetch(`/api/scenarios/${id}/calculate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (res.ok) {
                    await this.loadScenarios();
                    this.showToast('Scenario calculated successfully', 'success');
                } else {
                    this.showToast('Calculation failed', 'error');
                }
            } catch (e) {
                this.showToast('Calculation failed', 'error');
            }
        },

        async compareScenarios() {
            if (this.selectedScenarios.length < 2) {
                this.showToast('Select at least 2 scenarios to compare', 'error');
                return;
            }
            try {
                const res = await fetch('/api/scenarios/compare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scenario_ids: this.selectedScenarios })
                });
                if (res.ok) {
                    this.comparisonResult = await res.json();
                } else {
                    this.showToast('Comparison failed', 'error');
                }
            } catch (e) {
                this.showToast('Comparison failed', 'error');
            }
        },

        async quickAnalysis(type) {
            try {
                const res = await fetch(`/api/scenarios/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                if (res.ok) {
                    this.comparisonResult = await res.json();
                    this.showToast('Analysis complete', 'success');
                } else {
                    this.showToast('Analysis failed', 'error');
                }
            } catch (e) {
                this.showToast('Analysis failed', 'error');
            }
        },

        async deleteScenario(id) {
            if (!confirm('Delete this scenario? This action cannot be undone.')) return;
            try {
                const res = await fetch(`/api/scenarios/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    this.selectedScenarios = this.selectedScenarios.filter(s => s !== id);
                    await this.loadScenarios();
                    this.showToast('Scenario deleted', 'success');
                } else {
                    this.showToast('Failed to delete scenario', 'error');
                }
            } catch (e) {
                this.showToast('Failed to delete scenario', 'error');
            }
        },

        formatCurrency(val) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(val || 0);
        },

        formatPercent(val) {
            return (val || 0).toFixed(1) + '%';
        },

        showToast(message, type) {
            this.toastMessage = message;
            this.toastType = type || 'info';
            setTimeout(() => {
                this.toastMessage = '';
            }, 4000);
        }
    };
}
</script>
{% endblock %}
