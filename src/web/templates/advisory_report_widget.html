{% from 'macros/icons.html' import icon %}
<!---
  ADVISORY REPORT WIDGET - Progressive Disclosure Component

  This component provides 4 levels of progressive disclosure:
  Level 1: Preview Summary (shown immediately after tax calculation)
  Level 2: Detailed View (expandable sections)
  Level 3: Full Report Display (complete on-screen report)
  Level 4: PDF Export (optional download)

  Integration: Include this file's styles and scripts in index.html
-->

<style>
  /* =====================================================================
     ADVISORY REPORT PROGRESSIVE DISCLOSURE STYLES
     ===================================================================== */

  /* Container for advisory report */
  .advisory-report-container {
    margin-top: 40px;
    padding: 30px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }

  /* Level 1: Preview Summary */
  .advisory-preview {
    background: white;
    border-radius: 12px;
    padding: 32px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
  }

  .advisory-preview-header {
    text-align: center;
    margin-bottom: 32px;
  }

  .advisory-preview-title {
    font-size: 28px;
    font-weight: 700;
    color: #2c5aa0;
    margin-bottom: 8px;
  }

  .advisory-preview-subtitle {
    font-size: 16px;
    color: #6b7280;
  }

  .advisory-metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
  }

  .advisory-metric-card {
    background: linear-gradient(135deg, #f0f4f8 0%, #e6edf5 100%);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }

  .advisory-metric-card:hover {
    border-color: #2c5aa0;
    transform: translateY(-4px);
    box-shadow: 0 6px 20px rgba(44, 90, 160, 0.15);
  }

  .advisory-metric-label {
    font-size: 14px;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
    font-weight: 600;
  }

  .advisory-metric-value {
    font-size: 36px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 8px;
  }

  .advisory-metric-value.savings {
    color: #22c55e;
  }

  .advisory-metric-value.confidence {
    color: #2c5aa0;
  }

  .advisory-metric-sublabel {
    font-size: 12px;
    color: #9ca3af;
  }

  /* Top Recommendations Preview */
  .advisory-recommendations-preview {
    background: #f0f9ff;
    border: 2px solid #3b82f6;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 32px;
  }

  .advisory-recommendations-title {
    font-size: 18px;
    font-weight: 700;
    color: #1e3a8a;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .advisory-recommendation-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 16px;
    background: white;
    border-radius: 8px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
  }

  .advisory-recommendation-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transform: translateX(4px);
  }

  .advisory-recommendation-rank {
    font-size: 20px;
    font-weight: 700;
    color: #2c5aa0;
    min-width: 32px;
  }

  .advisory-recommendation-title {
    flex: 1;
    font-size: 15px;
    font-weight: 600;
    color: #1f2937;
  }

  .advisory-recommendation-savings {
    font-size: 18px;
    font-weight: 700;
    color: #22c55e;
  }

  /* Action Buttons */
  .advisory-actions {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .advisory-btn {
    padding: 14px 28px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    display: flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
  }

  .advisory-btn-primary {
    background: linear-gradient(135deg, #2c5aa0 0%, #1e3a6d 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(44, 90, 160, 0.3);
  }

  .advisory-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(44, 90, 160, 0.4);
  }

  .advisory-btn-secondary {
    background: white;
    color: #2c5aa0;
    border: 2px solid #2c5aa0;
  }

  .advisory-btn-secondary:hover {
    background: #2c5aa0;
    color: white;
  }

  /* Level 2: Detailed View */
  .advisory-detailed-view {
    display: none;
    margin-top: 32px;
    padding: 32px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }

  .advisory-detailed-view.active {
    display: block;
    animation: fadeInUp 0.4s ease;
  }

  .advisory-section {
    margin-bottom: 32px;
    padding-bottom: 32px;
    border-bottom: 2px solid #e5e7eb;
  }

  .advisory-section:last-child {
    border-bottom: none;
  }

  .advisory-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    padding: 16px 20px;
    background: #f9fafb;
    border-radius: 8px;
    margin-bottom: 16px;
    transition: all 0.2s ease;
  }

  .advisory-section-header:hover {
    background: #f3f4f6;
  }

  .advisory-section-title {
    font-size: 20px;
    font-weight: 700;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .advisory-section-toggle {
    font-size: 24px;
    color: #6b7280;
    transition: transform 0.3s ease;
  }

  .advisory-section-toggle.expanded {
    transform: rotate(180deg);
  }

  .advisory-section-content {
    padding: 0 20px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease;
  }

  .advisory-section-content.expanded {
    max-height: 2000px;
  }

  /* Level 3: Full Report */
  .advisory-full-report {
    display: none;
    margin-top: 32px;
  }

  .advisory-full-report.active {
    display: block;
    animation: fadeInUp 0.4s ease;
  }

  .advisory-report-header {
    background: linear-gradient(135deg, #2c5aa0 0%, #1e3a6d 100%);
    color: white;
    padding: 40px;
    border-radius: 12px 12px 0 0;
    text-align: center;
  }

  .advisory-report-title {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .advisory-report-subtitle {
    font-size: 16px;
    opacity: 0.9;
  }

  .advisory-report-body {
    background: white;
    padding: 40px;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }

  /* Loading State */
  .advisory-loading {
    text-align: center;
    padding: 60px 20px;
  }

  .advisory-loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid #e5e7eb;
    border-top-color: #2c5aa0;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .advisory-metrics-grid {
      grid-template-columns: 1fr;
    }

    .advisory-actions {
      flex-direction: column;
    }

    .advisory-btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>

<!-- HTML Structure for Advisory Report Widget -->
<div id="advisoryReportWidget" class="advisory-report-container" style="display: none;">
  <!-- Level 1: Preview Summary -->
  <div id="advisoryPreview" class="advisory-preview">
    <div class="advisory-preview-header">
      <div class="advisory-preview-title">{{ icon('chart-bar') }} Your Tax Advisory Report</div>
      <div class="advisory-preview-subtitle">Professional analysis of your tax situation</div>
    </div>

    <!-- Loading State -->
    <div id="advisoryLoading" class="advisory-loading">
      <div class="advisory-loading-spinner"></div>
      <div style="font-size: 16px; color: #6b7280;">Analyzing your tax situation...</div>
    </div>

    <!-- Metrics Grid -->
    <div id="advisoryMetrics" class="advisory-metrics-grid" style="display: none;">
      <div class="advisory-metric-card">
        <div class="advisory-metric-label">Current Tax Liability</div>
        <div class="advisory-metric-value" id="advisoryCurrentTax">$0</div>
        <div class="advisory-metric-sublabel">Based on your information</div>
      </div>

      <div class="advisory-metric-card">
        <div class="advisory-metric-label">Potential Savings</div>
        <div class="advisory-metric-value savings" id="advisorySavings">$0</div>
        <div class="advisory-metric-sublabel">Tax-saving opportunities</div>
      </div>

      <div class="advisory-metric-card">
        <div class="advisory-metric-label">Confidence Score</div>
        <div class="advisory-metric-value confidence" id="advisoryConfidence">0/100</div>
        <div class="advisory-metric-sublabel">Analysis reliability</div>
      </div>

      <div class="advisory-metric-card">
        <div class="advisory-metric-label">Recommendations</div>
        <div class="advisory-metric-value" id="advisoryRecommendationsCount">0</div>
        <div class="advisory-metric-sublabel">Action items identified</div>
      </div>
    </div>

    <!-- Top Recommendations Preview -->
    <div id="advisoryRecommendationsPreview" class="advisory-recommendations-preview" style="display: none;">
      <div class="advisory-recommendations-title">
        <span>{{ icon('light-bulb') }}</span>
        <span>Top Tax-Saving Opportunities</span>
      </div>
      <div id="advisoryTopRecommendations"></div>
    </div>

    <!-- Action Buttons -->
    <div id="advisoryActions" class="advisory-actions" style="display: none;">
      <button class="advisory-btn advisory-btn-primary" onclick="showAdvisoryDetailed()">
        {{ icon('clipboard-document-list') }} See Detailed Analysis
      </button>
      <button class="advisory-btn advisory-btn-secondary" onclick="showAdvisoryFullReport()">
        {{ icon('document-text') }} View Full Report
      </button>
    </div>
  </div>

  <!-- Level 2: Detailed View -->
  <div id="advisoryDetailedView" class="advisory-detailed-view">
    <button class="advisory-btn advisory-btn-secondary" onclick="backToPreview()" style="margin-bottom: 24px;">
      ‚Üê Back to Summary
    </button>

    <h2 style="font-size: 28px; font-weight: 700; color: #1f2937; margin-bottom: 32px;">
      Detailed Tax Analysis
    </h2>

    <!-- Sections will be dynamically added here -->
    <div id="advisoryDetailedSections"></div>

    <div class="advisory-actions" style="margin-top: 32px;">
      <button class="advisory-btn advisory-btn-primary" onclick="showAdvisoryFullReport()">
        {{ icon('document-text') }} View Full Report
      </button>
    </div>
  </div>

  <!-- Level 3: Full Report -->
  <div id="advisoryFullReport" class="advisory-full-report">
    <button class="advisory-btn advisory-btn-secondary" onclick="backToPreview()" style="margin-bottom: 24px;">
      ‚Üê Back to Summary
    </button>

    <div class="advisory-report-header">
      <div class="advisory-report-title" id="advisoryFullReportTitle">Tax Advisory Report</div>
      <div class="advisory-report-subtitle" id="advisoryFullReportSubtitle"></div>
    </div>

    <div class="advisory-report-body">
      <div id="advisoryFullReportContent"></div>

      <!-- Level 4: PDF Export -->
      <div class="advisory-actions" style="margin-top: 40px; padding-top: 32px; border-top: 2px solid #e5e7eb;">
        <button class="advisory-btn advisory-btn-primary" onclick="downloadAdvisoryPDF()" id="advisoryDownloadPDF">
          {{ icon('arrow-down-tray') }} Download PDF Report
        </button>
        <button class="advisory-btn advisory-btn-secondary" onclick="emailAdvisoryReport()" style="display: none;">
          {{ icon('envelope') }} Email Report
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  /* =====================================================================
     ADVISORY REPORT PROGRESSIVE DISCLOSURE JAVASCRIPT
     ===================================================================== */

  let currentAdvisoryReport = null;
  let currentReportId = null;

  /**
   * Escapes HTML special characters to prevent XSS attacks.
   * @param {string} text - The text to escape
   * @returns {string} The escaped text safe for HTML insertion
   */
  function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
  }

  /**
   * Level 1: Generate and show preview after tax calculation
   * Call this function after the tax return is calculated
   */
  async function generateAdvisoryReportPreview() {
    const sessionId = window.sessionId || sessionStorage.getItem('tax_session_id');

    if (!sessionId) {
      console.warn('No session ID found for advisory report');
      return;
    }

    // Show the widget with loading state
    document.getElementById('advisoryReportWidget').style.display = 'block';
    document.getElementById('advisoryLoading').style.display = 'block';
    document.getElementById('advisoryMetrics').style.display = 'none';

    try {
      // Call advisory API to generate report
      const response = await fetch('/api/v1/advisory-reports/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          session_id: sessionId,
          report_type: 'full_analysis',
          include_entity_comparison: true,
          include_multi_year: true,
          years_ahead: 3,
          generate_pdf: true,
          watermark: null
        })
      });

      if (!response.ok) {
        throw new Error(`Failed to generate report: ${response.statusText}`);
      }

      const reportData = await response.json();
      currentReportId = reportData.report_id;

      // Fetch full report data
      const dataResponse = await fetch(`/api/v1/advisory-reports/${currentReportId}/data`);
      if (dataResponse.ok) {
        currentAdvisoryReport = await dataResponse.json();
      }

      // Display preview
      displayAdvisoryPreview(reportData, currentAdvisoryReport);

    } catch (error) {
      console.error('Error generating advisory report:', error);
      document.getElementById('advisoryLoading').innerHTML = `
        <div style="color: #dc2626; font-size: 16px;">
          Unable to generate advisory report. Please try again.
        </div>
      `;
    }
  }

  /**
   * Display Level 1: Preview Summary
   */
  function displayAdvisoryPreview(reportData, fullReport) {
    // Hide loading
    document.getElementById('advisoryLoading').style.display = 'none';

    // Show metrics
    const metricsDiv = document.getElementById('advisoryMetrics');
    metricsDiv.style.display = 'grid';

    // Update metrics
    document.getElementById('advisoryCurrentTax').textContent =
      formatCurrency(reportData.current_tax_liability);

    document.getElementById('advisorySavings').textContent =
      formatCurrency(reportData.potential_savings);

    document.getElementById('advisoryConfidence').textContent =
      `${Math.round(reportData.confidence_score)}/100`;

    document.getElementById('advisoryRecommendationsCount').textContent =
      reportData.recommendations_count;

    // Display top 3 recommendations if available
    if (fullReport && fullReport.recommendations && fullReport.recommendations.immediate_actions) {
      const topRecommendations = fullReport.recommendations.immediate_actions.slice(0, 3);

      if (topRecommendations.length > 0) {
        const recommendationsDiv = document.getElementById('advisoryTopRecommendations');
        recommendationsDiv.innerHTML = topRecommendations.map((rec, index) => `
          <div class="advisory-recommendation-item">
            <div class="advisory-recommendation-rank">${index + 1}</div>
            <div class="advisory-recommendation-title">${escapeHtml(rec.title || rec.name)}</div>
            <div class="advisory-recommendation-savings">
              ${rec.savings ? formatCurrency(rec.savings) : ''}
            </div>
          </div>
        `).join('');

        document.getElementById('advisoryRecommendationsPreview').style.display = 'block';
      }
    }

    // Show action buttons
    document.getElementById('advisoryActions').style.display = 'flex';

    // Scroll to advisory widget
    document.getElementById('advisoryReportWidget').scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });
  }

  /**
   * Level 2: Show Detailed View
   */
  function showAdvisoryDetailed() {
    if (!currentAdvisoryReport) {
      alert('Report data not available');
      return;
    }

    // Hide preview, show detailed view
    document.getElementById('advisoryPreview').style.display = 'none';
    document.getElementById('advisoryDetailedView').classList.add('active');

    // Build sections
    const sectionsDiv = document.getElementById('advisoryDetailedSections');
    sectionsDiv.innerHTML = '';

    if (currentAdvisoryReport.sections) {
      currentAdvisoryReport.sections.forEach((section, index) => {
        const sectionHtml = `
          <div class="advisory-section">
            <div class="advisory-section-header" onclick="toggleAdvisorySection(${index})">
              <div class="advisory-section-title">
                <span>${getSectionIcon(section.section_id)}</span>
                <span>${escapeHtml(section.title)}</span>
              </div>
              <div class="advisory-section-toggle" id="toggle-${index}">‚ñº</div>
            </div>
            <div class="advisory-section-content" id="content-${index}">
              ${renderSectionContent(section)}
            </div>
          </div>
        `;
        sectionsDiv.innerHTML += sectionHtml;
      });
    }

    // Scroll to top of detailed view
    document.getElementById('advisoryDetailedView').scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });
  }

  /**
   * Toggle expandable section in detailed view
   */
  function toggleAdvisorySection(index) {
    const content = document.getElementById(`content-${index}`);
    const toggle = document.getElementById(`toggle-${index}`);

    if (content.classList.contains('expanded')) {
      content.classList.remove('expanded');
      toggle.classList.remove('expanded');
      content.style.maxHeight = '0';
    } else {
      content.classList.add('expanded');
      toggle.classList.add('expanded');
      content.style.maxHeight = content.scrollHeight + 'px';
    }
  }

  /**
   * Level 3: Show Full Report
   */
  function showAdvisoryFullReport() {
    if (!currentAdvisoryReport) {
      alert('Report data not available');
      return;
    }

    // Hide all previous views
    document.getElementById('advisoryPreview').style.display = 'none';
    document.getElementById('advisoryDetailedView').classList.remove('active');

    // Show full report
    document.getElementById('advisoryFullReport').classList.add('active');

    // Update header
    document.getElementById('advisoryFullReportTitle').textContent =
      `Tax Advisory Report - ${currentAdvisoryReport.taxpayer_name}`;

    document.getElementById('advisoryFullReportSubtitle').textContent =
      `Tax Year ${currentAdvisoryReport.tax_year} | Generated ${new Date(currentAdvisoryReport.generated_at).toLocaleDateString()}`;

    // Render all sections
    const contentDiv = document.getElementById('advisoryFullReportContent');
    contentDiv.innerHTML = '';

    if (currentAdvisoryReport.sections) {
      currentAdvisoryReport.sections.forEach(section => {
        const sectionHtml = `
          <div style="margin-bottom: 40px;">
            <h2 style="font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
              <span>${getSectionIcon(section.section_id)}</span>
              <span>${escapeHtml(section.title)}</span>
            </h2>
            <div style="padding-left: 44px;">
              ${renderSectionContent(section)}
            </div>
          </div>
        `;
        contentDiv.innerHTML += sectionHtml;
      });
    }

    // Scroll to full report
    document.getElementById('advisoryFullReport').scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });

    // Check if PDF is ready
    checkPDFStatus();
  }

  /**
   * Level 4: Download PDF
   */
  async function downloadAdvisoryPDF() {
    if (!currentReportId) {
      alert('No report available');
      return;
    }

    const btn = document.getElementById('advisoryDownloadPDF');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '{{ icon('clock') }} Preparing PDF...';

    try {
      // Check if PDF is ready
      const statusResponse = await fetch(`/api/v1/advisory-reports/${currentReportId}`);
      const statusData = await statusResponse.json();

      if (statusData.pdf_available) {
        // Download PDF
        window.open(`/api/v1/advisory-reports/${currentReportId}/pdf`, '_blank');
        btn.innerHTML = '{{ icon('check-circle') }} Downloaded!';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 2000);
      } else {
        // PDF not ready yet, wait and retry
        btn.innerHTML = '{{ icon('clock') }} Generating PDF...';
        setTimeout(() => downloadAdvisoryPDF(), 2000);
      }
    } catch (error) {
      console.error('Error downloading PDF:', error);
      alert('Failed to download PDF. Please try again.');
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  }

  /**
   * Check PDF status and update button
   */
  async function checkPDFStatus() {
    if (!currentReportId) return;

    try {
      const response = await fetch(`/api/v1/advisory-reports/${currentReportId}`);
      const data = await response.json();

      const btn = document.getElementById('advisoryDownloadPDF');
      if (data.pdf_available) {
        btn.disabled = false;
        btn.innerHTML = '{{ icon('arrow-down-tray') }} Download PDF Report';
      } else {
        btn.disabled = true;
        btn.innerHTML = '{{ icon('clock') }} Generating PDF...';
        // Check again in 2 seconds
        setTimeout(checkPDFStatus, 2000);
      }
    } catch (error) {
      console.error('Error checking PDF status:', error);
    }
  }

  /**
   * Go back to preview
   */
  function backToPreview() {
    document.getElementById('advisoryPreview').style.display = 'block';
    document.getElementById('advisoryDetailedView').classList.remove('active');
    document.getElementById('advisoryFullReport').classList.remove('active');

    // Scroll to preview
    document.getElementById('advisoryReportWidget').scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });
  }

  /**
   * Helper: Get icon for section
   */
  function getSectionIcon(sectionId) {
    const icons = {
      'executive_summary': '{{ icon('chart-bar') }}',
      'current_position': 'üìç',
      'recommendations': '{{ icon('light-bulb') }}',
      'entity_comparison': '{{ icon('building-office') }}',
      'multi_year_projection': '{{ icon('arrow-trending-up') }}',
      'action_plan': '{{ icon('check-circle') }}',
      'disclaimers': '{{ icon('clipboard-document-list') }}'
    };
    return icons[sectionId] || '{{ icon('document-text') }}';
  }

  /**
   * Helper: Render section content
   */
  function renderSectionContent(section) {
    if (!section.content) return '<p>No content available</p>';

    let html = '';

    // Render based on content structure
    Object.entries(section.content).forEach(([key, value]) => {
      if (typeof value === 'object' && !Array.isArray(value)) {
        // Nested object
        html += `<div style="margin-bottom: 20px;">
          <h4 style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 12px;">
            ${formatKey(key)}
          </h4>
          <div style="padding-left: 20px;">
            ${renderObject(value)}
          </div>
        </div>`;
      } else if (Array.isArray(value)) {
        // Array
        html += `<div style="margin-bottom: 20px;">
          <h4 style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 12px;">
            ${formatKey(key)}
          </h4>
          <ul style="list-style: disc; padding-left: 32px;">
            ${value.map(item => `<li style="margin-bottom: 8px;">${formatValue(item)}</li>`).join('')}
          </ul>
        </div>`;
      } else {
        // Simple value
        html += `<p style="margin-bottom: 12px;">
          <strong>${formatKey(key)}:</strong> ${formatValue(value)}
        </p>`;
      }
    });

    return html || '<p>No details available</p>';
  }

  /**
   * Helper: Render object content
   */
  function renderObject(obj) {
    let html = '';
    Object.entries(obj).forEach(([key, value]) => {
      html += `<p style="margin-bottom: 8px;">
        <strong>${formatKey(key)}:</strong> ${formatValue(value)}
      </p>`;
    });
    return html;
  }

  /**
   * Helper: Format key for display
   */
  function formatKey(key) {
    return key
      .replace(/_/g, ' ')
      .split(' ')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
  }

  /**
   * Helper: Format value for display
   */
  function formatValue(value) {
    if (typeof value === 'number') {
      if (Number.isInteger(value) && value > 1000) {
        return formatCurrency(value);
      }
      return value.toString();
    }
    if (typeof value === 'object') {
      return JSON.stringify(value, null, 2);
    }
    return value;
  }

  /**
   * Helper: Format currency
   */
  function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(amount);
  }

  /**
   * Email report (placeholder)
   */
  function emailAdvisoryReport() {
    alert('Email functionality coming soon!');
  }

  // Auto-generate report after calculation (optional - can be triggered manually)
  // Uncomment the line below to auto-generate after page load
  // window.addEventListener('load', () => setTimeout(generateAdvisoryReportPreview, 2000));

</script>
