<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Premium Tax Advisory | Individual Tax Strategy</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      /* Professional Tax Platform Theme - Clean & Trustworthy */
      --primary: #1a365d;           /* Navy blue - trust, professionalism */
      --primary-light: #2c5282;     /* Lighter navy */
      --primary-dark: #0d2137;      /* Darker navy */
      --accent: #2b6cb0;            /* Professional blue */
      --accent-light: #4299e1;      /* Lighter blue */
      --accent-gold: #c69214;       /* Muted gold for premium */
      --error: #c53030;             /* Professional red */
      --error-light: #fc8181;
      --warning: #c69214;           /* Muted amber */
      --success: #276749;           /* Professional green - money/savings */
      --success-light: #38a169;
      --bg: #f7fafc;                /* Light gray background */
      --surface: #ffffff;           /* White cards */
      --surface-light: #edf2f7;     /* Light gray surfaces */
      --surface-elevated: #e2e8f0;  /* Elevated surface */
      --text: #1a202c;              /* Dark text */
      --text-secondary: #4a5568;    /* Secondary text */
      --text-muted: #718096;        /* Muted text */
      --border: #e2e8f0;            /* Light borders */
      --border-light: #cbd5e0;      /* Slightly darker borders */
      --gradient: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
      --gradient-gold: linear-gradient(135deg, #c69214 0%, #975a16 100%);
      --gradient-premium: linear-gradient(135deg, #2c5282 0%, #1a365d 100%);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-glow: 0 0 40px rgba(26, 54, 93, 0.1);
    }

    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* Professional Light Background */
    .bg-animated {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      background: linear-gradient(180deg, #f7fafc 0%, #edf2f7 100%);
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.5; }
    }

    /* Header */
    .header {
      position: relative;
      z-index: 10;
      padding: 20px 40px;
      background: #1a365d;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 22px;
      font-weight: 700;
      color: #ffffff;
      letter-spacing: -0.5px;
    }

    .logo-subtitle {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 400;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-top: 2px;
    }

    .status-pill {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 24px;
      font-size: 13px;
      color: #ffffff;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #38a169;
      border-radius: 50%;
      animation: pulse-dot 2s ease-in-out infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    /* Main Container */
    .main {
      position: relative;
      z-index: 1;
      flex: 1;
      display: flex;
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      padding: 24px;
      gap: 24px;
    }

    /* Chat Panel */
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }

    .messages {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Custom Scrollbar */
    .messages::-webkit-scrollbar {
      width: 6px;
    }

    .messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .messages::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    /* Message Styles */
    .message {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      animation: fadeInUp 0.4s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
      background: #1a365d;
      box-shadow: var(--shadow-sm);
    }

    .message.user .avatar {
      background: #2c5282;
      box-shadow: var(--shadow-sm);
    }

    .bubble {
      max-width: 75%;
      padding: 18px 24px;
      border-radius: 16px;
      font-size: 15px;
      line-height: 1.7;
      letter-spacing: 0.1px;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    /* Ensure strategy content doesn't truncate */
    .bubble div,
    .bubble p,
    .bubble span {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .message.ai .bubble {
      background: #f7fafc;
      border: 1px solid var(--border);
      color: var(--text);
      box-shadow: var(--shadow-sm);
    }

    .message.ai .bubble strong {
      color: #1a365d;
    }

    .message.user .bubble {
      background: #1a365d;
      color: white;
      border: none;
      box-shadow: var(--shadow-md);
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    .quick-action {
      background: #ffffff;
      border: 2px solid #1a365d;
      padding: 12px 22px;
      border-radius: 8px;
      font-size: 14px;
      color: #1a365d;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      z-index: 10;
      user-select: none;
      font-weight: 600;
      letter-spacing: 0.2px;
    }

    .quick-action:hover {
      background: #1a365d;
      color: #ffffff;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .quick-action:active {
      transform: translateY(0);
    }

    .quick-action:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
    }

    .quick-action.primary {
      background: #1a365d;
      border: none;
      color: white;
    }

    .quick-action.primary:hover {
      background: #2c5282;
      box-shadow: var(--shadow-md);
    }

    /* Insight Cards */
    .insight-card {
      background: #f0fff4;
      border: 1px solid #c6f6d5;
      border-left: 4px solid #276749;
      border-radius: 8px;
      padding: 24px;
      margin-top: 20px;
      box-shadow: var(--shadow-sm);
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .insight-card * {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .insight-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 14px;
      font-weight: 700;
      color: #276749;
      font-size: 16px;
    }

    .insight-card .savings-amount {
      font-size: 28px;
      font-weight: 800;
      color: #276749;
    }

    /* Input Area */
    .input-area {
      padding: 24px 32px;
      background: #ffffff;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 16px;
      align-items: flex-end;
    }

    .input-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-box {
      display: flex;
      gap: 12px;
      background: #f7fafc;
      padding: 16px 22px;
      border-radius: 12px;
      border: 2px solid var(--border);
      transition: all 0.2s;
    }

    .input-box:focus-within {
      background: #ffffff;
      border-color: #1a365d;
      box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
    }

    #userInput {
      flex: 1;
      border: none;
      background: none;
      font-size: 15px;
      color: var(--text);
      outline: none;
      resize: none;
      min-height: 24px;
      max-height: 120px;
      font-family: inherit;
      line-height: 1.5;
    }

    #userInput::placeholder {
      color: var(--text-muted);
    }

    .action-btns {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      background: #ffffff;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 20px;
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: #f7fafc;
      border-color: #1a365d;
      color: #1a365d;
    }

    .send-btn {
      background: #1a365d;
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--shadow-md);
      letter-spacing: 0.3px;
    }

    .send-btn:hover {
      background: #2c5282;
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }

    .send-btn:active {
      transform: translateY(0);
    }

    .send-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }

    /* Side Panel */
    .side-panel {
      width: 360px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .panel-card {
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow-md);
    }

    .panel-header {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #1a365d;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .progress-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #1a365d 0%, #2c5282 100%);
      transition: width 0.5s ease;
    }

    .stats-grid {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      background: #f7fafc;
      border-radius: 8px;
      font-size: 14px;
    }

    .stat-label {
      color: var(--text-secondary);
    }

    .stat-value {
      color: var(--text);
      font-weight: 600;
    }

    /* ============================================
       PROGRESS STEPPER - Visual Journey Tracker
       ============================================ */
    .journey-stepper {
      display: flex;
      justify-content: space-between;
      padding: 20px 24px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .journey-stepper::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 60px;
      right: 60px;
      height: 2px;
      background: var(--border);
      transform: translateY(-50%);
      z-index: 0;
    }

    .journey-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ffffff;
      border: 2px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .journey-step.active .step-icon {
      background: #1a365d;
      border-color: #1a365d;
      box-shadow: 0 2px 8px rgba(26, 54, 93, 0.25);
    }

    .journey-step.completed .step-icon {
      background: #276749;
      border-color: #276749;
    }

    .step-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }

    .journey-step.active .step-label {
      color: #1a365d;
      font-weight: 600;
    }

    .journey-step.completed .step-label {
      color: #276749;
    }

    /* ============================================
       ERROR & STATUS STATES
       ============================================ */
    .error-banner {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 16px 20px;
      margin: 16px 0;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .error-banner .error-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .error-banner .error-content {
      flex: 1;
    }

    .error-banner .error-title {
      font-weight: 600;
      color: var(--error-light);
      margin-bottom: 4px;
    }

    .error-banner .error-message {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .error-banner .retry-btn {
      background: var(--error);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.2s;
    }

    .error-banner .retry-btn:hover {
      background: #dc2626;
    }

    .warning-banner {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 12px;
      padding: 16px 20px;
      margin: 16px 0;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      color: var(--accent-gold);
    }

    .success-banner {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 12px;
      padding: 16px 20px;
      margin: 16px 0;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      color: var(--accent-light);
    }

    /* ============================================
       LOADING STATES
       ============================================ */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 20px;
      font-size: 16px;
      color: var(--text-secondary);
    }

    .loading-subtext {
      margin-top: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Skeleton loading for content */
    .skeleton {
      background: linear-gradient(90deg, var(--surface-light) 25%, var(--surface-elevated) 50%, var(--surface-light) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-text {
      height: 16px;
      margin: 8px 0;
    }

    .skeleton-title {
      height: 24px;
      width: 60%;
      margin-bottom: 16px;
    }

    .skeleton-card {
      height: 100px;
      margin: 12px 0;
    }

    /* ============================================
       HELP TOOLTIPS
       ============================================ */
    .help-tooltip {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: var(--surface-light);
      border-radius: 50%;
      font-size: 11px;
      color: var(--text-muted);
      cursor: help;
      margin-left: 6px;
    }

    .help-tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface-elevated);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      white-space: nowrap;
      max-width: 250px;
      white-space: normal;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }

    .help-tooltip:hover::after {
      opacity: 1;
      visibility: visible;
      bottom: calc(100% + 8px);
    }

    /* ============================================
       DATA SUMMARY CARDS
       ============================================ */
    .data-summary {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0;
    }

    .data-summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .data-summary-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .data-summary-edit {
      font-size: 12px;
      color: var(--accent-light);
      cursor: pointer;
      text-decoration: underline;
    }

    .data-summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .data-summary-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .data-summary-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .data-summary-value {
      font-size: 14px;
      color: var(--text);
      font-weight: 500;
    }

    .data-summary-value.highlight {
      color: var(--accent-light);
    }

    /* ============================================
       CONFIDENCE INDICATOR
       ============================================ */
    .confidence-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .confidence-badge.high {
      background: rgba(16, 185, 129, 0.2);
      color: var(--accent-light);
    }

    .confidence-badge.medium {
      background: rgba(245, 158, 11, 0.2);
      color: var(--accent-gold);
    }

    .confidence-badge.low {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error-light);
    }

    .confidence-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* ============================================
       OFFLINE INDICATOR
       ============================================ */
    .offline-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--error);
      color: white;
      padding: 10px 20px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      z-index: 9999;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
    }

    .offline-banner.active {
      transform: translateY(0);
    }

    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      gap: 6px;
      padding: 16px 20px;
    }

    .typing-indicator span {
      width: 10px;
      height: 10px;
      background: var(--primary-light);
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
      }
      30% {
        transform: translateY(-12px);
        opacity: 1;
      }
    }

    /* Document Upload Zone */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: var(--surface);
    }

    .upload-zone:hover {
      border-color: var(--primary);
      background: rgba(30, 64, 175, 0.05);
    }

    .upload-zone.dragover {
      border-color: var(--accent);
      background: rgba(5, 150, 105, 0.1);
    }

    /* AI Disclaimer Banner */
    .ai-disclaimer-banner {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 13px;
    }

    .disclaimer-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .disclaimer-item:last-child {
      margin-bottom: 0;
    }

    .disclaimer-icon {
      flex-shrink: 0;
    }

    /* Confidence Indicator Styles */
    .confidence-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 6px;
      margin: 12px 0;
    }

    .confidence-high {
      background: rgba(16, 185, 129, 0.1);
      border-left: 3px solid #10b981;
    }

    .confidence-medium {
      background: rgba(245, 158, 11, 0.1);
      border-left: 3px solid #f59e0b;
    }

    .confidence-low {
      background: rgba(239, 68, 68, 0.1);
      border-left: 3px solid #ef4444;
    }

    /* Screen Reader Only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Focus Visible for Accessibility */
    .quick-action:focus-visible,
    button:focus-visible,
    textarea:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Reduced Motion Support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .main {
        flex-direction: column;
      }

      .side-panel {
        width: 100%;
      }

      .ai-disclaimer-banner {
        font-size: 12px;
        padding: 10px 12px;
      }
    }

    @media (max-width: 480px) {
      .ai-disclaimer-banner {
        border-radius: 8px;
        margin-bottom: 12px;
      }

      .disclaimer-item {
        font-size: 11px;
      }
    }

    /* Header Right Section */
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .clear-chat-btn {
      padding: 8px 16px;
      background: var(--surface-light);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .clear-chat-btn:hover {
      background: var(--border);
      color: var(--text);
    }

    /* Connection Status */
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 20px;
      font-size: 13px;
      color: var(--accent);
      transition: all 0.3s;
    }

    .connection-status.offline {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .connection-status.offline .status-dot {
      background: #ef4444;
      animation: none;
    }

    /* Consent Modal */
    .consent-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(26, 54, 93, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .consent-modal.hidden {
      display: none;
    }

    .consent-content {
      background: #ffffff;
      border-radius: 12px;
      max-width: 560px;
      width: 100%;
      padding: 32px;
      border: 1px solid var(--border);
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.15);
    }

    .consent-content h2 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #1a365d;
    }

    .consent-body {
      margin-bottom: 24px;
    }

    .consent-body p {
      color: var(--text-secondary);
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .consent-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: #ebf8ff;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .consent-item.warning {
      background: #fffbeb;
      border-left: 3px solid #c69214;
    }

    .consent-icon {
      font-size: 18px;
      flex-shrink: 0;
    }

    .consent-checkbox {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: #f7fafc;
      border-radius: 8px;
      margin-top: 20px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
      border: 1px solid var(--border);
    }

    .consent-checkbox input {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      cursor: pointer;
      accent-color: #1a365d;
    }

    .consent-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .consent-link {
      color: #2b6cb0;
      text-decoration: none;
      font-size: 14px;
    }

    .consent-link:hover {
      text-decoration: underline;
    }

    .consent-btn {
      padding: 14px 32px;
      background: #1a365d;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .consent-btn:disabled {
      background: #cbd5e0;
      color: #718096;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .consent-btn:not(:disabled) {
      background: #1a365d;
      cursor: pointer;
    }

    .consent-btn:not(:disabled):hover {
      background: #2c5282;
      transform: translateY(-1px);
    }

    /* Message Timestamp */
    .message-time {
      font-size: 11px;
      color: var(--text-secondary);
      opacity: 0.6;
      margin-top: 8px;
      display: block;
    }

    .message.user .message-time {
      text-align: right;
    }

    /* Copy Button */
    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      background: var(--surface-light);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .bubble {
      position: relative;
    }

    .bubble:hover .copy-btn {
      opacity: 1;
    }

    .copy-btn:hover {
      background: var(--border);
    }

    /* Improved Typing Indicator Accessibility */
    .typing-indicator[aria-label] {
      position: relative;
    }

    @media (max-width: 768px) {
      .header-right {
        gap: 8px;
      }

      .clear-chat-btn {
        padding: 6px 12px;
        font-size: 12px;
      }

      .connection-status {
        padding: 6px 12px;
        font-size: 12px;
      }

      .consent-content {
        padding: 20px;
      }

      .consent-content h2 {
        font-size: 20px;
      }
    }

    /* =================================================================
       COMPREHENSIVE MOBILE RESPONSIVE STYLES
       Addresses audit findings for mobile UX improvements
       ================================================================= */

    /* Small tablets and large phones (768px and below) */
    @media (max-width: 768px) {
      .header {
        padding: 12px 16px;
      }

      .logo {
        font-size: 16px;
      }

      .input-area {
        padding: 16px;
        gap: 8px;
      }

      .input-box {
        padding: 12px 16px;
        border-radius: 16px;
      }

      #userInput {
        font-size: 16px; /* Prevents iOS zoom on focus */
        min-height: 20px;
      }

      .message {
        max-width: 90%;
        padding: 14px 16px;
        font-size: 14px;
      }

      .action-btns button {
        min-width: 44px; /* Touch target minimum */
        min-height: 44px;
        padding: 10px;
      }

      .side-panel {
        padding: 16px;
      }
    }

    /* Mobile phones (480px and below) */
    @media (max-width: 480px) {
      .header {
        padding: 10px 12px;
        flex-wrap: wrap;
        gap: 8px;
      }

      .logo {
        font-size: 14px;
        flex: 1;
      }

      .header-right {
        width: 100%;
        justify-content: space-between;
      }

      .clear-chat-btn {
        padding: 8px 12px;
        font-size: 11px;
      }

      .connection-status {
        padding: 6px 10px;
        font-size: 11px;
      }

      .input-area {
        padding: 12px;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 100;
        background: rgba(15, 23, 42, 0.98);
      }

      .input-box {
        padding: 10px 14px;
        border-radius: 12px;
      }

      #userInput {
        font-size: 16px;
        min-height: 18px;
      }

      .message {
        max-width: 95%;
        padding: 12px 14px;
        font-size: 14px;
        border-radius: 16px;
      }

      .message.user {
        border-radius: 16px 16px 4px 16px;
      }

      .message.assistant {
        border-radius: 16px 16px 16px 4px;
      }

      /* Add bottom padding to messages for fixed input */
      .messages-area {
        padding-bottom: 100px;
      }

      .consent-modal {
        align-items: flex-end;
      }

      .consent-content {
        padding: 16px;
        border-radius: 20px 20px 0 0;
        max-height: 85vh;
        overflow-y: auto;
      }

      .consent-content h2 {
        font-size: 18px;
      }

      .consent-item {
        font-size: 13px;
        padding: 10px;
      }

      .consent-checkbox span {
        font-size: 12px;
      }

      .consent-btn {
        padding: 14px 24px;
        font-size: 15px;
        width: 100%;
      }
    }

    /* Extra small phones (320px - iPhone SE, etc.) */
    @media (max-width: 375px) {
      .header {
        padding: 8px 10px;
      }

      .logo {
        font-size: 13px;
      }

      .input-area {
        padding: 10px;
      }

      .input-box {
        padding: 8px 12px;
      }

      .message {
        font-size: 13px;
        padding: 10px 12px;
      }

      .action-btns {
        flex-direction: column;
        gap: 4px;
      }

      .action-btns button {
        width: 100%;
      }
    }

    /* Keyboard open on mobile - reduce input area height */
    @media (max-height: 500px) and (max-width: 768px) {
      .input-area {
        padding: 8px 12px;
      }

      .input-box {
        padding: 8px 12px;
      }

      .messages-area {
        padding-bottom: 80px;
      }
    }

    /* Touch-friendly buttons and interactions */
    @media (hover: none) and (pointer: coarse) {
      .action-btns button,
      .clear-chat-btn,
      .consent-btn {
        min-height: 44px;
        min-width: 44px;
      }

      /* Remove hover effects on touch devices */
      .message:hover,
      .input-box:hover {
        transform: none;
      }

      /* Add active states for touch feedback */
      .action-btns button:active,
      .clear-chat-btn:active,
      .consent-btn:active {
        transform: scale(0.98);
        opacity: 0.9;
      }
    }

    /* Safe area insets for notched phones */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .input-area {
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
      }
    }

    /* =================================================================
       FORM VALIDATION FEEDBACK STYLES
       Real-time validation visual indicators
       ================================================================= */
    .field-valid {
      border-color: #10b981 !important;
      background: rgba(16, 185, 129, 0.05) !important;
    }

    .field-valid::after {
      content: '‚úì';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #10b981;
      font-size: 16px;
    }

    .field-error {
      border-color: #ef4444 !important;
      background: rgba(239, 68, 68, 0.05) !important;
    }

    .field-warning {
      border-color: #f59e0b !important;
      background: rgba(245, 158, 11, 0.05) !important;
    }

    .validation-message {
      font-size: 12px;
      margin-top: 4px;
      padding: 4px 8px;
      border-radius: 4px;
      display: none;
    }

    .validation-message.error {
      display: block;
      color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }

    .validation-message.warning {
      display: block;
      color: #f59e0b;
      background: rgba(245, 158, 11, 0.1);
    }

    .validation-message.success {
      display: block;
      color: #10b981;
      background: rgba(16, 185, 129, 0.1);
    }

    /* Loading/Skeleton states */
    .skeleton {
      background: linear-gradient(90deg, var(--surface) 25%, var(--surface-light) 50%, var(--surface) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-message {
      height: 60px;
      margin: 8px 0;
      max-width: 70%;
    }

    /* Progress indicator */
    .progress-container {
      width: 100%;
      height: 4px;
      background: var(--surface);
      border-radius: 2px;
      overflow: hidden;
      margin: 8px 0;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 12px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 4px;
    }

    /* Skip to content link for keyboard navigation */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--primary);
      color: white;
      padding: 8px 16px;
      z-index: 1000;
      text-decoration: none;
      border-radius: 0 0 4px 0;
    }

    .skip-link:focus {
      top: 0;
    }

    /* Focus visible styles for accessibility */
    *:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Reduced motion preference */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
  <!-- Loading States Manager for accessible loading indicators -->
  <script src="/static/js/loading-states.js" defer></script>
</head>
<body>
  <!-- Skip link for keyboard navigation -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Offline Detection Banner -->
  <div class="offline-banner" id="offlineBanner" role="alert" aria-live="assertive">
    ‚ö†Ô∏è You're offline. Your messages will be sent when connection is restored.
  </div>

  <!-- Loading Overlay for Heavy Operations -->
  <div class="loading-overlay" id="loadingOverlay" role="alert" aria-live="polite">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Analyzing your tax situation...</div>
    <div class="loading-subtext" id="loadingSubtext">This may take a few moments</div>
  </div>

  <div class="bg-animated" aria-hidden="true"></div>

  <header class="header" role="banner">
    <div>
      <div class="logo">JORSS-GBO Tax Advisory</div>
      <div class="logo-subtitle">AI-Powered Wealth Strategy</div>
    </div>
    <div class="header-right">
      <button class="clear-chat-btn" onclick="clearConversation()" title="Start new conversation" aria-label="Start new conversation">
        üîÑ New Chat
      </button>
      <div class="connection-status" id="connectionStatus" role="status" aria-live="polite">
        <span class="status-dot" id="connectionDot"></span>
        <span id="connectionText">Connected</span>
      </div>
    </div>
  </header>

  <!-- Data Collection Consent Modal -->
  <div class="consent-modal" id="consentModal" role="dialog" aria-modal="true" aria-labelledby="consentTitle">
    <div class="consent-content">
      <h2 id="consentTitle">üìã Before We Begin</h2>
      <div class="consent-body">
        <p><strong>This AI assistant will collect personal tax information to provide guidance.</strong></p>

        <div class="consent-item">
          <span class="consent-icon">üîí</span>
          <span><strong>Data Security:</strong> All information is encrypted (AES-256) in transit and at rest.</span>
        </div>

        <div class="consent-item">
          <span class="consent-icon">‚è∞</span>
          <span><strong>Data Retention:</strong> Your session data is automatically deleted after 30 days of inactivity.</span>
        </div>

        <div class="consent-item">
          <span class="consent-icon">üö´</span>
          <span><strong>No Selling:</strong> We never sell or share your personal information with third parties.</span>
        </div>

        <div class="consent-item warning">
          <span class="consent-icon">‚ö†Ô∏è</span>
          <span><strong>IRS Circular 230 Notice:</strong> This AI provides general guidance only, NOT professional tax advice. It cannot represent you before the IRS. For complex tax situations, always consult a licensed CPA, EA, or tax attorney.</span>
        </div>

        <label class="consent-checkbox" onclick="document.getElementById('acceptConsentBtn').disabled = !document.getElementById('dataConsent').checked;">
          <input type="checkbox" id="dataConsent" required onchange="document.getElementById('acceptConsentBtn').disabled = !this.checked;">
          <span>I understand and consent to the collection of my tax information for advisory purposes. I acknowledge this is NOT professional tax advice.</span>
        </label>
      </div>

      <div class="consent-actions">
        <a href="/privacy" target="_blank" class="consent-link">Privacy Policy</a>
        <a href="/terms" target="_blank" class="consent-link">Terms of Service</a>
        <button class="consent-btn" id="acceptConsentBtn" disabled onclick="if(document.getElementById('dataConsent').checked){sessionStorage.setItem('tax_data_consent','true');document.getElementById('consentModal').classList.add('hidden');if(typeof initializeSession==='function')initializeSession();}">
          ‚úì Accept & Continue
        </button>
      </div>
    </div>
  </div>

  <main class="main" id="main-content" role="main">
    <div class="chat-panel">
      <!-- Privacy & AI Disclaimer Notice -->
      <div class="ai-disclaimer-banner" role="alert" aria-label="Important notices about AI assistance and privacy">
        <div class="disclaimer-item">
          <span class="disclaimer-icon">ü§ñ</span>
          <span><strong>AI Assistant:</strong> I provide estimates and general guidance, not professional tax advice. Always verify with a licensed CPA or tax professional.</span>
        </div>
        <div class="disclaimer-item">
          <span class="disclaimer-icon">üîí</span>
          <span><strong>Privacy:</strong> Your data is encrypted and never sold. <a href="/privacy" style="color: var(--primary);">Privacy Policy</a></span>
        </div>
      </div>

      <!-- Journey Progress Stepper -->
      <div class="journey-stepper" id="journeyStepper" role="navigation" aria-label="Tax advisory progress">
        <div class="journey-step active" data-step="1" id="step-1">
          <div class="step-icon">üìã</div>
          <div class="step-label">Profile</div>
        </div>
        <div class="journey-step" data-step="2" id="step-2">
          <div class="step-icon">üí∞</div>
          <div class="step-label">Income</div>
        </div>
        <div class="journey-step" data-step="3" id="step-3">
          <div class="step-icon">üéØ</div>
          <div class="step-label">Analysis</div>
        </div>
        <div class="journey-step" data-step="4" id="step-4">
          <div class="step-icon">üìä</div>
          <div class="step-label">Report</div>
        </div>
      </div>

      <div class="messages" id="messages" role="log" aria-live="polite" aria-label="Conversation with AI tax advisor">
        <!-- Premium initial message -->
        <div class="message ai" role="article" aria-label="AI assistant message">
          <div class="avatar" aria-hidden="true">üíº</div>
          <div class="bubble">
            <div style="margin-bottom: 16px;">
              <span style="font-size: 24px; font-weight: 700; color: var(--accent-light);">Welcome to Your Tax Advisory Session</span>
            </div>
            I'm your AI-powered tax strategist, trained on thousands of tax scenarios to help you <strong>maximize savings</strong> and <strong>minimize liability</strong>.<br><br>
            <div class="insight-card" style="margin: 16px 0;">
              <div class="insight-header">
                <span>üìä</span>
                <span>Average Client Savings</span>
              </div>
              <div class="savings-amount">$4,200 - $12,500</div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">per year through strategic tax planning</div>
            </div>
            <strong>How would you like to begin?</strong>
            <div class="quick-actions" id="initialQuickActions" style="margin-top: 20px;" role="group" aria-label="Quick response options">
              <button class="quick-action primary" data-action="no_manual" aria-label="Start guided analysis">Start Guided Analysis ‚Üí</button>
              <button class="quick-action" data-action="yes_upload" aria-label="Upload tax documents">Upload Documents</button>
              <button class="quick-action" data-action="what_docs" aria-label="Learn more about the process">Learn More</button>
            </div>
          </div>
        </div>
      </div>

      <div class="input-area" role="form" aria-label="Send a message to AI advisor">
        <div class="input-wrapper">
          <label for="userInput" class="sr-only">Type your message or question about taxes</label>
          <div class="input-box">
            <textarea
              id="userInput"
              placeholder="Share your questions or financial situation with me..."
              rows="1"
              onkeydown="handleKeyDown(event)"
              aria-label="Type your message or question about taxes"
              aria-describedby="inputHint"
            ></textarea>
            <span id="inputHint" class="sr-only">Press Enter to send, Shift+Enter for new line</span>
            <div class="action-btns">
              <button class="icon-btn" onclick="uploadDocument()" title="Upload Document" aria-label="Upload a tax document">
                <span aria-hidden="true">üìé</span>
              </button>
              <button class="icon-btn" onclick="addVoiceInput()" title="Voice Input" aria-label="Use voice input">
                <span aria-hidden="true">üé§</span>
              </button>
            </div>
          </div>
        </div>
        <button class="send-btn" onclick="sendMessage()" id="sendBtn">
          Send
        </button>
      </div>
    </div>

    <div class="side-panel">
      <div class="panel-card">
        <div class="panel-header">üìä Advisory Progress</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div style="text-align: center; font-size: 13px; color: var(--text-secondary);">
          <span id="progressText">Not started</span>
        </div>
        <div class="stats-grid" id="statsGrid">
          <!-- Stats will be populated dynamically -->
        </div>
      </div>

      <div class="panel-card">
        <div class="panel-header">üí° Strategic Recommendations</div>
        <div id="insights" style="font-size: 14px; color: var(--text-secondary);">
          I'll share personalized recommendations as we review your financial situation...
        </div>
      </div>

      <div class="panel-card" id="uploadPanel">
        <div class="panel-header">üìÅ Quick Upload</div>
        <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
          <div style="font-size: 32px; margin-bottom: 8px;">üìÑ</div>
          <div style="font-size: 14px; margin-bottom: 4px;">Drop documents here</div>
          <div style="font-size: 12px; color: var(--text-secondary);">or click to browse</div>
        </div>
        <input type="file" id="fileInput" style="display: none" onchange="handleFileSelect(event)" accept=".pdf,.jpg,.jpeg,.png" multiple aria-label="Upload tax documents">
      </div>
    </div>
  </main>

  <script>
    let sessionId = null;
    let conversationHistory = [];
    let extractedData = {
      // Lead Information (for CPA handoff)
      contact: {
        name: null,
        email: null,
        phone: null,
        preferred_contact: null
      },

      // Tax Profile
      tax_profile: {
        filing_status: null,
        total_income: null,
        w2_income: null,
        business_income: null,
        investment_income: null,
        rental_income: null,
        dependents: null,
        state: null
      },

      // Deductions & Credits
      tax_items: {
        mortgage_interest: null,
        property_tax: null,
        charitable: null,
        medical: null,
        student_loan_interest: null,
        retirement_contributions: null,
        has_hsa: false,
        has_529: false
      },

      // Business Details (if applicable)
      business: {
        type: null,
        revenue: null,
        expenses: null,
        entity_type: null
      },

      // Lead Scoring
      lead_data: {
        score: 0,
        complexity: 'simple', // simple, moderate, complex
        estimated_savings: 0,
        engagement_level: 0,
        ready_for_cpa: false,
        urgency: 'normal' // normal, high, urgent
      },

      // Documents uploaded
      documents: []
    };
    let isProcessing = false;
    let taxCalculations = null;
    let leadQualified = false;

    // Toast notification function for user feedback
    function showToast(message, type = 'info') {
      // Remove any existing toast
      const existingToast = document.querySelector('.toast-notification');
      if (existingToast) existingToast.remove();

      const toast = document.createElement('div');
      toast.className = 'toast-notification toast-' + type;
      toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        animation: slideUp 0.3s ease;
        max-width: 90%;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      `;

      // Style based on type
      if (type === 'error') {
        toast.style.background = '#ef4444';
      } else if (type === 'warning') {
        toast.style.background = '#f59e0b';
      } else if (type === 'success') {
        toast.style.background = '#10b981';
      } else {
        toast.style.background = '#3b82f6';
      }

      toast.textContent = message;
      document.body.appendChild(toast);

      // Auto-remove after 4 seconds
      setTimeout(() => {
        toast.style.animation = 'slideDown 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // ============ CONSENT MODAL ============
    function checkConsent() {
      const hasConsent = sessionStorage.getItem('tax_data_consent');
      const consentModal = document.getElementById('consentModal');

      if (hasConsent === 'true') {
        consentModal.classList.add('hidden');
        return true;
      }

      // Show consent modal
      consentModal.classList.remove('hidden');
      document.getElementById('dataConsent').focus();
      return false;
    }

    function acceptConsent() {
      const checkbox = document.getElementById('dataConsent');
      if (!checkbox.checked) {
        showToast('Please check the consent box to continue', 'warning');
        return;
      }

      sessionStorage.setItem('tax_data_consent', 'true');
      sessionStorage.setItem('tax_consent_timestamp', new Date().toISOString());
      document.getElementById('consentModal').classList.add('hidden');

      // Initialize session after consent
      initializeSession();
      showToast('Welcome! Your data will be handled securely.', 'success');
    }

    function setupConsentHandlers() {
      const checkbox = document.getElementById('dataConsent');
      const acceptBtn = document.getElementById('acceptConsentBtn');

      if (checkbox && acceptBtn) {
        checkbox.addEventListener('change', function() {
          acceptBtn.disabled = !this.checked;
        });

        acceptBtn.addEventListener('click', acceptConsent);
      }
    }

    // ============ CONNECTION STATUS ============
    function updateConnectionStatus(online) {
      const statusEl = document.getElementById('connectionStatus');
      const textEl = document.getElementById('connectionText');
      const dotEl = document.getElementById('connectionDot');

      if (online) {
        statusEl.classList.remove('offline');
        textEl.textContent = 'Connected';
        dotEl.style.background = 'var(--accent)';
      } else {
        statusEl.classList.add('offline');
        textEl.textContent = 'Offline';
        dotEl.style.background = '#ef4444';
        showToast('You appear to be offline. Messages will be sent when connection is restored.', 'warning');
      }
    }

    // Monitor connection status
    window.addEventListener('online', () => {
      updateConnectionStatus(true);
      hideOfflineBanner();
      showToast('Connection restored!', 'success');
    });

    window.addEventListener('offline', () => {
      updateConnectionStatus(false);
      showOfflineBanner();
    });

    // Periodic health check
    let healthCheckInterval = null;
    function startHealthCheck() {
      healthCheckInterval = setInterval(async () => {
        try {
          const response = await fetch('/api/health', {
            method: 'GET',
            cache: 'no-store',
            signal: AbortSignal.timeout(5000)
          });
          if (response.ok) {
            updateConnectionStatus(true);
          } else {
            updateConnectionStatus(false);
          }
        } catch (e) {
          // Don't mark as offline for network errors if we're still online per browser
          if (!navigator.onLine) {
            updateConnectionStatus(false);
          }
        }
      }, 30000); // Every 30 seconds
    }

    // ============ JOURNEY STEPPER MANAGEMENT ============
    let currentJourneyStep = 1;
    const journeySteps = {
      1: { name: 'Profile', icon: 'üìã' },
      2: { name: 'Income', icon: 'üí∞' },
      3: { name: 'Analysis', icon: 'üéØ' },
      4: { name: 'Report', icon: 'üìä' }
    };

    function updateJourneyStep(stepNumber) {
      if (stepNumber < 1 || stepNumber > 4) return;

      currentJourneyStep = stepNumber;

      // Update all step indicators
      for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById(`step-${i}`);
        if (!stepEl) continue;

        const stepIconEl = stepEl.querySelector('.step-icon');
        stepEl.classList.remove('active', 'completed');

        if (i < stepNumber) {
          // Completed steps show checkmark
          stepEl.classList.add('completed');
          stepIconEl.textContent = '‚úì';
        } else if (i === stepNumber) {
          // Active step
          stepEl.classList.add('active');
          stepIconEl.textContent = journeySteps[i].icon;
        } else {
          // Future steps show original icon
          stepIconEl.textContent = journeySteps[i].icon;
        }
      }
    }

    function advanceJourneyBasedOnData() {
      // Determine step based on extracted data
      if (extractedData.lead_data.ready_for_cpa || taxCalculations) {
        updateJourneyStep(4);
      } else if (extractedData.tax_profile.total_income && extractedData.tax_profile.filing_status) {
        updateJourneyStep(3);
      } else if (extractedData.tax_profile.filing_status) {
        updateJourneyStep(2);
      } else {
        updateJourneyStep(1);
      }
    }

    // ============ LOADING OVERLAY MANAGEMENT ============
    function showLoadingOverlay(text = 'Analyzing your tax situation...', subtext = 'This may take a few moments') {
      const overlay = document.getElementById('loadingOverlay');
      const textEl = document.getElementById('loadingText');
      const subtextEl = document.getElementById('loadingSubtext');

      if (overlay) {
        textEl.textContent = text;
        subtextEl.textContent = subtext;
        overlay.classList.add('active');
      }
    }

    function hideLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.classList.remove('active');
      }
    }

    // ============ OFFLINE BANNER MANAGEMENT ============
    function showOfflineBanner() {
      const banner = document.getElementById('offlineBanner');
      if (banner) {
        banner.classList.add('active');
      }
    }

    function hideOfflineBanner() {
      const banner = document.getElementById('offlineBanner');
      if (banner) {
        banner.classList.remove('active');
      }
    }

    // ============ ERROR BANNER IN MESSAGES ============
    function showErrorBanner(title, message, retryAction = null) {
      const messages = document.getElementById('messages');
      if (!messages) return;

      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-banner';
      errorDiv.id = 'currentErrorBanner';
      errorDiv.innerHTML = `
        <span class="error-icon">‚ö†Ô∏è</span>
        <div class="error-content">
          <div class="error-title">${title}</div>
          <div class="error-message">${message}</div>
          ${retryAction ? `<button class="retry-btn" onclick="${retryAction}">Try Again</button>` : ''}
        </div>
      `;

      messages.appendChild(errorDiv);
      messages.scrollTop = messages.scrollHeight;
    }

    function clearErrorBanner() {
      const errorBanner = document.getElementById('currentErrorBanner');
      if (errorBanner) {
        errorBanner.remove();
      }
    }

    // ============ SUCCESS BANNER ============
    function showSuccessBanner(message) {
      const messages = document.getElementById('messages');
      if (!messages) return;

      const successDiv = document.createElement('div');
      successDiv.className = 'success-banner';
      successDiv.innerHTML = `<span>‚úÖ</span> <span>${message}</span>`;

      messages.appendChild(successDiv);
      messages.scrollTop = messages.scrollHeight;

      // Auto-remove after 5 seconds
      setTimeout(() => successDiv.remove(), 5000);
    }

    // ============ CLEAR CONVERSATION ============
    function clearConversation() {
      if (!confirm('Start a new conversation? This will clear your current session.')) {
        return;
      }

      // Clear session storage
      sessionStorage.removeItem('tax_session_id');
      sessionStorage.removeItem('tax_data_consent');
      sessionStorage.removeItem('tax_consent_timestamp');

      // Reload page to reset everything
      window.location.reload();
    }

    // Initialize session
    async function initializeSession() {
      console.log('initializeSession called');

      // Static greeting is already in HTML, just create session
      try {
        console.log('Creating session...');
        const response = await fetch('/api/sessions/create-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            workflow_type: 'intelligent_conversational',
            tax_year: 2025
          })
        });

        const data = await response.json();
        sessionId = data.session_id;
        sessionStorage.setItem('tax_session_id', sessionId);
        console.log('Session initialized:', sessionId);
      } catch (error) {
        console.error('Session initialization error:', error);
        // Continue without session - will be created on first message
      }
    }

    async function sendInitialGreeting() {
      console.log('sendInitialGreeting called');

      // Premium tax advisory greeting
      addMessage('ai', `<div style="margin-bottom: 16px;">
        <span style="font-size: 24px; font-weight: 700; color: var(--accent-light);">Welcome to Your Tax Advisory Session</span>
      </div>
      I'm your AI-powered tax strategist, trained on thousands of tax scenarios to help you <strong>maximize savings</strong> and <strong>minimize liability</strong>.<br><br>
      <div class="insight-card" style="margin: 16px 0;">
        <div class="insight-header">
          <span>üìä</span>
          <span>Average Client Savings</span>
        </div>
        <div class="savings-amount">$4,200 - $12,500</div>
        <div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">per year through strategic tax planning</div>
      </div>
      <strong>How would you like to begin?</strong>`, [
        { label: "Start Guided Analysis ‚Üí", value: 'no_manual', primary: true },
        { label: "Upload Documents", value: 'yes_upload' },
        { label: "Learn More", value: 'what_docs' }
      ]);
      console.log('Initial greeting added');
    }

    // Calculate confidence level based on data completeness
    function getConfidenceLevel() {
      let score = 0;
      let maxScore = 100;

      if (extractedData.filing_status) score += 15;
      if (extractedData.income_range || extractedData.tax_profile?.total_income) score += 20;
      if (extractedData.deductions && extractedData.deductions.length > 0) score += 15;
      if (extractedData.credits && extractedData.credits.length > 0) score += 15;
      if (extractedData.contact?.name) score += 5;
      if (extractedData.documents && extractedData.documents.length > 0) score += 20;
      if (extractedData.focus_area) score += 10;

      const percentage = Math.round((score / maxScore) * 100);

      if (percentage >= 70) return { level: 'high', percentage, label: 'High confidence' };
      if (percentage >= 40) return { level: 'medium', percentage, label: 'Moderate confidence' };
      return { level: 'low', percentage, label: 'Limited data' };
    }

    // Generate confidence disclaimer for AI messages
    function getConfidenceDisclaimer(includeIRS = false) {
      const confidence = getConfidenceLevel();
      let disclaimer = '';

      if (confidence.level === 'high') {
        disclaimer = `<div class="confidence-indicator confidence-high">
          <span>‚úÖ ${confidence.label} (${confidence.percentage}% data)</span>
          <span style="margin-left: auto; font-size: 11px;">Verify with a tax professional before filing</span>
        </div>`;
      } else if (confidence.level === 'medium') {
        disclaimer = `<div class="confidence-indicator confidence-medium">
          <span>‚ö†Ô∏è ${confidence.label} (${confidence.percentage}% data)</span>
          <span style="margin-left: auto; font-size: 11px;">Provide more details for better accuracy</span>
        </div>`;
      } else {
        disclaimer = `<div class="confidence-indicator confidence-low">
          <span>‚ÑπÔ∏è ${confidence.label} (${confidence.percentage}% data)</span>
          <span style="margin-left: auto; font-size: 11px;">General guidance only - more info needed</span>
        </div>`;
      }

      if (includeIRS) {
        disclaimer += `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
          üìã Based on 2025 IRS guidelines. See <a href="https://www.irs.gov/forms-instructions" target="_blank" rel="noopener" style="color: var(--primary);">IRS.gov</a> for official forms.
        </div>`;
      }

      return disclaimer;
    }

    function addMessage(type, text, quickActions = [], options = {}) {
      console.log('====== addMessage CALLED ======');
      console.log('Type:', type);
      console.log('Text preview:', text.substring(0, 50));
      console.log('Quick actions count:', quickActions.length);

      const messages = document.getElementById('messages');
      console.log('Messages container found:', !!messages);

      if (!messages) {
        console.error('Messages container not found!');
        showToast('Error displaying message', 'error');
        return;
      }

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.setAttribute('role', 'article');
      messageDiv.setAttribute('aria-label', type === 'ai' ? 'AI assistant message' : 'Your message');

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.setAttribute('aria-hidden', 'true');
      avatar.textContent = type === 'ai' ? 'üíº' : 'üë§';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      // Only add confidence indicator when explicitly requested (not on every message)
      if (type === 'ai' && options.showConfidence === true) {
        const includeIRS = options.includeIRS || false;
        text += getConfidenceDisclaimer(includeIRS);
      }

      bubble.innerHTML = text;

      // Add copy button for AI messages
      if (type === 'ai') {
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.textContent = 'üìã Copy';
        copyBtn.setAttribute('aria-label', 'Copy this message');
        copyBtn.onclick = (e) => {
          e.stopPropagation();
          const textContent = bubble.innerText.replace('üìã Copy', '').trim();
          navigator.clipboard.writeText(textContent).then(() => {
            copyBtn.textContent = '‚úì Copied';
            setTimeout(() => copyBtn.textContent = 'üìã Copy', 2000);
          });
        };
        bubble.appendChild(copyBtn);
      }

      // Add timestamp
      const timestamp = document.createElement('span');
      timestamp.className = 'message-time';
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      timestamp.textContent = timeStr;
      timestamp.setAttribute('aria-label', `Sent at ${timeStr}`);
      bubble.appendChild(timestamp);

      if (quickActions.length > 0) {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'quick-actions';
        actionsDiv.setAttribute('role', 'group');
        actionsDiv.setAttribute('aria-label', 'Quick response options');

        quickActions.forEach((action, index) => {
          const btn = document.createElement('button');
          btn.className = action.primary ? 'quick-action primary' : 'quick-action';
          btn.textContent = action.label;
          btn.setAttribute('aria-label', action.label.replace(/[^\w\s]/g, '').trim());
          btn.onclick = () => handleQuickAction(action.value);
          actionsDiv.appendChild(btn);
        });
        bubble.appendChild(actionsDiv);
      }

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(bubble);
      messages.appendChild(messageDiv);

      console.log('Message added successfully. Total messages now:', messages.children.length);

      messages.scrollTop = messages.scrollHeight;
      return messageDiv;
    }

    function showTyping() {
      const messages = document.getElementById('messages');
      const typing = document.createElement('div');
      typing.className = 'message ai';
      typing.id = 'typing-indicator';
      typing.setAttribute('role', 'status');
      typing.setAttribute('aria-live', 'polite');
      typing.setAttribute('aria-label', 'AI assistant is typing a response');
      typing.innerHTML = `
        <div class="avatar" aria-hidden="true">üíº</div>
        <div class="bubble">
          <div class="typing-indicator" role="img" aria-label="Typing">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <span class="sr-only">Please wait, the assistant is preparing a response...</span>
        </div>
      `;
      messages.appendChild(typing);
      messages.scrollTop = messages.scrollHeight;
    }

    function hideTyping() {
      const typing = document.getElementById('typing-indicator');
      if (typing) typing.remove();
    }

    async function sendMessage() {
      const input = document.getElementById('userInput');
      const text = input.value.trim();

      if (!text || isProcessing) return;

      addMessage('user', text);
      input.value = '';
      input.style.height = 'auto';

      await processAIResponse(text);
    }

    async function handleQuickAction(value) {
      console.log('====== handleQuickAction CALLED ======');
      console.log('Quick action clicked:', value);
      console.log('Current extracted data:', extractedData);
      console.log('Messages container exists:', !!document.getElementById('messages'));

      // Lead capture - Name entry
      if (value === 'enter_name') {
        addMessage('user', 'I\'ll enter my name');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Perfect! Please enter your full name below so I can personalize your tax advisory report.<br><br><input type="text" id="nameInput" placeholder="Your full name" style="width: 100%; padding: 14px; margin: 12px 0; background: rgba(255,255,255,0.05); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 16px;" onkeypress="if(event.key==='Enter') captureName()"><br><button onclick="captureName()" style="padding: 12px 32px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 8px;">Continue ‚Üí</button>`);
          setTimeout(() => document.getElementById('nameInput').focus(), 100);
        }, 1000);

      } else if (value === 'skip_name') {
        addMessage('user', 'I\'ll skip for now');
        extractedData.lead_data.score += 5; // Lower score for anonymous users
        proceedToDataGathering();

      } else if (value === 'enter_email') {
        addMessage('user', 'I\'ll enter my email');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Great! Please enter your email address below.<br><br><input type="email" id="emailInput" placeholder="your.email@example.com" style="width: 100%; padding: 14px; margin: 12px 0; background: rgba(255,255,255,0.05); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 16px;" onkeypress="if(event.key==='Enter') captureEmail()"><br><button onclick="captureEmail()" style="padding: 12px 32px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 8px;">Continue ‚Üí</button>`);
          setTimeout(() => document.getElementById('emailInput').focus(), 100);
        }, 1000);

      } else if (value === 'skip_email') {
        addMessage('user', 'I\'ll skip for now');
        extractedData.lead_data.score += 10;
        proceedToDataGathering();

      } else if (value === 'upload_docs_qualified' || value === 'conversational_qualified' || value === 'hybrid_qualified') {
        const mode = value.replace('_qualified', '');
        addMessage('user', mode.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()));

        if (mode === 'upload_docs' || mode === 'hybrid') {
          showTyping();
          setTimeout(() => {
            hideTyping();
            addMessage('ai', `<strong>Perfect! Let's use our Express Lane document analysis.</strong><br><br>üìÑ <strong>Upload any of these documents:</strong><br>‚Ä¢ W-2 forms (employment income)<br>‚Ä¢ 1099 forms (freelance, interest, dividends)<br>‚Ä¢ Previous tax returns<br>‚Ä¢ Business financial statements<br>‚Ä¢ Receipts for deductions<br><br>I'll use advanced OCR and AI to extract all relevant information automatically.<br><br><div style="text-align: center; margin: 20px 0;"><button onclick="document.getElementById('fileInput').click()" style="padding: 16px 40px; background: var(--gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 18px;">üì§ Upload Documents</button></div>Or <strong>drag and drop</strong> files anywhere on this page.`);
          }, 1000);
        } else {
          // Conversational mode - start smart Q&A
          startIntelligentQuestioning();
        }

      // Handle initial greeting responses
      } else if (value === 'yes_upload') {
        console.log('Processing yes_upload action');
        addMessage('user', 'Yes, let me upload my documents');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Perfect! I'm ready to review your documents. You can:<br><br>‚Ä¢ <strong>Drag and drop</strong> files into the upload zone below<br>‚Ä¢ <strong>Click to browse</strong> and select files from your computer<br><br>I'll instantly analyze W-2s, 1099s, and other tax documents using advanced OCR technology. What would you like to upload first?`, [
            { label: 'üìé Upload W-2', value: 'upload_w2' },
            { label: 'üìé Upload 1099', value: 'upload_1099' },
            { label: 'üìé Other document', value: 'upload_other' }
          ]);
        }, 1500);

      } else if (value === 'no_manual') {
        addMessage('user', 'No, I\'d prefer to discuss my situation first');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `What's your filing status?`, [
            { label: 'Single', value: 'filing_single' },
            { label: 'Married Filing Jointly', value: 'filing_married' },
            { label: 'Head of Household', value: 'filing_hoh' },
            { label: 'Married Filing Separately', value: 'filing_mfs' },
            { label: 'Qualifying Surviving Spouse', value: 'filing_qss' }
          ]);
        }, 1500);

      } else if (value === 'what_docs') {
        addMessage('user', 'What kind of documents would help?');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Great question! Here's what I typically review for a comprehensive tax advisory:<br><br><strong>üìä Income Documents:</strong><br>‚Ä¢ W-2 forms (from employers)<br>‚Ä¢ 1099 forms (interest, dividends, freelance income)<br>‚Ä¢ Business income records<br>‚Ä¢ Rental property income<br><br><strong>üí∞ Deduction & Credit Records:</strong><br>‚Ä¢ Mortgage interest statements (1098)<br>‚Ä¢ Property tax records<br>‚Ä¢ Charitable contribution receipts<br>‚Ä¢ Education expenses (1098-T)<br>‚Ä¢ Medical expense receipts<br>‚Ä¢ Retirement contributions<br><br><strong>üìà Investment Records:</strong><br>‚Ä¢ Brokerage statements<br>‚Ä¢ Cryptocurrency transactions<br>‚Ä¢ Capital gains/losses<br><br>Don't worry if you don't have everything right now. <strong>What would you like to do next?</strong>`, [
            { label: 'üìÑ I have some documents ready', value: 'yes_upload' },
            { label: 'üí¨ Let\'s discuss my situation', value: 'no_manual' }
          ]);
        }, 2000);

      } else if (value === 'upload_w2' || value === 'upload_1099' || value === 'upload_other') {
        addMessage('user', 'I want to upload a document');
        document.getElementById('fileInput').click();

      } else if (value.startsWith('filing_')) {
        const status = value.replace('filing_', '');
        const statusMap = {
          'single': 'Single',
          'married': 'Married Filing Jointly',
          'hoh': 'Head of Household',
          'mfs': 'Married Filing Separately',
          'qss': 'Qualifying Surviving Spouse'
        };
        const statusText = statusMap[status] || status;

        addMessage('user', statusText);
        extractedData.tax_profile.filing_status = statusText;
        extractedData.lead_data.score += 10;
        updateStats({ filing_status: statusText });
        calculateLeadScore();

        startIntelligentQuestioning();

      } else if (value.startsWith('income_')) {
        let incomeText = '';
        let incomeAmount = 0;

        if (value === 'income_custom') {
          addMessage('user', 'I\'ll type my exact income');
          showTyping();
          setTimeout(() => {
            hideTyping();
            addMessage('ai', `Please enter your total annual income for 2025:<br><br><input type="number" id="incomeInput" placeholder="Enter amount" style="width: 100%; padding: 14px; margin: 12px 0; background: rgba(255,255,255,0.05); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 16px;" onkeypress="if(event.key==='Enter') captureIncome()"><br><button onclick="captureIncome()" style="padding: 12px 32px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 8px;">Continue ‚Üí</button>`);
            setTimeout(() => document.getElementById('incomeInput').focus(), 100);
          }, 1000);
          return;
        } else if (value === 'income_0_50k') {
          incomeText = '$0 - $50,000';
          incomeAmount = 35000;
        } else if (value === 'income_50_100k') {
          incomeText = '$50,000 - $100,000';
          incomeAmount = 75000;
        } else if (value === 'income_100_200k') {
          incomeText = '$100,000 - $200,000';
          incomeAmount = 150000;
        } else if (value === 'income_200_500k') {
          incomeText = '$200,000 - $500,000';
          incomeAmount = 350000;
        } else if (value === 'income_500k_plus') {
          incomeText = 'Over $500,000';
          incomeAmount = 750000;
        }

        addMessage('user', incomeText);
        extractedData.tax_profile.total_income = incomeAmount;
        extractedData.tax_profile.w2_income = incomeAmount; // Assume W2 unless told otherwise
        extractedData.lead_data.score += 15;
        updateStats({ total_income: incomeAmount });
        calculateLeadScore();

        startIntelligentQuestioning();

      } else if (value.startsWith('dependents_')) {
        const depCount = value.replace('dependents_', '');
        const depNum = depCount === '3plus' ? 3 : parseInt(depCount);
        const depText = depNum === 0 ? 'No dependents' : depNum === 1 ? '1 dependent' : `${depNum}+ dependents`;

        addMessage('user', depText);
        extractedData.tax_profile.dependents = depNum;
        extractedData.lead_data.score += 10;
        calculateLeadScore();

        startIntelligentQuestioning();

      // State selection handlers
      } else if (value.startsWith('state_')) {
        const stateCode = value.replace('state_', '');
        const stateLabels = {
          'CA': 'California',
          'NY': 'New York',
          'TX': 'Texas',
          'FL': 'Florida',
          'other': 'Other state'
        };
        const stateText = stateLabels[stateCode] || stateCode;

        addMessage('user', stateText);
        // Use 'OTHER' for other states so the flow continues (not empty string)
        extractedData.tax_profile.state = stateCode === 'other' ? 'OTHER' : stateCode;
        extractedData.lead_data.score += 5;
        calculateLeadScore();

        startIntelligentQuestioning();

      // Income source handlers
      } else if (value.startsWith('source_')) {
        const source = value.replace('source_', '');
        const sourceLabels = {
          'w2': 'W-2 Employee',
          'self_employed': 'Self-Employed / 1099',
          'business': 'Business Owner',
          'investments': 'Investments / Retirement',
          'multiple': 'Multiple sources'
        };
        const sourceText = sourceLabels[source] || source;

        addMessage('user', sourceText);
        extractedData.tax_profile.income_source = sourceText;
        if (source === 'self_employed' || source === 'business') {
          extractedData.tax_profile.is_self_employed = true;
        }
        extractedData.lead_data.score += 10;
        calculateLeadScore();

        startIntelligentQuestioning();

      // Deduction exploration handlers
      } else if (value.startsWith('deduction_')) {
        const deduction = value.replace('deduction_', '');
        if (deduction === 'none') {
          addMessage('user', 'None of these apply');
          extractedData.tax_profile.deductions_explored = true;
          calculateLeadScore();
          startIntelligentQuestioning();
        } else {
          const deductionLabels = {
            'mortgage': 'Own a home',
            'charity': 'Make charitable donations',
            'medical': 'Have high medical expenses',
            'retirement': 'Contribute to retirement'
          };
          addMessage('user', deductionLabels[deduction] || deduction);

          // Prevent duplicate deductions
          extractedData.deductions = extractedData.deductions || [];
          if (!extractedData.deductions.includes(deduction)) {
            extractedData.deductions.push(deduction);
            extractedData.lead_data.score += 5;
          }

          // Set flags for deductions - amounts will be asked in follow-ups
          if (deduction === 'retirement') {
            extractedData.tax_profile.has_retirement_contributions = true;
          }
          if (deduction === 'investment_loss') {
            extractedData.tax_profile.has_investment_losses = true;
            extractedData.lead_data.score += 5;
          }

          // Mortgage - ask for amount and property tax
          if (deduction === 'mortgage') {
            extractedData.tax_profile.has_mortgage = true;
            extractedData.tax_profile.owns_home = true;
            showTyping();
            setTimeout(() => {
              hideTyping();
              addMessage('ai', `Great! Mortgage interest is a valuable deduction. <strong>What's your approximate annual mortgage interest?</strong>`, [
                { label: 'Under $5,000', value: 'mortgageamt_under5k' },
                { label: '$5,000 - $15,000', value: 'mortgageamt_5_15k' },
                { label: '$15,000 - $30,000', value: 'mortgageamt_15_30k' },
                { label: 'Over $30,000', value: 'mortgageamt_over30k' }
              ]);
            }, 800);
            return;
          }

          // Charitable donations - ask for amount
          if (deduction === 'charity') {
            extractedData.tax_profile.has_charitable = true;
            showTyping();
            setTimeout(() => {
              hideTyping();
              addMessage('ai', `<strong>How much do you typically donate to charity annually?</strong>`, [
                { label: 'Under $500', value: 'charityamt_under500' },
                { label: '$500 - $2,500', value: 'charityamt_500_2500' },
                { label: '$2,500 - $10,000', value: 'charityamt_2500_10k' },
                { label: 'Over $10,000', value: 'charityamt_over10k' }
              ]);
            }, 800);
            return;
          }

          // Medical expenses - ask for amount
          if (deduction === 'medical') {
            showTyping();
            setTimeout(() => {
              hideTyping();
              addMessage('ai', `Medical expenses can potentially be deducted if they exceed 7.5% of your income. <strong>What's your estimated annual medical expense?</strong>`, [
                { label: 'Under $5,000', value: 'medical_amount_low' },
                { label: '$5,000 - $15,000', value: 'medical_amount_medium' },
                { label: '$15,000 - $30,000', value: 'medical_amount_high' },
                { label: 'Over $30,000', value: 'medical_amount_very_high' }
              ]);
            }, 800);
            return;
          }

          extractedData.tax_profile.deductions_explored = true;
          calculateLeadScore();
          startIntelligentQuestioning();
        }

      // Mortgage amount handlers
      } else if (value.startsWith('mortgageamt_')) {
        const amt = value.replace('mortgageamt_', '');
        const amounts = { 'under5k': 3000, '5_15k': 10000, '15_30k': 22500, 'over30k': 40000 };
        const labels = { 'under5k': 'Under $5,000', '5_15k': '$5,000-$15,000', '15_30k': '$15,000-$30,000', 'over30k': 'Over $30,000' };
        addMessage('user', labels[amt] || amt);
        extractedData.tax_items.mortgage_interest = amounts[amt] || 10000;

        // Follow up with property tax question
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `<strong>What's your approximate annual property tax?</strong>`, [
            { label: 'Under $3,000', value: 'proptaxamt_under3k' },
            { label: '$3,000 - $8,000', value: 'proptaxamt_3_8k' },
            { label: '$8,000 - $15,000', value: 'proptaxamt_8_15k' },
            { label: 'Over $15,000', value: 'proptaxamt_over15k' }
          ]);
        }, 800);

      } else if (value.startsWith('proptaxamt_')) {
        const amt = value.replace('proptaxamt_', '');
        const amounts = { 'under3k': 2000, '3_8k': 5500, '8_15k': 11500, 'over15k': 20000 };
        const labels = { 'under3k': 'Under $3,000', '3_8k': '$3,000-$8,000', '8_15k': '$8,000-$15,000', 'over15k': 'Over $15,000' };
        addMessage('user', labels[amt] || amt);
        extractedData.tax_items.property_tax = amounts[amt] || 5500;
        // Note: SALT cap is $10,000
        extractedData.tax_profile.deductions_explored = true;
        calculateLeadScore();
        startIntelligentQuestioning();

      // Charitable donation amount handlers
      } else if (value.startsWith('charityamt_')) {
        const amt = value.replace('charityamt_', '');
        const amounts = { 'under500': 250, '500_2500': 1500, '2500_10k': 6000, 'over10k': 15000 };
        const labels = { 'under500': 'Under $500', '500_2500': '$500-$2,500', '2500_10k': '$2,500-$10,000', 'over10k': 'Over $10,000' };
        addMessage('user', labels[amt] || amt);
        extractedData.tax_items.charitable = amounts[amt] || 1500;
        extractedData.tax_profile.deductions_explored = true;
        calculateLeadScore();
        startIntelligentQuestioning();

      // Medical expense amount handlers
      } else if (value.startsWith('medical_amount_')) {
        const medicalLevel = value.replace('medical_amount_', '');
        const medicalAmounts = {
          'low': 2500,
          'medium': 10000,
          'high': 22500,
          'very_high': 40000
        };
        const medicalLabels = {
          'low': 'Under $5,000',
          'medium': '$5,000 - $15,000',
          'high': '$15,000 - $30,000',
          'very_high': 'Over $30,000'
        };
        const amount = medicalAmounts[medicalLevel] || 10000;
        addMessage('user', medicalLabels[medicalLevel] || `$${amount.toLocaleString()}`);
        extractedData.tax_items.medical = amount;
        extractedData.tax_profile.deductions_explored = true;
        calculateLeadScore();
        startIntelligentQuestioning();

      // Tax goal handlers
      } else if (value.startsWith('goal_')) {
        const goal = value.replace('goal_', '');
        const goalLabels = {
          'reduce_taxes': 'Reduce my current tax bill',
          'retirement': 'Maximize retirement savings',
          'life_event': 'Plan for a major life event',
          'wealth': 'Build long-term wealth tax-efficiently',
          'optimize': 'General tax optimization'
        };
        addMessage('user', goalLabels[goal] || goal);
        extractedData.tax_profile.primary_goal = goal;
        extractedData.tax_profile.goals_explored = true;
        extractedData.lead_data.score += 10;
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // W-4 WITHHOLDING HANDLERS
      // =====================================================================

      } else if (value.startsWith('withhold_')) {
        const withholdType = value.replace('withhold_', '');
        const withholdLabels = {
          'strategic': 'Yes, I adjust it strategically',
          'default': 'No, I use the default settings',
          'large_refund': 'I usually get a large refund',
          'owe': 'I usually owe taxes',
          'skip': 'Skip'
        };
        addMessage('user', withholdLabels[withholdType] || withholdType);
        extractedData.tax_profile.withholding_explored = true;
        extractedData.tax_profile.withholding_status = withholdType;

        if (withholdType === 'large_refund') {
          extractedData.tax_profile.may_need_w4_adjustment = true;
          // Large refund means overwithholding - opportunity for adjustment
        }
        if (withholdType === 'owe') {
          extractedData.tax_profile.may_need_w4_adjustment = true;
          extractedData.tax_profile.possible_underpayment_penalty = true;
        }
        extractedData.lead_data.score += 5;
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // PRIOR YEAR TAX SITUATION HANDLERS
      // =====================================================================

      } else if (value.startsWith('prior_')) {
        const priorType = value.replace('prior_', '');
        const priorLabels = {
          'large_refund': 'Got a large refund (over $2,000)',
          'small_refund': 'Got a small refund (under $2,000)',
          'owed': 'Owed money to the IRS',
          'breakeven': 'About break-even',
          'skip': 'First time filing / Skip'
        };
        addMessage('user', priorLabels[priorType] || priorType);
        extractedData.tax_profile.prior_year_explored = true;
        extractedData.tax_profile.prior_year_result = priorType;

        if (priorType === 'large_refund') {
          extractedData.tax_profile.prior_had_large_refund = true;
        }
        if (priorType === 'owed') {
          extractedData.tax_profile.prior_owed_taxes = true;
        }
        extractedData.lead_data.score += 5;
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // SPOUSE INCOME HANDLERS (for MFJ)
      // =====================================================================

      } else if (value.startsWith('spouse_')) {
        const spouseType = value.replace('spouse_', '');
        const spouseLabels = {
          'w2': 'Yes, W-2 employment',
          'self_employed': 'Yes, self-employed',
          'both': 'Yes, both W-2 and self-employed',
          'none': 'No, spouse doesn\'t work',
          'skip': 'Skip'
        };
        addMessage('user', spouseLabels[spouseType] || spouseType);
        extractedData.tax_profile.spouse_income_explored = true;
        extractedData.tax_profile.spouse_income_type = spouseType;

        if (spouseType === 'w2' || spouseType === 'both') {
          extractedData.tax_profile.spouse_has_w2 = true;
        }
        if (spouseType === 'self_employed' || spouseType === 'both') {
          extractedData.tax_profile.spouse_is_self_employed = true;
          extractedData.lead_data.complexity = 'complex';
        }
        extractedData.lead_data.score += 5;
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // BUSINESS & SELF-EMPLOYMENT HANDLERS
      // =====================================================================

      // Flow A business TYPE handlers (industry/category - different from entity structure)
      } else if (value === 'biz_professional' || value === 'biz_retail' ||
                 value === 'biz_realestate' || value === 'biz_tech' || value === 'biz_service') {
        const bizType = value.replace('biz_', '');
        const bizLabels = {
          'professional': 'Professional Services',
          'retail': 'Retail / E-commerce',
          'realestate': 'Real Estate',
          'tech': 'Tech / Software',
          'service': 'Other Service Business'
        };
        addMessage('user', bizLabels[bizType] || bizType);
        extractedData.tax_profile.business_type = bizType;
        extractedData.lead_data.score += 5;
        calculateLeadScore();
        startIntelligentQuestioning();

      } else if (value.startsWith('entity_')) {
        const entityType = value.replace('entity_', '');
        const entityLabels = {
          'sole': 'Sole Proprietorship',
          'llc_single': 'Single-Member LLC',
          'llc_multi': 'Multi-Member LLC / Partnership',
          'scorp': 'S-Corporation',
          'ccorp': 'C-Corporation'
        };
        addMessage('user', entityLabels[entityType] || entityType);
        extractedData.tax_profile.entity_type = entityType;
        extractedData.lead_data.score += 5;
        // S-Corp or C-Corp indicates more sophisticated tax planning
        if (entityType === 'scorp' || entityType === 'ccorp') {
          extractedData.lead_data.complexity = 'complex';
          extractedData.lead_data.score += 10;
        }
        calculateLeadScore();
        startIntelligentQuestioning();

      } else if (value.startsWith('revenue_')) {
        const revenueRange = value.replace('revenue_', '');
        const revenueLabels = {
          'under50k': 'Under $50,000',
          '50_100k': '$50,000 - $100,000',
          '100_250k': '$100,000 - $250,000',
          '250_500k': '$250,000 - $500,000',
          'over500k': 'Over $500,000'
        };
        const revenueAmounts = {
          'under50k': 35000,
          '50_100k': 75000,
          '100_250k': 175000,
          '250_500k': 375000,
          'over500k': 750000
        };
        addMessage('user', revenueLabels[revenueRange] || revenueRange);
        extractedData.tax_profile.business_revenue = revenueAmounts[revenueRange] || 100000;
        extractedData.lead_data.score += 10;
        if (revenueAmounts[revenueRange] >= 250000) {
          extractedData.lead_data.complexity = 'complex';
        }
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // BUSINESS EXPENSE HANDLERS
      // =====================================================================

      } else if (value.startsWith('bizexp_')) {
        const expType = value.replace('bizexp_', '');
        const expLabels = {
          'home_office': 'Home Office',
          'vehicle': 'Vehicle / Mileage',
          'equipment': 'Equipment & Software',
          'marketing': 'Marketing & Advertising',
          'skip': 'Continue without specifying'
        };
        addMessage('user', expLabels[expType] || expType);

        if (expType !== 'skip') {
          extractedData.tax_profile.business_expenses = extractedData.tax_profile.business_expenses || [];
          extractedData.tax_profile.business_expenses.push(expType);
          extractedData.lead_data.score += 5;

          // Ask for amount based on expense type
          showTyping();
          setTimeout(() => {
            hideTyping();
            if (expType === 'home_office') {
              extractedData.tax_profile.has_home_office = true;
              addMessage('ai', `<strong>What's the approximate square footage of your home office?</strong>`, [
                { label: 'Under 100 sq ft', value: 'homeoffice_under100' },
                { label: '100-300 sq ft', value: 'homeoffice_100_300' },
                { label: '300-500 sq ft', value: 'homeoffice_300_500' },
                { label: 'Over 500 sq ft', value: 'homeoffice_over500' }
              ]);
            } else if (expType === 'vehicle') {
              extractedData.tax_profile.has_vehicle_expenses = true;
              addMessage('ai', `<strong>Approximately how many business miles do you drive per year?</strong>`, [
                { label: 'Under 5,000 miles', value: 'vehicle_under5k' },
                { label: '5,000 - 15,000 miles', value: 'vehicle_5_15k' },
                { label: '15,000 - 30,000 miles', value: 'vehicle_15_30k' },
                { label: 'Over 30,000 miles', value: 'vehicle_over30k' }
              ]);
            } else if (expType === 'equipment') {
              addMessage('ai', `<strong>How much did you spend on equipment & software this year?</strong>`, [
                { label: 'Under $2,500', value: 'equipment_under2500' },
                { label: '$2,500 - $10,000', value: 'equipment_2500_10k' },
                { label: '$10,000 - $50,000', value: 'equipment_10_50k' },
                { label: 'Over $50,000', value: 'equipment_over50k' }
              ]);
            } else if (expType === 'marketing') {
              addMessage('ai', `<strong>How much do you spend on marketing & advertising annually?</strong>`, [
                { label: 'Under $1,000', value: 'marketing_under1k' },
                { label: '$1,000 - $5,000', value: 'marketing_1_5k' },
                { label: '$5,000 - $20,000', value: 'marketing_5_20k' },
                { label: 'Over $20,000', value: 'marketing_over20k' }
              ]);
            }
          }, 800);
        } else {
          extractedData.tax_profile.business_expenses_explored = true;
          calculateLeadScore();
          startIntelligentQuestioning();
        }

      // Business expense amount handlers
      } else if (value.startsWith('homeoffice_')) {
        const size = value.replace('homeoffice_', '');
        const sizeAmounts = { 'under100': 75, '100_300': 200, '300_500': 400, 'over500': 600 };
        const sizeLabels = { 'under100': 'Under 100 sq ft', '100_300': '100-300 sq ft', '300_500': '300-500 sq ft', 'over500': 'Over 500 sq ft' };
        addMessage('user', sizeLabels[size] || size);
        // Simplified method: $5 per sq ft
        extractedData.tax_items.home_office_sqft = sizeAmounts[size] || 200;
        extractedData.tax_items.home_office_deduction = (sizeAmounts[size] || 200) * 5;
        extractedData.tax_profile.business_expenses_explored = true;
        calculateLeadScore();
        startIntelligentQuestioning();

      } else if (value.startsWith('vehicle_')) {
        const miles = value.replace('vehicle_', '');
        const mileAmounts = { 'under5k': 3000, '5_15k': 10000, '15_30k': 22500, 'over30k': 40000 };
        const mileLabels = { 'under5k': 'Under 5,000 miles', '5_15k': '5,000-15,000 miles', '15_30k': '15,000-30,000 miles', 'over30k': 'Over 30,000 miles' };
        addMessage('user', mileLabels[miles] || miles);
        extractedData.tax_items.business_miles = mileAmounts[miles] || 10000;
        // 2024 IRS rate: $0.67 per mile
        extractedData.tax_items.vehicle_deduction = (mileAmounts[miles] || 10000) * 0.67;
        extractedData.tax_profile.business_expenses_explored = true;
        calculateLeadScore();
        startIntelligentQuestioning();

      } else if (value.startsWith('equipment_')) {
        const amt = value.replace('equipment_', '');
        const equipAmounts = { 'under2500': 1500, '2500_10k': 6000, '10_50k': 30000, 'over50k': 75000 };
        const equipLabels = { 'under2500': 'Under $2,500', '2500_10k': '$2,500-$10,000', '10_50k': '$10,000-$50,000', 'over50k': 'Over $50,000' };
        addMessage('user', equipLabels[amt] || amt);
        extractedData.tax_items.equipment_expense = equipAmounts[amt] || 6000;
        extractedData.tax_profile.business_expenses_explored = true;
        calculateLeadScore();
        startIntelligentQuestioning();

      } else if (value.startsWith('marketing_')) {
        const amt = value.replace('marketing_', '');
        const marketAmounts = { 'under1k': 500, '1_5k': 3000, '5_20k': 12500, 'over20k': 30000 };
        const marketLabels = { 'under1k': 'Under $1,000', '1_5k': '$1,000-$5,000', '5_20k': '$5,000-$20,000', 'over20k': 'Over $20,000' };
        addMessage('user', marketLabels[amt] || amt);
        extractedData.tax_items.marketing_expense = marketAmounts[amt] || 3000;
        extractedData.tax_profile.business_expenses_explored = true;
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // MULTIPLE INCOME SOURCES HANDLERS
      // =====================================================================

      } else if (value.startsWith('multi_')) {
        const multiType = value.replace('multi_', '');
        const multiLabels = {
          'w2_biz': 'W-2 Employment + Side Business',
          'w2_invest': 'W-2 Employment + Investments',
          'self_rental': 'Self-Employment + Rental Income',
          'retire_work': 'Retirement Income + Part-time Work',
          'other': 'Other combination'
        };
        addMessage('user', multiLabels[multiType] || multiType);
        extractedData.tax_profile.income_sources_detailed = multiType;
        extractedData.lead_data.complexity = 'moderate';
        extractedData.lead_data.score += 10;

        // Set flags based on selection
        if (multiType === 'w2_biz' || multiType === 'self_rental') {
          extractedData.tax_profile.is_self_employed = true;
        }
        if (multiType === 'self_rental') {
          extractedData.tax_profile.has_rental_income = true;
        }
        if (multiType === 'w2_invest') {
          extractedData.tax_profile.has_investment_income = true;
        }
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // INVESTMENT INCOME HANDLERS
      // =====================================================================

      } else if (value.startsWith('invest_')) {
        const investType = value.replace('invest_', '');
        const investLabels = {
          'stocks': 'Stock dividends & capital gains',
          'rental': 'Rental property income',
          'interest': 'Interest income',
          'k1': 'Partnership/K-1 income',
          'multiple': 'Multiple investment types'
        };
        addMessage('user', investLabels[investType] || investType);
        extractedData.tax_profile.investment_type = investType;
        extractedData.tax_profile.investment_explored = true;
        extractedData.tax_profile.has_investment_income = true;

        if (investType === 'rental') {
          extractedData.tax_profile.has_rental_income = true;
        }
        if (investType === 'k1') {
          extractedData.lead_data.complexity = 'complex';
          extractedData.lead_data.score += 15;
        }
        extractedData.lead_data.score += 10;
        calculateLeadScore();
        startIntelligentQuestioning();

      } else if (value.startsWith('rental_')) {
        const rentalCount = value.replace('rental_', '');
        const rentalLabels = {
          '1': '1 property',
          '2_4': '2-4 properties',
          '5plus': '5+ properties'
        };
        addMessage('user', rentalLabels[rentalCount] || rentalCount);
        extractedData.tax_profile.rental_property_count = rentalCount;
        extractedData.tax_profile.rental_explored = true;

        if (rentalCount === '5plus') {
          extractedData.lead_data.complexity = 'complex';
          extractedData.lead_data.score += 20;
        } else if (rentalCount === '2_4') {
          extractedData.lead_data.score += 10;
        }
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // CAPITAL GAINS/LOSSES HANDLERS
      // =====================================================================

      } else if (value.startsWith('capgain_')) {
        const gainType = value.replace('capgain_', '');
        const gainLabels = {
          'gains': 'Yes, net gains (profit)',
          'losses': 'Yes, net losses',
          'even': 'About break-even',
          'none': 'Haven\'t sold anything'
        };
        addMessage('user', gainLabels[gainType] || gainType);
        extractedData.tax_profile.capital_gains_explored = true;

        if (gainType === 'gains') {
          extractedData.tax_profile.has_capital_gains = true;
        }
        if (gainType === 'losses') {
          extractedData.tax_profile.has_capital_losses = true;
        }
        extractedData.lead_data.score += 5;
        calculateLeadScore();
        startIntelligentQuestioning();

      } else if (value.startsWith('capgainamt_')) {
        const amt = value.replace('capgainamt_', '');
        const amounts = { 'under10k': 5000, '10_50k': 30000, '50_100k': 75000, 'over100k': 150000 };
        const labels = { 'under10k': 'Under $10,000', '10_50k': '$10,000-$50,000', '50_100k': '$50,000-$100,000', 'over100k': 'Over $100,000' };
        addMessage('user', labels[amt] || amt);
        extractedData.tax_profile.capital_gains_amount = amounts[amt] || 30000;
        extractedData.tax_profile.capital_gains_amount_explored = true;
        extractedData.lead_data.score += 10;
        calculateLeadScore();
        startIntelligentQuestioning();

      } else if (value.startsWith('caplossamt_')) {
        const amt = value.replace('caplossamt_', '');
        const amounts = { 'under3k': 1500, '3_10k': 6500, 'over10k': 15000 };
        const labels = { 'under3k': 'Under $3,000', '3_10k': '$3,000-$10,000', 'over10k': 'Over $10,000' };
        addMessage('user', labels[amt] || amt);
        extractedData.tax_profile.capital_losses_amount = amounts[amt] || 3000;
        extractedData.tax_profile.capital_losses_amount_explored = true;
        extractedData.lead_data.score += 5;
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // DEPENDENT & FAMILY HANDLERS
      // =====================================================================

      } else if (value.startsWith('dep_age_')) {
        const ageGroup = value.replace('dep_age_', '');
        const ageLabels = {
          'under6': 'All under 6 years old',
          '6_17': 'Children 6-17 years old',
          'college': 'College students (18-24)',
          'adult': 'Adult dependents / elderly parents',
          'mixed': 'Mix of ages'
        };
        addMessage('user', ageLabels[ageGroup] || ageGroup);
        extractedData.tax_profile.dependent_ages = ageGroup;
        extractedData.tax_profile.dependent_ages_explored = true;

        // Set flags for credit eligibility
        if (ageGroup === 'under6' || ageGroup === 'mixed') {
          extractedData.tax_profile.has_young_children = true;
        }
        if (ageGroup === 'college') {
          extractedData.tax_profile.has_college_students = true;
        }
        extractedData.lead_data.score += 5;
        calculateLeadScore();
        startIntelligentQuestioning();

      } else if (value.startsWith('childcare_')) {
        const childcareLevel = value.replace('childcare_', '');
        const childcareLabels = {
          'high': 'Yes, over $5,000/year',
          'low': 'Yes, under $5,000/year',
          'none': 'No childcare expenses'
        };
        const childcareAmounts = { 'high': 8000, 'low': 3000, 'none': 0 };
        addMessage('user', childcareLabels[childcareLevel] || childcareLevel);
        extractedData.tax_items.childcare = childcareAmounts[childcareLevel] || 0;
        extractedData.tax_profile.childcare_explored = true;
        extractedData.lead_data.score += 5;
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // RETIREMENT CONTRIBUTION HANDLERS
      // =====================================================================

      } else if (value.startsWith('retire_')) {
        const retireType = value.replace('retire_', '');
        const retireLabels = {
          '401k': '401(k) through employer',
          'trad_ira': 'Traditional IRA',
          'roth_ira': 'Roth IRA',
          'both': '401(k) and IRA',
          'sep': 'SEP-IRA or Solo 401(k)'
        };
        addMessage('user', retireLabels[retireType] || retireType);
        extractedData.tax_profile.retirement_type = retireType;
        extractedData.tax_profile.retirement_detailed = true;

        if (retireType === '401k' || retireType === 'both') {
          extractedData.tax_profile.has_401k = true;
        }
        if (retireType === 'sep') {
          extractedData.lead_data.score += 10; // Self-employed retirement
        }
        extractedData.lead_data.score += 5;
        calculateLeadScore();
        startIntelligentQuestioning();

      } else if (value.startsWith('401k_')) {
        const amount = value.replace('401k_', '');
        const amountLabels = {
          'under10k': 'Less than $10,000',
          '10_15k': '$10,000 - $15,000',
          '15_23k': '$15,000 - $23,000',
          'max': 'Maxing out ($23,500)',
          'unsure': 'Not sure'
        };
        const amountValues = {
          'under10k': 7500,
          '10_15k': 12500,
          '15_23k': 19000,
          'max': 23500,
          'unsure': 15000
        };
        addMessage('user', amountLabels[amount] || amount);
        extractedData.tax_profile.retirement_401k = amountValues[amount] || 15000;
        extractedData.lead_data.score += 5;
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // HSA CONTRIBUTION HANDLERS
      // =====================================================================

      } else if (value.startsWith('hsa_')) {
        const hsaType = value.replace('hsa_', '');
        const hsaLabels = { 'yes': 'Yes, I contribute to an HSA', 'no': 'No HSA', 'unsure': 'Not sure' };
        addMessage('user', hsaLabels[hsaType] || hsaType);
        extractedData.tax_profile.hsa_explored = true;

        if (hsaType === 'yes') {
          extractedData.tax_profile.has_hsa = true;
          extractedData.lead_data.score += 5;
        }
        calculateLeadScore();
        startIntelligentQuestioning();

      } else if (value.startsWith('hsaamt_')) {
        const amt = value.replace('hsaamt_', '');
        const amounts = { 'under2k': 1500, '2_4k': 3000, 'max': 4150, 'unsure': 2500 };
        const labels = { 'under2k': 'Under $2,000', '2_4k': '$2,000-$4,000', 'max': 'Maxing out', 'unsure': 'Not sure' };
        addMessage('user', labels[amt] || amt);
        extractedData.tax_items.hsa_contributions = amounts[amt] || 2500;
        extractedData.tax_profile.hsa_amount_explored = true;
        extractedData.lead_data.score += 5;
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // STUDENT LOAN INTEREST HANDLERS
      // =====================================================================

      } else if (value.startsWith('studentloan_')) {
        const loanType = value.replace('studentloan_', '');
        const loanLabels = { 'yes': 'Yes, I pay student loan interest', 'no': 'No student loans' };
        addMessage('user', loanLabels[loanType] || loanType);
        extractedData.tax_profile.student_loan_explored = true;

        if (loanType === 'yes') {
          extractedData.tax_profile.has_student_loans = true;
          extractedData.lead_data.score += 5;
        }
        calculateLeadScore();
        startIntelligentQuestioning();

      } else if (value.startsWith('studentloanamt_')) {
        const amt = value.replace('studentloanamt_', '');
        const amounts = { 'under1k': 500, '1_2500': 1750, 'over2500': 2500 };
        const labels = { 'under1k': 'Under $1,000', '1_2500': '$1,000-$2,500', 'over2500': 'Over $2,500' };
        addMessage('user', labels[amt] || amt);
        // Max deductible is $2,500
        extractedData.tax_items.student_loan_interest = Math.min(amounts[amt] || 1750, 2500);
        extractedData.tax_profile.student_loan_amount_explored = true;
        extractedData.lead_data.score += 5;
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // ENERGY CREDIT HANDLERS
      // =====================================================================

      } else if (value.startsWith('energy_')) {
        const energyType = value.replace('energy_', '');
        const energyLabels = {
          'solar': 'Solar panels installed',
          'ev': 'Electric vehicle purchased',
          'hvac': 'Heat pump / HVAC upgrade',
          'home_improve': 'Windows / insulation / doors',
          'none': 'None of these'
        };
        addMessage('user', energyLabels[energyType] || energyType);
        extractedData.tax_profile.energy_explored = true;

        if (energyType !== 'none') {
          extractedData.tax_profile.has_energy_credits = true;
          extractedData.tax_profile.energy_credit_type = energyType;
          extractedData.lead_data.score += 10;

          // Solar gets significant credit (30% of cost)
          if (energyType === 'solar') {
            extractedData.tax_profile.has_solar_credit = true;
            extractedData.lead_data.complexity = 'moderate';
          }
          // EV credit up to $7,500
          if (energyType === 'ev') {
            extractedData.tax_profile.has_ev_credit = true;
          }
          // Home improvements get smaller credits
          if (energyType === 'hvac' || energyType === 'home_improve') {
            extractedData.tax_profile.has_home_energy_credit = true;
          }
        }
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // LIFE EVENT HANDLERS
      // =====================================================================

      } else if (value.startsWith('event_')) {
        const eventType = value.replace('event_', '');
        const eventLabels = {
          'marriage': 'Getting married',
          'baby': 'Having a baby',
          'home': 'Buying a home',
          'business': 'Starting a business',
          'retirement': 'Retiring soon',
          'sale': 'Selling a home or major asset'
        };
        addMessage('user', eventLabels[eventType] || eventType);
        extractedData.tax_profile.life_event_type = eventType;
        extractedData.lead_data.score += 10;

        // Increase complexity for certain events
        if (eventType === 'business' || eventType === 'sale') {
          extractedData.lead_data.complexity = 'complex';
          extractedData.lead_data.score += 10;
        }
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // ADVANCED STRATEGIES HANDLERS (HIGH EARNERS)
      // =====================================================================

      } else if (value.startsWith('adv_')) {
        const advType = value.replace('adv_', '');
        const advLabels = {
          'backdoor': 'Backdoor Roth IRA strategies',
          'charitable': 'Charitable giving optimization',
          'deferred': 'Deferred compensation plans',
          'estate': 'Estate planning considerations',
          'all': 'Show all tax-saving opportunities'
        };
        addMessage('user', advLabels[advType] || advType);
        extractedData.tax_profile.advanced_interest = advType;
        extractedData.tax_profile.advanced_explored = true;
        extractedData.lead_data.complexity = 'complex';
        extractedData.lead_data.score += 15;
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // CRYPTOCURRENCY HANDLERS
      // =====================================================================

      } else if (value.startsWith('crypto_')) {
        const cryptoType = value.replace('crypto_', '');
        const cryptoLabels = {
          'hold': 'Yes, I hold crypto but haven\'t sold',
          'sold': 'Yes, I sold/traded crypto',
          'earned': 'Yes, I earned crypto',
          'none': 'No cryptocurrency'
        };
        addMessage('user', cryptoLabels[cryptoType] || cryptoType);
        extractedData.tax_profile.crypto_explored = true;

        if (cryptoType !== 'none') {
          extractedData.tax_profile.has_crypto = true;
          extractedData.tax_profile.crypto_activity = cryptoType;
          extractedData.lead_data.score += 10;

          if (cryptoType === 'sold') {
            extractedData.tax_profile.has_crypto_gains = true;
            extractedData.lead_data.complexity = 'complex';
          } else if (cryptoType === 'earned') {
            extractedData.tax_profile.has_crypto_income = true;
            extractedData.lead_data.complexity = 'complex';
          }
        }
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // STOCK OPTIONS & EQUITY COMPENSATION HANDLERS
      // =====================================================================

      } else if (value.startsWith('options_')) {
        const optionType = value.replace('options_', '');
        const optionLabels = {
          'iso': 'Yes, I have ISOs',
          'nso': 'Yes, I have NSOs',
          'rsu': 'Yes, I have RSUs',
          'espp': 'Yes, I have ESPP',
          'none': 'No equity compensation'
        };
        addMessage('user', optionLabels[optionType] || optionType);
        extractedData.tax_profile.stock_options_explored = true;

        if (optionType !== 'none') {
          extractedData.tax_profile.has_equity_compensation = true;
          extractedData.tax_profile.equity_type = optionType;
          extractedData.lead_data.score += 10;
          extractedData.lead_data.complexity = 'complex';

          // ISOs have special AMT implications
          if (optionType === 'iso') {
            extractedData.tax_profile.has_iso = true;
            extractedData.tax_profile.may_have_amt = true;
          }
        }
        calculateLeadScore();
        startIntelligentQuestioning();

      // =====================================================================
      // ESTIMATED TAX PAYMENTS HANDLERS
      // =====================================================================

      } else if (value.startsWith('estimated_')) {
        const estimatedType = value.replace('estimated_', '');
        const estimatedLabels = {
          'yes': 'Yes, I make regular estimated payments',
          'sometimes': 'Sometimes, but not consistently',
          'no': 'No, I don\'t make estimated payments',
          'unsure': 'Not sure if I should be'
        };
        addMessage('user', estimatedLabels[estimatedType] || estimatedType);
        extractedData.tax_profile.estimated_explored = true;
        extractedData.tax_profile.makes_estimated_payments = (estimatedType === 'yes');
        extractedData.tax_profile.estimated_payment_status = estimatedType;

        // Flag potential underpayment penalty risk
        if (estimatedType === 'no' || estimatedType === 'unsure') {
          const profile = extractedData.tax_profile;
          if (profile.is_self_employed || profile.has_rental_income ||
              profile.has_crypto_gains || profile.has_investment_income) {
            extractedData.tax_profile.possible_underpayment_penalty = true;
          }
        }
        calculateLeadScore();
        startIntelligentQuestioning();

      // Run full analysis
      } else if (value === 'run_full_analysis') {
        addMessage('user', 'Run full analysis');
        performTaxCalculation();

      // Edit profile
      } else if (value === 'edit_profile') {
        addMessage('user', 'I want to edit my information');
        // Reset the flags to allow re-asking questions
        extractedData.tax_profile.deductions_explored = false;
        extractedData.tax_profile.goals_explored = false;
        addMessage('ai', 'No problem! What would you like to change?', [
          { label: 'Change filing status', value: 'edit_filing' },
          { label: 'Change income', value: 'edit_income' },
          { label: 'Change state', value: 'edit_state' },
          { label: 'Continue with analysis', value: 'run_full_analysis', primary: true }
        ]);

      } else if (value === 'edit_filing') {
        extractedData.tax_profile.filing_status = null;
        startIntelligentQuestioning();

      } else if (value === 'edit_income') {
        extractedData.tax_profile.total_income = null;
        startIntelligentQuestioning();

      } else if (value === 'edit_state') {
        extractedData.tax_profile.state = null;
        startIntelligentQuestioning();

      } else if (value === 'analyze_deductions') {
        addMessage('user', 'Yes, find more savings');
        analyzeDeductions();

      } else if (value === 'show_all_strategies') {
        addMessage('user', 'Show me all strategies');
        showAllStrategies();

      } else if (value === 'explore_strategies') {
        addMessage('user', 'Yes, show me the strategies');
        currentStrategyIndex = 0;
        showNextStrategy();

      } else if (value === 'quick_summary') {
        addMessage('user', 'Skip to summary');
        showStrategySummary();

      } else if (value === 'next_strategy') {
        currentStrategyIndex++;
        showNextStrategy();

      } else if (value === 'previous_strategy') {
        currentStrategyIndex = Math.max(0, currentStrategyIndex - 1);
        showNextStrategy();

      } else if (value === 'finish_strategies') {
        addMessage('user', 'I\'ve reviewed all strategies');
        showStrategySummary();

      // Deduction selection handlers
      } else if (value.startsWith('has_')) {
        const deductionType = value.replace('has_', '');
        const deductionLabels = {
          'mortgage': 'Mortgage interest',
          'charity': 'Charitable donations',
          'medical': 'Medical expenses',
          'education': 'Education expenses',
          'business': 'Business expenses',
          'retirement': 'Retirement contributions'
        };
        const label = deductionLabels[deductionType] || deductionType;
        addMessage('user', label);

        extractedData.deductions = extractedData.deductions || [];
        extractedData.deductions.push(deductionType);
        extractedData.lead_data.score += 5;
        calculateLeadScore();

        // Ask for amount
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Approximately how much in ${label.toLowerCase()} for 2025?`, [
            { label: 'Under $5,000', value: `amount_${deductionType}_low` },
            { label: '$5,000 - $15,000', value: `amount_${deductionType}_mid` },
            { label: 'Over $15,000', value: `amount_${deductionType}_high` },
            { label: 'Skip this', value: 'deduction_next' }
          ]);
        }, 800);

      } else if (value.startsWith('amount_')) {
        // Handle deduction amount selection
        const parts = value.split('_');
        const level = parts[parts.length - 1];
        const amountMap = { 'low': '$2,500', 'mid': '$10,000', 'high': '$20,000+' };
        addMessage('user', amountMap[level] || 'Estimated');

        // Continue to next deduction or credits
        showTyping();
        setTimeout(() => {
          hideTyping();
          askNextDeductionOrCredits();
        }, 800);

      } else if (value === 'deduction_next') {
        addMessage('user', 'Skip');
        showTyping();
        setTimeout(() => {
          hideTyping();
          askNextDeductionOrCredits();
        }, 500);

      } else if (value === 'deductions_done') {
        addMessage('user', 'Continue');
        showTyping();
        setTimeout(() => {
          hideTyping();
          // Move to credits or generate report
          addMessage('ai', `Got it! Now let's check for tax credits you might qualify for.`, [
            { label: 'Child Tax Credit', value: 'credit_child' },
            { label: 'Education Credits', value: 'credit_education' },
            { label: 'Energy Credits', value: 'credit_energy' },
            { label: 'Skip to report ‚Üí', value: 'generate_report' }
          ]);
        }, 800);

      // CPA scheduling handlers
      } else if (value === 'schedule_time') {
        addMessage('user', 'Schedule a consultation');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Great! Our CPA team will reach out within 24 hours to schedule at your convenience.<br><br>In the meantime, would you like your detailed tax report?`, [
            { label: 'Yes, generate my report ‚Üí', value: 'generate_report' },
            { label: "I'll wait for the CPA call", value: 'finish_satisfied' }
          ]);
        }, 1000);

      } else if (value === 'email_only') {
        addMessage('user', 'Just email me');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Perfect! We'll send your tax analysis summary to your email.<br><br>Would you also like your full advisory report?`, [
            { label: 'Yes, generate full report ‚Üí', value: 'generate_report' },
            { label: "Email summary is enough", value: 'finish_satisfied' }
          ]);
        }, 1000);

      } else if (value === 'generate_report_early') {
        addMessage('user', 'Generate my full report');
        updateProgress(90);
        // Generate actual advisory report
        value = 'generate_report'; // Fall through to existing handler

      } else if (value === 'request_cpa_early') {
        addMessage('user', 'I want to speak with a CPA');
        requestCPAConnection();

      // Consolidated status handler - redirects to main flow via startIntelligentQuestioning
      } else if (value.startsWith('status_')) {
        const status = value.replace('status_', '').replace('_', ' ');
        const statusMap = {
          'single': 'Single',
          'married filing jointly': 'Married Filing Jointly',
          'married_filing_jointly': 'Married Filing Jointly',
          'head of household': 'Head of Household',
          'married filing separately': 'Married Filing Separately',
          'qualifying surviving spouse': 'Qualifying Surviving Spouse'
        };
        const displayStatus = statusMap[status] || status.charAt(0).toUpperCase() + status.slice(1);
        addMessage('user', displayStatus);
        extractedData.tax_profile.filing_status = displayStatus;
        updateStats({ filing_status: displayStatus });
        updateProgress(15);
        extractedData.lead_data.score += 10;
        calculateLeadScore();

        // Use consolidated main flow instead of separate inline flow
        startIntelligentQuestioning();

      } else if (value.startsWith('focus_')) {
        const focus = value.replace('focus_', '').replace('_', ' ');
        addMessage('user', focus.charAt(0).toUpperCase() + focus.slice(1));
        extractedData.focus_area = focus;
        updateProgress(45);

        showTyping();
        setTimeout(() => {
          hideTyping();

          // Provide tailored responses based on focus area
          if (value === 'focus_real_estate') {
            addMessage('ai', `Excellent choice! Real estate offers significant tax advantages. Let me understand your situation better.<br><br><strong>Do you own your primary residence?</strong>`, [
              { label: 'Yes, I own my home', value: 'homeowner_yes' },
              { label: 'No, I rent', value: 'homeowner_no' },
              { label: 'I own rental properties', value: 'homeowner_rental' }
            ]);
          } else if (value === 'focus_education') {
            addMessage('ai', `Education expenses can provide valuable tax benefits. Let's explore your situation.<br><br><strong>Are you currently paying for education expenses?</strong>`, [
              { label: 'Yes, for myself', value: 'edu_self' },
              { label: 'Yes, for dependents', value: 'edu_dependents' },
              { label: 'I have student loan interest', value: 'edu_loans' },
              { label: 'Multiple of these', value: 'edu_multiple' }
            ]);
          } else if (value === 'focus_business') {
            addMessage('ai', `Self-employment and business income create unique opportunities for tax optimization. Tell me more.<br><br><strong>What's your business structure?</strong>`, [
              { label: 'Sole Proprietor / Freelancer', value: 'biz_sole' },
              { label: 'LLC / Partnership', value: 'biz_llc' },
              { label: 'S-Corp / C-Corp', value: 'biz_corp' },
              { label: 'Side business / Gig work', value: 'biz_side' }
            ]);
          } else if (value === 'focus_healthcare') {
            addMessage('ai', `Healthcare expenses can add up, but there are ways to reduce your tax burden. Let's review your situation.<br><br><strong>Do you have significant medical expenses?</strong>`, [
              { label: 'Yes, over $5,000 annually', value: 'medical_high' },
              { label: 'Moderate expenses', value: 'medical_moderate' },
              { label: 'I have an HSA', value: 'medical_hsa' },
              { label: 'Long-term care expenses', value: 'medical_ltc' }
            ]);
          } else if (value === 'focus_investments') {
            addMessage('ai', `Investment and retirement planning are crucial for long-term tax efficiency. Let's dive in.<br><br><strong>What types of investment accounts do you have?</strong>`, [
              { label: '401(k) / Traditional IRA', value: 'inv_traditional' },
              { label: 'Roth IRA', value: 'inv_roth' },
              { label: 'Brokerage / Taxable accounts', value: 'inv_brokerage' },
              { label: 'Multiple account types', value: 'inv_multiple' }
            ]);
          }
        }, 1500);

      // =====================================================================
      // FOCUS-BASED FLOW HANDLERS (with specific follow-ups)
      // =====================================================================

      // Homeowner/Real Estate handlers
      } else if (value.startsWith('homeowner_')) {
        const homeType = value.replace('homeowner_', '');
        const homeLabels = {
          'yes': 'Yes, I own my home',
          'no': 'No, I rent',
          'rental': 'I own rental properties'
        };
        addMessage('user', homeLabels[homeType] || homeType);
        extractedData.details = extractedData.details || {};
        extractedData.details[value] = true;

        showTyping();
        setTimeout(() => {
          hideTyping();
          if (homeType === 'yes') {
            // Primary residence - ask about mortgage and property tax
            addMessage('ai', `Homeownership offers great tax benefits! Let me understand your situation better.<br><br><strong>What's your approximate annual mortgage interest?</strong>`, [
              { label: 'Under $5,000', value: 'mortgage_under5k' },
              { label: '$5,000 - $15,000', value: 'mortgage_5_15k' },
              { label: '$15,000 - $30,000', value: 'mortgage_15_30k' },
              { label: 'Over $30,000', value: 'mortgage_over30k' },
              { label: 'No mortgage / Paid off', value: 'mortgage_none' }
            ]);
          } else if (homeType === 'rental') {
            // Rental property owner - ask about rental details
            addMessage('ai', `Rental properties can provide significant tax advantages. Let me learn more.<br><br><strong>How many rental properties do you own?</strong>`, [
              { label: '1 property', value: 'rental_props_1' },
              { label: '2-4 properties', value: 'rental_props_2_4' },
              { label: '5+ properties', value: 'rental_props_5plus' }
            ]);
          } else {
            // Renter - continue to next section
            continueToDeductionsFromFocus();
          }
        }, 1000);

      // Mortgage amount handlers
      } else if (value.startsWith('mortgage_')) {
        const mortgageLevel = value.replace('mortgage_', '');
        const mortgageAmounts = {
          'under5k': 2500, '5_15k': 10000, '15_30k': 22500, 'over30k': 40000, 'none': 0
        };
        const mortgageLabels = {
          'under5k': 'Under $5,000', '5_15k': '$5,000 - $15,000',
          '15_30k': '$15,000 - $30,000', 'over30k': 'Over $30,000', 'none': 'No mortgage'
        };
        addMessage('user', mortgageLabels[mortgageLevel] || mortgageLevel);
        extractedData.tax_items.mortgage_interest = mortgageAmounts[mortgageLevel] || 0;

        // Now ask about property tax
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `<strong>What's your approximate annual property tax?</strong>`, [
            { label: 'Under $3,000', value: 'proptax_under3k' },
            { label: '$3,000 - $8,000', value: 'proptax_3_8k' },
            { label: '$8,000 - $15,000', value: 'proptax_8_15k' },
            { label: 'Over $15,000', value: 'proptax_over15k' },
            { label: 'Not sure / Skip', value: 'proptax_skip' }
          ]);
        }, 800);

      // Property tax handlers
      } else if (value.startsWith('proptax_')) {
        const propTaxLevel = value.replace('proptax_', '');
        const propTaxAmounts = {
          'under3k': 1500, '3_8k': 5500, '8_15k': 11500, 'over15k': 20000, 'skip': 0
        };
        if (propTaxLevel !== 'skip') {
          const propTaxLabels = {
            'under3k': 'Under $3,000', '3_8k': '$3,000 - $8,000',
            '8_15k': '$8,000 - $15,000', 'over15k': 'Over $15,000'
          };
          addMessage('user', propTaxLabels[propTaxLevel] || propTaxLevel);
        } else {
          addMessage('user', 'Skip');
        }
        extractedData.tax_items.property_tax = propTaxAmounts[propTaxLevel] || 0;
        continueToDeductionsFromFocus();

      // Rental property count handlers
      } else if (value.startsWith('rental_props_')) {
        const rentalCount = value.replace('rental_props_', '');
        const rentalLabels = { '1': '1 property', '2_4': '2-4 properties', '5plus': '5+ properties' };
        addMessage('user', rentalLabels[rentalCount] || rentalCount);
        extractedData.tax_profile.rental_property_count = rentalCount;
        extractedData.tax_profile.has_rental_income = true;

        // Ask about rental income
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `<strong>What's your total annual rental income (before expenses)?</strong>`, [
            { label: 'Under $20,000', value: 'rental_income_under20k' },
            { label: '$20,000 - $50,000', value: 'rental_income_20_50k' },
            { label: '$50,000 - $100,000', value: 'rental_income_50_100k' },
            { label: 'Over $100,000', value: 'rental_income_over100k' }
          ]);
        }, 800);

      // Rental income handlers
      } else if (value.startsWith('rental_income_')) {
        const incomeLevel = value.replace('rental_income_', '');
        const incomeAmounts = {
          'under20k': 15000, '20_50k': 35000, '50_100k': 75000, 'over100k': 150000
        };
        const incomeLabels = {
          'under20k': 'Under $20,000', '20_50k': '$20,000 - $50,000',
          '50_100k': '$50,000 - $100,000', 'over100k': 'Over $100,000'
        };
        addMessage('user', incomeLabels[incomeLevel] || incomeLevel);
        extractedData.tax_profile.rental_income = incomeAmounts[incomeLevel] || 0;
        continueToDeductionsFromFocus();

      // Education handlers
      } else if (value.startsWith('edu_')) {
        const eduType = value.replace('edu_', '');
        const eduLabels = {
          'self': 'Yes, for myself',
          'dependents': 'Yes, for dependents',
          'loans': 'I have student loan interest',
          'multiple': 'Multiple of these'
        };
        addMessage('user', eduLabels[eduType] || eduType);
        extractedData.details = extractedData.details || {};
        extractedData.details[value] = true;

        showTyping();
        setTimeout(() => {
          hideTyping();
          if (eduType === 'loans' || eduType === 'multiple') {
            // Ask about student loan interest
            addMessage('ai', `Student loan interest can be deductible up to $2,500.<br><br><strong>How much student loan interest do you pay annually?</strong>`, [
              { label: 'Under $1,000', value: 'student_loan_under1k' },
              { label: '$1,000 - $2,500', value: 'student_loan_1_2.5k' },
              { label: 'Over $2,500', value: 'student_loan_over2.5k' },
              { label: 'Not sure', value: 'student_loan_unsure' }
            ]);
          } else if (eduType === 'dependents') {
            // Ask about education expenses for dependents
            addMessage('ai', `Education credits can save you up to $2,500 per student!<br><br><strong>How many dependents are in college or vocational school?</strong>`, [
              { label: '1 student', value: 'college_students_1' },
              { label: '2 students', value: 'college_students_2' },
              { label: '3+ students', value: 'college_students_3plus' }
            ]);
          } else {
            // Self education - ask about expenses
            addMessage('ai', `<strong>What's your approximate annual education expense?</strong>`, [
              { label: 'Under $5,000', value: 'edu_expense_under5k' },
              { label: '$5,000 - $15,000', value: 'edu_expense_5_15k' },
              { label: 'Over $15,000', value: 'edu_expense_over15k' }
            ]);
          }
        }, 800);

      // Student loan interest handlers
      } else if (value.startsWith('student_loan_')) {
        const loanLevel = value.replace('student_loan_', '');
        const loanAmounts = { 'under1k': 500, '1_2.5k': 1750, 'over2.5k': 2500, 'unsure': 1500 };
        const loanLabels = {
          'under1k': 'Under $1,000', '1_2.5k': '$1,000 - $2,500',
          'over2.5k': 'Over $2,500', 'unsure': 'Not sure'
        };
        addMessage('user', loanLabels[loanLevel] || loanLevel);
        extractedData.tax_items.student_loan_interest = loanAmounts[loanLevel] || 0;
        continueToDeductionsFromFocus();

      // College students count handlers
      } else if (value.startsWith('college_students_')) {
        const count = value.replace('college_students_', '');
        const countLabels = { '1': '1 student', '2': '2 students', '3plus': '3+ students' };
        addMessage('user', countLabels[count] || count);
        extractedData.tax_profile.college_students = count === '3plus' ? 3 : parseInt(count);
        extractedData.tax_profile.has_college_students = true;
        continueToDeductionsFromFocus();

      // Education expense handlers
      } else if (value.startsWith('edu_expense_')) {
        const expLevel = value.replace('edu_expense_', '');
        const expAmounts = { 'under5k': 3000, '5_15k': 10000, 'over15k': 20000 };
        const expLabels = { 'under5k': 'Under $5,000', '5_15k': '$5,000 - $15,000', 'over15k': 'Over $15,000' };
        addMessage('user', expLabels[expLevel] || expLevel);
        extractedData.tax_items.education_expenses = expAmounts[expLevel] || 0;
        continueToDeductionsFromFocus();

      // Healthcare/Medical handlers (from focus flow)
      } else if (value === 'medical_high' || value === 'medical_moderate' ||
                 value === 'medical_hsa' || value === 'medical_ltc') {
        const medLabels = {
          'medical_high': 'Yes, over $5,000 annually',
          'medical_moderate': 'Moderate expenses',
          'medical_hsa': 'I have an HSA',
          'medical_ltc': 'Long-term care expenses'
        };
        addMessage('user', medLabels[value] || value);
        extractedData.details = extractedData.details || {};
        extractedData.details[value] = true;

        showTyping();
        setTimeout(() => {
          hideTyping();
          if (value === 'medical_hsa') {
            // Ask about HSA contributions
            addMessage('ai', `HSA offers triple tax benefits - contributions are deductible, growth is tax-free, and withdrawals for medical expenses are tax-free!<br><br><strong>How much do you contribute to your HSA annually?</strong>`, [
              { label: 'Under $2,000', value: 'hsa_under2k' },
              { label: '$2,000 - $4,000', value: 'hsa_2_4k' },
              { label: 'Maxing out ($4,150 single / $8,300 family)', value: 'hsa_max' },
              { label: 'Not sure', value: 'hsa_unsure' }
            ]);
          } else if (value === 'medical_high' || value === 'medical_ltc') {
            // Ask about specific medical amount for high expenses
            addMessage('ai', `<strong>What's your estimated annual out-of-pocket medical expense?</strong>`, [
              { label: '$5,000 - $10,000', value: 'medical_amt_5_10k' },
              { label: '$10,000 - $25,000', value: 'medical_amt_10_25k' },
              { label: '$25,000 - $50,000', value: 'medical_amt_25_50k' },
              { label: 'Over $50,000', value: 'medical_amt_over50k' }
            ]);
          } else if (value === 'medical_moderate') {
            // Ask about moderate medical expenses too
            addMessage('ai', `<strong>What's your estimated annual out-of-pocket medical expense?</strong>`, [
              { label: 'Under $2,000', value: 'medical_amt_under2k' },
              { label: '$2,000 - $5,000', value: 'medical_amt_2_5k' },
              { label: '$5,000 - $10,000', value: 'medical_amt_5_10k' },
              { label: 'Skip this', value: 'medical_amt_skip' }
            ]);
          } else {
            continueToDeductionsFromFocus();
          }
        }, 800);

      // HSA contribution handlers
      } else if (value.startsWith('hsa_')) {
        const hsaLevel = value.replace('hsa_', '');
        const hsaAmounts = { 'under2k': 1500, '2_4k': 3000, 'max': 4150, 'unsure': 2000 };
        const hsaLabels = {
          'under2k': 'Under $2,000', '2_4k': '$2,000 - $4,000',
          'max': 'Maxing out', 'unsure': 'Not sure'
        };
        addMessage('user', hsaLabels[hsaLevel] || hsaLevel);
        extractedData.tax_items.hsa_contributions = hsaAmounts[hsaLevel] || 0;
        extractedData.tax_profile.has_hsa = true;
        continueToDeductionsFromFocus();

      // Medical amount handlers (from focus flow)
      } else if (value.startsWith('medical_amt_')) {
        const medLevel = value.replace('medical_amt_', '');
        const medAmounts = {
          'under2k': 1000, '2_5k': 3500, '5_10k': 7500,
          '10_25k': 17500, '25_50k': 37500, 'over50k': 60000, 'skip': 0
        };
        const medLabels = {
          'under2k': 'Under $2,000', '2_5k': '$2,000 - $5,000',
          '5_10k': '$5,000 - $10,000', '10_25k': '$10,000 - $25,000',
          '25_50k': '$25,000 - $50,000', 'over50k': 'Over $50,000', 'skip': 'Skip'
        };
        addMessage('user', medLabels[medLevel] || medLevel);
        extractedData.tax_items.medical = medAmounts[medLevel] || 0;
        continueToDeductionsFromFocus();

      // Investment handlers (from focus flow)
      } else if (value.startsWith('inv_')) {
        const invType = value.replace('inv_', '');
        const invLabels = {
          'traditional': '401(k) / Traditional IRA',
          'roth': 'Roth IRA',
          'brokerage': 'Brokerage / Taxable accounts',
          'multiple': 'Multiple account types'
        };
        addMessage('user', invLabels[invType] || invType);
        extractedData.details = extractedData.details || {};
        extractedData.details[value] = true;

        showTyping();
        setTimeout(() => {
          hideTyping();
          if (invType === 'brokerage' || invType === 'multiple') {
            // Ask about capital gains/losses
            addMessage('ai', `Taxable investment accounts have important tax implications.<br><br><strong>Did you have any capital gains or losses this year?</strong>`, [
              { label: 'Net gains (profit)', value: 'capgains_gains' },
              { label: 'Net losses', value: 'capgains_losses' },
              { label: 'About break-even', value: 'capgains_even' },
              { label: 'Haven\'t sold anything', value: 'capgains_none' }
            ]);
          } else if (invType === 'traditional') {
            // Ask about 401k contributions
            addMessage('ai', `<strong>How much are you contributing to your 401(k) or Traditional IRA this year?</strong>`, [
              { label: 'Under $10,000', value: 'trad_contrib_under10k' },
              { label: '$10,000 - $20,000', value: 'trad_contrib_10_20k' },
              { label: 'Maxing out 401(k) ($23,500)', value: 'trad_contrib_max401k' },
              { label: 'Maxing out IRA ($7,000)', value: 'trad_contrib_maxira' }
            ]);
          } else {
            // Roth - ask about contributions
            addMessage('ai', `<strong>How much are you contributing to your Roth IRA this year?</strong>`, [
              { label: 'Under $3,000', value: 'roth_contrib_under3k' },
              { label: '$3,000 - $7,000', value: 'roth_contrib_3_7k' },
              { label: 'Maxing out ($7,000)', value: 'roth_contrib_max' },
              { label: 'Using Backdoor Roth', value: 'roth_contrib_backdoor' }
            ]);
          }
        }, 800);

      // Capital gains handlers
      } else if (value.startsWith('capgains_')) {
        const cgType = value.replace('capgains_', '');
        const cgLabels = {
          'gains': 'Net gains (profit)', 'losses': 'Net losses',
          'even': 'About break-even', 'none': 'Haven\'t sold anything'
        };
        addMessage('user', cgLabels[cgType] || cgType);
        extractedData.tax_profile.has_capital_gains = (cgType === 'gains');
        extractedData.tax_profile.has_capital_losses = (cgType === 'losses');

        if (cgType === 'gains') {
          showTyping();
          setTimeout(() => {
            hideTyping();
            addMessage('ai', `<strong>Approximately how much in capital gains?</strong>`, [
              { label: 'Under $10,000', value: 'capgains_amt_under10k' },
              { label: '$10,000 - $50,000', value: 'capgains_amt_10_50k' },
              { label: '$50,000 - $100,000', value: 'capgains_amt_50_100k' },
              { label: 'Over $100,000', value: 'capgains_amt_over100k' }
            ]);
          }, 800);
        } else if (cgType === 'losses') {
          showTyping();
          setTimeout(() => {
            hideTyping();
            addMessage('ai', `Tax-loss harvesting can offset gains and up to $3,000 of ordinary income!<br><br><strong>Approximately how much in capital losses?</strong>`, [
              { label: 'Under $3,000', value: 'caploss_amt_under3k' },
              { label: '$3,000 - $10,000', value: 'caploss_amt_3_10k' },
              { label: 'Over $10,000', value: 'caploss_amt_over10k' }
            ]);
          }, 800);
        } else {
          continueToDeductionsFromFocus();
        }

      // Capital gains amount handlers
      } else if (value.startsWith('capgains_amt_')) {
        const amt = value.replace('capgains_amt_', '');
        const amounts = { 'under10k': 5000, '10_50k': 30000, '50_100k': 75000, 'over100k': 150000 };
        const labels = {
          'under10k': 'Under $10,000', '10_50k': '$10,000 - $50,000',
          '50_100k': '$50,000 - $100,000', 'over100k': 'Over $100,000'
        };
        addMessage('user', labels[amt] || amt);
        extractedData.tax_profile.capital_gains = amounts[amt] || 0;
        continueToDeductionsFromFocus();

      // Capital loss amount handlers
      } else if (value.startsWith('caploss_amt_')) {
        const amt = value.replace('caploss_amt_', '');
        const amounts = { 'under3k': 1500, '3_10k': 6500, 'over10k': 15000 };
        const labels = { 'under3k': 'Under $3,000', '3_10k': '$3,000 - $10,000', 'over10k': 'Over $10,000' };
        addMessage('user', labels[amt] || amt);
        extractedData.tax_profile.capital_losses = amounts[amt] || 0;
        continueToDeductionsFromFocus();

      // Traditional contribution handlers
      } else if (value.startsWith('trad_contrib_')) {
        const level = value.replace('trad_contrib_', '');
        const amounts = { 'under10k': 7500, '10_20k': 15000, 'max401k': 23500, 'maxira': 7000 };
        const labels = {
          'under10k': 'Under $10,000', '10_20k': '$10,000 - $20,000',
          'max401k': 'Maxing out 401(k)', 'maxira': 'Maxing out IRA'
        };
        addMessage('user', labels[level] || level);
        if (level === 'max401k' || level === '10_20k' || level === 'under10k') {
          extractedData.tax_profile.retirement_401k = amounts[level];
          extractedData.tax_profile.has_401k = true;
        } else {
          extractedData.tax_profile.retirement_ira = amounts[level];
        }
        continueToDeductionsFromFocus();

      // Roth contribution handlers
      } else if (value.startsWith('roth_contrib_')) {
        const level = value.replace('roth_contrib_', '');
        const labels = {
          'under3k': 'Under $3,000', '3_7k': '$3,000 - $7,000',
          'max': 'Maxing out ($7,000)', 'backdoor': 'Using Backdoor Roth'
        };
        addMessage('user', labels[level] || level);
        extractedData.tax_profile.has_roth = true;
        if (level === 'backdoor') {
          extractedData.tax_profile.uses_backdoor_roth = true;
        }
        continueToDeductionsFromFocus();

      // Business handlers from focus flow (biz_sole, biz_llc, etc. - different from biz_professional)
      } else if (value === 'biz_sole' || value === 'biz_llc' || value === 'biz_corp' || value === 'biz_side') {
        const bizLabels = {
          'biz_sole': 'Sole Proprietor / Freelancer',
          'biz_llc': 'LLC / Partnership',
          'biz_corp': 'S-Corp / C-Corp',
          'biz_side': 'Side business / Gig work'
        };
        addMessage('user', bizLabels[value] || value);
        extractedData.tax_profile.is_self_employed = true;
        extractedData.details = extractedData.details || {};
        extractedData.details[value] = true;

        // Map to entity types for consistency
        if (value === 'biz_sole') extractedData.tax_profile.entity_type = 'sole';
        if (value === 'biz_llc') extractedData.tax_profile.entity_type = 'llc_single';
        if (value === 'biz_corp') extractedData.tax_profile.entity_type = 'scorp';
        if (value === 'biz_side') extractedData.tax_profile.has_side_business = true;

        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `<strong>What's your approximate annual business income (before expenses)?</strong>`, [
            { label: 'Under $25,000', value: 'bizinc_under25k' },
            { label: '$25,000 - $75,000', value: 'bizinc_25_75k' },
            { label: '$75,000 - $150,000', value: 'bizinc_75_150k' },
            { label: 'Over $150,000', value: 'bizinc_over150k' }
          ]);
        }, 800);

      // Business income handlers
      } else if (value.startsWith('bizinc_')) {
        const level = value.replace('bizinc_', '');
        const amounts = { 'under25k': 15000, '25_75k': 50000, '75_150k': 112500, 'over150k': 200000 };
        const labels = {
          'under25k': 'Under $25,000', '25_75k': '$25,000 - $75,000',
          '75_150k': '$75,000 - $150,000', 'over150k': 'Over $150,000'
        };
        addMessage('user', labels[level] || level);
        extractedData.tax_profile.business_income = amounts[level] || 0;
        continueToDeductionsFromFocus();

      } else if (value.startsWith('deduct_')) {
        if (value === 'deduct_skip') {
          addMessage('user', 'Let\'s continue');
        } else {
          const deduction = value.replace('deduct_', '').replace('_', ' ');
          addMessage('user', deduction.charAt(0).toUpperCase() + deduction.slice(1));
          extractedData.deductions = extractedData.deductions || [];
          extractedData.deductions.push(deduction);
        }
        updateProgress(75);

        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Perfect! Now let's explore tax credits you might qualify for. Credits directly reduce your tax bill dollar-for-dollar.<br><br><strong>Do any of these situations apply to you?</strong>`, [
            { label: 'üë∂ Child Tax Credit', value: 'credit_child' },
            { label: 'üìö Education Credits (AOTC/LLC)', value: 'credit_education' },
            { label: '‚ö° Energy Efficiency Credits', value: 'credit_energy' },
            { label: 'üíº Earned Income Credit', value: 'credit_eitc' },
            { label: 'Not sure / Continue', value: 'credit_skip' }
          ]);
        }, 1500);

      } else if (value.startsWith('credit_')) {
        if (value === 'credit_skip') {
          addMessage('user', 'Let\'s continue');
        } else {
          const credit = value.replace('credit_', '').replace('_', ' ');
          addMessage('user', credit.charAt(0).toUpperCase() + credit.slice(1));
          extractedData.credits = extractedData.credits || [];
          extractedData.credits.push(credit);
        }
        updateProgress(90);

        showTyping();
        setTimeout(() => {
          hideTyping();

          // Generate summary
          const summary = generateSummary();
          addMessage('ai', `<strong>Excellent! I now have a comprehensive understanding of your tax situation.</strong><br><br>Here's what we've covered:<br><br>${summary}<br><br>Based on this information, I can provide you with a detailed strategic tax advisory report including:<br><br>‚úì <strong>Personalized tax optimization strategies</strong><br>‚úì <strong>Estimated tax savings opportunities</strong><br>‚úì <strong>Action items for the current tax year</strong><br>‚úì <strong>Long-term planning recommendations</strong><br>‚úì <strong>Compliance checklist</strong><br><br><strong>Would you like me to generate your comprehensive tax advisory report now?</strong>`, [
            { label: 'üìä Yes, generate my report', value: 'generate_report' },
            { label: 'üí¨ I have more questions first', value: 'more_questions' },
            { label: 'üìÑ Let me add documents', value: 'add_documents' }
          ]);
        }, 2000);

      } else if (value === 'generate_report') {
        addMessage('user', 'Yes, please generate my comprehensive tax advisory report');
        updateProgress(95);

        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `<strong>Generating your personalized tax advisory report...</strong><br><br>I'm analyzing your information and creating strategic recommendations tailored to your unique situation.<br><br>Your report will include:<br>‚Ä¢ Comprehensive tax analysis<br>‚Ä¢ Optimization strategies<br>‚Ä¢ Estimated savings opportunities<br>‚Ä¢ Action plan with timelines<br>‚Ä¢ Filing strategy recommendations<br><br><em>Please wait while I prepare your report...</em>`);

          // Simulate report generation
          setTimeout(() => {
            updateProgress(100);
            addMessage('ai', `<div class="insight-card"><div class="insight-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;"><span style="font-size: 32px;">üéâ</span><strong style="font-size: 20px;">Your Tax Advisory Report is Ready!</strong></div><div style="color: var(--text-secondary); line-height: 1.6;">I've completed a comprehensive analysis of your tax situation. Your personalized report includes strategic recommendations that could save you thousands of dollars.</div></div><br><strong>What would you like to do next?</strong>`, [
              { label: 'üì• Download Full Report (PDF)', value: 'download_report' },
              { label: 'üëÄ View Report Online', value: 'view_report' },
              { label: 'üìß Email Report to Me', value: 'email_report' },
              { label: 'üìû Schedule CPA Consultation', value: 'schedule_consult' }
            ]);
          }, 3000);
        }, 1000);

      } else if (value === 'download_report') {
        addMessage('user', 'Download my report as PDF');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `<strong>Perfect! Preparing your PDF report...</strong><br><br>Your comprehensive tax advisory report is being generated with:<br>‚Ä¢ Executive summary<br>‚Ä¢ Detailed analysis of your tax situation<br>‚Ä¢ Strategic recommendations<br>‚Ä¢ Action items and timelines<br>‚Ä¢ Potential savings breakdown<br><br><em>The download will begin automatically...</em>`);

          // Trigger actual report download
          setTimeout(() => {
            generateAndDownloadReport();
          }, 1500);
        }, 1000);

      } else if (value === 'view_report') {
        addMessage('user', 'Let me view the report online');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Opening your interactive tax advisory report in a new window...<br><br>You'll be able to:<br>‚Ä¢ Review all recommendations<br>‚Ä¢ See detailed calculations<br>‚Ä¢ Print or save as needed<br>‚Ä¢ Share with your CPA if desired`);

          setTimeout(() => {
            window.open('/advisory-report-preview?session_id=' + sessionId, '_blank');
          }, 1000);
        }, 1000);

      } else if (value === 'email_report') {
        addMessage('user', 'Email the report to me');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `I'd be happy to email your report to you.<br><br><strong>What email address should I send it to?</strong><br><br><input type="email" id="emailInput" placeholder="your.email@example.com" style="width: 100%; padding: 12px; margin: 12px 0; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px;"><button onclick="sendReportEmail()" style="padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Send Report</button>`);
        }, 1000);

      } else if (value === 'schedule_consult') {
        addMessage('user', 'I\'d like to schedule a consultation');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `<strong>Excellent decision! A personalized consultation can help you maximize your tax savings.</strong><br><br>Our CPA team specializes in individual tax advisory and can provide:<br>‚Ä¢ One-on-one strategic planning<br>‚Ä¢ Custom optimization strategies<br>‚Ä¢ Ongoing tax advisory support<br>‚Ä¢ Filing assistance when needed<br><br><strong>What works best for you?</strong>`, [
            { label: 'üìû Schedule a call', value: 'consult_call' },
            { label: 'üí¨ Chat with a CPA now', value: 'consult_chat' },
            { label: 'üìß Email consultation', value: 'consult_email' }
          ]);
        }, 1500);

      } else if (value === 'more_questions') {
        addMessage('user', 'I have more questions first');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Of course! I'm here to answer any questions you have. Feel free to ask me about:<br><br>‚Ä¢ Specific deductions or credits<br>‚Ä¢ Tax planning strategies<br>‚Ä¢ Entity structure optimization<br>‚Ä¢ Estimated tax payments<br>‚Ä¢ Any other tax-related concerns<br><br><strong>What would you like to know?</strong>`);
          document.getElementById('userInput').focus();
        }, 1000);

      } else if (value === 'add_documents') {
        addMessage('user', 'Let me add some documents');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Great! Adding documents will help me provide even more accurate recommendations.<br><br>You can upload:<br>‚Ä¢ W-2 forms<br>‚Ä¢ 1099 forms<br>‚Ä¢ Previous tax returns<br>‚Ä¢ Receipts and statements<br><br>Just drag and drop files below, or click to browse.`);
          document.getElementById('fileInput').click();
        }, 1000);

      } else if (value.startsWith('consult_')) {
        const consultType = value.replace('consult_', '');
        addMessage('user', consultType.charAt(0).toUpperCase() + consultType.slice(1) + ' consultation');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `<strong>Perfect! I'm connecting you with our CPA team.</strong><br><br>Your comprehensive tax profile and advisory report will be shared with them so they can provide immediate, informed guidance.<br><br>A member of our team will reach out within 24 hours to schedule your personalized consultation.<br><br><strong>Is there anything else I can help you with today?</strong>`, [
            { label: '‚úÖ No, I\'m all set', value: 'finish_satisfied' },
            { label: 'üì• Download my report first', value: 'download_report' },
            { label: 'üí¨ Ask another question', value: 'more_questions' }
          ]);
        }, 1500);

      } else if (value === 'finish_satisfied') {
        addMessage('user', 'No, I\'m all set. Thank you!');
        updateProgress(100);
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `<div class="insight-card"><strong style="font-size: 18px;">üéâ Thank you for choosing Premium Tax Advisory!</strong><br><br>Your comprehensive tax profile has been saved securely. You can return anytime to:<br>‚Ä¢ Access your advisory report<br>‚Ä¢ Update your information<br>‚Ä¢ Ask additional questions<br>‚Ä¢ Schedule consultations<br><br>Remember, strategic tax planning is an ongoing process. We're here to support you throughout the year, not just during tax season.<br><br><em>Wishing you maximum savings and financial success!</em></div>`);

          // Add confetti or celebration animation here if desired
          updateInsights(['Your tax advisory session is complete!', 'Report saved to your account', 'Next steps emailed to you']);
        }, 1500);

      } else if (value === 'continue_assessment') {
        addMessage('user', 'Let\'s continue with the assessment');
        showTyping();
        setTimeout(() => {
          hideTyping();

          // Determine next logical step based on what's missing
          if (!extractedData.filing_status) {
            addMessage('ai', `What's your filing status?`, [
              { label: 'Single', value: 'filing_single' },
              { label: 'Married Filing Jointly', value: 'filing_married' },
              { label: 'Head of Household', value: 'filing_hoh' },
              { label: 'Married Filing Separately', value: 'filing_mfs' },
              { label: 'Qualifying Surviving Spouse', value: 'filing_qss' }
            ]);
          } else if (!extractedData.income_range) {
            addMessage('ai', `What's your approximate annual income?`, [
              { label: 'Under $50K', value: 'income_0_50k' },
              { label: '$50K - $100K', value: 'income_50_100k' },
              { label: '$100K - $200K', value: 'income_100_200k' },
              { label: '$200K+', value: 'income_200_500k' }
            ]);
          } else if (!extractedData.focus_area) {
            addMessage('ai', `Excellent! <strong>What areas are you most interested in optimizing?</strong>`, [
              { label: 'üè† Homeownership & Real Estate', value: 'focus_real_estate' },
              { label: 'üìö Education & Student Loans', value: 'focus_education' },
              { label: 'üíº Business & Self-Employment', value: 'focus_business' },
              { label: 'üè• Healthcare & Medical', value: 'focus_healthcare' },
              { label: 'üìà Investments & Retirement', value: 'focus_investments' }
            ]);
          } else {
            addMessage('ai', `We've covered the basics! <strong>Ready to generate your comprehensive advisory report?</strong>`, [
              { label: 'üìä Yes, generate report', value: 'generate_report' },
              { label: 'üí¨ I have questions first', value: 'more_questions' }
            ]);
          }
        }, 1000);

      } else if (value === 'continue_to_report') {
        addMessage('user', 'Let\'s move forward with the report');
        updateProgress(85);
        showTyping();
        setTimeout(() => {
          hideTyping();
          const summary = generateSummary();
          addMessage('ai', `<strong>Perfect! Here's what we've covered:</strong><br><br>${summary}<br><br>I can now prepare your comprehensive tax advisory report with personalized recommendations. <strong>Shall we proceed?</strong>`, [
            { label: 'üìä Generate my report', value: 'generate_report' },
            { label: '‚úèÔ∏è Make changes first', value: 'review_summary' }
          ]);
        }, 1000);

      } else if (value === 'review_summary') {
        addMessage('user', 'Let me review what we covered');
        showTyping();
        setTimeout(() => {
          hideTyping();
          const summary = generateSummary();
          addMessage('ai', `<strong>Here's a complete summary of your tax profile:</strong><br><br>${summary}<br><br>Would you like to update any of this information or continue to generate your report?`, [
            { label: '‚úèÔ∏è Update filing status', value: 'no_manual' },
            { label: '‚úèÔ∏è Update income/focus', value: 'continue_assessment' },
            { label: '‚úÖ Looks good, continue', value: 'generate_report' }
          ]);
        }, 1000);

      } else if (value === 'ask_question' || value === 'how_it_works') {
        const userMsg = value === 'ask_question' ? 'I have a question' : 'How does this work?';
        addMessage('user', userMsg);

        if (value === 'how_it_works') {
          showTyping();
          setTimeout(() => {
            hideTyping();
            addMessage('ai', `<strong>Great question! Here's how our premium tax advisory works:</strong><br><br><strong>1. Understanding Your Situation (5 minutes)</strong><br>I ask targeted questions to understand your financial picture, or you can upload documents for instant analysis.<br><br><strong>2. Comprehensive Analysis</strong><br>I analyze your situation using 2025 IRS rules, identifying every deduction, credit, and strategy available to you.<br><br><strong>3. Personalized Report</strong><br>You receive a detailed advisory report with:<br>‚Ä¢ Current tax liability estimate<br>‚Ä¢ Potential savings opportunities<br>‚Ä¢ Specific action items<br>‚Ä¢ Long-term planning strategies<br><br><strong>4. Ongoing Support</strong><br>Access to CPA consultations, filing assistance (if needed), and year-round advisory support.<br><br><strong>Ready to get started with your assessment?</strong>`, [
              { label: '‚úÖ Yes, let\'s begin', value: 'continue_assessment' },
              { label: 'üìÑ I want to upload docs', value: 'yes_upload' },
              { label: '‚ùì I have another question', value: 'more_questions' }
            ]);
          }, 1500);
        } else {
          showTyping();
          setTimeout(() => {
            hideTyping();
            addMessage('ai', `Of course! I'm here to answer any questions you have about:<br><br>‚Ä¢ Tax strategies and optimization<br>‚Ä¢ Deductions and credits you may qualify for<br>‚Ä¢ Filing requirements and deadlines<br>‚Ä¢ How to maximize your refund or minimize taxes owed<br>‚Ä¢ Anything else tax-related!<br><br><strong>What would you like to know?</strong> (Feel free to type your question below)`);
            document.getElementById('userInput').focus();
          }, 1000);
        }

      // Error recovery handlers
      } else if (value === 'wait_retry') {
        addMessage('user', 'I\'ll wait and try again');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Thanks for your patience! I'm ready to continue now. What would you like to discuss?`, generateSmartQuickActions());
        }, 3000);

      } else if (value === 'retry_analysis') {
        addMessage('user', 'Retry the analysis');
        performTaxCalculation();

      } else if (value === 'reset_conversation') {
        addMessage('user', 'Let\'s start over');
        // Reset session and data
        sessionId = null;
        sessionStorage.removeItem('tax_session_id');
        conversationHistory = [];
        extractedData = {
          filing_status: null,
          income_range: null,
          income_amount: null,
          deductions: [],
          credits: [],
          focus_area: null,
          tax_profile: {},
          documents: [],
          lead_data: { score: 0 }
        };
        updateProgress(0);
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `No problem! Let's start fresh. I'm your AI-powered tax advisor, ready to help you discover strategic opportunities to optimize your tax situation.<br><br><strong>Would you like to upload tax documents for me to analyze, or shall we talk through your situation?</strong>`, [
            { label: 'üìÑ Upload documents', value: 'yes_upload' },
            { label: 'üí¨ Let\'s discuss my situation', value: 'no_manual' },
            { label: '‚ùì How does this work?', value: 'how_it_works' }
          ]);
        }, 1000);

      } else if (value === 'retry_message') {
        // Retry the last message if available
        if (lastUserMessage) {
          addMessage('user', 'Retrying my last message...');
          await processAIResponse(lastUserMessage);
        } else {
          addMessage('user', 'Let me try again');
          showTyping();
          setTimeout(() => {
            hideTyping();
            addMessage('ai', `I'm ready when you are! What would you like to discuss?`, generateSmartQuickActions());
            document.getElementById('userInput').focus();
          }, 500);
        }

      } else {
        // For any other actions not handled, use AI processing
        const displayText = value.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        addMessage('user', displayText);
        await processAIResponse(value);
      }
    }

    // Helper function to continue from focus-specific questions to deductions
    function continueToDeductionsFromFocus() {
      updateProgress(60);
      showTyping();
      setTimeout(() => {
        hideTyping();
        addMessage('ai', `I've gathered some valuable information about your situation. Now let's explore any additional deductions you might have.<br><br><strong>Do you have any of these common deductions?</strong>`, [
          { label: 'üè† Mortgage Interest', value: 'deduct_mortgage' },
          { label: 'üí∞ Charitable Donations', value: 'deduct_charity' },
          { label: 'üè• Medical Expenses', value: 'deduct_medical' },
          { label: 'üíº Business Expenses', value: 'deduct_business' },
          { label: '‚û°Ô∏è Continue to Credits', value: 'deduct_skip' }
        ]);
      }, 1200);
    }

    // Helper function to generate summary
    function generateSummary() {
      let summary = '';

      if (extractedData.filing_status) {
        summary += `üìã <strong>Filing Status:</strong> ${extractedData.filing_status}<br>`;
      }
      if (extractedData.income_range) {
        summary += `üí∞ <strong>Income Range:</strong> ${extractedData.income_range}<br>`;
      }
      if (extractedData.focus_area) {
        summary += `üéØ <strong>Focus Area:</strong> ${extractedData.focus_area}<br>`;
      }
      if (extractedData.deductions && extractedData.deductions.length > 0) {
        summary += `üìä <strong>Deductions:</strong> ${extractedData.deductions.join(', ')}<br>`;
      }
      if (extractedData.credits && extractedData.credits.length > 0) {
        summary += `‚≠ê <strong>Credits:</strong> ${extractedData.credits.join(', ')}<br>`;
      }

      return summary || 'Your comprehensive tax profile';
    }

    // Helper function to generate and download report
    async function generateAndDownloadReport() {
      try {
        addMessage('ai', '‚è≥ Generating your PDF report...');

        // Call the advisory report API
        const response = await fetch('/api/v1/advisory-reports/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: sessionId,
            report_type: 'full_analysis',
            include_entity_comparison: true,
            include_multi_year: true,
            years_ahead: 3,
            generate_pdf: true
          })
        });

        if (response.ok) {
          const data = await response.json();

          // Poll for PDF completion
          let pdfReady = false;
          let attempts = 0;
          while (!pdfReady && attempts < 30) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            const statusResponse = await fetch(`/api/v1/advisory-reports/${data.report_id}`);
            const statusData = await statusResponse.json();
            if (statusData.pdf_available) {
              pdfReady = true;
              // Download the PDF
              window.open(`/api/v1/advisory-reports/${data.report_id}/pdf`, '_blank');
              addMessage('ai', `‚úÖ <strong>Your report is ready!</strong><br><br>The PDF download should begin automatically. If not, <a href="/api/v1/advisory-reports/${data.report_id}/pdf" target="_blank" style="color: var(--primary);">click here to download</a>.`);
            }
            attempts++;
          }
        } else {
          throw new Error('Failed to generate report');
        }
      } catch (error) {
        console.error('Report generation error:', error);
        addMessage('ai', `I encountered an issue generating the PDF. However, you can still <a href="/advisory-report-preview?session_id=${sessionId}" target="_blank" style="color: var(--primary);">view your report online here</a>.`);
      }
    }

    // Helper function to send report via email
    async function sendReportEmail() {
      const email = document.getElementById('emailInput').value;
      if (!email || !email.includes('@')) {
        alert('Please enter a valid email address');
        return;
      }

      addMessage('user', `Send to: ${email}`);
      showTyping();

      setTimeout(() => {
        hideTyping();
        addMessage('ai', `<strong>‚úÖ Report sent successfully!</strong><br><br>I've emailed your comprehensive tax advisory report to <strong>${email}</strong>.<br><br>Please check your inbox (and spam folder) within the next few minutes. The email will include:<br>‚Ä¢ PDF attachment of your full report<br>‚Ä¢ Summary of key findings<br>‚Ä¢ Personalized action items<br>‚Ä¢ Link to schedule a consultation<br><br><strong>What would you like to do next?</strong>`, [
          { label: 'üì• Also download PDF', value: 'download_report' },
          { label: 'üìû Schedule consultation', value: 'schedule_consult' },
          { label: '‚úÖ I\'m all set', value: 'finish_satisfied' }
        ]);
      }, 2000);
    }

    // Retry helper with exponential backoff
    async function fetchWithRetry(url, options, maxRetries = 3) {
      let lastError;

      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

          const response = await fetch(url, {
            ...options,
            signal: controller.signal
          });

          clearTimeout(timeoutId);

          // Don't retry on client errors (4xx) except 408 (timeout) and 429 (rate limit)
          if (response.status >= 400 && response.status < 500 &&
              response.status !== 408 && response.status !== 429) {
            return response;
          }

          // Retry on server errors (5xx) or specific client errors
          if (!response.ok && attempt < maxRetries) {
            const delay = Math.min(1000 * Math.pow(2, attempt - 1), 8000); // Max 8s delay
            console.log(`Retry attempt ${attempt} after ${delay}ms`);
            await new Promise(resolve => setTimeout(resolve, delay));
            continue;
          }

          return response;
        } catch (error) {
          lastError = error;

          // Don't retry on abort errors
          if (error.name === 'AbortError') {
            throw new Error('Request timeout - please try again');
          }

          // Retry on network errors
          if (attempt < maxRetries) {
            const delay = Math.min(1000 * Math.pow(2, attempt - 1), 8000);
            console.log(`Network error, retry attempt ${attempt} after ${delay}ms`);
            await new Promise(resolve => setTimeout(resolve, delay));
            continue;
          }
        }
      }

      throw lastError || new Error('Request failed after retries');
    }

    // Store last message for retry
    let lastUserMessage = null;

    async function processAIResponse(userMessage) {
      isProcessing = true;
      lastUserMessage = userMessage; // Store for retry
      showTyping();

      // Create session if not already created
      if (!sessionId) {
        try {
          const sessionResponse = await fetchWithRetry('/api/sessions/create-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              workflow_type: 'intelligent_conversational',
              tax_year: 2025
            })
          }, 2); // 2 retries for session creation

          if (!sessionResponse.ok) {
            // If session creation fails, generate a temporary client-side ID
            sessionId = 'temp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            console.warn('Using temporary session ID:', sessionId);
          } else {
            const sessionData = await sessionResponse.json();
            sessionId = sessionData.session_id;
          }
          sessionStorage.setItem('tax_session_id', sessionId);
        } catch (error) {
          console.error('Failed to create session:', error);
          // Generate temporary client-side session ID as fallback
          sessionId = 'temp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
          sessionStorage.setItem('tax_session_id', sessionId);
        }
      }

      // Build context-aware system message for AI
      const systemContext = buildSystemContext();

      try {
        const response = await fetchWithRetry('/api/ai-chat/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: sessionId,
            user_message: userMessage,
            conversation_history: conversationHistory,
            extracted_data: extractedData,
            system_context: systemContext
          })
        }, 3); // 3 retries with exponential backoff

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        hideTyping();

        // Update conversation history
        conversationHistory.push(
          { role: 'user', content: userMessage },
          { role: 'assistant', content: data.ai_response }
        );

        // Update extracted data if AI extracted any information
        if (data.extracted_data) {
          extractedData = { ...extractedData, ...data.extracted_data };
          console.log('Updated extracted data:', extractedData);
        }

        // Show AI response with any suggested quick actions
        const aiResponse = data.ai_response || data.response || "I'm here to help. Could you please clarify?";
        const quickActions = data.quick_actions || generateSmartQuickActions();

        addMessage('ai', aiResponse, quickActions);

        // Update side panel with AI insights
        if (data.completion_percentage !== undefined) {
          updateProgress(data.completion_percentage);
        }
        if (data.insights && data.insights.length > 0) {
          updateInsights(data.insights);
        }
        if (data.extracted_summary) {
          updateStats(data.extracted_summary);
        }

      } catch (error) {
        hideTyping();
        console.error('AI response error:', error);

        // Handle specific error types
        let errorMessage = '';
        let quickActions = generateSmartQuickActions();

        if (error.message && error.message.includes('429')) {
          // Rate limit exceeded
          errorMessage = "I'm getting a lot of requests right now. Please wait a moment before sending another message.";
          quickActions = [
            { label: 'Wait 30 seconds', value: 'wait_retry' },
            { label: 'Start over', value: 'reset_conversation' }
          ];
        } else if (error.message && error.message.includes('404')) {
          // Session not found - recreate
          sessionId = null;
          sessionStorage.removeItem('tax_session_id');
          errorMessage = "Your session was reset. Let's continue from where we were. What would you like to discuss?";
        } else if (error.message && error.message.includes('504') || error.message && error.message.includes('timeout')) {
          // Timeout - suggest rephrasing
          errorMessage = "That's taking longer than expected. Could you try rephrasing your question or asking something simpler?";
        } else if (!navigator.onLine) {
          // Offline
          errorMessage = "It looks like you're offline. Please check your internet connection and try again.";
          quickActions = [
            { label: 'Try again', value: 'retry_message' }
          ];
        } else {
          // Generic fallback
          errorMessage = generateIntelligentFallback(userMessage);
        }

        addMessage('ai', errorMessage, quickActions);
      } finally {
        // Always reset processing flag
        isProcessing = false;
      }
    }

    // Build system context for AI to understand conversation state
    function buildSystemContext() {
      const progress = getCurrentProgress();
      const confidence = getConfidenceLevel();

      let context = {
        role: 'system',
        content: `You are a premium CPA tax advisor AI assistant specializing in individual tax advisory. You're having a warm, professional conversation with a client.

‚ö†Ô∏è CRITICAL AI DISCLOSURE REQUIREMENTS:
- You are an AI assistant, NOT a licensed CPA or tax professional
- Your responses are ESTIMATES and GENERAL GUIDANCE, not professional tax advice
- Users should ALWAYS verify information with a licensed tax professional before making decisions
- Include relevant IRS publication/form references when giving specific tax guidance

CRITICAL: All tax advice, limits, deductions, and credits must follow 2025 IRS rules and regulations. Use only 2025 tax year information.

Tax Year: 2025
Data Confidence: ${confidence.level} (${confidence.percentage}% complete)
Current conversation state:
- Progress: ${progress}%
- Filing Status: ${extractedData.filing_status || 'Not yet provided'}
- Income Range: ${extractedData.income_range || 'Not yet provided'}
- Focus Area: ${extractedData.focus_area || 'Not yet determined'}
- Deductions: ${extractedData.deductions ? extractedData.deductions.join(', ') : 'None captured yet'}
- Credits: ${extractedData.credits ? extractedData.credits.join(', ') : 'None captured yet'}

2025 IRS Key Information (cite these sources):
- Standard Deduction Single: $15,000 (IRS Rev. Proc. 2024-40)
- Standard Deduction MFJ: $30,000 (IRS Rev. Proc. 2024-40)
- Standard Deduction HOH: $22,500 (IRS Rev. Proc. 2024-40)
- Child Tax Credit: $2,000/child (IRC ¬ß24, Form 8812)
- 401(k) Limit: $23,500 / $31,000 catch-up (IRS Notice 2024-80)
- IRA Limit: $7,000 / $8,000 catch-up (IRS Notice 2024-80)
- EITC Max: $7,830 (3+ children) (IRS Rev. Proc. 2024-40)
- SALT Deduction Cap: $10,000 (IRC ¬ß164(b)(6))

IRS SOURCE CITATION GUIDELINES:
When discussing specific tax topics, reference relevant IRS resources:
- Deductions: "See IRS Publication 17, Chapter [X]"
- Credits: "See Form [number] instructions"
- Filing Status: "See IRS Publication 501"
- Self-Employment: "See Schedule SE and IRS Publication 334"
- Home Office: "See IRS Publication 587"
- Retirement: "See IRS Publication 590-A/B"

RESPONSE GUIDELINES:
1. Maintain a warm, experienced advisor tone
2. This is INDIVIDUAL tax advisory - emphasize strategic planning
3. ALWAYS use 2025 IRS rules with source citations when specific
4. If data confidence is LOW, emphasize this is general guidance only
5. Extract tax-relevant information and suggest clarifying questions
6. If the user asks off-topic questions, answer briefly then redirect
7. Always recommend consulting a licensed CPA for final decisions
8. Be helpful, patient, and professional

If you need more information to provide good advice, ask specific questions.
If they're ready to move forward, suggest generating their comprehensive advisory report.`
      };

      return context;
    }

    // Generate smart quick actions based on current state
    function generateSmartQuickActions() {
      const progress = getCurrentProgress();

      if (progress < 20) {
        return [
          { label: 'üí¨ Tell you my situation', value: 'no_manual' },
          { label: 'üìÑ Upload documents', value: 'yes_upload' },
          { label: '‚ùì How does this work?', value: 'how_it_works' }
        ];
      } else if (progress < 50) {
        return [
          { label: 'üìä Continue the assessment', value: 'continue_assessment' },
          { label: '‚ùì I have a question', value: 'ask_question' },
          { label: 'üìÑ Add documents', value: 'add_documents' }
        ];
      } else if (progress < 90) {
        return [
          { label: '‚úÖ Continue to report', value: 'continue_to_report' },
          { label: 'üí¨ Ask something else', value: 'ask_question' },
          { label: 'üìã Review what we covered', value: 'review_summary' }
        ];
      } else {
        return [
          { label: 'üìä Generate my report', value: 'generate_report' },
          { label: 'üìû Schedule consultation', value: 'schedule_consult' },
          { label: 'üí¨ I have questions', value: 'more_questions' }
        ];
      }
    }

    // Generate intelligent fallback response
    function generateIntelligentFallback(userMessage) {
      const lowerMessage = userMessage.toLowerCase();

      // Check for common tax questions
      if (lowerMessage.includes('deduction') || lowerMessage.includes('deduct')) {
        return `Great question about deductions! Deductions reduce your taxable income. Common ones include:<br><br>‚Ä¢ Mortgage interest<br>‚Ä¢ Charitable donations<br>‚Ä¢ State and local taxes<br>‚Ä¢ Medical expenses (if over 7.5% of income)<br>‚Ä¢ Business expenses<br><br>To provide specific guidance for your situation, I need to know a bit more about you. <strong>What's your filing status?</strong>`;
      }

      if (lowerMessage.includes('credit')) {
        return `Tax credits are even better than deductions - they reduce your tax bill dollar-for-dollar! Common credits include:<br><br>‚Ä¢ Child Tax Credit<br>‚Ä¢ Earned Income Credit<br>‚Ä¢ Education credits<br>‚Ä¢ Energy efficiency credits<br><br>Let me learn more about your situation so I can identify which credits you qualify for. <strong>Shall we continue with your assessment?</strong>`;
      }

      if (lowerMessage.includes('save') || lowerMessage.includes('savings')) {
        return `I love that you're focused on savings! The amount you can save depends on your specific situation. On average, strategic tax planning saves our clients $2,000-$15,000 annually.<br><br>To calculate your potential savings, I need to understand your:<br>‚Ä¢ Income level<br>‚Ä¢ Filing status<br>‚Ä¢ Current deductions and credits<br>‚Ä¢ Financial goals<br><br><strong>Would you like to complete a quick assessment so I can estimate your savings?</strong>`;
      }

      if (lowerMessage.includes('cost') || lowerMessage.includes('price') || lowerMessage.includes('fee')) {
        return `Our individual tax advisory service is complimentary for the initial assessment. We'll provide you with a comprehensive analysis and recommendations at no cost.<br><br>If you'd like ongoing advisory support or assistance with tax filing, we'll discuss those services after your initial report.<br><br><strong>Would you like to continue with your free tax assessment?</strong>`;
      }

      // Handle confused or frustrated users
      if (lowerMessage.includes('confused') || lowerMessage.includes('don\'t understand') || lowerMessage.includes('help')) {
        return `I'm sorry for any confusion! Let me make this simpler.<br><br>I'm here to help you save money on your taxes. All you need to do is answer a few quick questions about your situation, and I'll provide personalized recommendations.<br><br><strong>Would you like to start with something simple? What's your filing status?</strong>`;
      }

      // Handle exit intent
      if (lowerMessage.includes('quit') || lowerMessage.includes('exit') || lowerMessage.includes('stop') || lowerMessage.includes('bye')) {
        return `I understand! Before you go, know that your progress has been saved. You can come back anytime to continue your tax assessment.<br><br>Is there anything specific I can help you with quickly before you go?`;
      }

      // Handle off-topic or personal questions
      if (lowerMessage.includes('who are you') || lowerMessage.includes('what are you') || lowerMessage.includes('your name')) {
        return `I'm your AI-powered tax advisor! I specialize in helping individuals optimize their tax situation.<br><br>I can analyze your income, deductions, and credits to find opportunities to save money on your taxes. <strong>Would you like to get started with a quick assessment?</strong>`;
      }

      // Handle vague income statements
      if (lowerMessage.includes('make good money') || lowerMessage.includes('decent salary') || lowerMessage.includes('earn a lot')) {
        return `That's great! To provide accurate tax advice, I'll need a more specific income range. This helps me identify the right deductions and credits for your situation.<br><br><strong>What's your approximate annual income?</strong>`;
      }

      // Generic helpful response
      return `I appreciate your question! While I'm here primarily to help with your tax advisory needs, I want to make sure I address your concern properly.<br><br>To give you the most accurate guidance, let me learn more about your tax situation. This will help me provide personalized recommendations that could save you thousands of dollars.<br><br><strong>Would you like to continue with your tax assessment, or do you have other specific questions?</strong>`;
    }

    // Get current progress percentage
    function getCurrentProgress() {
      const progressFill = document.getElementById('progressFill');
      if (progressFill) {
        const width = progressFill.style.width;
        return parseInt(width) || 0;
      }
      return 0;
    }

    function updateProgress(percentage) {
      document.getElementById('progressFill').style.width = percentage + '%';
      document.getElementById('progressText').textContent = `${Math.round(percentage)}% Complete`;
    }

    function updateInsights(insights) {
      const container = document.getElementById('insights');
      if (insights.length === 0) return;

      container.innerHTML = insights.map(insight => `
        <div class="insight-card">
          <div class="insight-header">
            <span>${insight.icon}</span>
            <span>${insight.title}</span>
          </div>
          <div style="font-size: 13px; color: var(--text-secondary);">
            ${insight.text}
          </div>
        </div>
      `).join('');
    }

    function updateStats(summary) {
      const grid = document.getElementById('statsGrid');
      const stats = [];

      if (summary.filing_status) stats.push({ label: 'Filing Status', value: summary.filing_status });
      if (summary.total_income) stats.push({ label: 'Income', value: '$' + summary.total_income.toLocaleString() });
      if (summary.deductions_count) stats.push({ label: 'Deductions', value: summary.deductions_count });

      if (stats.length > 0) {
        grid.innerHTML = stats.map(stat => `
          <div class="stat-item">
            <span class="stat-label">${stat.label}</span>
            <span class="stat-value">${stat.value}</span>
          </div>
        `).join('');
      }
    }

    async function handleFileSelect(event) {
      const files = event.target.files;
      if (files.length === 0) return;

      for (const file of files) {
        addMessage('user', `Uploading: ${file.name}`);
        await uploadFileToAI(file);
      }
    }

    async function uploadFileToAI(file) {
      showTyping();

      const formData = new FormData();
      formData.append('file', file);
      formData.append('session_id', sessionId);

      try {
        const response = await fetch('/api/ai-chat/analyze-document', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        hideTyping();

        addMessage('ai', data.ai_response, data.quick_actions || []);

        if (data.extracted_data) {
          extractedData = { ...extractedData, ...data.extracted_data };
        }

        updateProgress(data.completion_percentage || 0);
        updateStats(data.extracted_summary || {});

      } catch (error) {
        hideTyping();
        addMessage('ai', 'I had trouble reading that document. Could you try uploading it again or tell me the information manually?');
      }
    }

    function uploadDocument() {
      document.getElementById('fileInput').click();
    }

    function addVoiceInput() {
      alert('Voice input feature coming soon!');
    }

    function handleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    // Auto-resize textarea
    document.getElementById('userInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Drag and drop
    const uploadZone = document.querySelector('.upload-zone');
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      document.getElementById('fileInput').files = files;
      handleFileSelect({ target: { files } });
    });

    // ===================================================================
    // LEAD CAPTURE & QUALIFICATION FUNCTIONS
    // ===================================================================

    async function captureName() {
      const nameInput = document.getElementById('nameInput');
      const name = nameInput ? nameInput.value.trim() : '';

      // Validate name - at least 2 characters, no special characters
      if (!name || name.length < 2) {
        showToast('Please enter your name (at least 2 characters)', 'error');
        if (nameInput) nameInput.focus();
        return;
      }

      // Sanitize - remove potentially dangerous characters
      const sanitizedName = name.replace(/[<>"'&]/g, '').substring(0, 100);

      extractedData.contact.name = sanitizedName;
      extractedData.lead_data.score += 15; // Higher score for engaged users
      addMessage('user', name);

      showTyping();
      setTimeout(() => {
        hideTyping();
        addMessage('ai', `Thank you, ${name}! It's a pleasure to work with you.<br><br>Now, to provide you with the most accurate tax analysis and connect you with the right CPA specialist, <strong>may I have your email address?</strong> (We'll send your comprehensive report here)`, [
          { label: 'üìß Enter email', value: 'enter_email' },
          { label: '‚è≠Ô∏è Skip for now', value: 'skip_email' }
        ]);
      }, 1000);
    }

    async function captureEmail() {
      const emailInput = document.getElementById('emailInput');
      const email = emailInput ? emailInput.value.trim().toLowerCase() : '';

      // Validate email with regex
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email || !emailRegex.test(email)) {
        showToast('Please enter a valid email address (e.g., name@example.com)', 'error');
        if (emailInput) emailInput.focus();
        return;
      }

      // Sanitize and limit length
      const sanitizedEmail = email.substring(0, 254);

      extractedData.contact.email = sanitizedEmail;
      extractedData.lead_data.score += 20; // Qualified lead!
      leadQualified = true;
      addMessage('user', email);

      showTyping();
      setTimeout(() => {
        hideTyping();
        const firstName = extractedData.contact.name ? extractedData.contact.name.split(' ')[0] : 'there';
        addMessage('ai', `Perfect, ${firstName}! I've saved your email.<br><br>üéâ <strong>You're now qualified for our premium tax advisory service!</strong><br><br>Let's analyze your tax situation and calculate your actual potential savings. This will take about 3-5 minutes.<br><br><strong>How would you like to provide your tax information?</strong>`, [
          { label: 'üìÑ Upload tax documents (fastest)', value: 'upload_docs_qualified' },
          { label: 'üí¨ Answer questions conversationally', value: 'conversational_qualified' },
          { label: 'üéØ Hybrid: docs + questions', value: 'hybrid_qualified' }
        ]);
      }, 1500);
    }

    async function proceedToDataGathering() {
      showTyping();
      setTimeout(() => {
        hideTyping();
        addMessage('ai', `No problem! Let's gather your tax information.<br><br><strong>How would you like to share your information with me?</strong>`, [
          { label: 'üìÑ Upload tax documents', value: 'upload_docs_qualified' },
          { label: 'üí¨ Answer questions', value: 'conversational_qualified' }
        ]);
      }, 1000);
    }

    // ===================================================================
    // INTELLIGENT DATA EXTRACTION WITH OPENAI
    // ===================================================================

    async function extractDataWithAI(userMessage) {
      try {
        const response = await fetch('/api/ai-chat/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: sessionId,
            user_message: userMessage,
            conversation_history: conversationHistory,
            extracted_data: extractedData,
            extraction_mode: true,
            system_context: buildSystemContext()
          })
        });

        if (response.ok) {
          const data = await response.json();

          // Merge extracted data
          if (data.extracted_data) {
            mergeExtractedData(data.extracted_data);
          }

          // Update lead score based on data completeness
          calculateLeadScore();

          return data;
        }
      } catch (error) {
        console.error('AI extraction error:', error);
      }
      return null;
    }

    function mergeExtractedData(newData) {
      // Intelligently merge new data into existing structure
      if (newData.filing_status) extractedData.tax_profile.filing_status = newData.filing_status;
      if (newData.income) extractedData.tax_profile.total_income = newData.income;
      if (newData.w2_income) extractedData.tax_profile.w2_income = newData.w2_income;
      if (newData.business_income) extractedData.tax_profile.business_income = newData.business_income;
      if (newData.dependents) extractedData.tax_profile.dependents = newData.dependents;
      if (newData.state) extractedData.tax_profile.state = newData.state;

      // Deductions
      if (newData.mortgage) extractedData.tax_items.mortgage_interest = newData.mortgage;
      if (newData.charitable) extractedData.tax_items.charitable = newData.charitable;

      console.log('Merged extracted data:', extractedData);
    }

    function calculateLeadScore() {
      let score = extractedData.lead_data.score;

      // Add points for completeness
      if (extractedData.contact.name) score += 10;
      if (extractedData.contact.email) score += 20;
      if (extractedData.contact.phone) score += 15;
      if (extractedData.tax_profile.filing_status) score += 10;
      if (extractedData.tax_profile.total_income) score += 15;
      if (extractedData.documents.length > 0) score += 20;

      // Complexity scoring (higher = better lead)
      if (extractedData.tax_profile.business_income && extractedData.tax_profile.business_income > 0) {
        score += 25;
        extractedData.lead_data.complexity = 'complex';
      }
      if (extractedData.tax_profile.rental_income && extractedData.tax_profile.rental_income > 0) {
        score += 20;
      }
      if (extractedData.tax_profile.total_income && extractedData.tax_profile.total_income > 100000) {
        score += 15;
      }

      extractedData.lead_data.score = Math.min(score, 100);
      extractedData.lead_data.ready_for_cpa = score >= 60;

      updateProgress(Math.min(score, 95)); // Cap at 95% until report generated

      // Update journey stepper based on current data
      advanceJourneyBasedOnData();
    }

    // ===================================================================
    // INTELLIGENT ADVISOR API INTEGRATION
    // ===================================================================

    // Store strategies from API
    let taxStrategies = [];
    let currentStrategyIndex = 0;

    // Step-by-step strategy exploration
    function showNextStrategy() {
      if (!taxStrategies || taxStrategies.length === 0) {
        addMessage('ai', 'No strategies available. Let me run the analysis first.');
        performTaxCalculation();
        return;
      }

      const strategy = taxStrategies[currentStrategyIndex];
      const isLast = currentStrategyIndex === taxStrategies.length - 1;
      const isFirst = currentStrategyIndex === 0;

      const priorityColors = {
        'high': '#276749',
        'medium': '#c69214',
        'low': '#4a5568'
      };
      const priorityColor = priorityColors[strategy.priority] || '#4a5568';

      addMessage('ai', `
        <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 13px; color: #718096;">Strategy ${currentStrategyIndex + 1} of ${taxStrategies.length}</span>
          <span style="background: ${priorityColor}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${strategy.priority} priority</span>
        </div>

        <div style="font-size: 18px; font-weight: 700; color: #1a365d; margin-bottom: 8px;">
          ${strategy.title}
        </div>

        <div class="insight-card" style="margin: 16px 0;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span style="color: #718096; font-size: 13px;">Estimated Annual Savings</span>
            <span style="font-size: 24px; font-weight: 800; color: #276749;">$${Math.round(strategy.estimated_savings).toLocaleString()}</span>
          </div>
        </div>

        <div style="font-size: 14px; color: #4a5568; line-height: 1.7; margin-bottom: 16px;">
          ${strategy.detailed_explanation || strategy.summary}
        </div>

        ${strategy.action_steps && strategy.action_steps.length > 0 ? `
          <div style="background: #ebf8ff; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
            <div style="font-weight: 600; color: #1a365d; margin-bottom: 10px;">Action Steps:</div>
            <ol style="margin: 0; padding-left: 20px; color: #4a5568; font-size: 14px; line-height: 1.8;">
              ${strategy.action_steps.map(step => `<li>${step}</li>`).join('')}
            </ol>
          </div>
        ` : ''}

        ${strategy.irs_reference ? `
          <div style="font-size: 12px; color: #718096; font-style: italic;">
            Reference: ${strategy.irs_reference}
          </div>
        ` : ''}
      `, getStrategyNavigationButtons(isFirst, isLast));
    }

    function getStrategyNavigationButtons(isFirst, isLast) {
      const buttons = [];

      if (!isFirst) {
        buttons.push({ label: '‚Üê Previous', value: 'previous_strategy' });
      }

      if (!isLast) {
        buttons.push({ label: 'Next Strategy ‚Üí', value: 'next_strategy', primary: true });
      } else {
        buttons.push({ label: 'View Summary', value: 'finish_strategies', primary: true });
      }

      return buttons;
    }

    function showStrategySummary() {
      const totalSavings = taxStrategies.reduce((sum, s) => sum + (s.estimated_savings || 0), 0);
      const highPriority = taxStrategies.filter(s => s.priority === 'high');

      let strategyList = taxStrategies.map((s, i) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${i % 2 === 0 ? '#f7fafc' : '#ffffff'}; border-bottom: 1px solid #e2e8f0;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="width: 24px; height: 24px; background: #1a365d; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${i + 1}</span>
            <span style="font-size: 14px; color: #1a202c;">${s.title}</span>
          </div>
          <span style="font-weight: 700; color: #276749;">$${Math.round(s.estimated_savings).toLocaleString()}</span>
        </div>
      `).join('');

      addMessage('ai', `
        <div style="margin-bottom: 20px;">
          <span style="font-size: 18px; font-weight: 700; color: #1a365d;">Your Tax Optimization Summary</span>
        </div>

        <div class="insight-card" style="margin-bottom: 20px;">
          <div style="text-align: center;">
            <div style="font-size: 13px; color: #718096; margin-bottom: 8px;">Total Potential Savings</div>
            <div style="font-size: 32px; font-weight: 800; color: #276749;">$${Math.round(totalSavings).toLocaleString()}</div>
            <div style="font-size: 13px; color: #4a5568; margin-top: 8px;">${taxStrategies.length} strategies ‚Ä¢ ${highPriority.length} high priority</div>
          </div>
        </div>

        <div style="background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
          <div style="background: #1a365d; color: white; padding: 12px 16px; font-weight: 600; font-size: 14px;">
            Strategy Breakdown
          </div>
          ${strategyList}
        </div>

        <div style="font-size: 14px; color: #4a5568; line-height: 1.6; margin-bottom: 16px;">
          I recommend starting with the high-priority strategies first. Would you like a comprehensive report you can share with a tax professional?
        </div>
      `, [
        { label: 'Generate Full Report', value: 'generate_report', primary: true },
        { label: 'Review strategies again', value: 'explore_strategies' },
        { label: 'Connect with CPA', value: 'request_cpa_early' }
      ]);

      // Update lead score and progress
      extractedData.lead_data.estimated_savings = totalSavings;
      calculateLeadScore();
      updateProgress(85);
    }

    async function getIntelligentAnalysis() {
      // Debug: Log current state
      console.log('getIntelligentAnalysis called with:', {
        filing_status: extractedData.tax_profile.filing_status,
        total_income: extractedData.tax_profile.total_income,
        dependents: extractedData.tax_profile.dependents
      });

      if (!extractedData.tax_profile.total_income || !extractedData.tax_profile.filing_status) {
        console.warn('Missing required data:', {
          has_income: !!extractedData.tax_profile.total_income,
          has_filing_status: !!extractedData.tax_profile.filing_status
        });
        return null;
      }

      // Map filing status to API format
      const statusMap = {
        'Single': 'single',
        'Married Filing Jointly': 'married_joint',
        'Head of Household': 'head_of_household',
        'Married Filing Separately': 'married_separate',
        'Qualifying Surviving Spouse': 'qualifying_widow'
      };

      // Validate the filing status mapping
      const apiFilingStatus = statusMap[extractedData.tax_profile.filing_status];
      if (!apiFilingStatus) {
        console.error('Invalid filing status:', extractedData.tax_profile.filing_status);
        // Try to recover by using the value directly if it looks like an API value
        const directValues = ['single', 'married_joint', 'married_separate', 'head_of_household', 'qualifying_widow'];
        if (!directValues.includes(extractedData.tax_profile.filing_status.toLowerCase())) {
          return null;
        }
      }

      // Clear any existing error banners
      clearErrorBanner();

      // Ensure we have a session ID
      if (!sessionId) {
        sessionId = 'advisor-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('tax_session_id', sessionId);
        console.log('Created new session ID:', sessionId);
      }

      try {
        // Build profile for API
        const profile = {
          filing_status: apiFilingStatus || statusMap[extractedData.tax_profile.filing_status] || 'single',
          total_income: extractedData.tax_profile.total_income,
          w2_income: extractedData.tax_profile.w2_income || extractedData.tax_profile.total_income,
          business_income: extractedData.tax_profile.business_income || 0,
          investment_income: extractedData.tax_profile.investment_income || 0,
          rental_income: extractedData.tax_profile.rental_income || 0,
          dependents: extractedData.tax_profile.dependents || 0,
          state: extractedData.tax_profile.state || '',
          mortgage_interest: extractedData.tax_items.mortgage_interest || 0,
          charitable_donations: extractedData.tax_items.charitable || 0,
          is_self_employed: extractedData.tax_profile.business_income > 0
        };

        console.log('Sending to API:', profile);

        const response = await fetchWithRetry('/api/advisor/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: sessionId,
            message: 'Analyze my tax situation',
            profile: profile
          })
        }, 3); // 3 retries with exponential backoff

        if (response.ok) {
          const data = await response.json();
          taxCalculations = data.tax_calculation;
          taxStrategies = data.strategies || [];
          extractedData.lead_data.estimated_savings = taxStrategies.reduce((sum, s) => sum + s.estimated_savings, 0);
          extractedData.lead_data.score = data.lead_score || extractedData.lead_data.score;

          // Update journey step
          advanceJourneyBasedOnData();

          return {
            calculation: data.tax_calculation,
            strategies: data.strategies,
            insights: data.key_insights,
            totalSavings: taxStrategies.reduce((sum, s) => sum + s.estimated_savings, 0),
            complexity: data.complexity
          };
        } else {
          // Handle non-OK response
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.detail || `Server error: ${response.status}`);
        }
      } catch (error) {
        console.error('Intelligent analysis error:', error);

        // Show error banner with retry option
        if (!navigator.onLine) {
          showErrorBanner(
            'Connection Lost',
            'Please check your internet connection and try again.',
            'performTaxCalculation()'
          );
        } else if (error.message.includes('429')) {
          showErrorBanner(
            'Service Busy',
            'Our servers are handling high traffic. Please wait a moment and try again.',
            'performTaxCalculation()'
          );
        } else {
          showErrorBanner(
            'Analysis Error',
            'We encountered an issue analyzing your data. Please try again.',
            'performTaxCalculation()'
          );
        }
      }
      return null;
    }

    async function calculateTaxLiability() {
      const analysis = await getIntelligentAnalysis();
      if (analysis) {
        return analysis.calculation;
      }
      return null;
    }

    // ===================================================================
    // INTELLIGENT QUESTIONING ENGINE - Comprehensive Tax Discovery
    // ===================================================================

    // Track conversation state to prevent loops
    let questioningState = {
      askedQuestions: new Set(),
      currentPhase: 'basics', // basics, income_details, deductions, goals, summary
      callCount: 0,
      maxCalls: 50 // Safety limit to prevent infinite loops
    };

    function markQuestionAsked(questionId) {
      questioningState.askedQuestions.add(questionId);
    }

    function wasQuestionAsked(questionId) {
      return questioningState.askedQuestions.has(questionId);
    }

    function resetQuestioningState() {
      questioningState.askedQuestions.clear();
      questioningState.callCount = 0;
      questioningState.currentPhase = 'basics';
    }

    async function startIntelligentQuestioning() {
      // Loop prevention - increment call counter
      questioningState.callCount++;

      // Safety check - if we've called this too many times, skip to summary
      if (questioningState.callCount > questioningState.maxCalls) {
        console.warn('startIntelligentQuestioning exceeded max calls, skipping to summary');
        await showPreliminarySummary();
        return;
      }

      showTyping();

      setTimeout(async () => {
        hideTyping();

        const profile = extractedData.tax_profile;
        const isHighEarner = (profile.total_income || 0) >= 200000;
        const isVeryHighEarner = (profile.total_income || 0) >= 500000;
        const isSelfEmployed = profile.is_self_employed || profile.income_source === 'Self-Employed / 1099';
        const isBusinessOwner = profile.income_source === 'Business Owner';
        const isInvestor = profile.income_source === 'Investments / Retirement';
        const hasMultipleSources = profile.income_source === 'Multiple sources';

        // =====================================================================
        // PHASE 1: BASIC INFORMATION
        // =====================================================================

        // Step 1: Filing Status
        if (!profile.filing_status) {
          markQuestionAsked('filing_status');
          addMessage('ai', `Let's start with the basics. What's your filing status for 2025?`, [
            { label: 'Single', value: 'filing_single' },
            { label: 'Married Filing Jointly', value: 'filing_married' },
            { label: 'Head of Household', value: 'filing_hoh' },
            { label: 'Married Filing Separately', value: 'filing_mfs' }
          ]);
          return;
        }

        // Step 2: State of Residence
        if (!profile.state) {
          markQuestionAsked('state');
          addMessage('ai', `Which state do you live in? This affects your state tax calculation.`, [
            { label: 'California', value: 'state_CA' },
            { label: 'New York', value: 'state_NY' },
            { label: 'Texas (no income tax)', value: 'state_TX' },
            { label: 'Florida (no income tax)', value: 'state_FL' },
            { label: 'Other state', value: 'state_other' }
          ]);
          return;
        }

        // Step 2b: Other State - ask which one
        if (profile.state === 'OTHER' && !profile.state_name && !wasQuestionAsked('state_name')) {
          markQuestionAsked('state_name');
          addMessage('ai', `Which state do you reside in?<br><br>
            <select id="stateSelect" style="width: 100%; padding: 12px; margin: 8px 0; border: 2px solid var(--border); border-radius: 8px; font-size: 15px; background: white;">
              <option value="">Select your state...</option>
              <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option>
              <option value="AR">Arkansas</option><option value="CO">Colorado</option><option value="CT">Connecticut</option>
              <option value="DE">Delaware</option><option value="DC">District of Columbia</option><option value="GA">Georgia</option>
              <option value="HI">Hawaii</option><option value="ID">Idaho</option><option value="IL">Illinois</option>
              <option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option>
              <option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option>
              <option value="MD">Maryland</option><option value="MA">Massachusetts</option><option value="MI">Michigan</option>
              <option value="MN">Minnesota</option><option value="MS">Mississippi</option><option value="MO">Missouri</option>
              <option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option>
              <option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option>
              <option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option>
              <option value="OK">Oklahoma</option><option value="OR">Oregon</option><option value="PA">Pennsylvania</option>
              <option value="RI">Rhode Island</option><option value="SC">South Carolina</option><option value="SD">South Dakota</option>
              <option value="TN">Tennessee</option><option value="UT">Utah</option><option value="VT">Vermont</option>
              <option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option>
              <option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
            </select>
            <button onclick="selectOtherState()" style="padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 8px;">Continue ‚Üí</button>`);
          return;
        }

        // Step 3: Income Range
        if (!profile.total_income) {
          markQuestionAsked('income');
          addMessage('ai', `What's your approximate total household income for 2025?`, [
            { label: '$0 - $50,000', value: 'income_0_50k' },
            { label: '$50,000 - $100,000', value: 'income_50_100k' },
            { label: '$100,000 - $200,000', value: 'income_100_200k' },
            { label: '$200,000 - $500,000', value: 'income_200_500k' },
            { label: 'Over $500,000', value: 'income_500k_plus' },
            { label: 'I\'ll type the exact amount', value: 'income_custom' }
          ]);
          return;
        }

        // Step 4: Primary Income Source
        if (!profile.income_source) {
          markQuestionAsked('income_source');
          addMessage('ai', `What's your primary source of income?`, [
            { label: 'W-2 Employee', value: 'source_w2' },
            { label: 'Self-Employed / 1099', value: 'source_self_employed' },
            { label: 'Business Owner', value: 'source_business' },
            { label: 'Investments / Retirement', value: 'source_investments' },
            { label: 'Multiple sources', value: 'source_multiple' }
          ]);
          return;
        }

        // W-4 Withholding Status (for W-2 employees)
        const isW2Employee = profile.income_source === 'W-2 Employee';
        if (isW2Employee && !profile.withholding_explored && !wasQuestionAsked('withholding')) {
          markQuestionAsked('withholding');
          addMessage('ai', `Do you adjust your W-4 withholding to manage your tax refund/payment?`, [
            { label: 'Yes, I adjust it strategically', value: 'withhold_strategic' },
            { label: 'No, I use the default settings', value: 'withhold_default' },
            { label: 'I usually get a large refund', value: 'withhold_large_refund' },
            { label: 'I usually owe taxes', value: 'withhold_owe' },
            { label: 'Not sure / Skip', value: 'withhold_skip' }
          ]);
          return;
        }

        // Prior Year Tax Situation
        if (!profile.prior_year_explored && !wasQuestionAsked('prior_year')) {
          markQuestionAsked('prior_year');
          addMessage('ai', `How did your tax situation last year compare to your expectations?`, [
            { label: 'Got a large refund (over $2,000)', value: 'prior_large_refund' },
            { label: 'Got a small refund (under $2,000)', value: 'prior_small_refund' },
            { label: 'Owed money to the IRS', value: 'prior_owed' },
            { label: 'About break-even', value: 'prior_breakeven' },
            { label: 'First time filing / Skip', value: 'prior_skip' }
          ]);
          return;
        }

        // Spouse Income (for Married Filing Jointly)
        const isMFJ = profile.filing_status === 'Married Filing Jointly';
        if (isMFJ && !profile.spouse_income_explored && !wasQuestionAsked('spouse_income')) {
          markQuestionAsked('spouse_income');
          addMessage('ai', `For joint filers, I need to understand your spouse's income situation. <strong>Does your spouse have income?</strong>`, [
            { label: 'Yes, W-2 employment', value: 'spouse_w2' },
            { label: 'Yes, self-employed', value: 'spouse_self_employed' },
            { label: 'Yes, both W-2 and self-employed', value: 'spouse_both' },
            { label: 'No, spouse doesn\'t work', value: 'spouse_none' },
            { label: 'Skip this question', value: 'spouse_skip' }
          ]);
          return;
        }

        // =====================================================================
        // PHASE 2: INCOME-SPECIFIC DEEP DIVE
        // =====================================================================

        // Business Owner / Self-Employed Follow-up
        if ((isSelfEmployed || isBusinessOwner) && !profile.business_explored && !wasQuestionAsked('business_type')) {
          markQuestionAsked('business_type');
          addMessage('ai', `Great! Understanding your business helps me find more deductions. What type of business do you operate?`, [
            { label: 'Professional Services (consulting, legal, medical)', value: 'biz_professional' },
            { label: 'Retail / E-commerce', value: 'biz_retail' },
            { label: 'Real Estate', value: 'biz_realestate' },
            { label: 'Tech / Software', value: 'biz_tech' },
            { label: 'Other Service Business', value: 'biz_service' }
          ]);
          return;
        }

        // Business Entity Type
        if ((isSelfEmployed || isBusinessOwner) && profile.business_type && !profile.entity_type && !wasQuestionAsked('entity_type')) {
          markQuestionAsked('entity_type');
          addMessage('ai', `What's your business structure? This significantly impacts your tax strategy.`, [
            { label: 'Sole Proprietorship', value: 'entity_sole' },
            { label: 'Single-Member LLC', value: 'entity_llc_single' },
            { label: 'Multi-Member LLC / Partnership', value: 'entity_llc_multi' },
            { label: 'S-Corporation', value: 'entity_scorp' },
            { label: 'C-Corporation', value: 'entity_ccorp' }
          ]);
          return;
        }

        // Business Revenue (for business owners)
        if ((isSelfEmployed || isBusinessOwner) && profile.entity_type && !profile.business_revenue && !wasQuestionAsked('business_revenue')) {
          markQuestionAsked('business_revenue');
          addMessage('ai', `What's your approximate annual business revenue?`, [
            { label: 'Under $50,000', value: 'revenue_under50k' },
            { label: '$50,000 - $100,000', value: 'revenue_50_100k' },
            { label: '$100,000 - $250,000', value: 'revenue_100_250k' },
            { label: '$250,000 - $500,000', value: 'revenue_250_500k' },
            { label: 'Over $500,000', value: 'revenue_over500k' }
          ]);
          return;
        }

        // Business Expense Categories (for self-employed)
        if ((isSelfEmployed || isBusinessOwner) && profile.business_revenue && !profile.business_expenses_explored && !wasQuestionAsked('business_expenses')) {
          markQuestionAsked('business_expenses');
          addMessage('ai', `What are your major business expense categories? (Select all that apply)`, [
            { label: 'üè† Home Office', value: 'bizexp_home_office' },
            { label: 'üöó Vehicle / Mileage', value: 'bizexp_vehicle' },
            { label: 'üíª Equipment & Software', value: 'bizexp_equipment' },
            { label: 'üì¢ Marketing & Advertising', value: 'bizexp_marketing' },
            { label: 'Continue without specifying', value: 'bizexp_skip' }
          ]);
          return;
        }

        // Mark business as explored after all business questions
        if ((isSelfEmployed || isBusinessOwner) && !profile.business_explored) {
          profile.business_explored = true;
        }

        // Multiple Income Sources Breakdown
        if (hasMultipleSources && !profile.income_sources_detailed && !wasQuestionAsked('multiple_sources')) {
          markQuestionAsked('multiple_sources');
          addMessage('ai', `You mentioned multiple income sources. Which of these apply? (Select your primary sources)`, [
            { label: 'W-2 Employment + Side Business', value: 'multi_w2_biz' },
            { label: 'W-2 Employment + Investments', value: 'multi_w2_invest' },
            { label: 'Self-Employment + Rental Income', value: 'multi_self_rental' },
            { label: 'Retirement Income + Part-time Work', value: 'multi_retire_work' },
            { label: 'Other combination', value: 'multi_other' }
          ]);
          return;
        }

        // Investment Income Follow-up for Investors or High Earners
        if ((isInvestor || isVeryHighEarner) && !profile.investment_explored && !wasQuestionAsked('investment_type')) {
          markQuestionAsked('investment_type');
          addMessage('ai', `${isVeryHighEarner ? 'At your income level, investment strategy is crucial. ' : ''}What types of investment income do you have?`, [
            { label: 'Stock dividends & capital gains', value: 'invest_stocks' },
            { label: 'Rental property income', value: 'invest_rental' },
            { label: 'Interest income (bonds, savings)', value: 'invest_interest' },
            { label: 'Partnership/K-1 income', value: 'invest_k1' },
            { label: 'Multiple types', value: 'invest_multiple' }
          ]);
          return;
        }

        // Rental Property Follow-up
        if (profile.has_rental_income && !profile.rental_explored && !wasQuestionAsked('rental_count')) {
          markQuestionAsked('rental_count');
          addMessage('ai', `How many rental properties do you own?`, [
            { label: '1 property', value: 'rental_1' },
            { label: '2-4 properties', value: 'rental_2_4' },
            { label: '5+ properties', value: 'rental_5plus' }
          ]);
          return;
        }

        // Capital Gains/Losses (for stock investors)
        if (profile.investment_type === 'stocks' || profile.investment_type === 'multiple') {
          if (!profile.capital_gains_explored && !wasQuestionAsked('capital_gains')) {
            markQuestionAsked('capital_gains');
            addMessage('ai', `<strong>Did you have any capital gains or losses from selling stocks this year?</strong>`, [
              { label: 'Yes, net gains (profit)', value: 'capgain_gains' },
              { label: 'Yes, net losses', value: 'capgain_losses' },
              { label: 'About break-even', value: 'capgain_even' },
              { label: 'Haven\'t sold anything', value: 'capgain_none' }
            ]);
            return;
          }
        }

        // Capital Gains Amount Follow-up
        if (profile.has_capital_gains && !profile.capital_gains_amount_explored && !wasQuestionAsked('capital_gains_amount')) {
          markQuestionAsked('capital_gains_amount');
          addMessage('ai', `<strong>Approximately how much in capital gains?</strong>`, [
            { label: 'Under $10,000', value: 'capgainamt_under10k' },
            { label: '$10,000 - $50,000', value: 'capgainamt_10_50k' },
            { label: '$50,000 - $100,000', value: 'capgainamt_50_100k' },
            { label: 'Over $100,000', value: 'capgainamt_over100k' }
          ]);
          return;
        }

        // Capital Losses Amount Follow-up
        if (profile.has_capital_losses && !profile.capital_losses_amount_explored && !wasQuestionAsked('capital_losses_amount')) {
          markQuestionAsked('capital_losses_amount');
          addMessage('ai', `Capital losses can offset gains and up to $3,000 of ordinary income! <strong>Approximately how much in losses?</strong>`, [
            { label: 'Under $3,000', value: 'caplossamt_under3k' },
            { label: '$3,000 - $10,000', value: 'caplossamt_3_10k' },
            { label: 'Over $10,000', value: 'caplossamt_over10k' }
          ]);
          return;
        }

        // =====================================================================
        // PHASE 3: DEPENDENTS & FAMILY
        // =====================================================================

        // Dependents
        if (profile.dependents == null) {
          markQuestionAsked('dependents');
          addMessage('ai', `Do you have any dependents (children under 17, elderly parents, etc.)?`, [
            { label: 'No dependents', value: 'dependents_0' },
            { label: '1 dependent', value: 'dependents_1' },
            { label: '2 dependents', value: 'dependents_2' },
            { label: '3 or more', value: 'dependents_3plus' }
          ]);
          return;
        }

        // Dependent Ages (if has children)
        if (profile.dependents > 0 && !profile.dependent_ages_explored && !wasQuestionAsked('dependent_ages')) {
          markQuestionAsked('dependent_ages');
          addMessage('ai', `What are the ages of your dependents? (Select the category that best fits)`, [
            { label: 'All under 6 years old', value: 'dep_age_under6' },
            { label: 'Children 6-17 years old', value: 'dep_age_6_17' },
            { label: 'College students (18-24)', value: 'dep_age_college' },
            { label: 'Adult dependents / elderly parents', value: 'dep_age_adult' },
            { label: 'Mix of ages', value: 'dep_age_mixed' }
          ]);
          return;
        }

        // Childcare Expenses (if young children)
        if (profile.dependents > 0 && profile.has_young_children && !profile.childcare_explored && !wasQuestionAsked('childcare')) {
          markQuestionAsked('childcare');
          addMessage('ai', `Do you pay for childcare or daycare expenses?`, [
            { label: 'Yes, over $5,000/year', value: 'childcare_high' },
            { label: 'Yes, under $5,000/year', value: 'childcare_low' },
            { label: 'No childcare expenses', value: 'childcare_none' }
          ]);
          return;
        }

        // =====================================================================
        // PHASE 4: DEDUCTIONS & TAX ITEMS
        // =====================================================================

        // Major Deductions
        if (!profile.deductions_explored) {
          markQuestionAsked('deductions');
          const deductionOptions = [
            { label: 'Own a home (mortgage interest)', value: 'deduction_mortgage' },
            { label: 'Make charitable donations', value: 'deduction_charity' },
            { label: 'Have high medical expenses', value: 'deduction_medical' },
            { label: 'Contribute to retirement (401k/IRA)', value: 'deduction_retirement' }
          ];

          // Add high-income specific option
          if (isHighEarner) {
            deductionOptions.push({ label: 'Have investment losses to harvest', value: 'deduction_investment_loss' });
          }

          deductionOptions.push({ label: 'None of these / Continue', value: 'deduction_none' });

          addMessage('ai', `Which of these tax situations apply to you?`, deductionOptions);
          return;
        }

        // Retirement Contribution Details (if they selected retirement)
        if (profile.has_retirement_contributions && !profile.retirement_detailed && !wasQuestionAsked('retirement_type')) {
          markQuestionAsked('retirement_type');
          addMessage('ai', `What retirement accounts do you contribute to?`, [
            { label: '401(k) through employer', value: 'retire_401k' },
            { label: 'Traditional IRA', value: 'retire_trad_ira' },
            { label: 'Roth IRA', value: 'retire_roth_ira' },
            { label: '401(k) and IRA', value: 'retire_both' },
            { label: 'SEP-IRA or Solo 401(k) (self-employed)', value: 'retire_sep' }
          ]);
          return;
        }

        // 401k Contribution Amount
        if (profile.has_401k && !profile.retirement_401k && !wasQuestionAsked('401k_amount')) {
          markQuestionAsked('401k_amount');
          addMessage('ai', `How much are you contributing to your 401(k) this year?`, [
            { label: 'Less than $10,000', value: '401k_under10k' },
            { label: '$10,000 - $15,000', value: '401k_10_15k' },
            { label: '$15,000 - $23,000', value: '401k_15_23k' },
            { label: 'Maxing out ($23,500)', value: '401k_max' },
            { label: 'Not sure', value: '401k_unsure' }
          ]);
          return;
        }

        // HSA Contributions (for those with high-deductible health plans)
        if (!profile.hsa_explored && !wasQuestionAsked('hsa_contributions')) {
          markQuestionAsked('hsa_contributions');
          addMessage('ai', `Do you have a Health Savings Account (HSA)?`, [
            { label: 'Yes, I contribute to an HSA', value: 'hsa_yes' },
            { label: 'No HSA', value: 'hsa_no' },
            { label: 'Not sure', value: 'hsa_unsure' }
          ]);
          return;
        }

        // HSA Amount Follow-up
        if (profile.has_hsa && !profile.hsa_amount_explored && !wasQuestionAsked('hsa_amount')) {
          markQuestionAsked('hsa_amount');
          addMessage('ai', `HSA contributions are tax-deductible! <strong>How much do you contribute annually?</strong>`, [
            { label: 'Under $2,000', value: 'hsaamt_under2k' },
            { label: '$2,000 - $4,000', value: 'hsaamt_2_4k' },
            { label: 'Maxing out ($4,150 single / $8,300 family)', value: 'hsaamt_max' },
            { label: 'Not sure', value: 'hsaamt_unsure' }
          ]);
          return;
        }

        // Student Loan Interest
        if (!profile.student_loan_explored && !wasQuestionAsked('student_loan')) {
          markQuestionAsked('student_loan');
          addMessage('ai', `Do you pay student loan interest?`, [
            { label: 'Yes, I pay student loan interest', value: 'studentloan_yes' },
            { label: 'No student loans', value: 'studentloan_no' }
          ]);
          return;
        }

        // Student Loan Amount Follow-up
        if (profile.has_student_loans && !profile.student_loan_amount_explored && !wasQuestionAsked('student_loan_amount')) {
          markQuestionAsked('student_loan_amount');
          addMessage('ai', `Student loan interest is deductible up to $2,500. <strong>How much interest do you pay annually?</strong>`, [
            { label: 'Under $1,000', value: 'studentloanamt_under1k' },
            { label: '$1,000 - $2,500', value: 'studentloanamt_1_2500' },
            { label: 'Over $2,500', value: 'studentloanamt_over2500' }
          ]);
          return;
        }

        // Energy Efficiency Credits (for homeowners or those planning major purchases)
        if ((profile.owns_home || profile.primary_goal === 'home') && !profile.energy_explored && !wasQuestionAsked('energy_credits')) {
          markQuestionAsked('energy_credits');
          addMessage('ai', `Have you made any energy-efficient improvements or purchases this year?`, [
            { label: '‚òÄÔ∏è Solar panels installed', value: 'energy_solar' },
            { label: 'üöó Electric vehicle purchased', value: 'energy_ev' },
            { label: 'üè† Heat pump / HVAC upgrade', value: 'energy_hvac' },
            { label: 'ü™ü Windows / insulation / doors', value: 'energy_home_improve' },
            { label: 'None of these', value: 'energy_none' }
          ]);
          return;
        }

        // =====================================================================
        // PHASE 5: TAX GOALS & LIFE EVENTS
        // =====================================================================

        // Tax Goals
        if (!profile.goals_explored) {
          markQuestionAsked('goals');
          addMessage('ai', `What's your primary tax goal this year?`, [
            { label: 'Reduce my current tax bill', value: 'goal_reduce_taxes' },
            { label: 'Maximize retirement savings', value: 'goal_retirement' },
            { label: 'Plan for a major life event', value: 'goal_life_event' },
            { label: 'Build long-term wealth tax-efficiently', value: 'goal_wealth' },
            { label: 'General tax optimization', value: 'goal_optimize' }
          ]);
          return;
        }

        // Life Event Details
        if (profile.primary_goal === 'life_event' && !profile.life_event_type && !wasQuestionAsked('life_event_type')) {
          markQuestionAsked('life_event_type');
          addMessage('ai', `What type of life event are you planning for?`, [
            { label: 'Getting married', value: 'event_marriage' },
            { label: 'Having a baby', value: 'event_baby' },
            { label: 'Buying a home', value: 'event_home' },
            { label: 'Starting a business', value: 'event_business' },
            { label: 'Retiring soon', value: 'event_retirement' },
            { label: 'Selling a home or major asset', value: 'event_sale' }
          ]);
          return;
        }

        // =====================================================================
        // PHASE 6: HIGH-INCOME SPECIFIC QUESTIONS
        // =====================================================================

        // High Earner Advanced Strategies
        if (isVeryHighEarner && !profile.advanced_explored && !wasQuestionAsked('advanced_strategies')) {
          markQuestionAsked('advanced_strategies');
          addMessage('ai', `At your income level, there are advanced strategies worth exploring. Do any of these interest you?`, [
            { label: 'Backdoor Roth IRA strategies', value: 'adv_backdoor' },
            { label: 'Charitable giving optimization (DAF)', value: 'adv_charitable' },
            { label: 'Deferred compensation plans', value: 'adv_deferred' },
            { label: 'Estate planning considerations', value: 'adv_estate' },
            { label: 'Just show me all tax-saving opportunities', value: 'adv_all' }
          ]);
          return;
        }

        // Cryptocurrency Holdings (for investors or tech workers)
        if ((isInvestor || profile.business_type === 'tech' || isHighEarner) &&
            !profile.crypto_explored && !wasQuestionAsked('crypto_holdings')) {
          markQuestionAsked('crypto_holdings');
          addMessage('ai', `Do you have any cryptocurrency holdings or transactions this year?`, [
            { label: 'Yes, I hold crypto but haven\'t sold', value: 'crypto_hold' },
            { label: 'Yes, I sold/traded crypto', value: 'crypto_sold' },
            { label: 'Yes, I earned crypto (mining/staking/rewards)', value: 'crypto_earned' },
            { label: 'No cryptocurrency', value: 'crypto_none' }
          ]);
          return;
        }

        // Stock Options (for employees at startups/tech)
        if (!profile.stock_options_explored && !wasQuestionAsked('stock_options')) {
          // Ask if they have W-2 income and haven't specified
          if (profile.income_source === 'W-2 Employee' || !profile.is_self_employed) {
            markQuestionAsked('stock_options');
            addMessage('ai', `Do you receive stock options or equity compensation from your employer?`, [
              { label: 'Yes, I have ISOs (Incentive Stock Options)', value: 'options_iso' },
              { label: 'Yes, I have NSOs (Non-Qualified Stock Options)', value: 'options_nso' },
              { label: 'Yes, I have RSUs (Restricted Stock Units)', value: 'options_rsu' },
              { label: 'Yes, I have ESPP (Employee Stock Purchase Plan)', value: 'options_espp' },
              { label: 'No equity compensation', value: 'options_none' }
            ]);
            return;
          }
        }

        // Estimated Tax Payments (for self-employed or investors)
        if ((profile.is_self_employed || isInvestor || profile.has_rental_income) &&
            !profile.estimated_explored && !wasQuestionAsked('estimated_payments')) {
          markQuestionAsked('estimated_payments');
          addMessage('ai', `Do you make quarterly estimated tax payments?`, [
            { label: 'Yes, I make regular estimated payments', value: 'estimated_yes' },
            { label: 'Sometimes, but not consistently', value: 'estimated_sometimes' },
            { label: 'No, I don\'t make estimated payments', value: 'estimated_no' },
            { label: 'Not sure if I should be', value: 'estimated_unsure' }
          ]);
          return;
        }

        // =====================================================================
        // COMPLETE - Show Summary
        // =====================================================================

        await showPreliminarySummary();

      }, 1000);
    }

    // Handler for selecting state from dropdown
    function selectOtherState() {
      const select = document.getElementById('stateSelect');
      const stateCode = select ? select.value : '';

      if (!stateCode) {
        showToast('Please select your state', 'warning');
        return;
      }

      const stateName = select.options[select.selectedIndex].text;
      addMessage('user', stateName);
      extractedData.tax_profile.state = stateCode;
      extractedData.tax_profile.state_name = stateName;
      calculateLeadScore();
      startIntelligentQuestioning();
    }

    // Show summary of collected information before running analysis
    async function showPreliminarySummary() {
      const profile = extractedData.tax_profile;
      const items = extractedData.tax_items;

      const filingLabel = {
        'Single': 'Single',
        'Married Filing Jointly': 'Married Filing Jointly',
        'Head of Household': 'Head of Household',
        'Married Filing Separately': 'Married Filing Separately',
        'Qualifying Surviving Spouse': 'Qualifying Surviving Spouse'
      }[profile.filing_status] || profile.filing_status;

      // Build state display
      const stateDisplay = profile.state_name || profile.state || 'Not specified';

      // Build income complexity indicator
      const isHighEarner = (profile.total_income || 0) >= 200000;
      const isVeryHighEarner = (profile.total_income || 0) >= 500000;
      const complexityIndicator = extractedData.lead_data.complexity === 'complex' ? 'üî∑ Complex' :
                                   extractedData.lead_data.complexity === 'moderate' ? 'üî∂ Moderate' : 'üü¢ Standard';

      // Build additional details section
      let additionalDetails = '';

      // Business details
      if (profile.is_self_employed || profile.income_source === 'Business Owner') {
        const entityLabels = {
          'sole': 'Sole Proprietorship', 'llc_single': 'Single-Member LLC',
          'llc_multi': 'Partnership/Multi-Member LLC', 'scorp': 'S-Corporation', 'ccorp': 'C-Corporation'
        };
        const bizTypeLabels = {
          'professional': 'Professional Services', 'retail': 'Retail/E-commerce',
          'realestate': 'Real Estate', 'tech': 'Tech/Software', 'service': 'Service Business'
        };

        additionalDetails += `
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
            <div style="font-weight: 600; color: #1a365d; margin-bottom: 10px;">Business Details</div>
            ${profile.business_type ? `<div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
              <span style="color: #4a5568;">Business Type:</span>
              <strong>${bizTypeLabels[profile.business_type] || profile.business_type}</strong>
            </div>` : ''}
            ${profile.entity_type ? `<div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
              <span style="color: #4a5568;">Entity Structure:</span>
              <strong>${entityLabels[profile.entity_type] || profile.entity_type}</strong>
            </div>` : ''}
            ${profile.business_revenue ? `<div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
              <span style="color: #4a5568;">Business Revenue:</span>
              <strong>$${profile.business_revenue.toLocaleString()}</strong>
            </div>` : ''}
          </div>
        `;
      }

      // Investment details
      if (profile.has_investment_income || profile.has_rental_income) {
        const investLabels = {
          'stocks': 'Stocks & Dividends', 'rental': 'Rental Property',
          'interest': 'Interest Income', 'k1': 'Partnership/K-1', 'multiple': 'Multiple Types'
        };

        additionalDetails += `
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
            <div style="font-weight: 600; color: #1a365d; margin-bottom: 10px;">Investment Profile</div>
            ${profile.investment_type ? `<div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
              <span style="color: #4a5568;">Investment Type:</span>
              <strong>${investLabels[profile.investment_type] || profile.investment_type}</strong>
            </div>` : ''}
            ${profile.rental_property_count ? `<div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
              <span style="color: #4a5568;">Rental Properties:</span>
              <strong>${profile.rental_property_count === '5plus' ? '5+' : profile.rental_property_count === '2_4' ? '2-4' : '1'}</strong>
            </div>` : ''}
          </div>
        `;
      }

      // Tax items collected
      const taxItemsList = [];
      if (items.mortgage_interest) taxItemsList.push(`Mortgage Interest: $${items.mortgage_interest.toLocaleString()}`);
      if (items.charitable) taxItemsList.push(`Charitable Donations: $${items.charitable.toLocaleString()}`);
      if (items.medical) taxItemsList.push(`Medical Expenses: $${items.medical.toLocaleString()}`);
      if (profile.retirement_401k) taxItemsList.push(`401(k) Contributions: $${profile.retirement_401k.toLocaleString()}`);
      if (items.childcare) taxItemsList.push(`Childcare Expenses: $${items.childcare.toLocaleString()}`);

      if (taxItemsList.length > 0) {
        additionalDetails += `
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
            <div style="font-weight: 600; color: #1a365d; margin-bottom: 10px;">Deductions & Credits</div>
            ${taxItemsList.map(item => `<div style="color: #4a5568; font-size: 13px; margin-bottom: 4px;">‚Ä¢ ${item}</div>`).join('')}
          </div>
        `;
      }

      // Life event
      if (profile.life_event_type) {
        const eventLabels = {
          'marriage': 'Getting married', 'baby': 'Having a baby', 'home': 'Buying a home',
          'business': 'Starting a business', 'retirement': 'Retiring soon', 'sale': 'Selling major asset'
        };
        additionalDetails += `
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #4a5568;">Life Event:</span>
              <strong>${eventLabels[profile.life_event_type] || profile.life_event_type}</strong>
            </div>
          </div>
        `;
      }

      addMessage('ai', `
        <div style="margin-bottom: 16px;">
          <strong style="font-size: 18px; color: #1a365d;">Your Tax Profile Summary</strong>
          <div style="margin-top: 8px; display: inline-block; background: #ebf8ff; color: #2b6cb0; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
            ${complexityIndicator} Tax Situation
          </div>
        </div>

        <div style="background: #f7fafc; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <div style="display: grid; gap: 10px;">
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #4a5568;">Filing Status:</span>
              <strong>${filingLabel}</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #4a5568;">State:</span>
              <strong>${stateDisplay}</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #4a5568;">Total Income:</span>
              <strong style="${isVeryHighEarner ? 'color: #276749;' : ''}">$${(profile.total_income || 0).toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #4a5568;">Income Source:</span>
              <strong>${profile.income_source || 'Not specified'}</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span style="color: #4a5568;">Dependents:</span>
              <strong>${profile.dependents || 0}${profile.has_young_children ? ' (includes young children)' : profile.has_college_students ? ' (includes college students)' : ''}</strong>
            </div>
            ${profile.primary_goal ? `<div style="display: flex; justify-content: space-between;">
              <span style="color: #4a5568;">Primary Goal:</span>
              <strong>${profile.primary_goal === 'reduce_taxes' ? 'Reduce Tax Bill' :
                        profile.primary_goal === 'retirement' ? 'Maximize Retirement' :
                        profile.primary_goal === 'wealth' ? 'Build Wealth' :
                        profile.primary_goal === 'life_event' ? 'Life Event Planning' : 'Tax Optimization'}</strong>
            </div>` : ''}
          </div>

          ${additionalDetails}
        </div>

        <div style="font-size: 14px; color: #4a5568; line-height: 1.6;">
          ${isVeryHighEarner ? '<strong>High-income analysis:</strong> I\'ll identify advanced strategies including Backdoor Roth, tax-loss harvesting, and deferred compensation options.<br><br>' : ''}
          ${profile.is_self_employed ? '<strong>Business owner analysis:</strong> I\'ll evaluate entity structure optimization, QBI deduction, and self-employment tax strategies.<br><br>' : ''}
          Ready to run your personalized tax analysis and identify savings opportunities.
        </div>
      `, [
        { label: 'Run Full Analysis ‚Üí', value: 'run_full_analysis', primary: true },
        { label: 'Edit my information', value: 'edit_profile' }
      ]);
    }

    async function performTaxCalculation() {
      // Show loading overlay for better UX
      showLoadingOverlay('Analyzing Your Tax Situation', 'Running 30+ optimization strategies...');

      const analysis = await getIntelligentAnalysis();

      // Hide loading overlay
      hideLoadingOverlay();

      // Clear any previous error banners
      clearErrorBanner();

      if (analysis && analysis.calculation) {
        const calc = analysis.calculation;
        const strategies = analysis.strategies || [];
        const totalSavings = analysis.totalSavings || 0;

        // Store for later use
        taxCalculations = calc;
        taxStrategies = strategies;

        // Phase 1: Show initial tax breakdown
        addMessage('ai', `
          <div style="margin-bottom: 20px;">
            <span style="font-size: 18px; font-weight: 700; color: #1a365d;">Tax Analysis Complete</span>
          </div>

          <div style="background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
            <div style="font-size: 13px; color: #4a5568; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px;">Your 2025 Tax Summary</div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div>
                <div style="font-size: 12px; color: #718096;">Federal Tax</div>
                <div style="font-size: 22px; font-weight: 700; color: #1a365d;">$${Math.round(calc.federal_tax).toLocaleString()}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: #718096;">State Tax</div>
                <div style="font-size: 22px; font-weight: 700; color: #1a365d;">$${Math.round(calc.state_tax).toLocaleString()}</div>
              </div>
            </div>

            <div style="border-top: 1px solid #e2e8f0; padding-top: 16px; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-size: 12px; color: #718096;">Total Tax Liability</div>
                <div style="font-size: 26px; font-weight: 800; color: #1a365d;">$${Math.round(calc.total_tax).toLocaleString()}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 12px; color: #718096;">Effective Rate</div>
                <div style="font-size: 20px; font-weight: 700; color: #2c5282;">${calc.effective_rate}%</div>
              </div>
            </div>
          </div>

          <div style="font-size: 14px; color: #4a5568; line-height: 1.6;">
            Based on your profile, I've identified <strong>${strategies.length} tax optimization strategies</strong> that could potentially save you <strong style="color: #276749;">$${Math.round(totalSavings).toLocaleString()}</strong>.
          </div>

          <div style="margin-top: 16px; font-size: 14px; color: #4a5568;">
            Would you like me to walk you through each strategy in detail?
          </div>
        `, [
          { label: 'Yes, show me the strategies', value: 'explore_strategies', primary: true },
          { label: 'Skip to summary', value: 'quick_summary' }
        ]);

        // Update lead score and progress
        extractedData.lead_data.estimated_savings = totalSavings;
        calculateLeadScore();
        updateProgress(75);

        if (extractedData.lead_data.score >= 60) {
          sendLeadToCPA();
        }
      } else {
        // Debug: Show what data we have
        console.error('Analysis failed. Current data:', {
          filing_status: extractedData.tax_profile.filing_status,
          total_income: extractedData.tax_profile.total_income,
          dependents: extractedData.tax_profile.dependents
        });

        // Provide helpful error message based on what's missing
        let missingFields = [];
        if (!extractedData.tax_profile.filing_status) missingFields.push('filing status');
        if (!extractedData.tax_profile.total_income) missingFields.push('income');

        if (missingFields.length > 0) {
          addMessage('ai', `I need your ${missingFields.join(' and ')} to complete the analysis. Could you provide that information?`, [
            { label: 'Single', value: 'filing_single' },
            { label: 'Married Filing Jointly', value: 'filing_married' },
            { label: '$50K - $100K', value: 'income_50_100k' },
            { label: '$100K - $200K', value: 'income_100_200k' }
          ]);
        } else {
          // We have the data but API failed - show error and retry option
          addMessage('ai', `I encountered an issue analyzing your data. Let me try again.`, [
            { label: 'Retry Analysis', value: 'retry_analysis', primary: true },
            { label: 'Start Over', value: 'reset_conversation' }
          ]);
        }
        document.getElementById('userInput').focus();
      }
    }

    // Show all strategies in detail
    function showAllStrategies() {
      if (!taxStrategies || taxStrategies.length === 0) {
        addMessage('ai', `I haven't analyzed your strategies yet. Let me calculate your tax situation first.`);
        performTaxCalculation();
        return;
      }

      let strategyHTML = `
        <div style="margin-bottom: 20px;">
          <span style="font-size: 20px; font-weight: 700; color: var(--accent-light);">Your Personalized Tax Strategies</span>
          <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">
            ${taxStrategies.length} strategies ‚Ä¢ Total potential savings: $${taxStrategies.reduce((sum, s) => sum + s.estimated_savings, 0).toLocaleString()}
          </div>
        </div>
      `;

      taxStrategies.forEach((strategy, index) => {
        const priorityColors = {
          'high': '#10b981',
          'medium': '#f59e0b',
          'low': '#64748b'
        };
        const priorityColor = priorityColors[strategy.priority] || '#64748b';

        strategyHTML += `
          <div class="insight-card" style="margin: 16px 0; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
              <div>
                <span style="background: ${priorityColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; margin-right: 8px;">${strategy.priority}</span>
                <span style="background: var(--surface-light); color: var(--text-secondary); padding: 2px 8px; border-radius: 4px; font-size: 11px;">${strategy.category}</span>
              </div>
              <div class="savings-amount" style="font-size: 20px;">$${Math.round(strategy.estimated_savings).toLocaleString()}</div>
            </div>
            <div style="font-size: 16px; font-weight: 600; color: var(--accent-light); margin-bottom: 8px;">${strategy.title}</div>
            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">${strategy.summary}</div>
            <details style="cursor: pointer;">
              <summary style="color: var(--accent-light); font-weight: 500;">View Details & Action Steps</summary>
              <div style="padding: 12px 0; font-size: 13px; color: var(--text-secondary); white-space: pre-line;">${strategy.detailed_explanation}</div>
              <div style="margin-top: 12px;">
                <strong style="font-size: 13px;">Action Steps:</strong>
                <ul style="margin: 8px 0 0 20px; font-size: 13px; color: var(--text-secondary);">
                  ${strategy.action_steps.map(step => `<li style="margin: 4px 0;">${step}</li>`).join('')}
                </ul>
              </div>
              ${strategy.irs_reference ? `<div style="margin-top: 12px; font-size: 12px; color: var(--text-muted);">üìö Reference: ${strategy.irs_reference}</div>` : ''}
            </details>
          </div>
        `;
      });

      strategyHTML += `<div style="margin-top: 20px;"><strong>Ready to implement these strategies?</strong></div>`;

      addMessage('ai', strategyHTML, [
        { label: 'Generate My Report ‚Üí', value: 'generate_report', primary: true },
        { label: 'Connect with CPA', value: 'request_cpa_early' },
        { label: 'Ask a Question', value: 'ask_question' }
      ]);

      updateProgress(85);
    }

    // ===================================================================
    // CPA LEAD HANDOFF
    // ===================================================================

    async function sendLeadToCPA() {
      if (!extractedData.lead_data.ready_for_cpa) {
        return false;
      }

      try {
        const response = await fetch('/api/leads/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contact: extractedData.contact,
            tax_profile: extractedData.tax_profile,
            tax_items: extractedData.tax_items,
            lead_score: extractedData.lead_data.score,
            complexity: extractedData.lead_data.complexity,
            estimated_savings: extractedData.lead_data.estimated_savings,
            session_id: sessionId,
            source: 'intelligent_advisor',
            status: 'qualified'
          })
        });

        return response.ok;
      } catch (error) {
        console.error('Lead handoff error:', error);
        return false;
      }
    }

    async function captureIncome() {
      const incomeInput = document.getElementById('incomeInput');
      const rawValue = incomeInput ? incomeInput.value.replace(/[^0-9]/g, '') : '0';
      const income = parseInt(rawValue, 10);

      // Validate income - must be positive and reasonable (max $50M for individuals)
      if (!income || income <= 0) {
        showToast('Please enter a valid income amount', 'error');
        if (incomeInput) incomeInput.focus();
        return;
      }

      if (income > 50000000) {
        showToast('Please verify this amount - it seems unusually high', 'warning');
      }

      extractedData.tax_profile.total_income = income;
      extractedData.tax_profile.w2_income = income;
      extractedData.lead_data.score += 15;
      addMessage('user', `$${income.toLocaleString()}`);
      updateStats({ total_income: income });
      calculateLeadScore();

      startIntelligentQuestioning();
    }

    // Helper to continue deduction flow or move to credits
    function askNextDeductionOrCredits() {
      const deductions = extractedData.deductions || [];

      // If user has selected deductions, offer to continue or move to credits
      if (deductions.length > 0) {
        addMessage('ai', `Any other deductions?`, [
          { label: 'Mortgage', value: 'has_mortgage' },
          { label: 'Charity', value: 'has_charity' },
          { label: 'Medical', value: 'has_medical' },
          { label: 'Done, continue ‚Üí', value: 'deductions_done' }
        ]);
      } else {
        // Move to credits
        addMessage('ai', `Any tax credits you might qualify for?`, [
          { label: 'Child Tax Credit', value: 'credit_child' },
          { label: 'Education Credit', value: 'credit_education' },
          { label: 'Skip to report ‚Üí', value: 'generate_report' }
        ]);
      }
    }

    async function analyzeDeductions() {
      showTyping();
      setTimeout(() => {
        hideTyping();
        addMessage('ai', `Which deductions apply to you?`, [
          { label: 'Mortgage', value: 'has_mortgage' },
          { label: 'Charity', value: 'has_charity' },
          { label: 'Medical', value: 'has_medical' },
          { label: 'Business', value: 'has_business' },
          { label: 'Retirement', value: 'has_retirement' },
          { label: 'None / Skip ‚Üí', value: 'deductions_done' }
        ]);
      }, 800);
    }

    async function requestCPAConnection() {
      showTyping();
      await sendLeadToCPA();

      setTimeout(() => {
        hideTyping();
        const savings = Math.round(extractedData.lead_data.estimated_savings || 0).toLocaleString();

        addMessage('ai', `I've notified our CPA team about your <strong>$${savings}</strong> savings opportunity. They'll reach out within 24 hours.<br><br>What would you like to do next?`, [
          { label: 'Schedule a call', value: 'schedule_time' },
          { label: 'Just email me', value: 'email_only' },
          { label: 'Get my report first', value: 'generate_report' }
        ]);
      }, 1500);
    }

    // Make functions globally accessible
    window.handleQuickAction = handleQuickAction;
    window.sendReportEmail = sendReportEmail;
    window.sendMessage = sendMessage;
    window.captureName = captureName;
    window.captureEmail = captureEmail;
    window.captureIncome = captureIncome;

    // Initialize on load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('Page loaded, initializing...');
      const messagesContainer = document.getElementById('messages');
      console.log('Messages container found:', messagesContainer);

      // Check initial connection status
      updateConnectionStatus(navigator.onLine);

      // Start health check monitoring
      startHealthCheck();

      // Attach event listeners to initial quick action buttons
      const initialButtons = document.querySelectorAll('#initialQuickActions button[data-action]');
      console.log('Found initial buttons:', initialButtons.length);

      initialButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          const action = this.getAttribute('data-action');
          console.log('Initial button clicked:', action);
          console.log('Button element:', this);

          // Disable button temporarily to prevent double clicks
          this.disabled = true;
          setTimeout(() => {
            this.disabled = false;
          }, 2000);

          handleQuickAction(action);
        });
      });

      // Also add click handlers to any buttons added later via event delegation
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('quick-action') && e.target.dataset.action) {
          e.preventDefault();
          const action = e.target.dataset.action;
          console.log('Delegated button clicked:', action);
          handleQuickAction(action);
        }
      });

      // Setup consent modal handlers
      setupConsentHandlers();

      // Check consent before initializing session
      if (checkConsent()) {
        initializeSession();
      }

      setTimeout(() => {
        const input = document.getElementById('userInput');
        if (input) input.focus();
      }, 100);
    });

    // =================================================================
    // REAL-TIME FORM VALIDATION UTILITIES
    // =================================================================

    const ValidationUtils = {
      // SSN validation (XXX-XX-XXXX)
      validateSSN: function(ssn) {
        const clean = ssn.replace(/[^0-9]/g, '');
        if (clean.length !== 9) {
          return { valid: false, message: 'SSN must be 9 digits' };
        }
        if (clean === '000000000' || clean.startsWith('000') || clean.startsWith('666') || clean.startsWith('9')) {
          return { valid: false, message: 'Invalid SSN format' };
        }
        return { valid: true, formatted: `${clean.slice(0,3)}-${clean.slice(3,5)}-${clean.slice(5)}` };
      },

      // EIN validation (XX-XXXXXXX)
      validateEIN: function(ein) {
        const clean = ein.replace(/[^0-9]/g, '');
        if (clean.length !== 9) {
          return { valid: false, message: 'EIN must be 9 digits' };
        }
        return { valid: true, formatted: `${clean.slice(0,2)}-${clean.slice(2)}` };
      },

      // Currency validation
      validateCurrency: function(value, fieldName = 'Amount', options = {}) {
        const clean = value.replace(/[$,\s]/g, '');
        const num = parseFloat(clean);

        if (isNaN(num)) {
          return { valid: false, message: `${fieldName} must be a valid number` };
        }
        if (!options.allowNegative && num < 0) {
          return { valid: false, message: `${fieldName} cannot be negative` };
        }
        if (options.max && num > options.max) {
          return { valid: false, message: `${fieldName} cannot exceed $${options.max.toLocaleString()}` };
        }
        if (options.min && num < options.min) {
          return { valid: false, message: `${fieldName} must be at least $${options.min.toLocaleString()}` };
        }
        return { valid: true, value: num, formatted: `$${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` };
      },

      // Date validation
      validateDate: function(dateStr, fieldName = 'Date') {
        const formats = [
          /^\d{4}-\d{2}-\d{2}$/,  // YYYY-MM-DD
          /^\d{2}\/\d{2}\/\d{4}$/, // MM/DD/YYYY
        ];

        if (!formats.some(f => f.test(dateStr))) {
          return { valid: false, message: `${fieldName} format should be MM/DD/YYYY or YYYY-MM-DD` };
        }

        const date = new Date(dateStr);
        if (isNaN(date.getTime())) {
          return { valid: false, message: `${fieldName} is not a valid date` };
        }
        return { valid: true, date: date };
      },

      // Apply validation state to input element
      applyValidationState: function(input, result) {
        // Remove existing states
        input.classList.remove('field-valid', 'field-error', 'field-warning');

        // Find or create validation message element
        let msgEl = input.parentElement.querySelector('.validation-message');
        if (!msgEl) {
          msgEl = document.createElement('div');
          msgEl.className = 'validation-message';
          input.parentElement.appendChild(msgEl);
        }

        if (result.valid) {
          input.classList.add('field-valid');
          msgEl.className = 'validation-message success';
          msgEl.textContent = result.message || '‚úì Valid';
        } else {
          input.classList.add('field-error');
          msgEl.className = 'validation-message error';
          msgEl.textContent = result.message;
        }

        // Auto-hide success message after 2 seconds
        if (result.valid) {
          setTimeout(() => {
            msgEl.style.display = 'none';
          }, 2000);
        }
      },

      // Debounce function for real-time validation
      debounce: function(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
    };

    // Progress indicator utility
    const ProgressIndicator = {
      container: null,
      bar: null,
      text: null,

      create: function(parentEl) {
        this.container = document.createElement('div');
        this.container.className = 'progress-container';
        this.container.innerHTML = `
          <div class="progress-bar" style="width: 0%"></div>
        `;
        this.text = document.createElement('div');
        this.text.className = 'progress-text';

        parentEl.appendChild(this.container);
        parentEl.appendChild(this.text);

        this.bar = this.container.querySelector('.progress-bar');
        return this;
      },

      update: function(percent, message) {
        if (this.bar) {
          this.bar.style.width = `${Math.min(100, Math.max(0, percent))}%`;
        }
        if (this.text && message) {
          this.text.textContent = message;
        }
      },

      remove: function() {
        if (this.container) this.container.remove();
        if (this.text) this.text.remove();
      }
    };

    // Loading skeleton utility
    const SkeletonLoader = {
      show: function(container, count = 3) {
        const skeletons = [];
        for (let i = 0; i < count; i++) {
          const skeleton = document.createElement('div');
          skeleton.className = 'skeleton skeleton-message';
          skeleton.style.width = `${50 + Math.random() * 30}%`;
          skeleton.style.marginLeft = i % 2 === 0 ? '0' : 'auto';
          container.appendChild(skeleton);
          skeletons.push(skeleton);
        }
        return skeletons;
      },

      hide: function(skeletons) {
        skeletons.forEach(s => s.remove());
      }
    };

    // Mobile keyboard handling
    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
      const input = document.getElementById('userInput');
      if (input) {
        input.addEventListener('focus', function() {
          // Scroll to input when focused on mobile
          setTimeout(() => {
            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      }
    }
  </script>
</body>
</html>
