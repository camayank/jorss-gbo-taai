<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Premium Tax Advisory | Individual Tax Strategy</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary: #6366f1;
      --primary-light: #818cf8;
      --primary-dark: #4f46e5;
      --accent: #10b981;
      --bg: #0f172a;
      --surface: #1e293b;
      --surface-light: #334155;
      --text: #f1f5f9;
      --text-secondary: #94a3b8;
      --border: #334155;
      --gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
    }

    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* Animated Background */
    .bg-animated {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      opacity: 0.03;
      background:
        radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(236, 72, 153, 0.3) 0%, transparent 50%);
      animation: pulse 15s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.03; }
      50% { opacity: 0.06; }
    }

    /* Header */
    .header {
      position: relative;
      z-index: 10;
      padding: 16px 32px;
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 20px;
      font-weight: 700;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .status-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 20px;
      font-size: 13px;
      color: var(--accent);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse-dot 2s ease-in-out infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    /* Main Container */
    .main {
      position: relative;
      z-index: 1;
      flex: 1;
      display: flex;
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      padding: 24px;
      gap: 24px;
    }

    /* Chat Panel */
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(40px) saturate(180%);
      border: 1px solid var(--border);
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .messages {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Custom Scrollbar */
    .messages::-webkit-scrollbar {
      width: 8px;
    }

    .messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages::-webkit-scrollbar-thumb {
      background: var(--surface-light);
      border-radius: 4px;
    }

    .messages::-webkit-scrollbar-thumb:hover {
      background: var(--border);
    }

    /* Message Styles */
    .message {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      animation: fadeInUp 0.4s ease;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
      background: var(--gradient);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .message.user .avatar {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid var(--primary);
    }

    .bubble {
      max-width: 70%;
      padding: 20px 24px;
      border-radius: 20px;
      font-size: 15px;
      line-height: 1.7;
    }

    .message.ai .bubble {
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.3);
    }

    .message.user .bubble {
      background: var(--gradient);
      color: white;
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    .quick-action {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      padding: 10px 18px;
      border-radius: 12px;
      font-size: 14px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      z-index: 10;
      user-select: none;
    }

    .quick-action:hover {
      background: rgba(99, 102, 241, 0.2);
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .quick-action:active {
      transform: translateY(0);
      background: rgba(99, 102, 241, 0.3);
    }

    .quick-action:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    /* Insight Cards */
    .insight-card {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 16px;
      padding: 20px;
      margin-top: 16px;
    }

    .insight-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      font-weight: 600;
      color: var(--accent);
    }

    /* Input Area */
    .input-area {
      padding: 24px 32px;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .input-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-box {
      display: flex;
      gap: 12px;
      background: var(--surface);
      padding: 14px 20px;
      border-radius: 20px;
      border: 2px solid transparent;
      transition: all 0.3s;
    }

    .input-box:focus-within {
      background: var(--surface-light);
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    #userInput {
      flex: 1;
      border: none;
      background: none;
      font-size: 15px;
      color: var(--text);
      outline: none;
      resize: none;
      min-height: 24px;
      max-height: 120px;
      font-family: inherit;
    }

    #userInput::placeholder {
      color: var(--text-secondary);
    }

    .action-btns {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      background: rgba(255, 255, 255, 0.05);
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 20px;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      background: rgba(99, 102, 241, 0.2);
      color: var(--primary-light);
    }

    .send-btn {
      background: var(--gradient);
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 16px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .send-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(99, 102, 241, 0.5);
    }

    .send-btn:active {
      transform: translateY(0);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Side Panel */
    .side-panel {
      width: 360px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .panel-card {
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(40px) saturate(180%);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .panel-header {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .progress-bar {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: var(--gradient);
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stats-grid {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      font-size: 14px;
    }

    .stat-label {
      color: var(--text-secondary);
    }

    .stat-value {
      color: var(--text);
      font-weight: 600;
    }

    /* Typing Indicator */
    .typing-indicator {
      display: flex;
      gap: 6px;
      padding: 16px 20px;
    }

    .typing-indicator span {
      width: 10px;
      height: 10px;
      background: var(--primary-light);
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
      }
      30% {
        transform: translateY(-12px);
        opacity: 1;
      }
    }

    /* Document Upload Zone */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: rgba(255, 255, 255, 0.02);
    }

    .upload-zone:hover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
    }

    .upload-zone.dragover {
      border-color: var(--accent);
      background: rgba(16, 185, 129, 0.1);
    }

    /* AI Disclaimer Banner */
    .ai-disclaimer-banner {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 13px;
    }

    .disclaimer-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .disclaimer-item:last-child {
      margin-bottom: 0;
    }

    .disclaimer-icon {
      flex-shrink: 0;
    }

    /* Confidence Indicator Styles */
    .confidence-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 6px;
      margin: 12px 0;
    }

    .confidence-high {
      background: rgba(16, 185, 129, 0.1);
      border-left: 3px solid #10b981;
    }

    .confidence-medium {
      background: rgba(245, 158, 11, 0.1);
      border-left: 3px solid #f59e0b;
    }

    .confidence-low {
      background: rgba(239, 68, 68, 0.1);
      border-left: 3px solid #ef4444;
    }

    /* Screen Reader Only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Focus Visible for Accessibility */
    .quick-action:focus-visible,
    button:focus-visible,
    textarea:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Reduced Motion Support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .main {
        flex-direction: column;
      }

      .side-panel {
        width: 100%;
      }

      .ai-disclaimer-banner {
        font-size: 12px;
        padding: 10px 12px;
      }
    }

    @media (max-width: 480px) {
      .ai-disclaimer-banner {
        border-radius: 8px;
        margin-bottom: 12px;
      }

      .disclaimer-item {
        font-size: 11px;
      }
    }

    /* Header Right Section */
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .clear-chat-btn {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .clear-chat-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      color: var(--text);
    }

    /* Connection Status */
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 20px;
      font-size: 13px;
      color: var(--accent);
      transition: all 0.3s;
    }

    .connection-status.offline {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .connection-status.offline .status-dot {
      background: #ef4444;
      animation: none;
    }

    /* Consent Modal */
    .consent-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .consent-modal.hidden {
      display: none;
    }

    .consent-content {
      background: var(--surface);
      border-radius: 16px;
      max-width: 560px;
      width: 100%;
      padding: 32px;
      border: 1px solid var(--border);
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.4);
    }

    .consent-content h2 {
      font-size: 24px;
      margin-bottom: 20px;
      color: var(--text);
    }

    .consent-body {
      margin-bottom: 24px;
    }

    .consent-body p {
      color: var(--text-secondary);
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .consent-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: rgba(99, 102, 241, 0.08);
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .consent-item.warning {
      background: rgba(245, 158, 11, 0.1);
      border-left: 3px solid #f59e0b;
    }

    .consent-icon {
      font-size: 18px;
      flex-shrink: 0;
    }

    .consent-checkbox {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: var(--surface-light);
      border-radius: 8px;
      margin-top: 20px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .consent-checkbox input {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      cursor: pointer;
      accent-color: var(--primary);
    }

    .consent-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .consent-link {
      color: var(--primary);
      text-decoration: none;
      font-size: 14px;
    }

    .consent-link:hover {
      text-decoration: underline;
    }

    .consent-btn {
      padding: 14px 32px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .consent-btn:disabled {
      background: var(--surface-light);
      color: var(--text-secondary);
      cursor: not-allowed;
    }

    .consent-btn:not(:disabled):hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    /* Message Timestamp */
    .message-time {
      font-size: 11px;
      color: var(--text-secondary);
      opacity: 0.6;
      margin-top: 8px;
      display: block;
    }

    .message.user .message-time {
      text-align: right;
    }

    /* Copy Button */
    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 4px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .bubble {
      position: relative;
    }

    .bubble:hover .copy-btn {
      opacity: 1;
    }

    .copy-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Improved Typing Indicator Accessibility */
    .typing-indicator[aria-label] {
      position: relative;
    }

    @media (max-width: 768px) {
      .header-right {
        gap: 8px;
      }

      .clear-chat-btn {
        padding: 6px 12px;
        font-size: 12px;
      }

      .connection-status {
        padding: 6px 12px;
        font-size: 12px;
      }

      .consent-content {
        padding: 20px;
      }

      .consent-content h2 {
        font-size: 20px;
      }
    }

    /* =================================================================
       COMPREHENSIVE MOBILE RESPONSIVE STYLES
       Addresses audit findings for mobile UX improvements
       ================================================================= */

    /* Small tablets and large phones (768px and below) */
    @media (max-width: 768px) {
      .header {
        padding: 12px 16px;
      }

      .logo {
        font-size: 16px;
      }

      .input-area {
        padding: 16px;
        gap: 8px;
      }

      .input-box {
        padding: 12px 16px;
        border-radius: 16px;
      }

      #userInput {
        font-size: 16px; /* Prevents iOS zoom on focus */
        min-height: 20px;
      }

      .message {
        max-width: 90%;
        padding: 14px 16px;
        font-size: 14px;
      }

      .action-btns button {
        min-width: 44px; /* Touch target minimum */
        min-height: 44px;
        padding: 10px;
      }

      .side-panel {
        padding: 16px;
      }
    }

    /* Mobile phones (480px and below) */
    @media (max-width: 480px) {
      .header {
        padding: 10px 12px;
        flex-wrap: wrap;
        gap: 8px;
      }

      .logo {
        font-size: 14px;
        flex: 1;
      }

      .header-right {
        width: 100%;
        justify-content: space-between;
      }

      .clear-chat-btn {
        padding: 8px 12px;
        font-size: 11px;
      }

      .connection-status {
        padding: 6px 10px;
        font-size: 11px;
      }

      .input-area {
        padding: 12px;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 100;
        background: rgba(15, 23, 42, 0.98);
      }

      .input-box {
        padding: 10px 14px;
        border-radius: 12px;
      }

      #userInput {
        font-size: 16px;
        min-height: 18px;
      }

      .message {
        max-width: 95%;
        padding: 12px 14px;
        font-size: 14px;
        border-radius: 16px;
      }

      .message.user {
        border-radius: 16px 16px 4px 16px;
      }

      .message.assistant {
        border-radius: 16px 16px 16px 4px;
      }

      /* Add bottom padding to messages for fixed input */
      .messages-area {
        padding-bottom: 100px;
      }

      .consent-modal {
        align-items: flex-end;
      }

      .consent-content {
        padding: 16px;
        border-radius: 20px 20px 0 0;
        max-height: 85vh;
        overflow-y: auto;
      }

      .consent-content h2 {
        font-size: 18px;
      }

      .consent-item {
        font-size: 13px;
        padding: 10px;
      }

      .consent-checkbox span {
        font-size: 12px;
      }

      .consent-btn {
        padding: 14px 24px;
        font-size: 15px;
        width: 100%;
      }
    }

    /* Extra small phones (320px - iPhone SE, etc.) */
    @media (max-width: 375px) {
      .header {
        padding: 8px 10px;
      }

      .logo {
        font-size: 13px;
      }

      .input-area {
        padding: 10px;
      }

      .input-box {
        padding: 8px 12px;
      }

      .message {
        font-size: 13px;
        padding: 10px 12px;
      }

      .action-btns {
        flex-direction: column;
        gap: 4px;
      }

      .action-btns button {
        width: 100%;
      }
    }

    /* Keyboard open on mobile - reduce input area height */
    @media (max-height: 500px) and (max-width: 768px) {
      .input-area {
        padding: 8px 12px;
      }

      .input-box {
        padding: 8px 12px;
      }

      .messages-area {
        padding-bottom: 80px;
      }
    }

    /* Touch-friendly buttons and interactions */
    @media (hover: none) and (pointer: coarse) {
      .action-btns button,
      .clear-chat-btn,
      .consent-btn {
        min-height: 44px;
        min-width: 44px;
      }

      /* Remove hover effects on touch devices */
      .message:hover,
      .input-box:hover {
        transform: none;
      }

      /* Add active states for touch feedback */
      .action-btns button:active,
      .clear-chat-btn:active,
      .consent-btn:active {
        transform: scale(0.98);
        opacity: 0.9;
      }
    }

    /* Safe area insets for notched phones */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .input-area {
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
      }
    }

    /* =================================================================
       FORM VALIDATION FEEDBACK STYLES
       Real-time validation visual indicators
       ================================================================= */
    .field-valid {
      border-color: #10b981 !important;
      background: rgba(16, 185, 129, 0.05) !important;
    }

    .field-valid::after {
      content: '‚úì';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #10b981;
      font-size: 16px;
    }

    .field-error {
      border-color: #ef4444 !important;
      background: rgba(239, 68, 68, 0.05) !important;
    }

    .field-warning {
      border-color: #f59e0b !important;
      background: rgba(245, 158, 11, 0.05) !important;
    }

    .validation-message {
      font-size: 12px;
      margin-top: 4px;
      padding: 4px 8px;
      border-radius: 4px;
      display: none;
    }

    .validation-message.error {
      display: block;
      color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }

    .validation-message.warning {
      display: block;
      color: #f59e0b;
      background: rgba(245, 158, 11, 0.1);
    }

    .validation-message.success {
      display: block;
      color: #10b981;
      background: rgba(16, 185, 129, 0.1);
    }

    /* Loading/Skeleton states */
    .skeleton {
      background: linear-gradient(90deg, var(--surface) 25%, var(--surface-light) 50%, var(--surface) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-message {
      height: 60px;
      margin: 8px 0;
      max-width: 70%;
    }

    /* Progress indicator */
    .progress-container {
      width: 100%;
      height: 4px;
      background: var(--surface);
      border-radius: 2px;
      overflow: hidden;
      margin: 8px 0;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 12px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 4px;
    }

    /* Skip to content link for keyboard navigation */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--primary);
      color: white;
      padding: 8px 16px;
      z-index: 1000;
      text-decoration: none;
      border-radius: 0 0 4px 0;
    }

    .skip-link:focus {
      top: 0;
    }

    /* Focus visible styles for accessibility */
    *:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Reduced motion preference */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
  <!-- Loading States Manager for accessible loading indicators -->
  <script src="/static/js/loading-states.js" defer></script>
</head>
<body>
  <!-- Skip link for keyboard navigation -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <div class="bg-animated" aria-hidden="true"></div>

  <header class="header" role="banner">
    <div class="logo">‚ú® Premium Tax Advisory</div>
    <div class="header-right">
      <button class="clear-chat-btn" onclick="clearConversation()" title="Start new conversation" aria-label="Start new conversation">
        üîÑ New Chat
      </button>
      <div class="connection-status" id="connectionStatus" role="status" aria-live="polite">
        <span class="status-dot" id="connectionDot"></span>
        <span id="connectionText">Connected</span>
      </div>
    </div>
  </header>

  <!-- Data Collection Consent Modal -->
  <div class="consent-modal" id="consentModal" role="dialog" aria-modal="true" aria-labelledby="consentTitle">
    <div class="consent-content">
      <h2 id="consentTitle">üìã Before We Begin</h2>
      <div class="consent-body">
        <p><strong>This AI assistant will collect personal tax information to provide guidance.</strong></p>

        <div class="consent-item">
          <span class="consent-icon">üîí</span>
          <span><strong>Data Security:</strong> All information is encrypted (AES-256) in transit and at rest.</span>
        </div>

        <div class="consent-item">
          <span class="consent-icon">‚è∞</span>
          <span><strong>Data Retention:</strong> Your session data is automatically deleted after 30 days of inactivity.</span>
        </div>

        <div class="consent-item">
          <span class="consent-icon">üö´</span>
          <span><strong>No Selling:</strong> We never sell or share your personal information with third parties.</span>
        </div>

        <div class="consent-item warning">
          <span class="consent-icon">‚ö†Ô∏è</span>
          <span><strong>IRS Circular 230 Notice:</strong> This AI provides general guidance only, NOT professional tax advice. It cannot represent you before the IRS. For complex tax situations, always consult a licensed CPA, EA, or tax attorney.</span>
        </div>

        <label class="consent-checkbox">
          <input type="checkbox" id="dataConsent" required>
          <span>I understand and consent to the collection of my tax information for advisory purposes. I acknowledge this is NOT professional tax advice.</span>
        </label>
      </div>

      <div class="consent-actions">
        <a href="/privacy" target="_blank" class="consent-link">Privacy Policy</a>
        <a href="/terms" target="_blank" class="consent-link">Terms of Service</a>
        <button class="consent-btn" id="acceptConsentBtn" onclick="acceptConsent()" disabled>
          ‚úì Accept & Continue
        </button>
      </div>
    </div>
  </div>

  <main class="main" id="main-content" role="main">
    <div class="chat-panel">
      <!-- Privacy & AI Disclaimer Notice -->
      <div class="ai-disclaimer-banner" role="alert" aria-label="Important notices about AI assistance and privacy">
        <div class="disclaimer-item">
          <span class="disclaimer-icon">ü§ñ</span>
          <span><strong>AI Assistant:</strong> I provide estimates and general guidance, not professional tax advice. Always verify with a licensed CPA or tax professional.</span>
        </div>
        <div class="disclaimer-item">
          <span class="disclaimer-icon">üîí</span>
          <span><strong>Privacy:</strong> Your data is encrypted and never sold. <a href="/privacy" style="color: var(--primary);">Privacy Policy</a></span>
        </div>
      </div>

      <div class="messages" id="messages" role="log" aria-live="polite" aria-label="Conversation with AI tax advisor">
        <!-- Static initial message for immediate display -->
        <div class="message ai" role="article" aria-label="AI assistant message">
          <div class="avatar" aria-hidden="true">ü§ñ</div>
          <div class="bubble">
            <strong>Welcome! I'm your AI-powered tax advisory specialist.</strong><br><br>
            I help individuals like you identify tax-saving opportunities and connect you with our CPA team for personalized guidance. On average, our clients discover <strong>$3,000-$15,000 in overlooked deductions</strong> and tax-saving strategies.<br><br>
            <div class="insight-card" style="margin: 16px 0;">
              <strong>üéØ What I'll do for you:</strong><br>
              ‚Ä¢ Analyze your complete tax situation (5 minutes)<br>
              ‚Ä¢ Calculate your actual tax liability for 2025<br>
              ‚Ä¢ Identify every deduction & credit you qualify for<br>
              ‚Ä¢ Estimate your potential tax savings<br>
              ‚Ä¢ Generate a comprehensive advisory report<br>
              ‚Ä¢ Connect you with a CPA for personalized strategy
            </div>
            <div class="confidence-indicator" style="background: rgba(59, 130, 246, 0.1); padding: 8px 12px; border-radius: 6px; font-size: 12px; color: var(--text-secondary); margin: 12px 0;">
              ‚ÑπÔ∏è <em>This is general guidance. Accuracy improves as you provide more information.</em>
            </div>
            <strong>Before we dive in, may I have your name?</strong> (This helps me personalize your report)
            <div class="quick-actions" id="initialQuickActions" style="margin-top: 16px;" role="group" aria-label="Quick response options">
              <button class="quick-action" data-action="enter_name" aria-label="Enter my name to personalize the report">‚úçÔ∏è Enter my name</button>
              <button class="quick-action" data-action="skip_name" aria-label="Skip entering name for now">‚è≠Ô∏è Skip for now</button>
            </div>
          </div>
        </div>
      </div>

      <div class="input-area" role="form" aria-label="Send a message to AI advisor">
        <div class="input-wrapper">
          <label for="userInput" class="sr-only">Type your message or question about taxes</label>
          <div class="input-box">
            <textarea
              id="userInput"
              placeholder="Share your questions or financial situation with me..."
              rows="1"
              onkeydown="handleKeyDown(event)"
              aria-label="Type your message or question about taxes"
              aria-describedby="inputHint"
            ></textarea>
            <span id="inputHint" class="sr-only">Press Enter to send, Shift+Enter for new line</span>
            <div class="action-btns">
              <button class="icon-btn" onclick="uploadDocument()" title="Upload Document" aria-label="Upload a tax document">
                <span aria-hidden="true">üìé</span>
              </button>
              <button class="icon-btn" onclick="addVoiceInput()" title="Voice Input" aria-label="Use voice input">
                <span aria-hidden="true">üé§</span>
              </button>
            </div>
          </div>
        </div>
        <button class="send-btn" onclick="sendMessage()" id="sendBtn">
          Send
        </button>
      </div>
    </div>

    <div class="side-panel">
      <div class="panel-card">
        <div class="panel-header">üìä Advisory Progress</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div style="text-align: center; font-size: 13px; color: var(--text-secondary);">
          <span id="progressText">Not started</span>
        </div>
        <div class="stats-grid" id="statsGrid">
          <!-- Stats will be populated dynamically -->
        </div>
      </div>

      <div class="panel-card">
        <div class="panel-header">üí° Strategic Recommendations</div>
        <div id="insights" style="font-size: 14px; color: var(--text-secondary);">
          I'll share personalized recommendations as we review your financial situation...
        </div>
      </div>

      <div class="panel-card" id="uploadPanel">
        <div class="panel-header">üìÅ Quick Upload</div>
        <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
          <div style="font-size: 32px; margin-bottom: 8px;">üìÑ</div>
          <div style="font-size: 14px; margin-bottom: 4px;">Drop documents here</div>
          <div style="font-size: 12px; color: var(--text-secondary);">or click to browse</div>
        </div>
        <input type="file" id="fileInput" style="display: none" onchange="handleFileSelect(event)" accept=".pdf,.jpg,.jpeg,.png" multiple aria-label="Upload tax documents">
      </div>
    </div>
  </main>

  <script>
    let sessionId = null;
    let conversationHistory = [];
    let extractedData = {
      // Lead Information (for CPA handoff)
      contact: {
        name: null,
        email: null,
        phone: null,
        preferred_contact: null
      },

      // Tax Profile
      tax_profile: {
        filing_status: null,
        total_income: null,
        w2_income: null,
        business_income: null,
        investment_income: null,
        rental_income: null,
        dependents: null,
        state: null
      },

      // Deductions & Credits
      tax_items: {
        mortgage_interest: null,
        property_tax: null,
        charitable: null,
        medical: null,
        student_loan_interest: null,
        retirement_contributions: null,
        has_hsa: false,
        has_529: false
      },

      // Business Details (if applicable)
      business: {
        type: null,
        revenue: null,
        expenses: null,
        entity_type: null
      },

      // Lead Scoring
      lead_data: {
        score: 0,
        complexity: 'simple', // simple, moderate, complex
        estimated_savings: 0,
        engagement_level: 0,
        ready_for_cpa: false,
        urgency: 'normal' // normal, high, urgent
      },

      // Documents uploaded
      documents: []
    };
    let isProcessing = false;
    let taxCalculations = null;
    let leadQualified = false;

    // Toast notification function for user feedback
    function showToast(message, type = 'info') {
      // Remove any existing toast
      const existingToast = document.querySelector('.toast-notification');
      if (existingToast) existingToast.remove();

      const toast = document.createElement('div');
      toast.className = 'toast-notification toast-' + type;
      toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        animation: slideUp 0.3s ease;
        max-width: 90%;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      `;

      // Style based on type
      if (type === 'error') {
        toast.style.background = '#ef4444';
      } else if (type === 'warning') {
        toast.style.background = '#f59e0b';
      } else if (type === 'success') {
        toast.style.background = '#10b981';
      } else {
        toast.style.background = '#3b82f6';
      }

      toast.textContent = message;
      document.body.appendChild(toast);

      // Auto-remove after 4 seconds
      setTimeout(() => {
        toast.style.animation = 'slideDown 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // ============ CONSENT MODAL ============
    function checkConsent() {
      const hasConsent = sessionStorage.getItem('tax_data_consent');
      const consentModal = document.getElementById('consentModal');

      if (hasConsent === 'true') {
        consentModal.classList.add('hidden');
        return true;
      }

      // Show consent modal
      consentModal.classList.remove('hidden');
      document.getElementById('dataConsent').focus();
      return false;
    }

    function acceptConsent() {
      const checkbox = document.getElementById('dataConsent');
      if (!checkbox.checked) {
        showToast('Please check the consent box to continue', 'warning');
        return;
      }

      sessionStorage.setItem('tax_data_consent', 'true');
      sessionStorage.setItem('tax_consent_timestamp', new Date().toISOString());
      document.getElementById('consentModal').classList.add('hidden');

      // Initialize session after consent
      initializeSession();
      showToast('Welcome! Your data will be handled securely.', 'success');
    }

    // Enable/disable accept button based on checkbox
    document.addEventListener('DOMContentLoaded', function() {
      const checkbox = document.getElementById('dataConsent');
      const acceptBtn = document.getElementById('acceptConsentBtn');

      if (checkbox && acceptBtn) {
        checkbox.addEventListener('change', function() {
          acceptBtn.disabled = !this.checked;
        });
      }
    });

    // ============ CONNECTION STATUS ============
    function updateConnectionStatus(online) {
      const statusEl = document.getElementById('connectionStatus');
      const textEl = document.getElementById('connectionText');
      const dotEl = document.getElementById('connectionDot');

      if (online) {
        statusEl.classList.remove('offline');
        textEl.textContent = 'Connected';
        dotEl.style.background = 'var(--accent)';
      } else {
        statusEl.classList.add('offline');
        textEl.textContent = 'Offline';
        dotEl.style.background = '#ef4444';
        showToast('You appear to be offline. Messages will be sent when connection is restored.', 'warning');
      }
    }

    // Monitor connection status
    window.addEventListener('online', () => {
      updateConnectionStatus(true);
      showToast('Connection restored!', 'success');
    });

    window.addEventListener('offline', () => {
      updateConnectionStatus(false);
    });

    // Periodic health check
    let healthCheckInterval = null;
    function startHealthCheck() {
      healthCheckInterval = setInterval(async () => {
        try {
          const response = await fetch('/api/health', {
            method: 'GET',
            cache: 'no-store',
            signal: AbortSignal.timeout(5000)
          });
          if (response.ok) {
            updateConnectionStatus(true);
          } else {
            updateConnectionStatus(false);
          }
        } catch (e) {
          // Don't mark as offline for network errors if we're still online per browser
          if (!navigator.onLine) {
            updateConnectionStatus(false);
          }
        }
      }, 30000); // Every 30 seconds
    }

    // ============ CLEAR CONVERSATION ============
    function clearConversation() {
      if (!confirm('Start a new conversation? This will clear your current session.')) {
        return;
      }

      // Clear session storage
      sessionStorage.removeItem('tax_session_id');
      sessionStorage.removeItem('tax_data_consent');
      sessionStorage.removeItem('tax_consent_timestamp');

      // Reload page to reset everything
      window.location.reload();
    }

    // Initialize session
    async function initializeSession() {
      console.log('initializeSession called');

      // Static greeting is already in HTML, just create session
      try {
        console.log('Creating session...');
        const response = await fetch('/api/sessions/create-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            workflow_type: 'intelligent_conversational',
            tax_year: 2025
          })
        });

        const data = await response.json();
        sessionId = data.session_id;
        sessionStorage.setItem('tax_session_id', sessionId);
        console.log('Session initialized:', sessionId);
      } catch (error) {
        console.error('Session initialization error:', error);
        // Continue without session - will be created on first message
      }
    }

    async function sendInitialGreeting() {
      console.log('sendInitialGreeting called');

      // Enhanced greeting with value proposition
      addMessage('ai', `<strong>Welcome! I'm your AI-powered tax advisory specialist.</strong><br><br>I help individuals like you identify tax-saving opportunities and connect you with our CPA team for personalized guidance. On average, our clients discover <strong>$3,000-$15,000 in overlooked deductions</strong> and tax-saving strategies.<br><br><div class="insight-card" style="margin: 16px 0;"><strong>üéØ What I'll do for you:</strong><br>‚Ä¢ Analyze your complete tax situation (5 minutes)<br>‚Ä¢ Calculate your actual tax liability for 2025<br>‚Ä¢ Identify every deduction & credit you qualify for<br>‚Ä¢ Estimate your potential tax savings<br>‚Ä¢ Generate a comprehensive advisory report<br>‚Ä¢ Connect you with a CPA for personalized strategy<br></div><strong>Before we dive in, may I have your name?</strong> (This helps me personalize your report)`, [
        { label: '‚úçÔ∏è Enter my name', value: 'enter_name' },
        { label: '‚è≠Ô∏è Skip for now', value: 'skip_name' }
      ]);
      console.log('Initial greeting added');
    }

    // Calculate confidence level based on data completeness
    function getConfidenceLevel() {
      let score = 0;
      let maxScore = 100;

      if (extractedData.filing_status) score += 15;
      if (extractedData.income_range || extractedData.tax_profile?.total_income) score += 20;
      if (extractedData.deductions && extractedData.deductions.length > 0) score += 15;
      if (extractedData.credits && extractedData.credits.length > 0) score += 15;
      if (extractedData.contact?.name) score += 5;
      if (extractedData.documents && extractedData.documents.length > 0) score += 20;
      if (extractedData.focus_area) score += 10;

      const percentage = Math.round((score / maxScore) * 100);

      if (percentage >= 70) return { level: 'high', percentage, label: 'High confidence' };
      if (percentage >= 40) return { level: 'medium', percentage, label: 'Moderate confidence' };
      return { level: 'low', percentage, label: 'Limited data' };
    }

    // Generate confidence disclaimer for AI messages
    function getConfidenceDisclaimer(includeIRS = false) {
      const confidence = getConfidenceLevel();
      let disclaimer = '';

      if (confidence.level === 'high') {
        disclaimer = `<div class="confidence-indicator confidence-high">
          <span>‚úÖ ${confidence.label} (${confidence.percentage}% data)</span>
          <span style="margin-left: auto; font-size: 11px;">Verify with a tax professional before filing</span>
        </div>`;
      } else if (confidence.level === 'medium') {
        disclaimer = `<div class="confidence-indicator confidence-medium">
          <span>‚ö†Ô∏è ${confidence.label} (${confidence.percentage}% data)</span>
          <span style="margin-left: auto; font-size: 11px;">Provide more details for better accuracy</span>
        </div>`;
      } else {
        disclaimer = `<div class="confidence-indicator confidence-low">
          <span>‚ÑπÔ∏è ${confidence.label} (${confidence.percentage}% data)</span>
          <span style="margin-left: auto; font-size: 11px;">General guidance only - more info needed</span>
        </div>`;
      }

      if (includeIRS) {
        disclaimer += `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
          üìã Based on 2025 IRS guidelines. See <a href="https://www.irs.gov/forms-instructions" target="_blank" rel="noopener" style="color: var(--primary);">IRS.gov</a> for official forms.
        </div>`;
      }

      return disclaimer;
    }

    function addMessage(type, text, quickActions = [], options = {}) {
      console.log('====== addMessage CALLED ======');
      console.log('Type:', type);
      console.log('Text preview:', text.substring(0, 50));
      console.log('Quick actions count:', quickActions.length);

      const messages = document.getElementById('messages');
      console.log('Messages container found:', !!messages);

      if (!messages) {
        console.error('Messages container not found!');
        showToast('Error displaying message', 'error');
        return;
      }

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.setAttribute('role', 'article');
      messageDiv.setAttribute('aria-label', type === 'ai' ? 'AI assistant message' : 'Your message');

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.setAttribute('aria-hidden', 'true');
      avatar.textContent = type === 'ai' ? 'ü§ñ' : 'üë§';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';

      // Add confidence indicator for AI messages (unless explicitly disabled)
      if (type === 'ai' && options.showConfidence !== false) {
        const includeIRS = options.includeIRS || false;
        text += getConfidenceDisclaimer(includeIRS);
      }

      bubble.innerHTML = text;

      // Add copy button for AI messages
      if (type === 'ai') {
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.textContent = 'üìã Copy';
        copyBtn.setAttribute('aria-label', 'Copy this message');
        copyBtn.onclick = (e) => {
          e.stopPropagation();
          const textContent = bubble.innerText.replace('üìã Copy', '').trim();
          navigator.clipboard.writeText(textContent).then(() => {
            copyBtn.textContent = '‚úì Copied';
            setTimeout(() => copyBtn.textContent = 'üìã Copy', 2000);
          });
        };
        bubble.appendChild(copyBtn);
      }

      // Add timestamp
      const timestamp = document.createElement('span');
      timestamp.className = 'message-time';
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      timestamp.textContent = timeStr;
      timestamp.setAttribute('aria-label', `Sent at ${timeStr}`);
      bubble.appendChild(timestamp);

      if (quickActions.length > 0) {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'quick-actions';
        actionsDiv.setAttribute('role', 'group');
        actionsDiv.setAttribute('aria-label', 'Quick response options');

        quickActions.forEach((action, index) => {
          const btn = document.createElement('button');
          btn.className = 'quick-action';
          btn.textContent = action.label;
          btn.setAttribute('aria-label', action.label.replace(/[^\w\s]/g, '').trim());
          btn.onclick = () => handleQuickAction(action.value);
          actionsDiv.appendChild(btn);
        });
        bubble.appendChild(actionsDiv);
      }

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(bubble);
      messages.appendChild(messageDiv);

      console.log('Message added successfully. Total messages now:', messages.children.length);

      messages.scrollTop = messages.scrollHeight;
      return messageDiv;
    }

    function showTyping() {
      const messages = document.getElementById('messages');
      const typing = document.createElement('div');
      typing.className = 'message ai';
      typing.id = 'typing-indicator';
      typing.setAttribute('role', 'status');
      typing.setAttribute('aria-live', 'polite');
      typing.setAttribute('aria-label', 'AI assistant is typing a response');
      typing.innerHTML = `
        <div class="avatar" aria-hidden="true">ü§ñ</div>
        <div class="bubble">
          <div class="typing-indicator" role="img" aria-label="Typing">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <span class="sr-only">Please wait, the assistant is preparing a response...</span>
        </div>
      `;
      messages.appendChild(typing);
      messages.scrollTop = messages.scrollHeight;
    }

    function hideTyping() {
      const typing = document.getElementById('typing-indicator');
      if (typing) typing.remove();
    }

    async function sendMessage() {
      const input = document.getElementById('userInput');
      const text = input.value.trim();

      if (!text || isProcessing) return;

      addMessage('user', text);
      input.value = '';
      input.style.height = 'auto';

      await processAIResponse(text);
    }

    async function handleQuickAction(value) {
      console.log('====== handleQuickAction CALLED ======');
      console.log('Quick action clicked:', value);
      console.log('Current extracted data:', extractedData);
      console.log('Messages container exists:', !!document.getElementById('messages'));

      // Lead capture - Name entry
      if (value === 'enter_name') {
        addMessage('user', 'I\'ll enter my name');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Perfect! Please enter your full name below so I can personalize your tax advisory report.<br><br><input type="text" id="nameInput" placeholder="Your full name" style="width: 100%; padding: 14px; margin: 12px 0; background: rgba(255,255,255,0.05); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 16px;" onkeypress="if(event.key==='Enter') captureName()"><br><button onclick="captureName()" style="padding: 12px 32px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 8px;">Continue ‚Üí</button>`);
          setTimeout(() => document.getElementById('nameInput').focus(), 100);
        }, 1000);

      } else if (value === 'skip_name') {
        addMessage('user', 'I\'ll skip for now');
        extractedData.lead_data.score += 5; // Lower score for anonymous users
        proceedToDataGathering();

      } else if (value === 'enter_email') {
        addMessage('user', 'I\'ll enter my email');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Great! Please enter your email address below.<br><br><input type="email" id="emailInput" placeholder="your.email@example.com" style="width: 100%; padding: 14px; margin: 12px 0; background: rgba(255,255,255,0.05); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 16px;" onkeypress="if(event.key==='Enter') captureEmail()"><br><button onclick="captureEmail()" style="padding: 12px 32px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 8px;">Continue ‚Üí</button>`);
          setTimeout(() => document.getElementById('emailInput').focus(), 100);
        }, 1000);

      } else if (value === 'skip_email') {
        addMessage('user', 'I\'ll skip for now');
        extractedData.lead_data.score += 10;
        proceedToDataGathering();

      } else if (value === 'upload_docs_qualified' || value === 'conversational_qualified' || value === 'hybrid_qualified') {
        const mode = value.replace('_qualified', '');
        addMessage('user', mode.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()));

        if (mode === 'upload_docs' || mode === 'hybrid') {
          showTyping();
          setTimeout(() => {
            hideTyping();
            addMessage('ai', `<strong>Perfect! Let's use our Express Lane document analysis.</strong><br><br>üìÑ <strong>Upload any of these documents:</strong><br>‚Ä¢ W-2 forms (employment income)<br>‚Ä¢ 1099 forms (freelance, interest, dividends)<br>‚Ä¢ Previous tax returns<br>‚Ä¢ Business financial statements<br>‚Ä¢ Receipts for deductions<br><br>I'll use advanced OCR and AI to extract all relevant information automatically.<br><br><div style="text-align: center; margin: 20px 0;"><button onclick="document.getElementById('fileInput').click()" style="padding: 16px 40px; background: var(--gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 18px;">üì§ Upload Documents</button></div>Or <strong>drag and drop</strong> files anywhere on this page.`);
          }, 1000);
        } else {
          // Conversational mode - start smart Q&A
          startIntelligentQuestioning();
        }

      // Handle initial greeting responses
      } else if (value === 'yes_upload') {
        console.log('Processing yes_upload action');
        addMessage('user', 'Yes, let me upload my documents');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Perfect! I'm ready to review your documents. You can:<br><br>‚Ä¢ <strong>Drag and drop</strong> files into the upload zone below<br>‚Ä¢ <strong>Click to browse</strong> and select files from your computer<br><br>I'll instantly analyze W-2s, 1099s, and other tax documents using advanced OCR technology. What would you like to upload first?`, [
            { label: 'üìé Upload W-2', value: 'upload_w2' },
            { label: 'üìé Upload 1099', value: 'upload_1099' },
            { label: 'üìé Other document', value: 'upload_other' }
          ]);
        }, 1500);

      } else if (value === 'no_manual') {
        addMessage('user', 'No, I\'d prefer to discuss my situation first');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Absolutely! I'm here to listen and understand your unique situation.<br><br>Let's start with the basics so I can provide the most relevant guidance. <strong>What's your current filing status?</strong>`, [
            { label: 'Single', value: 'status_single' },
            { label: 'Married Filing Jointly', value: 'status_married' },
            { label: 'Head of Household', value: 'status_hoh' },
            { label: 'Other', value: 'status_other' }
          ]);
        }, 1500);

      } else if (value === 'what_docs') {
        addMessage('user', 'What kind of documents would help?');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Great question! Here's what I typically review for a comprehensive tax advisory:<br><br><strong>üìä Income Documents:</strong><br>‚Ä¢ W-2 forms (from employers)<br>‚Ä¢ 1099 forms (interest, dividends, freelance income)<br>‚Ä¢ Business income records<br>‚Ä¢ Rental property income<br><br><strong>üí∞ Deduction & Credit Records:</strong><br>‚Ä¢ Mortgage interest statements (1098)<br>‚Ä¢ Property tax records<br>‚Ä¢ Charitable contribution receipts<br>‚Ä¢ Education expenses (1098-T)<br>‚Ä¢ Medical expense receipts<br>‚Ä¢ Retirement contributions<br><br><strong>üìà Investment Records:</strong><br>‚Ä¢ Brokerage statements<br>‚Ä¢ Cryptocurrency transactions<br>‚Ä¢ Capital gains/losses<br><br>Don't worry if you don't have everything right now. <strong>What would you like to do next?</strong>`, [
            { label: 'üìÑ I have some documents ready', value: 'yes_upload' },
            { label: 'üí¨ Let\'s discuss my situation', value: 'no_manual' }
          ]);
        }, 2000);

      } else if (value === 'upload_w2' || value === 'upload_1099' || value === 'upload_other') {
        addMessage('user', 'I want to upload a document');
        document.getElementById('fileInput').click();

      } else if (value.startsWith('filing_')) {
        const status = value.replace('filing_', '');
        const statusMap = {
          'single': 'Single',
          'married': 'Married Filing Jointly',
          'hoh': 'Head of Household',
          'mfs': 'Married Filing Separately'
        };
        const statusText = statusMap[status] || status;

        addMessage('user', statusText);
        extractedData.tax_profile.filing_status = statusText;
        extractedData.lead_data.score += 10;
        updateStats({ filing_status: statusText });
        calculateLeadScore();

        startIntelligentQuestioning();

      } else if (value.startsWith('income_')) {
        let incomeText = '';
        let incomeAmount = 0;

        if (value === 'income_custom') {
          addMessage('user', 'I\'ll type my exact income');
          showTyping();
          setTimeout(() => {
            hideTyping();
            addMessage('ai', `Please enter your total annual income for 2025:<br><br><input type="number" id="incomeInput" placeholder="Enter amount" style="width: 100%; padding: 14px; margin: 12px 0; background: rgba(255,255,255,0.05); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 16px;" onkeypress="if(event.key==='Enter') captureIncome()"><br><button onclick="captureIncome()" style="padding: 12px 32px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 8px;">Continue ‚Üí</button>`);
            setTimeout(() => document.getElementById('incomeInput').focus(), 100);
          }, 1000);
          return;
        } else if (value === 'income_0_50k') {
          incomeText = '$0 - $50,000';
          incomeAmount = 35000;
        } else if (value === 'income_50_100k') {
          incomeText = '$50,000 - $100,000';
          incomeAmount = 75000;
        } else if (value === 'income_100_200k') {
          incomeText = '$100,000 - $200,000';
          incomeAmount = 150000;
        } else if (value === 'income_200_500k') {
          incomeText = '$200,000 - $500,000';
          incomeAmount = 350000;
        } else if (value === 'income_500k_plus') {
          incomeText = 'Over $500,000';
          incomeAmount = 750000;
        }

        addMessage('user', incomeText);
        extractedData.tax_profile.total_income = incomeAmount;
        extractedData.tax_profile.w2_income = incomeAmount; // Assume W2 unless told otherwise
        extractedData.lead_data.score += 15;
        updateStats({ total_income: incomeAmount });
        calculateLeadScore();

        startIntelligentQuestioning();

      } else if (value.startsWith('dependents_')) {
        const depCount = value.replace('dependents_', '');
        const depNum = depCount === '3plus' ? 3 : parseInt(depCount);
        const depText = depNum === 0 ? 'No dependents' : depNum === 1 ? '1 dependent' : `${depNum}+ dependents`;

        addMessage('user', depText);
        extractedData.tax_profile.dependents = depNum;
        extractedData.lead_data.score += 10;
        calculateLeadScore();

        startIntelligentQuestioning();

      } else if (value === 'analyze_deductions') {
        addMessage('user', 'Yes, help me find all my deductions');
        analyzeDeductions();

      } else if (value === 'generate_report_early') {
        addMessage('user', 'Generate my full report');
        updateProgress(90);
        // Generate actual advisory report
        value = 'generate_report'; // Fall through to existing handler

      } else if (value === 'request_cpa_early') {
        addMessage('user', 'I want to speak with a CPA');
        requestCPAConnection();

      } else if (value.startsWith('status_')) {
        const status = value.replace('status_', '').replace('_', ' ');
        addMessage('user', status.charAt(0).toUpperCase() + status.slice(1));
        extractedData.tax_profile.filing_status = status;
        updateStats({ filing_status: status });
        updateProgress(15);

        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Thank you! I've noted that you're filing as <strong>${status}</strong>.<br><br>Now, to provide you with strategic tax guidance, <strong>what's your approximate total annual income?</strong> (This helps me identify opportunities and potential savings specific to your situation)`, [
            { label: 'Under $50,000', value: 'income_under50k' },
            { label: '$50,000 - $100,000', value: 'income_50_100k' },
            { label: '$100,000 - $200,000', value: 'income_100_200k' },
            { label: 'Over $200,000', value: 'income_over200k' }
          ]);
        }, 1500);

      } else if (value.startsWith('income_')) {
        const incomeRange = value.replace('income_', '').replace('_', ' ');
        addMessage('user', incomeRange.charAt(0).toUpperCase() + incomeRange.slice(1));
        extractedData.income_range = incomeRange;
        updateProgress(30);

        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Excellent! With your filing status and income level, I can already identify several strategic opportunities.<br><br><strong>What areas are you most interested in optimizing?</strong> (Select what matters most to you)`, [
            { label: 'üè† Homeownership & Real Estate', value: 'focus_real_estate' },
            { label: 'üìö Education & Student Loans', value: 'focus_education' },
            { label: 'üíº Business & Self-Employment', value: 'focus_business' },
            { label: 'üè• Healthcare & Medical', value: 'focus_healthcare' },
            { label: 'üìà Investments & Retirement', value: 'focus_investments' }
          ]);
        }, 1500);

      } else if (value.startsWith('focus_')) {
        const focus = value.replace('focus_', '').replace('_', ' ');
        addMessage('user', focus.charAt(0).toUpperCase() + focus.slice(1));
        extractedData.focus_area = focus;
        updateProgress(45);

        showTyping();
        setTimeout(() => {
          hideTyping();

          // Provide tailored responses based on focus area
          if (value === 'focus_real_estate') {
            addMessage('ai', `Excellent choice! Real estate offers significant tax advantages. Let me understand your situation better.<br><br><strong>Do you own your primary residence?</strong>`, [
              { label: 'Yes, I own my home', value: 'homeowner_yes' },
              { label: 'No, I rent', value: 'homeowner_no' },
              { label: 'I own rental properties', value: 'homeowner_rental' }
            ]);
          } else if (value === 'focus_education') {
            addMessage('ai', `Education expenses can provide valuable tax benefits. Let's explore your situation.<br><br><strong>Are you currently paying for education expenses?</strong>`, [
              { label: 'Yes, for myself', value: 'edu_self' },
              { label: 'Yes, for dependents', value: 'edu_dependents' },
              { label: 'I have student loan interest', value: 'edu_loans' },
              { label: 'Multiple of these', value: 'edu_multiple' }
            ]);
          } else if (value === 'focus_business') {
            addMessage('ai', `Self-employment and business income create unique opportunities for tax optimization. Tell me more.<br><br><strong>What's your business structure?</strong>`, [
              { label: 'Sole Proprietor / Freelancer', value: 'biz_sole' },
              { label: 'LLC / Partnership', value: 'biz_llc' },
              { label: 'S-Corp / C-Corp', value: 'biz_corp' },
              { label: 'Side business / Gig work', value: 'biz_side' }
            ]);
          } else if (value === 'focus_healthcare') {
            addMessage('ai', `Healthcare expenses can add up, but there are ways to reduce your tax burden. Let's review your situation.<br><br><strong>Do you have significant medical expenses?</strong>`, [
              { label: 'Yes, over $5,000 annually', value: 'medical_high' },
              { label: 'Moderate expenses', value: 'medical_moderate' },
              { label: 'I have an HSA', value: 'medical_hsa' },
              { label: 'Long-term care expenses', value: 'medical_ltc' }
            ]);
          } else if (value === 'focus_investments') {
            addMessage('ai', `Investment and retirement planning are crucial for long-term tax efficiency. Let's dive in.<br><br><strong>What types of investment accounts do you have?</strong>`, [
              { label: '401(k) / Traditional IRA', value: 'inv_traditional' },
              { label: 'Roth IRA', value: 'inv_roth' },
              { label: 'Brokerage / Taxable accounts', value: 'inv_brokerage' },
              { label: 'Multiple account types', value: 'inv_multiple' }
            ]);
          }
        }, 1500);

      } else if (value.startsWith('homeowner_') || value.startsWith('edu_') ||
                 value.startsWith('biz_') || value.startsWith('medical_') ||
                 value.startsWith('inv_')) {

        const response = value.split('_').slice(1).join(' ');
        addMessage('user', response.charAt(0).toUpperCase() + response.slice(1));
        extractedData.details = extractedData.details || {};
        extractedData.details[value] = true;
        updateProgress(60);

        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Thank you for sharing that information. I'm building a comprehensive picture of your tax situation.<br><br>Let me ask about deductions you may be eligible for. <strong>Which of these apply to you?</strong>`, [
            { label: 'üè† Mortgage interest', value: 'deduct_mortgage' },
            { label: 'üíù Charitable donations', value: 'deduct_charity' },
            { label: 'üè• Medical expenses', value: 'deduct_medical' },
            { label: 'üìö Education costs', value: 'deduct_education' },
            { label: 'üíº Business expenses', value: 'deduct_business' },
            { label: 'None of these / Continue', value: 'deduct_skip' }
          ]);
        }, 1500);

      } else if (value.startsWith('deduct_')) {
        if (value === 'deduct_skip') {
          addMessage('user', 'Let\'s continue');
        } else {
          const deduction = value.replace('deduct_', '').replace('_', ' ');
          addMessage('user', deduction.charAt(0).toUpperCase() + deduction.slice(1));
          extractedData.deductions = extractedData.deductions || [];
          extractedData.deductions.push(deduction);
        }
        updateProgress(75);

        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Perfect! Now let's explore tax credits you might qualify for. Credits directly reduce your tax bill dollar-for-dollar.<br><br><strong>Do any of these situations apply to you?</strong>`, [
            { label: 'üë∂ Child Tax Credit', value: 'credit_child' },
            { label: 'üìö Education Credits (AOTC/LLC)', value: 'credit_education' },
            { label: '‚ö° Energy Efficiency Credits', value: 'credit_energy' },
            { label: 'üíº Earned Income Credit', value: 'credit_eitc' },
            { label: 'Not sure / Continue', value: 'credit_skip' }
          ]);
        }, 1500);

      } else if (value.startsWith('credit_')) {
        if (value === 'credit_skip') {
          addMessage('user', 'Let\'s continue');
        } else {
          const credit = value.replace('credit_', '').replace('_', ' ');
          addMessage('user', credit.charAt(0).toUpperCase() + credit.slice(1));
          extractedData.credits = extractedData.credits || [];
          extractedData.credits.push(credit);
        }
        updateProgress(90);

        showTyping();
        setTimeout(() => {
          hideTyping();

          // Generate summary
          const summary = generateSummary();
          addMessage('ai', `<strong>Excellent! I now have a comprehensive understanding of your tax situation.</strong><br><br>Here's what we've covered:<br><br>${summary}<br><br>Based on this information, I can provide you with a detailed strategic tax advisory report including:<br><br>‚úì <strong>Personalized tax optimization strategies</strong><br>‚úì <strong>Estimated tax savings opportunities</strong><br>‚úì <strong>Action items for the current tax year</strong><br>‚úì <strong>Long-term planning recommendations</strong><br>‚úì <strong>Compliance checklist</strong><br><br><strong>Would you like me to generate your comprehensive tax advisory report now?</strong>`, [
            { label: 'üìä Yes, generate my report', value: 'generate_report' },
            { label: 'üí¨ I have more questions first', value: 'more_questions' },
            { label: 'üìÑ Let me add documents', value: 'add_documents' }
          ]);
        }, 2000);

      } else if (value === 'generate_report') {
        addMessage('user', 'Yes, please generate my comprehensive tax advisory report');
        updateProgress(95);

        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `<strong>Generating your personalized tax advisory report...</strong><br><br>I'm analyzing your information and creating strategic recommendations tailored to your unique situation.<br><br>Your report will include:<br>‚Ä¢ Comprehensive tax analysis<br>‚Ä¢ Optimization strategies<br>‚Ä¢ Estimated savings opportunities<br>‚Ä¢ Action plan with timelines<br>‚Ä¢ Filing strategy recommendations<br><br><em>Please wait while I prepare your report...</em>`);

          // Simulate report generation
          setTimeout(() => {
            updateProgress(100);
            addMessage('ai', `<div class="insight-card"><div class="insight-header" style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;"><span style="font-size: 32px;">üéâ</span><strong style="font-size: 20px;">Your Tax Advisory Report is Ready!</strong></div><div style="color: var(--text-secondary); line-height: 1.6;">I've completed a comprehensive analysis of your tax situation. Your personalized report includes strategic recommendations that could save you thousands of dollars.</div></div><br><strong>What would you like to do next?</strong>`, [
              { label: 'üì• Download Full Report (PDF)', value: 'download_report' },
              { label: 'üëÄ View Report Online', value: 'view_report' },
              { label: 'üìß Email Report to Me', value: 'email_report' },
              { label: 'üìû Schedule CPA Consultation', value: 'schedule_consult' }
            ]);
          }, 3000);
        }, 1000);

      } else if (value === 'download_report') {
        addMessage('user', 'Download my report as PDF');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `<strong>Perfect! Preparing your PDF report...</strong><br><br>Your comprehensive tax advisory report is being generated with:<br>‚Ä¢ Executive summary<br>‚Ä¢ Detailed analysis of your tax situation<br>‚Ä¢ Strategic recommendations<br>‚Ä¢ Action items and timelines<br>‚Ä¢ Potential savings breakdown<br><br><em>The download will begin automatically...</em>`);

          // Trigger actual report download
          setTimeout(() => {
            generateAndDownloadReport();
          }, 1500);
        }, 1000);

      } else if (value === 'view_report') {
        addMessage('user', 'Let me view the report online');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Opening your interactive tax advisory report in a new window...<br><br>You'll be able to:<br>‚Ä¢ Review all recommendations<br>‚Ä¢ See detailed calculations<br>‚Ä¢ Print or save as needed<br>‚Ä¢ Share with your CPA if desired`);

          setTimeout(() => {
            window.open('/advisory-report-preview?session_id=' + sessionId, '_blank');
          }, 1000);
        }, 1000);

      } else if (value === 'email_report') {
        addMessage('user', 'Email the report to me');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `I'd be happy to email your report to you.<br><br><strong>What email address should I send it to?</strong><br><br><input type="email" id="emailInput" placeholder="your.email@example.com" style="width: 100%; padding: 12px; margin: 12px 0; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px;"><button onclick="sendReportEmail()" style="padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Send Report</button>`);
        }, 1000);

      } else if (value === 'schedule_consult') {
        addMessage('user', 'I\'d like to schedule a consultation');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `<strong>Excellent decision! A personalized consultation can help you maximize your tax savings.</strong><br><br>Our CPA team specializes in individual tax advisory and can provide:<br>‚Ä¢ One-on-one strategic planning<br>‚Ä¢ Custom optimization strategies<br>‚Ä¢ Ongoing tax advisory support<br>‚Ä¢ Filing assistance when needed<br><br><strong>What works best for you?</strong>`, [
            { label: 'üìû Schedule a call', value: 'consult_call' },
            { label: 'üí¨ Chat with a CPA now', value: 'consult_chat' },
            { label: 'üìß Email consultation', value: 'consult_email' }
          ]);
        }, 1500);

      } else if (value === 'more_questions') {
        addMessage('user', 'I have more questions first');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Of course! I'm here to answer any questions you have. Feel free to ask me about:<br><br>‚Ä¢ Specific deductions or credits<br>‚Ä¢ Tax planning strategies<br>‚Ä¢ Entity structure optimization<br>‚Ä¢ Estimated tax payments<br>‚Ä¢ Any other tax-related concerns<br><br><strong>What would you like to know?</strong>`);
          document.getElementById('userInput').focus();
        }, 1000);

      } else if (value === 'add_documents') {
        addMessage('user', 'Let me add some documents');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Great! Adding documents will help me provide even more accurate recommendations.<br><br>You can upload:<br>‚Ä¢ W-2 forms<br>‚Ä¢ 1099 forms<br>‚Ä¢ Previous tax returns<br>‚Ä¢ Receipts and statements<br><br>Just drag and drop files below, or click to browse.`);
          document.getElementById('fileInput').click();
        }, 1000);

      } else if (value.startsWith('consult_')) {
        const consultType = value.replace('consult_', '');
        addMessage('user', consultType.charAt(0).toUpperCase() + consultType.slice(1) + ' consultation');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `<strong>Perfect! I'm connecting you with our CPA team.</strong><br><br>Your comprehensive tax profile and advisory report will be shared with them so they can provide immediate, informed guidance.<br><br>A member of our team will reach out within 24 hours to schedule your personalized consultation.<br><br><strong>Is there anything else I can help you with today?</strong>`, [
            { label: '‚úÖ No, I\'m all set', value: 'finish_satisfied' },
            { label: 'üì• Download my report first', value: 'download_report' },
            { label: 'üí¨ Ask another question', value: 'more_questions' }
          ]);
        }, 1500);

      } else if (value === 'finish_satisfied') {
        addMessage('user', 'No, I\'m all set. Thank you!');
        updateProgress(100);
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `<div class="insight-card"><strong style="font-size: 18px;">üéâ Thank you for choosing Premium Tax Advisory!</strong><br><br>Your comprehensive tax profile has been saved securely. You can return anytime to:<br>‚Ä¢ Access your advisory report<br>‚Ä¢ Update your information<br>‚Ä¢ Ask additional questions<br>‚Ä¢ Schedule consultations<br><br>Remember, strategic tax planning is an ongoing process. We're here to support you throughout the year, not just during tax season.<br><br><em>Wishing you maximum savings and financial success!</em></div>`);

          // Add confetti or celebration animation here if desired
          updateInsights(['Your tax advisory session is complete!', 'Report saved to your account', 'Next steps emailed to you']);
        }, 1500);

      } else if (value === 'continue_assessment') {
        addMessage('user', 'Let\'s continue with the assessment');
        showTyping();
        setTimeout(() => {
          hideTyping();

          // Determine next logical step based on what's missing
          if (!extractedData.filing_status) {
            addMessage('ai', `Perfect! Let's continue. First, <strong>what's your filing status?</strong>`, [
              { label: 'Single', value: 'status_single' },
              { label: 'Married Filing Jointly', value: 'status_married' },
              { label: 'Head of Household', value: 'status_hoh' },
              { label: 'Other', value: 'status_other' }
            ]);
          } else if (!extractedData.income_range) {
            addMessage('ai', `Great! Now, <strong>what's your approximate annual income?</strong>`, [
              { label: 'Under $50,000', value: 'income_under50k' },
              { label: '$50,000 - $100,000', value: 'income_50_100k' },
              { label: '$100,000 - $200,000', value: 'income_100_200k' },
              { label: 'Over $200,000', value: 'income_over200k' }
            ]);
          } else if (!extractedData.focus_area) {
            addMessage('ai', `Excellent! <strong>What areas are you most interested in optimizing?</strong>`, [
              { label: 'üè† Homeownership & Real Estate', value: 'focus_real_estate' },
              { label: 'üìö Education & Student Loans', value: 'focus_education' },
              { label: 'üíº Business & Self-Employment', value: 'focus_business' },
              { label: 'üè• Healthcare & Medical', value: 'focus_healthcare' },
              { label: 'üìà Investments & Retirement', value: 'focus_investments' }
            ]);
          } else {
            addMessage('ai', `We've covered the basics! <strong>Ready to generate your comprehensive advisory report?</strong>`, [
              { label: 'üìä Yes, generate report', value: 'generate_report' },
              { label: 'üí¨ I have questions first', value: 'more_questions' }
            ]);
          }
        }, 1000);

      } else if (value === 'continue_to_report') {
        addMessage('user', 'Let\'s move forward with the report');
        updateProgress(85);
        showTyping();
        setTimeout(() => {
          hideTyping();
          const summary = generateSummary();
          addMessage('ai', `<strong>Perfect! Here's what we've covered:</strong><br><br>${summary}<br><br>I can now prepare your comprehensive tax advisory report with personalized recommendations. <strong>Shall we proceed?</strong>`, [
            { label: 'üìä Generate my report', value: 'generate_report' },
            { label: '‚úèÔ∏è Make changes first', value: 'review_summary' }
          ]);
        }, 1000);

      } else if (value === 'review_summary') {
        addMessage('user', 'Let me review what we covered');
        showTyping();
        setTimeout(() => {
          hideTyping();
          const summary = generateSummary();
          addMessage('ai', `<strong>Here's a complete summary of your tax profile:</strong><br><br>${summary}<br><br>Would you like to update any of this information or continue to generate your report?`, [
            { label: '‚úèÔ∏è Update filing status', value: 'no_manual' },
            { label: '‚úèÔ∏è Update income/focus', value: 'continue_assessment' },
            { label: '‚úÖ Looks good, continue', value: 'generate_report' }
          ]);
        }, 1000);

      } else if (value === 'ask_question' || value === 'how_it_works') {
        const userMsg = value === 'ask_question' ? 'I have a question' : 'How does this work?';
        addMessage('user', userMsg);

        if (value === 'how_it_works') {
          showTyping();
          setTimeout(() => {
            hideTyping();
            addMessage('ai', `<strong>Great question! Here's how our premium tax advisory works:</strong><br><br><strong>1. Understanding Your Situation (5 minutes)</strong><br>I ask targeted questions to understand your financial picture, or you can upload documents for instant analysis.<br><br><strong>2. Comprehensive Analysis</strong><br>I analyze your situation using 2025 IRS rules, identifying every deduction, credit, and strategy available to you.<br><br><strong>3. Personalized Report</strong><br>You receive a detailed advisory report with:<br>‚Ä¢ Current tax liability estimate<br>‚Ä¢ Potential savings opportunities<br>‚Ä¢ Specific action items<br>‚Ä¢ Long-term planning strategies<br><br><strong>4. Ongoing Support</strong><br>Access to CPA consultations, filing assistance (if needed), and year-round advisory support.<br><br><strong>Ready to get started with your assessment?</strong>`, [
              { label: '‚úÖ Yes, let\'s begin', value: 'continue_assessment' },
              { label: 'üìÑ I want to upload docs', value: 'yes_upload' },
              { label: '‚ùì I have another question', value: 'more_questions' }
            ]);
          }, 1500);
        } else {
          showTyping();
          setTimeout(() => {
            hideTyping();
            addMessage('ai', `Of course! I'm here to answer any questions you have about:<br><br>‚Ä¢ Tax strategies and optimization<br>‚Ä¢ Deductions and credits you may qualify for<br>‚Ä¢ Filing requirements and deadlines<br>‚Ä¢ How to maximize your refund or minimize taxes owed<br>‚Ä¢ Anything else tax-related!<br><br><strong>What would you like to know?</strong> (Feel free to type your question below)`);
            document.getElementById('userInput').focus();
          }, 1000);
        }

      // Error recovery handlers
      } else if (value === 'wait_retry') {
        addMessage('user', 'I\'ll wait and try again');
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `Thanks for your patience! I'm ready to continue now. What would you like to discuss?`, generateSmartQuickActions());
        }, 3000);

      } else if (value === 'reset_conversation') {
        addMessage('user', 'Let\'s start over');
        // Reset session and data
        sessionId = null;
        sessionStorage.removeItem('tax_session_id');
        conversationHistory = [];
        extractedData = {
          filing_status: null,
          income_range: null,
          income_amount: null,
          deductions: [],
          credits: [],
          focus_area: null,
          tax_profile: {},
          documents: [],
          lead_data: { score: 0 }
        };
        updateProgress(0);
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('ai', `No problem! Let's start fresh. I'm your AI-powered tax advisor, ready to help you discover strategic opportunities to optimize your tax situation.<br><br><strong>Would you like to upload tax documents for me to analyze, or shall we talk through your situation?</strong>`, [
            { label: 'üìÑ Upload documents', value: 'yes_upload' },
            { label: 'üí¨ Let\'s discuss my situation', value: 'no_manual' },
            { label: '‚ùì How does this work?', value: 'how_it_works' }
          ]);
        }, 1000);

      } else if (value === 'retry_message') {
        // Retry the last message if available
        if (lastUserMessage) {
          addMessage('user', 'Retrying my last message...');
          await processAIResponse(lastUserMessage);
        } else {
          addMessage('user', 'Let me try again');
          showTyping();
          setTimeout(() => {
            hideTyping();
            addMessage('ai', `I'm ready when you are! What would you like to discuss?`, generateSmartQuickActions());
            document.getElementById('userInput').focus();
          }, 500);
        }

      } else {
        // For any other actions not handled, use AI processing
        const displayText = value.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        addMessage('user', displayText);
        await processAIResponse(value);
      }
    }

    // Helper function to generate summary
    function generateSummary() {
      let summary = '';

      if (extractedData.filing_status) {
        summary += `üìã <strong>Filing Status:</strong> ${extractedData.filing_status}<br>`;
      }
      if (extractedData.income_range) {
        summary += `üí∞ <strong>Income Range:</strong> ${extractedData.income_range}<br>`;
      }
      if (extractedData.focus_area) {
        summary += `üéØ <strong>Focus Area:</strong> ${extractedData.focus_area}<br>`;
      }
      if (extractedData.deductions && extractedData.deductions.length > 0) {
        summary += `üìä <strong>Deductions:</strong> ${extractedData.deductions.join(', ')}<br>`;
      }
      if (extractedData.credits && extractedData.credits.length > 0) {
        summary += `‚≠ê <strong>Credits:</strong> ${extractedData.credits.join(', ')}<br>`;
      }

      return summary || 'Your comprehensive tax profile';
    }

    // Helper function to generate and download report
    async function generateAndDownloadReport() {
      try {
        addMessage('ai', '‚è≥ Generating your PDF report...');

        // Call the advisory report API
        const response = await fetch('/api/v1/advisory-reports/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: sessionId,
            report_type: 'full_analysis',
            include_entity_comparison: true,
            include_multi_year: true,
            years_ahead: 3,
            generate_pdf: true
          })
        });

        if (response.ok) {
          const data = await response.json();

          // Poll for PDF completion
          let pdfReady = false;
          let attempts = 0;
          while (!pdfReady && attempts < 30) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            const statusResponse = await fetch(`/api/v1/advisory-reports/${data.report_id}`);
            const statusData = await statusResponse.json();
            if (statusData.pdf_available) {
              pdfReady = true;
              // Download the PDF
              window.open(`/api/v1/advisory-reports/${data.report_id}/pdf`, '_blank');
              addMessage('ai', `‚úÖ <strong>Your report is ready!</strong><br><br>The PDF download should begin automatically. If not, <a href="/api/v1/advisory-reports/${data.report_id}/pdf" target="_blank" style="color: var(--primary);">click here to download</a>.`);
            }
            attempts++;
          }
        } else {
          throw new Error('Failed to generate report');
        }
      } catch (error) {
        console.error('Report generation error:', error);
        addMessage('ai', `I encountered an issue generating the PDF. However, you can still <a href="/advisory-report-preview?session_id=${sessionId}" target="_blank" style="color: var(--primary);">view your report online here</a>.`);
      }
    }

    // Helper function to send report via email
    async function sendReportEmail() {
      const email = document.getElementById('emailInput').value;
      if (!email || !email.includes('@')) {
        alert('Please enter a valid email address');
        return;
      }

      addMessage('user', `Send to: ${email}`);
      showTyping();

      setTimeout(() => {
        hideTyping();
        addMessage('ai', `<strong>‚úÖ Report sent successfully!</strong><br><br>I've emailed your comprehensive tax advisory report to <strong>${email}</strong>.<br><br>Please check your inbox (and spam folder) within the next few minutes. The email will include:<br>‚Ä¢ PDF attachment of your full report<br>‚Ä¢ Summary of key findings<br>‚Ä¢ Personalized action items<br>‚Ä¢ Link to schedule a consultation<br><br><strong>What would you like to do next?</strong>`, [
          { label: 'üì• Also download PDF', value: 'download_report' },
          { label: 'üìû Schedule consultation', value: 'schedule_consult' },
          { label: '‚úÖ I\'m all set', value: 'finish_satisfied' }
        ]);
      }, 2000);
    }

    // Retry helper with exponential backoff
    async function fetchWithRetry(url, options, maxRetries = 3) {
      let lastError;

      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

          const response = await fetch(url, {
            ...options,
            signal: controller.signal
          });

          clearTimeout(timeoutId);

          // Don't retry on client errors (4xx) except 408 (timeout) and 429 (rate limit)
          if (response.status >= 400 && response.status < 500 &&
              response.status !== 408 && response.status !== 429) {
            return response;
          }

          // Retry on server errors (5xx) or specific client errors
          if (!response.ok && attempt < maxRetries) {
            const delay = Math.min(1000 * Math.pow(2, attempt - 1), 8000); // Max 8s delay
            console.log(`Retry attempt ${attempt} after ${delay}ms`);
            await new Promise(resolve => setTimeout(resolve, delay));
            continue;
          }

          return response;
        } catch (error) {
          lastError = error;

          // Don't retry on abort errors
          if (error.name === 'AbortError') {
            throw new Error('Request timeout - please try again');
          }

          // Retry on network errors
          if (attempt < maxRetries) {
            const delay = Math.min(1000 * Math.pow(2, attempt - 1), 8000);
            console.log(`Network error, retry attempt ${attempt} after ${delay}ms`);
            await new Promise(resolve => setTimeout(resolve, delay));
            continue;
          }
        }
      }

      throw lastError || new Error('Request failed after retries');
    }

    // Store last message for retry
    let lastUserMessage = null;

    async function processAIResponse(userMessage) {
      isProcessing = true;
      lastUserMessage = userMessage; // Store for retry
      showTyping();

      // Create session if not already created
      if (!sessionId) {
        try {
          const sessionResponse = await fetchWithRetry('/api/sessions/create-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              workflow_type: 'intelligent_conversational',
              tax_year: 2025
            })
          }, 2); // 2 retries for session creation

          if (!sessionResponse.ok) {
            // If session creation fails, generate a temporary client-side ID
            sessionId = 'temp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            console.warn('Using temporary session ID:', sessionId);
          } else {
            const sessionData = await sessionResponse.json();
            sessionId = sessionData.session_id;
          }
          sessionStorage.setItem('tax_session_id', sessionId);
        } catch (error) {
          console.error('Failed to create session:', error);
          // Generate temporary client-side session ID as fallback
          sessionId = 'temp-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
          sessionStorage.setItem('tax_session_id', sessionId);
        }
      }

      // Build context-aware system message for AI
      const systemContext = buildSystemContext();

      try {
        const response = await fetchWithRetry('/api/ai-chat/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: sessionId,
            user_message: userMessage,
            conversation_history: conversationHistory,
            extracted_data: extractedData,
            system_context: systemContext
          })
        }, 3); // 3 retries with exponential backoff

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const data = await response.json();
        hideTyping();

        // Update conversation history
        conversationHistory.push(
          { role: 'user', content: userMessage },
          { role: 'assistant', content: data.ai_response }
        );

        // Update extracted data if AI extracted any information
        if (data.extracted_data) {
          extractedData = { ...extractedData, ...data.extracted_data };
          console.log('Updated extracted data:', extractedData);
        }

        // Show AI response with any suggested quick actions
        const aiResponse = data.ai_response || data.response || "I'm here to help. Could you please clarify?";
        const quickActions = data.quick_actions || generateSmartQuickActions();

        addMessage('ai', aiResponse, quickActions);

        // Update side panel with AI insights
        if (data.completion_percentage !== undefined) {
          updateProgress(data.completion_percentage);
        }
        if (data.insights && data.insights.length > 0) {
          updateInsights(data.insights);
        }
        if (data.extracted_summary) {
          updateStats(data.extracted_summary);
        }

      } catch (error) {
        hideTyping();
        console.error('AI response error:', error);

        // Handle specific error types
        let errorMessage = '';
        let quickActions = generateSmartQuickActions();

        if (error.message && error.message.includes('429')) {
          // Rate limit exceeded
          errorMessage = "I'm getting a lot of requests right now. Please wait a moment before sending another message.";
          quickActions = [
            { label: 'Wait 30 seconds', value: 'wait_retry' },
            { label: 'Start over', value: 'reset_conversation' }
          ];
        } else if (error.message && error.message.includes('404')) {
          // Session not found - recreate
          sessionId = null;
          sessionStorage.removeItem('tax_session_id');
          errorMessage = "Your session was reset. Let's continue from where we were. What would you like to discuss?";
        } else if (error.message && error.message.includes('504') || error.message && error.message.includes('timeout')) {
          // Timeout - suggest rephrasing
          errorMessage = "That's taking longer than expected. Could you try rephrasing your question or asking something simpler?";
        } else if (!navigator.onLine) {
          // Offline
          errorMessage = "It looks like you're offline. Please check your internet connection and try again.";
          quickActions = [
            { label: 'Try again', value: 'retry_message' }
          ];
        } else {
          // Generic fallback
          errorMessage = generateIntelligentFallback(userMessage);
        }

        addMessage('ai', errorMessage, quickActions);
      } finally {
        // Always reset processing flag
        isProcessing = false;
      }
    }

    // Build system context for AI to understand conversation state
    function buildSystemContext() {
      const progress = getCurrentProgress();
      const confidence = getConfidenceLevel();

      let context = {
        role: 'system',
        content: `You are a premium CPA tax advisor AI assistant specializing in individual tax advisory. You're having a warm, professional conversation with a client.

‚ö†Ô∏è CRITICAL AI DISCLOSURE REQUIREMENTS:
- You are an AI assistant, NOT a licensed CPA or tax professional
- Your responses are ESTIMATES and GENERAL GUIDANCE, not professional tax advice
- Users should ALWAYS verify information with a licensed tax professional before making decisions
- Include relevant IRS publication/form references when giving specific tax guidance

CRITICAL: All tax advice, limits, deductions, and credits must follow 2025 IRS rules and regulations. Use only 2025 tax year information.

Tax Year: 2025
Data Confidence: ${confidence.level} (${confidence.percentage}% complete)
Current conversation state:
- Progress: ${progress}%
- Filing Status: ${extractedData.filing_status || 'Not yet provided'}
- Income Range: ${extractedData.income_range || 'Not yet provided'}
- Focus Area: ${extractedData.focus_area || 'Not yet determined'}
- Deductions: ${extractedData.deductions ? extractedData.deductions.join(', ') : 'None captured yet'}
- Credits: ${extractedData.credits ? extractedData.credits.join(', ') : 'None captured yet'}

2025 IRS Key Information (cite these sources):
- Standard Deduction Single: $15,000 (IRS Rev. Proc. 2024-40)
- Standard Deduction MFJ: $30,000 (IRS Rev. Proc. 2024-40)
- Standard Deduction HOH: $22,500 (IRS Rev. Proc. 2024-40)
- Child Tax Credit: $2,000/child (IRC ¬ß24, Form 8812)
- 401(k) Limit: $23,500 / $31,000 catch-up (IRS Notice 2024-80)
- IRA Limit: $7,000 / $8,000 catch-up (IRS Notice 2024-80)
- EITC Max: $7,830 (3+ children) (IRS Rev. Proc. 2024-40)
- SALT Deduction Cap: $10,000 (IRC ¬ß164(b)(6))

IRS SOURCE CITATION GUIDELINES:
When discussing specific tax topics, reference relevant IRS resources:
- Deductions: "See IRS Publication 17, Chapter [X]"
- Credits: "See Form [number] instructions"
- Filing Status: "See IRS Publication 501"
- Self-Employment: "See Schedule SE and IRS Publication 334"
- Home Office: "See IRS Publication 587"
- Retirement: "See IRS Publication 590-A/B"

RESPONSE GUIDELINES:
1. Maintain a warm, experienced advisor tone
2. This is INDIVIDUAL tax advisory - emphasize strategic planning
3. ALWAYS use 2025 IRS rules with source citations when specific
4. If data confidence is LOW, emphasize this is general guidance only
5. Extract tax-relevant information and suggest clarifying questions
6. If the user asks off-topic questions, answer briefly then redirect
7. Always recommend consulting a licensed CPA for final decisions
8. Be helpful, patient, and professional

If you need more information to provide good advice, ask specific questions.
If they're ready to move forward, suggest generating their comprehensive advisory report.`
      };

      return context;
    }

    // Generate smart quick actions based on current state
    function generateSmartQuickActions() {
      const progress = getCurrentProgress();

      if (progress < 20) {
        return [
          { label: 'üí¨ Tell you my situation', value: 'no_manual' },
          { label: 'üìÑ Upload documents', value: 'yes_upload' },
          { label: '‚ùì How does this work?', value: 'how_it_works' }
        ];
      } else if (progress < 50) {
        return [
          { label: 'üìä Continue the assessment', value: 'continue_assessment' },
          { label: '‚ùì I have a question', value: 'ask_question' },
          { label: 'üìÑ Add documents', value: 'add_documents' }
        ];
      } else if (progress < 90) {
        return [
          { label: '‚úÖ Continue to report', value: 'continue_to_report' },
          { label: 'üí¨ Ask something else', value: 'ask_question' },
          { label: 'üìã Review what we covered', value: 'review_summary' }
        ];
      } else {
        return [
          { label: 'üìä Generate my report', value: 'generate_report' },
          { label: 'üìû Schedule consultation', value: 'schedule_consult' },
          { label: 'üí¨ I have questions', value: 'more_questions' }
        ];
      }
    }

    // Generate intelligent fallback response
    function generateIntelligentFallback(userMessage) {
      const lowerMessage = userMessage.toLowerCase();

      // Check for common tax questions
      if (lowerMessage.includes('deduction') || lowerMessage.includes('deduct')) {
        return `Great question about deductions! Deductions reduce your taxable income. Common ones include:<br><br>‚Ä¢ Mortgage interest<br>‚Ä¢ Charitable donations<br>‚Ä¢ State and local taxes<br>‚Ä¢ Medical expenses (if over 7.5% of income)<br>‚Ä¢ Business expenses<br><br>To provide specific guidance for your situation, I need to know a bit more about you. <strong>What's your filing status?</strong>`;
      }

      if (lowerMessage.includes('credit')) {
        return `Tax credits are even better than deductions - they reduce your tax bill dollar-for-dollar! Common credits include:<br><br>‚Ä¢ Child Tax Credit<br>‚Ä¢ Earned Income Credit<br>‚Ä¢ Education credits<br>‚Ä¢ Energy efficiency credits<br><br>Let me learn more about your situation so I can identify which credits you qualify for. <strong>Shall we continue with your assessment?</strong>`;
      }

      if (lowerMessage.includes('save') || lowerMessage.includes('savings')) {
        return `I love that you're focused on savings! The amount you can save depends on your specific situation. On average, strategic tax planning saves our clients $2,000-$15,000 annually.<br><br>To calculate your potential savings, I need to understand your:<br>‚Ä¢ Income level<br>‚Ä¢ Filing status<br>‚Ä¢ Current deductions and credits<br>‚Ä¢ Financial goals<br><br><strong>Would you like to complete a quick assessment so I can estimate your savings?</strong>`;
      }

      if (lowerMessage.includes('cost') || lowerMessage.includes('price') || lowerMessage.includes('fee')) {
        return `Our individual tax advisory service is complimentary for the initial assessment. We'll provide you with a comprehensive analysis and recommendations at no cost.<br><br>If you'd like ongoing advisory support or assistance with tax filing, we'll discuss those services after your initial report.<br><br><strong>Would you like to continue with your free tax assessment?</strong>`;
      }

      // Handle confused or frustrated users
      if (lowerMessage.includes('confused') || lowerMessage.includes('don\'t understand') || lowerMessage.includes('help')) {
        return `I'm sorry for any confusion! Let me make this simpler.<br><br>I'm here to help you save money on your taxes. All you need to do is answer a few quick questions about your situation, and I'll provide personalized recommendations.<br><br><strong>Would you like to start with something simple? What's your filing status?</strong>`;
      }

      // Handle exit intent
      if (lowerMessage.includes('quit') || lowerMessage.includes('exit') || lowerMessage.includes('stop') || lowerMessage.includes('bye')) {
        return `I understand! Before you go, know that your progress has been saved. You can come back anytime to continue your tax assessment.<br><br>Is there anything specific I can help you with quickly before you go?`;
      }

      // Handle off-topic or personal questions
      if (lowerMessage.includes('who are you') || lowerMessage.includes('what are you') || lowerMessage.includes('your name')) {
        return `I'm your AI-powered tax advisor! I specialize in helping individuals optimize their tax situation.<br><br>I can analyze your income, deductions, and credits to find opportunities to save money on your taxes. <strong>Would you like to get started with a quick assessment?</strong>`;
      }

      // Handle vague income statements
      if (lowerMessage.includes('make good money') || lowerMessage.includes('decent salary') || lowerMessage.includes('earn a lot')) {
        return `That's great! To provide accurate tax advice, I'll need a more specific income range. This helps me identify the right deductions and credits for your situation.<br><br><strong>What's your approximate annual income?</strong>`;
      }

      // Generic helpful response
      return `I appreciate your question! While I'm here primarily to help with your tax advisory needs, I want to make sure I address your concern properly.<br><br>To give you the most accurate guidance, let me learn more about your tax situation. This will help me provide personalized recommendations that could save you thousands of dollars.<br><br><strong>Would you like to continue with your tax assessment, or do you have other specific questions?</strong>`;
    }

    // Get current progress percentage
    function getCurrentProgress() {
      const progressFill = document.getElementById('progressFill');
      if (progressFill) {
        const width = progressFill.style.width;
        return parseInt(width) || 0;
      }
      return 0;
    }

    function updateProgress(percentage) {
      document.getElementById('progressFill').style.width = percentage + '%';
      document.getElementById('progressText').textContent = `${Math.round(percentage)}% Complete`;
    }

    function updateInsights(insights) {
      const container = document.getElementById('insights');
      if (insights.length === 0) return;

      container.innerHTML = insights.map(insight => `
        <div class="insight-card">
          <div class="insight-header">
            <span>${insight.icon}</span>
            <span>${insight.title}</span>
          </div>
          <div style="font-size: 13px; color: var(--text-secondary);">
            ${insight.text}
          </div>
        </div>
      `).join('');
    }

    function updateStats(summary) {
      const grid = document.getElementById('statsGrid');
      const stats = [];

      if (summary.filing_status) stats.push({ label: 'Filing Status', value: summary.filing_status });
      if (summary.total_income) stats.push({ label: 'Income', value: '$' + summary.total_income.toLocaleString() });
      if (summary.deductions_count) stats.push({ label: 'Deductions', value: summary.deductions_count });

      if (stats.length > 0) {
        grid.innerHTML = stats.map(stat => `
          <div class="stat-item">
            <span class="stat-label">${stat.label}</span>
            <span class="stat-value">${stat.value}</span>
          </div>
        `).join('');
      }
    }

    async function handleFileSelect(event) {
      const files = event.target.files;
      if (files.length === 0) return;

      for (const file of files) {
        addMessage('user', `Uploading: ${file.name}`);
        await uploadFileToAI(file);
      }
    }

    async function uploadFileToAI(file) {
      showTyping();

      const formData = new FormData();
      formData.append('file', file);
      formData.append('session_id', sessionId);

      try {
        const response = await fetch('/api/ai-chat/analyze-document', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        hideTyping();

        addMessage('ai', data.ai_response, data.quick_actions || []);

        if (data.extracted_data) {
          extractedData = { ...extractedData, ...data.extracted_data };
        }

        updateProgress(data.completion_percentage || 0);
        updateStats(data.extracted_summary || {});

      } catch (error) {
        hideTyping();
        addMessage('ai', 'I had trouble reading that document. Could you try uploading it again or tell me the information manually?');
      }
    }

    function uploadDocument() {
      document.getElementById('fileInput').click();
    }

    function addVoiceInput() {
      alert('Voice input feature coming soon!');
    }

    function handleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    // Auto-resize textarea
    document.getElementById('userInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Drag and drop
    const uploadZone = document.querySelector('.upload-zone');
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      document.getElementById('fileInput').files = files;
      handleFileSelect({ target: { files } });
    });

    // ===================================================================
    // LEAD CAPTURE & QUALIFICATION FUNCTIONS
    // ===================================================================

    async function captureName() {
      const nameInput = document.getElementById('nameInput');
      const name = nameInput ? nameInput.value.trim() : '';

      // Validate name - at least 2 characters, no special characters
      if (!name || name.length < 2) {
        showToast('Please enter your name (at least 2 characters)', 'error');
        if (nameInput) nameInput.focus();
        return;
      }

      // Sanitize - remove potentially dangerous characters
      const sanitizedName = name.replace(/[<>"'&]/g, '').substring(0, 100);

      extractedData.contact.name = sanitizedName;
      extractedData.lead_data.score += 15; // Higher score for engaged users
      addMessage('user', name);

      showTyping();
      setTimeout(() => {
        hideTyping();
        addMessage('ai', `Thank you, ${name}! It's a pleasure to work with you.<br><br>Now, to provide you with the most accurate tax analysis and connect you with the right CPA specialist, <strong>may I have your email address?</strong> (We'll send your comprehensive report here)`, [
          { label: 'üìß Enter email', value: 'enter_email' },
          { label: '‚è≠Ô∏è Skip for now', value: 'skip_email' }
        ]);
      }, 1000);
    }

    async function captureEmail() {
      const emailInput = document.getElementById('emailInput');
      const email = emailInput ? emailInput.value.trim().toLowerCase() : '';

      // Validate email with regex
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!email || !emailRegex.test(email)) {
        showToast('Please enter a valid email address (e.g., name@example.com)', 'error');
        if (emailInput) emailInput.focus();
        return;
      }

      // Sanitize and limit length
      const sanitizedEmail = email.substring(0, 254);

      extractedData.contact.email = sanitizedEmail;
      extractedData.lead_data.score += 20; // Qualified lead!
      leadQualified = true;
      addMessage('user', email);

      showTyping();
      setTimeout(() => {
        hideTyping();
        const firstName = extractedData.contact.name ? extractedData.contact.name.split(' ')[0] : 'there';
        addMessage('ai', `Perfect, ${firstName}! I've saved your email.<br><br>üéâ <strong>You're now qualified for our premium tax advisory service!</strong><br><br>Let's analyze your tax situation and calculate your actual potential savings. This will take about 3-5 minutes.<br><br><strong>How would you like to provide your tax information?</strong>`, [
          { label: 'üìÑ Upload tax documents (fastest)', value: 'upload_docs_qualified' },
          { label: 'üí¨ Answer questions conversationally', value: 'conversational_qualified' },
          { label: 'üéØ Hybrid: docs + questions', value: 'hybrid_qualified' }
        ]);
      }, 1500);
    }

    async function proceedToDataGathering() {
      showTyping();
      setTimeout(() => {
        hideTyping();
        addMessage('ai', `No problem! Let's gather your tax information.<br><br><strong>How would you like to share your information with me?</strong>`, [
          { label: 'üìÑ Upload tax documents', value: 'upload_docs_qualified' },
          { label: 'üí¨ Answer questions', value: 'conversational_qualified' }
        ]);
      }, 1000);
    }

    // ===================================================================
    // INTELLIGENT DATA EXTRACTION WITH OPENAI
    // ===================================================================

    async function extractDataWithAI(userMessage) {
      try {
        const response = await fetch('/api/ai-chat/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            session_id: sessionId,
            user_message: userMessage,
            conversation_history: conversationHistory,
            extracted_data: extractedData,
            extraction_mode: true,
            system_context: buildSystemContext()
          })
        });

        if (response.ok) {
          const data = await response.json();

          // Merge extracted data
          if (data.extracted_data) {
            mergeExtractedData(data.extracted_data);
          }

          // Update lead score based on data completeness
          calculateLeadScore();

          return data;
        }
      } catch (error) {
        console.error('AI extraction error:', error);
      }
      return null;
    }

    function mergeExtractedData(newData) {
      // Intelligently merge new data into existing structure
      if (newData.filing_status) extractedData.tax_profile.filing_status = newData.filing_status;
      if (newData.income) extractedData.tax_profile.total_income = newData.income;
      if (newData.w2_income) extractedData.tax_profile.w2_income = newData.w2_income;
      if (newData.business_income) extractedData.tax_profile.business_income = newData.business_income;
      if (newData.dependents) extractedData.tax_profile.dependents = newData.dependents;
      if (newData.state) extractedData.tax_profile.state = newData.state;

      // Deductions
      if (newData.mortgage) extractedData.tax_items.mortgage_interest = newData.mortgage;
      if (newData.charitable) extractedData.tax_items.charitable = newData.charitable;

      console.log('Merged extracted data:', extractedData);
    }

    function calculateLeadScore() {
      let score = extractedData.lead_data.score;

      // Add points for completeness
      if (extractedData.contact.name) score += 10;
      if (extractedData.contact.email) score += 20;
      if (extractedData.contact.phone) score += 15;
      if (extractedData.tax_profile.filing_status) score += 10;
      if (extractedData.tax_profile.total_income) score += 15;
      if (extractedData.documents.length > 0) score += 20;

      // Complexity scoring (higher = better lead)
      if (extractedData.tax_profile.business_income && extractedData.tax_profile.business_income > 0) {
        score += 25;
        extractedData.lead_data.complexity = 'complex';
      }
      if (extractedData.tax_profile.rental_income && extractedData.tax_profile.rental_income > 0) {
        score += 20;
      }
      if (extractedData.tax_profile.total_income && extractedData.tax_profile.total_income > 100000) {
        score += 15;
      }

      extractedData.lead_data.score = Math.min(score, 100);
      extractedData.lead_data.ready_for_cpa = score >= 60;

      updateProgress(Math.min(score, 95)); // Cap at 95% until report generated
    }

    // ===================================================================
    // REAL TAX CALCULATIONS
    // ===================================================================

    async function calculateTaxLiability() {
      if (!extractedData.tax_profile.total_income || !extractedData.tax_profile.filing_status) {
        return null;
      }

      try {
        const response = await fetch('/api/calculate-tax', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filing_status: extractedData.tax_profile.filing_status,
            total_income: extractedData.tax_profile.total_income,
            w2_income: extractedData.tax_profile.w2_income || 0,
            business_income: extractedData.tax_profile.business_income || 0,
            deductions: extractedData.tax_items,
            dependents: extractedData.tax_profile.dependents || 0,
            tax_year: 2025
          })
        });

        if (response.ok) {
          taxCalculations = await response.json();
          extractedData.lead_data.estimated_savings = taxCalculations.potential_savings || 0;
          return taxCalculations;
        }
      } catch (error) {
        console.error('Tax calculation error:', error);
      }
      return null;
    }

    // ===================================================================
    // INTELLIGENT QUESTIONING ENGINE
    // ===================================================================

    async function startIntelligentQuestioning() {
      showTyping();

      setTimeout(async () => {
        hideTyping();

        // Ask the most important question based on what we don't know
        if (!extractedData.tax_profile.filing_status) {
          addMessage('ai', `<strong>Let's start with the basics.</strong><br><br>What's your tax filing status for 2025?`, [
            { label: 'Single', value: 'filing_single' },
            { label: 'Married Filing Jointly', value: 'filing_married' },
            { label: 'Head of Household', value: 'filing_hoh' },
            { label: 'Married Filing Separately', value: 'filing_mfs' }
          ]);
        } else if (!extractedData.tax_profile.total_income) {
          addMessage('ai', `<strong>Now, tell me about your income.</strong><br><br>What's your approximate total annual income for 2025? (Include all sources: wages, business, investments, etc.)`, [
            { label: '$0 - $50,000', value: 'income_0_50k' },
            { label: '$50,000 - $100,000', value: 'income_50_100k' },
            { label: '$100,000 - $200,000', value: 'income_100_200k' },
            { label: '$200,000 - $500,000', value: 'income_200_500k' },
            { label: 'Over $500,000', value: 'income_500k_plus' },
            { label: 'I\'ll type the exact amount', value: 'income_custom' }
          ]);
        } else if (!extractedData.tax_profile.dependents && extractedData.tax_profile.dependents !== 0) {
          addMessage('ai', `<strong>Do you have any dependents?</strong> (Children under 17, or other qualifying dependents)`, [
            { label: 'No dependents', value: 'dependents_0' },
            { label: '1 dependent', value: 'dependents_1' },
            { label: '2 dependents', value: 'dependents_2' },
            { label: '3+ dependents', value: 'dependents_3plus' }
          ]);
        } else {
          // We have basics, calculate tax and show results
          await performTaxCalculation();
        }
      }, 1500);
    }

    async function performTaxCalculation() {
      addMessage('ai', `<strong>Excellent! I now have enough information to calculate your tax liability.</strong><br><br>‚è≥ Analyzing your tax situation...`);

      const calc = await calculateTaxLiability();

      setTimeout(() => {
        if (calc && calc.total_tax !== undefined) {
          const savings = calc.potential_savings || 0;
          const effectiveRate = ((calc.total_tax / extractedData.tax_profile.total_income) * 100).toFixed(2);

          addMessage('ai', `<div class="insight-card"><strong style="font-size: 20px;">üìä Your 2025 Tax Analysis</strong><br><br><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin: 16px 0;"><div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px;"><div style="font-size: 12px; color: var(--text-secondary);">Estimated Tax Liability</div><div style="font-size: 24px; font-weight: 700; color: #f59e0b;">$${Math.round(calc.total_tax).toLocaleString()}</div></div><div style="background: rgba(16,185,129,0.1); padding: 16px; border-radius: 8px;"><div style="font-size: 12px; color: var(--text-secondary);">Potential Savings</div><div style="font-size: 24px; font-weight: 700; color: #10b981;">$${Math.round(savings).toLocaleString()}</div></div></div><div style="margin: 16px 0;"><strong>Effective Tax Rate:</strong> ${effectiveRate}%<br><strong>Filing Status:</strong> ${extractedData.tax_profile.filing_status}<br><strong>Total Income:</strong> $${extractedData.tax_profile.total_income.toLocaleString()}</div></div><br><strong>Want to maximize your savings?</strong> Let me analyze deductions and credits you may be missing.`, [
            { label: '‚úÖ Yes, find all my deductions', value: 'analyze_deductions' },
            { label: 'üìä Generate full report now', value: 'generate_report_early' },
            { label: 'ü§ù Connect me with a CPA', value: 'request_cpa_early' }
          ]);

          // Update lead score and send to CPA dashboard
          extractedData.lead_data.estimated_savings = savings;
          calculateLeadScore();

          if (extractedData.lead_data.score >= 60) {
            sendLeadToCPA();
          }
        } else {
          addMessage('ai', `I need a bit more information to calculate your exact tax liability. <strong>What's your specific total income for 2025?</strong> (You can type the amount)`);
          document.getElementById('userInput').focus();
        }
      }, 2000);
    }

    // ===================================================================
    // CPA LEAD HANDOFF
    // ===================================================================

    async function sendLeadToCPA() {
      if (!extractedData.lead_data.ready_for_cpa) {
        return false;
      }

      try {
        const response = await fetch('/api/leads/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contact: extractedData.contact,
            tax_profile: extractedData.tax_profile,
            tax_items: extractedData.tax_items,
            lead_score: extractedData.lead_data.score,
            complexity: extractedData.lead_data.complexity,
            estimated_savings: extractedData.lead_data.estimated_savings,
            session_id: sessionId,
            source: 'intelligent_advisor',
            status: 'qualified'
          })
        });

        return response.ok;
      } catch (error) {
        console.error('Lead handoff error:', error);
        return false;
      }
    }

    async function captureIncome() {
      const incomeInput = document.getElementById('incomeInput');
      const rawValue = incomeInput ? incomeInput.value.replace(/[^0-9]/g, '') : '0';
      const income = parseInt(rawValue, 10);

      // Validate income - must be positive and reasonable (max $50M for individuals)
      if (!income || income <= 0) {
        showToast('Please enter a valid income amount', 'error');
        if (incomeInput) incomeInput.focus();
        return;
      }

      if (income > 50000000) {
        showToast('Please verify this amount - it seems unusually high', 'warning');
      }

      extractedData.tax_profile.total_income = income;
      extractedData.tax_profile.w2_income = income;
      extractedData.lead_data.score += 15;
      addMessage('user', `$${income.toLocaleString()}`);
      updateStats({ total_income: income });
      calculateLeadScore();

      startIntelligentQuestioning();
    }

    async function analyzeDeductions() {
      showTyping();
      setTimeout(() => {
        hideTyping();
        addMessage('ai', `<strong>Let's identify every deduction you qualify for.</strong><br><br>I'll ask about common deductions. Select all that apply to you:`, [
          { label: 'üè† Mortgage interest', value: 'has_mortgage' },
          { label: 'üíù Charitable donations', value: 'has_charity' },
          { label: 'üè• Medical expenses', value: 'has_medical' },
          { label: 'üìö Education expenses', value: 'has_education' },
          { label: 'üíº Business expenses', value: 'has_business' },
          { label: 'üè¶ Retirement contributions', value: 'has_retirement' },
          { label: '‚úÖ None of these / Continue', value: 'deductions_done' }
        ]);
      }, 1000);
    }

    async function requestCPAConnection() {
      showTyping();

      // Send lead to CPA
      await sendLeadToCPA();

      setTimeout(() => {
        hideTyping();
        const firstName = extractedData.contact.name ? extractedData.contact.name.split(' ')[0] : 'there';

        addMessage('ai', `<div class="insight-card"><strong style="font-size: 20px;">ü§ù Connecting You with a CPA</strong><br><br>Excellent decision, ${firstName}! Based on your tax profile:<br><br>‚Ä¢ <strong>Complexity Level:</strong> ${extractedData.lead_data.complexity.charAt(0).toUpperCase() + extractedData.lead_data.complexity.slice(1)}<br>‚Ä¢ <strong>Estimated Savings Opportunity:</strong> $${Math.round(extractedData.lead_data.estimated_savings).toLocaleString()}<br>‚Ä¢ <strong>Priority Status:</strong> ${extractedData.lead_data.score >= 80 ? 'High Priority' : 'Standard'}<br><br>I've notified our CPA team. They'll review your information and reach out within 24 hours.</div><br><strong>Would you like to schedule a specific time?</strong>`, [
          { label: 'üìÖ Schedule consultation', value: 'schedule_time' },
          { label: 'üìß Just email me', value: 'email_only' },
          { label: 'üìä Generate my report first', value: 'generate_report' }
        ]);
      }, 2000);
    }

    // Make functions globally accessible
    window.handleQuickAction = handleQuickAction;
    window.sendReportEmail = sendReportEmail;
    window.sendMessage = sendMessage;
    window.captureName = captureName;
    window.captureEmail = captureEmail;
    window.captureIncome = captureIncome;

    // Initialize on load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('Page loaded, initializing...');
      const messagesContainer = document.getElementById('messages');
      console.log('Messages container found:', messagesContainer);

      // Check initial connection status
      updateConnectionStatus(navigator.onLine);

      // Start health check monitoring
      startHealthCheck();

      // Attach event listeners to initial quick action buttons
      const initialButtons = document.querySelectorAll('#initialQuickActions button[data-action]');
      console.log('Found initial buttons:', initialButtons.length);

      initialButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          const action = this.getAttribute('data-action');
          console.log('Initial button clicked:', action);
          console.log('Button element:', this);

          // Disable button temporarily to prevent double clicks
          this.disabled = true;
          setTimeout(() => {
            this.disabled = false;
          }, 2000);

          handleQuickAction(action);
        });
      });

      // Also add click handlers to any buttons added later via event delegation
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('quick-action') && e.target.dataset.action) {
          e.preventDefault();
          const action = e.target.dataset.action;
          console.log('Delegated button clicked:', action);
          handleQuickAction(action);
        }
      });

      // Check consent before initializing session
      if (checkConsent()) {
        initializeSession();
      }

      setTimeout(() => {
        const input = document.getElementById('userInput');
        if (input) input.focus();
      }, 100);
    });

    // =================================================================
    // REAL-TIME FORM VALIDATION UTILITIES
    // =================================================================

    const ValidationUtils = {
      // SSN validation (XXX-XX-XXXX)
      validateSSN: function(ssn) {
        const clean = ssn.replace(/[^0-9]/g, '');
        if (clean.length !== 9) {
          return { valid: false, message: 'SSN must be 9 digits' };
        }
        if (clean === '000000000' || clean.startsWith('000') || clean.startsWith('666') || clean.startsWith('9')) {
          return { valid: false, message: 'Invalid SSN format' };
        }
        return { valid: true, formatted: `${clean.slice(0,3)}-${clean.slice(3,5)}-${clean.slice(5)}` };
      },

      // EIN validation (XX-XXXXXXX)
      validateEIN: function(ein) {
        const clean = ein.replace(/[^0-9]/g, '');
        if (clean.length !== 9) {
          return { valid: false, message: 'EIN must be 9 digits' };
        }
        return { valid: true, formatted: `${clean.slice(0,2)}-${clean.slice(2)}` };
      },

      // Currency validation
      validateCurrency: function(value, fieldName = 'Amount', options = {}) {
        const clean = value.replace(/[$,\s]/g, '');
        const num = parseFloat(clean);

        if (isNaN(num)) {
          return { valid: false, message: `${fieldName} must be a valid number` };
        }
        if (!options.allowNegative && num < 0) {
          return { valid: false, message: `${fieldName} cannot be negative` };
        }
        if (options.max && num > options.max) {
          return { valid: false, message: `${fieldName} cannot exceed $${options.max.toLocaleString()}` };
        }
        if (options.min && num < options.min) {
          return { valid: false, message: `${fieldName} must be at least $${options.min.toLocaleString()}` };
        }
        return { valid: true, value: num, formatted: `$${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` };
      },

      // Date validation
      validateDate: function(dateStr, fieldName = 'Date') {
        const formats = [
          /^\d{4}-\d{2}-\d{2}$/,  // YYYY-MM-DD
          /^\d{2}\/\d{2}\/\d{4}$/, // MM/DD/YYYY
        ];

        if (!formats.some(f => f.test(dateStr))) {
          return { valid: false, message: `${fieldName} format should be MM/DD/YYYY or YYYY-MM-DD` };
        }

        const date = new Date(dateStr);
        if (isNaN(date.getTime())) {
          return { valid: false, message: `${fieldName} is not a valid date` };
        }
        return { valid: true, date: date };
      },

      // Apply validation state to input element
      applyValidationState: function(input, result) {
        // Remove existing states
        input.classList.remove('field-valid', 'field-error', 'field-warning');

        // Find or create validation message element
        let msgEl = input.parentElement.querySelector('.validation-message');
        if (!msgEl) {
          msgEl = document.createElement('div');
          msgEl.className = 'validation-message';
          input.parentElement.appendChild(msgEl);
        }

        if (result.valid) {
          input.classList.add('field-valid');
          msgEl.className = 'validation-message success';
          msgEl.textContent = result.message || '‚úì Valid';
        } else {
          input.classList.add('field-error');
          msgEl.className = 'validation-message error';
          msgEl.textContent = result.message;
        }

        // Auto-hide success message after 2 seconds
        if (result.valid) {
          setTimeout(() => {
            msgEl.style.display = 'none';
          }, 2000);
        }
      },

      // Debounce function for real-time validation
      debounce: function(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
    };

    // Progress indicator utility
    const ProgressIndicator = {
      container: null,
      bar: null,
      text: null,

      create: function(parentEl) {
        this.container = document.createElement('div');
        this.container.className = 'progress-container';
        this.container.innerHTML = `
          <div class="progress-bar" style="width: 0%"></div>
        `;
        this.text = document.createElement('div');
        this.text.className = 'progress-text';

        parentEl.appendChild(this.container);
        parentEl.appendChild(this.text);

        this.bar = this.container.querySelector('.progress-bar');
        return this;
      },

      update: function(percent, message) {
        if (this.bar) {
          this.bar.style.width = `${Math.min(100, Math.max(0, percent))}%`;
        }
        if (this.text && message) {
          this.text.textContent = message;
        }
      },

      remove: function() {
        if (this.container) this.container.remove();
        if (this.text) this.text.remove();
      }
    };

    // Loading skeleton utility
    const SkeletonLoader = {
      show: function(container, count = 3) {
        const skeletons = [];
        for (let i = 0; i < count; i++) {
          const skeleton = document.createElement('div');
          skeleton.className = 'skeleton skeleton-message';
          skeleton.style.width = `${50 + Math.random() * 30}%`;
          skeleton.style.marginLeft = i % 2 === 0 ? '0' : 'auto';
          container.appendChild(skeleton);
          skeletons.push(skeleton);
        }
        return skeletons;
      },

      hide: function(skeletons) {
        skeletons.forEach(s => s.remove());
      }
    };

    // Mobile keyboard handling
    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
      const input = document.getElementById('userInput');
      if (input) {
        input.addEventListener('focus', function() {
          // Scroll to input when focused on mobile
          setTimeout(() => {
            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      }
    }
  </script>
</body>
</html>
