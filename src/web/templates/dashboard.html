<!DOCTYPE html>
<html lang="en" data-theme="cpa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1e3a5f">
  <meta name="description" content="CPA Workspace for managing tax clients and decisions">
  <title>CPA Workspace - Tax Decision Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Core Design System -->
  <link rel="stylesheet" href="/static/css/core/variables.css">
  <link rel="stylesheet" href="/static/css/core/reset.css">
  <link rel="stylesheet" href="/static/css/core/typography.css">
  <link rel="stylesheet" href="/static/css/unified-theme.css">
  <style>
    :root {
      /* =========================
         MAPPED TO CORE DESIGN SYSTEM
         Legacy variables for backward compatibility
         ========================= */
      /* Primary Colors - Using Core Indigo */
      --primary: var(--color-primary-500, var(--color-primary-400));
      --primary-dark: var(--color-primary-600, var(--color-primary-600));
      --primary-hover: var(--color-primary-600, var(--color-primary-600));
      --primary-light: var(--color-primary-50, var(--color-info-50));
      --primary-50: var(--color-primary-50, var(--color-info-50));

      /* Grayscale - Map to Core */
      --gray-50: var(--color-gray-50, var(--color-gray-50));
      --gray-100: var(--color-gray-100, var(--color-gray-100));
      --gray-200: var(--color-gray-200, var(--color-gray-200));
      --gray-300: var(--color-gray-300, var(--color-gray-300));
      --gray-400: var(--color-gray-400, var(--color-gray-400));
      --gray-500: var(--color-gray-500, var(--color-gray-500));
      --gray-600: var(--color-gray-600, var(--color-gray-600));
      --gray-700: var(--color-gray-700, var(--color-gray-700));
      --gray-800: var(--color-gray-800, var(--color-gray-800));
      --gray-900: var(--color-gray-900, var(--color-gray-900));

      /* Text Colors - Map to Core */
      --text-primary: var(--color-gray-900, var(--color-gray-900));
      --text-secondary: var(--color-gray-800, var(--color-gray-800));
      --text-tertiary: var(--color-gray-600, var(--color-gray-600));
      --text-hint: var(--color-gray-500, var(--color-gray-500));

      /* Background Colors - Map to Core */
      --bg-primary: var(--white);
      --bg-secondary: var(--color-gray-50, var(--color-gray-50));
      --bg-tertiary: var(--color-gray-100, var(--color-gray-100));
      --border-light: var(--color-gray-200, var(--color-gray-200));
      --border-default: var(--color-gray-300, var(--color-gray-300));

      /* Semantic Colors - Map to Core */
      --success: var(--color-success-500, var(--color-success-500));
      --success-light: var(--color-success-100, var(--color-success-100));
      --warning: var(--color-warning-500, var(--color-warning-500));
      --warning-light: var(--color-warning-100, var(--color-warning-100));
      --error: var(--color-error-500, var(--color-error-500));
      --info: var(--color-info-500, var(--color-primary-400));
      --info-light: var(--color-info-100, var(--color-primary-50));

      /* Shadows - Map to Core */
      --shadow-sm: var(--shadow-xs, 0 1px 2px 0 rgb(0 0 0 / 0.05));
      --shadow-md: var(--shadow-md, 0 4px 6px -1px rgb(0 0 0 / 0.1));
      --shadow-lg: var(--shadow-lg, 0 10px 15px -3px rgb(0 0 0 / 0.1));

      /* Border Radius - Map to Core */
      --radius-sm: var(--radius-md, 0.375rem);
      --radius-md: var(--radius-lg, 0.5rem);
      --radius-lg: var(--radius-xl, 0.75rem);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      line-height: var(--leading-normal);

    }

    /* Header */
    .header {
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-light);
      padding: var(--space-4) var(--space-6);

      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: var(--space-3);

    }
    .logo-icon {
      width: var(--space-10);

      height: var(--space-10);

      background: var(--primary);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: var(--font-bold);

      font-size: var(--text-lg);

    }
    .logo-text {
      font-size: var(--text-xl);

      font-weight: var(--font-bold);

      color: var(--text-primary);
    }
    .logo-subtitle {
      font-size: var(--text-xs);

      color: var(--text-tertiary);
      font-weight: var(--font-medium);

    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-4);

    }
    .preparer-name {
      font-size: var(--text-sm);

      color: var(--text-secondary);
      font-weight: var(--font-medium);

    }

    /* Main Layout */
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--space-6);

    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);

      margin-bottom: var(--space-6);

    }
    .stat-card {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      padding: var(--space-5);

      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-sm);
    }
    .stat-label {
      font-size: var(--text-xs-plus);
      color: var(--text-tertiary);
      font-weight: var(--font-medium);

      margin-bottom: var(--space-2);

    }
    .stat-value {
      font-size: 28px;
      font-weight: var(--font-bold);

      color: var(--text-primary);
    }
    .stat-value.success { color: var(--success); }
    .stat-value.warning { color: var(--warning); }
    .stat-change {
      font-size: var(--text-xs);

      color: var(--text-hint);
      margin-top: var(--space-1);

    }

    /* Controls Bar */
    .controls-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);

      gap: var(--space-4);

      flex-wrap: wrap;
    }
    .search-box {
      display: flex;
      align-items: center;
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-2) var(--space-3);

      width: 300px;
    }
    .search-box input {
      border: none;
      outline: none;
      font-size: var(--text-sm);

      width: 100%;
      background: transparent;
      color: var(--text-primary);
    }
    .search-box input::placeholder {
      color: var(--text-hint);
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1-5);

      padding: var(--space-2-5) var(--space-4);

      font-size: var(--text-sm);

      font-weight: var(--font-medium);

      border-radius: var(--radius-lg);
      border: none;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover {
      background: var(--primary-hover);
    }
    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-light);
    }
    .btn-secondary:hover {
      background: var(--bg-hover, var(--color-slate-200));
    }

    /* Client Table */
    .client-table-container {
      background: var(--bg-primary);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }
    .client-table {
      width: 100%;
      border-collapse: collapse;
    }
    .client-table th,
    .client-table td {
      padding: var(--space-3-5) var(--space-4);

      text-align: left;
      border-bottom: 1px solid var(--border-light);
    }
    .client-table th {
      background: var(--bg-tertiary);
      font-size: var(--text-xs);

      font-weight: var(--font-semibold);

      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .client-table tbody tr {
      transition: background 0.1s ease;
    }
    .client-table tbody tr:hover {
      background: var(--bg-secondary);
    }
    .client-table tbody tr:last-child td {
      border-bottom: none;
    }
    .client-name {
      font-weight: var(--font-semibold);

      color: var(--text-primary);
    }
    .client-email {
      font-size: var(--text-xs-plus);
      color: var(--text-tertiary);
    }
    .client-id {
      font-size: var(--text-xs-plus);
      color: var(--text-hint);
      font-family: monospace;
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: var(--space-1) var(--space-2-5);

      font-size: var(--text-xs);

      font-weight: var(--font-medium);

      border-radius: var(--radius-2xl-plus);
    }
    .status-new {
      background: var(--info-light);
      color: var(--info);
    }
    .status-in_progress {
      background: var(--warning-light);
      color: var(--warning);
    }
    .status-ready_for_review {
      background: var(--primary-light);
      color: var(--primary);
    }
    .status-reviewed {
      background: var(--success-light);
      color: var(--success);
    }
    .status-delivered {
      background: var(--color-purple-100);
      color: var(--color-primary-400);
    }
    .status-archived {
      background: var(--bg-tertiary);
      color: var(--text-hint);
    }

    /* Metrics */
    .metric-cell {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: var(--text-sm);

    }
    .metric-positive {
      color: var(--success);
      font-weight: var(--font-semibold);

    }
    .metric-negative {
      color: var(--color-error-600);
      font-weight: var(--font-semibold);

    }

    /* Action Button */
    .action-btn {
      padding: var(--space-1-5) var(--space-3);

      font-size: var(--text-xs-plus);
      font-weight: var(--font-medium);

      border-radius: var(--radius-md);

      border: 1px solid var(--border-light);
      background: var(--bg-primary);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.1s ease;
    }
    .action-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px var(--space-5);

    }
    .empty-state-icon {
      font-size: var(--text-5xl);

      margin-bottom: var(--space-4);

    }
    .empty-state-title {
      font-size: var(--text-lg);

      font-weight: var(--font-semibold);

      color: var(--text-primary);
      margin-bottom: var(--space-2);

    }
    .empty-state-text {
      font-size: var(--text-sm);

      color: var(--text-tertiary);
      margin-bottom: var(--space-5);

    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal {
      background: var(--bg-primary);
      border-radius: var(--radius-2xl);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }
    .modal-header {
      padding: var(--space-5) var(--space-6);

      border-bottom: 1px solid var(--border-light);
    }
    .modal-title {
      font-size: var(--text-lg);

      font-weight: var(--font-semibold);

      color: var(--text-primary);
    }
    .modal-body {
      padding: var(--space-6);

    }
    .modal-footer {
      padding: var(--space-4) var(--space-6);

      border-top: 1px solid var(--border-light);
      display: flex;
      justify-content: flex-end;
      gap: var(--space-3);

    }

    /* Form */
    .form-group {
      margin-bottom: var(--space-4);

    }
    .form-label {
      display: block;
      font-size: var(--text-xs-plus);
      font-weight: var(--font-medium);

      color: var(--text-secondary);
      margin-bottom: var(--space-1-5);

    }
    .form-input {
      width: 100%;
      padding: var(--space-2-5) var(--space-3);

      font-size: var(--text-sm);

      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: border-color 0.15s ease;
    }
    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);

    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4);

      border-top: 1px solid var(--border-light);
    }
    .pagination-info {
      font-size: var(--text-xs-plus);
      color: var(--text-tertiary);
    }
    .pagination-buttons {
      display: flex;
      gap: var(--space-2);

    }
    .page-btn {
      padding: var(--space-1-5) var(--space-3);

      font-size: var(--text-xs-plus);
      border-radius: var(--radius-md);

      border: 1px solid var(--border-light);
      background: var(--bg-primary);
      color: var(--text-secondary);
      cursor: pointer;
    }
    .page-btn:hover:not(:disabled) {
      background: var(--bg-tertiary);
    }
    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: var(--space-6);

      right: var(--space-6);

      z-index: 300;
    }
    .toast {
      background: var(--text-primary);
      color: white;
      padding: var(--space-3) var(--space-5);

      border-radius: var(--radius-lg);
      font-size: var(--text-sm);

      box-shadow: var(--shadow-lg);
      margin-top: var(--space-2);

      animation: slideIn 0.3s ease;
    }
    .toast.success {
      background: var(--success);
    }
    .toast.error {
      background: var(--color-error-600);
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* =========================
       MOBILE RESPONSIVE
       ========================= */
    @media (max-width: 768px) {
      .header {
        padding: var(--space-3) var(--space-4);

        flex-wrap: wrap;
        gap: var(--space-3);

      }

      .logo {
        gap: var(--space-2-5);

      }

      .logo-icon {
        width: var(--space-9);

        height: var(--space-9);

        font-size: var(--text-sm);

      }

      .logo-text {
        font-size: var(--text-base);

      }

      .header-actions {
        gap: var(--space-2-5);

        width: 100%;
        justify-content: flex-end;
      }

      .main-container {
        padding: var(--space-4);

      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-3);

      }

      .stat-card {
        padding: var(--space-4);

      }

      .stat-value {
        font-size: var(--text-2xl);

      }

      .client-grid {
        grid-template-columns: 1fr;
      }

      .btn {
        padding: var(--space-2-5) var(--space-4);

        font-size: var(--text-sm);

        min-height: var(--space-11);

      }

      /* Tables scroll horizontally */
      table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    @media (max-width: 480px) {
      .header {
        padding: var(--space-2-5) var(--space-3);

      }

      .logo-text {
        font-size: var(--text-sm);

      }

      .logo-subtitle {
        font-size: 10px;
      }

      .main-container {
        padding: var(--space-3);

      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .stat-card {
        padding: var(--space-3);

      }

      .stat-value {
        font-size: var(--text-xl);

      }

      .stat-label {
        font-size: var(--text-2xs);
      }

      .card {
        padding: var(--space-3);

        border-radius: var(--radius-lg-plus);
      }

      .card-header {
        padding: var(--space-3);

      }

      h2 {
        font-size: var(--text-lg);

      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Skip Link for Keyboard Navigation -->
  <a href="#main-content" class="skip-link" style="position:absolute;top:-40px;left:0;background:#2E7D32;color:white;padding:var(--space-2) var(--space-4);z-index:1000;transition:top 0.3s;" onfocus="this.style.top='0'" onblur="this.style.top='-40px'">Skip to main content</a>

  <!-- Header -->
  <header class="header" role="banner">
    <div class="logo">
      <div class="logo-icon" id="logo-icon" aria-hidden="true">TDI</div>
      <div>
        <div class="logo-text" id="firm-name">Tax Decision Intelligence</div>
        <div class="logo-subtitle">CPA Workspace</div>
      </div>
    </div>
    <nav class="header-actions" role="navigation" aria-label="User actions">
      <span class="preparer-name" id="preparer-name" aria-live="polite">Loading...</span>
      <button class="btn btn-secondary" onclick="showSettings()" aria-label="Open settings">Settings</button>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="main-container" id="main-content" role="main">
    <!-- Stats Grid -->
    <section class="stats-grid" id="stats-grid" aria-label="Dashboard statistics">
      <div class="stat-card" role="group" aria-labelledby="label-total-clients">
        <div class="stat-label" id="label-total-clients">Total Clients</div>
        <div class="stat-value" id="stat-total-clients" aria-live="polite">-</div>
      </div>
      <div class="stat-card" role="group" aria-labelledby="label-in-progress">
        <div class="stat-label" id="label-in-progress">In Progress</div>
        <div class="stat-value warning" id="stat-in-progress" aria-live="polite">-</div>
      </div>
      <div class="stat-card" role="group" aria-labelledby="label-ready-review">
        <div class="stat-label" id="label-ready-review">Ready for Review</div>
        <div class="stat-value" id="stat-ready-review" aria-live="polite">-</div>
      </div>
      <div class="stat-card" role="group" aria-labelledby="label-savings">
        <div class="stat-label" id="label-savings">Potential Savings</div>
        <div class="stat-value success" id="stat-savings" aria-live="polite">-</div>
      </div>
    </section>

    <!-- Controls -->
    <div class="controls-bar" role="toolbar" aria-label="Client list controls">
      <div class="search-box" role="search">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="color: var(--text-hint); margin-right: var(--space-2);" aria-hidden="true">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="M21 21l-4.35-4.35"></path>
        </svg>
        <label for="search-input" class="sr-only">Search clients</label>
        <input type="search" id="search-input" placeholder="Search clients..." onkeyup="debounceSearch()" aria-label="Search clients by name or ID">
      </div>
      <div style="display: flex; gap: var(--space-3);">
        <label for="status-filter" class="sr-only">Filter by status</label>
        <select class="btn btn-secondary" id="status-filter" onchange="loadClients()" aria-label="Filter clients by status">
          <option value="">All Statuses</option>
          <option value="new">New</option>
          <option value="in_progress">In Progress</option>
          <option value="ready_for_review">Ready for Review</option>
          <option value="reviewed">Reviewed</option>
          <option value="delivered">Delivered</option>
          <option value="archived">Archived</option>
        </select>
        <button class="btn btn-primary" onclick="showAddClientModal()" aria-haspopup="dialog">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 5v14M5 12h14"></path>
          </svg>
          Add Client
        </button>
      </div>
    </div>

    <!-- Client Table -->
    <section class="client-table-container" aria-label="Client list">
      <table class="client-table" role="grid" aria-describedby="pagination-info">
        <caption class="sr-only">Tax client list with status, documents, and financial information</caption>
        <thead>
          <tr>
            <th scope="col">Client</th>
            <th scope="col">ID</th>
            <th scope="col">Status</th>
            <th scope="col">Documents</th>
            <th scope="col">Est. Refund/Owed</th>
            <th scope="col">Savings</th>
            <th scope="col">Last Accessed</th>
            <th scope="col"><span class="sr-only">Actions</span></th>
          </tr>
        </thead>
        <tbody id="client-table-body" aria-live="polite">
          <tr>
            <td colspan="8">
              <div class="empty-state" role="status" aria-live="polite">
                <div class="empty-state-icon" aria-hidden="true">&#128203;</div>
                <div class="empty-state-title">Loading clients...</div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
      <nav class="pagination" id="pagination" role="navigation" aria-label="Table pagination">
        <div class="pagination-info" id="pagination-info" aria-live="polite">Showing 0 of 0 clients</div>
        <div class="pagination-buttons" role="group" aria-label="Pagination controls">
          <button class="page-btn" id="prev-btn" onclick="prevPage()" disabled aria-label="Previous page">Previous</button>
          <button class="page-btn" id="next-btn" onclick="nextPage()" disabled aria-label="Next page">Next</button>
        </div>
      </nav>
    </section>
  </main>

  <!-- Add Client Modal -->
  <div class="modal-overlay" id="add-client-modal" role="dialog" aria-modal="true" aria-labelledby="add-client-modal-title" aria-describedby="add-client-modal-desc">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="add-client-modal-title">Add New Client</h2>
        <p id="add-client-modal-desc" class="sr-only">Form to add a new tax client to your workspace</p>
      </div>
      <form id="add-client-form" onsubmit="submitAddClient(event)" novalidate>
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="client-first-name">First Name <span aria-hidden="true">*</span><span class="sr-only">(required)</span></label>
              <input type="text" class="form-input" id="client-first-name" name="first_name" required aria-required="true" autocomplete="given-name">
            </div>
            <div class="form-group">
              <label class="form-label" for="client-last-name">Last Name <span aria-hidden="true">*</span><span class="sr-only">(required)</span></label>
              <input type="text" class="form-input" id="client-last-name" name="last_name" required aria-required="true" autocomplete="family-name">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="client-email">Email</label>
            <input type="email" class="form-input" id="client-email" name="email" autocomplete="email" aria-describedby="email-hint">
            <span id="email-hint" class="sr-only">Optional email address for client communication</span>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="client-external-id">Client ID (your reference)</label>
              <input type="text" class="form-input" id="client-external-id" name="external_id" placeholder="e.g., 2025-001" aria-describedby="external-id-hint">
              <span id="external-id-hint" class="sr-only">Your internal reference number for this client</span>
            </div>
            <div class="form-group">
              <label class="form-label" for="client-phone">Phone</label>
              <input type="tel" class="form-input" id="client-phone" name="phone" autocomplete="tel">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="client-street">Street Address</label>
            <input type="text" class="form-input" id="client-street" name="street_address" autocomplete="street-address">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="client-city">City</label>
              <input type="text" class="form-input" id="client-city" name="city" autocomplete="address-level2">
            </div>
            <div class="form-group">
              <label class="form-label" for="client-state">State</label>
              <input type="text" class="form-input" id="client-state" name="state" maxlength="2" placeholder="CA" autocomplete="address-level1">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('add-client-modal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Client</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast Container - Live Region for Announcements -->
  <div class="toast-container" id="toast-container" role="region" aria-live="polite" aria-label="Notifications"></div>

  <!-- Screen Reader Only Styles (must be in body for some screen readers) -->
  <style>
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -var(--space-px);

      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>

  <script>
    // ================================================================
    // SECURITY: XSS Prevention - Always use this for user-generated content
    // ================================================================
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    // State
    let preparerId = null;
    let currentPage = 0;
    let pageSize = 50;
    let totalClients = 0;
    let searchTimeout = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadPreparer();
      await loadDashboard();
      await loadClients();
    });

    // Load preparer profile
    async function loadPreparer() {
      try {
        const response = await fetch('/api/workspace/preparer/me');
        if (response.status === 401) {
          // No preparer registered - show registration
          showRegistrationPrompt();
          return;
        }
        const data = await response.json();
        if (data.success) {
          preparerId = data.preparer.preparer_id;
          document.getElementById('preparer-name').textContent = data.preparer.display_name || data.preparer.full_name;
          if (data.preparer.firm_name) {
            document.getElementById('firm-name').textContent = data.preparer.firm_name;
          }
          if (data.preparer.branding?.primary_color) {
            document.documentElement.style.setProperty('--primary', data.preparer.branding.primary_color);
          }
        }
      } catch (error) {
        console.error('Failed to load preparer:', error);
      }
    }

    // Load dashboard stats
    async function loadDashboard() {
      try {
        const response = await fetch('/api/workspace/dashboard?tax_year=2025');
        const data = await response.json();
        if (data.success) {
          document.getElementById('stat-total-clients').textContent = data.stats.total_clients;
          document.getElementById('stat-in-progress').textContent = data.stats.status_breakdown.in_progress || 0;
          document.getElementById('stat-ready-review').textContent = data.stats.status_breakdown.ready_for_review || 0;
          document.getElementById('stat-savings').textContent = formatCurrency(data.stats.total_potential_savings);
        }
      } catch (error) {
        console.error('Failed to load dashboard:', error);
      }
    }

    // Load clients
    async function loadClients() {
      const search = document.getElementById('search-input').value;
      const status = document.getElementById('status-filter').value;
      const params = new URLSearchParams({
        tax_year: 2025,
        limit: pageSize,
        offset: currentPage * pageSize,
      });
      if (search) params.append('search', search);
      if (status) params.append('status', status);

      try {
        const response = await fetch(`/api/workspace/clients?${params}`);
        const data = await response.json();
        if (data.success) {
          totalClients = data.total;
          renderClients(data.clients);
          updatePagination(data);
        }
      } catch (error) {
        console.error('Failed to load clients:', error);
        renderEmptyState('Failed to load clients. Please try again.');
      }
    }

    // Render clients table
    function renderClients(clients) {
      const tbody = document.getElementById('client-table-body');

      if (clients.length === 0) {
        renderEmptyState('No clients found. Add your first client to get started.');
        return;
      }

      tbody.innerHTML = clients.map(client => {
        const session = client.session;
        const statusClass = session ? `status-${session.status}` : 'status-new';
        const statusText = session ? formatStatus(session.status) : 'No Session';
        const documents = session?.progress?.documents_processed || 0;
        const refund = session?.metrics?.estimated_refund;
        const owed = session?.metrics?.estimated_tax_owed;
        const savings = session?.metrics?.potential_savings;
        const lastAccessed = session?.last_accessed_at ? formatDate(session.last_accessed_at) : '-';

        let refundOwed = '-';
        let refundClass = '';
        if (refund && refund > 0) {
          refundOwed = formatCurrency(refund);
          refundClass = 'metric-positive';
        } else if (owed && owed > 0) {
          refundOwed = formatCurrency(-owed);
          refundClass = 'metric-negative';
        }

        // Sanitize client data to prevent XSS
        const safeName = escapeHtml(client.full_name);
        const safeEmail = escapeHtml(client.email || '');
        const safeExternalId = escapeHtml(client.external_id || client.client_id.slice(0, 8));
        const safeClientId = escapeHtml(client.client_id);

        return `
          <tr role="row">
            <td role="gridcell">
              <div class="client-name">${safeName}</div>
              ${client.email ? `<div class="client-email">${safeEmail}</div>` : ''}
            </td>
            <td role="gridcell"><span class="client-id">${safeExternalId}</span></td>
            <td role="gridcell"><span class="status-badge ${statusClass}" role="status">${statusText}</span></td>
            <td role="gridcell">${documents}</td>
            <td role="gridcell" class="metric-cell ${refundClass}" aria-label="Estimated ${refund > 0 ? 'refund' : 'owed'}: ${refundOwed}">${refundOwed}</td>
            <td role="gridcell" class="metric-cell ${savings ? 'metric-positive' : ''}" aria-label="Potential savings: ${savings ? formatCurrency(savings) : 'none'}">${savings ? formatCurrency(savings) : '-'}</td>
            <td role="gridcell" style="color: var(--text-tertiary); font-size: var(--text-xs-plus);">${lastAccessed}</td>
            <td role="gridcell">
              <button class="action-btn" onclick="openClient('${safeClientId}')" aria-label="Open ${safeName}'s tax return">Open</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderEmptyState(message) {
      document.getElementById('client-table-body').innerHTML = `
        <tr>
          <td colspan="8">
            <div class="empty-state" role="status" aria-live="polite">
              <div class="empty-state-icon" aria-hidden="true">&#128203;</div>
              <div class="empty-state-title">${message}</div>
              <button class="btn btn-primary" onclick="showAddClientModal()" aria-haspopup="dialog">Add Client</button>
            </div>
          </td>
        </tr>
      `;
    }

    function updatePagination(data) {
      const start = data.offset + 1;
      const end = Math.min(data.offset + data.clients.length, data.total);
      document.getElementById('pagination-info').textContent = `Showing ${start}-${end} of ${data.total} clients`;
      document.getElementById('prev-btn').disabled = currentPage === 0;
      document.getElementById('next-btn').disabled = !data.has_more;
    }

    function prevPage() {
      if (currentPage > 0) {
        currentPage--;
        loadClients();
      }
    }

    function nextPage() {
      currentPage++;
      loadClients();
    }

    function debounceSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        currentPage = 0;
        loadClients();
      }, 300);
    }

    // Add client - with focus management for accessibility
    let previousActiveElement = null;

    function showAddClientModal() {
      previousActiveElement = document.activeElement;
      const modal = document.getElementById('add-client-modal');
      modal.classList.add('active');
      // Focus first input when modal opens
      setTimeout(() => {
        const firstInput = modal.querySelector('input, button, select, textarea');
        if (firstInput) firstInput.focus();
      }, 100);
      // Add keyboard listener for Escape
      document.addEventListener('keydown', handleModalKeydown);
    }

    function closeModal(id) {
      const modal = document.getElementById(id);
      modal.classList.remove('active');
      // Remove keyboard listener
      document.removeEventListener('keydown', handleModalKeydown);
      // Return focus to previous element
      if (previousActiveElement) {
        previousActiveElement.focus();
        previousActiveElement = null;
      }
    }

    function handleModalKeydown(e) {
      if (e.key === 'Escape') {
        closeModal('add-client-modal');
      }
      // Trap focus within modal
      if (e.key === 'Tab') {
        const modal = document.querySelector('.modal-overlay.active .modal');
        if (!modal) return;
        const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];
        if (e.shiftKey && document.activeElement === firstElement) {
          e.preventDefault();
          lastElement.focus();
        } else if (!e.shiftKey && document.activeElement === lastElement) {
          e.preventDefault();
          firstElement.focus();
        }
      }
    }

    async function submitAddClient(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      // Remove empty values
      Object.keys(data).forEach(key => {
        if (!data[key]) delete data[key];
      });

      try {
        const response = await fetch('/api/workspace/clients', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        const result = await response.json();

        if (result.success) {
          showToast('Client added successfully', 'success');
          closeModal('add-client-modal');
          form.reset();
          loadClients();
          loadDashboard();
        } else {
          showToast(result.detail || 'Failed to add client', 'error');
        }
      } catch (error) {
        showToast('Failed to add client', 'error');
      }
    }

    // Open client session
    async function openClient(clientId) {
      try {
        const response = await fetch('/api/workspace/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ client_id: clientId, tax_year: 2025 }),
        });
        const data = await response.json();

        if (data.success) {
          // Redirect to main app with session context
          window.location.href = `/?session_id=${data.session.session_id}&client_id=${clientId}`;
        }
      } catch (error) {
        showToast('Failed to open client', 'error');
      }
    }

    // Registration prompt
    function showRegistrationPrompt() {
      document.getElementById('client-table-body').innerHTML = `
        <tr>
          <td colspan="8">
            <div class="empty-state">
              <div class="empty-state-icon">&#128100;</div>
              <div class="empty-state-title">Welcome! Let's set up your workspace</div>
              <div class="empty-state-text">Register as a preparer to start managing clients.</div>
              <button class="btn btn-primary" onclick="showRegistrationModal()">Register Now</button>
            </div>
          </td>
        </tr>
      `;
    }

    // Utilities
    function formatCurrency(amount) {
      if (amount === null || amount === undefined) return '-';
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(amount);
    }

    function formatStatus(status) {
      const statusMap = {
        'new': 'New',
        'in_progress': 'In Progress',
        'ready_for_review': 'Ready for Review',
        'reviewed': 'Reviewed',
        'delivered': 'Delivered',
        'archived': 'Archived',
      };
      return statusMap[status] || status;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
      if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;

      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.setAttribute('role', type === 'error' ? 'alert' : 'status');
      toast.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
      toast.textContent = message;
      container.appendChild(toast);

      // Auto-dismiss after 4 seconds
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    function showSettings() {
      showToast('Settings coming soon', 'info');
    }

    function showRegistrationModal() {
      // For simplicity, redirect to a registration page or show modal
      showToast('Registration modal coming soon', 'info');
    }
  </script>
</body>
</html>
