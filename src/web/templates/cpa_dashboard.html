<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1e40af">
  <meta name="description" content="CA4CPA GLOBAL LLC - Tax Advisory Intelligence">
  <title>CA4CPA GLOBAL | Tax Advisory Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* =========================
         UNIFIED DESIGN SYSTEM
         ========================= */

      /* Primary Colors - Navy Blue (CA4CPA GLOBAL LLC Branding) */
      --primary: #1e40af;
      --primary-dark: #1e3a8a;
      --primary-hover: #1e3a8a; /* Alias for backwards compatibility */
      --primary-light: #3b82f6;
      --primary-50: #dbeafe;

      /* Accent Colors - Blue (CA4CPA brand secondary) */
      --accent: #3b82f6;
      --accent-light: #dbeafe;

      /* Grayscale */
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;

      /* Semantic Colors */
      --success: #10b981;
      --success-light: #d1fae5;
      --warning: #f59e0b;
      --warning-light: #fef3c7;
      --error: #ef4444;
      --error-light: #fee2e2;
      --info: #3b82f6;
      --info-light: #dbeafe;

      /* CPA-specific Colors */
      --savings: #10b981;
      --savings-bg: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);

      /* Layout */
      --sidebar-width: 260px;

      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08);

      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;

      /* Transitions */
      --transition: 150ms ease;
      --transition-fast: 150ms ease; /* Alias for backwards compatibility */
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--gray-100);
      color: var(--gray-900);
      line-height: 1.5;
      font-size: 14px;
      overflow: hidden;
      height: 100vh;
    }
    .app-layout { display: flex; height: 100vh; }

    /* Sidebar - Compact */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--gray-900);
      color: white;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--gray-700);
    }
    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-mark {
      width: 32px;
      height: 32px;
      background: var(--savings-bg);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
    }
    .logo-text { font-size: 14px; font-weight: 600; }
    .logo-subtitle { font-size: 10px; color: var(--gray-400); margin-top: 1px; }
    .sidebar-nav { flex: 1; padding: 12px 8px; overflow-y: auto; }
    .nav-section { margin-bottom: 20px; }
    .nav-section-label {
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--gray-500);
      padding: 0 12px;
      margin-bottom: 6px;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: var(--radius-md);
      color: var(--gray-400);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .nav-item:hover { background: var(--gray-800); color: white; }
    .nav-item.active { background: var(--primary); color: white; }
    .nav-item.disabled { opacity: 0.4; cursor: not-allowed; }
    .nav-badge {
      margin-left: auto;
      background: var(--primary);
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
    }
    .nav-badge.alert { background: var(--error); }
    .nav-badge.coming { background: var(--gray-600); font-size: 8px; }

    /* Main Content */
    .main-content { flex: 1; overflow-y: auto; padding: 24px; }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
    }
    .page-title { font-size: 24px; font-weight: 700; color: var(--gray-900); }
    .page-subtitle { font-size: 13px; color: var(--gray-500); margin-top: 4px; }
    .header-actions { display: flex; gap: 12px; align-items: center; }
    /* Buttons - Unified Design System */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all var(--transition);
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-primary:disabled { background: var(--gray-300); cursor: not-allowed; }
    .btn-secondary { background: white; color: var(--gray-700); border: 1px solid var(--gray-200); }
    .btn-secondary:hover { background: var(--gray-50); }
    .btn-ghost { background: transparent; color: var(--gray-600); border: 1px solid var(--gray-300); }
    .btn-ghost:hover { background: var(--gray-100); }
    .btn-danger { background: var(--error); color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #059669; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn:focus-visible { outline: 3px solid var(--primary-50); outline-offset: 2px; }

    /* Hero Savings Card */
    .hero-savings {
      background: var(--savings-bg);
      border-radius: var(--radius-lg);
      padding: 28px 32px;
      color: white;
      margin-bottom: 24px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 32px;
      align-items: center;
    }
    .hero-main h2 { font-size: 14px; font-weight: 500; opacity: 0.9; margin-bottom: 8px; }
    .hero-amount { font-size: 48px; font-weight: 700; line-height: 1; margin-bottom: 8px; }
    .hero-detail { font-size: 13px; opacity: 0.85; }
    .hero-detail strong { font-weight: 600; }
    .hero-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      text-align: center;
    }
    .hero-stat-value { font-size: 28px; font-weight: 700; }
    .hero-stat-label { font-size: 11px; opacity: 0.85; margin-top: 4px; }

    /* Grid Layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 24px;
    }
    .full-width { grid-column: 1 / -1; }

    /* Cards - Unified Design System */
    .card {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
      transition: box-shadow var(--transition);
    }
    .card:hover { box-shadow: var(--shadow-md); }
    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-title { font-size: 14px; font-weight: 600; color: var(--gray-900); }
    .card-subtitle { font-size: 12px; color: var(--gray-500); }
    .card-body { padding: 16px 20px; }
    .card-body.no-padding { padding: 0; }

    /* Optimization Categories */
    .optimization-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    .opt-card {
      background: white;
      border-radius: var(--radius-md);
      padding: 16px;
      border: 1px solid var(--gray-200);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .opt-card:hover { border-color: var(--primary); box-shadow: var(--shadow-md); }
    .opt-card.active { border-color: var(--primary); background: var(--primary-50); }
    .opt-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      font-size: 18px;
    }
    .opt-icon.retirement { background: #dbeafe; color: #1e40af; }
    .opt-icon.deductions { background: #d1fae5; color: #059669; }
    .opt-icon.credits { background: #fef3c7; color: #d97706; }
    .opt-icon.qbi { background: #ede9fe; color: #7c3aed; }
    .opt-icon.investment { background: #fce7f3; color: #db2777; }
    .opt-label { font-size: 12px; font-weight: 500; color: var(--gray-700); margin-bottom: 4px; }
    .opt-value { font-size: 18px; font-weight: 700; color: var(--gray-900); }
    .opt-count { font-size: 11px; color: var(--gray-500); margin-top: 4px; }

    /* Insights Feed */
    .insight-item {
      padding: 14px 20px;
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      gap: 12px;
      cursor: pointer;
      transition: background var(--transition-fast);
    }
    .insight-item:hover { background: var(--gray-50); }
    .insight-item:last-child { border-bottom: none; }
    .insight-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .insight-icon.savings { background: var(--success-light); color: var(--success); }
    .insight-icon.warning { background: var(--warning-light); color: var(--warning); }
    .insight-icon.info { background: var(--info-light); color: var(--info); }
    .insight-icon.critical { background: var(--error-light); color: var(--error); }
    .insight-content { flex: 1; min-width: 0; }
    .insight-title { font-size: 13px; font-weight: 600; color: var(--gray-900); margin-bottom: 2px; }
    .insight-desc { font-size: 12px; color: var(--gray-600); line-height: 1.4; }
    .insight-meta { display: flex; gap: 12px; margin-top: 6px; }
    .insight-tag {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      background: var(--gray-100);
      color: var(--gray-600);
      font-weight: 500;
    }
    .insight-tag.irs { background: var(--accent-light); color: var(--accent); }
    .insight-amount {
      font-size: 14px;
      font-weight: 700;
      color: var(--success);
      margin-left: auto;
      white-space: nowrap;
    }

    /* Client Pipeline */
    .client-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      border-bottom: 1px solid var(--gray-100);
      cursor: pointer;
      transition: background var(--transition-fast);
    }
    .client-row:hover { background: var(--gray-50); }
    .client-row:last-child { border-bottom: none; }
    .client-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary-light);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 13px;
      flex-shrink: 0;
    }
    .client-info { flex: 1; min-width: 0; }
    .client-name { font-size: 13px; font-weight: 600; color: var(--gray-900); }
    .client-detail { font-size: 11px; color: var(--gray-500); margin-top: 1px; }
    .client-savings {
      text-align: right;
    }
    .savings-amount { font-size: 15px; font-weight: 700; color: var(--success); }
    .savings-label { font-size: 10px; color: var(--gray-500); }
    .client-action {
      opacity: 0;
      transition: opacity var(--transition-fast);
    }
    .client-row:hover .client-action { opacity: 1; }

    /* Risk Alerts */
    .alert-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px 16px;
      background: var(--error-light);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
    }
    .alert-item:last-child { margin-bottom: 0; }
    .alert-item.warning { background: var(--warning-light); }
    .alert-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
    .alert-content { flex: 1; }
    .alert-title { font-size: 12px; font-weight: 600; color: var(--gray-900); }
    .alert-desc { font-size: 11px; color: var(--gray-600); margin-top: 2px; }

    /* Stats Row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: white;
      border-radius: var(--radius-md);
      padding: 16px 20px;
      border: 1px solid var(--gray-200);
    }
    .stat-label { font-size: 12px; color: var(--gray-500); margin-bottom: 4px; }
    .stat-value { font-size: 24px; font-weight: 700; color: var(--gray-900); }
    .stat-change { font-size: 11px; color: var(--success); margin-top: 4px; }
    .stat-change.negative { color: var(--error); }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray-500);
    }
    .empty-icon { font-size: 32px; margin-bottom: 12px; opacity: 0.5; }
    .empty-title { font-size: 14px; font-weight: 600; color: var(--gray-700); margin-bottom: 4px; }
    .empty-desc { font-size: 12px; margin-bottom: 16px; }

    /* Scrollable Content */
    .scrollable { max-height: 400px; overflow-y: auto; }

    /* View Toggle */
    .view { display: none; }
    .view.active { display: block; }

    /* Toast */
    .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 1000; }
    .toast {
      background: var(--gray-900);
      color: white;
      padding: 12px 20px;
      border-radius: var(--radius-md);
      margin-top: 8px;
      font-size: 13px;
      box-shadow: var(--shadow-lg);
      animation: slideIn 0.3s ease;
    }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--error); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* Recommendation Detail Panel */
    .detail-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 480px;
      height: 100vh;
      background: white;
      box-shadow: -4px 0 20px rgba(0,0,0,0.1);
      z-index: 100;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .detail-panel.active { transform: translateX(0); }
    .panel-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .panel-title { font-size: 16px; font-weight: 600; }
    .panel-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--gray-100);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .panel-body { flex: 1; overflow-y: auto; padding: 24px; }
    .panel-section { margin-bottom: 24px; }
    .panel-section-title { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--gray-500); margin-bottom: 12px; }
    .panel-footer { padding: 16px 24px; border-top: 1px solid var(--gray-200); }

    /* IRS Reference */
    .irs-ref {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--accent);
      background: var(--accent-light);
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 500;
    }

    /* Action Steps */
    .action-step {
      display: flex;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--gray-100);
    }
    .action-step:last-child { border-bottom: none; }
    .step-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .step-content { flex: 1; }
    .step-title { font-size: 13px; font-weight: 500; color: var(--gray-900); }
    .step-desc { font-size: 12px; color: var(--gray-500); margin-top: 2px; }

    /* ============================================= */
    /* ENHANCED UI/UX STYLES                        */
    /* ============================================= */

    /* Loading States */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border-radius: inherit;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .loading-spinner.sm { width: 20px; height: 20px; border-width: 2px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Skeleton Loaders */
    .skeleton {
      background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-sm);
    }
    .skeleton-text { height: 14px; margin-bottom: 8px; }
    .skeleton-text.lg { height: 24px; }
    .skeleton-text.sm { height: 10px; }
    .skeleton-avatar { width: 40px; height: 40px; border-radius: 50%; }
    .skeleton-card { height: 100px; border-radius: var(--radius-md); }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* Progress Bars */
    .progress-bar {
      height: 6px;
      background: var(--gray-200);
      border-radius: 3px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 3px;
      transition: width 0.5s ease;
    }
    .progress-bar-fill.animated {
      animation: progressPulse 2s ease-in-out infinite;
    }
    @keyframes progressPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Status Indicators */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }
    .status-dot.success { background: var(--success); }
    .status-dot.warning { background: var(--warning); }
    .status-dot.error { background: var(--error); }
    .status-dot.info { background: var(--info); }
    .status-dot.pending { background: var(--gray-400); animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.1); }
    }

    /* Enhanced Buttons */
    .btn.loading {
      position: relative;
      color: transparent;
      pointer-events: none;
    }
    .btn.loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin: -8px 0 0 -8px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    .btn.loading::after { border-top-color: white; }

    /* Tooltips */
    .tooltip {
      position: relative;
    }
    .tooltip::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 10px;
      background: var(--gray-900);
      color: white;
      font-size: 11px;
      border-radius: var(--radius-sm);
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-fast);
      margin-bottom: 6px;
      z-index: 100;
    }
    .tooltip:hover::before { opacity: 1; visibility: visible; }

    /* Enhanced Cards with Hover */
    .card-interactive {
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .card-interactive:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* Metric Cards Enhanced */
    .metric-card {
      position: relative;
      overflow: hidden;
    }
    .metric-card::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 60px;
      height: 60px;
      background: var(--primary);
      opacity: 0.1;
      border-radius: 50%;
      transform: translate(30%, -30%);
    }

    /* Animated Counters */
    .animate-number {
      transition: all 0.5s ease;
    }

    /* Fade In Animation */
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Slide Up Animation */
    .slide-up {
      animation: slideUp 0.4s ease;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Staggered Animation */
    .stagger-item { opacity: 0; animation: fadeIn 0.3s ease forwards; }
    .stagger-item:nth-child(1) { animation-delay: 0ms; }
    .stagger-item:nth-child(2) { animation-delay: 50ms; }
    .stagger-item:nth-child(3) { animation-delay: 100ms; }
    .stagger-item:nth-child(4) { animation-delay: 150ms; }
    .stagger-item:nth-child(5) { animation-delay: 200ms; }
    .stagger-item:nth-child(6) { animation-delay: 250ms; }

    /* Pipeline Card Styles */
    .pipeline-card {
      background: white;
      border-radius: var(--radius-md);
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: var(--shadow-sm);
      border-left: 3px solid var(--gray-300);
      transition: all 0.2s ease;
      cursor: grab;
    }
    .pipeline-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    .pipeline-card.high-value { border-left-color: var(--success); }
    .pipeline-card.engaged { border-left-color: var(--info); }
    .pipeline-card.ready { border-left-color: var(--warning); }

    /* Empty States Enhanced */
    .empty-state {
      text-align: center;
      padding: 48px 20px;
      color: var(--gray-500);
    }
    .empty-state-icon {
      width: 64px;
      height: 64px;
      background: var(--gray-100);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 24px;
    }

    /* Modal/Dialog */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }
    .modal-backdrop.active { opacity: 1; visibility: visible; }
    .modal {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      transform: scale(0.9);
      transition: transform 0.2s ease;
    }
    .modal-backdrop.active .modal { transform: scale(1); }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-body { padding: 24px; max-height: 60vh; overflow-y: auto; }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Success Animation */
    .success-check {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--success);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      animation: successPop 0.4s ease;
    }
    .success-check::after {
      content: '\2713';
      color: white;
      font-size: 28px;
      font-weight: bold;
    }
    @keyframes successPop {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    /* Input Focus States */
    select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }

    /* Drag and Drop Enhanced */
    .drop-zone-active {
      border-color: var(--primary) !important;
      background: var(--primary-50) !important;
    }

    /* Badge Animations */
    .nav-badge.pulse {
      animation: badgePulse 2s infinite;
    }
    @keyframes badgePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Data Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--gray-500);
      border-bottom: 1px solid var(--gray-200);
    }
    .data-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--gray-100);
    }
    .data-table tr:hover { background: var(--gray-50); }

    /* Comparison Cards */
    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 16px;
      align-items: center;
    }
    .comparison-vs {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--gray-600);
      font-size: 12px;
    }

    /* Responsive Adjustments */
    @media (max-width: 1200px) {
      .dashboard-grid { grid-template-columns: 1fr; }
      .optimization-grid { grid-template-columns: repeat(3, 1fr); }
      .pipeline-board { grid-template-columns: repeat(3, 1fr) !important; }
    }

    /* Mobile Header - Hidden by default */
    .mobile-header {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: var(--primary);
      z-index: 1001;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .mobile-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mobile-logo-icon {
      width: 32px;
      height: 32px;
      background: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      color: var(--primary);
    }

    .mobile-logo-text {
      font-weight: 600;
      color: white;
      font-size: 14px;
    }

    .hamburger-btn {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 8px;
      gap: 5px;
    }

    .hamburger-line {
      width: 22px;
      height: 2px;
      background: white;
      border-radius: 2px;
      transition: all 0.3s ease;
    }

    .hamburger-btn.active .hamburger-line:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    .hamburger-btn.active .hamburger-line:nth-child(2) {
      opacity: 0;
    }
    .hamburger-btn.active .hamburger-line:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }

    /* Sidebar overlay for mobile */
    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sidebar-overlay.active {
      display: block;
      opacity: 1;
    }

    /* Tablet breakpoint */
    @media (max-width: 1024px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 1000;
        width: 260px !important;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0 !important;
        padding-top: 72px;
      }

      .mobile-header {
        display: flex !important;
      }
    }

    /* Mobile breakpoint */
    @media (max-width: 768px) {
      .optimization-grid { grid-template-columns: repeat(2, 1fr); }
      .pipeline-board { grid-template-columns: 1fr !important; }

      .main-content {
        padding: 72px 12px 16px 12px;
      }

      .card {
        padding: 16px;
      }

      .view-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .view-header h1 {
        font-size: 20px;
      }

      .btn {
        padding: 10px 16px;
        font-size: 14px;
      }

      /* Make tables scrollable */
      .data-table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Stack filter controls */
      .filter-bar {
        flex-direction: column;
        gap: 8px;
      }

      .filter-bar select,
      .filter-bar input {
        width: 100%;
      }

      /* Pipeline cards stack vertically */
      .pipeline-stage {
        min-width: auto;
      }

      /* Sidebar open state shows all text */
      .sidebar.open .logo-text,
      .sidebar.open .logo-subtitle,
      .sidebar.open .nav-section-label,
      .sidebar.open .nav-item span {
        display: block;
      }
    }

    /* Small mobile */
    @media (max-width: 480px) {
      .optimization-grid { grid-template-columns: 1fr; }

      .stat-card {
        padding: 12px;
      }

      .stat-value {
        font-size: 24px;
      }

      .mobile-header {
        padding: 0 12px;
      }

      .view-header h1 {
        font-size: 18px;
      }
    }

    /* =========================================================================== */
    /* SMART ONBOARDING & MODAL STYLES */
    /* =========================================================================== */

    /* Onboarding Step Labels */
    .onboard-step-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--gray-400);
      transition: all 0.2s ease;
    }
    .onboard-step-label.active {
      color: var(--primary);
      font-weight: 600;
    }
    .onboard-step-label.completed {
      color: var(--success);
    }

    /* Onboard Steps */
    .onboard-step {
      animation: fadeIn 0.3s ease;
    }

    /* Smart Question Card */
    .smart-question {
      background: var(--gray-50);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 12px;
      border-left: 3px solid var(--primary);
    }
    .smart-question-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .smart-question-text {
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-900);
      flex: 1;
    }
    .smart-question-savings {
      font-size: 12px;
      font-weight: 600;
      color: var(--success);
      background: var(--success-light);
      padding: 2px 8px;
      border-radius: 12px;
      white-space: nowrap;
      margin-left: 12px;
    }
    .smart-question-options {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .smart-question-option {
      padding: 8px 16px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-md);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .smart-question-option:hover {
      border-color: var(--primary);
      background: var(--primary-50);
    }
    .smart-question-option.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Opportunity Card */
    .opportunity-card {
      background: white;
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid var(--gray-200);
      display: flex;
      align-items: flex-start;
      gap: 14px;
    }
    .opportunity-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    .opportunity-icon.retirement { background: #dbeafe; color: #1e40af; }
    .opportunity-icon.deductions { background: #d1fae5; color: #059669; }
    .opportunity-icon.credits { background: #fef3c7; color: #d97706; }
    .opportunity-icon.healthcare { background: #ede9fe; color: #7c3aed; }
    .opportunity-content { flex: 1; }
    .opportunity-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 4px;
    }
    .opportunity-desc {
      font-size: 12px;
      color: var(--gray-600);
      line-height: 1.4;
    }
    .opportunity-savings {
      font-size: 16px;
      font-weight: 700;
      color: var(--success);
      white-space: nowrap;
    }

    /* Tab Buttons */
    .tab-btn {
      background: none;
      border: none;
      padding: 14px 0;
      font-size: 13px;
      font-weight: 500;
      color: var(--gray-500);
      cursor: pointer;
      position: relative;
      transition: color 0.2s ease;
    }
    .tab-btn:hover { color: var(--gray-900); }
    .tab-btn.active {
      color: var(--primary);
    }
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--primary);
      border-radius: 2px 2px 0 0;
    }

    /* Focus Cards for Practice Setup */
    .focus-card input:checked + span { color: var(--primary); }
    .focus-card:has(input:checked) {
      border-color: var(--primary);
      background: var(--primary-50);
    }

    /* Stats Row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: white;
      border-radius: var(--radius-md);
      padding: 16px;
      border: 1px solid var(--gray-200);
    }
    .stat-label {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--gray-500);
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--gray-900);
      margin-top: 4px;
    }

    /* Dropzone Active State */
    .dropzone:hover, .dropzone.drop-zone-active {
      border-color: var(--primary);
      background: var(--primary-50);
    }

    /* Command Palette */
    .command-palette-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding-top: 15vh;
    }
    .command-palette-backdrop.active { display: flex; }
    .command-palette {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      width: 100%;
      max-width: 560px;
      overflow: hidden;
    }
    .command-palette-input {
      width: 100%;
      padding: 16px 20px;
      border: none;
      border-bottom: 1px solid var(--gray-200);
      font-size: 16px;
      outline: none;
    }
    .command-palette-input::placeholder { color: var(--gray-400); }
    .command-palette-results {
      max-height: 360px;
      overflow-y: auto;
    }
    .command-palette-section {
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--gray-50);
    }
    .command-palette-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      cursor: pointer;
      transition: background var(--transition);
    }
    .command-palette-item:hover, .command-palette-item.selected {
      background: var(--primary-50);
    }
    .command-palette-item-icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      background: var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .command-palette-item-content { flex: 1; }
    .command-palette-item-title { font-weight: 500; color: var(--gray-900); }
    .command-palette-item-desc { font-size: 12px; color: var(--gray-500); }
    .command-palette-shortcut {
      font-size: 11px;
      padding: 2px 6px;
      background: var(--gray-100);
      border-radius: 4px;
      color: var(--gray-600);
    }
    .command-palette-empty {
      padding: 32px;
      text-align: center;
      color: var(--gray-500);
    }
    .command-palette-hint {
      padding: 12px 20px;
      font-size: 12px;
      color: var(--gray-500);
      border-top: 1px solid var(--gray-100);
      display: flex;
      gap: 16px;
    }
    .command-palette-hint kbd {
      padding: 2px 6px;
      background: var(--gray-100);
      border-radius: 4px;
      font-family: inherit;
    }

    /* ============ PRINT STYLES FOR ADVISORY REPORTS ============ */
    @media print {
      /* Hide navigation and non-essential UI */
      .sidebar, .top-bar, .command-palette, .toast-container,
      .btn:not(.print-visible), nav, header {
        display: none !important;
      }

      /* Full width for content */
      .main-content, .app-layout {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        max-width: none !important;
      }

      /* Clean card styling for print */
      .card {
        box-shadow: none !important;
        border: 1px solid #ddd !important;
        page-break-inside: avoid;
        margin-bottom: 20px !important;
      }

      /* Report header styling */
      .report-header {
        text-align: center;
        border-bottom: 2px solid #333;
        padding-bottom: 20px;
        margin-bottom: 30px;
      }

      /* Section headings */
      h1, h2, h3 {
        page-break-after: avoid;
        color: #000 !important;
      }

      /* Tables print friendly */
      table {
        border-collapse: collapse;
        width: 100%;
      }
      table th, table td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
      }

      /* Ensure text is black for print */
      body, p, span, div {
        color: #000 !important;
      }

      /* Hide action buttons in printed report */
      .action-buttons, .report-actions {
        display: none !important;
      }

      /* Page breaks for sections */
      .report-section {
        page-break-inside: avoid;
      }

      /* Footer with page numbers */
      @page {
        margin: 0.75in;
        @bottom-center {
          content: "Page " counter(page) " of " counter(pages);
        }
      }
    }

    /* Print button styling (visible on screen, hidden in print) */
    .btn-print {
      background: var(--gray-100);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }
    .btn-print:hover {
      background: var(--gray-200);
    }
  </style>
</head>
<body>
  <!-- Mobile Header -->
  <header class="mobile-header">
    <button class="hamburger-btn" id="hamburger-btn" onclick="toggleSidebar()" aria-label="Toggle navigation menu">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
    <div class="mobile-logo">
      <div class="mobile-logo-icon">CA</div>
      <span class="mobile-logo-text">CA4CPA GLOBAL</span>
    </div>
    <div style="width: 40px;"></div>
  </header>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="logo-mark" style="background: linear-gradient(135deg, #1e40af, #3b82f6);">CA</div>
          <div>
            <div class="logo-text">CA4CPA GLOBAL</div>
            <div class="logo-subtitle">Tax Advisory Intelligence</div>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav" aria-label="Main navigation">
        <div class="nav-section" role="group" aria-labelledby="nav-advisory-label">
          <div class="nav-section-label" id="nav-advisory-label">Advisory Intelligence</div>
          <a class="nav-item active" data-view="dashboard" onclick="switchView('dashboard')" role="button" tabindex="0">
            <span>Dashboard</span>
          </a>
          <a class="nav-item" data-view="insights" onclick="switchView('insights')" role="button" tabindex="0">
            <span>CPA Review Signals</span>
            <span class="nav-badge" id="insights-badge" aria-label="0 signals">0</span>
          </a>
          <a class="nav-item" data-view="scenarios" onclick="switchView('scenarios')" role="button" tabindex="0">
            <span>Scenario Workspace</span>
          </a>
          <a class="nav-item" data-view="advisory-tools" onclick="switchView('advisory-tools')" role="button" tabindex="0">
            <span>Analysis Workspace</span>
          </a>
        </div>
        <div class="nav-section" role="group" aria-labelledby="nav-leads-label">
          <div class="nav-section-label" id="nav-leads-label">Lead Management</div>
          <a class="nav-item" data-view="pipeline" onclick="switchView('pipeline')" role="button" tabindex="0">
            <span>Lead Pipeline</span>
            <span class="nav-badge" id="pipeline-badge" aria-label="0 leads">0</span>
          </a>
          <a class="nav-item" data-view="intake" onclick="switchView('intake')" role="button" tabindex="0">
            <span>Intake</span>
          </a>
        </div>
        <div class="nav-section" role="group" aria-labelledby="nav-engagements-label">
          <div class="nav-section-label" id="nav-engagements-label">Engagements</div>
          <a class="nav-item" data-view="clients" onclick="switchView('clients')" role="button" tabindex="0">
            <span>Engaged Clients</span>
          </a>
          <a class="nav-item" data-view="documents" onclick="switchView('documents')" role="button" tabindex="0">
            <span>Document Center</span>
          </a>
          <a class="nav-item" data-view="review" onclick="switchView('review')" role="button" tabindex="0">
            <span>Review Queue</span>
            <span class="nav-badge alert" id="review-badge">0</span>
          </a>
        </div>
        <div class="nav-section">
          <div class="nav-section-label">Compliance</div>
          <a class="nav-item" data-view="risks" onclick="switchView('risks')">
            <span>Complexity & Risks</span>
            <span class="nav-badge alert" id="risk-badge">0</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard View -->
      <div class="view active" id="view-dashboard">
        <div class="page-header">
          <div>
            <h1 class="page-title">Advisory Intelligence Dashboard</h1>
            <p class="page-subtitle">Tax Year 2025 | CPA-led advisory leverage identification</p>
          </div>
          <div class="header-actions">
            <button class="btn btn-ghost" onclick="refreshData()">Refresh</button>
            <button class="btn btn-primary" onclick="switchView('clients')">+ Add Client</button>
          </div>
        </div>

        <!-- Advisory Surface Indicator -->
        <div class="advisory-surface-card" style="background:linear-gradient(135deg, #1f2937 0%, #374151 100%);border-radius:var(--radius-lg);padding:24px 32px;color:white;margin-bottom:24px;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <h2 style="font-size:14px;font-weight:500;opacity:0.9;margin-bottom:8px;">Advisory Surface Identified</h2>
            <div style="font-size:32px;font-weight:700;" id="advisory-surface-level">Analyzing...</div>
            <div style="font-size:13px;opacity:0.85;margin-top:8px;">
              <strong id="leads-ready-count">0</strong> leads ready for CPA review
            </div>
          </div>
          <div style="display:flex;gap:32px;text-align:center;">
            <div>
              <div style="font-size:24px;font-weight:700;" id="stat-high-leverage">0</div>
              <div style="font-size:11px;opacity:0.85;margin-top:4px;">High Leverage</div>
            </div>
            <div>
              <div style="font-size:24px;font-weight:700;" id="stat-needs-review">0</div>
              <div style="font-size:11px;opacity:0.85;margin-top:4px;">Needs Review</div>
            </div>
            <div>
              <div style="font-size:24px;font-weight:700;" id="stat-complexity">0</div>
              <div style="font-size:11px;opacity:0.85;margin-top:4px;">Complex Cases</div>
            </div>
          </div>
        </div>

        <!-- Advisory Opportunity Areas (CPA Review Required) -->
        <div class="optimization-grid">
          <div class="opt-card" onclick="filterByCategory('retirement')">
            <div class="opt-icon retirement">401k</div>
            <div class="opt-label">Retirement</div>
            <div class="opt-value" id="opt-retirement-level" style="font-size:14px;color:var(--gray-600);">—</div>
            <div class="opt-count"><span id="opt-retirement-count">0</span> signals</div>
          </div>
          <div class="opt-card" onclick="filterByCategory('deductions')">
            <div class="opt-icon deductions">§</div>
            <div class="opt-label">Deductions</div>
            <div class="opt-value" id="opt-deductions-level" style="font-size:14px;color:var(--gray-600);">—</div>
            <div class="opt-count"><span id="opt-deductions-count">0</span> signals</div>
          </div>
          <div class="opt-card" onclick="filterByCategory('credits')">
            <div class="opt-icon credits">✓</div>
            <div class="opt-label">Credits</div>
            <div class="opt-value" id="opt-credits-level" style="font-size:14px;color:var(--gray-600);">—</div>
            <div class="opt-count"><span id="opt-credits-count">0</span> signals</div>
          </div>
          <div class="opt-card" onclick="filterByCategory('qbi')">
            <div class="opt-icon qbi">199A</div>
            <div class="opt-label">QBI (Sec 199A)</div>
            <div class="opt-value" id="opt-qbi-level" style="font-size:14px;color:var(--gray-600);">—</div>
            <div class="opt-count"><span id="opt-qbi-count">0</span> signals</div>
          </div>
          <div class="opt-card" onclick="filterByCategory('investment')">
            <div class="opt-icon investment">TLH</div>
            <div class="opt-label">Investment</div>
            <div class="opt-value" id="opt-investment-level" style="font-size:14px;color:var(--gray-600);">—</div>
            <div class="opt-count"><span id="opt-investment-count">0</span> signals</div>
          </div>
        </div>
        <div style="font-size:11px;color:var(--gray-500);text-align:center;margin:-16px 0 24px 0;">Advisory Opportunity Areas — CPA Review Required</div>

        <!-- Two Column Layout -->
        <div class="dashboard-grid">
          <!-- Left: CPA Review Signals -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">CPA Review Signals</div>
                <div class="card-subtitle">Areas requiring professional review</div>
              </div>
              <button class="btn btn-ghost btn-sm" onclick="switchView('insights')">View All</button>
            </div>
            <div class="card-body no-padding scrollable" id="top-insights">
              <div class="empty-state">
                <div class="empty-icon">$</div>
                <div class="empty-title">Loading insights...</div>
              </div>
            </div>
          </div>

          <!-- Right: High Leverage Leads -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">High Leverage Leads</div>
                <div class="card-subtitle">Prioritized by advisory surface</div>
              </div>
            </div>
            <div class="card-body no-padding scrollable" id="high-value-clients">
              <div class="empty-state">
                <div class="empty-icon">◎</div>
                <div class="empty-title">No leads yet</div>
                <button class="btn btn-primary btn-sm" onclick="switchView('pipeline')">View Pipeline</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- CPA Review Signals View -->
      <div class="view" id="view-insights">
        <div class="page-header">
          <div>
            <h1 class="page-title">CPA Review Signals</h1>
            <p class="page-subtitle">Areas identified for professional review with IRS compliance references</p>
          </div>
        </div>
        <div class="card">
          <div class="card-body no-padding" id="all-insights">
            <div class="empty-state">
              <div class="empty-title">Loading signals...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Engaged Clients View -->
      <div class="view" id="view-clients">
        <div class="page-header">
          <div>
            <h1 class="page-title">Engaged Clients</h1>
            <p class="page-subtitle">Clients with active engagements</p>
          </div>
        </div>
        <div class="card">
          <div class="card-body no-padding" id="clients-list">
            <div class="empty-state">
              <div class="empty-title">Loading clients...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Review Queue View -->
      <div class="view" id="view-review">
        <div class="page-header">
          <div>
            <h1 class="page-title">Review Queue</h1>
            <p class="page-subtitle">Returns pending CPA review and approval</p>
          </div>
        </div>
        <div class="dashboard-grid">
          <div class="card">
            <div class="card-body no-padding" id="review-queue">
              <div class="empty-state">
                <div class="empty-title">No returns pending review</div>
              </div>
            </div>
          </div>
          <div class="card" id="review-detail-card" style="display:none;">
            <div class="card-header">
              <div class="card-title">Review Details</div>
            </div>
            <div class="card-body" id="review-detail-content"></div>
          </div>
        </div>
      </div>

      <!-- Complexity & Risks View -->
      <div class="view" id="view-risks">
        <div class="page-header">
          <div>
            <h1 class="page-title">Complexity & Risks</h1>
            <p class="page-subtitle">Complexity signals requiring CPA attention</p>
          </div>
        </div>
        <div class="card">
          <div class="card-body" id="risk-alerts">
            <div class="empty-state">
              <div class="empty-title">No risk alerts</div>
              <div class="empty-desc">All returns are compliance-ready</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Scenario Workspace View -->
      <div class="view" id="view-scenarios">
        <div class="page-header">
          <div>
            <h1 class="page-title">Scenario Workspace</h1>
            <p class="page-subtitle">Compare scenarios using CPA-curated templates</p>
          </div>
        </div>

        <!-- Client Selector -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header">
            <div class="card-title">Select Client for Analysis</div>
          </div>
          <div class="card-body">
            <select id="scenario-client-select" class="form-select" style="width:100%;padding:10px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:13px" onchange="loadScenarioTemplates()">
              <option value="">-- Select a Client --</option>
            </select>
          </div>
        </div>

        <!-- Scenario Templates -->
        <div class="card" style="margin-bottom:20px" id="scenario-templates-card" style="display:none">
          <div class="card-header">
            <div class="card-title">Pre-Built Scenario Templates</div>
            <div class="card-subtitle">Quick comparisons for common tax strategies</div>
          </div>
          <div class="card-body">
            <div class="optimization-grid" id="scenario-templates">
              <div class="opt-card" onclick="runQuickScenario('max_401k')">
                <div class="opt-icon retirement">401k</div>
                <div class="opt-label">Max 401(k)</div>
                <div class="opt-count">$23,500 contribution</div>
              </div>
              <div class="opt-card" onclick="runQuickScenario('max_ira')">
                <div class="opt-icon retirement">IRA</div>
                <div class="opt-label">Max IRA</div>
                <div class="opt-count">$7,000 contribution</div>
              </div>
              <div class="opt-card" onclick="runQuickScenario('max_hsa')">
                <div class="opt-icon retirement">HSA</div>
                <div class="opt-label">Max HSA</div>
                <div class="opt-count">$4,150 individual</div>
              </div>
              <div class="opt-card" onclick="runQuickScenario('charitable_bunching')">
                <div class="opt-icon deductions">Char</div>
                <div class="opt-label">Charitable Bunch</div>
                <div class="opt-count">2-year strategy</div>
              </div>
              <div class="opt-card" onclick="runQuickScenario('home_office')">
                <div class="opt-icon deductions">Home</div>
                <div class="opt-label">Home Office</div>
                <div class="opt-count">Simplified method</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Scenario Results -->
        <div class="card" id="scenario-results-card" style="display:none">
          <div class="card-header">
            <div class="card-title">Scenario Comparison Results</div>
          </div>
          <div class="card-body" id="scenario-results">
            <!-- Results will be populated dynamically -->
          </div>
        </div>
      </div>

      <!-- Lead Pipeline View -->
      <div class="view" id="view-pipeline">
        <div class="page-header">
          <div>
            <h1 class="page-title">Lead Pipeline</h1>
            <p class="page-subtitle">Track prospects from discovery to conversion</p>
          </div>
          <div class="header-actions">
            <button class="btn btn-ghost" onclick="loadPipeline()">Refresh</button>
          </div>
        </div>

        <!-- Pipeline Metrics -->
        <div class="stats-row" id="pipeline-metrics">
          <div class="stat-card">
            <div class="stat-label">Total Leads</div>
            <div class="stat-value" id="metric-total-leads">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Conversion Rate</div>
            <div class="stat-value" id="metric-conversion">0%</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg. Days to Convert</div>
            <div class="stat-value" id="metric-velocity">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Monetizable Value</div>
            <div class="stat-value" id="metric-monetizable">$0</div>
          </div>
        </div>

        <!-- Kanban Pipeline -->
        <div class="pipeline-board" id="pipeline-board" style="display:grid;grid-template-columns:repeat(5,1fr);gap:16px;min-height:500px">
          <div class="pipeline-column" data-state="ANONYMOUS" style="background:var(--gray-100);border-radius:var(--radius-lg);padding:12px">
            <div style="font-weight:600;font-size:13px;margin-bottom:12px;color:var(--gray-700)">Anonymous <span class="nav-badge" id="col-anonymous">0</span></div>
            <div class="pipeline-cards" id="cards-anonymous"></div>
          </div>
          <div class="pipeline-column" data-state="IDENTIFIED" style="background:var(--gray-100);border-radius:var(--radius-lg);padding:12px">
            <div style="font-weight:600;font-size:13px;margin-bottom:12px;color:var(--gray-700)">Identified <span class="nav-badge" id="col-identified">0</span></div>
            <div class="pipeline-cards" id="cards-identified"></div>
          </div>
          <div class="pipeline-column" data-state="ENGAGED" style="background:var(--info-light);border-radius:var(--radius-lg);padding:12px">
            <div style="font-weight:600;font-size:13px;margin-bottom:12px;color:var(--info)">Engaged <span class="nav-badge" id="col-engaged">0</span></div>
            <div class="pipeline-cards" id="cards-engaged"></div>
          </div>
          <div class="pipeline-column" data-state="ADVISORY_READY" style="background:var(--warning-light);border-radius:var(--radius-lg);padding:12px">
            <div style="font-weight:600;font-size:13px;margin-bottom:12px;color:var(--warning)">Advisory Ready <span class="nav-badge" id="col-advisory-ready">0</span></div>
            <div class="pipeline-cards" id="cards-advisory-ready"></div>
          </div>
          <div class="pipeline-column" data-state="CONVERTED" style="background:var(--success-light);border-radius:var(--radius-lg);padding:12px">
            <div style="font-weight:600;font-size:13px;margin-bottom:12px;color:var(--success)">Converted <span class="nav-badge" id="col-converted">0</span></div>
            <div class="pipeline-cards" id="cards-converted"></div>
          </div>
        </div>
      </div>

      <!-- Analysis Workspace View -->
      <div class="view" id="view-advisory-tools">
        <div class="page-header">
          <div>
            <h1 class="page-title">Analysis Workspace</h1>
            <p class="page-subtitle">CPA-directed tax analysis tools</p>
          </div>
        </div>

        <!-- Client Selector -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header">
            <div class="card-title">Select Client</div>
          </div>
          <div class="card-body">
            <select id="advisory-client-select" class="form-select" style="width:100%;padding:10px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:13px" onchange="updateAdvisoryTools()">
              <option value="">-- Select a Client --</option>
            </select>
          </div>
        </div>

        <!-- Tool Grid -->
        <div class="optimization-grid" style="grid-template-columns:repeat(3,1fr);gap:20px" id="advisory-tools-grid">
          <div class="opt-card" style="padding:24px;cursor:pointer" onclick="runCreditAnalysis()">
            <div class="opt-icon credits" style="width:48px;height:48px;font-size:24px">+</div>
            <div class="opt-label" style="font-size:14px;margin-top:12px">Credit Analysis</div>
            <div class="opt-count" style="margin-top:8px">Identify all eligible tax credits</div>
            <button class="btn btn-primary btn-sm" style="margin-top:16px;width:100%">Analyze Credits</button>
          </div>
          <div class="opt-card" style="padding:24px;cursor:pointer" onclick="runDeductionAnalysis()">
            <div class="opt-icon deductions" style="width:48px;height:48px;font-size:24px">-</div>
            <div class="opt-label" style="font-size:14px;margin-top:12px">Deduction Analysis</div>
            <div class="opt-count" style="margin-top:8px">Optimize deductions and strategies</div>
            <button class="btn btn-primary btn-sm" style="margin-top:16px;width:100%">Analyze Deductions</button>
          </div>
          <div class="opt-card" style="padding:24px;cursor:pointer" onclick="runFilingStatusAnalysis()">
            <div class="opt-icon" style="width:48px;height:48px;font-size:24px;background:#fce7f3;color:#db2777">FS</div>
            <div class="opt-label" style="font-size:14px;margin-top:12px">Filing Status Compare</div>
            <div class="opt-count" style="margin-top:8px">Compare MFJ, MFS, HOH options</div>
            <button class="btn btn-primary btn-sm" style="margin-top:16px;width:100%">Compare Status</button>
          </div>
          <div class="opt-card" style="padding:24px;cursor:pointer" onclick="runEntityAnalysis()">
            <div class="opt-icon qbi" style="width:48px;height:48px;font-size:24px">LLC</div>
            <div class="opt-label" style="font-size:14px;margin-top:12px">Entity Structure</div>
            <div class="opt-count" style="margin-top:8px">Compare LLC, S-Corp, C-Corp</div>
            <button class="btn btn-primary btn-sm" style="margin-top:16px;width:100%">Compare Entities</button>
          </div>
          <div class="opt-card" style="padding:24px;cursor:pointer" onclick="runFullStrategy()">
            <div class="opt-icon" style="width:48px;height:48px;font-size:24px;background:#dbeafe;color:#1e40af">AI</div>
            <div class="opt-label" style="font-size:14px;margin-top:12px">Full Strategy Report</div>
            <div class="opt-count" style="margin-top:8px">Comprehensive tax strategy analysis</div>
            <button class="btn btn-primary btn-sm" style="margin-top:16px;width:100%">Generate Strategy</button>
          </div>
          <div class="opt-card" style="padding:24px;cursor:pointer" onclick="generateAdvisoryReport()">
            <div class="opt-icon" style="width:48px;height:48px;font-size:24px;background:#d1fae5;color:#059669">PDF</div>
            <div class="opt-label" style="font-size:14px;margin-top:12px">Generate Report</div>
            <div class="opt-count" style="margin-top:8px">Client-ready advisory report</div>
            <button class="btn btn-primary btn-sm" style="margin-top:16px;width:100%">Generate Report</button>
          </div>
        </div>

        <!-- Results Panel -->
        <div class="card" style="margin-top:24px;display:none" id="advisory-results-card">
          <div class="card-header">
            <div class="card-title" id="advisory-results-title">Analysis Results</div>
          </div>
          <div class="card-body" id="advisory-results"></div>
        </div>
      </div>

      <!-- Document Center View -->
      <div class="view" id="view-documents">
        <div class="page-header">
          <div>
            <h1 class="page-title">Document Center</h1>
            <p class="page-subtitle">Upload and process client tax documents with OCR</p>
          </div>
        </div>

        <!-- Client Selector -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header">
            <div class="card-title">Select Client</div>
          </div>
          <div class="card-body">
            <select id="document-client-select" class="form-select" style="width:100%;padding:10px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:13px" onchange="loadClientDocuments()">
              <option value="">-- Select a Client --</option>
            </select>
          </div>
        </div>

        <!-- Upload Zone -->
        <div class="card" style="margin-bottom:20px" id="upload-card">
          <div class="card-header">
            <div class="card-title">Upload Documents</div>
          </div>
          <div class="card-body">
            <div id="upload-zone" style="border:2px dashed var(--gray-300);border-radius:var(--radius-lg);padding:40px;text-align:center;cursor:pointer;transition:all var(--transition-fast)" onclick="document.getElementById('file-input').click()" ondragover="event.preventDefault();this.style.borderColor='var(--primary)'" ondrop="handleFileDrop(event)">
              <input type="file" id="file-input" style="display:none" accept=".pdf,.png,.jpg,.jpeg" multiple onchange="handleFileUpload(event)">
              <div style="font-size:32px;margin-bottom:12px;opacity:0.5">+</div>
              <div style="font-weight:600;color:var(--gray-700)">Drop files here or click to upload</div>
              <div style="font-size:12px;color:var(--gray-500);margin-top:8px">Supports W-2, 1099, 1098, and other tax forms (PDF, PNG, JPG)</div>
            </div>
          </div>
        </div>

        <!-- Document List -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Uploaded Documents</div>
          </div>
          <div class="card-body no-padding" id="document-list">
            <div class="empty-state">
              <div class="empty-title">No documents uploaded</div>
              <div class="empty-desc">Select a client and upload tax documents</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pricing Calculator View -->
      <div class="view" id="view-pricing">
        <div class="page-header">
          <div>
            <h1 class="page-title">Pricing Calculator</h1>
            <p class="page-subtitle">Generate complexity-based pricing quotes for clients</p>
          </div>
        </div>

        <!-- Client Selector -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header">
            <div class="card-title">Select Client</div>
          </div>
          <div class="card-body">
            <select id="pricing-client-select" class="form-select" style="width:100%;padding:10px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:13px" onchange="calculatePricing()">
              <option value="">-- Select a Client --</option>
            </select>
          </div>
        </div>

        <!-- Pricing Tiers Reference -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header">
            <div class="card-title">Pricing Tiers</div>
          </div>
          <div class="card-body">
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px" id="pricing-tiers">
              <div style="padding:16px;background:var(--success-light);border-radius:var(--radius-md);text-align:center">
                <div style="font-weight:700;font-size:20px;color:var(--success)">$150-250</div>
                <div style="font-size:12px;color:var(--gray-600);margin-top:4px">Simple</div>
                <div style="font-size:10px;color:var(--gray-500);margin-top:4px">W-2 only, standard deduction</div>
              </div>
              <div style="padding:16px;background:var(--info-light);border-radius:var(--radius-md);text-align:center">
                <div style="font-weight:700;font-size:20px;color:var(--info)">$250-450</div>
                <div style="font-size:12px;color:var(--gray-600);margin-top:4px">Standard</div>
                <div style="font-size:10px;color:var(--gray-500);margin-top:4px">Itemized, investments</div>
              </div>
              <div style="padding:16px;background:var(--warning-light);border-radius:var(--radius-md);text-align:center">
                <div style="font-weight:700;font-size:20px;color:var(--warning)">$450-750</div>
                <div style="font-size:12px;color:var(--gray-600);margin-top:4px">Complex</div>
                <div style="font-size:10px;color:var(--gray-500);margin-top:4px">Self-employment, rental</div>
              </div>
              <div style="padding:16px;background:var(--error-light);border-radius:var(--radius-md);text-align:center">
                <div style="font-weight:700;font-size:20px;color:var(--error)">$750+</div>
                <div style="font-size:12px;color:var(--gray-600);margin-top:4px">Premium</div>
                <div style="font-size:10px;color:var(--gray-500);margin-top:4px">Business entities, multi-state</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pricing Result -->
        <div class="card" id="pricing-result-card" style="display:none">
          <div class="card-header">
            <div class="card-title">Calculated Quote</div>
          </div>
          <div class="card-body" id="pricing-result">
            <!-- Results populated dynamically -->
          </div>
        </div>
      </div>

      <!-- Client Intake View -->
      <div class="view" id="view-intake">
        <div class="page-header">
          <div>
            <h1 class="page-title">Client Intake</h1>
            <p class="page-subtitle">Start new client onboarding with benefit estimation</p>
          </div>
          <div class="header-actions">
            <button class="btn btn-primary" onclick="startNewIntake()">+ New Client Intake</button>
          </div>
        </div>

        <!-- Active Intakes -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header">
            <div class="card-title">Active Intakes</div>
            <div class="card-subtitle">Clients currently in the onboarding process</div>
          </div>
          <div class="card-body no-padding" id="active-intakes">
            <div class="empty-state">
              <div class="empty-title">No active intakes</div>
              <div class="empty-desc">Start a new client intake to begin onboarding</div>
            </div>
          </div>
        </div>

        <!-- New Intake Form (hidden by default) -->
        <div class="card" id="intake-form-card" style="display:none">
          <div class="card-header">
            <div class="card-title">New Client Intake</div>
          </div>
          <div class="card-body">
            <form id="intake-form" onsubmit="submitIntake(event)">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
                <div>
                  <label style="display:block;font-size:12px;font-weight:500;color:var(--gray-700);margin-bottom:4px">First Name</label>
                  <input type="text" id="intake-first-name" style="width:100%;padding:10px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:13px" required>
                </div>
                <div>
                  <label style="display:block;font-size:12px;font-weight:500;color:var(--gray-700);margin-bottom:4px">Last Name</label>
                  <input type="text" id="intake-last-name" style="width:100%;padding:10px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:13px" required>
                </div>
              </div>
              <div style="margin-bottom:16px">
                <label style="display:block;font-size:12px;font-weight:500;color:var(--gray-700);margin-bottom:4px">Email</label>
                <input type="email" id="intake-email" style="width:100%;padding:10px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:13px" required>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
                <div>
                  <label style="display:block;font-size:12px;font-weight:500;color:var(--gray-700);margin-bottom:4px">Tax Year</label>
                  <select id="intake-tax-year" style="width:100%;padding:10px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:13px">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                  </select>
                </div>
                <div>
                  <label style="display:block;font-size:12px;font-weight:500;color:var(--gray-700);margin-bottom:4px">Filing Status</label>
                  <select id="intake-filing-status" style="width:100%;padding:10px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:13px">
                    <option value="single">Single</option>
                    <option value="married_filing_jointly">Married Filing Jointly</option>
                    <option value="married_filing_separately">Married Filing Separately</option>
                    <option value="head_of_household">Head of Household</option>
                  </select>
                </div>
              </div>
              <div style="display:flex;gap:12px;justify-content:flex-end">
                <button type="button" class="btn btn-ghost" onclick="cancelIntake()">Cancel</button>
                <button type="submit" class="btn btn-primary">Start Intake</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Advisory Reports View -->
      <div class="view" id="view-reports">
        <div class="page-header">
          <div>
            <h1 class="page-title">Advisory Reports</h1>
            <p class="page-subtitle">Generate comprehensive client-ready tax advisory reports</p>
          </div>
        </div>

        <!-- Client Selector -->
        <div class="card" style="margin-bottom:20px">
          <div class="card-header">
            <div class="card-title">Select Client</div>
          </div>
          <div class="card-body">
            <select id="report-client-select" class="form-select" style="width:100%;padding:10px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:13px" onchange="loadReportSections()">
              <option value="">-- Select a Client --</option>
            </select>
          </div>
        </div>

        <!-- Report Sections -->
        <div class="card" style="margin-bottom:20px" id="report-sections-card" style="display:none">
          <div class="card-header">
            <div class="card-title">Report Sections</div>
            <div class="card-subtitle">Select sections to include in the report</div>
          </div>
          <div class="card-body" id="report-sections">
            <!-- Populated dynamically -->
          </div>
        </div>

        <!-- Generate Button -->
        <div style="display:flex;gap:12px;justify-content:flex-end" id="report-actions" style="display:none">
          <button class="btn btn-ghost" onclick="downloadReport('markdown')">Download Markdown</button>
          <button class="btn btn-ghost" onclick="downloadReport('html')">Download HTML</button>
          <button class="btn btn-print" onclick="printReport()" title="Print or save as PDF">🖨️ Print / PDF</button>
          <button class="btn btn-primary" onclick="generateReport()">Generate Full Report</button>
        </div>

        <!-- Report Preview -->
        <div class="card" style="margin-top:20px;display:none" id="report-preview-card">
          <div class="card-header">
            <div class="card-title">Report Preview</div>
          </div>
          <div class="card-body" id="report-preview" style="max-height:600px;overflow-y:auto">
            <!-- Preview content -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- =========================================================================== -->
  <!-- CPA FIRST LOGIN MODAL - Practice Setup Wizard -->
  <!-- =========================================================================== -->
  <div class="modal-backdrop" id="first-login-modal">
    <div class="modal" style="max-width:600px;width:95%">
      <div class="modal-header" style="background:var(--savings-bg);color:white;border:none">
        <div>
          <h3 style="font-size:18px;font-weight:700;margin-bottom:4px">Welcome to CA4CPA GLOBAL</h3>
          <div style="font-size:13px;opacity:0.9">Tax Advisory Intelligence Platform</div>
        </div>
      </div>
      <div class="modal-body" style="padding:32px">
        <!-- Step 1: Practice Info -->
        <div class="setup-step active" id="setup-step-1">
          <div style="text-align:center;margin-bottom:24px">
            <div style="width:48px;height:48px;background:var(--primary-light);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:20px">1</div>
            <div style="font-size:16px;font-weight:600;color:var(--gray-900)">Practice Information</div>
          </div>
          <div style="margin-bottom:16px">
            <label style="display:block;font-size:12px;font-weight:500;color:var(--gray-700);margin-bottom:4px">Your Name</label>
            <input type="text" id="setup-name" placeholder="Enter your name" style="width:100%;padding:12px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:14px">
          </div>
          <div style="margin-bottom:16px">
            <label style="display:block;font-size:12px;font-weight:500;color:var(--gray-700);margin-bottom:4px">Firm Name</label>
            <input type="text" id="setup-firm" placeholder="Your firm or practice name" style="width:100%;padding:12px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:14px">
          </div>
          <div style="margin-bottom:16px">
            <label style="display:block;font-size:12px;font-weight:500;color:var(--gray-700);margin-bottom:4px">Credentials</label>
            <div style="display:flex;gap:12px;flex-wrap:wrap">
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                <input type="checkbox" id="cred-cpa" checked> <span style="font-size:13px">CPA</span>
              </label>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                <input type="checkbox" id="cred-ea"> <span style="font-size:13px">EA</span>
              </label>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                <input type="checkbox" id="cred-jd"> <span style="font-size:13px">JD</span>
              </label>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                <input type="checkbox" id="cred-cfp"> <span style="font-size:13px">CFP</span>
              </label>
            </div>
          </div>
          <button class="btn btn-primary" style="width:100%;padding:14px" onclick="nextSetupStep(2)">Continue</button>
        </div>

        <!-- Step 2: Practice Focus -->
        <div class="setup-step" id="setup-step-2" style="display:none">
          <div style="text-align:center;margin-bottom:24px">
            <div style="width:48px;height:48px;background:var(--primary-light);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:20px">2</div>
            <div style="font-size:16px;font-weight:600;color:var(--gray-900)">Practice Focus</div>
          </div>
          <div style="margin-bottom:20px">
            <label style="display:block;font-size:12px;font-weight:500;color:var(--gray-700);margin-bottom:8px">Primary Client Types</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <label class="focus-card" style="display:flex;align-items:center;gap:10px;padding:12px;border:2px solid var(--gray-200);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s">
                <input type="checkbox" id="focus-individual" checked style="display:none">
                <span style="font-size:20px">Individual Tax Returns</span>
              </label>
              <label class="focus-card" style="display:flex;align-items:center;gap:10px;padding:12px;border:2px solid var(--gray-200);border-radius:var(--radius-md);cursor:pointer;transition:all 0.2s">
                <input type="checkbox" id="focus-small-biz" style="display:none">
                <span style="font-size:20px">Small Business</span>
              </label>
            </div>
          </div>
          <div style="margin-bottom:20px">
            <label style="display:block;font-size:12px;font-weight:500;color:var(--gray-700);margin-bottom:8px">Estimated Client Count</label>
            <select id="setup-client-count" style="width:100%;padding:12px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:14px">
              <option value="1-25">1-25 clients</option>
              <option value="26-50">26-50 clients</option>
              <option value="51-100" selected>51-100 clients</option>
              <option value="100+">100+ clients</option>
            </select>
          </div>
          <div style="display:flex;gap:12px">
            <button class="btn btn-ghost" style="flex:1;padding:14px" onclick="nextSetupStep(1)">Back</button>
            <button class="btn btn-primary" style="flex:2;padding:14px" onclick="completeSetup()">Complete Setup</button>
          </div>
        </div>

        <!-- Step 3: Complete -->
        <div class="setup-step" id="setup-step-3" style="display:none">
          <div style="text-align:center;padding:20px">
            <div class="success-check" style="width:80px;height:80px;margin-bottom:20px"></div>
            <div style="font-size:20px;font-weight:700;color:var(--gray-900);margin-bottom:8px">You're All Set!</div>
            <div style="font-size:14px;color:var(--gray-600);margin-bottom:24px">Your practice is configured and ready to use</div>
            <div style="background:var(--primary-light);border-radius:var(--radius-md);padding:16px;margin-bottom:24px">
              <div style="font-size:13px;color:var(--gray-700)">Ready to add your first client?</div>
              <div style="font-size:12px;color:var(--gray-500);margin-top:4px">Use our 60-second Smart Onboarding to get instant tax insights</div>
            </div>
            <button class="btn btn-primary" style="width:100%;padding:14px" onclick="closeFirstLoginAndStartOnboarding()">Add First Client</button>
            <button class="btn btn-ghost" style="width:100%;margin-top:8px" onclick="closeFirstLogin()">Go to Dashboard</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================================================================== -->
  <!-- SMART ONBOARDING MODAL - 60-Second Client Onboarding -->
  <!-- =========================================================================== -->
  <div class="modal-backdrop" id="smart-onboarding-modal">
    <div class="modal" style="max-width:700px;width:95%;max-height:90vh">
      <div class="modal-header" style="background:linear-gradient(135deg,#1e40af 0%,#3b82f6 100%);color:white;border:none">
        <div style="display:flex;align-items:center;gap:16px">
          <div style="width:44px;height:44px;background:rgba(255,255,255,0.2);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:20px">60s</div>
          <div>
            <h3 style="font-size:18px;font-weight:700;margin-bottom:2px">Smart Client Onboarding</h3>
            <div style="font-size:12px;opacity:0.9">Upload 1040 - Instant Analysis - Maximum Value</div>
          </div>
        </div>
        <button class="panel-close" style="color:white;font-size:24px" onclick="closeSmartOnboarding()">&times;</button>
      </div>

      <!-- Progress Bar -->
      <div style="background:var(--gray-100);padding:12px 24px">
        <div style="display:flex;justify-content:space-between;margin-bottom:8px">
          <span class="onboard-step-label active" data-step="1">Upload</span>
          <span class="onboard-step-label" data-step="2">Questions</span>
          <span class="onboard-step-label" data-step="3">Analysis</span>
          <span class="onboard-step-label" data-step="4">Create</span>
        </div>
        <div style="height:4px;background:var(--gray-200);border-radius:2px;overflow:hidden">
          <div id="onboard-progress-bar" style="height:100%;background:var(--primary);width:25%;transition:width 0.3s ease"></div>
        </div>
      </div>

      <div class="modal-body" style="padding:24px;max-height:60vh;overflow-y:auto">
        <!-- Step 1: Document Upload -->
        <div class="onboard-step active" id="onboard-step-1">
          <div style="text-align:center;margin-bottom:24px">
            <div style="font-size:16px;font-weight:600;color:var(--gray-900)">Upload Last Year's 1040</div>
            <div style="font-size:13px;color:var(--gray-500);margin-top:4px">We'll extract key data and identify opportunities instantly</div>
          </div>

          <div id="onboard-dropzone" class="dropzone" style="border:2px dashed var(--gray-300);border-radius:var(--radius-lg);padding:48px 24px;text-align:center;cursor:pointer;transition:all 0.2s;background:var(--gray-50)" ondragover="event.preventDefault();this.classList.add('drop-zone-active')" ondragleave="this.classList.remove('drop-zone-active')" ondrop="handleOnboardDrop(event)" onclick="document.getElementById('onboard-file-input').click()">
            <div style="font-size:48px;margin-bottom:16px">PDF</div>
            <div style="font-size:14px;font-weight:500;color:var(--gray-900);margin-bottom:8px">Drop your 1040 PDF here</div>
            <div style="font-size:12px;color:var(--gray-500)">or click to browse</div>
            <input type="file" id="onboard-file-input" accept=".pdf,.png,.jpg,.jpeg" style="display:none" onchange="handleOnboardFileSelect(event)">
          </div>

          <div id="onboard-upload-status" style="display:none;margin-top:20px;text-align:center">
            <div class="loading-spinner" style="margin:0 auto 12px"></div>
            <div style="font-size:13px;color:var(--gray-600)" id="onboard-status-text">Processing document...</div>
          </div>

          <div style="text-align:center;margin-top:24px">
            <div style="font-size:12px;color:var(--gray-500)">No document? No problem</div>
            <button class="btn btn-ghost" style="margin-top:8px" onclick="skipToManualEntry()">Enter Info Manually</button>
          </div>
        </div>

        <!-- Step 2: Smart Questions -->
        <div class="onboard-step" id="onboard-step-2" style="display:none">
          <div style="text-align:center;margin-bottom:24px">
            <div style="font-size:16px;font-weight:600;color:var(--gray-900)">Quick Questions</div>
            <div style="font-size:13px;color:var(--gray-500);margin-top:4px">Based on your return, these could unlock significant savings</div>
          </div>

          <div id="smart-questions-container">
            <!-- Questions populated dynamically -->
          </div>

          <div style="margin-top:24px;display:flex;gap:12px">
            <button class="btn btn-ghost" style="flex:1" onclick="goToOnboardStep(1)">Back</button>
            <button class="btn btn-primary" style="flex:2" onclick="submitOnboardAnswers()">Get My Analysis</button>
          </div>
        </div>

        <!-- Step 3: Analysis Results -->
        <div class="onboard-step" id="onboard-step-3" style="display:none">
          <div style="text-align:center;margin-bottom:24px">
            <div style="font-size:16px;font-weight:600;color:var(--gray-900)">Advisory Signals Identified</div>
          </div>

          <!-- Advisory Surface -->
          <div style="background:linear-gradient(135deg, #1f2937 0%, #374151 100%);border-radius:var(--radius-lg);padding:24px;text-align:center;color:white;margin-bottom:24px">
            <div style="font-size:13px;opacity:0.9">Advisory Surface Assessment</div>
            <div id="onboard-advisory-level" style="font-size:28px;font-weight:700;margin-top:8px">Analyzing...</div>
            <div style="font-size:12px;opacity:0.85;margin-top:4px"><span id="onboard-opp-count">0</span> areas identified for CPA review</div>
          </div>

          <!-- Signal Areas -->
          <div id="onboard-opportunities" style="margin-bottom:24px">
            <!-- Signals populated dynamically -->
          </div>

          <div style="display:flex;gap:12px">
            <button class="btn btn-ghost" style="flex:1" onclick="goToOnboardStep(2)">Back</button>
            <button class="btn btn-primary" style="flex:2" onclick="goToOnboardStep(4)">Create Client Profile</button>
          </div>
        </div>

        <!-- Step 4: Create Client -->
        <div class="onboard-step" id="onboard-step-4" style="display:none">
          <div style="text-align:center;margin-bottom:24px">
            <div style="font-size:16px;font-weight:600;color:var(--gray-900)">Finalize Client Profile</div>
            <div style="font-size:13px;color:var(--gray-500);margin-top:4px">Confirm details to create the client record</div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
            <div>
              <label style="display:block;font-size:12px;font-weight:500;color:var(--gray-700);margin-bottom:4px">First Name</label>
              <input type="text" id="onboard-first-name" style="width:100%;padding:12px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:14px">
            </div>
            <div>
              <label style="display:block;font-size:12px;font-weight:500;color:var(--gray-700);margin-bottom:4px">Last Name</label>
              <input type="text" id="onboard-last-name" style="width:100%;padding:12px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:14px">
            </div>
          </div>

          <div style="margin-bottom:16px">
            <label style="display:block;font-size:12px;font-weight:500;color:var(--gray-700);margin-bottom:4px">Email</label>
            <input type="email" id="onboard-email" style="width:100%;padding:12px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:14px">
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px">
            <div>
              <label style="display:block;font-size:12px;font-weight:500;color:var(--gray-700);margin-bottom:4px">Filing Status</label>
              <select id="onboard-filing-status" style="width:100%;padding:12px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:14px">
                <option value="single">Single</option>
                <option value="married_filing_jointly">Married Filing Jointly</option>
                <option value="married_filing_separately">Married Filing Separately</option>
                <option value="head_of_household">Head of Household</option>
              </select>
            </div>
            <div>
              <label style="display:block;font-size:12px;font-weight:500;color:var(--gray-700);margin-bottom:4px">Tax Year</label>
              <select id="onboard-tax-year" style="width:100%;padding:12px;border:1px solid var(--gray-300);border-radius:var(--radius-md);font-size:14px">
                <option value="2025">2025</option>
                <option value="2024" selected>2024</option>
              </select>
            </div>
          </div>

          <!-- Summary of what was found -->
          <div style="background:var(--gray-50);border-radius:var(--radius-md);padding:16px;margin-bottom:24px">
            <div style="font-size:12px;font-weight:600;color:var(--gray-700);margin-bottom:8px">This client profile will include:</div>
            <div style="font-size:12px;color:var(--gray-600);line-height:1.6">
              - Extracted 1040 data from uploaded document<br>
              - <span id="onboard-summary-opps">0</span> identified optimization opportunities<br>
              - <span id="onboard-summary-savings">$0</span> potential savings analysis
            </div>
          </div>

          <div style="display:flex;gap:12px">
            <button class="btn btn-ghost" style="flex:1" onclick="goToOnboardStep(3)">Back</button>
            <button class="btn btn-primary" style="flex:2" id="create-client-btn" onclick="createClientFromOnboarding()">Create Client</button>
          </div>
        </div>

        <!-- Step 5: Success -->
        <div class="onboard-step" id="onboard-step-5" style="display:none">
          <div style="text-align:center;padding:20px">
            <div class="success-check" style="width:80px;height:80px;margin-bottom:20px"></div>
            <div style="font-size:20px;font-weight:700;color:var(--gray-900);margin-bottom:8px">Client Created!</div>
            <div style="font-size:14px;color:var(--gray-600);margin-bottom:24px">
              <span id="created-client-name">Client</span> is now in your practice
            </div>

            <div style="background:var(--success-light);border-radius:var(--radius-lg);padding:20px;margin-bottom:24px">
              <div style="font-size:13px;color:var(--gray-700)">Ready to review</div>
              <div style="font-size:28px;font-weight:700;color:var(--success);margin-top:8px" id="created-savings">$0</div>
              <div style="font-size:12px;color:var(--gray-600);margin-top:4px">in optimization opportunities</div>
            </div>

            <button class="btn btn-primary" style="width:100%;padding:14px;margin-bottom:8px" onclick="viewCreatedClient()">View Client Details</button>
            <button class="btn btn-ghost" style="width:100%" onclick="closeSmartOnboarding()">Back to Dashboard</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================================================================== -->
  <!-- CLIENT DETAIL MODAL - Full Advisory Workspace -->
  <!-- =========================================================================== -->
  <div class="modal-backdrop" id="client-detail-modal">
    <div class="modal" style="max-width:1100px;width:95%;max-height:95vh">
      <div class="modal-header" style="padding:16px 24px">
        <div style="display:flex;align-items:center;gap:16px">
          <div class="client-avatar" id="detail-client-avatar" style="width:48px;height:48px;font-size:18px">--</div>
          <div>
            <h3 style="font-size:18px;font-weight:700" id="detail-client-name">Client Name</h3>
            <div style="font-size:12px;color:var(--gray-500)">Tax Year <span id="detail-tax-year">2024</span> | <span id="detail-filing-status">Single</span></div>
          </div>
        </div>
        <button class="panel-close" onclick="closeClientDetail()">&times;</button>
      </div>

      <div class="modal-body" style="padding:0;max-height:calc(95vh - 120px);overflow-y:auto">
        <!-- Client Detail Tabs -->
        <div style="border-bottom:1px solid var(--gray-200);padding:0 24px;display:flex;gap:24px">
          <button class="tab-btn active" data-tab="overview" onclick="switchClientTab('overview')">Overview</button>
          <button class="tab-btn" data-tab="opportunities" onclick="switchClientTab('opportunities')">Opportunities</button>
          <button class="tab-btn" data-tab="what-if" onclick="switchClientTab('what-if')">What-If</button>
          <button class="tab-btn" data-tab="documents" onclick="switchClientTab('documents')">Documents</button>
        </div>

        <!-- Tab: Overview -->
        <div class="client-tab active" id="client-tab-overview" style="padding:24px">
          <!-- Savings Hero -->
          <div style="background:var(--savings-bg);border-radius:var(--radius-lg);padding:24px;color:white;margin-bottom:24px">
            <div style="display:grid;grid-template-columns:1fr auto;gap:24px;align-items:center">
              <div>
                <div style="font-size:13px;opacity:0.9">Total Savings Potential</div>
                <div style="font-size:36px;font-weight:700" id="detail-total-savings">$0</div>
                <div style="font-size:12px;opacity:0.85;margin-top:4px"><span id="detail-opp-count">0</span> opportunities identified</div>
              </div>
              <div style="text-align:right">
                <button class="btn" style="background:white;color:var(--primary)" onclick="generateClientReport()">Generate Report</button>
              </div>
            </div>
          </div>

          <!-- Key Metrics Grid -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px">
            <div class="stat-card">
              <div class="stat-label">AGI</div>
              <div class="stat-value" id="detail-agi">$0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Tax</div>
              <div class="stat-value" id="detail-total-tax">$0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Effective Rate</div>
              <div class="stat-value" id="detail-effective-rate">0%</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Refund/Owed</div>
              <div class="stat-value" id="detail-refund">$0</div>
            </div>
          </div>

          <!-- Top Opportunities Quick View -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">Top Opportunities</div>
              <button class="btn btn-ghost btn-sm" onclick="switchClientTab('opportunities')">View All</button>
            </div>
            <div class="card-body no-padding" id="detail-top-opportunities">
              <div class="empty-state"><div class="empty-title">Loading...</div></div>
            </div>
          </div>
        </div>

        <!-- Tab: Opportunities -->
        <div class="client-tab" id="client-tab-opportunities" style="padding:24px;display:none">
          <div class="card">
            <div class="card-header">
              <div class="card-title">All Optimization Opportunities</div>
            </div>
            <div class="card-body no-padding" id="detail-all-opportunities">
              <div class="empty-state"><div class="empty-title">Loading...</div></div>
            </div>
          </div>
        </div>

        <!-- Tab: What-If -->
        <div class="client-tab" id="client-tab-what-if" style="padding:24px;display:none">
          <div style="margin-bottom:20px">
            <div style="font-size:14px;font-weight:600;color:var(--gray-900);margin-bottom:12px">Quick Scenarios</div>
            <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px" id="detail-scenario-templates">
              <div class="opt-card" onclick="runClientScenario('max_401k')">
                <div class="opt-icon retirement">401k</div>
                <div class="opt-label">Max 401(k)</div>
              </div>
              <div class="opt-card" onclick="runClientScenario('max_ira')">
                <div class="opt-icon retirement">IRA</div>
                <div class="opt-label">Max IRA</div>
              </div>
              <div class="opt-card" onclick="runClientScenario('max_hsa')">
                <div class="opt-icon retirement">HSA</div>
                <div class="opt-label">Max HSA</div>
              </div>
              <div class="opt-card" onclick="runClientScenario('charitable_bunching')">
                <div class="opt-icon deductions">Char</div>
                <div class="opt-label">Charitable Bunch</div>
              </div>
              <div class="opt-card" onclick="runClientScenario('home_office')">
                <div class="opt-icon deductions">Home</div>
                <div class="opt-label">Home Office</div>
              </div>
            </div>
          </div>
          <div class="card" id="detail-scenario-results" style="display:none">
            <div class="card-header">
              <div class="card-title">Scenario Comparison</div>
            </div>
            <div class="card-body" id="detail-scenario-content"></div>
          </div>
        </div>

        <!-- Tab: Documents -->
        <div class="client-tab" id="client-tab-documents" style="padding:24px;display:none">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Uploaded Documents</div>
              <button class="btn btn-primary btn-sm" onclick="uploadClientDocument()">Upload Document</button>
            </div>
            <div class="card-body no-padding" id="detail-documents">
              <div class="empty-state"><div class="empty-title">No documents uploaded</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Insight Detail Panel -->
  <div class="detail-panel" id="insight-panel">
    <div class="panel-header">
      <div class="panel-title" id="panel-title">Recommendation Details</div>
      <button class="panel-close" onclick="closePanel()">&times;</button>
    </div>
    <div class="panel-body" id="panel-body"></div>
    <div class="panel-footer">
      <button class="btn btn-primary" style="width:100%" onclick="markImplemented()">Mark as Implemented</button>
    </div>
  </div>

  <div class="toast-container" id="toast-container"></div>

  <script>
    // ================================================================
    // SECURITY: XSS Prevention - Always use this for user-generated content
    // ================================================================
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    // ================================================================
    // MOBILE NAVIGATION
    // ================================================================
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      const hamburger = document.getElementById('hamburger-btn');
      const isOpen = sidebar.classList.contains('open');

      if (isOpen) {
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
        hamburger.classList.remove('active');
        document.body.style.overflow = '';
      } else {
        sidebar.classList.add('open');
        overlay.classList.add('active');
        hamburger.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    }

    // Close sidebar when clicking a nav item on mobile
    document.addEventListener('DOMContentLoaded', () => {
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', () => {
          if (window.innerWidth <= 1024) {
            toggleSidebar();
          }
        });
      });

      // Close sidebar on window resize if open
      window.addEventListener('resize', () => {
        const sidebar = document.getElementById('sidebar');
        if (window.innerWidth > 1024 && sidebar && sidebar.classList.contains('open')) {
          toggleSidebar();
        }
      });
    });

    // State
    const state = {
      currentView: 'dashboard',
      insights: [],
      clients: [],
      selectedInsight: null,
      preparerId: null,
      totals: { savings: 0, implemented: 0, pending: 0 },
      categories: { retirement: 0, deductions: 0, credits: 0, qbi: 0, investment: 0 },
    };

    // API Helper with retry and timeout
    async function api(endpoint, options = {}) {
      const headers = {
        'Content-Type': 'application/json',
        ...(state.preparerId && { 'X-Preparer-ID': state.preparerId }),
      };
      const timeout = options.timeout || 30000;
      const retries = options.retries || 1;

      for (let attempt = 1; attempt <= retries; attempt++) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), timeout);

          const response = await fetch(endpoint, {
            ...options,
            headers: { ...headers, ...(options.headers || {}) },
            signal: controller.signal,
          });
          clearTimeout(timeoutId);

          if (!response.ok && response.status >= 500 && attempt < retries) {
            await new Promise(r => setTimeout(r, 1000 * attempt));
            continue;
          }

          return await response.json();
        } catch (e) {
          if (e.name === 'AbortError') {
            console.error(`API timeout: ${endpoint}`);
          } else {
            console.error(`API Error (attempt ${attempt}):`, e);
          }
          if (attempt === retries) {
            return { success: false, error: e.message || 'Network error' };
          }
          await new Promise(r => setTimeout(r, 1000 * attempt));
        }
      }
      return { success: false };
    }

    // Core Platform API Base
    const CORE_API = '/api/core';

    // Core Platform API helper (unified API for all user types)
    async function coreApi(endpoint, options = {}) {
      const token = localStorage.getItem('cpa_token') || state.preparerId;
      const headers = {
        'Content-Type': 'application/json',
        ...(token && { 'Authorization': `Bearer ${token}` }),
        ...(state.preparerId && { 'X-Preparer-ID': state.preparerId }),
      };

      try {
        const response = await fetch(`${CORE_API}${endpoint}`, {
          ...options,
          headers: { ...headers, ...(options.headers || {}) },
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.detail || `Request failed: ${response.status}`);
        }

        return await response.json();
      } catch (e) {
        console.error(`Core API Error: ${endpoint}`, e);
        return { success: false, error: e.message };
      }
    }

    // =============================================================================
    // SECURITY UTILITY FUNCTIONS
    // =============================================================================

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    function isValidUrl(url) {
      if (!url) return false;
      try {
        const parsed = new URL(url, window.location.origin);
        return ['http:', 'https:'].includes(parsed.protocol);
      } catch {
        return false;
      }
    }

    function sanitizeClassName(className) {
      if (!className) return '';
      return String(className).replace(/[^a-zA-Z0-9_-]/g, '');
    }

    function sanitizeId(id) {
      if (!id) return '';
      return String(id).replace(/[^a-zA-Z0-9_-]/g, '');
    }

    // =============================================================================
    // UI UTILITY FUNCTIONS
    // =============================================================================

    // Show loading state on a container
    function showLoading(containerId, message = 'Loading...') {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.style.position = 'relative';
      container.innerHTML = `
        <div class="loading-overlay fade-in">
          <div style="text-align:center">
            <div class="loading-spinner"></div>
            <div style="margin-top:12px;font-size:12px;color:var(--gray-500)">${escapeHtml(message)}</div>
          </div>
        </div>
      `;
    }

    // Show skeleton loader
    function showSkeleton(containerId, count = 3) {
      const container = document.getElementById(containerId);
      if (!container) return;
      let html = '';
      for (let i = 0; i < count; i++) {
        html += `
          <div style="padding:16px;border-bottom:1px solid var(--gray-100)">
            <div class="skeleton skeleton-text" style="width:60%"></div>
            <div class="skeleton skeleton-text sm" style="width:80%"></div>
            <div class="skeleton skeleton-text sm" style="width:40%"></div>
          </div>
        `;
      }
      container.innerHTML = html;
    }

    // Animate a number from 0 to target
    function animateNumber(elementId, targetValue, duration = 1000, prefix = '', suffix = '') {
      const element = document.getElementById(elementId);
      if (!element) return;

      const startValue = 0;
      const startTime = performance.now();

      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        // Ease out cubic
        const easeProgress = 1 - Math.pow(1 - progress, 3);
        const currentValue = Math.floor(startValue + (targetValue - startValue) * easeProgress);

        element.textContent = prefix + currentValue.toLocaleString() + suffix;

        if (progress < 1) {
          requestAnimationFrame(update);
        } else {
          element.textContent = prefix + targetValue.toLocaleString() + suffix;
        }
      }

      requestAnimationFrame(update);
    }

    // Animate currency
    function animateCurrency(elementId, targetValue, duration = 1000) {
      const element = document.getElementById(elementId);
      if (!element) return;

      const startValue = 0;
      const startTime = performance.now();

      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easeProgress = 1 - Math.pow(1 - progress, 3);
        const currentValue = Math.floor(startValue + (targetValue - startValue) * easeProgress);

        element.textContent = formatCurrency(currentValue);

        if (progress < 1) {
          requestAnimationFrame(update);
        } else {
          element.textContent = formatCurrency(targetValue);
        }
      }

      requestAnimationFrame(update);
    }

    // Show success modal
    function showSuccessModal(title, message, onClose) {
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop';
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-body" style="text-align:center;padding:40px">
          <div class="success-check"></div>
          <h3 style="margin-bottom:8px"></h3>
          <p style="color:var(--gray-600);margin-bottom:24px"></p>
          <button class="btn btn-primary">Continue</button>
        </div>
      `;
      modal.querySelector('h3').textContent = title;
      modal.querySelector('p').textContent = message;
      modal.querySelector('button').onclick = () => {
        backdrop.remove();
        if (onClose && typeof window[onClose] === 'function') window[onClose]();
      };
      backdrop.appendChild(modal);
      document.body.appendChild(backdrop);
      setTimeout(() => backdrop.classList.add('active'), 10);
    }

    // Show confirmation modal
    function showConfirmModal(title, message, onConfirm) {
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop';
      backdrop.id = 'confirm-modal';
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-header">
          <h3 style="font-size:16px;font-weight:600"></h3>
          <button class="panel-close">&times;</button>
        </div>
        <div class="modal-body">
          <p style="color:var(--gray-600)"></p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost">Cancel</button>
          <button class="btn btn-primary">Confirm</button>
        </div>
      `;
      modal.querySelector('h3').textContent = title;
      modal.querySelector('p').textContent = message;
      modal.querySelector('.panel-close').onclick = () => backdrop.remove();
      modal.querySelector('.btn-ghost').onclick = () => backdrop.remove();
      modal.querySelector('.btn-primary').onclick = () => {
        backdrop.remove();
        if (onConfirm && typeof window[onConfirm] === 'function') window[onConfirm]();
      };
      backdrop.appendChild(modal);
      document.body.appendChild(backdrop);
      setTimeout(() => backdrop.classList.add('active'), 10);
    }

    // Set button loading state
    function setButtonLoading(button, loading) {
      if (loading) {
        button.classList.add('loading');
        button.disabled = true;
      } else {
        button.classList.remove('loading');
        button.disabled = false;
      }
    }

    // Progress indicator
    function showProgress(containerId, progress, label = '') {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = `
        <div style="margin-bottom:8px;display:flex;justify-content:space-between;font-size:12px">
          <span style="color:var(--gray-600)">${label}</span>
          <span style="font-weight:600">${Math.round(progress)}%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-bar-fill" style="width:${progress}%"></div>
        </div>
      `;
    }

    // Enhanced empty state
    function showEmptyState(containerId, icon, title, description, actionLabel, actionFn) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = `
        <div class="empty-state fade-in">
          <div class="empty-state-icon">${icon}</div>
          <div class="empty-title">${title}</div>
          <div class="empty-desc">${description}</div>
          ${actionLabel ? `<button class="btn btn-primary" style="margin-top:16px" onclick="${actionFn}">${actionLabel}</button>` : ''}
        </div>
      `;
    }

    // Debounce function for search/filter inputs
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Show loading states immediately
      showSkeleton('top-insights', 4);
      showSkeleton('high-value-clients', 4);

      await initializePreparer();
      await loadAllData();

      // Restore view from URL hash (e.g., #clients, #pipeline)
      initFromUrlHash();

      // Animate hero numbers on load
      if (state.totals.savings > 0) {
        animateCurrency('total-savings', state.totals.savings, 1500);
        animateCurrency('stat-implemented', state.totals.implemented, 1200);
        animateCurrency('stat-pending', state.totals.pending, 1200);
      }
    });

    async function initializePreparer() {
      const existingId = document.cookie.split('; ').find(c => c.startsWith('preparer_id='))?.split('=')[1];
      if (existingId) {
        state.preparerId = existingId;
        return;
      }
      try {
        const data = await fetch('/api/workspace/preparer/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: 'admin@ca4cpa.com',
            first_name: 'CA4CPA',
            last_name: 'Admin',
            firm_name: 'CA4CPA GLOBAL LLC',
            credentials: ['CPA'],
          }),
        }).then(r => r.json());
        if (data.success) state.preparerId = data.preparer.preparer_id;
      } catch (e) { /* Preparer init skipped - using default */ }
    }

    async function loadAllData() {
      await Promise.all([
        loadSmartInsights(),
        loadClients(),
        loadQueueCounts(),
      ]);
      updateDashboard();
    }

    async function loadSmartInsights() {
      try {
        // Use the REAL aggregated insights API that connects to the recommendation engine
        const data = await api('/api/cpa/insights/aggregate?limit=50');
        if (data.success && data.insights) {
          // Transform API response to dashboard format
          state.insights = data.insights.map((i, idx) => ({
            id: idx + 1,
            title: i.title,
            description: i.description,
            category: mapCategory(i.category),
            estimated_savings: i.estimated_savings || 0,
            irs_reference: i.irs_reference || i.irs_form || '',
            priority: i.priority || 'medium',
            client: i.client_name || 'Client',
            session_id: i.session_id,
            action_items: i.action_items || [],
            source: i.source || 'recommendation_engine',
          }));

          document.getElementById('insights-badge').textContent = state.insights.length;
          renderTopInsights(state.insights.slice(0, 8));
          renderAllInsights(state.insights);

          // Use totals from API if available
          if (data.total_savings_potential) {
            state.totals.savings = data.total_savings_potential;
            state.totals.pending = data.total_savings_potential * 0.7;
            state.totals.implemented = data.total_savings_potential * 0.3;
            document.getElementById('total-savings').textContent = formatCurrency(data.total_savings_potential);
            document.getElementById('stat-implemented').textContent = formatCurrency(state.totals.implemented);
            document.getElementById('stat-pending').textContent = formatCurrency(state.totals.pending);
          } else {
            calculateSavingsTotals(state.insights);
          }

          // Use category breakdown from API
          if (data.category_breakdown) {
            updateCategoryBreakdown(data.category_breakdown);
          }

          // Update clients with savings count
          if (data.clients_by_savings) {
            document.getElementById('clients-with-savings').textContent = data.clients_by_savings.length;
            state.clientsBySavings = data.clients_by_savings;
          }
          return;
        }
      } catch (e) {
        console.error('Failed to load real insights, falling back to summary:', e);
      }

      // Fallback: Try the summary endpoint for hero metrics
      try {
        const summaryData = await api('/api/cpa/insights/summary');
        if (summaryData.success) {
          document.getElementById('total-savings').textContent = formatCurrency(summaryData.total_savings_identified);
          document.getElementById('stat-pending').textContent = formatCurrency(summaryData.total_savings_identified * 0.7);
          document.getElementById('stat-implemented').textContent = formatCurrency(summaryData.total_savings_identified * 0.3);
          document.getElementById('clients-with-savings').textContent = summaryData.clients_with_savings || 0;

          if (summaryData.category_breakdown) {
            updateCategoryBreakdown(summaryData.category_breakdown);
          }
        }
      } catch (e) {
        console.error('Summary endpoint also failed:', e);
      }

      // Try to load from our database recommendations
      try {
        const dbData = await api('/api/cpa/data/recommendations?limit=100');
        if (dbData.success && dbData.recommendations && dbData.recommendations.length > 0) {
          state.insights = dbData.recommendations.map((r, idx) => ({
            id: idx + 1,
            rec_id: r.rec_id,
            title: r.title,
            description: r.description,
            category: r.category,
            estimated_savings: r.estimated_savings || 0,
            priority: r.priority || 'medium',
            client: r.first_name && r.last_name ? `${r.first_name} ${r.last_name}` : 'Client',
            client_id: r.client_id,
            session_id: r.session_id,
            status: r.status,
            source: 'database',
          }));

          document.getElementById('insights-badge').textContent = state.insights.length;
          renderTopInsights(state.insights.slice(0, 8));
          renderAllInsights(state.insights);

          // Update totals from database
          if (dbData.total_savings) {
            state.totals.savings = dbData.total_savings;
            state.totals.pending = dbData.total_savings * 0.7;
            state.totals.implemented = dbData.total_savings * 0.3;
            document.getElementById('total-savings').textContent = formatCurrency(dbData.total_savings);
            document.getElementById('stat-implemented').textContent = formatCurrency(state.totals.implemented);
            document.getElementById('stat-pending').textContent = formatCurrency(state.totals.pending);
          }

          // Update category breakdown from database
          if (dbData.categories) {
            const breakdown = {};
            dbData.categories.forEach(c => {
              breakdown[c.category] = { total_savings: c.savings, count: c.count };
            });
            updateCategoryBreakdown(breakdown);
          }
          return;
        }
      } catch (e) {
        console.error('Database recommendations also failed:', e);
      }

      // Final fallback: sample data for demo
      const sampleInsights = generateSampleInsights();
      state.insights = sampleInsights;
      document.getElementById('insights-badge').textContent = sampleInsights.length;
      renderTopInsights(sampleInsights.slice(0, 8));
      renderAllInsights(sampleInsights);
      calculateSavingsTotals(sampleInsights);
    }

    function mapCategory(apiCategory) {
      // Map API category names to dashboard categories
      const categoryMap = {
        'retirement_planning': 'retirement',
        'deduction_opportunity': 'deductions',
        'credit_opportunity': 'credits',
        'investment_strategy': 'investment',
        'timing_optimization': 'investment',
        'immediate_action': 'deductions',
        'warning': 'deductions',
        'informational': 'deductions',
      };
      return categoryMap[apiCategory] || apiCategory || 'deductions';
    }

    function updateCategoryBreakdown(breakdown) {
      // Map API categories to dashboard category display
      const mapping = {
        retirement_planning: 'retirement',
        deduction_opportunity: 'deductions',
        credit_opportunity: 'credits',
        investment_strategy: 'investment',
        retirement: 'retirement',
        deductions: 'deductions',
        credits: 'credits',
        investment: 'investment',
        qbi: 'qbi',
      };

      const cats = { retirement: 0, deductions: 0, credits: 0, qbi: 0, investment: 0 };
      const catCounts = { retirement: 0, deductions: 0, credits: 0, qbi: 0, investment: 0 };

      Object.entries(breakdown).forEach(([key, data]) => {
        const mappedKey = mapping[key] || key;
        if (cats[mappedKey] !== undefined) {
          cats[mappedKey] += data.total_savings || 0;
          catCounts[mappedKey] += data.count || 0;
        }
      });

      state.categories = cats;

      // Update UI
      Object.keys(cats).forEach(cat => {
        const valEl = document.getElementById(`opt-${cat}`);
        const countEl = document.getElementById(`opt-${cat}-count`);
        if (valEl) valEl.textContent = formatCurrency(cats[cat]);
        if (countEl) countEl.textContent = catCounts[cat];
      });
    }

    function generateSampleInsights() {
      return [
        { id: 1, title: '401(k) Contribution Opportunity', description: 'Client has room to maximize 401(k) contribution before year end', category: 'retirement', priority: 'high', irs_reference: 'IRC Section 402(g)', client: 'Mayank Wadhera' },
        { id: 2, title: 'HSA Triple Tax Benefit', description: 'Client is HDHP eligible but not maximizing HSA contributions', category: 'retirement', priority: 'high', irs_reference: 'IRC Section 223', client: 'Test Export' },
        { id: 3, title: 'Charitable Deduction Bunching', description: 'Consider bunching multi-year donations to exceed standard deduction', category: 'deductions', priority: 'medium', irs_reference: 'IRC Section 170', client: 'Mayank Wadhera' },
        { id: 4, title: 'QBI Deduction Available', description: 'Self-employment income qualifies for Section 199A deduction', category: 'qbi', priority: 'high', irs_reference: 'IRC Section 199A', client: 'John Smith' },
        { id: 5, title: 'Education Credit - AOTC', description: 'Qualified education expenses may be eligible for American Opportunity Credit', category: 'credits', priority: 'medium', irs_reference: 'IRC Section 25A', client: 'Test Export' },
        { id: 6, title: 'Tax Loss Harvesting', description: 'Unrealized losses available for potential harvesting strategy', category: 'investment', priority: 'medium', irs_reference: 'IRC Section 1211', client: 'Mayank Wadhera' },
        { id: 7, title: 'Saver\'s Credit Eligibility', description: 'Income level may qualify for retirement savings credit', category: 'credits', priority: 'medium', irs_reference: 'IRC Section 25B', client: 'John Smith' },
        { id: 8, title: 'State Tax Optimization', description: 'Consider timing of state tax payments for SALT deduction', category: 'deductions', priority: 'low', irs_reference: 'IRC Section 164', client: 'Test Export' },
      ];
    }

    function calculateSavingsTotals(insights) {
      const catCounts = { retirement: 0, deductions: 0, credits: 0, qbi: 0, investment: 0 };
      let highLeverage = 0, needsReview = 0, complex = 0;

      insights.forEach(i => {
        if (catCounts[i.category] !== undefined) {
          catCounts[i.category]++;
        }
        // Count by priority for advisory surface
        if (i.priority === 'critical' || i.priority === 'high') highLeverage++;
        else if (i.priority === 'medium') needsReview++;
        else complex++;
      });

      // Determine overall advisory surface level
      const totalSignals = insights.length;
      let surfaceLevel = 'Low';
      if (highLeverage >= 3 || totalSignals >= 6) surfaceLevel = 'High';
      else if (highLeverage >= 1 || totalSignals >= 3) surfaceLevel = 'Moderate';

      // Update advisory surface indicator
      const surfaceEl = document.getElementById('advisory-surface-level');
      if (surfaceEl) surfaceEl.textContent = surfaceLevel;

      const leadsEl = document.getElementById('leads-ready-count');
      if (leadsEl) leadsEl.textContent = totalSignals;

      const highEl = document.getElementById('stat-high-leverage');
      if (highEl) highEl.textContent = highLeverage;

      const reviewEl = document.getElementById('stat-needs-review');
      if (reviewEl) reviewEl.textContent = needsReview;

      const complexEl = document.getElementById('stat-complexity');
      if (complexEl) complexEl.textContent = complex;

      // Update category cards with leverage levels
      Object.keys(catCounts).forEach(cat => {
        const levelEl = document.getElementById(`opt-${cat}-level`);
        const countEl = document.getElementById(`opt-${cat}-count`);
        if (levelEl) {
          const count = catCounts[cat];
          levelEl.textContent = count >= 2 ? 'High' : count === 1 ? 'Moderate' : '—';
        }
        if (countEl) countEl.textContent = catCounts[cat];
      });
    }

    async function loadClients() {
      try {
        // First try the new data endpoint with real database data
        const data = await api('/api/cpa/data/clients-for-select');
        if (data.success && data.clients && data.clients.length > 0) {
          state.clients = data.clients.map(c => ({
            id: c.id,
            client_id: c.client_id,
            name: c.name,
            complexity: c.complexity,
            savings: c.savings_potential || 0,
          }));

          // Load full dashboard summary for stats
          const summaryData = await api('/api/cpa/data/dashboard/summary');
          if (summaryData.success) {
            state.dashboardSummary = summaryData.summary;

            // Update total savings display
            const totalSavings = summaryData.summary.recommendations?.total_savings || 0;
            const heroAmount = document.querySelector('.hero-amount');
            if (heroAmount) {
              heroAmount.textContent = formatCurrency(totalSavings);
            }

            // Update stat cards
            const totalClients = summaryData.summary.total_clients || 0;
            document.getElementById('clients-with-savings').textContent = totalClients;

            const avgSavings = totalClients > 0 ? totalSavings / totalClients : 0;
            document.getElementById('stat-avg-savings').textContent = formatCurrency(avgSavings);

            // Update hero stats
            const heroStats = document.querySelector('.hero-stats');
            if (heroStats) {
              heroStats.innerHTML = `
                <div class="hero-stat">
                  <div class="hero-stat-value">${totalClients}</div>
                  <div class="hero-stat-label">Clients</div>
                </div>
                <div class="hero-stat">
                  <div class="hero-stat-value">${summaryData.summary.recommendations?.total || 0}</div>
                  <div class="hero-stat-label">Opportunities</div>
                </div>
                <div class="hero-stat">
                  <div class="hero-stat-value">${formatCurrency(avgSavings)}</div>
                  <div class="hero-stat-label">Avg Savings</div>
                </div>
              `;
            }

            // Render high value clients from summary
            if (summaryData.summary.top_clients_by_savings) {
              renderHighValueClientsFromSummary(summaryData.summary.top_clients_by_savings);
            }

            // Render high value opportunities
            if (summaryData.summary.high_value_opportunities) {
              renderHighValueOpportunities(summaryData.summary.high_value_opportunities);
            }
          }

          renderClientsList(state.clients);
        } else {
          // Fallback to old endpoint if no data in new database
          const fallbackData = await api('/api/returns?tax_year=2025&limit=50');
          if (fallbackData.returns) {
            state.clients = fallbackData.returns.map(r => ({
              id: r.return_id || r.session_id,
              name: r.taxpayer_name || 'Unknown',
              filing_status: r.filing_status,
              savings: Math.floor(Math.random() * 5000) + 500,
            }));
            renderClientsList(state.clients);
          }
        }
      } catch (e) {
        console.error('Failed to load clients:', e);
      }
    }

    function renderHighValueClientsFromSummary(topClients) {
      const container = document.getElementById('high-value-clients');
      if (!container || !topClients.length) return;

      container.innerHTML = topClients.slice(0, 5).map((client, index) => `
        <div class="client-row" onclick="selectClient('${sanitizeId(client.client_id)}')">
          <div class="client-rank">${index + 1}</div>
          <div class="client-info">
            <div class="client-name">${escapeHtml(client.name)}</div>
            <div class="client-detail">${escapeHtml(client.complexity)} | ${parseInt(client.recommendation_count) || 0} opportunities</div>
          </div>
          <div class="client-savings">+${formatCurrency(client.total_savings)}</div>
        </div>
      `).join('');
    }

    function renderHighValueOpportunities(opportunities) {
      const container = document.getElementById('opportunities-list');
      if (!container) return;

      if (!opportunities.length) {
        container.innerHTML = '<div class="empty-state">No high-value opportunities found</div>';
        return;
      }

      container.innerHTML = opportunities.slice(0, 8).map(opp => `
        <div class="opportunity-row">
          <div class="opportunity-icon">${getCategoryIcon(opp.category)}</div>
          <div class="opportunity-info">
            <div class="opportunity-title">${escapeHtml(opp.title)}</div>
            <div class="opportunity-detail">${escapeHtml(opp.client_name)} | ${escapeHtml(opp.category)}</div>
          </div>
          <div class="opportunity-savings">+${formatCurrency(opp.savings)}</div>
          <span class="status-badge ${sanitizeClassName(opp.status) === 'implemented' ? 'status-success' : 'status-info'}">${escapeHtml(opp.status)}</span>
        </div>
      `).join('');
    }

    function getCategoryIcon(category) {
      const icons = {
        retirement: '🏦',
        deduction: '📋',
        credit: '💳',
        investment: '📈',
        real_estate: '🏠',
        business: '💼',
        healthcare: '🏥',
        filing: '📁',
        state: '🗺️',
        international: '🌍',
        equity: '📊',
        crypto: '₿',
        estimated_tax: '📅',
      };
      return icons[category] || '💡';
    }

    async function loadQueueCounts() {
      try {
        const data = await api('/api/cpa/queue/counts');
        if (data.success) {
          const reviewCount = data.counts.IN_REVIEW || 0;
          document.getElementById('review-badge').textContent = reviewCount;
        }
      } catch (e) {
        console.error('Failed to load queue counts:', e);
      }
    }

    function getLeverageLevel(priority) {
      if (priority === 'critical' || priority === 'high') return 'High';
      if (priority === 'medium') return 'Elevated';
      return 'Moderate';
    }

    function renderTopInsights(insights) {
      const container = document.getElementById('top-insights');
      if (insights.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-title">No signals yet</div><div class="empty-desc">Add clients to identify advisory opportunities</div></div>`;
        return;
      }
      container.innerHTML = insights.map(i => `
        <div class="insight-item" onclick="showInsightDetail(${parseInt(i.id) || 0})">
          <div class="insight-icon ${sanitizeClassName(getPriorityClass(i.priority))}">
            ${getCategoryIcon(i.category)}
          </div>
          <div class="insight-content">
            <div class="insight-title">${escapeHtml(i.title)}</div>
            <div class="insight-desc">${escapeHtml(i.description)}</div>
            <div class="insight-meta">
              <span class="insight-tag">${escapeHtml(i.client || 'Client')}</span>
              ${i.irs_reference ? `<span class="insight-tag irs">${escapeHtml(i.irs_reference)}</span>` : ''}
            </div>
          </div>
          <div class="insight-amount" style="font-size:12px;color:var(--primary);">${escapeHtml(getLeverageLevel(i.priority))} Leverage</div>
        </div>
      `).join('');
    }

    function renderAllInsights(insights) {
      const container = document.getElementById('all-insights');
      if (insights.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-title">No signals available</div></div>`;
        return;
      }
      container.innerHTML = insights.map(i => `
        <div class="insight-item" onclick="showInsightDetail(${parseInt(i.id) || 0})">
          <div class="insight-icon ${sanitizeClassName(getPriorityClass(i.priority))}">
            ${getCategoryIcon(i.category)}
          </div>
          <div class="insight-content">
            <div class="insight-title">${escapeHtml(i.title)}</div>
            <div class="insight-desc">${escapeHtml(i.description)}</div>
            <div class="insight-meta">
              <span class="insight-tag">${escapeHtml(i.client || 'Client')}</span>
              <span class="insight-tag">${escapeHtml(capitalizeFirst(i.category))}</span>
              ${i.irs_reference ? `<span class="insight-tag irs">${escapeHtml(i.irs_reference)}</span>` : ''}
            </div>
          </div>
          <div class="insight-amount" style="font-size:12px;color:var(--primary);">${escapeHtml(getLeverageLevel(i.priority))} Leverage</div>
        </div>
      `).join('');
    }

    function renderHighValueClients(clients) {
      const container = document.getElementById('high-value-clients');
      // Sort by signal count (priority) instead of dollar savings
      const sorted = [...clients].sort((a, b) => (b.signalCount || 0) - (a.signalCount || 0)).slice(0, 8);

      if (sorted.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-title">No leads yet</div><button class="btn btn-primary btn-sm" onclick="switchView('pipeline')">View Pipeline</button></div>`;
        return;
      }

      container.innerHTML = sorted.map(c => `
        <div class="client-row" onclick="openClient('${sanitizeId(c.id)}')">
          <div class="client-avatar">${escapeHtml(getInitials(c.name))}</div>
          <div class="client-info">
            <div class="client-name">${escapeHtml(c.name)}</div>
            <div class="client-detail">${escapeHtml(c.filing_status || 'Single')} | ${parseInt(c.signalCount) || 1} signals</div>
          </div>
          <div class="client-savings">
            <div class="savings-amount" style="font-size:13px;color:var(--primary);">${(parseInt(c.signalCount) || 0) >= 3 ? 'High' : (parseInt(c.signalCount) || 0) >= 1 ? 'Moderate' : 'Low'}</div>
            <div class="savings-label">leverage</div>
          </div>
        </div>
      `).join('');
    }

    function renderClientsList(clients) {
      const container = document.getElementById('clients-list');
      if (!container) return;

      if (clients.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-title">No clients yet</div></div>`;
        return;
      }

      // Sort by savings descending
      const sorted = [...clients].sort((a, b) => (b.savings || 0) - (a.savings || 0));

      container.innerHTML = sorted.slice(0, 20).map(c => {
        const complexityBadge = getComplexityBadge(c.complexity);
        return `
          <div class="client-row" onclick="openClient('${sanitizeId(c.id)}')">
            <div class="client-avatar">${escapeHtml(getInitials(c.name))}</div>
            <div class="client-info">
              <div class="client-name">${escapeHtml(c.name)}</div>
              <div class="client-detail">
                ${complexityBadge}
                ${c.filing_status ? ` | ${escapeHtml(formatFilingStatus(c.filing_status))}` : ''}
              </div>
            </div>
            <div class="client-savings">
              <div class="savings-amount">+${formatCurrency(c.savings || 0)}</div>
              <div class="savings-label">savings potential</div>
            </div>
            <button class="btn btn-ghost btn-sm client-action" onclick="event.stopPropagation(); selectClientForAnalysis('${sanitizeId(c.id)}')">Analyze</button>
          </div>
        `;
      }).join('');
    }

    function getComplexityBadge(complexity) {
      const safeComplexity = sanitizeClassName(complexity);
      const colors = {
        simple: 'var(--success)',
        moderate: 'var(--info)',
        complex: 'var(--warning)',
        highly_complex: 'var(--error)',
        enterprise: '#7c3aed',
      };
      const labels = {
        simple: 'Simple',
        moderate: 'Moderate',
        complex: 'Complex',
        highly_complex: 'Highly Complex',
        enterprise: 'Enterprise',
      };
      const color = colors[safeComplexity] || 'var(--gray-500)';
      const label = labels[safeComplexity] || escapeHtml(complexity) || 'Unknown';
      return `<span style="display:inline-block;padding:2px 6px;background:${color}15;color:${color};border-radius:4px;font-size:10px;font-weight:600">${label}</span>`;
    }

    function formatFilingStatus(status) {
      const labels = {
        single: 'Single',
        married_filing_jointly: 'MFJ',
        married_filing_separately: 'MFS',
        head_of_household: 'HoH',
        qualifying_surviving_spouse: 'QSS',
      };
      return labels[status] || status;
    }

    function selectClientForAnalysis(sessionId) {
      // Pre-select this client in advisory tools
      switchView('advisory-tools');
      setTimeout(() => {
        const select = document.getElementById('advisory-client-select');
        if (select) select.value = sessionId;
      }, 100);
    }

    function showInsightDetail(id) {
      const insight = state.insights.find(i => i.id === id);
      if (!insight) return;

      state.selectedInsight = insight;
      document.getElementById('panel-title').textContent = insight.title;

      // Show source badge (recommendation engine vs rules engine)
      const sourceBadge = insight.source === 'rules_engine'
        ? `<span class="insight-tag irs" style="background:#d1fae5;color:#059669">Rules Engine</span>`
        : `<span class="insight-tag" style="background:#dbeafe;color:#1e40af">AI Analysis</span>`;

      // Determine leverage level (no dollar amounts)
      const leverageLevel = insight.priority === 'critical' ? 'High' :
                           insight.priority === 'high' ? 'Elevated' : 'Moderate';

      document.getElementById('panel-body').innerHTML = `
        <div class="panel-section">
          <div class="panel-section-title">Signal Overview</div>
          <p style="color:var(--gray-600);font-size:13px;line-height:1.6">${escapeHtml(insight.description)}</p>
          <div style="margin-top:16px;display:flex;gap:12px;align-items:center">
            <span style="font-size:18px;font-weight:600;color:var(--primary);">${escapeHtml(leverageLevel)} Leverage</span>
            <span style="color:var(--gray-500);font-size:12px">CPA review recommended</span>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            ${sourceBadge}
            <span class="insight-tag">${escapeHtml(capitalizeFirst(insight.category))}</span>
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">IRS Compliance Reference</div>
          ${insight.irs_reference
            ? `<div class="irs-ref">${escapeHtml(insight.irs_reference)}</div>`
            : `<div style="font-size:12px;color:var(--gray-500)">Based on current tax code guidelines</div>`
          }
          <p style="margin-top:8px;font-size:12px;color:var(--gray-500)">Subject to CPA verification and client-specific analysis.</p>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">Client</div>
          <div style="display:flex;align-items:center;gap:12px">
            <div class="client-avatar">${escapeHtml(getInitials(insight.client || 'Client'))}</div>
            <div>
              <div style="font-weight:600;font-size:13px">${escapeHtml(insight.client || 'Client')}</div>
              <div style="font-size:11px;color:var(--gray-500)">Tax Year 2025</div>
            </div>
          </div>
        </div>
      `;
      document.getElementById('insight-panel').classList.add('active');
    }

    function closePanel() {
      document.getElementById('insight-panel').classList.remove('active');
      state.selectedInsight = null;
    }

    function markImplemented() {
      if (state.selectedInsight) {
        showToast(`Marked "${escapeHtml(state.selectedInsight.title)}" as implemented`, 'success');
        closePanel();
        loadAllData();
      }
    }

    // Navigation
    function switchView(viewName, updateUrl = true) {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.view === viewName);
      });
      document.querySelectorAll('.view').forEach(view => {
        view.classList.toggle('active', view.id === `view-${viewName}`);
      });
      state.currentView = viewName;

      // Update URL hash for browser navigation
      if (updateUrl) {
        history.pushState({ view: viewName }, '', `#${viewName}`);
      }

      if (viewName === 'review') loadReviewQueue();
    }

    // Handle browser back/forward navigation
    window.addEventListener('popstate', (e) => {
      const view = e.state?.view || window.location.hash.slice(1) || 'dashboard';
      if (view && view !== state.currentView) {
        switchView(view, false);
      }
    });

    // Restore view from URL hash on page load
    function initFromUrlHash() {
      const hash = window.location.hash.slice(1);
      const validViews = ['dashboard', 'clients', 'pipeline', 'advisory', 'review', 'reports', 'onboarding'];
      if (hash && validViews.includes(hash)) {
        switchView(hash, false);
      }
    }

    async function loadReviewQueue() {
      try {
        const data = await api('/api/cpa/queue/IN_REVIEW?limit=50');
        const container = document.getElementById('review-queue');
        if (data.success && data.returns?.length > 0) {
          container.innerHTML = data.returns.map(r => `
            <div class="client-row">
              <div class="client-avatar">${escapeHtml(getInitials(r.taxpayer_name || 'Client'))}</div>
              <div class="client-info">
                <div class="client-name">${escapeHtml(r.taxpayer_name || 'Client')}</div>
                <div class="client-detail">Refund: ${formatCurrency(Math.max(0, parseFloat(r.refund_or_owed) || 0))}</div>
              </div>
              <button class="btn btn-primary btn-sm" onclick="approveReturn('${sanitizeId(r.session_id)}')">Approve</button>
            </div>
          `).join('');
        } else {
          container.innerHTML = `<div class="empty-state"><div class="empty-title">No returns pending review</div></div>`;
        }
      } catch (e) {
        console.error('Failed to load review queue:', e);
      }
    }

    async function approveReturn(sessionId) {
      try {
        const data = await api(`/api/cpa/returns/${sessionId}/approve`, {
          method: 'POST',
          body: JSON.stringify({
            cpa_reviewer_id: state.preparerId || 'cpa-001',
            cpa_reviewer_name: 'CPA Reviewer',
          }),
        });
        if (data.success) {
          showToast('Return approved successfully', 'success');
          loadReviewQueue();
          loadQueueCounts();
        }
      } catch (e) {
        showToast('Failed to approve return', 'error');
      }
    }

    function updateDashboard() {
      // Called after all data loads to ensure UI is updated
    }

    function refreshData() {
      loadAllData();
      showToast('Data refreshed', 'success');
    }

    function filterByCategory(category) {
      document.querySelectorAll('.opt-card').forEach(c => c.classList.remove('active'));
      event.currentTarget.classList.add('active');
      // Filter insights by category
      const filtered = state.insights.filter(i => i.category === category);
      renderAllInsights(filtered.length > 0 ? filtered : state.insights);
      switchView('insights');
    }

    function openClient(id) {
      window.location.href = `/?client_id=${id}`;
    }

    // Utilities
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount || 0);
    }

    function getInitials(name) {
      return (name || '').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) || '--';
    }

    function capitalizeFirst(str) {
      return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
    }

    function getPriorityClass(priority) {
      const map = { high: 'savings', critical: 'critical', medium: 'info', low: 'info' };
      return map[priority] || 'info';
    }

    function getCategoryIcon(category) {
      const icons = {
        retirement: '$',
        deductions: '-',
        credits: '+',
        qbi: '%',
        investment: '~',
        filing_status: 'F',
      };
      return icons[category] || '$';
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
    }

    // =============================================================================
    // LEAD PIPELINE FUNCTIONS
    // =============================================================================

    async function loadPipeline() {
      try {
        // Load pipeline by state
        const pipelineData = await api('/api/cpa/leads/pipeline');
        if (pipelineData.success) {
          renderPipeline(pipelineData.pipeline);
          document.getElementById('pipeline-badge').textContent = pipelineData.total_leads || 0;
        }

        // Load metrics
        const metricsData = await api('/api/cpa/leads/pipeline/metrics');
        if (metricsData.success) {
          document.getElementById('metric-total-leads').textContent = metricsData.total_leads || 0;
          document.getElementById('metric-conversion').textContent =
            (metricsData.conversion_rate ? (metricsData.conversion_rate * 100).toFixed(1) : 0) + '%';
          document.getElementById('metric-velocity').textContent = metricsData.avg_days_to_convert || 0;
          document.getElementById('metric-monetizable').textContent =
            formatCurrency(metricsData.total_monetizable_value || 0);
        }
      } catch (e) {
        console.error('Failed to load pipeline:', e);
      }
    }

    function renderPipeline(pipeline) {
      const states = ['ANONYMOUS', 'IDENTIFIED', 'ENGAGED', 'ADVISORY_READY', 'CONVERTED'];

      states.forEach(stateName => {
        const stateKey = stateName.toLowerCase().replace('_', '-');
        const leads = pipeline[stateName] || [];
        const container = document.getElementById(`cards-${stateKey}`);
        const countEl = document.getElementById(`col-${stateKey}`);

        if (countEl) countEl.textContent = leads.length;

        if (container) {
          if (leads.length === 0) {
            container.innerHTML = `<div style="font-size:11px;color:var(--gray-500);text-align:center;padding:20px">No leads</div>`;
          } else {
            container.innerHTML = leads.slice(0, 10).map(lead => `
              <div class="lead-card" style="background:white;border-radius:var(--radius-md);padding:12px;margin-bottom:8px;box-shadow:var(--shadow-sm);cursor:pointer" onclick="showLeadDetail('${sanitizeId(lead.lead_id)}')">
                <div style="font-weight:600;font-size:12px;color:var(--gray-900)">${escapeHtml(lead.name || lead.email || 'Anonymous')}</div>
                <div style="font-size:11px;color:var(--gray-500);margin-top:4px">${escapeHtml(lead.email || 'No email')}</div>
                ${lead.estimated_value ? `<div style="font-size:12px;font-weight:600;color:var(--success);margin-top:6px">${formatCurrency(lead.estimated_value)}</div>` : ''}
                ${stateName !== 'CONVERTED' ? `<button class="btn btn-primary btn-sm" style="margin-top:8px;width:100%;font-size:10px;padding:4px 8px" onclick="event.stopPropagation();advanceLead('${sanitizeId(lead.lead_id)}')">Advance</button>` : ''}
              </div>
            `).join('');
          }
        }
      });
    }

    async function advanceLead(leadId) {
      try {
        const data = await api(`/api/cpa/leads/${leadId}/advance`, { method: 'POST' });
        if (data.success) {
          showToast('Lead advanced successfully', 'success');
          loadPipeline();
        } else {
          showToast(data.error || 'Failed to advance lead', 'error');
        }
      } catch (e) {
        showToast('Failed to advance lead', 'error');
      }
    }

    function showLeadDetail(leadId) {
      // For now, show a toast - in production, this would open a detail panel
      showToast(`Lead ${leadId} selected`, 'info');
    }

    // =============================================================================
    // SCENARIO ANALYSIS FUNCTIONS
    // =============================================================================

    function loadScenarioTemplates() {
      const sessionId = document.getElementById('scenario-client-select').value;
      if (sessionId) {
        document.getElementById('scenario-templates-card').style.display = 'block';
      }
    }

    async function runQuickScenario(templateId) {
      const sessionId = document.getElementById('scenario-client-select').value;
      if (!sessionId) {
        showToast('Please select a client first', 'error');
        return;
      }

      try {
        const data = await api(`/api/cpa/session/${sessionId}/scenarios/quick-compare?template=${templateId}`, {
          method: 'POST'
        });

        if (data.success) {
          document.getElementById('scenario-results-card').style.display = 'block';
          renderScenarioResults(data);
        } else {
          showToast(data.error || 'Failed to run scenario', 'error');
        }
      } catch (e) {
        showToast('Failed to run scenario', 'error');
      }
    }

    function renderScenarioResults(data) {
      const container = document.getElementById('scenario-results');
      const comparison = data.comparison || {};

      container.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
          <div style="padding:20px;background:var(--gray-50);border-radius:var(--radius-md)">
            <div style="font-size:12px;color:var(--gray-500);margin-bottom:8px">Baseline</div>
            <div style="font-size:28px;font-weight:700;color:var(--gray-900)">${formatCurrency(comparison.baseline_tax || 0)}</div>
            <div style="font-size:11px;color:var(--gray-500);margin-top:4px">Total Tax Liability</div>
          </div>
          <div style="padding:20px;background:var(--success-light);border-radius:var(--radius-md)">
            <div style="font-size:12px;color:var(--gray-500);margin-bottom:8px">With Changes</div>
            <div style="font-size:28px;font-weight:700;color:var(--success)">${formatCurrency(comparison.scenario_tax || 0)}</div>
            <div style="font-size:11px;color:var(--gray-500);margin-top:4px">Total Tax Liability</div>
          </div>
        </div>
        <div style="margin-top:24px;padding:20px;background:var(--primary-light);border-radius:var(--radius-md);text-align:center">
          <div style="font-size:14px;color:var(--gray-700)">Potential Savings</div>
          <div style="font-size:36px;font-weight:700;color:var(--primary);margin-top:8px">${formatCurrency(comparison.savings || 0)}</div>
        </div>
        ${comparison.notes ? `<div style="margin-top:16px;font-size:12px;color:var(--gray-600)">${comparison.notes}</div>` : ''}
      `;
    }

    // =============================================================================
    // ADVISORY TOOLS FUNCTIONS
    // =============================================================================

    function updateAdvisoryTools() {
      const sessionId = document.getElementById('advisory-client-select').value;
      if (sessionId) {
        document.getElementById('advisory-tools-grid').style.opacity = '1';
      }
    }

    // Loading state helper for analysis functions
    function showAnalysisLoading(title) {
      const resultsCard = document.getElementById('advisory-results-card');
      resultsCard.style.display = 'block';
      document.getElementById('advisory-results-title').textContent = title;
      document.getElementById('advisory-results').innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;padding:40px">
          <div class="loading-spinner" style="width:32px;height:32px;border-width:3px;margin-bottom:16px"></div>
          <div style="color:var(--gray-600);font-size:14px">Analyzing tax data...</div>
        </div>
      `;
    }

    async function runCreditAnalysis() {
      const sessionId = document.getElementById('advisory-client-select').value;
      if (!sessionId) { showToast('Please select a client', 'error'); return; }

      showAnalysisLoading('Credit Analysis');
      try {
        const data = await api(`/api/cpa/session/${sessionId}/credits/analyze`, { method: 'POST' });
        if (data.success) {
          showAdvisoryResults('Credit Analysis', data);
        } else {
          showToast(data.error || 'Credit analysis failed', 'error');
          document.getElementById('advisory-results-card').style.display = 'none';
        }
      } catch (e) {
        showToast('Credit analysis failed. Please try again.', 'error');
        document.getElementById('advisory-results-card').style.display = 'none';
      }
    }

    async function runDeductionAnalysis() {
      const sessionId = document.getElementById('advisory-client-select').value;
      if (!sessionId) { showToast('Please select a client', 'error'); return; }

      showAnalysisLoading('Deduction Analysis');
      try {
        const data = await api(`/api/cpa/session/${sessionId}/deductions/analyze`, { method: 'POST' });
        if (data.success) {
          showAdvisoryResults('Deduction Analysis', data);
        } else {
          showToast(data.error || 'Deduction analysis failed', 'error');
          document.getElementById('advisory-results-card').style.display = 'none';
        }
      } catch (e) {
        showToast('Deduction analysis failed. Please try again.', 'error');
        document.getElementById('advisory-results-card').style.display = 'none';
      }
    }

    async function runFilingStatusAnalysis() {
      const sessionId = document.getElementById('advisory-client-select').value;
      if (!sessionId) { showToast('Please select a client', 'error'); return; }

      showAnalysisLoading('Filing Status Comparison');
      try {
        const data = await api(`/api/cpa/session/${sessionId}/filing-status/compare`, { method: 'POST' });
        if (data.success) {
          showAdvisoryResults('Filing Status Comparison', data);
        } else {
          showToast(data.error || 'Filing status analysis failed', 'error');
          document.getElementById('advisory-results-card').style.display = 'none';
        }
      } catch (e) {
        showToast('Filing status analysis failed. Please try again.', 'error');
        document.getElementById('advisory-results-card').style.display = 'none';
      }
    }

    async function runEntityAnalysis() {
      const sessionId = document.getElementById('advisory-client-select').value;
      if (!sessionId) { showToast('Please select a client', 'error'); return; }

      showAnalysisLoading('Entity Structure Comparison');
      try {
        const data = await api(`/api/cpa/session/${sessionId}/entity/compare`, { method: 'POST' });
        if (data.success) {
          showAdvisoryResults('Entity Structure Comparison', data);
        } else {
          showToast(data.error || 'Entity analysis failed', 'error');
          document.getElementById('advisory-results-card').style.display = 'none';
        }
      } catch (e) {
        showToast('Entity analysis failed. Please try again.', 'error');
        document.getElementById('advisory-results-card').style.display = 'none';
      }
    }

    async function runFullStrategy() {
      const sessionId = document.getElementById('advisory-client-select').value;
      if (!sessionId) { showToast('Please select a client', 'error'); return; }

      showAnalysisLoading('Full Tax Strategy');
      try {
        const data = await api(`/api/cpa/session/${sessionId}/strategy/analyze`, { method: 'POST' });
        if (data.success) {
          showAdvisoryResults('Full Tax Strategy', data);
        } else {
          showToast(data.error || 'Strategy analysis failed', 'error');
          document.getElementById('advisory-results-card').style.display = 'none';
        }
      } catch (e) {
        showToast('Strategy analysis failed. Please try again.', 'error');
        document.getElementById('advisory-results-card').style.display = 'none';
      }
    }

    function showAdvisoryResults(title, data) {
      document.getElementById('advisory-results-card').style.display = 'block';
      document.getElementById('advisory-results-title').textContent = title;

      const results = data.analysis || data.comparison || data.credits || data.deductions || data;
      let html = '';

      if (results.total_savings !== undefined) {
        html += `<div style="padding:20px;background:var(--success-light);border-radius:var(--radius-md);text-align:center;margin-bottom:20px">
          <div style="font-size:14px;color:var(--gray-700)">Total Potential Savings</div>
          <div style="font-size:36px;font-weight:700;color:var(--success)">${formatCurrency(results.total_savings)}</div>
        </div>`;
      }

      if (results.recommendations) {
        html += `<div style="margin-bottom:16px"><div style="font-weight:600;margin-bottom:8px">Recommendations</div>`;
        results.recommendations.forEach(rec => {
          html += `<div style="padding:12px;background:var(--gray-50);border-radius:var(--radius-md);margin-bottom:8px">
            <div style="font-weight:500">${escapeHtml(rec.title || rec.name || 'Recommendation')}</div>
            <div style="font-size:12px;color:var(--gray-600);margin-top:4px">${escapeHtml(rec.description || '')}</div>
            ${rec.savings ? `<div style="font-weight:600;color:var(--success);margin-top:4px">+${formatCurrency(rec.savings)}</div>` : ''}
          </div>`;
        });
        html += '</div>';
      }

      if (results.summary) {
        html += `<div style="font-size:13px;color:var(--gray-600);line-height:1.6">${escapeHtml(results.summary)}</div>`;
      }

      document.getElementById('advisory-results').innerHTML = html || '<div style="color:var(--gray-500)">Analysis complete. See details above.</div>';
    }

    async function generateAdvisoryReport() {
      const sessionId = document.getElementById('advisory-client-select').value;
      if (!sessionId) { showToast('Please select a client', 'error'); return; }
      switchView('reports');
      document.getElementById('report-client-select').value = sessionId;
      loadReportSections();
    }

    // =============================================================================
    // DOCUMENT CENTER FUNCTIONS
    // =============================================================================

    async function loadClientDocuments() {
      const sessionId = document.getElementById('document-client-select').value;
      if (!sessionId) return;

      try {
        const data = await api(`/api/cpa/session/${sessionId}/documents`);
        const container = document.getElementById('document-list');

        if (data.success && data.documents?.length > 0) {
          container.innerHTML = data.documents.map(doc => `
            <div class="client-row">
              <div class="client-avatar" style="background:var(--info-light);color:var(--info)">${doc.document_type?.slice(0,2).toUpperCase() || 'DOC'}</div>
              <div class="client-info">
                <div class="client-name">${doc.filename || 'Document'}</div>
                <div class="client-detail">${doc.document_type || 'Unknown type'} | ${doc.status || 'Processing'}</div>
              </div>
              <div style="display:flex;gap:8px">
                ${doc.status === 'completed' ? `<button class="btn btn-ghost btn-sm" onclick="viewExtracted('${sessionId}', '${doc.document_id}')">View Data</button>` : ''}
                ${doc.status === 'completed' ? `<button class="btn btn-primary btn-sm" onclick="applyDocument('${sessionId}', '${doc.document_id}')">Apply</button>` : ''}
              </div>
            </div>
          `).join('');
        } else {
          container.innerHTML = `<div class="empty-state"><div class="empty-title">No documents uploaded</div></div>`;
        }
      } catch (e) {
        console.error('Failed to load documents:', e);
      }
    }

    function handleFileDrop(event) {
      event.preventDefault();
      const files = event.dataTransfer.files;
      uploadFiles(files);
    }

    function handleFileUpload(event) {
      const files = event.target.files;
      uploadFiles(files);
    }

    async function uploadFiles(files) {
      const sessionId = document.getElementById('document-client-select').value;
      if (!sessionId) {
        showToast('Please select a client first', 'error');
        return;
      }

      for (const file of files) {
        const formData = new FormData();
        formData.append('file', file);

        try {
          const response = await fetch(`/api/cpa/session/${sessionId}/documents/upload`, {
            method: 'POST',
            body: formData,
          });
          const data = await response.json();

          if (data.success) {
            showToast(`Uploaded: ${escapeHtml(file.name)}`, 'success');
          } else {
            showToast(`Failed to upload: ${escapeHtml(file.name)}`, 'error');
          }
        } catch (e) {
          showToast(`Upload error: ${escapeHtml(file.name)}`, 'error');
        }
      }

      loadClientDocuments();
    }

    async function viewExtracted(sessionId, documentId) {
      try {
        const data = await api(`/api/cpa/session/${sessionId}/documents/${documentId}/extracted`);
        if (data.success && data.extracted_data) {
          // Show extracted data in a modal-like overlay
          const overlay = document.createElement('div');
          overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
          overlay.innerHTML = `
            <div style="background:white;padding:24px;border-radius:12px;max-width:600px;max-height:80vh;overflow:auto;margin:20px;">
              <h3 style="margin:0 0 16px;font-size:18px;font-weight:600;">Extracted Document Data</h3>
              <pre style="background:#f3f4f6;padding:16px;border-radius:8px;overflow:auto;font-size:12px;white-space:pre-wrap;">${escapeHtml(JSON.stringify(data.extracted_data, null, 2))}</pre>
              <button onclick="this.closest('div').parentElement.remove()" style="margin-top:16px;padding:8px 16px;background:#6366f1;color:white;border:none;border-radius:6px;cursor:pointer;">Close</button>
            </div>
          `;
          overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
          document.body.appendChild(overlay);
        }
      } catch (e) {
        showToast('Failed to load extracted data', 'error');
      }
    }

    async function applyDocument(sessionId, documentId) {
      try {
        const data = await api(`/api/cpa/session/${sessionId}/documents/${documentId}/apply`, { method: 'POST' });
        if (data.success) {
          showToast('Document data applied to return', 'success');
        } else {
          showToast(data.error || 'Failed to apply document', 'error');
        }
      } catch (e) {
        showToast('Failed to apply document', 'error');
      }
    }

    // =============================================================================
    // PRICING CALCULATOR FUNCTIONS
    // =============================================================================

    async function calculatePricing() {
      const sessionId = document.getElementById('pricing-client-select').value;
      if (!sessionId) return;

      try {
        const data = await api(`/api/cpa/session/${sessionId}/pricing/calculate`, { method: 'POST' });

        if (data.success) {
          document.getElementById('pricing-result-card').style.display = 'block';
          document.getElementById('pricing-result').innerHTML = `
            <div style="text-align:center;padding:20px">
              <div style="font-size:14px;color:var(--gray-500)">Complexity Tier</div>
              <div style="font-size:24px;font-weight:700;color:var(--gray-900);margin-top:8px">${data.tier || 'Standard'}</div>
              <div style="font-size:48px;font-weight:700;color:var(--primary);margin-top:16px">${formatCurrency(data.price || data.base_price || 350)}</div>
              <div style="font-size:12px;color:var(--gray-500);margin-top:8px">Recommended Price</div>
              ${data.complexity_factors ? `
                <div style="margin-top:24px;text-align:left">
                  <div style="font-weight:600;margin-bottom:8px">Complexity Factors</div>
                  ${data.complexity_factors.map(f => `<div style="font-size:12px;color:var(--gray-600);padding:4px 0">- ${f}</div>`).join('')}
                </div>
              ` : ''}
              <button class="btn btn-primary" style="margin-top:24px" onclick="generateQuote('${sessionId}')">Generate Quote</button>
            </div>
          `;
        }
      } catch (e) {
        showToast('Failed to calculate pricing', 'error');
      }
    }

    async function generateQuote(sessionId) {
      try {
        const data = await api(`/api/cpa/session/${sessionId}/pricing/quote`, { method: 'POST' });
        if (data.success) {
          showToast('Quote generated! View in Engagement Letters', 'success');
        }
      } catch (e) {
        showToast('Failed to generate quote', 'error');
      }
    }

    // =============================================================================
    // CLIENT INTAKE FUNCTIONS
    // =============================================================================

    function startNewIntake() {
      document.getElementById('intake-form-card').style.display = 'block';
    }

    function cancelIntake() {
      document.getElementById('intake-form-card').style.display = 'none';
      document.getElementById('intake-form').reset();
    }

    async function submitIntake(event) {
      event.preventDefault();

      const intakeData = {
        first_name: document.getElementById('intake-first-name').value,
        last_name: document.getElementById('intake-last-name').value,
        email: document.getElementById('intake-email').value,
        tax_year: parseInt(document.getElementById('intake-tax-year').value),
        filing_status: document.getElementById('intake-filing-status').value,
      };

      try {
        const data = await api('/api/cpa/clients/intake/start', {
          method: 'POST',
          body: JSON.stringify(intakeData),
        });

        if (data.success) {
          showToast('Client intake started', 'success');
          cancelIntake();
          loadActiveIntakes();
        } else {
          showToast(data.error || 'Failed to start intake', 'error');
        }
      } catch (e) {
        showToast('Failed to start intake', 'error');
      }
    }

    async function loadActiveIntakes() {
      // This would load active intakes from the API
      // For now, show empty state
    }

    // =============================================================================
    // ADVISORY REPORT FUNCTIONS
    // =============================================================================

    async function loadReportSections() {
      const sessionId = document.getElementById('report-client-select').value;
      if (!sessionId) return;

      try {
        const data = await api(`/api/cpa/session/${sessionId}/report/sections`);

        if (data.success) {
          document.getElementById('report-sections-card').style.display = 'block';
          document.getElementById('report-actions').style.display = 'flex';

          const sections = data.sections || [];
          document.getElementById('report-sections').innerHTML = sections.map(section => `
            <label style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--gray-100)">
              <input type="checkbox" name="report-section" value="${escapeHtml(section.id)}" checked>
              <span style="font-weight:500">${escapeHtml(section.name)}</span>
              <span style="font-size:11px;color:var(--gray-500);margin-left:auto">${escapeHtml(section.description || '')}</span>
            </label>
          `).join('');
        }
      } catch (e) {
        console.error('Failed to load report sections:', e);
      }
    }

    async function generateReport() {
      const sessionId = document.getElementById('report-client-select').value;
      if (!sessionId) { showToast('Please select a client', 'error'); return; }

      const selectedSections = Array.from(document.querySelectorAll('input[name="report-section"]:checked'))
        .map(cb => cb.value);

      try {
        const data = await api(`/api/cpa/session/${sessionId}/report/generate`, {
          method: 'POST',
          body: JSON.stringify({ sections: selectedSections }),
        });

        if (data.success) {
          document.getElementById('report-preview-card').style.display = 'block';

          const report = data.report || {};
          let html = `
            <div style="padding:20px;background:var(--gray-50);border-radius:var(--radius-md);margin-bottom:20px">
              <h2 style="font-size:20px;margin-bottom:8px">${escapeHtml(report.title || 'Tax Advisory Report')}</h2>
              <div style="font-size:13px;color:var(--gray-600)">
                Client: ${escapeHtml(report.client_name || 'Client')} | Tax Year: ${escapeHtml(String(report.tax_year || 2025))}
              </div>
              <div style="font-size:24px;font-weight:700;color:var(--success);margin-top:12px">
                Total Potential Savings: ${formatCurrency(report.total_potential_savings || 0)}
              </div>
            </div>
          `;

          if (report.sections) {
            report.sections.forEach(section => {
              html += `
                <div style="margin-bottom:20px">
                  <h3 style="font-size:16px;font-weight:600;margin-bottom:8px;color:var(--gray-900)">${escapeHtml(section.title || 'Section')}</h3>
                  <div style="font-size:13px;color:var(--gray-700);line-height:1.6;white-space:pre-wrap">${escapeHtml(section.content || '')}</div>
                </div>
              `;
            });
          }

          document.getElementById('report-preview').innerHTML = html;
          showToast('Report generated', 'success');
        } else {
          showToast(data.error || 'Failed to generate report', 'error');
        }
      } catch (e) {
        showToast('Failed to generate report', 'error');
      }
    }

    async function downloadReport(format) {
      const sessionId = document.getElementById('report-client-select').value;
      if (!sessionId) { showToast('Please select a client', 'error'); return; }

      try {
        const data = await api(`/api/cpa/session/${sessionId}/report/download?format=${format}`);
        if (data.success) {
          // Create download link
          const blob = new Blob([data.content], { type: format === 'html' ? 'text/html' : 'text/markdown' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = data.filename || `report.${format === 'html' ? 'html' : 'md'}`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showToast('Report downloaded', 'success');
        }
      } catch (e) {
        showToast('Failed to download report', 'error');
      }
    }

    function printReport() {
      // Ensure report is generated first
      const previewCard = document.getElementById('report-preview-card');
      if (!previewCard || previewCard.style.display === 'none') {
        showToast('Please generate a report first', 'warning');
        return;
      }

      // Trigger browser print dialog (user can choose "Save as PDF")
      window.print();
    }

    // =============================================================================
    // POPULATE CLIENT SELECTORS
    // =============================================================================

    function populateClientSelectors() {
      const selectors = [
        'scenario-client-select',
        'advisory-client-select',
        'document-client-select',
        'pricing-client-select',
        'report-client-select',
      ];

      selectors.forEach(selectorId => {
        const select = document.getElementById(selectorId);
        if (select && state.clients.length > 0) {
          const currentValue = select.value;
          select.innerHTML = '<option value="">-- Select a Client --</option>';
          state.clients.forEach(client => {
            const option = document.createElement('option');
            option.value = client.id;
            option.textContent = client.name;
            select.appendChild(option);
          });
          if (currentValue) select.value = currentValue;
        }
      });
    }

    // Override loadClients to also populate selectors
    const originalLoadClients = loadClients;
    loadClients = async function() {
      await originalLoadClients();
      populateClientSelectors();
    };

    // Load pipeline when switching to that view
    const originalSwitchView = switchView;
    switchView = function(viewName) {
      originalSwitchView(viewName);
      if (viewName === 'pipeline') loadPipeline();
    };

    // =============================================================================
    // CPA FIRST LOGIN FUNCTIONS
    // =============================================================================

    // Check if first login and show modal
    function checkFirstLogin() {
      const hasSetup = localStorage.getItem('cpa_practice_setup_complete');
      if (!hasSetup) {
        document.getElementById('first-login-modal').classList.add('active');
      }
    }

    function nextSetupStep(step) {
      document.querySelectorAll('.setup-step').forEach(s => s.style.display = 'none');
      document.getElementById(`setup-step-${step}`).style.display = 'block';
    }

    function completeSetup() {
      // Save practice info
      const practiceInfo = {
        name: document.getElementById('setup-name').value,
        firm: document.getElementById('setup-firm').value,
        credentials: [],
        clientTypes: [],
        clientCount: document.getElementById('setup-client-count').value,
      };

      if (document.getElementById('cred-cpa').checked) practiceInfo.credentials.push('CPA');
      if (document.getElementById('cred-ea').checked) practiceInfo.credentials.push('EA');
      if (document.getElementById('cred-jd').checked) practiceInfo.credentials.push('JD');
      if (document.getElementById('cred-cfp').checked) practiceInfo.credentials.push('CFP');
      if (document.getElementById('focus-individual').checked) practiceInfo.clientTypes.push('individual');
      if (document.getElementById('focus-small-biz').checked) practiceInfo.clientTypes.push('small_business');

      localStorage.setItem('cpa_practice_info', JSON.stringify(practiceInfo));
      localStorage.setItem('cpa_practice_setup_complete', 'true');

      nextSetupStep(3);
    }

    function closeFirstLogin() {
      document.getElementById('first-login-modal').classList.remove('active');
    }

    function closeFirstLoginAndStartOnboarding() {
      closeFirstLogin();
      openSmartOnboarding();
    }

    // =============================================================================
    // SMART ONBOARDING FUNCTIONS
    // =============================================================================

    // Onboarding state
    const onboardState = {
      sessionId: null,
      questions: [],
      answers: {},
      analysis: null,
      parsedData: null,
      opportunities: [],
      totalSavings: 0,
    };

    function openSmartOnboarding() {
      // Reset state
      onboardState.sessionId = null;
      onboardState.questions = [];
      onboardState.answers = {};
      onboardState.analysis = null;
      onboardState.opportunities = [];
      onboardState.totalSavings = 0;

      // Reset UI to step 1
      document.querySelectorAll('.onboard-step').forEach(s => s.style.display = 'none');
      document.getElementById('onboard-step-1').style.display = 'block';
      document.getElementById('onboard-progress-bar').style.width = '25%';
      document.querySelectorAll('.onboard-step-label').forEach(l => l.classList.remove('active', 'completed'));
      document.querySelector('.onboard-step-label[data-step="1"]').classList.add('active');
      document.getElementById('onboard-dropzone').style.display = 'block';
      document.getElementById('onboard-upload-status').style.display = 'none';

      // Start a new session
      startOnboardingSession();

      document.getElementById('smart-onboarding-modal').classList.add('active');
    }

    function closeSmartOnboarding() {
      document.getElementById('smart-onboarding-modal').classList.remove('active');
      loadAllData(); // Refresh dashboard
    }

    async function startOnboardingSession() {
      try {
        const data = await api('/api/cpa/onboarding/start', { method: 'POST' });
        if (data.success) {
          onboardState.sessionId = data.session_id;
        }
      } catch (e) {
        console.error('Failed to start onboarding session:', e);
        // Generate a fallback session ID
        onboardState.sessionId = 'ob-' + Date.now();
      }
    }

    function goToOnboardStep(step) {
      document.querySelectorAll('.onboard-step').forEach(s => s.style.display = 'none');
      document.getElementById(`onboard-step-${step}`).style.display = 'block';

      // Update progress bar
      const progressWidth = step * 25;
      document.getElementById('onboard-progress-bar').style.width = progressWidth + '%';

      // Update step labels
      document.querySelectorAll('.onboard-step-label').forEach(l => {
        const labelStep = parseInt(l.dataset.step);
        l.classList.remove('active', 'completed');
        if (labelStep < step) l.classList.add('completed');
        if (labelStep === step) l.classList.add('active');
      });
    }

    // Handle file drop
    function handleOnboardDrop(event) {
      event.preventDefault();
      event.target.classList.remove('drop-zone-active');
      const files = event.dataTransfer.files;
      if (files.length > 0) {
        processOnboardFile(files[0]);
      }
    }

    // Handle file select
    function handleOnboardFileSelect(event) {
      const files = event.target.files;
      if (files.length > 0) {
        processOnboardFile(files[0]);
      }
    }

    // Process uploaded file
    async function processOnboardFile(file) {
      document.getElementById('onboard-dropzone').style.display = 'none';
      document.getElementById('onboard-upload-status').style.display = 'block';
      document.getElementById('onboard-status-text').textContent = 'Uploading document...';

      try {
        const formData = new FormData();
        formData.append('file', file);

        document.getElementById('onboard-status-text').textContent = 'Processing with OCR...';

        const response = await fetch(`/api/cpa/onboarding/${onboardState.sessionId}/upload`, {
          method: 'POST',
          body: formData,
        });
        const data = await response.json();

        if (data.success) {
          onboardState.parsedData = data.parsed_data || {};
          document.getElementById('onboard-status-text').textContent = 'Generating smart questions...';

          // Pre-fill client info if available
          if (data.parsed_data) {
            if (data.parsed_data.taxpayer_name) {
              const nameParts = data.parsed_data.taxpayer_name.split(' ');
              document.getElementById('onboard-first-name').value = nameParts[0] || '';
              document.getElementById('onboard-last-name').value = nameParts.slice(1).join(' ') || '';
            }
            if (data.parsed_data.filing_status) {
              document.getElementById('onboard-filing-status').value = data.parsed_data.filing_status;
            }
          }

          // Load questions
          await loadSmartQuestions();
        } else {
          showToast(data.error || 'Failed to process document', 'error');
          document.getElementById('onboard-dropzone').style.display = 'block';
          document.getElementById('onboard-upload-status').style.display = 'none';
        }
      } catch (e) {
        console.error('Upload error:', e);
        showToast('Failed to upload document', 'error');
        document.getElementById('onboard-dropzone').style.display = 'block';
        document.getElementById('onboard-upload-status').style.display = 'none';
      }
    }

    // Skip to manual entry
    async function skipToManualEntry() {
      // Load demo questions for manual entry
      await loadSmartQuestions(true);
    }

    // Load smart questions from API
    async function loadSmartQuestions(isManual = false) {
      try {
        const data = await api(`/api/cpa/onboarding/${onboardState.sessionId}/questions`);

        if (data.success && data.questions && data.questions.questions) {
          onboardState.questions = data.questions.questions;
          renderSmartQuestions(onboardState.questions);
          goToOnboardStep(2);
        } else {
          // Use demo questions
          onboardState.questions = getDemoQuestions();
          renderSmartQuestions(onboardState.questions);
          goToOnboardStep(2);
        }
      } catch (e) {
        console.error('Failed to load questions:', e);
        // Use demo questions as fallback
        onboardState.questions = getDemoQuestions();
        renderSmartQuestions(onboardState.questions);
        goToOnboardStep(2);
      }
    }

    function getDemoQuestions() {
      return [
        {
          question_id: 'q1',
          question_text: 'Are you contributing to a 401(k) or employer retirement plan?',
          category: 'retirement',
          potential_savings: 2400,
          options: ['Yes, max contributions', 'Yes, partial', 'No', 'Not sure'],
        },
        {
          question_id: 'q2',
          question_text: 'Do you have a High Deductible Health Plan (HDHP)?',
          category: 'healthcare',
          potential_savings: 1200,
          options: ['Yes', 'No', 'Not sure'],
        },
        {
          question_id: 'q3',
          question_text: 'Do you have dependents under 17?',
          category: 'credits',
          potential_savings: 2000,
          options: ['Yes, 1', 'Yes, 2+', 'No'],
        },
        {
          question_id: 'q4',
          question_text: 'Do you work from home for your employer?',
          category: 'deductions',
          potential_savings: 1500,
          options: ['Yes, full-time', 'Yes, part-time', 'No'],
        },
      ];
    }

    function renderSmartQuestions(questions) {
      const container = document.getElementById('smart-questions-container');
      container.innerHTML = questions.map(q => `
        <div class="smart-question" data-question-id="${q.question_id}">
          <div class="smart-question-header">
            <div class="smart-question-text">${q.question_text}</div>
            ${q.potential_savings ? `<div class="smart-question-savings">Up to ${formatCurrency(q.potential_savings)}</div>` : ''}
          </div>
          <div class="smart-question-options">
            ${q.options.map(opt => `
              <div class="smart-question-option" onclick="selectQuestionOption('${q.question_id}', '${opt}', this)">${opt}</div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    function selectQuestionOption(questionId, option, element) {
      onboardState.answers[questionId] = option;

      // Update UI
      element.parentElement.querySelectorAll('.smart-question-option').forEach(o => o.classList.remove('selected'));
      element.classList.add('selected');
    }

    // Submit answers and get analysis
    async function submitOnboardAnswers() {
      try {
        const data = await api(`/api/cpa/onboarding/${onboardState.sessionId}/answers`, {
          method: 'POST',
          body: JSON.stringify({ answers: onboardState.answers }),
        });

        if (data.success && data.session) {
          onboardState.analysis = data.session.instant_analysis || {};
          onboardState.opportunities = data.session.instant_analysis?.opportunities || [];
          onboardState.totalSavings = data.session.instant_analysis?.total_potential_savings || 0;

          renderAnalysisResults();
          goToOnboardStep(3);
        } else {
          // Generate demo analysis
          generateDemoAnalysis();
          goToOnboardStep(3);
        }
      } catch (e) {
        console.error('Failed to submit answers:', e);
        generateDemoAnalysis();
        goToOnboardStep(3);
      }
    }

    function generateDemoAnalysis() {
      // Create demo opportunities based on answers
      const opportunities = [];
      let total = 0;

      if (onboardState.answers['q1'] && onboardState.answers['q1'] !== 'Yes, max contributions') {
        opportunities.push({
          category: 'retirement',
          title: '401(k) Contribution Optimization',
          description: 'Increasing retirement contributions could reduce taxable income',
          estimated_savings: 2400,
        });
        total += 2400;
      }

      if (onboardState.answers['q2'] === 'Yes') {
        opportunities.push({
          category: 'healthcare',
          title: 'HSA Contribution Opportunity',
          description: 'Maximize HSA contributions for triple tax advantage',
          estimated_savings: 1200,
        });
        total += 1200;
      }

      if (onboardState.answers['q3'] && onboardState.answers['q3'] !== 'No') {
        opportunities.push({
          category: 'credits',
          title: 'Child Tax Credit',
          description: 'Eligible for child tax credit based on dependents',
          estimated_savings: 2000,
        });
        total += 2000;
      }

      if (onboardState.answers['q4'] && onboardState.answers['q4'] !== 'No') {
        opportunities.push({
          category: 'deductions',
          title: 'Home Office Deduction Potential',
          description: 'May qualify for home office deductions',
          estimated_savings: 1500,
        });
        total += 1500;
      }

      // Add a default if no opportunities
      if (opportunities.length === 0) {
        opportunities.push({
          category: 'deductions',
          title: 'Standard Deduction Analysis',
          description: 'Review itemized vs standard deduction',
          estimated_savings: 500,
        });
        total = 500;
      }

      onboardState.opportunities = opportunities;
      onboardState.totalSavings = total;
      renderAnalysisResults();
    }

    function renderAnalysisResults() {
      document.getElementById('onboard-total-savings').textContent = formatCurrency(onboardState.totalSavings);
      document.getElementById('onboard-opp-count').textContent = onboardState.opportunities.length;

      const container = document.getElementById('onboard-opportunities');
      container.innerHTML = onboardState.opportunities.map(opp => `
        <div class="opportunity-card">
          <div class="opportunity-icon ${escapeHtml(opp.category)}">${getCategoryIcon(opp.category)}</div>
          <div class="opportunity-content">
            <div class="opportunity-title">${escapeHtml(opp.title)}</div>
            <div class="opportunity-desc">${escapeHtml(opp.description)}</div>
          </div>
          <div class="opportunity-savings">+${formatCurrency(opp.estimated_savings)}</div>
        </div>
      `).join('');

      // Update step 4 summary
      document.getElementById('onboard-summary-opps').textContent = onboardState.opportunities.length;
      document.getElementById('onboard-summary-savings').textContent = formatCurrency(onboardState.totalSavings);
    }

    // Create client from onboarding
    async function createClientFromOnboarding() {
      const btn = document.getElementById('create-client-btn');
      setButtonLoading(btn, true);

      const clientData = {
        first_name: document.getElementById('onboard-first-name').value || 'New',
        last_name: document.getElementById('onboard-last-name').value || 'Client',
        email: document.getElementById('onboard-email').value || '',
        filing_status: document.getElementById('onboard-filing-status').value,
        tax_year: parseInt(document.getElementById('onboard-tax-year').value),
      };

      try {
        const data = await api(`/api/cpa/onboarding/${onboardState.sessionId}/create-client`, {
          method: 'POST',
          body: JSON.stringify(clientData),
        });

        setButtonLoading(btn, false);

        if (data.success) {
          onboardState.clientId = data.client_id;
          document.getElementById('created-client-name').textContent = `${clientData.first_name} ${clientData.last_name}`;
          document.getElementById('created-savings').textContent = formatCurrency(onboardState.totalSavings);
          goToOnboardStep(5);
        } else {
          // Demo mode - simulate success
          onboardState.clientId = 'client-' + Date.now();
          document.getElementById('created-client-name').textContent = `${clientData.first_name} ${clientData.last_name}`;
          document.getElementById('created-savings').textContent = formatCurrency(onboardState.totalSavings);
          goToOnboardStep(5);
        }
      } catch (e) {
        console.error('Failed to create client:', e);
        setButtonLoading(btn, false);
        // Demo mode
        onboardState.clientId = 'client-' + Date.now();
        document.getElementById('created-client-name').textContent = `${clientData.first_name} ${clientData.last_name}`;
        document.getElementById('created-savings').textContent = formatCurrency(onboardState.totalSavings);
        goToOnboardStep(5);
      }
    }

    function viewCreatedClient() {
      closeSmartOnboarding();
      if (onboardState.clientId) {
        openClientDetail(onboardState.clientId);
      }
    }

    // =============================================================================
    // CLIENT DETAIL MODAL FUNCTIONS
    // =============================================================================

    const clientDetailState = {
      clientId: null,
      clientData: null,
      opportunities: [],
    };

    function openClientDetail(clientId) {
      clientDetailState.clientId = clientId;
      document.getElementById('client-detail-modal').classList.add('active');

      // Reset to overview tab
      switchClientTab('overview');

      // Show loading state
      document.getElementById('detail-client-name').textContent = 'Loading...';
      document.getElementById('detail-total-savings').textContent = '...';
      document.getElementById('detail-agi').textContent = '...';
      document.getElementById('detail-total-tax').textContent = '...';

      // Load client data
      loadClientDetailData(clientId);
    }

    function closeClientDetail() {
      document.getElementById('client-detail-modal').classList.remove('active');
    }

    function switchClientTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      document.querySelectorAll('.client-tab').forEach(tab => {
        tab.style.display = tab.id === `client-tab-${tabName}` ? 'block' : 'none';
      });
    }

    async function loadClientDetailData(clientId) {
      // Try to load from CPA API first
      try {
        const data = await api(`/api/cpa/insights/client/${clientId}`);
        if (data.success) {
          updateClientDetailUI(data);

          // Also load from Core Platform API for enhanced data
          loadCoreClientData(clientId);
          return;
        }
      } catch (e) {
      }

      // Try Core Platform API as fallback
      try {
        const [profile, recommendations, returns] = await Promise.all([
          coreApi(`/users/${clientId}`).catch(() => null),
          coreApi(`/recommendations?user_id=${clientId}`).catch(() => []),
          coreApi(`/tax-returns?user_id=${clientId}`).catch(() => [])
        ]);

        if (profile) {
          const taxReturn = returns[0] || {};
          const totalSavings = recommendations.reduce((sum, r) => sum + (r.estimated_savings_high || 0), 0);

          updateClientDetailUI({
            client_name: profile.full_name || `${profile.first_name} ${profile.last_name}`,
            tax_year: taxReturn.tax_year || 2024,
            filing_status: 'Single',
            agi: taxReturn.adjusted_gross_income || 0,
            total_tax: taxReturn.total_tax || 0,
            effective_rate: taxReturn.gross_income > 0 ? (taxReturn.total_tax / taxReturn.gross_income * 100) : 0,
            refund_or_owed: taxReturn.refund_amount || -taxReturn.amount_due || 0,
            total_potential_savings: totalSavings,
            opportunities: recommendations.map(r => ({
              category: r.category,
              title: r.title,
              description: r.summary,
              estimated_savings: r.estimated_savings_high
            }))
          });
          return;
        }
      } catch (e) {
      }

      // Use demo data from onboarding if available
      const firstName = document.getElementById('onboard-first-name')?.value || 'Demo';
      const lastName = document.getElementById('onboard-last-name')?.value || 'Client';

      const demoData = {
        client_name: `${firstName} ${lastName}`,
        tax_year: 2024,
        filing_status: 'Single',
        agi: 85000,
        total_tax: 12500,
        effective_rate: 14.7,
        refund_or_owed: 1250,
        total_potential_savings: onboardState.totalSavings || 4500,
        opportunities: onboardState.opportunities.length > 0 ? onboardState.opportunities : [
          { category: 'retirement', title: '401(k) Optimization', description: 'Maximize retirement contributions', estimated_savings: 2400 },
          { category: 'healthcare', title: 'HSA Opportunity', description: 'Triple tax advantage available', estimated_savings: 1200 },
          { category: 'deductions', title: 'Home Office', description: 'Potential deduction for remote work', estimated_savings: 900 },
        ],
      };

      updateClientDetailUI(demoData);
    }

    function updateClientDetailUI(data) {
      clientDetailState.clientData = data;
      clientDetailState.opportunities = data.opportunities || [];

      // Update header
      document.getElementById('detail-client-avatar').textContent = getInitials(data.client_name || 'Client');
      document.getElementById('detail-client-name').textContent = data.client_name || 'Client';
      document.getElementById('detail-tax-year').textContent = data.tax_year || 2024;
      document.getElementById('detail-filing-status').textContent = data.filing_status || 'Single';

      // Update metrics
      document.getElementById('detail-total-savings').textContent = formatCurrency(data.total_potential_savings || 0);
      document.getElementById('detail-opp-count').textContent = (data.opportunities || []).length;
      document.getElementById('detail-agi').textContent = formatCurrency(data.agi || 0);
      document.getElementById('detail-total-tax').textContent = formatCurrency(data.total_tax || 0);
      document.getElementById('detail-effective-rate').textContent = (data.effective_rate || 0).toFixed(1) + '%';
      document.getElementById('detail-refund').textContent = formatCurrency(data.refund_or_owed || 0);

      // Render opportunities
      const opps = data.opportunities || [];
      const topOppsHtml = opps.slice(0, 3).map(opp => `
        <div class="insight-item">
          <div class="insight-icon savings">${getCategoryIcon(opp.category)}</div>
          <div class="insight-content">
            <div class="insight-title">${escapeHtml(opp.title)}</div>
            <div class="insight-desc">${escapeHtml(opp.description)}</div>
          </div>
          <div class="insight-amount">+${formatCurrency(opp.estimated_savings)}</div>
        </div>
      `).join('');

      document.getElementById('detail-top-opportunities').innerHTML = topOppsHtml || '<div class="empty-state"><div class="empty-title">No opportunities found</div></div>';

      const allOppsHtml = opps.map(opp => `
        <div class="insight-item">
          <div class="insight-icon savings">${getCategoryIcon(opp.category)}</div>
          <div class="insight-content">
            <div class="insight-title">${escapeHtml(opp.title)}</div>
            <div class="insight-desc">${escapeHtml(opp.description)}</div>
          </div>
          <div class="insight-amount">+${formatCurrency(opp.estimated_savings)}</div>
        </div>
      `).join('');

      document.getElementById('detail-all-opportunities').innerHTML = allOppsHtml || '<div class="empty-state"><div class="empty-title">No opportunities found</div></div>';
    }

    /**
     * Load enhanced data from Core Platform API
     * This enriches the client detail view with core platform data
     */
    async function loadCoreClientData(clientId) {
      try {
        // Load recommendations from Core API
        const recommendations = await coreApi(`/recommendations?user_id=${clientId}`);
        if (Array.isArray(recommendations) && recommendations.length > 0) {
          clientDetailState.coreRecommendations = recommendations;

          // Update recommendations section if it exists
          const recsContainer = document.getElementById('detail-core-recommendations');
          if (recsContainer) {
            recsContainer.innerHTML = recommendations.slice(0, 5).map(rec => `
              <div class="insight-item" data-rec-id="${rec.id}">
                <div class="insight-icon ${rec.priority}">${getCategoryIcon(rec.category)}</div>
                <div class="insight-content">
                  <div class="insight-title">${escapeHtml(rec.title)}</div>
                  <div class="insight-desc">${escapeHtml(rec.summary)}</div>
                  <div style="margin-top:4px;font-size:11px;color:var(--gray-500);">
                    Confidence: ${rec.confidence_score}% | Priority: ${rec.priority}
                  </div>
                </div>
                <div class="insight-amount">
                  <span style="font-size:11px;color:var(--gray-500);">Est. savings</span><br>
                  ${formatCurrency(rec.estimated_savings_low)} - ${formatCurrency(rec.estimated_savings_high)}
                </div>
              </div>
            `).join('');
          }
        }

        // Load documents from Core API
        const documents = await coreApi(`/documents?user_id=${clientId}`);
        if (Array.isArray(documents) && documents.length > 0) {
          clientDetailState.coreDocuments = documents;
        }

        // Load messages/conversations from Core API
        const conversations = await coreApi(`/messages/conversations`);
        const clientConversation = conversations.find(c =>
          c.participants?.some(p => p.user_id === clientId)
        );
        if (clientConversation) {
          clientDetailState.conversationId = clientConversation.id;
          clientDetailState.unreadMessages = clientConversation.unread_count || 0;
        }

      } catch (e) {
        // Core API enhancement data not available - using basic data
      }
    }

    /**
     * Send a message to a client using Core API
     */
    async function sendMessageToClient(clientId, message) {
      try {
        let conversationId = clientDetailState.conversationId;

        if (!conversationId) {
          // Create a new conversation
          const newConv = await coreApi('/messages/conversations', {
            method: 'POST',
            body: JSON.stringify({
              type: 'direct',
              participant_ids: [clientId],
              initial_message: message
            })
          });
          conversationId = newConv.id;
          clientDetailState.conversationId = conversationId;
        } else {
          // Send to existing conversation
          await coreApi(`/messages/conversations/${conversationId}/messages`, {
            method: 'POST',
            body: JSON.stringify({ content: message, message_type: 'text' })
          });
        }

        showToast('Message sent successfully', 'success');
        return true;
      } catch (e) {
        showToast('Failed to send message', 'error');
        return false;
      }
    }

    /**
     * Create a recommendation for a client using Core API
     */
    async function createClientRecommendation(clientId, recommendation) {
      try {
        const result = await coreApi('/recommendations', {
          method: 'POST',
          body: JSON.stringify({
            user_id: clientId,
            ...recommendation
          })
        });

        if (result.id) {
          showToast('Recommendation created', 'success');
          loadCoreClientData(clientId); // Refresh
          return result;
        }
      } catch (e) {
        showToast('Failed to create recommendation', 'error');
      }
      return null;
    }

    async function runClientScenario(templateId) {
      if (!clientDetailState.clientId) return;

      const resultsCard = document.getElementById('detail-scenario-results');
      resultsCard.style.display = 'block';
      document.getElementById('detail-scenario-content').innerHTML = '<div class="loading-spinner" style="margin:20px auto"></div>';

      try {
        const data = await api(`/api/cpa/session/${clientDetailState.clientId}/scenarios/quick-compare?template=${templateId}`, {
          method: 'POST'
        });

        if (data.success) {
          renderClientScenarioResults(data);
        } else {
          renderDemoScenarioResults(templateId);
        }
      } catch (e) {
        renderDemoScenarioResults(templateId);
      }
    }

    function renderDemoScenarioResults(templateId) {
      const scenarios = {
        max_401k: { name: 'Max 401(k)', savings: 5500, baseline: 12500, scenario: 7000 },
        max_ira: { name: 'Max IRA', savings: 1540, baseline: 12500, scenario: 10960 },
        max_hsa: { name: 'Max HSA', savings: 1000, baseline: 12500, scenario: 11500 },
        charitable_bunching: { name: 'Charitable Bunching', savings: 2200, baseline: 12500, scenario: 10300 },
        home_office: { name: 'Home Office', savings: 800, baseline: 12500, scenario: 11700 },
      };

      const s = scenarios[templateId] || scenarios.max_401k;
      renderClientScenarioResults({
        comparison: { baseline_tax: s.baseline, scenario_tax: s.scenario, savings: s.savings },
        scenario_name: s.name,
      });
    }

    function renderClientScenarioResults(data) {
      const comparison = data.comparison || {};
      document.getElementById('detail-scenario-content').innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
          <div style="padding:20px;background:var(--gray-50);border-radius:var(--radius-md);text-align:center">
            <div style="font-size:12px;color:var(--gray-500);margin-bottom:8px">Current</div>
            <div style="font-size:28px;font-weight:700;color:var(--gray-900)">${formatCurrency(comparison.baseline_tax || 0)}</div>
          </div>
          <div style="padding:20px;background:var(--success-light);border-radius:var(--radius-md);text-align:center">
            <div style="font-size:12px;color:var(--gray-500);margin-bottom:8px">With ${data.scenario_name || 'Changes'}</div>
            <div style="font-size:28px;font-weight:700;color:var(--success)">${formatCurrency(comparison.scenario_tax || 0)}</div>
          </div>
        </div>
        <div style="margin-top:20px;padding:16px;background:var(--primary-light);border-radius:var(--radius-md);text-align:center">
          <div style="font-size:13px;color:var(--gray-700)">Potential Savings</div>
          <div style="font-size:32px;font-weight:700;color:var(--primary);margin-top:4px">${formatCurrency(comparison.savings || 0)}</div>
        </div>
      `;
    }

    function generateClientReport() {
      switchView('reports');
      closeClientDetail();
      // Pre-select client in report view
      const select = document.getElementById('report-client-select');
      if (select && clientDetailState.clientId) {
        select.value = clientDetailState.clientId;
        loadReportSections();
      }
    }

    function uploadClientDocument() {
      switchClientTab('documents');
      showToast('Document upload coming soon', 'info');
    }

    // =============================================================================
    // UPDATE ADD CLIENT BUTTON TO USE SMART ONBOARDING
    // =============================================================================

    // Override the add client button action
    document.addEventListener('DOMContentLoaded', () => {
      // Check for first login (uncomment to enable)
      // checkFirstLogin();

      // Update Add Client button click
      const addClientBtn = document.querySelector('.btn-primary[onclick*="switchView(\'clients\')"]');
      if (addClientBtn) {
        addClientBtn.onclick = () => openSmartOnboarding();
        addClientBtn.textContent = '+ Add Client (60s)';
      }
    });

    // Make openClient use detail modal
    window.openClient = function(clientId) {
      openClientDetail(clientId);
    };

    // =============================================================================
    // COMMAND PALETTE (Ctrl+K)
    // =============================================================================

    const commandPaletteCommands = [
      { id: 'dashboard', icon: '📊', title: 'Dashboard', desc: 'View overview and insights', action: () => switchView('dashboard') },
      { id: 'clients', icon: '👥', title: 'Clients', desc: 'Manage all clients', action: () => switchView('clients') },
      { id: 'pipeline', icon: '📈', title: 'Pipeline', desc: 'View lead pipeline', action: () => switchView('pipeline') },
      { id: 'advisory', icon: '💡', title: 'Advisory Tools', desc: 'Tax optimization tools', action: () => switchView('advisory') },
      { id: 'review', icon: '✅', title: 'Review Queue', desc: 'Returns pending review', action: () => switchView('review') },
      { id: 'reports', icon: '📄', title: 'Reports', desc: 'Generate client reports', action: () => switchView('reports') },
      { id: 'add-client', icon: '➕', title: 'Add New Client', desc: 'Quick onboarding (60s)', action: () => { closeCommandPalette(); openSmartOnboarding(); } },
      { id: 'refresh', icon: '🔄', title: 'Refresh Data', desc: 'Reload all data', action: () => { closeCommandPalette(); refreshDashboard(); } },
    ];

    function openCommandPalette() {
      const backdrop = document.getElementById('command-palette-backdrop');
      const input = document.getElementById('command-palette-input');
      backdrop.classList.add('active');
      input.value = '';
      input.focus();
      renderCommandPaletteResults('');
    }

    function closeCommandPalette() {
      document.getElementById('command-palette-backdrop').classList.remove('active');
    }

    function renderCommandPaletteResults(query) {
      const container = document.getElementById('command-palette-results');
      const q = query.toLowerCase().trim();

      // Filter commands
      const filteredCommands = commandPaletteCommands.filter(cmd =>
        cmd.title.toLowerCase().includes(q) || cmd.desc.toLowerCase().includes(q)
      );

      // Filter clients
      const filteredClients = (state.clients || [])
        .filter(c => c.name?.toLowerCase().includes(q) || c.email?.toLowerCase().includes(q))
        .slice(0, 5);

      let html = '';

      if (filteredCommands.length > 0) {
        html += '<div class="command-palette-section">Commands</div>';
        filteredCommands.forEach(cmd => {
          html += `
            <div class="command-palette-item" onclick="executeCommand('${cmd.id}')">
              <div class="command-palette-item-icon">${cmd.icon}</div>
              <div class="command-palette-item-content">
                <div class="command-palette-item-title">${escapeHtml(cmd.title)}</div>
                <div class="command-palette-item-desc">${escapeHtml(cmd.desc)}</div>
              </div>
            </div>
          `;
        });
      }

      if (q && filteredClients.length > 0) {
        html += '<div class="command-palette-section">Clients</div>';
        filteredClients.forEach(client => {
          html += `
            <div class="command-palette-item" onclick="openClientFromPalette('${escapeHtml(client.session_id || client.id)}')">
              <div class="command-palette-item-icon">👤</div>
              <div class="command-palette-item-content">
                <div class="command-palette-item-title">${escapeHtml(client.name || 'Unknown')}</div>
                <div class="command-palette-item-desc">${escapeHtml(client.email || 'No email')}</div>
              </div>
            </div>
          `;
        });
      }

      if (!html) {
        html = '<div class="command-palette-empty">No results found</div>';
      }

      container.innerHTML = html;
    }

    function executeCommand(cmdId) {
      const cmd = commandPaletteCommands.find(c => c.id === cmdId);
      if (cmd) {
        closeCommandPalette();
        cmd.action();
      }
    }

    function openClientFromPalette(clientId) {
      closeCommandPalette();
      openClientDetail(clientId);
    }

    // Update keyboard handler
    document.addEventListener('keydown', e => {
      // Escape - close panels/modals
      if (e.key === 'Escape') {
        const palette = document.getElementById('command-palette-backdrop');
        if (palette.classList.contains('active')) {
          closeCommandPalette();
        } else {
          closePanel();
        }
      }

      // Ctrl/Cmd + K - open command palette
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        openCommandPalette();
      }
    });
  </script>

  <!-- Command Palette -->
  <div class="command-palette-backdrop" id="command-palette-backdrop" onclick="if(event.target === this) closeCommandPalette()">
    <div class="command-palette">
      <input type="text" class="command-palette-input" id="command-palette-input"
             placeholder="Search commands, clients..."
             oninput="renderCommandPaletteResults(this.value)">
      <div class="command-palette-results" id="command-palette-results"></div>
      <div class="command-palette-hint">
        <span><kbd>↑↓</kbd> Navigate</span>
        <span><kbd>↵</kbd> Select</span>
        <span><kbd>Esc</kbd> Close</span>
      </div>
    </div>
  </div>
</body>
</html>
