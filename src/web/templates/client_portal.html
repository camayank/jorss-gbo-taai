<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tax Advisory Portal</title>

  <!-- Security & SEO -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta name="description" content="Get your FREE tax advisory report - discover your tax savings potential">
  <meta name="theme-color" content="#1e3a5f">
  <meta name="robots" content="index, follow">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/core/variables.css">
  <link rel="stylesheet" href="/static/css/core/reset.css">
  <link rel="stylesheet" href="/static/css/core/typography.css">
  <link rel="stylesheet" href="/static/css/unified-theme.css">

  <style>
    /* ================================================================
       DESIGN SYSTEM - Unified Indigo Theme
       - WCAG 2.1 AA Color Contrast
       - Accessible Focus States
       - Responsive Breakpoints
       - Consistent with Admin & CPA Panels
       ================================================================ */
    :root {
      /* ============================================
         UNIFIED DESIGN SYSTEM - Client Portal
         Matches Admin & CPA Panel design tokens
         ============================================ */

      /* Primary Colors - Professional Navy Blue */
      --primary: var(--color-primary-500);
      --primary-dark: var(--color-primary-900);
      --primary-light: var(--color-primary-400);
      --primary-50: var(--color-info-50);
      --primary-100: var(--color-primary-50);

      /* Accent Colors - Teal (Unified Design System) */
      --accent: var(--color-accent-500);
      --accent-light: var(--color-accent-100);

      /* Semantic Colors */
      --success: var(--color-success-500);
      --success-light: var(--color-success-100);
      --secondary: var(--color-success-500);       /* Alias for backwards compatibility */
      --secondary-light: var(--color-success-100); /* Alias for backwards compatibility */

      --warning: var(--color-warning-500);
      --warning-light: var(--color-warning-100);

      --error: var(--color-error-500);
      --error-light: var(--color-error-100);

      --info: var(--color-primary-400);
      --info-light: var(--color-primary-50);

      /* Grayscale */
      --gray-50: var(--color-gray-50);
      --gray-100: var(--color-gray-100);
      --gray-200: var(--color-gray-200);
      --gray-300: var(--color-gray-300);
      --gray-400: var(--color-gray-400);
      --gray-500: var(--color-gray-500);
      --gray-600: var(--color-gray-600);
      --gray-700: var(--color-gray-700);
      --gray-800: var(--color-gray-800);
      --gray-900: var(--color-gray-900);

      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.06), 0 2px 4px -1px rgba(0,0,0,0.04);
      --shadow: 0 4px 12px rgba(0,0,0,0.1);  /* Alias for backwards compatibility */
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.04);
      --shadow-xl: 0 12px 40px rgba(0,0,0,0.15);

      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius: 12px;  /* Alias for backwards compatibility */

      /* Transitions */
      --transition: 150ms ease;
      --transition-fast: 150ms ease;
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--gray-50);
      color: var(--gray-600);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ================================================================
       LAYOUT
       ================================================================ */
    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      padding: var(--space-4) var(--space-6);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      font-weight: var(--font-bold);
      font-size: var(--text-lg);
      color: var(--primary);
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--primary);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--white);
      font-size: var(--text-lg);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--gray-100);
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
    }

    .main {
      flex: 1;
      padding: var(--space-8) var(--space-6);
      max-width: 1000px;
      margin: 0 auto;
      width: 100%;
    }

    /* ================================================================
       PROGRESS STEPPER
       ================================================================ */
    .stepper {
      display: flex;
      justify-content: center;
      margin-bottom: var(--space-10);
      padding: 0 var(--space-5);
    }

    .stepper-track {
      display: flex;
      align-items: center;
      gap: 0;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gray-200);
      color: var(--gray-500);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      transition: var(--transition);
      position: relative;
      z-index: 2;
    }

    .step.active .step-circle {
      background: var(--primary);
      color: var(--white);
      box-shadow: 0 0 0 4px var(--primary-50);
    }

    .step.completed .step-circle {
      background: var(--secondary);
      color: var(--white);
    }

    .step-label {
      margin-top: var(--space-2);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      color: var(--gray-500);
      text-align: center;
      max-width: 80px;
    }

    .step.active .step-label {
      color: var(--primary);
      font-weight: var(--font-semibold);
    }

    .step.completed .step-label {
      color: var(--secondary);
    }

    .step-connector {
      width: 60px;
      height: 3px;
      background: var(--gray-200);
      margin: 0 var(--space-2);
      margin-bottom: var(--space-7);
      transition: var(--transition);
    }

    .step-connector.completed {
      background: var(--secondary);
    }

    /* ================================================================
       CARDS & CONTAINERS - Unified Design System
       ================================================================ */
    .card {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      transition: box-shadow var(--transition);
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
    }

    .card-header {
      padding: var(--space-6);
      border-bottom: 1px solid var(--gray-100);
    }

    .card-title {
      font-size: var(--text-xl);
      font-weight: var(--font-bold);
      color: var(--gray-700);
      margin-bottom: var(--space-1);
    }

    .card-subtitle {
      font-size: var(--text-sm);
      color: var(--gray-500);
    }

    .card-body {
      padding: var(--space-6);
    }

    .card-footer {
      padding: var(--space-4) var(--space-6);
      background: var(--gray-50);
      border-top: 1px solid var(--gray-100);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* ================================================================
       FORMS
       ================================================================ */
    .form-group {
      margin-bottom: var(--space-5);
    }

    .form-label {
      display: block;
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--gray-600);
      margin-bottom: var(--space-1-5);
    }

    .form-input {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-sm);
      font-size: 15px;
      font-family: inherit;
      transition: var(--transition);
      background: var(--white);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-50);
    }

    .form-input.error {
      border-color: var(--error);
    }

    .form-hint {
      font-size: var(--text-xs);
      color: var(--gray-500);
      margin-top: var(--space-1);
    }

    .form-error {
      font-size: var(--text-xs);
      color: var(--error);
      margin-top: var(--space-1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }

    @media (max-width: 600px) {
      .form-row { grid-template-columns: 1fr; }
    }

    /* ================================================================
       BUTTONS
       ================================================================ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-sm);
      font-size: 15px;
      font-weight: var(--font-semibold);
      font-family: inherit;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      min-height: 44px;
    }

    .btn-primary {
      background: var(--primary);
      color: var(--white);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-primary:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--white);
      color: var(--gray-600);
      border: 2px solid var(--gray-200);
    }

    .btn-secondary:hover {
      background: var(--gray-50);
      border-color: var(--gray-300);
    }

    .btn-success {
      background: var(--success);
      color: var(--white);
    }

    .btn-success:hover {
      background: var(--color-success-600);
    }

    .btn-danger {
      background: var(--error);
      color: var(--white);
    }

    .btn-danger:hover {
      background: var(--color-error-600);
    }

    .btn-ghost {
      background: transparent;
      color: var(--gray-600);
      border: 2px solid var(--gray-200);
    }

    .btn-ghost:hover {
      background: var(--gray-100);
    }

    .btn:focus-visible {
      outline: 3px solid var(--primary-50);
      outline-offset: 2px;
    }

    /* ================================================================
       FILE UPLOAD
       ================================================================ */
    .upload-zone {
      border: 2px dashed var(--gray-300);
      border-radius: var(--radius);
      padding: var(--space-10);
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      background: var(--gray-50);
    }

    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--primary);
      background: var(--primary-50);
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: var(--space-4);
    }

    .upload-title {
      font-size: var(--text-base);
      font-weight: var(--font-semibold);
      color: var(--gray-600);
      margin-bottom: var(--space-1);
    }

    .upload-hint {
      font-size: 13px;
      color: var(--gray-500);
    }

    .file-list {
      margin-top: var(--space-5);
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-2);
    }

    .file-icon {
      width: 40px;
      height: 40px;
      background: var(--primary-light);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-lg);
    }

    .file-info {
      flex: 1;
    }

    .file-name {
      font-weight: var(--font-medium);
      font-size: var(--text-sm);
      color: var(--gray-600);
    }

    .file-size {
      font-size: var(--text-xs);
      color: var(--gray-500);
    }

    .file-status {
      padding: var(--space-1) var(--space-2-5);
      border-radius: var(--radius-xl);
      font-size: 11px;
      font-weight: var(--font-semibold);
    }

    .file-status.uploading {
      background: var(--accent-light);
      color: var(--accent);
    }

    .file-status.complete {
      background: var(--secondary-light);
      color: var(--secondary);
    }

    .file-remove {
      background: none;
      border: none;
      color: var(--gray-500);
      cursor: pointer;
      padding: var(--space-1);
      font-size: var(--text-lg);
    }

    /* ================================================================
       DASHBOARD COMPONENTS
       ================================================================ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }

    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: 1fr; }
    }

    .stat-card {
      background: var(--white);
      border-radius: var(--radius);
      padding: var(--space-5);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-100);
    }

    .stat-label {
      font-size: 13px;
      color: var(--gray-500);
      margin-bottom: var(--space-1);
    }

    .stat-value {
      font-size: 28px;
      font-weight: var(--font-bold);
      color: var(--gray-700);
    }

    .stat-change {
      font-size: var(--text-xs);
      color: var(--secondary);
      margin-top: var(--space-1);
    }

    .insight-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .insight-item {
      display: flex;
      gap: var(--space-4);
      padding: var(--space-4);
      background: var(--white);
      border-radius: var(--radius-sm);
      border: 1px solid var(--gray-100);
      transition: var(--transition);
    }

    .insight-item:hover {
      border-color: var(--primary-light);
      box-shadow: var(--shadow-sm);
    }

    .insight-icon {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xl);
      flex-shrink: 0;
    }

    .insight-icon.opportunity { background: var(--secondary-light); }
    .insight-icon.alert { background: var(--accent-light); }
    .insight-icon.info { background: var(--primary-light); }

    .insight-content { flex: 1; }

    .insight-title {
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      color: var(--gray-700);
      margin-bottom: 2px;
    }

    .insight-desc {
      font-size: 13px;
      color: var(--gray-500);
      line-height: var(--leading-normal);
    }

    .insight-badge {
      padding: var(--space-1) var(--space-2-5);
      background: var(--gray-100);
      border-radius: var(--radius-xl);
      font-size: 11px;
      font-weight: var(--font-semibold);
      color: var(--gray-600);
    }

    /* ================================================================
       STATUS & TIMELINE
       ================================================================ */
    .timeline {
      position: relative;
      padding-left: var(--space-7);
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--gray-200);
    }

    .timeline-item {
      position: relative;
      padding-bottom: var(--space-6);
    }

    .timeline-item:last-child {
      padding-bottom: 0;
    }

    .timeline-marker {
      position: absolute;
      left: -28px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--white);
      border: 2px solid var(--gray-300);
    }

    .timeline-item.completed .timeline-marker {
      background: var(--secondary);
      border-color: var(--secondary);
    }

    .timeline-item.active .timeline-marker {
      background: var(--primary);
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-light);
    }

    .timeline-content {
      padding-top: 0;
    }

    .timeline-title {
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      color: var(--gray-700);
    }

    .timeline-desc {
      font-size: 13px;
      color: var(--gray-500);
      margin-top: 2px;
    }

    .timeline-time {
      font-size: 11px;
      color: var(--gray-500);
      margin-top: var(--space-1);
    }

    /* ================================================================
       CONSENT & LEGAL
       ================================================================ */
    .consent-section {
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
    }

    .consent-title {
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      color: var(--gray-700);
      margin-bottom: var(--space-2);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .consent-text {
      font-size: 13px;
      color: var(--gray-500);
      line-height: 1.6;
    }

    .checkbox-group {
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
      padding: var(--space-4);
      background: var(--white);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
    }

    .checkbox-group:hover {
      border-color: var(--primary-light);
    }

    .checkbox-group.checked {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .checkbox-group input {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      accent-color: var(--primary);
    }

    .checkbox-label {
      font-size: var(--text-sm);
      color: var(--gray-600);
      line-height: var(--leading-normal);
    }

    /* ================================================================
       LOADING & EMPTY STATES
       ================================================================ */
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px var(--space-5);
      text-align: center;
    }

    .loading-text {
      margin-top: var(--space-4);
      color: var(--gray-500);
      font-size: var(--text-sm);
    }

    .empty-state {
      text-align: center;
      padding: 60px var(--space-5);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: var(--space-4);
    }

    .empty-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--gray-700);
      margin-bottom: var(--space-2);
    }

    .empty-desc {
      font-size: var(--text-sm);
      color: var(--gray-500);
      max-width: 400px;
      margin: 0 auto;
    }

    /* ================================================================
       TOAST NOTIFICATIONS
       ================================================================ */
    .toast-container {
      position: fixed;
      top: 80px;
      right: 24px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .toast {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3-5) 18px;
      background: var(--white);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-lg);
      animation: slideIn 0.3s ease;
      max-width: 380px;
    }

    .toast.success { border-left: 4px solid var(--secondary); }
    .toast.error { border-left: 4px solid var(--error); }
    .toast.info { border-left: 4px solid var(--primary); }

    .toast-icon { font-size: var(--text-xl); }
    .toast-message { flex: 1; font-size: var(--text-sm); color: var(--gray-600); }
    .toast-close {
      background: none;
      border: none;
      color: var(--gray-500);
      cursor: pointer;
      font-size: var(--text-lg);
      padding: var(--space-1);
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* ================================================================
       SCREEN VISIBILITY
       ================================================================ */
    .screen { display: none; }
    .screen.active { display: block; }

    .hidden { display: none !important; }

    /* ================================================================
       LEAD MAGNET STYLES
       ================================================================ */
    .cpa-header {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4) var(--space-6);
      background: linear-gradient(135deg, var(--primary), var(--color-primary-400));
      color: var(--white);
      border-radius: var(--radius) var(--radius) 0 0;
    }

    .cpa-logo-large {
      width: 60px;
      height: 60px;
      background: var(--white);
      border-radius: var(--radius-xl);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-2xl);
      color: var(--primary);
      flex-shrink: 0;
    }

    .cpa-logo-large img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: var(--radius-xl);
    }

    .cpa-branding h2 {
      font-size: var(--text-lg);
      font-weight: var(--font-bold);
      margin-bottom: 2px;
    }

    .cpa-branding p {
      font-size: 13px;
      opacity: 0.9;
    }

    .assessment-mode-toggle {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-5);
    }

    .mode-btn {
      flex: 1;
      padding: var(--space-4);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-sm);
      background: var(--white);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
    }

    .mode-btn:hover {
      border-color: var(--primary-light);
    }

    .mode-btn.active {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .mode-btn .mode-time {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--primary);
    }

    .mode-btn .mode-label {
      font-size: var(--text-sm);
      color: var(--gray-600);
      margin-top: var(--space-1);
    }

    /* Smart Profile Questions */
    .question-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-4);
    }

    @media (max-width: 600px) {
      .question-grid { grid-template-columns: 1fr; }
    }

    .multi-select {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .multi-select-item {
      padding: var(--space-2) var(--space-4);
      border: 2px solid var(--gray-200);
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition);
      user-select: none;
    }

    .multi-select-item:hover {
      border-color: var(--primary-light);
    }

    .multi-select-item.selected {
      background: var(--primary);
      color: var(--white);
      border-color: var(--primary);
    }

    .stepper-input {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .stepper-btn {
      width: 36px;
      height: 36px;
      border: 2px solid var(--gray-200);
      border-radius: 50%;
      background: var(--white);
      font-size: var(--text-lg);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stepper-btn:hover {
      background: var(--gray-100);
    }

    .stepper-value {
      font-size: var(--text-xl);
      font-weight: var(--font-semibold);
      min-width: 40px;
      text-align: center;
    }

    .toggle-switch {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .switch {
      position: relative;
      width: 48px;
      height: 28px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--gray-300);
      transition: var(--transition);
      border-radius: 28px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background: var(--white);
      transition: var(--transition);
      border-radius: 50%;
    }

    input:checked + .slider {
      background: var(--secondary);
    }

    input:checked + .slider:before {
      transform: translateX(20px);
    }

    /* Savings Highlight */
    .savings-highlight {
      background: linear-gradient(135deg, var(--color-success-100) 0%, var(--color-success-200) 100%);
      border-radius: var(--radius);
      padding: var(--space-6);
      text-align: center;
      margin: var(--space-5) 0;
    }

    .savings-label {
      font-size: 13px;
      color: var(--color-success-700);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-2);
    }

    .savings-amount {
      font-size: 32px;
      font-weight: var(--font-bold);
      color: var(--color-success-700);
    }

    .savings-note {
      font-size: var(--text-xs);
      color: var(--color-success-700);
      margin-top: var(--space-2);
      opacity: 0.8;
    }

    /* Report Preview */
    .report-preview {
      border: 1px solid var(--gray-200);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .report-preview iframe {
      width: 100%;
      height: 500px;
      border: none;
    }

    .insight-teaser {
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      padding: var(--space-4);
      margin-bottom: var(--space-3);
      border-left: 4px solid var(--accent);
    }

    .insight-teaser-title {
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      margin-bottom: var(--space-1);
    }

    .insight-teaser-desc {
      font-size: 13px;
      color: var(--gray-500);
    }

    .insight-teaser-savings {
      font-size: 13px;
      color: var(--secondary);
      font-weight: var(--font-semibold);
      margin-top: var(--space-2);
    }

    .locked-overlay {
      position: relative;
      overflow: hidden;
    }

    .locked-overlay::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to bottom, transparent 30%, var(--white));
    }

    .unlock-cta {
      background: linear-gradient(135deg, var(--primary), var(--color-primary-400));
      border-radius: var(--radius);
      padding: var(--space-6);
      text-align: center;
      color: var(--white);
      margin-top: var(--space-5);
    }

    .unlock-cta h3 {
      font-size: var(--text-lg);
      margin-bottom: var(--space-2);
    }

    .unlock-cta p {
      font-size: var(--text-sm);
      opacity: 0.9;
      margin-bottom: var(--space-4);
    }

    .progress-bar {
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: var(--space-4);
    }

    .progress-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width var(--transition-slow);
    }

    .question-number {
      font-size: 11px;
      color: var(--gray-500);
      margin-bottom: var(--space-2);
    }

    /* ================================================================
       CLIENT DASHBOARD STYLES
       ================================================================ */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--white);
      border-radius: var(--radius);
      padding: var(--space-6);
      margin-bottom: var(--space-6);
      box-shadow: var(--shadow-sm);
    }

    .dashboard-welcome h1 {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--gray-800);
      margin-bottom: var(--space-1);
    }

    .dashboard-welcome p {
      font-size: var(--text-sm);
      color: var(--gray-500);
    }

    .dashboard-cpa-info {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: var(--gray-50);
      border-radius: var(--radius-sm);
    }

    .cpa-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--primary);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: var(--font-semibold);
      font-size: var(--text-base);
    }

    .cpa-name {
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      color: var(--gray-700);
    }

    .cpa-contact {
      font-size: var(--text-xs);
      color: var(--gray-500);
    }

    .cpa-contact a {
      color: var(--primary);
      text-decoration: none;
    }

    .cpa-contact a:hover {
      text-decoration: underline;
    }

    /* Dashboard Stats */
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }

    @media (max-width: 900px) {
      .dashboard-stats { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 500px) {
      .dashboard-stats { grid-template-columns: 1fr; }
    }

    .dash-stat-card {
      background: var(--white);
      border-radius: var(--radius);
      padding: var(--space-5);
      display: flex;
      align-items: center;
      gap: var(--space-4);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-100);
    }

    .dash-stat-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-xl);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
    }

    .dash-stat-value {
      font-size: 28px;
      font-weight: var(--font-bold);
      color: var(--gray-800);
      line-height: 1.2;
    }

    .dash-stat-label {
      font-size: 13px;
      color: var(--gray-500);
    }

    /* Dashboard Tabs */
    .dashboard-tabs {
      display: flex;
      gap: var(--space-1);
      background: var(--white);
      border-radius: var(--radius);
      padding: var(--space-1-5);
      margin-bottom: var(--space-6);
      box-shadow: var(--shadow-sm);
      overflow-x: auto;
    }

    .dash-tab {
      flex: 1;
      padding: var(--space-3) var(--space-5);
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: var(--gray-600);
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }

    .dash-tab:hover {
      background: var(--gray-100);
    }

    .dash-tab.active {
      background: var(--primary);
      color: var(--white);
    }

    .dash-tab-content {
      display: none;
    }

    .dash-tab-content.active {
      display: block;
    }

    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-6);
    }

    @media (max-width: 900px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }

    /* Return Progress Steps */
    .return-progress {
      margin-bottom: var(--space-5);
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-top: var(--space-4);
      position: relative;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
    }

    .progress-step::before {
      content: '';
      position: absolute;
      top: 8px;
      left: -50%;
      right: 50%;
      height: 2px;
      background: var(--gray-200);
    }

    .progress-step:first-child::before {
      display: none;
    }

    .progress-step.completed::before {
      background: var(--secondary);
    }

    .progress-step.active::before {
      background: var(--primary);
    }

    .step-dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--gray-200);
      border: 3px solid white;
      box-shadow: 0 0 0 2px var(--gray-200);
      z-index: 1;
      margin-bottom: var(--space-2);
    }

    .progress-step.completed .step-dot {
      background: var(--secondary);
      box-shadow: 0 0 0 2px var(--secondary);
    }

    .progress-step.active .step-dot {
      background: var(--primary);
      box-shadow: 0 0 0 2px var(--primary);
    }

    .progress-step .step-label {
      font-size: 11px;
      color: var(--gray-500);
      text-align: center;
    }

    .progress-step.completed .step-label {
      color: var(--secondary);
    }

    .progress-step.active .step-label {
      color: var(--primary);
      font-weight: var(--font-semibold);
    }

    .return-info {
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      padding: var(--space-4);
    }

    .return-info p {
      font-size: var(--text-sm);
      color: var(--gray-600);
      margin-bottom: var(--space-2);
    }

    .return-info p:last-child {
      margin-bottom: 0;
    }

    /* Action Items */
    .action-item {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4);
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-3);
      border-left: 4px solid var(--gray-300);
    }

    .action-item:last-child {
      margin-bottom: 0;
    }

    .action-item.urgent {
      background: var(--error-light);
      border-left-color: var(--error);
    }

    .action-icon {
      font-size: var(--text-2xl);
    }

    .action-content {
      flex: 1;
    }

    .action-title {
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      color: var(--gray-700);
      margin-bottom: 2px;
    }

    .action-desc {
      font-size: 13px;
      color: var(--gray-500);
    }

    /* Activity Timeline */
    .activity-timeline {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .activity-timeline .timeline-item {
      display: flex;
      gap: var(--space-4);
      padding-bottom: 0;
    }

    .timeline-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: var(--space-1);
    }

    .activity-timeline .timeline-content {
      flex: 1;
      padding-top: 0;
    }

    .activity-timeline .timeline-title {
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      color: var(--gray-700);
      margin-bottom: 2px;
    }

    .activity-timeline .timeline-desc {
      font-size: 13px;
      color: var(--gray-500);
    }

    .activity-timeline .timeline-time {
      font-size: 11px;
      color: var(--gray-400);
      margin-top: var(--space-1);
    }

    /* Data Table with responsive wrapper */
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      text-align: left;
      padding: var(--space-3) var(--space-4);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--gray-100);
    }

    .data-table td {
      padding: var(--space-4);
      font-size: var(--text-sm);
      color: var(--gray-600);
      border-bottom: 1px solid var(--gray-100);
    }

    .data-table tbody tr:hover {
      background: var(--gray-50);
    }

    /* Responsive table for mobile */
    @media (max-width: 768px) {
      .table-responsive {
        margin: 0 -var(--space-4);
      }
      .data-table {
        min-width: 500px;
      }
      .data-table th,
      .data-table td {
        padding: var(--space-2-5) var(--space-3);
        font-size: 13px;
      }
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: var(--space-1) var(--space-3);
      border-radius: 20px;
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
    }

    .status-badge.status-progress {
      background: var(--primary-light);
      color: var(--primary);
    }

    .status-badge.status-complete {
      background: var(--secondary-light);
      color: var(--secondary);
    }

    .status-badge.status-pending {
      background: var(--accent-light);
      color: var(--accent);
    }

    /* Document Requests */
    .doc-request {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4);
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-3);
      border-left: 4px solid var(--primary);
    }

    .doc-request:last-child {
      margin-bottom: 0;
    }

    .doc-request.urgent {
      background: var(--error-light);
      border-left-color: var(--error);
    }

    .doc-name {
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      color: var(--gray-700);
    }

    .doc-desc {
      font-size: 13px;
      color: var(--gray-500);
      margin-top: 2px;
    }

    .doc-meta {
      font-size: var(--text-xs);
      color: var(--gray-400);
      margin-top: 2px;
    }

    /* Uploaded Documents */
    .uploaded-doc {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: var(--gray-50);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-2);
    }

    .uploaded-doc:last-child {
      margin-bottom: 0;
    }

    .doc-icon {
      font-size: var(--text-2xl);
    }

    .uploaded-doc .doc-info {
      flex: 1;
    }

    /* Messages */
    .messages-card {
      display: flex;
      flex-direction: column;
      height: 500px;
    }

    .messages-card .card-body {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .message {
      display: flex;
      gap: var(--space-3);
      max-width: 80%;
    }

    .message.sent {
      margin-left: auto;
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      flex-shrink: 0;
    }

    .message-content {
      background: var(--gray-100);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius);
    }

    .message.sent .message-content {
      background: var(--primary);
      color: var(--white);
    }

    .message-text {
      font-size: var(--text-sm);
      line-height: var(--leading-normal);
    }

    .message-time {
      font-size: 11px;
      color: var(--gray-500);
      margin-top: var(--space-1);
    }

    .message.sent .message-time {
      color: rgba(255, 255, 255, 0.7);
    }

    .message-input-area {
      display: flex;
      gap: var(--space-3);
      padding: var(--space-4) var(--space-6);
      border-top: 1px solid var(--gray-100);
      background: var(--white);
    }

    .message-input {
      flex: 1;
      padding: var(--space-3) var(--space-4);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      font-family: inherit;
    }

    .message-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Balance Display */
    .balance-display {
      text-align: center;
      padding: var(--space-6);
    }

    .balance-amount {
      font-size: 42px;
      font-weight: var(--font-bold);
      color: var(--gray-800);
    }

    .balance-status {
      font-size: var(--text-sm);
      color: var(--secondary);
      margin-top: var(--space-2);
    }

    .balance-status.due {
      color: var(--error);
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--white);
      border-radius: var(--radius);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-5) var(--space-6);
      border-bottom: 1px solid var(--gray-100);
    }

    .modal-header h3 {
      font-size: var(--text-lg);
      font-weight: var(--font-bold);
      color: var(--gray-800);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: var(--text-2xl);
      color: var(--gray-500);
      cursor: pointer;
      padding: var(--space-1);
    }

    .modal-close:hover {
      color: var(--gray-700);
    }

    .modal-body {
      padding: var(--space-6);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: var(--space-3);
      padding: var(--space-4) var(--space-6);
      border-top: 1px solid var(--gray-100);
      background: var(--gray-50);
    }

    /* Modal responsive breakpoints */
    @media (max-width: 540px) {
      .modal-content {
        max-width: calc(100vw - 32px);
        margin: var(--space-4);
      }
      .modal-header {
        padding: var(--space-4) var(--space-5);
      }
      .modal-body {
        padding: var(--space-5);
      }
      .modal-footer {
        padding: var(--space-3) var(--space-5);
        flex-wrap: wrap;
      }
    }

    @media (max-width: 380px) {
      .modal-content {
        max-width: calc(100vw - 16px);
        margin: var(--space-2);
        max-height: 95vh;
      }
      .modal-header {
        padding: var(--space-3) var(--space-4);
      }
      .modal-header h3 {
        font-size: var(--text-base);
      }
      .modal-body {
        padding: var(--space-4);
      }
      .modal-footer {
        padding: var(--space-3) var(--space-4);
      }
      .toast {
        max-width: calc(100vw - 48px);
        right: 12px;
      }
    }

    /* Form Select */
    .form-select {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-sm);
      font-size: var(--text-sm);
      font-family: inherit;
      background: var(--white);
      cursor: pointer;
    }

    .form-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    /* Small Button Variant */
    .btn-sm {
      padding: var(--space-2) var(--space-4);
      font-size: 13px;
      min-height: 36px;
    }

    /* Logout Button */
    .btn-logout {
      background: none;
      border: none;
      color: var(--gray-400);
      cursor: pointer;
      padding: var(--space-1) var(--space-2);
      font-size: var(--text-sm);
      margin-left: var(--space-2);
      transition: var(--transition);
    }

    .btn-logout:hover {
      color: var(--error);
    }

    /* Card Header Actions */
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header h3 {
      margin: 0;
    }

    /* ================================================================
       RESPONSIVE
       ================================================================ */
    @media (max-width: 768px) {
      .header { padding: var(--space-3) var(--space-4); }
      .main { padding: var(--space-5) var(--space-4); }
      .card-header, .card-body { padding: var(--space-4); }
      .stepper { overflow-x: auto; padding-bottom: var(--space-2); }
      .step-connector { width: 40px; }
      .dashboard-header { flex-direction: column; gap: var(--space-4); text-align: center; }
      .dashboard-cpa-info { width: 100%; justify-content: center; }
      .message { max-width: 90%; }
      .data-table { font-size: var(--text-xs); }
      .data-table th, .data-table td { padding: var(--space-2-5) var(--space-2); }

      /* Better touch targets */
      .btn { min-height: 48px; padding: var(--space-3-5) var(--space-5); }

      /* Header adjustments */
      .header-actions { gap: var(--space-2); }

      /* Card adjustments */
      .card { border-radius: var(--radius-xl); }
    }

    /* Small mobile */
    @media (max-width: 480px) {
      .header {
        padding: var(--space-2-5) var(--space-3);
        flex-wrap: wrap;
        gap: var(--space-2);
      }

      .logo { gap: var(--space-2); }
      .logo-icon { width: 36px; height: 36px; font-size: var(--text-sm); }
      .logo-text { font-size: var(--text-base); }

      .main { padding: var(--space-4) var(--space-3); }

      .card-header, .card-body { padding: var(--space-3); }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .header-actions {
        width: 100%;
        justify-content: flex-end;
      }

      /* Step indicators */
      .step-number { width: 28px; height: 28px; font-size: var(--text-xs); }
      .step-label { font-size: 10px; }

      /* File upload */
      .upload-zone { padding: var(--space-6) var(--space-4); }

      /* Form fields */
      .form-label { font-size: 13px; }
      .form-input { padding: var(--space-2-5) var(--space-3); font-size: var(--text-sm); }
    }

    /* Help Overlay */
    .help-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .help-overlay.active { display: flex; }
    .help-modal {
      background: var(--white);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      width: 100%;
      max-width: 480px;
      margin: var(--space-5);
      overflow: hidden;
    }
    .help-modal-header {
      padding: var(--space-5) var(--space-6);
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .help-modal-title { font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--gray-900); }
    .help-modal-close {
      width: 32px; height: 32px;
      border: none; background: var(--gray-100);
      border-radius: 50%; cursor: pointer;
      font-size: var(--text-lg); color: var(--gray-600);
    }
    .help-modal-close:hover { background: var(--gray-200); }
    .help-modal-body { padding: var(--space-6); }
    .help-section { margin-bottom: var(--space-5); }
    .help-section:last-child { margin-bottom: 0; }
    .help-section-title { font-size: var(--text-xs); font-weight: var(--font-semibold); color: var(--gray-500); text-transform: uppercase; margin-bottom: var(--space-3); }
    .help-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-2-5) 0;
      border-bottom: 1px solid var(--gray-100);
    }
    .help-item:last-child { border-bottom: none; }
    .help-item-label { color: var(--gray-700); }
    .help-item-key {
      display: flex;
      gap: var(--space-1);
    }
    .help-item-key kbd {
      padding: var(--space-1) var(--space-2);
      background: var(--gray-100);
      border-radius: 4px;
      font-family: inherit;
      font-size: var(--text-xs);
      color: var(--gray-600);
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- Header -->
    <header class="header">
      <div class="logo" id="site-logo">
        <div class="logo-icon" id="cpa-logo-icon">&#9830;</div>
        <span id="cpa-name-display">Tax Advisory</span>
      </div>
      <div class="header-actions">
        <div class="user-menu" id="user-display">
          <span>&#128100;</span>
          <span id="user-name">Guest</span>
        </div>
      </div>
    </header>

    <!-- Progress Stepper -->
    <div class="main">
      <div class="stepper" id="stepper">
        <div class="stepper-track">
          <div class="step active" data-step="1">
            <div class="step-circle">1</div>
            <div class="step-label">Welcome</div>
          </div>
          <div class="step-connector"></div>
          <div class="step" data-step="2">
            <div class="step-circle">2</div>
            <div class="step-label">Tax Profile</div>
          </div>
          <div class="step-connector"></div>
          <div class="step" data-step="3" id="step-documents">
            <div class="step-circle">3</div>
            <div class="step-label">Documents</div>
          </div>
          <div class="step-connector" id="connector-documents"></div>
          <div class="step" data-step="4">
            <div class="step-circle" id="step-contact-circle">4</div>
            <div class="step-label">Contact</div>
          </div>
          <div class="step-connector"></div>
          <div class="step" data-step="5">
            <div class="step-circle" id="step-report-circle">5</div>
            <div class="step-label">Your Report</div>
          </div>
        </div>
      </div>

      <!-- Screen 1: Welcome & Consent -->
      <div class="screen active" id="screen-welcome">
        <div class="card">
          <!-- CPA Branding Header (populated dynamically) -->
          <div class="cpa-header" id="cpa-header">
            <div class="cpa-logo-large" id="cpa-logo-welcome">&#9830;</div>
            <div class="cpa-branding">
              <h2 id="cpa-name-welcome">Your Tax Professional</h2>
              <p id="cpa-firm-welcome">Tax Advisory Services</p>
            </div>
          </div>

          <div class="card-header">
            <h1 class="card-title">Get Your FREE Tax Advisory Report</h1>
            <p class="card-subtitle">Discover your potential tax savings in just 2-3 minutes</p>
          </div>

          <div class="card-body">
            <!-- Assessment Mode Toggle -->
            <div class="form-group">
              <label class="form-label">Choose your assessment type:</label>
              <div class="assessment-mode-toggle">
                <div class="mode-btn active" data-mode="quick" onclick="setAssessmentMode('quick')">
                  <div class="mode-time">~2 min</div>
                  <div class="mode-label">Quick Assessment</div>
                </div>
                <div class="mode-btn" data-mode="full" onclick="setAssessmentMode('full')">
                  <div class="mode-time">~5 min</div>
                  <div class="mode-label">Full Assessment</div>
                </div>
              </div>
            </div>

            <div class="consent-section">
              <div class="consent-title">&#128161; What You'll Get</div>
              <div class="consent-text">
                <strong>FREE Tax Advisory Report</strong> with personalized insights showing:<br>
                &#8226; Estimated tax savings range<br>
                &#8226; Key optimization opportunities<br>
                &#8226; Complexity assessment of your tax situation
              </div>
            </div>

            <div class="consent-section">
              <div class="consent-title">&#128274; Privacy & Security</div>
              <div class="consent-text">
                Your information is encrypted and protected. We follow strict security protocols
                to ensure your data remains confidential and secure at all times.
              </div>
            </div>

            <div class="checkbox-group" id="consent-box" onclick="toggleConsent(event)">
              <input type="checkbox" id="consent-check">
              <label class="checkbox-label" for="consent-check">
                I have read and agree to the privacy policy. I consent to the collection
                and processing of my tax information for generating my advisory report.
              </label>
            </div>
          </div>
          <div class="card-footer">
            <span class="form-hint">No credit card required</span>
            <button type="button" class="btn btn-primary" id="btn-start" disabled onclick="startAssessment()">
              Start My FREE Assessment <span>&#8594;</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Screen 2: Smart Tax Profile Questions -->
      <div class="screen" id="screen-profile">
        <div class="card">
          <div class="card-header">
            <h1 class="card-title">Your Tax Profile</h1>
            <p class="card-subtitle">Quick questions to personalize your report (all dropdowns - no typing needed!)</p>
            <div class="progress-bar">
              <div class="progress-fill" id="profile-progress" style="width: 0%"></div>
            </div>
          </div>
          <div class="card-body">
            <!-- Question 1: Filing Status -->
            <div class="form-group">
              <div class="question-number">Question 1 of 8</div>
              <label class="form-label" for="filing-status">What's your filing status?</label>
              <select class="form-input" id="filing-status" required onchange="updateProgress()">
                <option value="">Select your filing status</option>
                <option value="single">Single</option>
                <option value="married_jointly">Married Filing Jointly</option>
                <option value="married_separately">Married Filing Separately</option>
                <option value="head_of_household">Head of Household</option>
                <option value="qualifying_surviving_spouse">Qualifying Surviving Spouse</option>
              </select>
            </div>

            <!-- Question 2: Dependents -->
            <div class="question-grid">
              <div class="form-group">
                <div class="question-number">Question 2 of 8</div>
                <label class="form-label">How many dependents?</label>
                <div class="stepper-input">
                  <button type="button" class="stepper-btn" onclick="adjustDependents(-1)">-</button>
                  <span class="stepper-value" id="dependents-value">0</span>
                  <button type="button" class="stepper-btn" onclick="adjustDependents(1)">+</button>
                </div>
                <input type="hidden" id="dependents-count" value="0">
              </div>

              <div class="form-group">
                <label class="form-label">&nbsp;</label>
                <div class="toggle-switch">
                  <label class="switch">
                    <input type="checkbox" id="children-under-17" onchange="updateProgress()">
                    <span class="slider"></span>
                  </label>
                  <span>Children under 17?</span>
                </div>
                <div class="form-hint">For Child Tax Credit eligibility</div>
              </div>
            </div>

            <!-- Question 3: Income Range -->
            <div class="form-group">
              <div class="question-number">Question 3 of 8</div>
              <label class="form-label" for="income-range">What's your approximate annual income?</label>
              <select class="form-input" id="income-range" required onchange="updateProgress()">
                <option value="">Select income range</option>
                <option value="under_50k">Under $50,000</option>
                <option value="50k_75k">$50,000 - $75,000</option>
                <option value="75k_100k">$75,000 - $100,000</option>
                <option value="100k_150k">$100,000 - $150,000</option>
                <option value="150k_200k">$150,000 - $200,000</option>
                <option value="200k_500k">$200,000 - $500,000</option>
                <option value="over_500k">Over $500,000</option>
              </select>
            </div>

            <!-- Question 4: Income Sources -->
            <div class="form-group">
              <div class="question-number">Question 4 of 8</div>
              <label class="form-label">Where does your income come from? (select all that apply)</label>
              <div class="multi-select" id="income-sources">
                <div class="multi-select-item selected" data-value="w2" onclick="toggleMultiSelect(this)">W-2 Employment</div>
                <div class="multi-select-item" data-value="self_employed" onclick="toggleMultiSelect(this)">Self-Employed</div>
                <div class="multi-select-item" data-value="investments" onclick="toggleMultiSelect(this)">Investments</div>
                <div class="multi-select-item" data-value="rental" onclick="toggleMultiSelect(this)">Rental Income</div>
                <div class="multi-select-item" data-value="retirement" onclick="toggleMultiSelect(this)">Retirement</div>
              </div>
            </div>

            <!-- Question 5 & 6: Homeowner & Retirement -->
            <div class="question-grid">
              <div class="form-group">
                <div class="question-number">Question 5 of 8</div>
                <label class="form-label">Are you a homeowner?</label>
                <div class="toggle-switch" style="margin-top: var(--space-2);">
                  <label class="switch">
                    <input type="checkbox" id="is-homeowner" onchange="updateProgress()">
                    <span class="slider"></span>
                  </label>
                  <span>Yes, I own my home</span>
                </div>
                <div class="form-hint">Mortgage interest & property tax deductions</div>
              </div>

              <div class="form-group">
                <div class="question-number">Question 6 of 8</div>
                <label class="form-label" for="retirement-savings">Retirement savings?</label>
                <select class="form-input" id="retirement-savings" onchange="updateProgress()">
                  <option value="none">None currently</option>
                  <option value="some">Contributing some</option>
                  <option value="maxed">Maxing contributions</option>
                </select>
              </div>
            </div>

            <!-- Question 7: Healthcare -->
            <div class="form-group">
              <div class="question-number">Question 7 of 8</div>
              <label class="form-label" for="healthcare-type">What type of health insurance do you have?</label>
              <select class="form-input" id="healthcare-type" onchange="updateProgress()">
                <option value="employer">Employer-provided</option>
                <option value="hdhp_hsa">High-Deductible with HSA</option>
                <option value="marketplace">Marketplace (ACA)</option>
                <option value="none">No insurance</option>
              </select>
            </div>

            <!-- Question 8: Life Events -->
            <div class="form-group">
              <div class="question-number">Question 8 of 8</div>
              <label class="form-label">Any major life events this year? (select all that apply)</label>
              <div class="multi-select" id="life-events">
                <div class="multi-select-item" data-value="new_job" onclick="toggleMultiSelect(this)">New Job</div>
                <div class="multi-select-item" data-value="baby" onclick="toggleMultiSelect(this)">New Baby</div>
                <div class="multi-select-item" data-value="home_purchase" onclick="toggleMultiSelect(this)">Bought Home</div>
                <div class="multi-select-item" data-value="marriage" onclick="toggleMultiSelect(this)">Got Married</div>
                <div class="multi-select-item" data-value="divorce" onclick="toggleMultiSelect(this)">Divorce</div>
                <div class="multi-select-item" data-value="retirement" onclick="toggleMultiSelect(this)">Retired</div>
                <div class="multi-select-item" data-value="college_student" onclick="toggleMultiSelect(this)">College Student</div>
              </div>
            </div>

            <!-- Additional toggles -->
            <div class="question-grid" style="margin-top: var(--space-4);">
              <div class="toggle-switch">
                <label class="switch">
                  <input type="checkbox" id="has-student-loans">
                  <span class="slider"></span>
                </label>
                <span>Have student loans?</span>
              </div>
              <div class="toggle-switch">
                <label class="switch">
                  <input type="checkbox" id="has-business">
                  <span class="slider"></span>
                </label>
                <span>Own a business/side hustle?</span>
              </div>
            </div>
          </div>
          <div class="card-footer">
            <button class="btn btn-secondary" onclick="prevStep()">
              <span>&#8592;</span> Back
            </button>
            <button class="btn btn-primary" onclick="submitProfileAndNext()">
              Continue <span>&#8594;</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Screen 3: Document Upload (Optional - skipped in Quick mode) -->
      <div class="screen" id="screen-documents">
        <div class="card">
          <div class="card-header">
            <h1 class="card-title">Upload Documents (Optional)</h1>
            <p class="card-subtitle">Uploading your prior year 1040 improves accuracy, but is not required</p>
          </div>
          <div class="card-body">
            <div class="consent-section" style="background: var(--accent-light); margin-bottom: var(--space-5);">
              <div class="consent-title" style="color: var(--accent);">&#128161; Optional Enhancement</div>
              <div class="consent-text">
                Upload your prior year's 1040 for more accurate insights.
                You can skip this step and still get your FREE report.
              </div>
            </div>

            <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
              <div class="upload-icon">&#128194;</div>
              <div class="upload-title">Drop your 1040 here or click to browse</div>
              <div class="upload-hint">Supported: PDF, JPG, PNG (max 10MB)</div>
              <input type="file" id="file-input" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="handleFiles(this.files)">
            </div>

            <div class="file-list" id="file-list"></div>
          </div>
          <div class="card-footer">
            <button class="btn btn-secondary" onclick="prevStep()">
              <span>&#8592;</span> Back
            </button>
            <div>
              <button class="btn btn-secondary" onclick="skipDocuments()" style="margin-right: var(--space-2);">
                Skip for now
              </button>
              <button class="btn btn-primary" onclick="nextStep()">
                Continue <span>&#8594;</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Screen 4: Contact Capture (Lead Gate) -->
      <div class="screen" id="screen-contact">
        <div class="card">
          <div class="card-header">
            <h1 class="card-title">Almost There!</h1>
            <p class="card-subtitle">Enter your info to receive your FREE Tax Advisory Report</p>
          </div>
          <div class="card-body">
            <!-- Savings Preview -->
            <div class="savings-highlight">
              <div class="savings-label">Your Estimated Tax Savings</div>
              <div class="savings-amount" id="savings-preview">$500 - $2,000</div>
              <div class="savings-note">Based on your tax profile</div>
            </div>

            <div class="consent-section" style="background: var(--secondary-light); margin-bottom: var(--space-5);">
              <div class="consent-title" style="color: var(--secondary);">&#127881; Your FREE Report Includes:</div>
              <div class="consent-text">
                &#10003; Personalized tax savings estimate<br>
                &#10003; <span id="insights-count-preview">3-5</span> optimization opportunities<br>
                &#10003; Complexity assessment<br>
                &#10003; Next steps recommendations
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="first-name">First Name *</label>
              <input type="text" class="form-input" id="first-name" placeholder="Enter your first name" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="email">Email Address *</label>
              <input type="email" class="form-input" id="email" placeholder="you@example.com" required>
              <div class="form-hint">We'll send your report to this email</div>
            </div>

            <div class="form-group">
              <label class="form-label" for="phone">Phone Number (optional)</label>
              <input type="tel" class="form-input" id="phone" placeholder="(555) 123-4567">
            </div>
          </div>
          <div class="card-footer">
            <button class="btn btn-secondary" onclick="prevStep()">
              <span>&#8592;</span> Back
            </button>
            <button class="btn btn-success" onclick="captureContactAndGetReport()">
              Get My FREE Report <span>&#10003;</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Screen 5: FREE Tax Advisory Report -->
      <div class="screen" id="screen-report">
        <div class="card">
          <!-- CPA Branded Header -->
          <div class="cpa-header" id="report-cpa-header">
            <div class="cpa-logo-large" id="report-cpa-logo">&#9830;</div>
            <div class="cpa-branding">
              <h2 id="report-cpa-name">Your Tax Professional</h2>
              <p id="report-cpa-firm">Tax Advisory Services</p>
            </div>
          </div>

          <div class="card-header" style="text-align: center;">
            <h1 class="card-title" style="color: var(--secondary);">&#127881; Your FREE Tax Advisory Report</h1>
            <p class="card-subtitle">Prepared for <strong id="report-client-name">You</strong></p>
          </div>

          <div class="card-body">
            <!-- Summary Stats -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-label">Filing Status</div>
                <div class="stat-value" id="report-filing-status" style="font-size: var(--text-lg);">Single</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Complexity</div>
                <div class="stat-value" id="report-complexity" style="font-size: var(--text-lg); color: var(--accent);">Moderate</div>
              </div>
              <div class="stat-card" style="background: var(--secondary-light);">
                <div class="stat-label" style="color: var(--secondary);">Potential Savings</div>
                <div class="stat-value" id="report-savings-range" style="color: var(--secondary);">$500 - $2,000</div>
              </div>
            </div>

            <!-- Teaser Insights -->
            <div style="margin-top: var(--space-6);">
              <h3 class="card-title" style="font-size: var(--text-base); margin-bottom: var(--space-4);">
                &#128161; Tax Optimization Opportunities (<span id="report-insights-shown">3</span> of <span id="report-insights-total">8</span>)
              </h3>

              <div id="report-insights-list">
                <!-- Populated dynamically -->
                <div class="insight-teaser">
                  <div class="insight-teaser-title">Retirement Savings Optimization</div>
                  <div class="insight-teaser-desc">You may be able to increase tax-deferred savings...</div>
                  <div class="insight-teaser-savings">Potential: Contact CPA for details</div>
                </div>
              </div>

              <!-- Locked Insights -->
              <div class="consent-section" style="background: var(--gray-100); text-align: center; margin-top: var(--space-4);">
                <div class="consent-title">&#128274; <span id="report-locked-count">5</span> More Insights Available</div>
                <div class="consent-text">
                  Contact <span id="unlock-cpa-name">your tax professional</span> to unlock your complete analysis
                  with specific dollar amounts, action items, and IRS references.
                </div>
              </div>
            </div>

            <!-- Unlock CTA -->
            <div class="unlock-cta">
              <h3>Ready to Maximize Your Tax Savings?</h3>
              <p>Schedule a consultation to unlock your full analysis and get personalized guidance.</p>
              <a href="#" class="btn btn-primary" id="report-booking-link" style="background: white; color: var(--primary);">
                Schedule Free Consultation
              </a>
              <div style="margin-top: var(--space-4); font-size: var(--text-sm); opacity: 0.9;">
                <span id="report-cpa-email"></span>
                <span id="report-cpa-phone" style="margin-left: var(--space-4);"></span>
              </div>
            </div>

            <!-- Disclaimer -->
            <div class="consent-section" style="margin-top: var(--space-6);">
              <div class="consent-title">&#9888; Important Disclaimer</div>
              <div class="consent-text" style="font-size: 11px;">
                This report provides general tax information based on the information you provided
                and is for educational purposes only. It does not constitute tax, legal, or financial
                advice. Actual tax savings depend on your complete financial situation. Consult with
                a qualified tax professional before making any tax-related decisions.
              </div>
            </div>
          </div>

          <div class="card-footer">
            <button class="btn btn-secondary" onclick="window.print()">
              &#128424; Print Report
            </button>
            <button class="btn btn-primary" id="btn-contact-cpa">
              Contact <span id="btn-cpa-name">Tax Professional</span>
            </button>
          </div>
        </div>
      </div>

      <!-- ================================================================
           CLIENT DASHBOARD - Post-Conversion Experience
           Shown when user is an active client (not just a lead)
           ================================================================ -->
      <div class="screen" id="screen-dashboard">
        <div class="dashboard-header">
          <div class="dashboard-welcome">
            <h1>Welcome back, <span id="dashboard-client-name">Client</span>!</h1>
            <p>Here's the status of your tax services</p>
          </div>
          <div class="dashboard-cpa-info">
            <div class="cpa-avatar" id="dashboard-cpa-avatar">JD</div>
            <div>
              <div class="cpa-name" id="dashboard-cpa-name">Your CPA</div>
              <div class="cpa-contact">
                <a href="#" id="dashboard-cpa-email-link">Contact</a>
                <span>|</span>
                <a href="#" id="dashboard-cpa-phone-link">Call</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="dashboard-stats">
          <div class="dash-stat-card">
            <div class="dash-stat-icon" style="background: var(--primary-light); color: var(--primary);">&#128196;</div>
            <div class="dash-stat-content">
              <div class="dash-stat-value" id="dash-returns-count">0</div>
              <div class="dash-stat-label">Active Returns</div>
            </div>
          </div>
          <div class="dash-stat-card">
            <div class="dash-stat-icon" style="background: var(--secondary-light); color: var(--secondary);">&#128206;</div>
            <div class="dash-stat-content">
              <div class="dash-stat-value" id="dash-docs-pending">0</div>
              <div class="dash-stat-label">Docs Needed</div>
            </div>
          </div>
          <div class="dash-stat-card">
            <div class="dash-stat-icon" style="background: var(--accent-light); color: var(--accent);">&#128172;</div>
            <div class="dash-stat-content">
              <div class="dash-stat-value" id="dash-messages-count">0</div>
              <div class="dash-stat-label">Messages</div>
            </div>
          </div>
          <div class="dash-stat-card">
            <div class="dash-stat-icon" style="background: var(--error-light); color: var(--error);">&#128176;</div>
            <div class="dash-stat-content">
              <div class="dash-stat-value" id="dash-balance">$0</div>
              <div class="dash-stat-label">Balance Due</div>
            </div>
          </div>
        </div>

        <!-- Dashboard Tabs -->
        <div class="dashboard-tabs">
          <button class="dash-tab active" onclick="showDashboardTab('overview')">Overview</button>
          <button class="dash-tab" onclick="showDashboardTab('returns')">My Returns</button>
          <button class="dash-tab" onclick="showDashboardTab('documents')">Documents</button>
          <button class="dash-tab" onclick="showDashboardTab('messages')">Messages</button>
          <button class="dash-tab" onclick="showDashboardTab('billing')">Billing</button>
        </div>

        <!-- Tab Content: Overview -->
        <div class="dash-tab-content active" id="tab-overview">
          <div class="dashboard-grid">
            <!-- Current Return Status -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Current Return Status</h3>
                <span class="status-badge" id="return-status-badge">In Progress</span>
              </div>
              <div class="card-body">
                <div class="return-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" id="return-progress-fill" style="width: 40%"></div>
                  </div>
                  <div class="progress-steps" id="return-progress-steps">
                    <div class="progress-step completed">
                      <div class="step-dot"></div>
                      <div class="step-label">Info Received</div>
                    </div>
                    <div class="progress-step active">
                      <div class="step-dot"></div>
                      <div class="step-label">In Review</div>
                    </div>
                    <div class="progress-step">
                      <div class="step-dot"></div>
                      <div class="step-label">Ready for Review</div>
                    </div>
                    <div class="progress-step">
                      <div class="step-dot"></div>
                      <div class="step-label">Filed</div>
                    </div>
                  </div>
                </div>
                <div class="return-info" id="return-info">
                  <p><strong>Tax Year:</strong> <span id="return-tax-year">2024</span></p>
                  <p><strong>Return Type:</strong> <span id="return-type">1040 Individual</span></p>
                  <p><strong>Last Updated:</strong> <span id="return-updated">Today</span></p>
                </div>
              </div>
            </div>

            <!-- Action Items -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">&#9888; Action Required</h3>
              </div>
              <div class="card-body" id="action-items-list">
                <div class="action-item urgent">
                  <div class="action-icon">&#128206;</div>
                  <div class="action-content">
                    <div class="action-title">Upload W-2 Forms</div>
                    <div class="action-desc">Your CPA needs your W-2 from all employers</div>
                  </div>
                  <button class="btn btn-sm btn-primary" onclick="showDashboardTab('documents')">Upload</button>
                </div>
                <div class="action-item">
                  <div class="action-icon">&#128172;</div>
                  <div class="action-content">
                    <div class="action-title">Review Message</div>
                    <div class="action-desc">Your CPA has a question about your deductions</div>
                  </div>
                  <button class="btn btn-sm btn-secondary" onclick="showDashboardTab('messages')">View</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="card" style="margin-top: var(--space-6);">
            <div class="card-header">
              <h3 class="card-title">Recent Activity</h3>
            </div>
            <div class="card-body" id="recent-activity">
              <div class="activity-timeline">
                <div class="timeline-item">
                  <div class="timeline-dot" style="background: var(--secondary);"></div>
                  <div class="timeline-content">
                    <div class="timeline-title">Document Received</div>
                    <div class="timeline-desc">Your W-2 has been received and is being processed</div>
                    <div class="timeline-time">2 hours ago</div>
                  </div>
                </div>
                <div class="timeline-item">
                  <div class="timeline-dot" style="background: var(--primary);"></div>
                  <div class="timeline-content">
                    <div class="timeline-title">Return Started</div>
                    <div class="timeline-desc">Your CPA has started preparing your 2024 tax return</div>
                    <div class="timeline-time">Yesterday</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab Content: My Returns -->
        <div class="dash-tab-content" id="tab-returns">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Tax Returns</h3>
            </div>
            <div class="card-body" id="returns-list">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Tax Year</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Refund/Owed</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="returns-table-body">
                  <tr>
                    <td>2024</td>
                    <td>1040 Individual</td>
                    <td><span class="status-badge status-progress">In Progress</span></td>
                    <td>Calculating...</td>
                    <td><button class="btn btn-sm btn-secondary">View</button></td>
                  </tr>
                  <tr>
                    <td>2023</td>
                    <td>1040 Individual</td>
                    <td><span class="status-badge status-complete">Filed</span></td>
                    <td style="color: var(--secondary);">+$2,847 Refund</td>
                    <td><button class="btn btn-sm btn-secondary">Download</button></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Tab Content: Documents -->
        <div class="dash-tab-content" id="tab-documents">
          <div class="dashboard-grid">
            <!-- Document Requests -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">&#128206; Documents Needed</h3>
              </div>
              <div class="card-body" id="doc-requests-list">
                <div class="doc-request urgent">
                  <div class="doc-info">
                    <div class="doc-name">W-2 Forms</div>
                    <div class="doc-desc">From all employers for 2024</div>
                  </div>
                  <div class="doc-actions">
                    <input type="file" id="upload-w2" style="display: none;" onchange="uploadRequestedDoc(this, 'w2')">
                    <button class="btn btn-sm btn-primary" onclick="document.getElementById('upload-w2').click()">Upload</button>
                  </div>
                </div>
                <div class="doc-request">
                  <div class="doc-info">
                    <div class="doc-name">1099-INT</div>
                    <div class="doc-desc">Interest income statements</div>
                  </div>
                  <div class="doc-actions">
                    <input type="file" id="upload-1099int" style="display: none;" onchange="uploadRequestedDoc(this, '1099-int')">
                    <button class="btn btn-sm btn-primary" onclick="document.getElementById('upload-1099int').click()">Upload</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Uploaded Documents -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">&#128193; Uploaded Documents</h3>
                <button class="btn btn-sm btn-secondary" onclick="openUploadModal()">+ Upload New</button>
              </div>
              <div class="card-body" id="uploaded-docs-list">
                <div class="uploaded-doc">
                  <div class="doc-icon">&#128196;</div>
                  <div class="doc-info">
                    <div class="doc-name">W2_Employer1_2024.pdf</div>
                    <div class="doc-meta">Uploaded Jan 15, 2025  245 KB</div>
                  </div>
                  <span class="status-badge status-complete">Received</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab Content: Messages -->
        <div class="dash-tab-content" id="tab-messages">
          <div class="card messages-card">
            <div class="card-header">
              <h3 class="card-title">&#128172; Messages with <span id="messages-cpa-name">Your CPA</span></h3>
            </div>
            <div class="card-body messages-body" id="messages-container">
              <div class="message received">
                <div class="message-avatar">JD</div>
                <div class="message-content">
                  <div class="message-text">Hi! I've started reviewing your documents. Quick question - did you have any additional 1099 income this year?</div>
                  <div class="message-time">Yesterday at 2:30 PM</div>
                </div>
              </div>
              <div class="message sent">
                <div class="message-content">
                  <div class="message-text">Yes, I had some freelance work. I'll upload those 1099s now.</div>
                  <div class="message-time">Yesterday at 3:15 PM</div>
                </div>
              </div>
              <div class="message received">
                <div class="message-avatar">JD</div>
                <div class="message-content">
                  <div class="message-text">Perfect! Once I receive those, I should have your return ready for review within 2-3 business days.</div>
                  <div class="message-time">Yesterday at 3:20 PM</div>
                </div>
              </div>
            </div>
            <div class="message-input-area">
              <input type="text" id="message-input" class="message-input" placeholder="Type your message...">
              <button class="btn btn-primary" onclick="sendMessage()">Send</button>
            </div>
          </div>
        </div>

        <!-- Tab Content: Billing -->
        <div class="dash-tab-content" id="tab-billing">
          <div class="dashboard-grid">
            <!-- Current Balance -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Current Balance</h3>
              </div>
              <div class="card-body">
                <div class="balance-display">
                  <div class="balance-amount" id="billing-balance">$0.00</div>
                  <div class="balance-status" id="billing-status">Paid in Full</div>
                </div>
                <button class="btn btn-primary" id="pay-now-btn" style="display: none;">Pay Now</button>
              </div>
            </div>

            <!-- Payment History -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Invoices & Payments</h3>
              </div>
              <div class="card-body" id="invoices-list">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Description</th>
                      <th>Amount</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="invoices-table-body">
                    <tr>
                      <td>Jan 10, 2025</td>
                      <td>2024 Tax Return Preparation</td>
                      <td>$350.00</td>
                      <td><span class="status-badge status-pending">Due Feb 1</span></td>
                      <td><button class="btn btn-sm btn-primary">Pay</button></td>
                    </tr>
                    <tr>
                      <td>Apr 15, 2024</td>
                      <td>2023 Tax Return Preparation</td>
                      <td>$300.00</td>
                      <td><span class="status-badge status-complete">Paid</span></td>
                      <td><button class="btn btn-sm btn-secondary">Receipt</button></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal-overlay" id="upload-modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Upload Document</h3>
        <button class="modal-close" onclick="closeUploadModal()" aria-label="Close upload modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Document Type</label>
          <select id="upload-doc-type" class="form-select">
            <option value="w2">W-2</option>
            <option value="1099">1099</option>
            <option value="1098">1098 (Mortgage Interest)</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="upload-zone" id="modal-upload-zone">
          <input type="file" id="modal-file-input" style="display: none;" onchange="handleModalUpload(this)">
          <div class="upload-icon">&#128206;</div>
          <p>Drag and drop or <a href="#" onclick="document.getElementById('modal-file-input').click(); return false;">browse</a></p>
          <p class="upload-hint">PDF, JPG, PNG (max 10MB)</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
        <button class="btn btn-primary" id="modal-upload-btn" disabled>Upload</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <script>
    // ================================================================
    // SECURITY: XSS Prevention - Always use this for user-generated content
    // ================================================================
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    // ================================================================
    // APPLICATION STATE - Lead Magnet Flow
    // ================================================================
    const API_BASE = '/api/cpa';
    const CORE_API = '/api/core';  // Unified Core Platform API

    const state = {
      currentStep: 1,
      totalSteps: 5,
      sessionId: null,
      leadId: null,
      consent: false,
      assessmentMode: 'quick', // 'quick' or 'full'

      // CPA Profile (loaded from URL param or default)
      cpaProfile: {
        cpaId: null,
        cpaSlug: null,
        firstName: 'Your',
        lastName: 'Tax Professional',
        credentials: 'CPA',
        firmName: 'Tax Advisory Services',
        logoUrl: null,
        email: '',
        phone: '',
        bookingLink: '#contact'
      },

      // Tax Profile (from smart questions)
      taxProfile: {
        filingStatus: '',
        dependentsCount: 0,
        hasChildrenUnder17: false,
        incomeRange: '',
        incomeSources: ['w2'],
        isHomeowner: false,
        retirementSavings: 'none',
        healthcareType: 'employer',
        lifeEvents: [],
        hasStudentLoans: false,
        hasBusiness: false
      },

      // Contact info (lead gate)
      contact: {
        firstName: '',
        email: '',
        phone: ''
      },

      // Report data
      report: {
        complexity: 'simple',
        savingsRangeLow: 500,
        savingsRangeHigh: 2000,
        insights: [],
        totalInsights: 8,
        insightsShown: 3
      },

      documents: [],
      startTime: null,

      // Client Dashboard State (post-conversion)
      clientDashboard: {
        isAuthenticated: false,
        clientId: null,
        clientName: '',
        assignedCpa: {
          id: null,
          name: '',
          initials: '',
          email: '',
          phone: ''
        },
        returns: [],
        currentReturn: null,
        documentRequests: [],
        uploadedDocuments: [],
        messages: [],
        invoices: [],
        balance: 0,
        unreadMessages: 0
      }
    };

    // ================================================================
    // INITIALIZATION
    // ================================================================
    document.addEventListener('DOMContentLoaded', async () => {
      state.startTime = Date.now();

      const urlParams = new URLSearchParams(window.location.search);

      // Load CPA profile from URL param
      const cpaSlug = urlParams.get('cpa');
      if (cpaSlug) {
        await loadCPAProfile(cpaSlug);
      }

      // Check for existing session from URL
      const sessionId = urlParams.get('session') || urlParams.get('id');
      if (sessionId) {
        state.sessionId = sessionId;
        await loadExistingSession(sessionId);
      } else {
        // No URL session - try to restore from localStorage
        const restored = loadSavedState();
        if (restored && state.currentStep > 1) {
          restoreUIState();
          showToast('Welcome back! Your progress has been restored.', 'success');
        }
      }

      // Apply CPA branding to UI
      updateCPABranding();

      // Setup drag and drop
      setupDragAndDrop();

      // Check for client dashboard access (authenticated client)
      const clientToken = urlParams.get('token') || localStorage.getItem('client_token');
      if (clientToken) {
        await loadClientDashboard();
      }
    });

    // ================================================================
    // KEYBOARD SHORTCUTS
    // ================================================================
    document.addEventListener('keydown', function(e) {
      // Escape - close modals and overlays
      if (e.key === 'Escape') {
        // Close help overlay if open
        const helpOverlay = document.getElementById('help-overlay');
        if (helpOverlay && helpOverlay.classList.contains('active')) {
          closeHelpOverlay();
          return;
        }
        // Close upload modal if open
        const uploadModal = document.getElementById('upload-modal');
        if (uploadModal && uploadModal.style.display !== 'none') {
          closeUploadModal();
          return;
        }
        // Close any overlay
        const overlays = document.querySelectorAll('[style*="position:fixed"][style*="inset:0"]');
        overlays.forEach(o => o.remove());
      }

      // Ctrl/Cmd + K - open help overlay
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        openHelpOverlay();
      }
    });

    function openHelpOverlay() {
      document.getElementById('help-overlay').classList.add('active');
    }

    function closeHelpOverlay() {
      document.getElementById('help-overlay').classList.remove('active');
    }

    // ================================================================
    // CPA PROFILE LOADING
    // ================================================================
    async function loadCPAProfile(cpaSlug) {
      try {
        const response = await fetch(`${API_BASE}/lead-magnet/cpa-profiles/${cpaSlug}`);
        if (response.ok) {
          const data = await response.json();
          state.cpaProfile = {
            cpaId: data.cpa_id,
            cpaSlug: data.cpa_slug,
            firstName: data.first_name || 'Your',
            lastName: data.last_name || 'Tax Professional',
            credentials: data.credentials || 'CPA',
            firmName: data.firm_name || 'Tax Advisory Services',
            logoUrl: data.logo_url,
            email: data.email || '',
            phone: data.phone || '',
            bookingLink: data.booking_link || '#contact'
          };
        }
      } catch (e) {
        console.warn('Could not load CPA profile:', e);
      }
    }

    function updateCPABranding() {
      const cpa = state.cpaProfile;
      const displayName = `${cpa.firstName} ${cpa.lastName}`.trim();
      const fullName = cpa.credentials ? `${displayName}, ${cpa.credentials}` : displayName;

      // Header
      document.getElementById('cpa-name-display').textContent = cpa.firmName || displayName;

      // Welcome screen
      document.getElementById('cpa-name-welcome').textContent = fullName;
      document.getElementById('cpa-firm-welcome').textContent = cpa.firmName || '';

      // Report screen
      document.getElementById('report-cpa-name').textContent = fullName;
      document.getElementById('report-cpa-firm').textContent = cpa.firmName || '';
      document.getElementById('unlock-cpa-name').textContent = cpa.firstName;
      document.getElementById('btn-cpa-name').textContent = cpa.firstName;

      if (cpa.email) {
        document.getElementById('report-cpa-email').innerHTML = `&#9993; ${escapeHtml(cpa.email)}`;
      }
      if (cpa.phone) {
        document.getElementById('report-cpa-phone').innerHTML = `&#128222; ${escapeHtml(cpa.phone)}`;
      }
      if (cpa.bookingLink && cpa.bookingLink !== '#contact' && isValidUrl(cpa.bookingLink)) {
        document.getElementById('report-booking-link').href = cpa.bookingLink;
      }

      // Logo - sanitize URL to prevent XSS
      if (cpa.logoUrl && isValidUrl(cpa.logoUrl)) {
        const logoHtml = `<img src="${escapeHtml(cpa.logoUrl)}" alt="${escapeHtml(displayName)}">`;
        document.getElementById('cpa-logo-welcome').innerHTML = logoHtml;
        document.getElementById('report-cpa-logo').innerHTML = logoHtml;
      } else {
        const initial = cpa.firstName[0] || 'T';
        document.getElementById('cpa-logo-welcome').textContent = initial;
        document.getElementById('report-cpa-logo').textContent = initial;
      }
    }

    // ================================================================
    // ASSESSMENT MODE
    // ================================================================
    function setAssessmentMode(mode) {
      state.assessmentMode = mode;

      // Update UI
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });

      // Show/hide documents step for full mode
      const docsStep = document.getElementById('step-documents');
      const docsConnector = document.getElementById('connector-documents');
      if (mode === 'quick') {
        docsStep.style.display = 'none';
        docsConnector.style.display = 'none';
        // Renumber steps
        document.getElementById('step-contact-circle').textContent = '3';
        document.getElementById('step-report-circle').textContent = '4';
        state.totalSteps = 4;
      } else {
        docsStep.style.display = 'flex';
        docsConnector.style.display = 'block';
        document.getElementById('step-contact-circle').textContent = '4';
        document.getElementById('step-report-circle').textContent = '5';
        state.totalSteps = 5;
      }
    }

    // ================================================================
    // NAVIGATION
    // ================================================================
    function getScreensForMode() {
      if (state.assessmentMode === 'quick') {
        return ['welcome', 'profile', 'contact', 'report'];
      } else {
        return ['welcome', 'profile', 'documents', 'contact', 'report'];
      }
    }

    function goToStep(step) {
      const screens = getScreensForMode();
      if (step < 1 || step > screens.length) return;

      state.currentStep = step;

      // Update stepper UI
      document.querySelectorAll('.step').forEach((el) => {
        const stepNum = parseInt(el.dataset.step);
        el.classList.remove('active', 'completed');

        // Handle skip of documents in quick mode
        let effectiveStep = stepNum;
        if (state.assessmentMode === 'quick' && stepNum > 2) {
          effectiveStep = stepNum - 1;
        }

        if (effectiveStep < step) el.classList.add('completed');
        if (effectiveStep === step) el.classList.add('active');
      });

      document.querySelectorAll('.step-connector').forEach((el, index) => {
        el.classList.toggle('completed', index < step - 1);
      });

      // Show correct screen
      const screenIds = {
        'welcome': 'screen-welcome',
        'profile': 'screen-profile',
        'documents': 'screen-documents',
        'contact': 'screen-contact',
        'report': 'screen-report'
      };

      document.querySelectorAll('.screen').forEach(el => {
        el.classList.remove('active');
      });

      const currentScreen = screens[step - 1];
      const screenEl = document.getElementById(screenIds[currentScreen]);
      if (screenEl) {
        screenEl.classList.add('active');
      }

      // Hide stepper on report screen
      const isReportScreen = currentScreen === 'report';
      document.getElementById('stepper').classList.toggle('hidden', isReportScreen);

      // Prepare screen content
      if (currentScreen === 'contact') prepareContactScreen();
      if (currentScreen === 'report') loadReport();

      saveState();
    }

    function nextStep() {
      const screens = getScreensForMode();
      if (state.currentStep < screens.length) {
        goToStep(state.currentStep + 1);
      }
    }

    function prevStep() {
      if (state.currentStep > 1) {
        goToStep(state.currentStep - 1);
      }
    }

    function skipDocuments() {
      // Skip to contact screen
      const screens = getScreensForMode();
      const contactIndex = screens.indexOf('contact') + 1;
      goToStep(contactIndex);
    }

    // ================================================================
    // CONSENT HANDLING
    // ================================================================
    function toggleConsent(event) {
      const checkbox = document.getElementById('consent-check');
      const box = document.getElementById('consent-box');
      const btn = document.getElementById('btn-start');

      // Only toggle if click was NOT on the checkbox itself (checkbox handles its own toggle)
      if (event && event.target && event.target.id !== 'consent-check') {
        checkbox.checked = !checkbox.checked;
      }

      state.consent = checkbox.checked;
      box.classList.toggle('checked', checkbox.checked);
      btn.disabled = !checkbox.checked;
    }

    // ================================================================
    // START ASSESSMENT
    // ================================================================
    async function startAssessment() {
      if (!state.consent) {
        showToast('Please accept the privacy policy to continue', 'error');
        return;
      }

      // Show loading state on button
      const startBtn = document.getElementById('btn-start');
      const originalText = startBtn.textContent;
      startBtn.disabled = true;
      startBtn.textContent = 'Starting...';

      try {
        // Create session via API
        const response = await fetch(`${API_BASE}/lead-magnet/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cpa_slug: state.cpaProfile.cpaSlug,
            assessment_mode: state.assessmentMode,
            referral_source: new URLSearchParams(window.location.search).get('ref')
          })
        });

        if (response.ok) {
          const data = await response.json();
          state.sessionId = data.session_id;

          // Update URL
          const newUrl = new URL(window.location);
          newUrl.searchParams.set('session', state.sessionId);
          window.history.replaceState({}, '', newUrl);
        }
      } catch (e) {
        console.warn('Could not start session via API:', e);
        // Generate temporary session ID
        state.sessionId = 'temp_' + Date.now();
      }

      // Initialize mode-based stepper
      setAssessmentMode(state.assessmentMode);
      nextStep();
    }

    // ================================================================
    // SMART TAX PROFILE
    // ================================================================
    function adjustDependents(delta) {
      const current = state.taxProfile.dependentsCount;
      const newValue = Math.max(0, Math.min(10, current + delta));
      state.taxProfile.dependentsCount = newValue;
      document.getElementById('dependents-value').textContent = newValue;
      document.getElementById('dependents-count').value = newValue;
      updateProgress();
    }

    function toggleMultiSelect(element) {
      element.classList.toggle('selected');

      // Update state based on which multi-select this belongs to
      const parent = element.closest('.multi-select');
      const selectedItems = parent.querySelectorAll('.selected');
      const values = Array.from(selectedItems).map(el => el.dataset.value);

      if (parent.id === 'income-sources') {
        state.taxProfile.incomeSources = values;
      } else if (parent.id === 'life-events') {
        state.taxProfile.lifeEvents = values;
      }

      updateProgress();
    }

    function updateProgress() {
      // Count filled fields
      let filled = 0;
      const total = 8;

      if (document.getElementById('filing-status').value) filled++;
      filled++; // Dependents always has a value
      if (document.getElementById('income-range').value) filled++;
      if (state.taxProfile.incomeSources.length > 0) filled++;
      filled++; // Homeowner toggle always has a value
      filled++; // Retirement savings dropdown always has a value
      filled++; // Healthcare type dropdown always has a value
      filled++; // Life events (optional, but counts)

      const progress = (filled / total) * 100;
      document.getElementById('profile-progress').style.width = `${progress}%`;
    }

    async function submitProfileAndNext() {
      // Collect all profile data
      const profile = {
        filing_status: document.getElementById('filing-status').value,
        dependents_count: state.taxProfile.dependentsCount,
        has_children_under_17: document.getElementById('children-under-17').checked,
        income_range: document.getElementById('income-range').value,
        income_sources: state.taxProfile.incomeSources,
        is_homeowner: document.getElementById('is-homeowner').checked,
        retirement_savings: document.getElementById('retirement-savings').value,
        healthcare_type: document.getElementById('healthcare-type').value,
        life_events: state.taxProfile.lifeEvents,
        has_student_loans: document.getElementById('has-student-loans').checked,
        has_business: document.getElementById('has-business').checked,
        privacy_consent: state.consent
      };

      // Validation
      if (!profile.filing_status || !profile.income_range) {
        showToast('Please complete filing status and income range', 'error');
        return;
      }

      // Update local state
      Object.assign(state.taxProfile, {
        filingStatus: profile.filing_status,
        dependentsCount: profile.dependents_count,
        hasChildrenUnder17: profile.has_children_under_17,
        incomeRange: profile.income_range,
        incomeSources: profile.income_sources,
        isHomeowner: profile.is_homeowner,
        retirementSavings: profile.retirement_savings,
        healthcareType: profile.healthcare_type,
        lifeEvents: profile.life_events,
        hasStudentLoans: profile.has_student_loans,
        hasBusiness: profile.has_business
      });

      // Submit to API
      try {
        const response = await fetch(`${API_BASE}/lead-magnet/${state.sessionId}/profile`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(profile)
        });

        if (response.ok) {
          const data = await response.json();
          state.report.complexity = data.complexity;

          // Calculate preliminary savings estimate based on complexity
          const savingsMap = {
            'simple': { low: 300, high: 1000 },
            'moderate': { low: 800, high: 3000 },
            'complex': { low: 2000, high: 8000 },
            'professional': { low: 5000, high: 20000 }
          };
          const savings = savingsMap[data.complexity] || savingsMap['simple'];
          state.report.savingsRangeLow = savings.low;
          state.report.savingsRangeHigh = savings.high;
        }
      } catch (e) {
        console.warn('Could not submit profile:', e);
        // Estimate complexity locally
        state.report.complexity = estimateComplexity();
      }

      nextStep();
    }

    function estimateComplexity() {
      // Local complexity estimation
      let score = 0;

      if (state.taxProfile.incomeSources.includes('self_employed')) score += 2;
      if (state.taxProfile.incomeSources.includes('rental')) score += 2;
      if (state.taxProfile.incomeSources.includes('investments')) score += 1;
      if (state.taxProfile.hasBusiness) score += 2;
      if (state.taxProfile.isHomeowner) score += 1;

      const incomeHigh = ['200k_500k', 'over_500k'].includes(state.taxProfile.incomeRange);
      if (incomeHigh) score += 2;

      if (score >= 5) return 'professional';
      if (score >= 3) return 'complex';
      if (score >= 1) return 'moderate';
      return 'simple';
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // ================================================================
    // CONTACT CAPTURE
    // ================================================================
    function prepareContactScreen() {
      // Show savings preview
      const savingsRange = `$${state.report.savingsRangeLow.toLocaleString()} - $${state.report.savingsRangeHigh.toLocaleString()}`;
      document.getElementById('savings-preview').textContent = savingsRange;
    }

    async function captureContactAndGetReport() {
      const firstName = document.getElementById('first-name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();

      // Validation
      if (!firstName || !email) {
        showToast('Please enter your name and email', 'error');
        return;
      }

      if (!isValidEmail(email)) {
        showToast('Please enter a valid email address', 'error');
        return;
      }

      state.contact = { firstName, email, phone };
      document.getElementById('user-name').textContent = firstName;

      // Submit to API
      try {
        const response = await fetch(`${API_BASE}/lead-magnet/${state.sessionId}/contact`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            first_name: firstName,
            email: email,
            phone: phone || null
          })
        });

        if (response.ok) {
          const data = await response.json();
          state.leadId = data.lead_id;
          showToast('Your report is ready!', 'success');
        }
      } catch (e) {
        console.warn('Could not capture contact:', e);
      }

      nextStep();
    }

    // ================================================================
    // LOAD REPORT
    // ================================================================
    async function loadReport() {
      // Update client name
      document.getElementById('report-client-name').textContent = state.contact.firstName || 'You';

      // Update filing status display
      const filingStatusMap = {
        'single': 'Single',
        'married_jointly': 'Married Filing Jointly',
        'married_separately': 'Married Filing Separately',
        'head_of_household': 'Head of Household'
      };
      document.getElementById('report-filing-status').textContent =
        filingStatusMap[state.taxProfile.filingStatus] || 'Single';

      // Update complexity
      const complexityLabels = {
        'simple': 'Simple',
        'moderate': 'Moderate',
        'complex': 'Complex',
        'professional': 'Professional'
      };
      document.getElementById('report-complexity').textContent =
        complexityLabels[state.report.complexity] || 'Moderate';

      // Try to load report from API
      try {
        const response = await fetch(`${API_BASE}/lead-magnet/${state.sessionId}/report`);
        if (response.ok) {
          const data = await response.json();

          // Update savings range
          if (data.savings_range) {
            document.getElementById('report-savings-range').textContent = data.savings_range;
          } else {
            const range = `$${state.report.savingsRangeLow.toLocaleString()} - $${state.report.savingsRangeHigh.toLocaleString()}`;
            document.getElementById('report-savings-range').textContent = range;
          }

          // Update insights
          if (data.insights && data.insights.length > 0) {
            renderReportInsights(data.insights, data.total_insights || 8, data.locked_count || 5);
          } else {
            renderDefaultInsights();
          }

          return;
        }
      } catch (e) {
        console.warn('Could not load report from API:', e);
      }

      // Fallback to local data
      const range = `$${state.report.savingsRangeLow.toLocaleString()} - $${state.report.savingsRangeHigh.toLocaleString()}`;
      document.getElementById('report-savings-range').textContent = range;
      renderDefaultInsights();
    }

    function renderReportInsights(insights, total, locked) {
      const container = document.getElementById('report-insights-list');
      container.innerHTML = insights.map(insight => `
        <div class="insight-teaser">
          <div class="insight-teaser-title">${escapeHtml(insight.title)}</div>
          <div class="insight-teaser-desc">${escapeHtml(insight.teaser_description || insight.description)}</div>
          <div class="insight-teaser-savings">Potential: ${insight.savings_range || 'Contact CPA for details'}</div>
        </div>
      `).join('');

      document.getElementById('report-insights-shown').textContent = insights.length;
      document.getElementById('report-insights-total').textContent = total;
      document.getElementById('report-locked-count').textContent = locked;
    }

    function renderDefaultInsights() {
      // Generate insights based on profile
      const insights = [];

      if (state.taxProfile.retirementSavings !== 'maxed') {
        insights.push({
          title: 'Retirement Savings Optimization',
          description: 'Based on your income, you may be able to increase tax-deferred retirement contributions...'
        });
      }

      if (state.taxProfile.isHomeowner) {
        insights.push({
          title: 'Homeowner Deductions',
          description: 'Property tax and mortgage interest deductions could provide significant savings...'
        });
      }

      if (state.taxProfile.hasChildrenUnder17) {
        insights.push({
          title: 'Child Tax Credit',
          description: 'You may qualify for Child Tax Credit of up to $2,000 per qualifying child...'
        });
      }

      if (state.taxProfile.healthcareType === 'hdhp_hsa') {
        insights.push({
          title: 'HSA Contribution Opportunity',
          description: 'Your HSA-eligible plan allows pre-tax contributions that can reduce taxable income...'
        });
      }

      // Add generic insight if none matched
      if (insights.length < 3) {
        insights.push({
          title: 'Tax Planning Strategy Review',
          description: 'A comprehensive review of your situation may reveal additional opportunities...'
        });
      }

      renderReportInsights(insights.slice(0, 3), 8, 5);
    }

    // ================================================================
    // FILE UPLOAD
    // ================================================================
    function setupDragAndDrop() {
      const zone = document.getElementById('upload-zone');

      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
      });

      zone.addEventListener('dragleave', () => {
        zone.classList.remove('dragover');
      });

      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });
    }

    async function handleFiles(files) {
      for (const file of files) {
        if (file.size > 10 * 1024 * 1024) {
          showToast(`${escapeHtml(file.name)} is too large (max 10MB)`, 'error');
          continue;
        }

        const doc = {
          id: 'doc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          name: file.name,
          size: file.size,
          type: file.type,
          status: 'uploading',
          file: file
        };

        state.documents.push(doc);
        renderFileList();

        // REAL upload to backend API
        try {
          // Ensure we have a session first
          if (!state.sessionId) {
            await createSession();
          }

          const formData = new FormData();
          formData.append('file', file);

          const response = await fetch(`${API_BASE}/clients/${state.sessionId}/documents`, {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            const data = await response.json();
            if (data.success || data.data) {
              doc.status = 'complete';
              doc.document_id = data.data?.document_id || data.document_id;
              showToast(`${escapeHtml(file.name)} uploaded successfully`, 'success');
            } else {
              throw new Error(data.error || 'Upload failed');
            }
          } else {
            throw new Error(`Server error: ${response.status}`);
          }
        } catch (e) {
          console.error('Upload error:', e);
          doc.status = 'error';
          showToast(`Failed to upload ${escapeHtml(file.name)}`, 'error');
        }

        renderFileList();
      }
      saveState();
    }

    function renderFileList() {
      const list = document.getElementById('file-list');

      if (state.documents.length === 0) {
        list.innerHTML = '';
        return;
      }

      list.innerHTML = state.documents.map(doc => `
        <div class="file-item">
          <div class="file-icon">&#128196;</div>
          <div class="file-info">
            <div class="file-name">${escapeHtml(doc.name)}</div>
            <div class="file-size">${formatFileSize(doc.size)}</div>
          </div>
          <span class="file-status ${doc.status}">${doc.status === 'uploading' ? 'Uploading...' : 'Complete'}</span>
          <button class="file-remove" onclick="removeFile('${doc.id}')" aria-label="Remove file">&times;</button>
        </div>
      `).join('');
    }

    function removeFile(id) {
      state.documents = state.documents.filter(d => d.id !== id);
      renderFileList();
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // ================================================================
    // REVIEW & SUBMIT
    // ================================================================
    function prepareReview() {
      document.getElementById('review-personal').innerHTML = `
        <strong>Name:</strong> ${escapeHtml(state.userInfo.firstName)} ${escapeHtml(state.userInfo.lastName)}<br>
        <strong>Email:</strong> ${escapeHtml(state.userInfo.email)}<br>
        <strong>Phone:</strong> ${escapeHtml(state.userInfo.phone) || 'Not provided'}<br>
        <strong>Filing Status:</strong> ${formatFilingStatus(state.userInfo.filingStatus)}<br>
        <strong>Tax Year:</strong> ${state.userInfo.taxYear}
      `;

      document.getElementById('review-documents').innerHTML = state.documents.length > 0
        ? state.documents.map(d => `&#8226; ${escapeHtml(d.name)}`).join('<br>')
        : 'No documents uploaded yet';
    }

    function formatFilingStatus(status) {
      const map = {
        'single': 'Single',
        'married_filing_jointly': 'Married Filing Jointly',
        'married_filing_separately': 'Married Filing Separately',
        'head_of_household': 'Head of Household',
        'qualifying_widow': 'Qualifying Widow(er)'
      };
      return map[status] || status;
    }

    async function submitAndComplete() {
      showToast('Submitting your information...', 'info');

      try {
        // Ensure we have a session
        if (!state.sessionId) {
          await createSession();
        }

        // Save client info first
        await fetch(`${API_BASE}/clients/${state.sessionId}/info`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            first_name: state.userInfo.firstName,
            last_name: state.userInfo.lastName,
            email: state.userInfo.email,
            phone: state.userInfo.phone,
            filing_status: state.userInfo.filingStatus,
            tax_year: state.userInfo.taxYear,
            consent: state.consent
          })
        });

        // Submit for review
        const response = await fetch(`${API_BASE}/clients/${state.sessionId}/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          const data = await response.json();
          state.status = data.data?.status || data.status || 'IN_REVIEW';
          showToast('Successfully submitted for review!', 'success');
        } else {
          throw new Error('Submission failed');
        }
      } catch (e) {
        console.error('Submit error:', e);
        // Even if API fails, proceed to dashboard
        state.status = 'IN_REVIEW';
        showToast('Submitted (offline mode)', 'info');
      }

      saveState();
      goToStep(5);
    }

    // ================================================================
    // DASHBOARD
    // ================================================================
    function loadDashboard() {
      document.getElementById('dash-doc-count').textContent = state.documents.length;
      document.getElementById('dash-status').textContent = formatStatus(state.status);

      renderTimeline();
      loadInsights();
    }

    function formatStatus(status) {
      const map = {
        'DRAFT': 'Draft',
        'IN_REVIEW': 'In Review',
        'CPA_APPROVED': 'Approved'
      };
      return map[status] || status;
    }

    function renderTimeline() {
      const timeline = document.getElementById('timeline');

      const steps = [
        { title: 'Information Submitted', desc: 'Your details have been received', completed: true, time: 'Just now' },
        { title: 'Documents Uploaded', desc: `${state.documents.length} document(s) received`, completed: state.documents.length > 0, time: state.documents.length > 0 ? 'Just now' : '' },
        { title: 'Under Review', desc: 'Our team is analyzing your information', active: state.status === 'IN_REVIEW', time: '' },
        { title: 'Insights Ready', desc: 'Personalized recommendations available', completed: state.status === 'CPA_APPROVED', time: '' },
      ];

      timeline.innerHTML = steps.map((step, i) => `
        <div class="timeline-item ${step.completed ? 'completed' : ''} ${step.active ? 'active' : ''}">
          <div class="timeline-marker"></div>
          <div class="timeline-content">
            <div class="timeline-title">${step.title}</div>
            <div class="timeline-desc">${step.desc}</div>
            ${step.time ? `<div class="timeline-time">${step.time}</div>` : ''}
          </div>
        </div>
      `).join('');
    }

    async function loadInsights() {
      const container = document.getElementById('insight-list');

      // Show loading
      container.innerHTML = `
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <div class="loading-text">Analyzing your situation...</div>
        </div>
      `;

      // Fetch REAL insights from API - no mocks
      try {
        if (state.sessionId) {
          // Try multiple insight endpoints
          let insights = [];

          // Try aggregated insights endpoint
          try {
            const response = await fetch(`${API_BASE}/insights/client/${state.sessionId}`);
            if (response.ok) {
              const data = await response.json();
              if (data.data?.insights) {
                insights = data.data.insights;
              } else if (data.insights) {
                insights = data.insights;
              }
            }
          } catch (e) {
            console.warn('Could not fetch from insights endpoint');
          }

          // Try recommendations endpoint as fallback
          if (insights.length === 0) {
            try {
              const recResponse = await fetch(`${API_BASE}/data/recommendations?client_id=${state.clientId || state.sessionId}&limit=10`);
              if (recResponse.ok) {
                const recData = await recResponse.json();
                if (recData.recommendations) {
                  insights = recData.recommendations.map(r => ({
                    title: r.title,
                    description: r.description,
                    category: r.category || 'opportunity',
                    priority: r.priority || 'medium',
                    estimated_savings: r.estimated_savings
                  }));
                }
              }
            } catch (e) {
              console.warn('Could not fetch recommendations');
            }
          }

          // Try to get client full data
          if (insights.length === 0) {
            try {
              const fullResponse = await fetch(`${API_BASE}/clients/${state.sessionId}/full`);
              if (fullResponse.ok) {
                const fullData = await fullResponse.json();
                const clientData = fullData.data?.client || fullData.client;
                if (clientData?.recommendations) {
                  insights = clientData.recommendations.map(r => ({
                    title: r.title,
                    description: r.description,
                    category: r.category || 'opportunity',
                    priority: r.priority || 'medium',
                    estimated_savings: r.estimated_savings
                  }));
                }
              }
            } catch (e) {
              console.warn('Could not fetch client full data');
            }
          }

          state.insights = insights;
          renderInsights();
          return;
        }
      } catch (e) {
        console.error('Error loading insights:', e);
        showToast('Could not load insights. Please try refreshing.', 'error');
      }

      // No mock data - show empty state
      state.insights = [];
      renderInsights();
    }

    function renderInsights() {
      const container = document.getElementById('insight-list');
      document.getElementById('dash-insight-count').textContent = state.insights.length;

      if (state.insights.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">&#128269;</div>
            <div class="empty-title">No insights yet</div>
            <div class="empty-desc">We're still analyzing your information. Check back soon!</div>
          </div>
        `;
        return;
      }

      container.innerHTML = state.insights.map(insight => `
        <div class="insight-item">
          <div class="insight-icon ${sanitizeClassName(insight.category) || 'info'}">
            ${insight.category === 'opportunity' ? '&#128161;' : insight.category === 'alert' ? '&#9888;' : '&#128196;'}
          </div>
          <div class="insight-content">
            <div class="insight-title">${escapeHtml(insight.title)}</div>
            <div class="insight-desc">${escapeHtml(insight.description)}</div>
          </div>
          <span class="insight-badge">${escapeHtml(insight.priority || 'info')}</span>
        </div>
      `).join('');
    }

    // ================================================================
    // API COMMUNICATION
    // ================================================================
    async function createSession() {
      try {
        const response = await fetch(`${API_BASE}/clients/intake/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            first_name: state.userInfo.firstName,
            last_name: state.userInfo.lastName,
            email: state.userInfo.email,
            phone: state.userInfo.phone,
            filing_status: state.userInfo.filingStatus,
            tax_year: state.userInfo.taxYear,
            consent: state.consent
          })
        });

        if (response.ok) {
          const data = await response.json();
          // Handle both direct response and data wrapper
          const responseData = data.data || data;
          if (responseData.session_id) {
            state.sessionId = responseData.session_id;
            state.clientId = responseData.client_id;
            // Update URL
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('session', state.sessionId);
            window.history.replaceState({}, '', newUrl);
          }
        } else {
          throw new Error(`API returned ${response.status}`);
        }
      } catch (e) {
        console.error('Could not create session via API:', e);
        // Generate a temporary session ID for offline use
        state.sessionId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        showToast('Working in offline mode - data will sync when connection restores', 'info');
      }

      saveState();
    }

    async function loadExistingSession(sessionId) {
      try {
        // Try to load from client full endpoint first
        let response = await fetch(`${API_BASE}/clients/${sessionId}/full`);
        if (!response.ok) {
          // Fallback to data/clients endpoint
          response = await fetch(`${API_BASE}/data/clients/${sessionId}`);
        }

        if (response.ok) {
          const data = await response.json();
          const clientData = data.data?.client || data.client;

          if (clientData) {
            state.clientId = clientData.client_id;
            state.userInfo.firstName = clientData.first_name || '';
            state.userInfo.lastName = clientData.last_name || '';
            state.userInfo.email = clientData.email || '';
            state.userInfo.phone = clientData.phone || '';
            state.userInfo.filingStatus = clientData.filing_status || '';
            state.userInfo.taxYear = clientData.tax_year || '2025';
            state.consent = clientData.consent_given || true;
            state.status = clientData.status || 'DRAFT';

            // Load documents if available
            if (clientData.documents) {
              state.documents = clientData.documents.map(d => ({
                id: d.document_id,
                name: d.original_filename || d.filename,
                size: d.file_size,
                status: 'complete'
              }));
            }

            // Load insights/recommendations if available
            if (clientData.recommendations) {
              state.insights = clientData.recommendations;
            }

            document.getElementById('user-name').textContent = state.userInfo.firstName || 'Client';

            // Determine which step to show based on status
            if (state.status === 'IN_REVIEW' || state.status === 'CPA_APPROVED') {
              goToStep(5); // Dashboard
            } else if (state.documents.length > 0) {
              goToStep(4); // Review
            } else if (state.userInfo.firstName) {
              goToStep(3); // Documents
            } else {
              goToStep(2); // Personal info
            }
            return;
          }
        }
      } catch (e) {
        console.error('Could not load existing session:', e);
      }

      // Session not found, start fresh
      showToast('Session not found, starting fresh', 'info');
    }

    // ================================================================
    // STATE PERSISTENCE
    // ================================================================

    /**
     * Load saved state from localStorage
     * Returns true if state was restored, false otherwise
     */
    function loadSavedState() {
      try {
        const saved = localStorage.getItem('tax_portal_state');
        if (!saved) return false;

        const parsed = JSON.parse(saved);

        // Only restore if we have valid data and no URL session override
        if (parsed && parsed.currentStep !== undefined) {
          // Restore state properties
          if (parsed.currentStep) state.currentStep = parsed.currentStep;
          if (parsed.sessionId) state.sessionId = parsed.sessionId;
          if (parsed.consent) state.consent = parsed.consent;
          if (parsed.userInfo) state.userInfo = { ...state.userInfo, ...parsed.userInfo };
          if (parsed.documents) state.documents = parsed.documents;
          if (parsed.status) state.status = parsed.status;

          return true;
        }
      } catch (e) {
        console.warn('Failed to restore saved state:', e);
        localStorage.removeItem('tax_portal_state');
      }
      return false;
    }

    /**
     * Clear saved state (e.g., when starting fresh or completing)
     */
    function clearSavedState() {
      localStorage.removeItem('tax_portal_state');
    }

    function saveState() {
      const toSave = {
        currentStep: state.currentStep,
        sessionId: state.sessionId,
        consent: state.consent,
        userInfo: state.userInfo,
        documents: state.documents.map(d => ({ id: d.id, name: d.name, size: d.size, status: d.status })),
        status: state.status,
        savedAt: Date.now()
      };
      localStorage.setItem('tax_portal_state', JSON.stringify(toSave));
    }

    function restoreUIState() {
      // Restore consent
      if (state.consent) {
        document.getElementById('consent-check').checked = true;
        document.getElementById('consent-box').classList.add('checked');
        document.getElementById('btn-start').disabled = false;
      }

      // Restore user info
      if (state.userInfo.firstName) {
        document.getElementById('first-name').value = state.userInfo.firstName;
        document.getElementById('last-name').value = state.userInfo.lastName;
        document.getElementById('email').value = state.userInfo.email;
        document.getElementById('phone').value = state.userInfo.phone || '';
        document.getElementById('filing-status').value = state.userInfo.filingStatus;
        document.getElementById('tax-year').value = state.userInfo.taxYear;
        document.getElementById('user-name').textContent = state.userInfo.firstName;
      }

      // Restore documents
      renderFileList();

      // Go to saved step
      goToStep(state.currentStep);
    }

    // ================================================================
    // CLIENT DASHBOARD - Post-Conversion Experience
    // ================================================================

    /**
     * Load the client dashboard after authentication
     */
    async function loadClientDashboard() {
      try {
        // Check for client token in URL or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const clientToken = urlParams.get('token') || localStorage.getItem('client_token');

        if (!clientToken) {
          return;
        }

        // Store token
        localStorage.setItem('client_token', clientToken);
        const secureFlag = window.location.protocol === 'https:' ? '; Secure' : '';
        document.cookie = `client_token=${encodeURIComponent(clientToken)}; Path=/; Max-Age=86400; SameSite=Lax${secureFlag}`;

        // Load client data from API
        const clientData = await clientApi('/client/dashboard');

        // Update state
        state.clientDashboard = {
          ...state.clientDashboard,
          isAuthenticated: true,
          clientId: clientData.client_id,
          clientName: clientData.name || 'Client',
          assignedCpa: {
            id: clientData.cpa?.id,
            name: clientData.cpa?.name || 'Your CPA',
            initials: getInitials(clientData.cpa?.name || 'CPA'),
            email: clientData.cpa?.email || '',
            phone: clientData.cpa?.phone || ''
          },
          returns: clientData.returns || [],
          currentReturn: clientData.current_return || null,
          documentRequests: clientData.document_requests || [],
          uploadedDocuments: clientData.uploaded_documents || [],
          messages: clientData.messages || [],
          invoices: clientData.invoices || [],
          balance: clientData.balance || 0,
          unreadMessages: clientData.unread_messages || 0
        };

        // Show dashboard
        showDashboard();
        updateDashboardUI();

      } catch (error) {
        console.error('Failed to load dashboard:', error);
        showToast('Failed to load dashboard. Please try again.', 'error');
      }
    }

    /**
     * Show the client dashboard screen
     */
    function showDashboard() {
      // Hide stepper and other screens
      document.getElementById('stepper').style.display = 'none';

      // Hide all screens
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));

      // Show dashboard
      document.getElementById('screen-dashboard').classList.add('active');

      // Update header for dashboard mode
      const userDisplay = document.getElementById('user-display');
      userDisplay.innerHTML = `
        <span>&#128100;</span>
        <span>${escapeHtml(state.clientDashboard.clientName)}</span>
        <button class="btn-logout" onclick="logout()" title="Logout">&#x2715;</button>
      `;
    }

    /**
     * Update all dashboard UI elements with current state
     */
    function updateDashboardUI() {
      const dash = state.clientDashboard;

      // Update welcome section
      document.getElementById('dashboard-client-name').textContent = escapeHtml(dash.clientName);

      // Update CPA info
      document.getElementById('dashboard-cpa-avatar').textContent = dash.assignedCpa.initials;
      document.getElementById('dashboard-cpa-name').textContent = escapeHtml(dash.assignedCpa.name);
      document.getElementById('dashboard-cpa-email-link').href = `mailto:${dash.assignedCpa.email}`;
      document.getElementById('dashboard-cpa-phone-link').href = `tel:${dash.assignedCpa.phone}`;

      // Update stats
      document.getElementById('dash-returns-count').textContent = dash.returns.filter(r => r.status !== 'filed').length;
      document.getElementById('dash-docs-pending').textContent = dash.documentRequests.filter(d => !d.fulfilled).length;
      document.getElementById('dash-messages-count').textContent = dash.unreadMessages;
      document.getElementById('dash-balance').textContent = formatCurrency(dash.balance);

      // Update current return status
      if (dash.currentReturn) {
        updateReturnProgress(dash.currentReturn);
      }

      // Update action items
      updateActionItems();

      // Update messages tab CPA name
      document.getElementById('messages-cpa-name').textContent = escapeHtml(dash.assignedCpa.name);

      // Update billing balance
      document.getElementById('billing-balance').textContent = formatCurrency(dash.balance);
      const balanceStatus = document.getElementById('billing-status');
      const payBtn = document.getElementById('pay-now-btn');
      if (dash.balance > 0) {
        balanceStatus.textContent = 'Payment Due';
        balanceStatus.classList.add('due');
        payBtn.style.display = 'block';
      } else {
        balanceStatus.textContent = 'Paid in Full';
        balanceStatus.classList.remove('due');
        payBtn.style.display = 'none';
      }
    }

    /**
     * Switch between dashboard tabs
     */
    function showDashboardTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.dash-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.currentTarget?.classList.add('active');

      // Find the clicked tab button if not using event
      if (!event?.currentTarget) {
        document.querySelectorAll('.dash-tab').forEach(tab => {
          if (tab.textContent.toLowerCase().includes(tabName.toLowerCase())) {
            tab.classList.add('active');
          }
        });
      }

      // Update tab content
      document.querySelectorAll('.dash-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // Load tab-specific data
      switch (tabName) {
        case 'returns':
          loadReturnsTab();
          break;
        case 'documents':
          loadDocumentsTab();
          break;
        case 'messages':
          loadMessagesTab();
          scrollToLatestMessage();
          break;
        case 'billing':
          loadBillingTab();
          break;
      }
    }

    /**
     * Update return progress visualization
     */
    function updateReturnProgress(returnData) {
      const stages = ['received', 'review', 'ready', 'filed'];
      const currentStageIndex = stages.indexOf(returnData.status || 'received');
      const progress = ((currentStageIndex + 1) / stages.length) * 100;

      document.getElementById('return-progress-fill').style.width = `${progress}%`;
      document.getElementById('return-tax-year').textContent = returnData.tax_year || new Date().getFullYear();
      document.getElementById('return-type').textContent = returnData.return_type || '1040 Individual';
      document.getElementById('return-updated').textContent = formatRelativeTime(returnData.updated_at);

      // Update progress steps
      const stepsContainer = document.getElementById('return-progress-steps');
      const steps = stepsContainer.querySelectorAll('.progress-step');
      steps.forEach((step, index) => {
        step.classList.remove('completed', 'active');
        if (index < currentStageIndex) {
          step.classList.add('completed');
        } else if (index === currentStageIndex) {
          step.classList.add('active');
        }
      });

      // Update status badge
      const statusBadge = document.getElementById('return-status-badge');
      const statusLabels = {
        'received': 'Info Received',
        'review': 'In Review',
        'ready': 'Ready for Review',
        'filed': 'Filed'
      };
      statusBadge.textContent = statusLabels[returnData.status] || 'In Progress';
      statusBadge.className = `status-badge status-${returnData.status === 'filed' ? 'complete' : 'progress'}`;
    }

    /**
     * Update action items in overview
     */
    function updateActionItems() {
      const container = document.getElementById('action-items-list');
      const dash = state.clientDashboard;
      const items = [];

      // Add pending document requests
      dash.documentRequests.filter(d => !d.fulfilled).forEach(doc => {
        items.push({
          type: 'document',
          urgent: doc.urgent,
          icon: '&#128206;',
          title: `Upload ${escapeHtml(doc.name)}`,
          desc: escapeHtml(doc.description || 'Your CPA needs this document'),
          action: 'Upload',
          handler: `showDashboardTab('documents')`
        });
      });

      // Add unread messages
      if (dash.unreadMessages > 0) {
        items.push({
          type: 'message',
          urgent: false,
          icon: '&#128172;',
          title: `${dash.unreadMessages} New Message${dash.unreadMessages > 1 ? 's' : ''}`,
          desc: 'You have unread messages from your CPA',
          action: 'View',
          handler: `showDashboardTab('messages')`
        });
      }

      // Add pending invoices
      dash.invoices.filter(i => i.status === 'pending').forEach(inv => {
        items.push({
          type: 'invoice',
          urgent: isOverdue(inv.due_date),
          icon: '&#128176;',
          title: `Payment Due: ${formatCurrency(inv.amount)}`,
          desc: `Due ${formatDate(inv.due_date)}`,
          action: 'Pay',
          handler: `showDashboardTab('billing')`
        });
      });

      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: var(--space-6);">
            <div class="empty-icon">&#10003;</div>
            <div class="empty-title">All caught up!</div>
            <div class="empty-desc">No action items at this time.</div>
          </div>
        `;
        return;
      }

      container.innerHTML = items.slice(0, 5).map(item => `
        <div class="action-item ${item.urgent ? 'urgent' : ''}">
          <div class="action-icon">${item.icon}</div>
          <div class="action-content">
            <div class="action-title">${item.title}</div>
            <div class="action-desc">${item.desc}</div>
          </div>
          <button class="btn btn-sm btn-${item.urgent ? 'primary' : 'secondary'}" onclick="${item.handler}">${item.action}</button>
        </div>
      `).join('');
    }

    /**
     * Load returns tab data - Uses Core Platform API
     */
    async function loadReturnsTab() {
      try {
        // Use Core API for tax returns
        const returns = await coreApi('/tax-returns/my');
        state.clientDashboard.returns = returns;

        const tbody = document.getElementById('returns-table-body');
        if (returns.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: var(--space-10);">No tax returns yet.</td></tr>`;
          return;
        }

        tbody.innerHTML = returns.map(ret => `
          <tr>
            <td>${ret.tax_year}</td>
            <td>${escapeHtml(ret.return_type || 'individual')}</td>
            <td><span class="status-badge status-${getStatusClass(ret.status)}">${escapeHtml(formatStatus(ret.status))}</span></td>
            <td style="color: ${ret.refund_amount > 0 ? 'var(--secondary)' : 'var(--error)'};">
              ${ret.refund_amount !== undefined ? (ret.refund_amount > 0 ? '+' : '') + formatCurrency(ret.refund_amount) + (ret.refund_amount > 0 ? ' Refund' : ' Owed') : 'Calculating...'}
            </td>
            <td>
              ${ret.status === 'filed'
                ? `<button class="btn btn-sm btn-secondary" onclick="downloadReturn('${ret.id}')">Download</button>`
                : `<button class="btn btn-sm btn-secondary" onclick="viewReturnDetails('${ret.id}')">View</button>`
              }
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Failed to load returns:', error);
        showToast('Could not load tax returns. Please try again.', 'error');
      }
    }

    /**
     * Format status for display
     */
    function formatStatus(status) {
      const statusLabels = {
        'draft': 'Draft',
        'in_progress': 'In Progress',
        'pending_review': 'Pending Review',
        'under_review': 'Under Review',
        'needs_info': 'Needs Info',
        'approved': 'Approved',
        'filed': 'Filed',
        'rejected': 'Rejected'
      };
      return statusLabels[status] || status;
    }

    /**
     * Load documents tab data - Uses Core Platform API
     */
    async function loadDocumentsTab() {
      try {
        // Use Core API for documents
        const [requests, uploads] = await Promise.all([
          coreApi('/documents/requests/pending'),
          coreApi('/documents/my')
        ]);

        state.clientDashboard.documentRequests = requests;
        state.clientDashboard.uploadedDocuments = uploads;

        // Update requests list
        const requestsList = document.getElementById('doc-requests-list');
        if (requests.length === 0) {
          requestsList.innerHTML = `<div style="text-align: center; padding: var(--space-6); color: var(--gray-500);">No documents needed at this time.</div>`;
        } else {
          requestsList.innerHTML = requests.filter(d => d.status === 'pending').map((doc, i) => `
            <div class="doc-request ${doc.required ? 'urgent' : ''}">
              <div class="doc-info">
                <div class="doc-name">${escapeHtml(doc.category)}</div>
                <div class="doc-desc">${escapeHtml(doc.description)}</div>
              </div>
              <div class="doc-actions">
                <input type="file" id="upload-req-${i}" style="display: none;" onchange="uploadRequestedDoc(this, '${doc.id}')">
                <button class="btn btn-sm btn-primary" onclick="document.getElementById('upload-req-${i}').click()">Upload</button>
              </div>
            </div>
          `).join('');
        }

        // Update uploads list
        const uploadsList = document.getElementById('uploaded-docs-list');
        if (uploads.length === 0) {
          uploadsList.innerHTML = `<div style="text-align: center; padding: var(--space-6); color: var(--gray-500);">No documents uploaded yet.</div>`;
        } else {
          uploadsList.innerHTML = uploads.map(doc => `
            <div class="uploaded-doc">
              <div class="doc-icon">&#128196;</div>
              <div class="doc-info">
                <div class="doc-name">${escapeHtml(doc.filename || doc.original_filename)}</div>
                <div class="doc-meta">Uploaded ${formatDate(doc.uploaded_at)} &bull; ${formatFileSize(doc.file_size)}</div>
              </div>
              <span class="status-badge status-${getDocStatusClass(doc.status)}">${escapeHtml(formatDocStatus(doc.status))}</span>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Failed to load documents:', error);
        showToast('Could not load documents. Please try again.', 'error');
      }
    }

    /**
     * Get document status CSS class
     */
    function getDocStatusClass(status) {
      const classes = {
        'pending': 'pending',
        'uploaded': 'progress',
        'verified': 'complete',
        'rejected': 'error'
      };
      return classes[status] || 'progress';
    }

    /**
     * Format document status for display
     */
    function formatDocStatus(status) {
      const labels = {
        'pending': 'Pending',
        'uploaded': 'Received',
        'verified': 'Verified',
        'rejected': 'Rejected'
      };
      return labels[status] || status;
    }

    /**
     * Upload a document for a specific request
     */
    async function uploadRequestedDoc(input, requestId) {
      const file = input.files[0];
      if (!file) return;

      try {
        showToast('Uploading document...', 'info');

        const formData = new FormData();
        formData.append('file', file);
        formData.append('request_id', requestId);

        await clientApiUpload('/client/documents/upload', formData);

        showToast('Document uploaded successfully!', 'success');
        loadDocumentsTab();
        updateActionItems();

      } catch (error) {
        console.error('Upload failed:', error);
        showToast('Failed to upload document. Please try again.', 'error');
      }

      // Reset input
      input.value = '';
    }

    // Focus trap state for accessibility
    let modalPreviousFocus = null;
    let modalFocusTrapHandler = null;

    /**
     * Set up focus trap for a modal
     */
    function setupModalFocusTrap(modal) {
      modalPreviousFocus = document.activeElement;

      const focusableElements = modal.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      const firstFocusable = focusableElements[0];
      const lastFocusable = focusableElements[focusableElements.length - 1];

      if (firstFocusable) {
        setTimeout(() => firstFocusable.focus(), 50);
      }

      modalFocusTrapHandler = (e) => {
        if (e.key === 'Tab') {
          if (e.shiftKey && document.activeElement === firstFocusable) {
            e.preventDefault();
            lastFocusable.focus();
          } else if (!e.shiftKey && document.activeElement === lastFocusable) {
            e.preventDefault();
            firstFocusable.focus();
          }
        }
        if (e.key === 'Escape') {
          closeUploadModal();
        }
      };

      document.addEventListener('keydown', modalFocusTrapHandler);
    }

    /**
     * Clean up focus trap
     */
    function cleanupModalFocusTrap() {
      if (modalFocusTrapHandler) {
        document.removeEventListener('keydown', modalFocusTrapHandler);
        modalFocusTrapHandler = null;
      }
      if (modalPreviousFocus) {
        modalPreviousFocus.focus();
        modalPreviousFocus = null;
      }
    }

    /**
     * Open upload modal
     */
    function openUploadModal() {
      const modal = document.getElementById('upload-modal');
      modal.style.display = 'flex';
      setupModalFocusTrap(modal);
    }

    /**
     * Close upload modal
     */
    function closeUploadModal() {
      document.getElementById('upload-modal').style.display = 'none';
      document.getElementById('modal-file-input').value = '';
      document.getElementById('modal-upload-btn').disabled = true;
      cleanupModalFocusTrap();
    }

    /**
     * Handle file selection in upload modal
     */
    function handleModalUpload(input) {
      const file = input.files[0];
      document.getElementById('modal-upload-btn').disabled = !file;

      if (file) {
        // Update modal UI to show selected file
        const uploadZone = document.getElementById('modal-upload-zone');
        uploadZone.innerHTML = `
          <div class="file-item" style="border: none; background: none;">
            <div class="file-icon">&#128196;</div>
            <div class="file-info">
              <div class="file-name">${escapeHtml(file.name)}</div>
              <div class="file-size">${formatFileSize(file.size)}</div>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="resetModalUpload()">Change</button>
          </div>
        `;
      }
    }

    /**
     * Reset modal upload zone
     */
    function resetModalUpload() {
      document.getElementById('modal-file-input').value = '';
      document.getElementById('modal-upload-btn').disabled = true;
      document.getElementById('modal-upload-zone').innerHTML = `
        <input type="file" id="modal-file-input" style="display: none;" onchange="handleModalUpload(this)">
        <div class="upload-icon">&#128206;</div>
        <p>Drag and drop or <a href="#" onclick="document.getElementById('modal-file-input').click(); return false;">browse</a></p>
        <p class="upload-hint">PDF, JPG, PNG (max 10MB)</p>
      `;
    }

    /**
     * Load messages tab data
     */
    async function loadMessagesTab() {
      try {
        // Use Core API for messaging - get conversations first
        const conversations = await coreApi('/messages/conversations');

        // Get the first conversation (CPA conversation) or empty
        const conversation = conversations.find(c => c.type === 'tax_return' || c.type === 'direct') || conversations[0];

        if (!conversation) {
          const container = document.getElementById('messages-container');
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">&#128172;</div>
              <div class="empty-title">No messages yet</div>
              <div class="empty-desc">Send a message to your CPA to get started.</div>
            </div>
          `;
          return;
        }

        // Store conversation ID for sending messages
        state.clientDashboard.conversationId = conversation.id;

        // Get messages in the conversation
        const messages = await coreApi(`/messages/conversations/${conversation.id}/messages`);
        state.clientDashboard.messages = messages;

        const container = document.getElementById('messages-container');
        if (messages.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">&#128172;</div>
              <div class="empty-title">No messages yet</div>
              <div class="empty-desc">Send a message to your CPA to get started.</div>
            </div>
          `;
          return;
        }

        const cpa = state.clientDashboard.assignedCpa;
        const myId = state.clientDashboard.clientId;

        // Messages come in reverse order, so reverse for display
        const sortedMessages = [...messages].reverse();

        container.innerHTML = sortedMessages.map(msg => `
          <div class="message ${msg.sender_id === myId ? 'sent' : 'received'}">
            ${msg.sender_id !== myId ? `<div class="message-avatar">${getInitials(msg.sender_name)}</div>` : ''}
            <div class="message-content">
              <div class="message-text">${escapeHtml(msg.content)}</div>
              <div class="message-time">${formatRelativeTime(msg.created_at)}</div>
            </div>
          </div>
        `).join('');

        // Mark conversation as read
        await coreApi(`/messages/conversations/${conversation.id}/read`, { method: 'POST' }).catch(() => {});
        state.clientDashboard.unreadMessages = 0;
        document.getElementById('dash-messages-count').textContent = '0';

      } catch (error) {
        console.error('Failed to load messages:', error);
        showToast('Could not load messages. Please try again.', 'error');
      }
    }

    /**
     * Send a message to CPA - Uses Core Platform API
     */
    async function sendMessage() {
      const input = document.getElementById('message-input');
      const content = input.value.trim();

      if (!content) return;

      try {
        // Get or create conversation
        let conversationId = state.clientDashboard.conversationId;

        if (!conversationId && state.clientDashboard.assignedCpa?.id) {
          // Create a new conversation
          const newConv = await coreApi('/messages/conversations', {
            method: 'POST',
            body: JSON.stringify({
              type: 'direct',
              participant_ids: [state.clientDashboard.assignedCpa.id],
              initial_message: content
            })
          });
          conversationId = newConv.id;
          state.clientDashboard.conversationId = conversationId;
          input.value = '';
          loadMessagesTab();
          return;
        }

        // Send message to existing conversation
        await coreApi(`/messages/conversations/${conversationId}/messages`, {
          method: 'POST',
          body: JSON.stringify({ content, message_type: 'text' })
        });

        input.value = '';

        // Optimistically add message to UI
        const container = document.getElementById('messages-container');
        const messageEl = document.createElement('div');
        messageEl.className = 'message sent';
        messageEl.innerHTML = `
          <div class="message-content">
            <div class="message-text">${escapeHtml(content)}</div>
            <div class="message-time">Just now</div>
          </div>
        `;
        container.appendChild(messageEl);
        scrollToLatestMessage();

      } catch (error) {
        console.error('Failed to send message:', error);
        showToast('Failed to send message. Please try again.', 'error');
      }
    }

    /**
     * Scroll to latest message
     */
    function scrollToLatestMessage() {
      const container = document.getElementById('messages-container');
      container.scrollTop = container.scrollHeight;
    }

    /**
     * Load billing tab data - Uses Core Platform API
     */
    async function loadBillingTab() {
      try {
        // Use Core API for billing
        const [invoices, subscription] = await Promise.all([
          coreApi('/billing/invoices'),
          coreApi('/billing/subscription').catch(() => null)
        ]);

        state.clientDashboard.invoices = invoices || [];

        // Calculate outstanding balance from unpaid invoices
        const balance = invoices
          .filter(inv => inv.status !== 'paid')
          .reduce((sum, inv) => sum + inv.total, 0);
        state.clientDashboard.balance = balance;

        // Update balance display
        document.getElementById('billing-balance').textContent = formatCurrency(balance);

        const tbody = document.getElementById('invoices-table-body');
        if (invoices.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: var(--space-10);">No invoices yet.</td></tr>`;
          return;
        }

        tbody.innerHTML = invoices.map(inv => `
          <tr>
            <td>${formatDate(inv.created_at)}</td>
            <td>${escapeHtml(inv.invoice_number)}</td>
            <td>${formatCurrency(inv.total)}</td>
            <td><span class="status-badge status-${inv.status === 'paid' ? 'complete' : 'pending'}">${inv.status === 'paid' ? 'Paid' : `Due ${formatDate(inv.due_date)}`}</span></td>
            <td>
              ${inv.status === 'paid'
                ? `<button class="btn btn-sm btn-secondary" onclick="downloadReceipt('${inv.id}')">Receipt</button>`
                : `<button class="btn btn-sm btn-primary" onclick="payInvoice('${inv.id}')">Pay</button>`
              }
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Failed to load billing:', error);
        showToast('Could not load billing information. Please try again.', 'error');
      }
    }

    /**
     * Core Platform API helper with auth
     * Uses the unified /api/core endpoints
     */
    async function coreApi(endpoint, options = {}) {
      const token = localStorage.getItem('client_token');
      const response = await fetch(`${CORE_API}${endpoint}`, {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        },
        ...options
      });

      if (!response.ok) {
        if (response.status === 401) {
          localStorage.removeItem('client_token');
          document.cookie = 'client_token=; Path=/; Max-Age=0; SameSite=Lax';
          showToast('Session expired. Please log in again.', 'error');
          setTimeout(() => window.location.href = '/client/login', 2000);
        }
        throw new Error((await response.json()).detail || 'Request failed');
      }

      return response.json();
    }

    /**
     * Client API helper with auth (legacy CPA endpoints)
     */
    async function clientApi(endpoint, options = {}) {
      const token = localStorage.getItem('client_token');
      const response = await fetch(`${API_BASE}${endpoint}`, {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        },
        ...options
      });

      if (!response.ok) {
        if (response.status === 401) {
          // Token expired, redirect to login
          localStorage.removeItem('client_token');
          document.cookie = 'client_token=; Path=/; Max-Age=0; SameSite=Lax';
          showToast('Session expired. Please log in again.', 'error');
          setTimeout(() => window.location.href = '/client/login', 2000);
        }
        throw new Error((await response.json()).detail || 'Request failed');
      }

      return response.json();
    }

    /**
     * Client API helper for file uploads
     */
    async function clientApiUpload(endpoint, formData) {
      const token = localStorage.getItem('client_token');
      const response = await fetch(`${API_BASE}${endpoint}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });

      if (!response.ok) {
        throw new Error((await response.json()).detail || 'Upload failed');
      }

      return response.json();
    }

    /**
     * Logout client
     */
    function logout() {
      localStorage.removeItem('client_token');
      document.cookie = 'client_token=; Path=/; Max-Age=0; SameSite=Lax';
      window.location.href = '/client/login';
    }

    /**
     * Download a filed return - Uses Core Platform API
     */
    async function downloadReturn(returnId) {
      try {
        // Core API doesn't have download yet, get the return details
        const ret = await coreApi(`/tax-returns/${returnId}`);
        showToast('Return download will be available when filing is complete.', 'info');
      } catch (error) {
        showToast('Failed to download return.', 'error');
      }
    }

    /**
     * View return details
     */
    function viewReturnDetails(returnId) {
      const ret = state.clientDashboard.returns.find(r => r.id === returnId);
      if (ret) {
        state.clientDashboard.currentReturn = ret;
        updateReturnProgress(ret);
        showDashboardTab('overview');
      }
    }

    /**
     * Download payment receipt - Uses Core Platform API
     */
    async function downloadReceipt(invoiceId) {
      try {
        const response = await coreApi(`/billing/invoices/${invoiceId}/download`);
        if (response.download_url) {
          window.open(response.download_url, '_blank');
        } else {
          showToast('Receipt download started.', 'info');
        }
      } catch (error) {
        showToast('Failed to download receipt.', 'error');
      }
    }

    /**
     * Pay an invoice - Uses Core Platform API
     */
    async function payInvoice(invoiceId) {
      try {
        const response = await coreApi(`/billing/invoices/${invoiceId}/pay`, { method: 'POST' });
        if (response.success) {
          showToast('Payment successful!', 'success');
          loadBillingTab();
        } else if (response.payment_url) {
          window.location.href = response.payment_url;
        }
      } catch (error) {
        showToast('Failed to process payment. Please try again.', 'error');
      }
    }

    // ================================================================
    // DASHBOARD HELPER FUNCTIONS
    // ================================================================

    function getInitials(name) {
      if (!name) return '??';
      return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatRelativeTime(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
      if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
      return formatDate(dateStr);
    }

    function formatFileSize(bytes) {
      if (!bytes) return '0 B';
      const units = ['B', 'KB', 'MB', 'GB'];
      let i = 0;
      while (bytes >= 1024 && i < units.length - 1) {
        bytes /= 1024;
        i++;
      }
      return `${bytes.toFixed(1)} ${units[i]}`;
    }

    function getStatusClass(status) {
      const map = {
        'received': 'progress',
        'review': 'progress',
        'ready': 'pending',
        'filed': 'complete',
        'pending': 'pending',
        'paid': 'complete'
      };
      return map[status] || 'progress';
    }

    function isOverdue(dateStr) {
      if (!dateStr) return false;
      return new Date(dateStr) < new Date();
    }

    // ================================================================
    // UTILITIES
    // ================================================================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function isValidUrl(url) {
      if (!url) return false;
      try {
        const parsed = new URL(url, window.location.origin);
        // Only allow http/https protocols to prevent javascript: URLs
        return ['http:', 'https:'].includes(parsed.protocol);
      } catch {
        return false;
      }
    }

    function sanitizeClassName(className) {
      // Only allow alphanumeric, hyphens, and underscores for CSS classes
      if (!className) return '';
      return className.replace(/[^a-zA-Z0-9_-]/g, '');
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icons = { success: '&#10003;', error: '&#10007;', info: '&#8505;' };

      toast.innerHTML = `
        <span class="toast-icon">${icons[type] || icons.info}</span>
        <span class="toast-message">${escapeHtml(message)}</span>
        <button class="toast-close" onclick="this.parentElement.remove()" aria-label="Dismiss notification">&times;</button>
      `;

      container.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }
  </script>

  <!-- Help Overlay -->
  <div class="help-overlay" id="help-overlay" onclick="if(event.target === this) closeHelpOverlay()">
    <div class="help-modal">
      <div class="help-modal-header">
        <div class="help-modal-title">Keyboard Shortcuts</div>
        <button class="help-modal-close" onclick="closeHelpOverlay()" aria-label="Close help">&times;</button>
      </div>
      <div class="help-modal-body">
        <div class="help-section">
          <div class="help-section-title">Navigation</div>
          <div class="help-item">
            <span class="help-item-label">Open this help</span>
            <span class="help-item-key"><kbd>Ctrl</kbd><kbd>K</kbd></span>
          </div>
          <div class="help-item">
            <span class="help-item-label">Close modal/overlay</span>
            <span class="help-item-key"><kbd>Esc</kbd></span>
          </div>
        </div>
        <div class="help-section">
          <div class="help-section-title">Quick Tips</div>
          <div class="help-item">
            <span class="help-item-label">Drag & drop files to upload</span>
            <span class="help-item-key"></span>
          </div>
          <div class="help-item">
            <span class="help-item-label">Your progress is auto-saved</span>
            <span class="help-item-key"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
