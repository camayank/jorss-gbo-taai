<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TaxFlow">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  <title>TaxFlow - Smart Tax Filing</title>
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/static/icon-192.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ============ PROFESSIONAL COLOR SYSTEM ============
       Based on WCAG AAA standards (7:1 contrast ratio)
       Inspired by: Stripe, Linear, Apple HIG, Material Design 3
    ============================================== */
    :root {
      /* Primary Brand Colors - Professional Blue */
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --primary-active: #1e40af;
      --primary-light: #dbeafe;
      --primary-lighter: #eff6ff;

      /* Semantic Colors - Clear Visual Hierarchy */
      --success: #059669;
      --success-hover: #047857;
      --success-light: #d1fae5;
      --success-lighter: #ecfdf5;

      --warning: #d97706;
      --warning-hover: #b45309;
      --warning-light: #fef3c7;
      --warning-lighter: #fffbeb;

      --danger: #dc2626;
      --danger-hover: #b91c1c;
      --danger-light: #fee2e2;
      --danger-lighter: #fef2f2;

      --info: #0284c7;
      --info-light: #e0f2fe;

      /* Text Colors - Clear Hierarchy (WCAG AAA compliant) */
      --text-primary: #0f172a;      /* Headings, important text - 15.5:1 on white */
      --text-secondary: #1e293b;    /* Body text - 13.5:1 on white (enhanced) */
      --text-tertiary: #475569;     /* Secondary info - 7:1 on white (AAA) */
      --text-hint: #64748b;         /* Hints, placeholders - 4.5:1 on white (AA) */
      --text-muted: #94a3b8;        /* Disabled only - 3:1 (decorative) */
      --text-inverse: #ffffff;      /* Text on dark backgrounds */

      /* Background Colors - Clean & Professional */
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #f1f5f9;
      --bg-hover: #e2e8f0;
      --bg-active: #cbd5e1;

      /* Border Colors */
      --border-light: #e2e8f0;
      --border-default: #cbd5e1;
      --border-dark: #94a3b8;

      /* Special Purpose */
      --refund-green: #059669;
      --owed-red: #dc2626;

      /* Shadow System */
      --shadow-sm: 0 1px 2px rgba(15, 23, 42, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(15, 23, 42, 0.08), 0 2px 4px -1px rgba(15, 23, 42, 0.04);
      --shadow-lg: 0 10px 15px -3px rgba(15, 23, 42, 0.08), 0 4px 6px -2px rgba(15, 23, 42, 0.04);
      --shadow-xl: 0 20px 25px -5px rgba(15, 23, 42, 0.1), 0 10px 10px -5px rgba(15, 23, 42, 0.04);

      /* Legacy support - mapped to new system */
      --primary-dark: var(--primary-hover);
      --gray-50: var(--bg-secondary);
      --gray-100: var(--bg-tertiary);
      --gray-200: var(--border-light);
      --gray-300: var(--border-default);
      --gray-400: var(--text-hint);
      --gray-500: var(--text-tertiary);  /* Upgraded: now 7:1 contrast (was 4.5:1) */
      --gray-600: var(--text-tertiary);  /* All readable text now has 7:1+ contrast */
      --gray-700: var(--text-secondary);
      --gray-800: var(--text-primary);
      --gray-900: var(--text-primary);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    /* Global input styling for proper contrast */
    input, select, textarea {
      background: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border-default);
    }

    input::placeholder, textarea::placeholder {
      color: var(--text-hint);
    }

    /* Focus states - accessible focus ring */
    input:focus, select:focus, textarea:focus, button:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* ============ MOBILE-FIRST BASE STYLES ============ */
    html {
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #0ea5e9 100%);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      color: var(--text-primary);
      line-height: 1.5;
      /* Prevent pull-to-refresh on mobile */
      overscroll-behavior-y: contain;
      /* Safe area for notched phones */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    /* Touch-friendly tap targets (minimum 44px) */
    button, .btn, input[type="button"], input[type="submit"],
    .option-card, .nav-btn, .clickable {
      min-height: 44px;
      min-width: 44px;
    }

    /* Smooth touch scrolling */
    .scrollable {
      -webkit-overflow-scrolling: touch;
      overflow-y: auto;
    }

    /* Prevent text selection on interactive elements */
    button, .btn, .option-card, .step-dot {
      -webkit-user-select: none;
      user-select: none;
    }

    /* ============ LAYOUT ============ */
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px;
      padding-bottom: 80px; /* Space for bottom nav on mobile */
      min-height: 100vh;
      min-height: -webkit-fill-available;
      display: flex;
      flex-direction: column;
    }

    /* ============ HEADER ============ */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      margin-bottom: 20px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      color: white;
      font-weight: 700;
      font-size: 24px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn-header {
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-header:hover {
      background: rgba(255,255,255,0.25);
    }

    /* ============ MAIN CONTENT ============ */
    .main-content {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 24px;
      flex: 1;
    }

    @media (max-width: 900px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      .sidebar {
        order: -1;
      }
    }

    /* ============ PRIMARY CARD ============ */
    .primary-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* ============ PROGRESS BAR ============ */
    .progress-container {
      padding: 24px 24px 0;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-bottom: 8px;
    }

    .progress-steps::before {
      content: '';
      position: absolute;
      top: 14px;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gray-200);
      border-radius: 2px;
      z-index: 0;
    }

    .progress-fill {
      position: absolute;
      top: 14px;
      left: 0;
      height: 4px;
      background: var(--primary);
      border-radius: 2px;
      z-index: 1;
      transition: width 0.5s ease;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 2;
    }

    .step-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: white;
      border: 3px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-600);
      transition: all 0.3s;
    }

    .step.active .step-dot {
      border-color: var(--primary);
      color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
    }

    .step.completed .step-dot {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .step-label {
      margin-top: 8px;
      font-size: 12px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.85);
    }

    .step.active .step-label,
    .step.completed .step-label {
      color: white;
    }

    /* ============ STEP CONTENT ============ */
    .step-content {
      flex: 1;
      padding: 32px;
      display: flex;
      flex-direction: column;
    }

    .step-header {
      margin-bottom: 32px;
    }

    .step-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .step-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* ============ UPLOAD ZONE ============ */
    .upload-zone {
      border: 2px dashed var(--gray-300);
      border-radius: 16px;
      padding: 48px 32px;
      text-align: center;
      background: var(--gray-50);
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 24px;
    }

    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--primary);
      background: #f5f3ff;
    }

    .upload-zone.uploading {
      pointer-events: none;
      opacity: 0.7;
    }

    .upload-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .upload-icon svg {
      width: 32px;
      height: 32px;
      color: white;
    }

    .upload-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .upload-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .upload-formats {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .format-badge {
      background: white;
      border: 1px solid var(--border-light);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* ============ DOCUMENT LIST ============ */
    .documents-list {
      margin-bottom: 24px;
    }

    .document-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .document-card:hover {
      border-color: var(--primary);
    }

    .doc-icon {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      text-transform: uppercase;
    }

    .doc-icon.w2 { background: #dbeafe; color: #1d4ed8; }
    .doc-icon.int { background: #d1fae5; color: #059669; }
    .doc-icon.div { background: #fef3c7; color: #d97706; }
    .doc-icon.nec { background: #ede9fe; color: #7c3aed; }

    .doc-details {
      flex: 1;
    }

    .doc-type {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 15px;
    }

    .doc-meta {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }

    .doc-values {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .doc-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .doc-status.success { background: var(--success-light); color: var(--success); }
    .doc-status.applied { background: #ede9fe; color: #7c3aed; }
    .doc-status.pending { background: var(--warning-light); color: var(--warning); }

    .doc-actions {
      display: flex;
      gap: 8px;
    }

    .btn-apply {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-apply:hover {
      background: var(--primary-dark);
    }

    .btn-delete {
      background: transparent;
      color: var(--gray-600);
      border: none;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-delete:hover {
      background: var(--danger-light);
      color: var(--danger);
    }

    /* ============ QUESTION CARD ============ */
    .question-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    }

    .question-text {
      font-size: 18px;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 20px;
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .option-btn {
      background: white;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .option-btn:hover {
      border-color: var(--primary);
    }

    .option-btn.selected {
      border-color: var(--primary);
      background: #f5f3ff;
    }

    .option-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .option-label {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
    }

    /* ============ INPUT FIELDS ============ */
    .input-group {
      margin-bottom: 20px;
    }

    .input-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .input-field {
      width: 100%;
      padding: 14px 16px;
      font-size: 16px;
      border: 2px solid var(--border-light);
      border-radius: 12px;
      outline: none;
      transition: all 0.2s;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .input-field::placeholder {
      color: var(--text-hint);
    }

    .input-field:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }

    .input-hint {
      font-size: 13px;
      color: var(--text-tertiary);
      margin-top: 6px;
    }

    /* ============ CHAT INTERFACE ============ */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--gray-50);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 24px;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      max-height: 300px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      max-width: 85%;
      padding: 14px 18px;
      border-radius: 16px;
      line-height: 1.5;
      font-size: 14px;
    }

    .message.agent {
      align-self: flex-start;
      background: white;
      border: 1px solid var(--gray-200);
      border-bottom-left-radius: 4px;
    }

    .message.user {
      align-self: flex-end;
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.system {
      align-self: center;
      background: var(--warning-light);
      color: #92400e;
      font-size: 13px;
      border-radius: 8px;
    }

    .chat-input-area {
      display: flex;
      gap: 12px;
      padding: 16px;
      border-top: 1px solid var(--gray-200);
      background: white;
    }

    .chat-input {
      flex: 1;
      padding: 14px 18px;
      font-size: 15px;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      outline: none;
      transition: all 0.2s;
      background: white;
      color: var(--gray-900);
    }

    .chat-input::placeholder {
      color: var(--gray-500);
    }

    .chat-input:focus {
      border-color: var(--primary);
    }

    .btn-send {
      background: var(--primary);
      color: var(--text-inverse);
      border: none;
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: var(--shadow-sm);
    }

    .btn-send:hover {
      background: var(--primary-hover);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .btn-send:active {
      background: var(--primary-active);
      transform: translateY(0);
    }

    .btn-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ============ NAVIGATION BUTTONS ============ */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      padding-top: 24px;
      border-top: 1px solid var(--border-light);
    }

    .btn {
      padding: 14px 28px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .btn-secondary {
      background: var(--bg-primary);
      border: 2px solid var(--border-default);
      color: var(--text-secondary);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
      border-color: var(--border-dark);
    }

    .btn-primary {
      background: var(--primary);
      border: none;
      color: var(--text-inverse);
      box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .btn-primary:active {
      background: var(--primary-active);
      transform: translateY(0);
    }

    .btn-success {
      background: var(--success);
      border: none;
      color: var(--text-inverse);
      box-shadow: var(--shadow-sm);
    }

    .btn-success:hover {
      background: var(--success-hover);
      box-shadow: var(--shadow-md);
    }

    .btn-danger {
      background: var(--danger);
      border: none;
      color: var(--text-inverse);
    }

    .btn-danger:hover {
      background: var(--danger-hover);
    }

    /* ============ SIDEBAR ============ */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* ============ REFUND CARD ============ */
    .refund-card {
      background: var(--bg-primary);
      border-radius: 16px;
      padding: 28px;
      text-align: center;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
    }

    .refund-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .refund-amount {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 8px;
      line-height: 1;
    }

    .refund-amount.positive {
      color: var(--refund-green);
    }

    .refund-amount.negative {
      color: var(--owed-red);
    }

    .refund-amount.zero {
      color: var(--text-tertiary);
    }

    .refund-breakdown {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border-light);
    }

    .breakdown-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      font-size: 14px;
    }

    .breakdown-label {
      color: var(--text-secondary);
    }

    .breakdown-value {
      font-weight: 600;
      color: var(--gray-800);
    }

    .breakdown-value.positive { color: var(--refund-green); }
    .breakdown-value.negative { color: var(--owed-red); }

    /* ============ SMART INSIGHTS SIDEBAR ============ */
    .smart-insights-card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .insights-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .insights-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .insights-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .insights-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
    }

    .insights-badge {
      background: var(--success);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .insights-loading {
      text-align: center;
      padding: 20px;
      color: var(--gray-500);
    }

    .insights-loading .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .insights-empty {
      text-align: center;
      padding: 24px 16px;
      color: var(--gray-500);
    }

    .insights-empty-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    /* Enhanced Empty State */
    .insights-empty-enhanced {
      padding: 20px 16px;
    }

    .insights-empty-illustration {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-200) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .insights-empty-illustration::before {
      content: 'ðŸ’¡';
      font-size: 28px;
      animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes pulse-glow {
      0%, 100% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.1); opacity: 1; }
    }

    .insights-empty-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 8px;
    }

    .insights-empty-subtitle {
      font-size: 13px;
      color: var(--gray-500);
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .insights-empty-checklist {
      text-align: left;
      margin: 0 auto 20px;
      max-width: 200px;
    }

    .insights-empty-checklist-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 13px;
      color: var(--gray-600);
    }

    .insights-empty-checklist-item .check-icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--gray-400);
    }

    .insights-empty-checklist-item.completed .check-icon {
      background: var(--success);
      color: white;
    }

    .insights-get-started-btn {
      background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .insights-get-started-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    /* Sample Insight Preview */
    .sample-insight-container {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px dashed var(--gray-200);
    }

    .sample-insight-label {
      font-size: 11px;
      color: var(--gray-400);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .sample-insight-card {
      background: var(--gray-50);
      border-radius: 12px;
      padding: 14px;
      border-left: 4px solid var(--gray-300);
      opacity: 0.6;
      position: relative;
      overflow: hidden;
    }

    .sample-insight-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, transparent 60%, rgba(255,255,255,0.8) 100%);
      pointer-events: none;
    }

    .sample-insight-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 4px;
    }

    .sample-insight-desc {
      font-size: 12px;
      color: var(--gray-500);
    }

    .sample-insight-savings {
      margin-top: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--success);
      opacity: 0.7;
    }

    .insight-card {
      background: var(--gray-50);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border-left: 4px solid transparent;
      transition: all 0.2s ease;
    }

    .insight-card:last-child {
      margin-bottom: 0;
    }

    .insight-card.high-priority {
      border-left-color: var(--success);
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(255,255,255,0) 100%);
    }

    .insight-card.medium-priority {
      border-left-color: var(--warning);
      background: linear-gradient(135deg, rgba(234, 179, 8, 0.08) 0%, rgba(255,255,255,0) 100%);
    }

    .insight-card.low-priority {
      border-left-color: var(--primary);
    }

    .insight-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .insight-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .insight-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .insight-emoji {
      font-size: 20px;
    }

    .insight-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-900);
      line-height: 1.3;
    }

    .insight-savings {
      background: var(--success);
      color: white;
      font-size: 12px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 8px;
      white-space: nowrap;
    }

    .insight-description {
      font-size: 13px;
      color: var(--gray-600);
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .insight-actions {
      display: flex;
      gap: 8px;
    }

    .insight-btn {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .insight-btn-apply {
      background: var(--success);
      color: white;
    }

    .insight-btn-apply:hover {
      background: #16a34a;
      transform: translateY(-1px);
    }

    .insight-btn-dismiss {
      background: var(--gray-200);
      color: var(--gray-600);
    }

    .insight-btn-dismiss:hover {
      background: var(--gray-300);
    }

    .insight-applied {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px;
      background: rgba(34, 197, 94, 0.1);
      border-radius: 8px;
      color: var(--success);
      font-size: 12px;
      font-weight: 600;
    }

    /* ===== Visual Hierarchy - Tiered Insight Cards (Prompt 3) ===== */

    /* TOP OPPORTUNITY Tier - Highest savings */
    .insight-card.tier-top {
      border: 2px solid #f59e0b;
      border-left: 4px solid #f59e0b;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
      padding: 20px;
      position: relative;
      animation: pulseGlow 3s ease-in-out infinite;
    }

    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 4px 20px rgba(245, 158, 11, 0.15); }
      50% { box-shadow: 0 4px 25px rgba(245, 158, 11, 0.25); }
    }

    .insight-card.tier-top::before {
      content: 'â˜… TOP OPPORTUNITY';
      position: absolute;
      top: -10px;
      left: 16px;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 4px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .insight-card.tier-top .insight-title {
      font-size: 16px;
    }

    .insight-card.tier-top .insight-description {
      font-size: 14px;
    }

    /* HIGH Tier - >$1000 savings */
    .insight-card.tier-high {
      border-left: 4px solid var(--success);
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(255, 255, 255, 0) 100%);
    }

    /* MEDIUM Tier - $100-$1000 savings */
    .insight-card.tier-medium {
      padding: 12px 16px;
      border-left: 4px solid var(--primary);
    }

    .insight-card.tier-medium .insight-description {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .insight-card.tier-medium:hover .insight-description {
      -webkit-line-clamp: unset;
    }

    /* LOW Tier - <$100 savings */
    .insight-card.tier-low {
      padding: 10px 14px;
      border-left: 3px solid var(--gray-300);
      background: var(--gray-50);
    }

    .insight-card.tier-low .insight-description {
      display: none;
    }

    .insight-card.tier-low:hover .insight-description {
      display: block;
      font-size: 12px;
    }

    .insight-card.tier-low .insight-title {
      font-size: 13px;
    }

    .insight-card.tier-low .insight-actions {
      gap: 4px;
    }

    .insight-card.tier-low .insight-btn {
      padding: 6px 10px;
      font-size: 11px;
    }

    /* Savings Progress Bar */
    .insight-savings-bar {
      height: 6px;
      background: var(--gray-200);
      border-radius: 3px;
      margin: 8px 0 12px;
      overflow: hidden;
      position: relative;
    }

    .insight-savings-fill {
      height: 100%;
      border-radius: 3px;
      background: linear-gradient(90deg, var(--gray-400) 0%, var(--success) 100%);
      width: 0;
      transition: width 0.8s ease-out;
    }

    .insight-card.tier-top .insight-savings-fill {
      background: linear-gradient(90deg, #f59e0b 0%, #22c55e 100%);
    }

    .insight-savings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .insight-savings-amount {
      font-size: 18px;
      font-weight: 700;
      color: var(--success);
    }

    .insight-card.tier-top .insight-savings-amount {
      font-size: 22px;
      color: #d97706;
    }

    /* Total Potential Header */
    .insights-header-enhanced {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 12px;
      margin-bottom: 12px;
      border-bottom: 1px solid var(--gray-200);
    }

    .insights-header-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-800);
    }

    .insights-total-potential {
      background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
    }

    .insights-total-potential .amount {
      display: inline-block;
    }

    /* Count-up animation */
    @keyframes countUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .count-animate {
      animation: countUp 0.5s ease-out forwards;
    }

    /* Hover lift effect */
    .insight-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    .insight-card.tier-top:hover {
      box-shadow: 0 8px 24px rgba(245, 158, 11, 0.25);
    }

    .insights-total-savings {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .total-savings-label {
      font-size: 13px;
      color: var(--gray-600);
    }

    .total-savings-amount {
      font-size: 18px;
      font-weight: 700;
      color: var(--success);
    }

    /* Legacy tips styles for fallback */
    .tips-card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .tips-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    .tips-icon {
      width: 36px;
      height: 36px;
      background: var(--warning-light);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .tips-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
    }

    .tip-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--gray-100);
    }

    .tip-item:last-child {
      border-bottom: none;
    }

    .tip-icon {
      width: 24px;
      height: 24px;
      background: var(--success-light);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--success);
      flex-shrink: 0;
      margin-top: 2px;
    }

    .tip-text {
      font-size: 13px;
      color: var(--gray-600);
      line-height: 1.4;
    }

    .tip-savings {
      color: var(--success);
      font-weight: 600;
    }

    /* ============ TAX OPTIMIZER MODAL ============ */
    .tax-optimizer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .tax-optimizer-overlay.active {
      display: flex;
    }

    .tax-optimizer-modal {
      background: white;
      border-radius: 24px;
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .optimizer-header {
      padding: 24px 32px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .optimizer-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .optimizer-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .optimizer-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .optimizer-subtitle {
      font-size: 13px;
      color: var(--gray-500);
      margin-top: 2px;
    }

    .optimizer-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: var(--gray-100);
      color: var(--gray-600);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .optimizer-close:hover {
      background: var(--gray-200);
      color: var(--gray-900);
    }

    .optimizer-tabs {
      display: flex;
      gap: 4px;
      padding: 16px 32px;
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
    }

    .optimizer-tab {
      padding: 10px 20px;
      border-radius: 10px;
      border: none;
      background: transparent;
      color: var(--gray-600);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .optimizer-tab:hover {
      background: var(--gray-200);
    }

    .optimizer-tab.active {
      background: white;
      color: var(--primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .optimizer-tab-icon {
      font-size: 16px;
    }

    .optimizer-content {
      flex: 1;
      overflow-y: auto;
      padding: 32px;
    }

    .optimizer-panel {
      display: none;
    }

    .optimizer-panel.active {
      display: block;
    }

    /* ============ PROGRESSIVE DISCLOSURE (Prompt 2) ============ */
    .optimizer-recommendation-view {
      display: none;
    }

    .optimizer-recommendation-view.active {
      display: block;
    }

    .optimizer-tabs.hidden,
    .optimizer-content.hidden {
      display: none;
    }

    /* Recommendation Card */
    .recommendation-hero {
      text-align: center;
      padding: 20px 0 30px;
    }

    .recommendation-intro {
      font-size: 14px;
      color: var(--gray-600);
      margin-bottom: 20px;
    }

    .recommendation-card {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(34, 197, 94, 0.02) 100%);
      border: 2px solid var(--success);
      border-radius: 20px;
      padding: 28px;
      position: relative;
      max-width: 500px;
      margin: 0 auto;
    }

    .recommendation-badge {
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .recommendation-badge::before {
      content: 'ðŸ†';
    }

    .recommendation-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--gray-900);
      margin: 16px 0 8px;
    }

    .recommendation-savings {
      font-size: 36px;
      font-weight: 800;
      color: var(--success);
      margin: 12px 0;
    }

    .recommendation-savings-label {
      font-size: 13px;
      color: var(--gray-500);
      margin-bottom: 20px;
    }

    .recommendation-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
    }

    .recommendation-btn-primary {
      background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .recommendation-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
    }

    .recommendation-btn-secondary {
      background: white;
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .recommendation-btn-secondary:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    /* Other Opportunities List */
    .other-opportunities {
      margin-top: 30px;
      padding-top: 24px;
      border-top: 1px solid var(--gray-200);
    }

    .other-opportunities-title {
      font-size: 13px;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    .opportunity-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--gray-50);
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .opportunity-item:hover {
      background: var(--gray-100);
    }

    .opportunity-item-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .opportunity-icon {
      font-size: 20px;
    }

    .opportunity-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-800);
    }

    .opportunity-savings {
      font-size: 14px;
      font-weight: 600;
      color: var(--success);
    }

    .opportunity-check {
      color: var(--success);
      font-size: 16px;
    }

    /* Detail Expansion View */
    .detail-expansion-view {
      display: none;
      animation: slideInRight 0.3s ease;
    }

    .detail-expansion-view.active {
      display: block;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .detail-back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      color: var(--gray-600);
      font-size: 14px;
      cursor: pointer;
      padding: 8px 0;
      margin-bottom: 20px;
      transition: color 0.2s ease;
    }

    .detail-back-btn:hover {
      color: var(--gray-900);
    }

    .detail-comparison {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 20px;
      align-items: center;
      margin-bottom: 30px;
    }

    .detail-comparison-card {
      background: var(--gray-50);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
    }

    .detail-comparison-card.after {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.02) 100%);
      border: 2px solid var(--success);
    }

    .detail-comparison-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-500);
      margin-bottom: 16px;
    }

    .detail-comparison-amount {
      font-size: 28px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 8px;
    }

    .detail-comparison-card.after .detail-comparison-amount {
      color: var(--success);
    }

    .detail-comparison-breakdown {
      font-size: 13px;
      color: var(--gray-500);
    }

    .detail-arrow {
      font-size: 24px;
      color: var(--gray-400);
    }

    .detail-savings-banner {
      background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
      color: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      margin-bottom: 24px;
    }

    .detail-savings-amount {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .detail-savings-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .detail-apply-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .detail-apply-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
    }

    /* Simple/Advanced Toggle */
    .view-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .view-toggle-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .view-toggle-btn:hover {
      text-decoration: underline;
    }

    /* No Recommendations State */
    .no-recommendations {
      text-align: center;
      padding: 20px;
    }

    .no-rec-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .no-rec-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 8px;
    }

    .no-rec-subtitle {
      font-size: 14px;
      color: var(--gray-500);
      margin-bottom: 20px;
    }

    .no-other-opportunities {
      text-align: center;
      padding: 16px;
      color: var(--gray-500);
      font-size: 14px;
    }

    /* ===== Goal-Based Guided Flow (Prompt 4) ===== */
    .guided-flow-overlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      z-index: 100;
      padding: 40px;
      overflow-y: auto;
    }

    .guided-flow-overlay.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .guided-flow-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      color: var(--gray-400);
      cursor: pointer;
    }

    .guided-flow-close:hover {
      color: var(--gray-600);
    }

    .guided-flow-step {
      display: none;
      max-width: 500px;
      margin: 0 auto;
      text-align: center;
    }

    .guided-flow-step.active {
      display: block;
      animation: slideInUp 0.4s ease;
    }

    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .guided-flow-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 12px;
    }

    .guided-flow-subtitle {
      font-size: 16px;
      color: var(--gray-500);
      margin-bottom: 32px;
    }

    /* Goal Cards Grid */
    .goal-cards-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .goal-card {
      background: var(--gray-50);
      border: 2px solid var(--gray-200);
      border-radius: 16px;
      padding: 24px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .goal-card:hover {
      border-color: var(--primary);
      background: white;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15);
    }

    .goal-card-icon {
      font-size: 40px;
      margin-bottom: 12px;
    }

    .goal-card-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--gray-800);
    }

    .goal-card-desc {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    .guided-flow-skip {
      color: var(--gray-500);
      font-size: 14px;
      background: none;
      border: none;
      cursor: pointer;
      text-decoration: underline;
    }

    .guided-flow-skip:hover {
      color: var(--gray-700);
    }

    /* Questionnaire Step */
    .questionnaire-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .questionnaire-back {
      background: none;
      border: none;
      color: var(--gray-500);
      font-size: 20px;
      cursor: pointer;
    }

    .questionnaire-back:hover {
      color: var(--gray-700);
    }

    .questionnaire-progress {
      flex: 1;
      text-align: center;
    }

    .questionnaire-progress-dots {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 8px;
    }

    .progress-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--gray-300);
      transition: all 0.2s ease;
    }

    .progress-dot.active {
      background: var(--primary);
      transform: scale(1.2);
    }

    .progress-dot.completed {
      background: var(--success);
    }

    .questionnaire-question {
      text-align: left;
      margin-bottom: 24px;
    }

    .question-label {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 16px;
    }

    .question-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .question-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--gray-50);
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .question-option:hover {
      border-color: var(--primary);
    }

    .question-option.selected {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.05);
    }

    .question-option input[type="radio"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .question-option label {
      font-size: 14px;
      color: var(--gray-700);
      cursor: pointer;
      flex: 1;
    }

    .question-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.2s ease;
    }

    .question-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .questionnaire-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .questionnaire-btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .questionnaire-btn-primary {
      background: var(--primary);
      color: white;
      border: none;
    }

    .questionnaire-btn-primary:hover {
      background: #4f46e5;
      transform: translateY(-1px);
    }

    .questionnaire-btn-primary:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
    }

    /* Results Step */
    .results-celebration {
      font-size: 64px;
      margin-bottom: 20px;
      animation: bounce 0.6s ease;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .results-savings-card {
      background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
      color: white;
      border-radius: 20px;
      padding: 32px;
      margin: 24px 0;
    }

    .results-savings-amount {
      font-size: 48px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .results-savings-label {
      font-size: 16px;
      opacity: 0.9;
    }

    .results-opportunities {
      text-align: left;
      margin: 24px 0;
    }

    .results-opportunities-title {
      font-size: 14px;
      color: var(--gray-500);
      margin-bottom: 12px;
    }

    .results-opportunity-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--gray-50);
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .results-opportunity-rank {
      width: 24px;
      height: 24px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      margin-right: 12px;
    }

    .results-opportunity-name {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-800);
    }

    .results-opportunity-savings {
      font-size: 14px;
      font-weight: 600;
      color: var(--success);
    }

    .results-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .results-btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .results-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
    }

    .results-btn-secondary {
      background: none;
      border: none;
      color: var(--gray-600);
      font-size: 14px;
      cursor: pointer;
    }

    .results-btn-secondary:hover {
      color: var(--gray-800);
      text-decoration: underline;
    }

    .guided-flow-remember {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 20px;
      font-size: 13px;
      color: var(--gray-500);
    }

    .guided-flow-remember input {
      accent-color: var(--primary);
    }

    /* ===== Contextual Discoverability Triggers (Prompt 5) ===== */

    /* Inline Savings Alert */
    .inline-savings-alert {
      display: none;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      position: relative;
      animation: slideInUp 0.4s ease;
    }

    .inline-savings-alert.visible {
      display: block;
    }

    .inline-savings-alert-dismiss {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      color: var(--gray-400);
      font-size: 16px;
      cursor: pointer;
    }

    .inline-savings-alert-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .inline-savings-alert-icon {
      font-size: 24px;
    }

    .inline-savings-alert-text {
      flex: 1;
    }

    .inline-savings-alert-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 4px;
    }

    .inline-savings-alert-subtitle {
      font-size: 13px;
      color: var(--gray-600);
    }

    .inline-savings-alert-cta {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s ease;
    }

    .inline-savings-alert-cta:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    /* Floating Nudge */
    .floating-nudge {
      display: none;
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      padding: 16px;
      z-index: 100;
      animation: bounceIn 0.4s ease;
    }

    .floating-nudge.visible {
      display: block;
    }

    @keyframes bounceIn {
      0% { opacity: 0; transform: translateY(-10px) scale(0.95); }
      50% { transform: translateY(5px) scale(1.02); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .floating-nudge::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 24px;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid white;
    }

    .floating-nudge-icon {
      font-size: 20px;
      margin-bottom: 8px;
    }

    .floating-nudge-text {
      font-size: 14px;
      color: var(--gray-700);
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .floating-nudge-savings {
      font-weight: 700;
      color: var(--success);
    }

    .floating-nudge-actions {
      display: flex;
      gap: 8px;
    }

    .floating-nudge-btn {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .floating-nudge-btn-primary {
      background: var(--primary);
      color: white;
      border: none;
    }

    .floating-nudge-btn-primary:hover {
      background: #4f46e5;
    }

    .floating-nudge-btn-secondary {
      background: var(--gray-100);
      color: var(--gray-600);
      border: none;
    }

    .floating-nudge-btn-secondary:hover {
      background: var(--gray-200);
    }

    /* Pulsing Optimizer Button */
    .optimizer-btn-pulsing {
      position: relative;
    }

    .optimizer-btn-pulsing::after {
      content: '';
      position: absolute;
      top: -2px;
      right: -2px;
      width: 10px;
      height: 10px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse-ring 2s ease-out infinite;
    }

    @keyframes pulse-ring {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.5); opacity: 0.5; }
      100% { transform: scale(2); opacity: 0; }
    }

    .optimizer-savings-badge {
      position: absolute;
      top: -8px;
      right: -12px;
      background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 10px;
      white-space: nowrap;
      animation: badgeBounce 0.5s ease;
    }

    @keyframes badgeBounce {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    /* Review Screen Banner */
    .review-savings-banner {
      display: none;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #f59e0b;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 24px;
      animation: slideInDown 0.4s ease;
    }

    .review-savings-banner.visible {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    @keyframes slideInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .review-savings-banner-icon {
      font-size: 28px;
    }

    .review-savings-banner-content {
      flex: 1;
    }

    .review-savings-banner-title {
      font-size: 15px;
      font-weight: 700;
      color: #92400e;
      margin-bottom: 2px;
    }

    .review-savings-banner-subtitle {
      font-size: 13px;
      color: #a16207;
    }

    .review-savings-banner-cta {
      background: #f59e0b;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .review-savings-banner-cta:hover {
      background: #d97706;
      transform: translateY(-1px);
    }

    .review-savings-banner-dismiss {
      background: none;
      border: none;
      color: #a16207;
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
    }

    /* ===== Before/After Feedback Toast (Prompt 6) ===== */
    .feedback-toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
      padding: 20px;
      min-width: 340px;
      max-width: 400px;
      z-index: 10000;
      transform: translateX(120%);
      transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .feedback-toast.visible {
      transform: translateX(0);
    }

    .feedback-toast-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    .feedback-toast-icon {
      width: 32px;
      height: 32px;
      background: var(--success);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
    }

    .feedback-toast-title {
      flex: 1;
      font-size: 15px;
      font-weight: 600;
      color: var(--gray-800);
    }

    .feedback-toast-close {
      background: none;
      border: none;
      color: var(--gray-400);
      font-size: 20px;
      cursor: pointer;
    }

    .feedback-toast-comparison {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .feedback-toast-value {
      flex: 1;
      text-align: center;
      padding: 12px;
      border-radius: 10px;
    }

    .feedback-toast-value.before {
      background: var(--gray-100);
    }

    .feedback-toast-value.after {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid var(--success);
    }

    .feedback-toast-label {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--gray-500);
      margin-bottom: 4px;
    }

    .feedback-toast-amount {
      font-size: 18px;
      font-weight: 700;
    }

    .feedback-toast-value.after .feedback-toast-amount {
      color: var(--success);
    }

    .feedback-toast-arrow {
      color: var(--gray-400);
      font-size: 20px;
    }

    .feedback-toast-savings {
      background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
      color: white;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 16px;
    }

    .feedback-toast-savings-amount {
      font-size: 24px;
      font-weight: 800;
    }

    .feedback-toast-savings-label {
      font-size: 13px;
      opacity: 0.9;
    }

    .feedback-toast-actions {
      display: flex;
      gap: 8px;
    }

    .feedback-toast-btn {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .feedback-toast-btn-primary {
      background: var(--primary);
      color: white;
      border: none;
    }

    .feedback-toast-btn-secondary {
      background: none;
      border: 1px solid var(--gray-300);
      color: var(--gray-600);
    }

    /* ===== Savings Meter (Prompt 8) ===== */
    .savings-meter {
      margin-top: 20px;
      padding: 16px;
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
      border-radius: 12px;
    }

    .savings-meter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .savings-meter-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-700);
    }

    .savings-meter-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--success);
    }

    .savings-meter-bar {
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .savings-meter-fill {
      height: 100%;
      background: linear-gradient(90deg, #f59e0b 0%, var(--success) 100%);
      border-radius: 4px;
      transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .savings-meter-fill::after {
      content: '';
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 20px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3));
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .savings-meter-milestones {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 10px;
      color: var(--gray-500);
    }

    /* ===== Smart Nudge (Prompt 7) ===== */
    .smart-nudge {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(99, 102, 241, 0.02) 100%);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 10px;
      padding: 12px 14px;
      margin-top: 12px;
      display: none;
      animation: slideInUp 0.4s ease;
    }

    .smart-nudge.visible {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .smart-nudge-icon {
      font-size: 18px;
    }

    .smart-nudge-content {
      flex: 1;
    }

    .smart-nudge-text {
      font-size: 13px;
      color: var(--gray-700);
      line-height: 1.4;
    }

    .smart-nudge-action {
      background: var(--primary);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }

    .smart-nudge-dismiss {
      background: none;
      border: none;
      color: var(--gray-400);
      font-size: 16px;
      cursor: pointer;
      padding: 0;
    }

    /* ===== Micro-Interactions (Prompt 10) ===== */

    /* Button ripple effect */
    .btn-ripple {
      position: relative;
      overflow: hidden;
    }

    .btn-ripple::after {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    .btn-ripple:active::after {
      width: 200px;
      height: 200px;
      transition: width 0.3s ease, height 0.3s ease;
    }

    /* Input focus glow */
    input:focus, select:focus, textarea:focus {
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    /* Success state pulse */
    .success-pulse {
      animation: successPulse 0.6s ease;
    }

    @keyframes successPulse {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
      50% { box-shadow: 0 0 0 12px rgba(34, 197, 94, 0); }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }

    /* Number change animation */
    .number-change {
      display: inline-block;
      animation: numberBounce 0.4s ease;
    }

    @keyframes numberBounce {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); color: var(--success); }
      100% { transform: scale(1); }
    }

    /* Card hover effects enhancement */
    .insight-card, .goal-card, .option-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    /* Skeleton loading */
    .skeleton {
      background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
      background-size: 200% 100%;
      animation: skeletonWave 1.5s infinite;
      border-radius: 4px;
    }

    @keyframes skeletonWave {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Stagger animation for lists */
    .stagger-item {
      opacity: 0;
      transform: translateY(10px);
      animation: staggerIn 0.3s ease forwards;
    }

    @keyframes staggerIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Celebration confetti (for milestone) */
    .celebration-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      animation: confettiFall 3s ease-out forwards;
    }

    @keyframes confettiFall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    /* ===== Comparison Charts (Prompt 9) ===== */

    /* Chart Container */
    .chart-container {
      padding: 20px;
      background: var(--gray-50);
      border-radius: 12px;
      margin: 16px 0;
    }

    .chart-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 16px;
    }

    /* Horizontal Bar Chart */
    .h-bar-chart {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .h-bar-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .h-bar-label {
      width: 80px;
      font-size: 13px;
      color: var(--gray-600);
      text-align: right;
      flex-shrink: 0;
    }

    .h-bar-track {
      flex: 1;
      height: 28px;
      background: var(--gray-200);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .h-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, #8b5cf6 100%);
      border-radius: 6px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
    }

    .h-bar-fill.best {
      background: linear-gradient(90deg, var(--success) 0%, #16a34a 100%);
    }

    .h-bar-value {
      font-size: 12px;
      font-weight: 600;
      color: white;
    }

    .h-bar-savings {
      font-size: 11px;
      color: var(--success);
      margin-left: 8px;
      font-weight: 600;
    }

    /* Vertical Bar Chart */
    .v-bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 16px;
      height: 200px;
      padding: 20px 0;
      border-bottom: 2px solid var(--gray-200);
    }

    .v-bar-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
    }

    .v-bar-fill {
      width: 100%;
      max-width: 60px;
      background: linear-gradient(180deg, var(--primary) 0%, #8b5cf6 100%);
      border-radius: 6px 6px 0 0;
      transition: height 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .v-bar-fill.highlight {
      background: linear-gradient(180deg, var(--success) 0%, #16a34a 100%);
    }

    .v-bar-value {
      position: absolute;
      top: -24px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      font-weight: 600;
      color: var(--gray-700);
      white-space: nowrap;
    }

    .v-bar-label {
      margin-top: 8px;
      font-size: 11px;
      color: var(--gray-500);
      text-align: center;
    }

    /* Donut Chart */
    .donut-chart {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .donut-ring {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      position: relative;
    }

    .donut-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      background: white;
      width: 90px;
      height: 90px;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .donut-total {
      font-size: 20px;
      font-weight: 700;
      color: var(--gray-800);
    }

    .donut-label {
      font-size: 11px;
      color: var(--gray-500);
    }

    .donut-legend {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .donut-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--gray-700);
    }

    .donut-legend-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    /* Comparison Cards */
    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 16px;
      align-items: center;
    }

    .comparison-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 2px solid var(--gray-200);
    }

    .comparison-card.before {
      border-color: var(--gray-300);
    }

    .comparison-card.after {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, white 100%);
    }

    .comparison-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray-500);
      margin-bottom: 8px;
    }

    .comparison-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--gray-800);
    }

    .comparison-card.after .comparison-value {
      color: var(--success);
    }

    .comparison-arrow {
      font-size: 24px;
      color: var(--gray-400);
    }

    .comparison-diff {
      margin-top: 16px;
      padding: 12px;
      background: linear-gradient(135deg, var(--success) 0%, #16a34a 100%);
      color: white;
      border-radius: 8px;
      text-align: center;
    }

    .comparison-diff-amount {
      font-size: 20px;
      font-weight: 700;
    }

    .comparison-diff-label {
      font-size: 12px;
      opacity: 0.9;
    }

    /* What-If Scenarios Panel */
    .scenario-builder {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 768px) {
      .scenario-builder {
        grid-template-columns: 1fr;
      }
    }

    .scenario-section {
      background: var(--gray-50);
      border-radius: 16px;
      padding: 24px;
    }

    .scenario-section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .scenario-input-group {
      margin-bottom: 16px;
    }

    .scenario-label {
      font-size: 13px;
      color: var(--gray-600);
      margin-bottom: 6px;
      display: block;
    }

    .scenario-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--gray-300);
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.2s ease;
    }

    .scenario-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .scenario-select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--gray-300);
      border-radius: 10px;
      font-size: 15px;
      background: white;
      cursor: pointer;
    }

    .scenario-compare-btn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.2s ease;
    }

    .scenario-compare-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .scenario-results {
      margin-top: 24px;
    }

    .scenario-result-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 12px;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .scenario-result-card.winner {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, white 100%);
    }

    .scenario-result-card.winner::before {
      content: 'Best Option';
      position: absolute;
      top: -10px;
      right: 16px;
      background: var(--success);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 10px;
      border-radius: 6px;
    }

    .scenario-result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .scenario-result-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--gray-900);
    }

    .scenario-result-tax {
      font-size: 18px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .scenario-result-savings {
      color: var(--success);
      font-size: 14px;
      font-weight: 600;
    }

    .scenario-result-details {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .scenario-detail-item {
      text-align: center;
    }

    .scenario-detail-label {
      font-size: 11px;
      color: var(--gray-500);
      text-transform: uppercase;
    }

    .scenario-detail-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-800);
      margin-top: 2px;
    }

    /* Entity Comparison Panel */
    .entity-comparison {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 24px;
    }

    @media (max-width: 768px) {
      .entity-comparison {
        grid-template-columns: 1fr;
      }
    }

    .entity-inputs {
      background: var(--gray-50);
      border-radius: 16px;
      padding: 24px;
    }

    .entity-results {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .entity-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      border: 2px solid var(--gray-200);
      transition: all 0.2s ease;
      position: relative;
    }

    .entity-card.recommended {
      border-color: var(--success);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15);
    }

    .entity-card.recommended::before {
      content: 'Recommended';
      position: absolute;
      top: -10px;
      left: 24px;
      background: var(--success);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 6px;
    }

    .entity-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .entity-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .entity-icon.sole-prop { background: #fef3c7; }
    .entity-icon.s-corp { background: #dbeafe; }
    .entity-icon.llc { background: #f3e8ff; }

    .entity-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--gray-900);
    }

    .entity-tax-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--gray-100);
    }

    .entity-tax-row:last-child {
      border-bottom: none;
    }

    .entity-tax-label {
      font-size: 14px;
      color: var(--gray-600);
    }

    .entity-tax-value {
      font-size: 15px;
      font-weight: 600;
      color: var(--gray-900);
    }

    .entity-total {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 2px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .entity-total-label {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
    }

    .entity-total-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .entity-savings-badge {
      display: inline-block;
      background: var(--success);
      color: white;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 6px;
      margin-left: 8px;
    }

    /* Salary Slider */
    .salary-slider-container {
      margin-top: 24px;
      padding: 20px;
      background: linear-gradient(135deg, #eef2ff 0%, #faf5ff 100%);
      border-radius: 12px;
    }

    .salary-slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .salary-slider-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
    }

    .salary-slider-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }

    .salary-slider {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      background: linear-gradient(to right, var(--primary) 0%, var(--primary) 50%, #e5e7eb 50%, #e5e7eb 100%);
      border-radius: 4px;
      outline: none;
    }

    .salary-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      background: var(--primary);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
    }

    /* Retirement Planning Panel */
    .retirement-planning {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 768px) {
      .retirement-planning {
        grid-template-columns: 1fr;
      }
    }

    .retirement-account-card {
      background: var(--gray-50);
      border-radius: 16px;
      padding: 24px;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .retirement-account-card.has-contribution {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, white 100%);
    }

    .retirement-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .retirement-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .retirement-icon.type-401k { background: #dbeafe; }
    .retirement-icon.type-ira { background: #dcfce7; }
    .retirement-icon.type-hsa { background: #fce7f3; }
    .retirement-icon.type-sep { background: #fef3c7; }

    .retirement-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
    }

    .retirement-limit {
      font-size: 12px;
      color: var(--gray-500);
    }

    .retirement-input-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .retirement-input {
      flex: 1;
      padding: 14px 16px;
      border: 1px solid var(--gray-300);
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
    }

    .retirement-max-btn {
      padding: 14px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .retirement-progress {
      background: var(--gray-200);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .retirement-progress-bar {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .retirement-progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--gray-500);
    }

    .retirement-savings-preview {
      margin-top: 16px;
      padding: 12px 16px;
      background: rgba(34, 197, 94, 0.1);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .retirement-savings-label {
      font-size: 13px;
      color: var(--gray-600);
    }

    .retirement-savings-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--success);
    }

    .retirement-summary {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfeff 100%);
      border-radius: 16px;
      padding: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .retirement-summary-left h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 4px;
    }

    .retirement-summary-left p {
      font-size: 14px;
      color: var(--gray-600);
    }

    .retirement-summary-right {
      text-align: right;
    }

    .retirement-total-savings {
      font-size: 32px;
      font-weight: 700;
      color: var(--success);
    }

    .retirement-total-label {
      font-size: 13px;
      color: var(--gray-500);
    }

    /* ============ INFO CARD ============ */
    .info-card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .info-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    .info-icon {
      width: 36px;
      height: 36px;
      background: #dbeafe;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .info-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--gray-100);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-size: 13px;
      color: var(--text-tertiary);
    }

    .info-value {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* ============ LOADING SPINNER ============ */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ============ SUMMARY VIEW ============ */
    .summary-section {
      margin-bottom: 32px;
    }

    .summary-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .summary-item {
      background: var(--gray-50);
      padding: 16px;
      border-radius: 12px;
    }

    .summary-item-label {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-bottom: 4px;
      font-weight: 500;
    }

    .summary-item-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* ============ DEDUCTIONS STEP ============ */
    .deductions-container {
      max-height: 450px;
      overflow-y: auto;
      padding-right: 8px;
      margin-bottom: 24px;
    }

    .deductions-container::-webkit-scrollbar {
      width: 6px;
    }

    .deductions-container::-webkit-scrollbar-track {
      background: var(--gray-100);
      border-radius: 3px;
    }

    .deductions-container::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 3px;
    }

    .deduction-category {
      margin-bottom: 24px;
    }

    .category-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--gray-200);
    }

    .category-icon {
      font-size: 20px;
    }

    .category-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-800);
    }

    .question-card {
      background: var(--gray-50);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 10px;
    }

    .question-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .question-text {
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-700);
      flex: 1;
    }

    .toggle-buttons {
      display: flex;
      gap: 6px;
    }

    .toggle-btn {
      padding: 8px 16px;
      border: 2px solid var(--gray-200);
      background: white;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--gray-600);
    }

    .toggle-btn:hover {
      border-color: var(--primary);
    }

    .toggle-btn.selected {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .toggle-btn.selected-no {
      background: var(--gray-200);
      border-color: var(--gray-300);
      color: var(--gray-600);
    }

    .amount-input {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--gray-200);
    }

    .amount-input label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--gray-600);
      margin-bottom: 6px;
    }

    .amount-field {
      width: 100%;
      max-width: 200px;
      padding: 10px 14px;
      font-size: 15px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      outline: none;
      transition: all 0.2s;
    }

    .amount-field:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .input-hint {
      display: block;
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    /* Deduction Summary */
    .deduction-summary {
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .summary-comparison {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      margin-bottom: 16px;
    }

    .comparison-item {
      text-align: center;
      flex: 1;
      max-width: 150px;
    }

    .comparison-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--gray-600);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .comparison-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .comparison-vs {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-600);
      padding: 8px 12px;
      background: white;
      border-radius: 20px;
    }

    .recommendation {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      background: white;
      border-radius: 10px;
    }

    .rec-icon {
      font-size: 18px;
    }

    .rec-text {
      font-size: 13px;
      color: var(--gray-700);
    }

    .rec-text.better {
      color: var(--success);
      font-weight: 600;
    }

    @media (max-width: 600px) {
      .question-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .toggle-buttons {
        width: 100%;
      }

      .toggle-btn {
        flex: 1;
        text-align: center;
      }

      .summary-comparison {
        flex-direction: column;
        gap: 12px;
      }

      .comparison-vs {
        padding: 4px 12px;
      }
    }

    /* ============ WELCOME MODAL ============ */
    .welcome-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .welcome-content {
      background: white;
      border-radius: 24px;
      padding: 48px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    }

    .welcome-header { margin-bottom: 32px; }
    .welcome-icon { font-size: 64px; margin-bottom: 16px; }
    .welcome-header h1 { font-size: 28px; color: var(--text-primary); margin-bottom: 8px; font-weight: 700; }
    .welcome-header p { color: var(--text-secondary); font-size: 16px; }

    .welcome-options { display: flex; flex-direction: column; gap: 12px; }

    .welcome-option {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      border: 2px solid var(--border-light);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      background: var(--bg-primary);
    }

    .welcome-option:hover {
      border-color: var(--primary);
      background: var(--primary-lighter);
    }

    .wo-icon { font-size: 32px; }
    .wo-title { font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
    .wo-desc { font-size: 13px; color: var(--text-tertiary); }

    .welcome-footer { margin-top: 32px; }
    .secure-note { font-size: 13px; color: var(--text-tertiary); }

    /* Import Modal */
    .import-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }

    .import-content {
      background: white;
      border-radius: 20px;
      padding: 32px;
      max-width: 600px;
      width: 90%;
      position: relative;
    }

    .import-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray-600);
    }

    .import-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 24px 0;
    }

    .import-option {
      padding: 20px;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .import-option:hover {
      border-color: var(--primary);
      background: var(--primary-lighter);
    }

    .io-icon { font-size: 32px; margin-bottom: 8px; }
    .io-title { font-weight: 600; font-size: 14px; color: var(--text-primary); }
    .io-desc { font-size: 12px; color: var(--text-tertiary); margin-top: 4px; }

    /* ============ WIZARD STYLES ============ */
    .substep { animation: fadeIn 0.3s ease; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .wizard-card {
      background: var(--bg-primary);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
    }

    .wizard-progress {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 32px;
    }

    .wp-step {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-primary);
      border: 2px solid var(--border-default);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .wp-step.active {
      border-color: var(--primary);
      color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
    }

    .wp-step.completed {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .wp-line {
      width: 40px;
      height: 3px;
      background: var(--gray-300);
      border-radius: 2px;
    }

    .wp-line.filled { background: var(--primary); }

    .wizard-question {
      text-align: center;
      margin-bottom: 24px;
    }

    .wizard-question h3 {
      font-size: 22px;
      color: var(--gray-900);
      margin-bottom: 8px;
    }

    .wizard-hint {
      font-size: 14px;
      color: var(--text-tertiary);
    }

    .wizard-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .wizard-btn {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: white;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      position: relative;
    }

    .wizard-btn:hover {
      border-color: var(--primary);
      transform: translateX(4px);
    }

    .wizard-btn.selected {
      border-color: var(--primary);
      background: #f5f3ff;
    }

    .wizard-btn.recommended { border-color: var(--success); }

    .wb-icon { font-size: 28px; }
    .wb-text { font-size: 16px; font-weight: 600; color: var(--text-primary); }
    .wb-desc { font-size: 13px; color: var(--text-tertiary); margin-top: 4px; }
    .wb-badge {
      position: absolute;
      top: -8px;
      right: 12px;
      background: var(--success);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 12px;
    }

    .wizard-info {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      padding: 16px;
      background: #fef3c7;
      border-radius: 10px;
    }

    .wi-icon { font-size: 20px; }
    .wi-text { font-size: 13px; color: #92400e; line-height: 1.5; }

    .wizard-nav {
      display: flex;
      justify-content: space-between;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--gray-200);
    }

    /* ============ RESULT CARD ============ */
    .result-card { text-align: center; }

    .result-header {
      margin-bottom: 24px;
    }

    .result-icon { font-size: 48px; margin-bottom: 12px; }

    .result-recommendation {
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
      padding: 32px;
      border-radius: 16px;
      margin-bottom: 24px;
    }

    .rec-status { margin-bottom: 12px; }
    .rec-status .rec-icon { font-size: 48px; display: block; margin-bottom: 8px; }
    .rec-status .rec-name { font-size: 24px; font-weight: 700; color: var(--gray-900); }
    .rec-benefit { font-size: 16px; color: var(--gray-600); }

    .result-confirm { margin-top: 24px; }
    .result-confirm p { margin-bottom: 16px; color: var(--gray-600); }
    .confirm-buttons { display: flex; gap: 12px; justify-content: center; }

    .manual-status { margin-top: 24px; text-align: left; }
    .manual-status h4 { margin-bottom: 16px; }

    .status-options { display: flex; flex-direction: column; gap: 8px; }

    .status-option {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .status-option:hover { border-color: var(--primary); }
    .status-option.selected { border-color: var(--primary); background: #f5f3ff; }

    .so-icon { font-size: 24px; }
    .so-name { font-weight: 600; color: var(--gray-900); }
    .so-deduction { font-size: 13px; color: var(--text-tertiary); font-weight: 500; }

    /* ============ PERSONAL FORM ============ */
    .personal-form { text-align: left; }

    .pf-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .pf-field { display: flex; flex-direction: column; }
    .pf-field.full-width { grid-column: 1 / -1; }
    .pf-field label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
      display: block;
    }

    .pf-field input, .pf-field select {
      padding: 12px 14px;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      font-size: 15px;
      transition: all 0.2s;
    }

    .pf-field input:focus, .pf-field select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .field-hint { font-size: 12px; color: var(--text-tertiary); margin-top: 4px; }

    /* Calculated value display */
    .calculated-value {
      color: var(--success);
      font-weight: 500;
    }

    /* Info notice - auto-calculated message */
    .info-notice {
      background: var(--info-light);
      color: var(--info);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      margin: 12px 0;
      border-left: 3px solid var(--info);
    }

    /* Eligibility notice */
    .eligibility-notice {
      background: var(--success-lighter);
      color: var(--success);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      margin: 12px 0;
      border-left: 3px solid var(--success);
    }

    .eligibility-notice.warning {
      background: var(--warning-lighter);
      color: var(--warning);
      border-left-color: var(--warning);
    }

    /* Validation message */
    .validation-message {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 8px;
    }

    .validation-message.error {
      background: var(--danger-lighter);
      color: var(--danger);
    }

    .validation-message.warning {
      background: var(--warning-lighter);
      color: var(--warning);
    }

    .validation-message.info {
      background: var(--info-light);
      color: var(--info);
    }

    .pf-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--gray-200);
    }

    .pf-section-title { font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; }
    .pf-section-hint { font-size: 13px; color: var(--text-tertiary); margin-bottom: 16px; }

    /* Checkboxes */
    .checkbox-group { display: flex; flex-direction: column; gap: 12px; }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .checkbox-item:hover { border-color: var(--primary); }

    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: var(--primary);
    }

    .checkbox-label { flex: 1; font-size: 14px; color: var(--text-primary); font-weight: 500; }
    .checkbox-benefit { font-size: 12px; color: var(--success); font-weight: 600; }

    .spouse-fields { margin-top: 16px; }
    .spouse-fields h5 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; }

    /* ============ DEPENDENTS ============ */
    .add-dependent-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 16px;
      border: 2px dashed var(--gray-300);
      border-radius: 12px;
      background: transparent;
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 20px;
    }

    .add-dependent-btn:hover {
      border-color: var(--primary);
      background: #f5f3ff;
    }

    .dependent-form {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .df-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .df-title { font-weight: 600; color: var(--gray-800); }
    .df-remove { background: none; border: none; font-size: 24px; color: var(--gray-600); cursor: pointer; }

    .df-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .df-field label { font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; display: block; }
    .df-field input, .df-field select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 14px;
    }

    .df-qualifications {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--gray-100);
    }

    .qual-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .qual-item.eligible .qual-icon { color: var(--success); }
    .qual-item.eligible .qual-text { color: var(--success); }

    .dependents-summary {
      background: #d1fae5;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .ds-header { font-weight: 600; color: #065f46; margin-bottom: 12px; }
    .ds-row { display: flex; justify-content: space-between; padding: 6px 0; color: #065f46; }

    /* ============ CREDITS STEP ============ */
    .credits-container {
      max-height: 450px;
      overflow-y: auto;
      padding-right: 8px;
      margin-bottom: 24px;
    }

    .credit-category {
      margin-bottom: 24px;
    }

    .credit-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 12px;
    }

    .credit-card.auto-credit {
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
      border: none;
    }

    .credit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .credit-name { font-weight: 600; color: var(--gray-900); }
    .credit-amount { font-size: 20px; font-weight: 700; color: var(--success); }

    .credit-details {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
    }

    .credit-desc { color: var(--gray-600); }
    .credit-status { color: var(--primary); font-weight: 500; }

    .credit-form { margin-bottom: 16px; }
    .cf-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; }
    .cf-field { display: flex; flex-direction: column; }
    .cf-field label { font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; }

    .credit-estimate {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: #d1fae5;
      border-radius: 8px;
      font-size: 14px;
    }

    .ce-amount { font-weight: 700; color: var(--success); }
    .ce-note { font-size: 12px; color: var(--text-tertiary); }

    .credit-comparison { margin-top: 16px; }
    .cc-header { font-size: 13px; font-weight: 500; color: var(--gray-600); margin-bottom: 12px; }
    .cc-options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .cc-option {
      padding: 16px;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cc-option:hover { border-color: var(--primary); }
    .cc-option.recommended { border-color: var(--success); background: #f0fdf4; }

    .cc-name { font-weight: 600; font-size: 14px; color: var(--gray-800); }
    .cc-amount { font-size: 18px; font-weight: 700; color: var(--success); margin: 4px 0; }
    .cc-desc { font-size: 12px; color: var(--text-tertiary); }

    .eitc-table {
      margin-top: 16px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    .eitc-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      padding: 10px 16px;
      font-size: 13px;
      border-bottom: 1px solid var(--gray-100);
    }

    .eitc-row.header {
      background: var(--gray-100);
      font-weight: 600;
      color: var(--gray-700);
    }

    .credit-checklist { margin-bottom: 16px; }

    .credit-check-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .credit-check-item input { width: 18px; height: 18px; accent-color: var(--primary); }
    .item-credit { margin-left: auto; font-size: 12px; color: var(--success); font-weight: 500; }

    .saver-info {
      margin-top: 12px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      font-size: 13px;
    }

    .saver-info p { margin-bottom: 8px; font-weight: 500; }
    .saver-info ul { margin-left: 20px; color: var(--gray-600); }

    .credits-summary {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .cs-header { font-size: 16px; font-weight: 600; color: #065f46; margin-bottom: 16px; }

    .cs-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(6, 95, 70, 0.1);
    }

    .cs-name { color: #065f46; }
    .cs-value { font-weight: 600; color: #065f46; }

    .cs-total {
      display: flex;
      justify-content: space-between;
      padding-top: 12px;
      margin-top: 8px;
      font-size: 18px;
      font-weight: 700;
    }

    .cs-note {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
      font-size: 13px;
      color: #065f46;
    }

    /* ============ COMPREHENSIVE REVIEW STEP ============ */
    .review-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-700);
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: var(--gray-50);
      border-color: var(--primary);
      color: var(--primary);
    }

    .action-icon { font-size: 16px; }

    .action-btn-primary {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-color: #6366f1;
      color: white;
    }

    .action-btn-primary:hover {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      border-color: #4f46e5;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    /* Review Banner */
    .review-banner {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }

    .review-banner.owed {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .rb-main { flex: 1; }
    .rb-label { font-size: 14px; opacity: 0.9; margin-bottom: 8px; }
    .rb-amount { font-size: 48px; font-weight: 800; line-height: 1; }

    .rb-breakdown {
      margin-top: 12px;
      font-size: 14px;
      opacity: 0.9;
    }

    .rb-divider { margin: 0 12px; opacity: 0.5; }

    .rb-actions .btn-lg {
      padding: 16px 32px;
      font-size: 16px;
      background: white;
      color: #059669;
      border: none;
      font-weight: 600;
    }

    .review-banner.owed .rb-actions .btn-lg { color: #d97706; }

    /* Optimization Panel */
    .optimization-panel {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .op-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .op-icon { font-size: 24px; }
    .op-title { font-weight: 600; color: #92400e; flex: 1; }
    .op-potential {
      font-weight: 700;
      color: #059669;
      background: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
    }

    .op-recommendations { display: flex; flex-direction: column; gap: 12px; }

    .op-rec {
      background: white;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .opr-icon { font-size: 24px; }
    .opr-content { flex: 1; }
    .opr-title { font-weight: 600; color: var(--gray-800); margin-bottom: 4px; }
    .opr-desc { font-size: 13px; color: var(--gray-600); }
    .opr-savings {
      font-weight: 700;
      color: #059669;
      font-size: 16px;
      white-space: nowrap;
    }

    .opr-action {
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
    }

    /* Quick Optimizer Links */
    .op-quick-links {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(146, 64, 14, 0.15);
    }

    @media (max-width: 768px) {
      .op-quick-links {
        grid-template-columns: 1fr;
      }
    }

    .op-quick-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: white;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }

    .op-quick-link:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .oql-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .oql-content {
      flex: 1;
      min-width: 0;
    }

    .oql-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-900);
      display: block;
    }

    .oql-desc {
      font-size: 12px;
      color: var(--gray-500);
      display: block;
    }

    .oql-arrow {
      font-size: 16px;
      color: var(--gray-400);
      flex-shrink: 0;
      transition: transform 0.2s ease;
    }

    .op-quick-link:hover .oql-arrow {
      transform: translateX(4px);
      color: var(--primary);
    }

    /* Computation Panel */
    .computation-panel {
      background: white;
      border-radius: 16px;
      border: 1px solid var(--gray-200);
      overflow: hidden;
      margin-bottom: 24px;
    }

    .cp-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    .cp-header h3 { font-size: 18px; font-weight: 600; color: var(--gray-900); margin: 0; }
    .cp-badge {
      background: var(--primary);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    /* Computation Sections */
    .cp-section { border-bottom: 1px solid var(--gray-100); }

    .cps-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 24px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .cps-header:hover { background: var(--gray-50); }
    .cps-icon { font-size: 20px; }
    .cps-title { flex: 1; font-weight: 500; color: var(--gray-800); }
    .cps-amount { font-weight: 700; font-size: 16px; color: var(--gray-900); }
    .cps-amount.negative { color: #dc2626; }
    .cps-toggle { color: var(--gray-600); transition: transform 0.2s; }
    .cps-header.collapsed .cps-toggle { transform: rotate(-90deg); }

    .cps-details {
      padding: 0 24px 20px 56px;
      background: var(--gray-50);
    }

    .cpd-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 14px;
      border-bottom: 1px solid var(--gray-100);
    }

    .cpd-row:last-child { border-bottom: none; }
    .cpd-label { color: var(--text-secondary); }
    .cpd-value { font-weight: 600; color: var(--text-primary); }
    .cpd-row.total { font-weight: 600; padding-top: 12px; margin-top: 8px; border-top: 2px solid var(--border-default); }
    .cpd-row.total .cpd-label, .cpd-row.total .cpd-value { color: var(--text-primary); font-weight: 700; }

    /* AGI Line */
    .cp-agi, .cp-taxable, .cp-final-tax {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px 24px;
      background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
    }

    .agi-label, .taxable-label, .ft-label {
      font-weight: 700;
      color: var(--primary);
      flex: 1;
    }
    .agi-amount, .taxable-amount, .ft-amount {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary);
    }
    .agi-note, .taxable-note {
      font-size: 12px;
      color: var(--text-secondary);
      background: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 500;
    }

    .cp-final-tax {
      background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
    }
    .cp-final-tax .ft-label, .cp-final-tax .ft-amount { color: #dc2626; }

    /* Deduction Comparison */
    .cpd-comparison {
      display: flex;
      gap: 20px;
      align-items: stretch;
      margin-bottom: 16px;
    }

    .cpd-option {
      flex: 1;
      background: white;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s;
    }

    .cpd-option.selected {
      border-color: var(--success);
      background: #f0fdf4;
    }

    .cpd-opt-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .cpd-opt-icon { font-size: 18px; }
    .cpd-opt-name { font-weight: 600; font-size: 14px; flex: 1; }
    .cpd-opt-badge {
      background: var(--success);
      color: white;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }

    .cpd-opt-amount {
      font-size: 28px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 12px;
    }

    .cpd-opt-breakdown { font-size: 13px; }
    .cpd-opt-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      color: var(--gray-600);
    }

    .cpd-vs {
      display: flex;
      align-items: center;
      font-weight: 700;
      color: var(--gray-600);
      font-size: 14px;
    }

    .cpd-recommendation {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #d1fae5;
      padding: 12px 16px;
      border-radius: 8px;
    }

    .rec-icon { font-size: 20px; }
    .rec-text { flex: 1; font-size: 14px; color: #065f46; font-weight: 500; }
    .rec-savings { font-weight: 700; color: #059669; }

    .warning-text { color: #d97706; font-size: 12px; }

    /* Tax Brackets */
    .cpd-brackets { margin-bottom: 16px; }
    .bracket-header {
      font-weight: 600;
      font-size: 14px;
      color: var(--gray-700);
      margin-bottom: 12px;
    }

    .bracket-row {
      display: grid;
      grid-template-columns: 80px 1fr 100px 80px;
      gap: 12px;
      padding: 8px 12px;
      font-size: 13px;
      background: white;
      border-radius: 6px;
      margin-bottom: 4px;
      align-items: center;
    }

    .bracket-rate {
      font-weight: 700;
      color: var(--primary);
    }

    .bracket-bar-container {
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
    }

    .bracket-bar {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
    }

    .bracket-income { color: var(--gray-600); text-align: right; }
    .bracket-tax { font-weight: 600; text-align: right; }

    /* Refundable Note */
    .cpd-refundable-note {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: #dbeafe;
      border-radius: 8px;
      font-size: 13px;
      color: #1e40af;
      margin-top: 12px;
    }

    /* Final Result */
    .cp-result {
      padding: 24px;
    }

    .cpr-box {
      text-align: center;
      padding: 32px;
      border-radius: 16px;
    }

    .cpr-box.refund {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    }

    .cpr-box.owed {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    }

    .cpr-label { font-size: 16px; color: #065f46; font-weight: 500; }
    .cpr-box.owed .cpr-label { color: #991b1b; }

    .cpr-amount {
      font-size: 48px;
      font-weight: 800;
      color: #059669;
      margin: 12px 0;
    }

    .cpr-box.owed .cpr-amount { color: #dc2626; }
    .cpr-explanation { font-size: 14px; color: #065f46; }
    .cpr-box.owed .cpr-explanation { color: #991b1b; }

    /* State Tax Panel */
    .state-panel { margin-bottom: 24px; }
    .state-panel .cp-header { background: #dbeafe; }
    .state-panel .cp-header h3 { color: #1e40af; }
    .state-panel .cp-badge { background: #1e40af; }

    .cp-state-summary { padding: 20px 24px; }

    .state-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      font-size: 15px;
      border-bottom: 1px solid var(--gray-100);
    }

    .state-row:last-child { border-bottom: none; }
    .state-row.result {
      font-weight: 700;
      font-size: 18px;
      color: #059669;
      padding-top: 16px;
      margin-top: 8px;
      border-top: 2px solid var(--gray-200);
    }

    /* Comparison Modals */
    .comparison-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-content.wide { max-width: 900px; }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
    }

    .modal-header h3 { font-size: 18px; font-weight: 600; margin: 0; }
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--gray-600);
      cursor: pointer;
      line-height: 1;
    }

    .modal-body { padding: 24px; }
    .modal-intro { color: var(--gray-600); margin-bottom: 20px; }

    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding: 16px 24px;
      border-top: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    /* Filing Comparison Grid */
    .comparison-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .comparison-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .comparison-card:hover { border-color: var(--primary); }
    .comparison-card.selected { border-color: var(--success); background: #f0fdf4; }
    .comparison-card.current { border-color: var(--primary); background: #f5f3ff; }
    .comparison-card.disabled { opacity: 0.5; cursor: not-allowed; }

    .cc-icon { font-size: 24px; }
    .cc-info { flex: 1; }
    .cc-name { font-weight: 600; color: var(--text-primary); }
    .cc-deduction { font-size: 13px; color: var(--text-tertiary); }

    .cc-result { text-align: right; }
    .cc-tax { font-weight: 700; font-size: 18px; color: var(--text-primary); }
    .cc-diff { font-size: 13px; font-weight: 600; }
    .cc-diff.savings { color: var(--success); }
    .cc-diff.costs { color: #dc2626; }

    .cc-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .cc-badge.current { background: var(--primary); color: white; }
    .cc-badge.best { background: var(--success); color: white; }
    .cc-badge.disabled { background: var(--gray-200); color: var(--gray-500); }

    .comparison-note {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      background: #fef3c7;
      border-radius: 8px;
      font-size: 13px;
      color: #92400e;
      margin-top: 16px;
    }

    /* State Comparison Grid */
    .state-comparison-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
    }

    .state-card {
      padding: 16px;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      text-align: center;
    }

    .state-card.current {
      border-color: var(--primary);
      background: #f5f3ff;
    }

    .state-card.no-tax {
      background: #d1fae5;
      border-color: var(--success);
    }

    .sc-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
    .sc-tax { font-size: 20px; font-weight: 700; color: var(--gray-800); }
    .sc-diff { font-size: 12px; font-weight: 600; margin-top: 4px; }
    .sc-diff.savings { color: var(--success); }
    .sc-diff.costs { color: #dc2626; }

    .comparison-insight {
      margin-top: 20px;
      padding: 16px;
      background: var(--gray-50);
      border-radius: 12px;
    }

    .insight-header { font-weight: 600; margin-bottom: 8px; }
    .insight-text { font-size: 14px; color: var(--gray-600); }

    /* Button Variations */
    .btn-lg {
      padding: 14px 28px;
      font-size: 16px;
    }

    .btn-icon { margin-right: 8px; }

    /* Print Styles */
    @media print {
      .review-actions, .rb-actions, .nav-buttons, .optimization-panel,
      .comparison-modal, .action-btn { display: none !important; }
      .computation-panel { break-inside: avoid; }
      .review-banner { background: #f0fdf4 !important; color: #065f46 !important; }
    }

    /* ============ UTILITIES ============ */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mt-4 { margin-top: 16px; }
    .mb-4 { margin-bottom: 16px; }

    /* ============ MOBILE-FIRST RESPONSIVE ============ */

    /* Mobile Bottom Navigation */
    .mobile-bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-primary);
      border-top: 1px solid var(--border-light);
      padding: 8px 0;
      padding-bottom: calc(8px + env(safe-area-inset-bottom));
      z-index: 1000;
      box-shadow: 0 -4px 20px rgba(15, 23, 42, 0.08);
    }

    .mobile-bottom-nav .nav-items {
      display: flex;
      justify-content: space-around;
      align-items: center;
    }

    .mobile-bottom-nav .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 16px;
      border-radius: 12px;
      color: var(--text-tertiary);
      text-decoration: none;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.15s ease;
      cursor: pointer;
    }

    .mobile-bottom-nav .nav-item:hover {
      color: var(--text-secondary);
      background: var(--bg-secondary);
    }

    .mobile-bottom-nav .nav-item.active {
      color: var(--primary);
      background: var(--primary-lighter);
    }

    .mobile-bottom-nav .nav-item .nav-icon {
      font-size: 22px;
    }

    /* Mobile Action Button (FAB) */
    .mobile-fab {
      display: none;
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
      font-size: 24px;
      cursor: pointer;
      z-index: 999;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .mobile-fab:active {
      transform: scale(0.95);
    }

    /* Mobile Step Progress Bar */
    .mobile-progress {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: rgba(255,255,255,0.3);
      z-index: 1001;
    }

    .mobile-progress-bar {
      height: 100%;
      background: white;
      transition: width 0.3s ease;
    }

    /* Swipe Indicator */
    .swipe-indicator {
      display: none;
      text-align: center;
      padding: 12px;
      color: var(--gray-600);
      font-size: 12px;
    }

    /* ============ TABLET (768px and below) ============ */
    @media (max-width: 768px) {
      .app-container {
        padding: 10px;
        padding-bottom: 90px;
      }

      .header {
        padding: 12px 0;
        margin-bottom: 12px;
      }

      .logo {
        font-size: 20px;
      }

      .logo-icon {
        width: 36px;
        height: 36px;
      }

      .header-actions {
        gap: 8px;
      }

      .btn-header {
        padding: 8px 14px;
        font-size: 13px;
      }

      .main-content {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .sidebar {
        order: -1;
      }

      .card {
        border-radius: 16px;
        padding: 20px;
      }

      .step-title {
        font-size: 24px;
      }

      .refund-amount {
        font-size: 42px;
      }
    }

    /* ============ MOBILE (600px and below) ============ */
    @media (max-width: 600px) {
      /* Show mobile navigation */
      .mobile-bottom-nav {
        display: block;
      }

      .mobile-progress {
        display: block;
      }

      .swipe-indicator {
        display: block;
      }

      /* Hide desktop elements */
      .header-actions {
        display: none;
      }

      .step-progress {
        display: none;
      }

      /* App container */
      .app-container {
        padding: 8px;
        padding-bottom: 100px;
      }

      /* Header adjustments */
      .header {
        padding: 10px 4px;
        margin-bottom: 8px;
      }

      .logo {
        font-size: 18px;
        gap: 8px;
      }

      .logo-icon {
        width: 32px;
        height: 32px;
        font-size: 16px;
      }

      /* Cards */
      .card {
        border-radius: 20px;
        padding: 16px;
        margin-bottom: 12px;
      }

      /* Typography */
      .step-title {
        font-size: 20px;
        line-height: 1.3;
      }

      .step-subtitle {
        font-size: 14px;
      }

      .refund-amount {
        font-size: 36px;
      }

      .refund-label {
        font-size: 12px;
      }

      /* Options grid - single column on mobile */
      .options-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .option-card {
        padding: 16px;
        min-height: 60px;
      }

      .option-icon {
        font-size: 28px;
      }

      .option-title {
        font-size: 15px;
      }

      .option-desc {
        font-size: 12px;
      }

      /* Form inputs - larger for touch */
      .form-input, .form-select, input[type="text"],
      input[type="number"], input[type="date"], select {
        font-size: 16px !important; /* Prevents iOS zoom */
        padding: 14px 16px;
        border-radius: 12px;
        min-height: 50px;
      }

      .form-label {
        font-size: 13px;
        margin-bottom: 6px;
      }

      .form-group {
        margin-bottom: 16px;
      }

      /* Buttons - larger touch targets */
      .btn, button {
        padding: 14px 20px;
        font-size: 15px;
        border-radius: 12px;
        min-height: 50px;
      }

      .btn-primary {
        width: 100%;
      }

      .nav-buttons {
        flex-direction: column;
        gap: 10px;
      }

      .nav-buttons .btn {
        width: 100%;
      }

      /* Breakdown rows */
      .breakdown-row {
        padding: 12px 0;
        font-size: 13px;
      }

      .breakdown-label {
        flex: 1;
      }

      /* Tax brackets - horizontal scroll on mobile */
      .bracket-breakdown {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -16px;
        padding: 0 16px;
      }

      .bracket-row {
        min-width: max-content;
      }

      /* Wizard flow */
      .wizard-options {
        gap: 10px;
      }

      .wizard-option {
        padding: 16px;
        font-size: 14px;
      }

      /* Question rows stack vertically */
      .question-row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .question-label {
        font-size: 14px;
      }

      /* Summary sections */
      .summary-section {
        padding: 14px;
        border-radius: 14px;
      }

      .summary-title {
        font-size: 14px;
      }

      .summary-value {
        font-size: 18px;
      }

      /* Modals - full screen on mobile */
      .modal-content {
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
        border-radius: 0;
        margin: 0;
      }

      .modal-header {
        padding: 16px;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
      }

      .modal-body {
        padding: 16px;
        padding-bottom: 100px;
      }

      /* Toast on mobile */
      .toast-notification {
        bottom: 100px;
        left: 12px;
        right: 12px;
        max-width: none;
      }

      /* Recommendations on mobile */
      .recommendation-card {
        padding: 12px;
      }

      .rec-header h5 {
        font-size: 13px;
      }

      .recommendation-card p {
        font-size: 12px;
      }

      /* Hide non-essential on mobile */
      .desktop-only {
        display: none !important;
      }
    }

    /* ============ SMALL MOBILE (375px and below) ============ */
    @media (max-width: 375px) {
      .app-container {
        padding: 6px;
      }

      .card {
        padding: 14px;
        border-radius: 16px;
      }

      .step-title {
        font-size: 18px;
      }

      .refund-amount {
        font-size: 32px;
      }

      .btn {
        padding: 12px 16px;
        font-size: 14px;
      }

      .option-card {
        padding: 14px;
      }

      .mobile-bottom-nav .nav-item {
        padding: 6px 12px;
        font-size: 10px;
      }

      .mobile-bottom-nav .nav-item .nav-icon {
        font-size: 20px;
      }
    }

    /* ============ LANDSCAPE MOBILE ============ */
    @media (max-height: 500px) and (orientation: landscape) {
      .mobile-bottom-nav {
        padding: 4px 0;
      }

      .mobile-bottom-nav .nav-item {
        flex-direction: row;
        gap: 8px;
      }

      .mobile-bottom-nav .nav-item .nav-icon {
        font-size: 18px;
      }

      .card {
        padding: 12px;
      }

      .refund-amount {
        font-size: 28px;
      }
    }

    /* ============ TOUCH INTERACTIONS ============ */
    @media (hover: none) and (pointer: coarse) {
      /* Touch device specific styles */
      .btn:hover, .option-card:hover {
        /* Disable hover effects on touch devices */
        transform: none;
        box-shadow: none;
      }

      .btn:active, .option-card:active {
        transform: scale(0.98);
        opacity: 0.9;
      }

      /* Larger touch targets */
      .clickable-row {
        min-height: 48px;
        padding: 12px;
      }

      /* Remove hover tooltips */
      [title]:hover::after {
        display: none;
      }
    }

    /* ============ DARK MODE SUPPORT ============ */
    @media (prefers-color-scheme: dark) {
      :root {
        --gray-50: #1f2937;
        --gray-100: #374151;
        --gray-200: #4b5563;
        --gray-800: #f9fafb;
        --gray-700: #e5e7eb;
      }

      .card {
        background: #1f2937;
        color: #f9fafb;
      }

      .mobile-bottom-nav {
        background: #111827;
        border-top-color: #374151;
      }
    }

    /* ============ REDUCED MOTION ============ */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ============ LARGE DESKTOP (1400px+) ============ */
    @media (min-width: 1400px) {
      .app-container {
        max-width: 1400px;
        padding: 24px;
      }

      .main-content {
        grid-template-columns: 1fr 420px;
        gap: 32px;
      }

      .card {
        padding: 32px;
      }

      .step-title {
        font-size: 32px;
      }

      .refund-amount {
        font-size: 56px;
      }

      .wizard-card {
        padding: 40px;
      }

      .pf-row {
        grid-template-columns: repeat(3, 1fr);
      }

      .summary-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    /* ============ 4K / ULTRA-WIDE (1920px+) ============ */
    @media (min-width: 1920px) {
      .app-container {
        max-width: 1600px;
      }

      .main-content {
        grid-template-columns: 1fr 480px;
      }

      body {
        font-size: 18px;
      }

      .step-title {
        font-size: 36px;
      }

      .pf-field label {
        font-size: 15px;
      }

      .pf-field input, .pf-field select {
        padding: 16px 18px;
        font-size: 16px;
      }
    }

    /* ============ TABLET LANDSCAPE (1024px - 1200px) ============ */
    @media (min-width: 768px) and (max-width: 1200px) {
      .main-content {
        grid-template-columns: 1fr 320px;
        gap: 20px;
      }

      .pf-row {
        grid-template-columns: repeat(2, 1fr);
      }

      .wizard-card {
        padding: 24px;
      }

      .summary-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .cc-options {
        grid-template-columns: 1fr;
      }
    }

    /* ============ FORM GRID RESPONSIVE ============ */
    @media (max-width: 600px) {
      .pf-row {
        grid-template-columns: 1fr !important;
        gap: 16px;
      }

      .pf-field.half {
        grid-column: span 1;
      }

      .df-grid {
        grid-template-columns: 1fr !important;
      }

      .cf-row {
        grid-template-columns: 1fr !important;
      }

      /* Credit comparison single column */
      .cc-options {
        grid-template-columns: 1fr !important;
      }

      /* Calculation preview sections */
      .cps-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .cp-agi, .cp-taxable, .cp-final-tax {
        flex-direction: column;
        text-align: center;
        gap: 8px;
      }

      .agi-amount, .taxable-amount, .ft-amount {
        font-size: 20px;
      }

      /* Welcome modal on mobile */
      .welcome-option {
        flex-direction: column;
        text-align: center;
        padding: 16px;
      }

      .wo-icon {
        font-size: 28px;
      }

      /* Import options */
      .import-options {
        grid-template-columns: 1fr !important;
      }
    }

    /* ============ IPAD SPECIFIC (768px - 1024px) ============ */
    @media (min-width: 768px) and (max-width: 1024px) {
      .app-container {
        padding: 16px;
      }

      .wizard-card {
        padding: 28px;
      }

      .pf-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }

      .checkbox-group {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .refund-amount {
        font-size: 44px;
      }
    }

    /* ============ FOLDABLE DEVICES ============ */
    @media (min-width: 280px) and (max-width: 320px) {
      .app-container {
        padding: 4px;
      }

      .card {
        padding: 12px;
        border-radius: 12px;
      }

      .step-title {
        font-size: 16px;
      }

      .refund-amount {
        font-size: 28px;
      }

      .mobile-bottom-nav .nav-item span:not(.nav-icon) {
        display: none;
      }

      .pf-field label {
        font-size: 11px;
      }

      .btn {
        padding: 10px 12px;
        font-size: 13px;
      }
    }

    /* ============ HIGH DPI / RETINA DISPLAYS ============ */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .card {
        border: 0.5px solid var(--border-light);
      }

      input, select, textarea {
        border-width: 0.5px;
      }
    }

    /* ============ PRINT STYLES ENHANCEMENT ============ */
    @media print {
      .mobile-bottom-nav,
      .header-actions,
      .btn-header,
      .toast-notification,
      .swipe-indicator {
        display: none !important;
      }

      .app-container {
        padding: 0;
        max-width: 100%;
      }

      .card {
        box-shadow: none;
        border: 1px solid #ddd;
        page-break-inside: avoid;
      }

      .refund-amount {
        color: #000 !important;
      }
    }

    /* ============ VALIDATION & ERROR STYLES ============ */
    .input-error {
      border-color: var(--danger) !important;
      background: var(--danger-light) !important;
    }

    .input-error:focus {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
    }

    .field-error-message {
      color: var(--danger);
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }

    /* Toast Notifications */
    .toast-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 400px;
    }

    .toast-notification.toast-visible {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-content {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }

    .toast-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }

    .toast-success .toast-icon { background: var(--success-light); color: var(--success); }
    .toast-error .toast-icon { background: var(--danger-light); color: var(--danger); }
    .toast-warning .toast-icon { background: var(--warning-light); color: var(--warning); }
    .toast-info .toast-icon { background: #dbeafe; color: #3b82f6; }

    .toast-message {
      font-size: 14px;
      color: var(--gray-700);
      line-height: 1.4;
    }

    .toast-close {
      background: none;
      border: none;
      font-size: 20px;
      color: var(--gray-600);
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .toast-close:hover {
      color: var(--gray-600);
    }

    /* Recommendations Styles */
    .recommendations-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .recommendations-header h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-800);
    }

    .savings-badge {
      background: var(--success-light);
      color: var(--success);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .recommendations-summary {
      font-size: 14px;
      color: var(--gray-600);
      margin-bottom: 16px;
    }

    .recommendations-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .recommendation-card {
      background: var(--gray-50);
      border-radius: 10px;
      padding: 14px;
      border-left: 4px solid var(--gray-300);
    }

    .recommendation-card.priority-high {
      border-left-color: var(--danger);
      background: var(--danger-light);
    }

    .recommendation-card.priority-medium {
      border-left-color: var(--warning);
      background: var(--warning-light);
    }

    .recommendation-card.priority-low {
      border-left-color: var(--success);
      background: var(--success-light);
    }

    .rec-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .rec-priority {
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(0,0,0,0.1);
    }

    .rec-header h5 {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-800);
    }

    .recommendation-card p {
      font-size: 13px;
      color: var(--gray-600);
      line-height: 1.5;
    }

    .rec-savings {
      display: inline-block;
      margin-top: 8px;
      font-size: 12px;
      font-weight: 600;
      color: var(--success);
    }

    .btn-see-all {
      margin-top: 12px;
      background: none;
      border: 1px solid var(--gray-300);
      color: var(--gray-600);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      width: 100%;
    }

    .btn-see-all:hover {
      background: var(--gray-100);
    }

    /* Progress Bar */
    .progress-container {
      background: var(--gray-200);
      border-radius: 8px;
      height: 8px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    #progressBar {
      height: 100%;
      background: var(--primary);
      border-radius: 8px;
      transition: width 0.3s ease;
    }

    #progressText {
      font-size: 12px;
      color: var(--gray-500);
    }

    .next-step-highlight {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
      50% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
    }

    /* ============ ALPINE.JS + HTMX INTEGRATION ============ */
    /* Dynamic field visibility */
    [x-cloak] { display: none !important; }

    /* htmx loading indicator */
    .htmx-request .htmx-indicator {
      display: inline-block;
    }
    .htmx-indicator {
      display: none;
    }

    /* Field state transitions */
    .field-hidden {
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transition: opacity 0.2s, max-height 0.3s;
    }
    .field-visible {
      opacity: 1;
      max-height: 500px;
      transition: opacity 0.2s, max-height 0.3s;
    }

    /* Validation feedback styles */
    .validation-error {
      color: var(--danger);
      font-size: 12px;
      margin-top: 4px;
    }
    .validation-warning {
      color: var(--warning);
      font-size: 12px;
      margin-top: 4px;
    }
    .validation-success {
      color: var(--success);
      font-size: 12px;
      margin-top: 4px;
    }

    /* Field requirement indicators */
    .field-required label::after {
      content: " *";
      color: var(--danger);
    }
    .field-hint {
      font-size: 12px;
      color: var(--text-hint);
      margin-top: 2px;
    }

    /* Optimization tip styles */
    .optimization-tip {
      background: var(--info-light);
      border-left: 3px solid var(--info);
      padding: 12px 16px;
      border-radius: 0 8px 8px 0;
      margin: 8px 0;
    }
    .optimization-tip strong {
      color: var(--info);
    }

    /* Did you know hint */
    .did-you-know {
      background: var(--success-lighter);
      border-left: 3px solid var(--success);
      padding: 12px 16px;
      border-radius: 0 8px 8px 0;
      margin: 8px 0;
    }
  </style>

  <!-- Alpine.js - lightweight reactive framework -->
  <script defer src="https://unpkg.com/alpinejs@3.14.3/dist/cdn.min.js"></script>

  <!-- htmx - HTML-driven interactivity -->
  <script src="https://unpkg.com/htmx.org@2.0.4/dist/htmx.min.js"></script>

  <!-- Alpine.js Store and Configuration -->
  <script>
    // Wait for Alpine to be ready
    document.addEventListener('alpine:init', () => {

      // Global Tax Return State Store
      Alpine.store('taxReturn', {
        // Current wizard step
        currentStep: 1,
        totalSteps: 7,

        // Filing status (drives many visibility rules)
        filingStatus: null,

        // Field states from backend rules engine
        fieldStates: {},

        // Validation messages
        validationMessages: [],

        // Optimization recommendations
        recommendations: [],

        // Computed values from backend
        computed: {
          age: null,
          spouseAge: null,
          totalIncome: 0,
          agi: 0,
          taxableIncome: 0,
          totalTax: 0,
          refundOrOwed: 0
        },

        // Smart defaults from rules engine
        defaults: {
          useStandardDeduction: true,
          showSpouseFields: false,
          is65OrOlder: false
        },

        // Track dirty fields for validation
        dirtyFields: new Set(),

        // Loading state
        isLoading: false,

        // Initialize from server-provided state
        init() {
          console.log('Alpine.js tax return store initialized');
        },

        // Fetch field states from backend
        async updateFieldStates() {
          this.isLoading = true;
          try {
            const response = await fetch('/api/validate/fields', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.getContext())
            });
            if (response.ok) {
              const data = await response.json();
              this.fieldStates = data.fields || {};
              this.validationMessages = data.validation || [];
              this.computed = { ...this.computed, ...data.computed };
              this.defaults = { ...this.defaults, ...data.defaults };
            }
          } catch (error) {
            console.error('Failed to update field states:', error);
          } finally {
            this.isLoading = false;
          }
        },

        // Build context for rules engine
        getContext() {
          return {
            step: this.currentStep,
            filingStatus: this.filingStatus,
            computed: this.computed,
            // Include form data from the main app state
            ...(window.taxData || {})
          };
        },

        // Check if a field should be visible
        isFieldVisible(fieldId) {
          const state = this.fieldStates[fieldId];
          return state ? state.visible !== false : true;
        },

        // Check if a field is required
        isFieldRequired(fieldId) {
          const state = this.fieldStates[fieldId];
          return state ? state.requirement === 'mandatory' : false;
        },

        // Get field hint text
        getFieldHint(fieldId) {
          const state = this.fieldStates[fieldId];
          return state ? state.hint : null;
        },

        // Mark field as dirty (touched by user)
        markDirty(fieldId) {
          this.dirtyFields.add(fieldId);
        },

        // Check if field has validation error
        hasError(fieldId) {
          if (!this.dirtyFields.has(fieldId)) return false;
          return this.validationMessages.some(
            msg => msg.field === fieldId && msg.severity === 'error'
          );
        },

        // Get validation message for field
        getValidationMessage(fieldId) {
          return this.validationMessages.find(msg => msg.field === fieldId);
        },

        // Navigation helpers
        nextStep() {
          if (this.currentStep < this.totalSteps) {
            this.currentStep++;
            this.updateFieldStates();
          }
        },

        prevStep() {
          if (this.currentStep > 1) {
            this.currentStep--;
            this.updateFieldStates();
          }
        },

        goToStep(step) {
          if (step >= 1 && step <= this.totalSteps) {
            this.currentStep = step;
            this.updateFieldStates();
          }
        },

        // Handle filing status change (triggers many visibility updates)
        setFilingStatus(status) {
          this.filingStatus = status;
          this.defaults.showSpouseFields = ['married_joint', 'married_separate'].includes(status);
          this.updateFieldStates();
        }
      });

      // Recommendations Store
      Alpine.store('recommendations', {
        tips: [],
        savings: 0,

        async fetchRecommendations() {
          try {
            const context = Alpine.store('taxReturn').getContext();
            const response = await fetch('/api/suggestions', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(context)
            });
            if (response.ok) {
              const data = await response.json();
              this.tips = data.tips || [];
              this.savings = data.potential_savings || 0;
            }
          } catch (error) {
            console.error('Failed to fetch recommendations:', error);
          }
        }
      });
    });

    // htmx configuration
    document.addEventListener('DOMContentLoaded', () => {
      // Configure htmx
      htmx.config.defaultSwapStyle = 'innerHTML';
      htmx.config.indicatorClass = 'htmx-indicator';

      // Listen for htmx events
      document.body.addEventListener('htmx:afterSwap', (event) => {
        // Trigger Alpine to re-scan swapped content
        Alpine.initTree(event.detail.elt);
      });

      // Listen for validation responses
      document.body.addEventListener('htmx:afterRequest', (event) => {
        if (event.detail.pathInfo.requestPath.includes('/api/validate/')) {
          // Update Alpine store with validation result
          const response = JSON.parse(event.detail.xhr.response);
          if (response.validation) {
            const store = Alpine.store('taxReturn');
            store.validationMessages = response.validation;
          }
        }
      });
    });
  </script>
</head>
<body>
  <!-- Mobile Progress Bar (top of screen) -->
  <div class="mobile-progress" id="mobileProgress">
    <div class="mobile-progress-bar" id="mobileProgressBar" style="width: 0%"></div>
  </div>

  <div class="app-container">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <div class="logo-icon">$</div>
        <span>TaxFlow</span>
      </div>
      <div class="header-actions">
        <button class="btn-header" id="btnReset">Start Over</button>
        <button class="btn-header" id="btnHelp">Help</button>
      </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Primary Card -->
      <div class="primary-card">
        <!-- Progress Bar -->
        <div class="progress-container">
          <div class="progress-steps">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            <div class="step active" data-step="1">
              <div class="step-dot">1</div>
              <span class="step-label">About You</span>
            </div>
            <div class="step" data-step="2">
              <div class="step-dot">2</div>
              <span class="step-label">Documents</span>
            </div>
            <div class="step" data-step="3">
              <div class="step-dot">3</div>
              <span class="step-label">Income</span>
            </div>
            <div class="step" data-step="4">
              <div class="step-dot">4</div>
              <span class="step-label">Deductions</span>
            </div>
            <div class="step" data-step="5">
              <div class="step-dot">5</div>
              <span class="step-label">Credits</span>
            </div>
            <div class="step" data-step="6">
              <div class="step-dot">6</div>
              <span class="step-label">Review</span>
            </div>
          </div>
        </div>

        <!-- Step Content -->
        <div class="step-content">

          <!-- ============================================================ -->
          <!-- STEP 0: WELCOME / PRE-ONBOARDING (Modal Overlay) -->
          <!-- ============================================================ -->
          <div id="welcomeModal" class="welcome-modal">
            <div class="welcome-content">
              <div class="welcome-header">
                <div class="welcome-icon">ðŸŽ¯</div>
                <h1>Welcome to TaxFlow</h1>
                <p>Smart tax filing for Tax Year 2025</p>
              </div>

              <div class="welcome-options">
                <div class="welcome-option" data-type="new">
                  <div class="wo-icon">âœ¨</div>
                  <div class="wo-text">
                    <div class="wo-title">I'm new here</div>
                    <div class="wo-desc">Start fresh - we'll guide you step by step</div>
                  </div>
                </div>

                <div class="welcome-option" data-type="returning">
                  <div class="wo-icon">ðŸ”„</div>
                  <div class="wo-text">
                    <div class="wo-title">I filed with TaxFlow before</div>
                    <div class="wo-desc">We'll import your information from last year</div>
                  </div>
                </div>

                <div class="welcome-option" data-type="import">
                  <div class="wo-icon">ðŸ“¥</div>
                  <div class="wo-text">
                    <div class="wo-title">Import from another service</div>
                    <div class="wo-desc">TurboTax, H&R Block, or upload prior year PDF</div>
                  </div>
                </div>
              </div>

              <div class="welcome-footer">
                <p class="secure-note">ðŸ”’ Your data is encrypted and secure</p>
              </div>
            </div>
          </div>

          <!-- Import Modal (shown when "Import from another service" selected) -->
          <div id="importModal" class="import-modal hidden">
            <div class="import-content">
              <button class="import-close" id="closeImport">Ã—</button>
              <h2>Import Your Tax Data</h2>
              <p>Choose how you'd like to import your prior year information:</p>

              <div class="import-options">
                <div class="import-option" data-source="pdf">
                  <div class="io-icon">ðŸ“„</div>
                  <div class="io-title">Upload Prior Year 1040</div>
                  <div class="io-desc">PDF of your 2024 tax return</div>
                </div>

                <div class="import-option" data-source="turbotax">
                  <div class="io-icon">ðŸ”·</div>
                  <div class="io-title">TurboTax</div>
                  <div class="io-desc">.tax or .txf file</div>
                </div>

                <div class="import-option" data-source="hrblock">
                  <div class="io-icon">ðŸŸ©</div>
                  <div class="io-title">H&R Block</div>
                  <div class="io-desc">.hrb or PDF file</div>
                </div>

                <div class="import-option" data-source="csv">
                  <div class="io-icon">ðŸ“Š</div>
                  <div class="io-title">CSV/Excel</div>
                  <div class="io-desc">Spreadsheet format</div>
                </div>
              </div>

              <div class="import-upload hidden" id="importUpload">
                <input type="file" id="importFileInput" accept=".pdf,.tax,.txf,.hrb,.csv,.xlsx" />
                <label for="importFileInput" class="upload-label">
                  <span>ðŸ“ Choose file or drag here</span>
                </label>
                <div class="import-status" id="importStatus"></div>
              </div>

              <div class="import-actions">
                <button class="btn btn-secondary" id="skipImport">Skip - Start Fresh</button>
              </div>
            </div>
          </div>

          <!-- ============================================================ -->
          <!-- STEP 1: ABOUT YOU (Filing Status Wizard + Personal Info) -->
          <!-- ============================================================ -->
          <div id="step1" class="step-view hidden">
            <div class="step-header">
              <h2 class="step-title">Tell us about yourself</h2>
              <p class="step-subtitle">Answer a few questions so we can determine your best filing status and maximize your refund.</p>
            </div>

            <!-- Sub-step 1a: Life Situation Questions -->
            <div id="step1a" class="substep">
              <div class="wizard-card">
                <div class="wizard-progress">
                  <div class="wp-step active">1</div>
                  <div class="wp-line"></div>
                  <div class="wp-step">2</div>
                  <div class="wp-line"></div>
                  <div class="wp-step">3</div>
                  <div class="wp-line"></div>
                  <div class="wp-step">4</div>
                </div>

                <div class="wizard-question">
                  <h3>What was your marital status on December 31, 2025?</h3>
                  <p class="wizard-hint">Your status on the last day of the year determines your filing status</p>
                </div>

                <div class="wizard-options">
                  <button class="wizard-btn" data-question="marital" data-value="single">
                    <span class="wb-icon">ðŸ‘¤</span>
                    <span class="wb-text">Single</span>
                    <span class="wb-desc">Never married, or legally divorced/separated</span>
                  </button>
                  <button class="wizard-btn" data-question="marital" data-value="married">
                    <span class="wb-icon">ðŸ‘«</span>
                    <span class="wb-text">Married</span>
                    <span class="wb-desc">Legally married as of Dec 31, 2025</span>
                  </button>
                  <button class="wizard-btn" data-question="marital" data-value="widowed">
                    <span class="wb-icon">ðŸ•¯ï¸</span>
                    <span class="wb-text">Widowed</span>
                    <span class="wb-desc">Spouse passed away in 2023, 2024, or 2025</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Sub-step 1b: Spouse Death Year (shown if widowed) -->
            <div id="step1b-widow" class="substep hidden">
              <div class="wizard-card">
                <div class="wizard-progress">
                  <div class="wp-step completed">âœ“</div>
                  <div class="wp-line filled"></div>
                  <div class="wp-step active">2</div>
                  <div class="wp-line"></div>
                  <div class="wp-step">3</div>
                  <div class="wp-line"></div>
                  <div class="wp-step">4</div>
                </div>

                <div class="wizard-question">
                  <h3>When did your spouse pass away?</h3>
                  <p class="wizard-hint">This determines if you qualify for Qualifying Surviving Spouse status</p>
                </div>

                <div class="wizard-options">
                  <button class="wizard-btn" data-question="spouse_death" data-value="2025">
                    <span class="wb-icon">ðŸ“…</span>
                    <span class="wb-text">In 2025</span>
                    <span class="wb-desc">You can file as Married Filing Jointly for 2025</span>
                  </button>
                  <button class="wizard-btn" data-question="spouse_death" data-value="2024">
                    <span class="wb-icon">ðŸ“…</span>
                    <span class="wb-text">In 2024</span>
                    <span class="wb-desc">May qualify for Qualifying Surviving Spouse</span>
                  </button>
                  <button class="wizard-btn" data-question="spouse_death" data-value="2023">
                    <span class="wb-icon">ðŸ“…</span>
                    <span class="wb-text">In 2023</span>
                    <span class="wb-desc">May qualify for Qualifying Surviving Spouse</span>
                  </button>
                  <button class="wizard-btn" data-question="spouse_death" data-value="before_2023">
                    <span class="wb-icon">ðŸ“…</span>
                    <span class="wb-text">Before 2023</span>
                    <span class="wb-desc">File as Single or Head of Household</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Sub-step 1b: Married Filing Preference (shown if married) -->
            <div id="step1b-married" class="substep hidden">
              <div class="wizard-card">
                <div class="wizard-progress">
                  <div class="wp-step completed">âœ“</div>
                  <div class="wp-line filled"></div>
                  <div class="wp-step active">2</div>
                  <div class="wp-line"></div>
                  <div class="wp-step">3</div>
                  <div class="wp-line"></div>
                  <div class="wp-step">4</div>
                </div>

                <div class="wizard-question">
                  <h3>How would you like to file?</h3>
                  <p class="wizard-hint">Most couples save money filing jointly, but there are exceptions</p>
                </div>

                <div class="wizard-options">
                  <button class="wizard-btn recommended" data-question="married_filing" data-value="joint">
                    <span class="wb-icon">ðŸ‘«</span>
                    <span class="wb-text">Married Filing Jointly</span>
                    <span class="wb-desc">Combined income, usually lower taxes</span>
                    <span class="wb-badge">Recommended</span>
                  </button>
                  <button class="wizard-btn" data-question="married_filing" data-value="separate">
                    <span class="wb-icon">â†”ï¸</span>
                    <span class="wb-text">Married Filing Separately</span>
                    <span class="wb-desc">Separate liability, may be required in some cases</span>
                  </button>
                </div>

                <div class="wizard-info">
                  <div class="wi-icon">ðŸ’¡</div>
                  <div class="wi-text">
                    <strong>When to file separately:</strong> Student loan income-based repayment,
                    spouse has tax debt, protect yourself from spouse's tax issues,
                    or live in a community property state with complex situations.
                  </div>
                </div>
              </div>
            </div>

            <!-- Sub-step 1c: Dependents Question -->
            <div id="step1c" class="substep hidden">
              <div class="wizard-card">
                <div class="wizard-progress">
                  <div class="wp-step completed">âœ“</div>
                  <div class="wp-line filled"></div>
                  <div class="wp-step completed">âœ“</div>
                  <div class="wp-line filled"></div>
                  <div class="wp-step active">3</div>
                  <div class="wp-line"></div>
                  <div class="wp-step">4</div>
                </div>

                <div class="wizard-question">
                  <h3>Do you have any dependents?</h3>
                  <p class="wizard-hint">Children, relatives, or others who rely on you for financial support</p>
                </div>

                <div class="wizard-options">
                  <button class="wizard-btn" data-question="has_dependents" data-value="yes">
                    <span class="wb-icon">ðŸ‘¨â€ðŸ‘§â€ðŸ‘¦</span>
                    <span class="wb-text">Yes, I have dependents</span>
                    <span class="wb-desc">May qualify for Child Tax Credit, EITC, Head of Household</span>
                  </button>
                  <button class="wizard-btn" data-question="has_dependents" data-value="no">
                    <span class="wb-icon">ðŸ‘¤</span>
                    <span class="wb-text">No dependents</span>
                    <span class="wb-desc">No children or qualifying relatives</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Sub-step 1c-dependents: Dependent Details (shown if has dependents) -->
            <div id="step1c-dependents" class="substep hidden">
              <div class="wizard-card">
                <div class="wizard-progress">
                  <div class="wp-step completed">âœ“</div>
                  <div class="wp-line filled"></div>
                  <div class="wp-step completed">âœ“</div>
                  <div class="wp-line filled"></div>
                  <div class="wp-step active">3</div>
                  <div class="wp-line"></div>
                  <div class="wp-step">4</div>
                </div>

                <div class="wizard-question">
                  <h3>Tell us about your dependents</h3>
                  <p class="wizard-hint">We'll determine which credits you qualify for</p>
                </div>

                <div class="dependents-list" id="dependentsList">
                  <!-- Dependents will be added here dynamically -->
                </div>

                <!-- CTC Eligibility Notice - auto-calculated based on dependent ages -->
                <div id="ctcEligibilityNotice" class="eligibility-notice" style="display: none;"></div>

                <button class="add-dependent-btn" id="addDependentBtn">
                  <span>+ Add Dependent</span>
                </button>

                <!-- Dependent Form Template -->
                <div class="dependent-form hidden" id="dependentFormTemplate">
                  <div class="df-header">
                    <span class="df-title">Dependent Information</span>
                    <button class="df-remove">Ã—</button>
                  </div>
                  <div class="df-grid">
                    <div class="df-field">
                      <label>First Name</label>
                      <input type="text" class="dep-firstname" placeholder="First name">
                    </div>
                    <div class="df-field">
                      <label>Last Name</label>
                      <input type="text" class="dep-lastname" placeholder="Last name">
                    </div>
                    <div class="df-field">
                      <label>Date of Birth</label>
                      <input type="date" class="dep-dob">
                    </div>
                    <div class="df-field">
                      <label>Relationship</label>
                      <select class="dep-relationship">
                        <option value="">Select...</option>
                        <option value="child">Son/Daughter</option>
                        <option value="stepchild">Stepchild</option>
                        <option value="foster">Foster Child</option>
                        <option value="grandchild">Grandchild</option>
                        <option value="sibling">Brother/Sister</option>
                        <option value="parent">Parent</option>
                        <option value="grandparent">Grandparent</option>
                        <option value="other">Other Relative</option>
                      </select>
                    </div>
                    <div class="df-field">
                      <label>Months Lived With You</label>
                      <select class="dep-months">
                        <option value="12">All year (12 months)</option>
                        <option value="11">11 months</option>
                        <option value="10">10 months</option>
                        <option value="9">9 months</option>
                        <option value="8">8 months</option>
                        <option value="7">7 months</option>
                        <option value="6">6 months or less</option>
                        <option value="0">Did not live with me</option>
                      </select>
                    </div>
                    <div class="df-field">
                      <label>SSN (optional for now)</label>
                      <input type="text" class="dep-ssn" placeholder="XXX-XX-XXXX">
                    </div>
                  </div>
                  <div class="df-qualifications">
                    <div class="qual-item" data-qual="ctc">
                      <span class="qual-icon">â³</span>
                      <span class="qual-text">Checking Child Tax Credit eligibility...</span>
                    </div>
                    <div class="qual-item" data-qual="eitc">
                      <span class="qual-icon">â³</span>
                      <span class="qual-text">Checking EITC eligibility...</span>
                    </div>
                  </div>
                </div>

                <div class="dependents-summary hidden" id="dependentsSummary">
                  <div class="ds-header">Summary</div>
                  <div class="ds-content">
                    <div class="ds-row">
                      <span>Children under 17 (Child Tax Credit):</span>
                      <span id="ctcCount">0</span>
                    </div>
                    <div class="ds-row">
                      <span>Qualifying children for EITC:</span>
                      <span id="eitcCount">0</span>
                    </div>
                    <div class="ds-row">
                      <span>Other dependents:</span>
                      <span id="otherDepCount">0</span>
                    </div>
                  </div>
                </div>

                <div class="wizard-nav">
                  <button class="btn btn-secondary wizard-back">Back</button>
                  <button class="btn btn-primary wizard-next" id="dependentsNext">Continue</button>
                </div>
              </div>
            </div>

            <!-- Sub-step 1d: Head of Household Check (for single/widowed with dependents) -->
            <div id="step1d-hoh" class="substep hidden">
              <div class="wizard-card">
                <div class="wizard-progress">
                  <div class="wp-step completed">âœ“</div>
                  <div class="wp-line filled"></div>
                  <div class="wp-step completed">âœ“</div>
                  <div class="wp-line filled"></div>
                  <div class="wp-step completed">âœ“</div>
                  <div class="wp-line filled"></div>
                  <div class="wp-step active">4</div>
                </div>

                <div class="wizard-question">
                  <h3>Did you pay more than half the cost of keeping up your home?</h3>
                  <p class="wizard-hint">This includes rent/mortgage, utilities, food, repairs, property taxes, and insurance</p>
                </div>

                <div class="wizard-options">
                  <button class="wizard-btn" data-question="paid_household" data-value="yes">
                    <span class="wb-icon">âœ…</span>
                    <span class="wb-text">Yes, I paid more than half</span>
                    <span class="wb-desc">You may qualify for Head of Household status</span>
                  </button>
                  <button class="wizard-btn" data-question="paid_household" data-value="no">
                    <span class="wb-icon">âŒ</span>
                    <span class="wb-text">No</span>
                    <span class="wb-desc">Someone else paid more than half</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Sub-step 1e: Filing Status Recommendation -->
            <div id="step1e-result" class="substep hidden">
              <div class="wizard-card result-card">
                <div class="result-header">
                  <div class="result-icon">ðŸŽ¯</div>
                  <h3>Your Recommended Filing Status</h3>
                </div>

                <div class="result-recommendation" id="filingRecommendation">
                  <div class="rec-status">
                    <span class="rec-icon" id="recIcon">ðŸ‘¤</span>
                    <span class="rec-name" id="recName">Single</span>
                  </div>
                  <div class="rec-benefit" id="recBenefit">
                    Standard deduction: $15,000
                  </div>
                </div>

                <div class="result-comparison hidden" id="statusComparison">
                  <div class="comp-header">Other options and their impact:</div>
                  <div class="comp-list" id="compList">
                    <!-- Comparison items will be added dynamically -->
                  </div>
                </div>

                <div class="result-confirm">
                  <p>Do you want to use this filing status?</p>
                  <div class="confirm-buttons">
                    <button class="btn btn-primary" id="acceptStatus">Yes, use this status</button>
                    <button class="btn btn-secondary" id="changeStatus">Choose different status</button>
                  </div>
                </div>

                <!-- Manual Status Selection (shown if "Choose different" clicked) -->
                <div class="manual-status hidden" id="manualStatus">
                  <h4>Select your filing status:</h4>
                  <div class="status-options">
                    <div class="status-option" data-value="single">
                      <div class="so-icon">ðŸ‘¤</div>
                      <div class="so-details">
                        <div class="so-name">Single</div>
                        <div class="so-deduction">Standard deduction: $15,000</div>
                      </div>
                    </div>
                    <div class="status-option" data-value="married_joint">
                      <div class="so-icon">ðŸ‘«</div>
                      <div class="so-details">
                        <div class="so-name">Married Filing Jointly</div>
                        <div class="so-deduction">Standard deduction: $30,000</div>
                      </div>
                    </div>
                    <div class="status-option" data-value="married_separate">
                      <div class="so-icon">â†”ï¸</div>
                      <div class="so-details">
                        <div class="so-name">Married Filing Separately</div>
                        <div class="so-deduction">Standard deduction: $15,000</div>
                      </div>
                    </div>
                    <div class="status-option" data-value="head_of_household">
                      <div class="so-icon">ðŸ </div>
                      <div class="so-details">
                        <div class="so-name">Head of Household</div>
                        <div class="so-deduction">Standard deduction: $22,500</div>
                      </div>
                    </div>
                    <div class="status-option" data-value="qualifying_widow">
                      <div class="so-icon">ðŸ•¯ï¸</div>
                      <div class="so-details">
                        <div class="so-name">Qualifying Surviving Spouse</div>
                        <div class="so-deduction">Standard deduction: $30,000</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sub-step 1f: Personal Information -->
            <div id="step1f-personal" class="substep hidden">
              <div class="wizard-card">
                <div class="wizard-question">
                  <h3>Your Personal Information</h3>
                  <p class="wizard-hint">This information is required for your tax return</p>
                </div>

                <div class="personal-form">
                  <div class="pf-row">
                    <div class="pf-field">
                      <label>First Name *</label>
                      <input type="text" id="firstName" placeholder="John" required>
                    </div>
                    <div class="pf-field">
                      <label>Middle Initial</label>
                      <input type="text" id="middleInitial" placeholder="Q" maxlength="1">
                    </div>
                    <div class="pf-field">
                      <label>Last Name *</label>
                      <input type="text" id="lastName" placeholder="Public" required>
                    </div>
                  </div>

                  <div class="pf-row">
                    <div class="pf-field">
                      <label>Social Security Number *</label>
                      <input type="text" id="ssn" placeholder="XXX-XX-XXXX" required>
                      <span class="field-hint">ðŸ”’ Encrypted and secure</span>
                    </div>
                    <div class="pf-field">
                      <label>Date of Birth *</label>
                      <input type="date" id="dob" required>
                      <span id="calculatedAge" class="field-hint calculated-value"></span>
                    </div>
                  </div>

                  <!-- Age 65+ auto-calculated notice -->
                  <div id="age65Notice" class="info-notice" style="display: none;"></div>

                  <div class="pf-row">
                    <div class="pf-field full-width">
                      <label>Street Address *</label>
                      <input type="text" id="street" placeholder="123 Main Street" required>
                    </div>
                  </div>

                  <div class="pf-row">
                    <div class="pf-field">
                      <label>City *</label>
                      <input type="text" id="city" placeholder="Anytown" required>
                    </div>
                    <div class="pf-field">
                      <label>State *</label>
                      <select id="stateSelect" required>
                        <option value="">Select state...</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska (No state income tax)</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida (No state income tax)</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada (No state income tax)</option>
                <option value="NH">New Hampshire (No state income tax)</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota (No state income tax)</option>
                <option value="TN">Tennessee (No state income tax)</option>
                <option value="TX">Texas (No state income tax)</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington (No state income tax)</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming (No state income tax)</option>
                        <option value="DC">Washington D.C.</option>
                      </select>
                    </div>
                    <div class="pf-field">
                      <label>ZIP Code *</label>
                      <input type="text" id="zipCode" placeholder="12345" maxlength="10" required>
                    </div>
                  </div>

                  <!-- Age 65+ and Blindness Questions -->
                  <div class="pf-section">
                    <h4 class="pf-section-title">Additional Information</h4>
                    <p class="pf-section-hint">These affect your standard deduction amount</p>

                    <div class="checkbox-group">
                      <label class="checkbox-item age-65-manual">
                        <input type="checkbox" id="age65">
                        <span class="checkbox-label">I was born before January 2, 1961 (age 65 or older)</span>
                        <span class="checkbox-benefit">+$2,000 standard deduction</span>
                      </label>
                      <label class="checkbox-item">
                        <input type="checkbox" id="blind">
                        <span class="checkbox-label">I am legally blind</span>
                        <span class="checkbox-benefit">+$2,000 standard deduction</span>
                      </label>
                    </div>

                    <!-- Spouse fields (shown if MFJ) -->
                    <div id="spouseAgeBlind" class="spouse-fields hidden">
                      <h5>Spouse Information</h5>
                      <p class="pf-section-hint">Required for Married Filing Jointly</p>

                      <div class="pf-row">
                        <div class="pf-field">
                          <label>Spouse First Name *</label>
                          <input type="text" id="spouseFirstName" placeholder="Jane">
                        </div>
                        <div class="pf-field">
                          <label>Spouse Middle Initial</label>
                          <input type="text" id="spouseMiddleInitial" placeholder="A" maxlength="1">
                        </div>
                        <div class="pf-field">
                          <label>Spouse Last Name *</label>
                          <input type="text" id="spouseLastName" placeholder="Public">
                        </div>
                      </div>

                      <div class="pf-row">
                        <div class="pf-field">
                          <label>Spouse SSN *</label>
                          <input type="text" id="spouseSsn" placeholder="XXX-XX-XXXX">
                          <span class="field-hint">ðŸ”’ Encrypted and secure</span>
                        </div>
                        <div class="pf-field">
                          <label>Spouse Date of Birth *</label>
                          <input type="date" id="spouseDob">
                          <span id="spouseCalculatedAge" class="field-hint calculated-value"></span>
                        </div>
                      </div>

                      <div class="checkbox-group" style="margin-top: 16px;">
                        <label class="checkbox-item spouse-age-65-manual">
                          <input type="checkbox" id="spouseAge65">
                          <span class="checkbox-label">Spouse was born before January 2, 1961</span>
                          <span class="checkbox-benefit">+$1,600 standard deduction</span>
                        </label>
                        <label class="checkbox-item">
                          <input type="checkbox" id="spouseBlind">
                          <span class="checkbox-label">Spouse is legally blind</span>
                          <span class="checkbox-benefit">+$1,600 standard deduction</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <!-- Bank Information (optional) -->
                  <div class="pf-section">
                    <h4 class="pf-section-title">Direct Deposit (Optional)</h4>
                    <p class="pf-section-hint">Get your refund faster - typically 21 days vs 6-8 weeks by mail</p>

                    <div class="pf-row">
                      <div class="pf-field">
                        <label>Routing Number</label>
                        <input type="text" id="routingNumber" placeholder="9 digits">
                      </div>
                      <div class="pf-field">
                        <label>Account Number</label>
                        <input type="text" id="accountNumber" placeholder="Account number">
                      </div>
                      <div class="pf-field">
                        <label>Account Type</label>
                        <select id="accountType">
                          <option value="">Select...</option>
                          <option value="checking">Checking</option>
                          <option value="savings">Savings</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="wizard-nav">
                  <button class="btn btn-secondary wizard-back" id="personalBack">Back</button>
                  <button class="btn btn-primary" id="personalNext">Continue to Documents</button>
                </div>
              </div>
            </div>

            <!-- Nav for Step 1 overall -->
            <div class="nav-buttons hidden" id="step1Nav">
              <button class="btn btn-secondary" id="btnBack1">Back</button>
              <button class="btn btn-primary" id="btnNext1">Continue</button>
            </div>
          </div>

          <!-- STEP 2: Documents -->
          <div id="step2" class="step-view hidden">
            <div class="step-header">
              <h2 class="step-title">Upload your tax documents</h2>
              <p class="step-subtitle">Drop your W-2s and 1099s here. We'll automatically extract the data for you.</p>
            </div>

            <div class="upload-zone" id="uploadZone">
              <div class="upload-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
              </div>
              <div class="upload-title">Drop files here or click to upload</div>
              <div class="upload-subtitle">We'll automatically extract all tax information</div>
              <div class="upload-formats">
                <span class="format-badge">PDF</span>
                <span class="format-badge">PNG</span>
                <span class="format-badge">JPG</span>
                <span class="format-badge">TIFF</span>
              </div>
            </div>

            <div class="documents-list" id="documentsList"></div>

            <div class="nav-buttons">
              <button class="btn btn-secondary" id="btnBack2">Back</button>
              <button class="btn btn-primary" id="btnNext2">Continue</button>
            </div>
          </div>

          <!-- STEP 3: Additional Income (Chat) -->
          <div id="step3" class="step-view hidden">
            <div class="step-header">
              <h2 class="step-title">Any other income?</h2>
              <p class="step-subtitle">Let's make sure we capture everything. Tell us about any additional income.</p>
            </div>

            <div class="chat-container">
              <div class="chat-messages" id="chatMessages"></div>
              <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="Type your answer..." />
                <button class="btn-send" id="btnSend">Send</button>
              </div>
            </div>

            <div class="nav-buttons">
              <button class="btn btn-secondary" id="btnBack3">Back</button>
              <button class="btn btn-primary" id="btnNext3">Continue</button>
            </div>
          </div>

          <!-- STEP 4: Deductions -->
          <div id="step4" class="step-view hidden">
            <div class="step-header">
              <h2 class="step-title">Maximize your deductions</h2>
              <p class="step-subtitle">Answer these questions to find all the deductions you qualify for. We'll automatically determine if itemizing saves you more than the standard deduction.</p>
            </div>

            <div class="deductions-container" id="deductionQuestions">
              <!-- Home & Property -->
              <div class="deduction-category">
                <div class="category-header">
                  <span class="category-icon">ðŸ </span>
                  <span class="category-title">Home & Property</span>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you pay mortgage interest?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="mortgage" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="mortgage" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="mortgage">
                    <label>Amount paid:</label>
                    <input type="text" class="amount-field" data-field="mortgage_amount" placeholder="$0">
                    <span class="input-hint">From Form 1098, Box 1</span>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you pay property taxes?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="property_tax" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="property_tax" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="property_tax">
                    <label>Amount paid:</label>
                    <input type="text" class="amount-field" data-field="property_tax_amount" placeholder="$0">
                    <span class="input-hint">Combined with state taxes, max $10,000 deduction (SALT cap)</span>
                  </div>
                </div>
              </div>

              <!-- Charitable Giving -->
              <div class="deduction-category">
                <div class="category-header">
                  <span class="category-icon">â¤ï¸</span>
                  <span class="category-title">Charitable Giving</span>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you donate to charity (cash)?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="charity_cash" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="charity_cash" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="charity_cash">
                    <label>Total cash donations:</label>
                    <input type="text" class="amount-field" data-field="charity_cash_amount" placeholder="$0">
                    <span class="input-hint">Churches, nonprofits, charities (keep receipts for $250+)</span>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you donate goods (clothing, furniture, etc.)?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="charity_goods" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="charity_goods" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="charity_goods">
                    <label>Fair market value:</label>
                    <input type="text" class="amount-field" data-field="charity_goods_amount" placeholder="$0">
                    <span class="input-hint">Goodwill, Salvation Army, etc.</span>
                  </div>
                </div>
              </div>

              <!-- Medical & Health -->
              <div class="deduction-category">
                <div class="category-header">
                  <span class="category-icon">ðŸ¥</span>
                  <span class="category-title">Medical & Health</span>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you have significant medical expenses?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="medical" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="medical" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="medical">
                    <label>Total out-of-pocket medical expenses:</label>
                    <input type="text" class="amount-field" data-field="medical_amount" placeholder="$0">
                    <span class="input-hint">Only expenses exceeding 7.5% of AGI are deductible</span>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you contribute to an HSA?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="hsa" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="hsa" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="hsa">
                    <label>HSA contributions (not through employer):</label>
                    <input type="text" class="amount-field" data-field="hsa_amount" placeholder="$0">
                    <span class="input-hint">2025 limit: $4,300 individual / $8,550 family</span>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Are you self-employed and pay health insurance?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="self_health_insurance" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="self_health_insurance" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="self_health_insurance">
                    <label>Health insurance premiums paid:</label>
                    <input type="text" class="amount-field" data-field="self_health_insurance_amount" placeholder="$0">
                    <span class="input-hint">100% deductible above-the-line</span>
                  </div>
                </div>
              </div>

              <!-- Education -->
              <div class="deduction-category">
                <div class="category-header">
                  <span class="category-icon">ðŸŽ“</span>
                  <span class="category-title">Education</span>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you pay student loan interest?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="student_loan" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="student_loan" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="student_loan">
                    <label>Interest paid:</label>
                    <input type="text" class="amount-field" data-field="student_loan_amount" placeholder="$0">
                    <span class="input-hint">Max $2,500 deduction (Form 1098-E)</span>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you pay college tuition?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="tuition" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="tuition" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="tuition">
                    <label>Tuition and fees paid:</label>
                    <input type="text" class="amount-field" data-field="tuition_amount" placeholder="$0">
                    <span class="input-hint">May qualify for American Opportunity or Lifetime Learning Credit</span>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Are you a K-12 teacher who bought classroom supplies?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="educator" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="educator" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="educator">
                    <label>Amount spent on supplies:</label>
                    <input type="text" class="amount-field" data-field="educator_amount" placeholder="$0">
                    <span class="input-hint">Up to $300 deductible above-the-line</span>
                  </div>
                </div>
              </div>

              <!-- Family & Childcare -->
              <div class="deduction-category">
                <div class="category-header">
                  <span class="category-icon">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§</span>
                  <span class="category-title">Family & Childcare</span>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you pay for childcare or daycare?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="childcare" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="childcare" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="childcare">
                    <label>Childcare expenses:</label>
                    <input type="text" class="amount-field" data-field="childcare_amount" placeholder="$0">
                    <span class="input-hint">May qualify for Child Care Credit (up to $3,000/child)</span>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Do you have children under 17?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="children" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="children" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="children">
                    <label>Number of qualifying children:</label>
                    <input type="number" class="amount-field" data-field="children_count" placeholder="0" min="0" max="10">
                    <span class="input-hint">$2,200 Child Tax Credit per child (2025)</span>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you pay alimony (divorce before 2019)?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="alimony" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="alimony" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="alimony">
                    <label>Alimony paid:</label>
                    <input type="text" class="amount-field" data-field="alimony_amount" placeholder="$0">
                    <span class="input-hint">Only deductible for divorces finalized before 2019</span>
                  </div>
                </div>
              </div>

              <!-- Retirement -->
              <div class="deduction-category">
                <div class="category-header">
                  <span class="category-icon">ðŸ¦</span>
                  <span class="category-title">Retirement Savings</span>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you contribute to a Traditional IRA?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="ira" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="ira" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="ira">
                    <label>IRA contributions:</label>
                    <input type="text" class="amount-field" data-field="ira_amount" placeholder="$0">
                    <span class="input-hint">2025 limit: $7,000 ($8,000 if 50+)</span>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Are you self-employed with a SEP/SIMPLE IRA?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="sep_ira" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="sep_ira" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="sep_ira">
                    <label>SEP/SIMPLE contributions:</label>
                    <input type="text" class="amount-field" data-field="sep_ira_amount" placeholder="$0">
                    <span class="input-hint">SEP limit: 25% of net self-employment income (max $69,000)</span>
                  </div>
                </div>
              </div>

              <!-- Work & Business -->
              <div class="deduction-category">
                <div class="category-header">
                  <span class="category-icon">ðŸ’¼</span>
                  <span class="category-title">Work & Business</span>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Do you work from home (self-employed)?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="home_office" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="home_office" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="home_office">
                    <label>Home office square footage:</label>
                    <input type="number" class="amount-field" data-field="home_office_sqft" placeholder="0" min="0">
                    <span class="input-hint">Simplified method: $5/sq ft (max 300 sq ft = $1,500)</span>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you have unreimbursed business expenses?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="business_expenses" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="business_expenses" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="business_expenses">
                    <label>Business expenses (self-employed only):</label>
                    <input type="text" class="amount-field" data-field="business_expenses_amount" placeholder="$0">
                    <span class="input-hint">Equipment, supplies, software, travel, etc.</span>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you use your vehicle for business?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="vehicle" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="vehicle" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="vehicle">
                    <label>Business miles driven:</label>
                    <input type="number" class="amount-field" data-field="vehicle_miles" placeholder="0" min="0">
                    <span class="input-hint">2025 rate: 70 cents per mile</span>
                  </div>
                </div>
              </div>

              <!-- State & Local Taxes -->
              <div class="deduction-category">
                <div class="category-header">
                  <span class="category-icon">ðŸ›ï¸</span>
                  <span class="category-title">State & Local Taxes</span>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you pay state income tax (beyond withholding)?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="state_tax" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="state_tax" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="state_tax">
                    <label>Additional state tax paid:</label>
                    <input type="text" class="amount-field" data-field="state_tax_amount" placeholder="$0">
                    <span class="input-hint">Estimated payments, prior year balance due</span>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you pay local income tax?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="local_tax" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="local_tax" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="local_tax">
                    <label>Local income tax paid:</label>
                    <input type="text" class="amount-field" data-field="local_tax_amount" placeholder="$0">
                    <span class="input-hint">City/county tax (NYC, Philadelphia, etc.)</span>
                  </div>
                </div>
              </div>

              <!-- Other Deductions -->
              <div class="deduction-category">
                <div class="category-header">
                  <span class="category-icon">ðŸ“</span>
                  <span class="category-title">Other Deductions</span>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you have gambling losses?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="gambling" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="gambling" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="gambling">
                    <label>Gambling losses:</label>
                    <input type="text" class="amount-field" data-field="gambling_amount" placeholder="$0">
                    <span class="input-hint">Can only deduct up to gambling winnings</span>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you have casualty/theft losses (federally declared disaster)?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="casualty" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="casualty" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="casualty">
                    <label>Unreimbursed loss amount:</label>
                    <input type="text" class="amount-field" data-field="casualty_amount" placeholder="$0">
                    <span class="input-hint">Only for federally declared disasters</span>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you pay investment interest expenses?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn deduction-option" data-question="investment_interest" data-value="yes">Yes</button>
                      <button class="toggle-btn deduction-option" data-question="investment_interest" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="investment_interest">
                    <label>Investment interest paid:</label>
                    <input type="text" class="amount-field" data-field="investment_interest_amount" placeholder="$0">
                    <span class="input-hint">Margin interest, etc. (limited to investment income)</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Deduction Summary -->
            <div class="deduction-summary" id="deductionSummary">
              <div class="summary-comparison">
                <div class="comparison-item">
                  <div class="comparison-label">Standard Deduction</div>
                  <div class="comparison-value" id="standardDeductionAmount">$15,000</div>
                </div>
                <div class="comparison-vs">VS</div>
                <div class="comparison-item">
                  <div class="comparison-label">Your Itemized Total</div>
                  <div class="comparison-value" id="itemizedTotal">$0</div>
                </div>
              </div>
              <div class="recommendation" id="deductionRecommendation">
                <span class="rec-icon">ðŸ’¡</span>
                <span class="rec-text">Add your deductions above to see which option saves you more!</span>
              </div>
            </div>

            <div class="nav-buttons">
              <button class="btn btn-secondary" id="btnBack4">Back</button>
              <button class="btn btn-primary" id="btnNext4">Continue</button>
            </div>
          </div>

          <!-- ============================================================ -->
          <!-- STEP 5: TAX CREDITS -->
          <!-- ============================================================ -->
          <div id="step5" class="step-view hidden">
            <div class="step-header">
              <h2 class="step-title">Claim your tax credits</h2>
              <p class="step-subtitle">Credits directly reduce your tax bill. Let's find all the credits you qualify for.</p>
            </div>

            <div class="credits-container">
              <!-- Child-Related Credits -->
              <div class="credit-category">
                <div class="category-header">
                  <span class="category-icon">ðŸ‘¶</span>
                  <span class="category-title">Child & Family Credits</span>
                </div>

                <!-- Child Tax Credit (Auto-calculated from dependents) -->
                <div class="credit-card auto-credit" id="ctcCard">
                  <div class="credit-header">
                    <div class="credit-name">Child Tax Credit</div>
                    <div class="credit-amount" id="ctcAmount">$0</div>
                  </div>
                  <div class="credit-details">
                    <span class="credit-desc">$2,200 per qualifying child under 17</span>
                    <span class="credit-status" id="ctcStatus">Add dependents to qualify</span>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you pay for childcare so you could work?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn credit-option" data-credit="childcare" data-value="yes">Yes</button>
                      <button class="toggle-btn credit-option" data-credit="childcare" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="childcare">
                    <div class="credit-form">
                      <div class="cf-row">
                        <div class="cf-field">
                          <label>Total childcare expenses paid</label>
                          <input type="text" class="amount-field" data-field="childcare_amount" placeholder="$0">
                          <span class="input-hint">Max $3,000 for one child, $6,000 for two+</span>
                        </div>
                        <div class="cf-field">
                          <label>Provider's Tax ID (EIN or SSN)</label>
                          <input type="text" class="amount-field" data-field="childcare_provider_tin" placeholder="XX-XXXXXXX">
                        </div>
                      </div>
                    </div>
                    <div class="credit-estimate">
                      <span>Estimated credit:</span>
                      <span class="ce-amount" id="childcareCredit">$0</span>
                      <span class="ce-note">(20-35% of expenses based on income)</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Education Credits -->
              <div class="credit-category">
                <div class="category-header">
                  <span class="category-icon">ðŸŽ“</span>
                  <span class="category-title">Education Credits</span>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you pay college tuition in 2025?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn credit-option" data-credit="education" data-value="yes">Yes</button>
                      <button class="toggle-btn credit-option" data-credit="education" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="education">
                    <div class="credit-form">
                      <div class="cf-row">
                        <div class="cf-field">
                          <label>Tuition and fees paid (Form 1098-T)</label>
                          <input type="text" class="amount-field" data-field="tuition_paid" placeholder="$0">
                        </div>
                        <div class="cf-field">
                          <label>Student status</label>
                          <select class="amount-field" data-field="student_status">
                            <option value="">Select...</option>
                            <option value="undergrad_1-4">Undergraduate (first 4 years)</option>
                            <option value="grad">Graduate school</option>
                            <option value="continuing">Continuing education</option>
                          </select>
                        </div>
                      </div>
                    </div>

                    <div class="credit-comparison">
                      <div class="cc-header">Best education credit for you:</div>
                      <div class="cc-options">
                        <div class="cc-option recommended" data-credit-type="aotc">
                          <div class="cc-name">American Opportunity Credit</div>
                          <div class="cc-amount" id="aotcAmount">Up to $2,500</div>
                          <div class="cc-desc">First 4 years of college, 40% refundable</div>
                        </div>
                        <div class="cc-option" data-credit-type="llc">
                          <div class="cc-name">Lifetime Learning Credit</div>
                          <div class="cc-amount" id="llcAmount">Up to $2,000</div>
                          <div class="cc-desc">Any year, graduate school, non-refundable</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Earned Income Credit -->
              <div class="credit-category">
                <div class="category-header">
                  <span class="category-icon">ðŸ’°</span>
                  <span class="category-title">Earned Income Tax Credit (EITC)</span>
                </div>

                <div class="credit-card auto-credit" id="eitcCard">
                  <div class="credit-header">
                    <div class="credit-name">Earned Income Credit</div>
                    <div class="credit-amount" id="eitcAmount">$0</div>
                  </div>
                  <div class="credit-details">
                    <span class="credit-desc" id="eitcDesc">For low-to-moderate income workers</span>
                    <span class="credit-status" id="eitcStatus">Calculating based on your income...</span>
                  </div>
                  <div class="eitc-table">
                    <div class="eitc-row header">
                      <span>Children</span>
                      <span>Max Credit</span>
                      <span>Max Income (Single)</span>
                    </div>
                    <div class="eitc-row">
                      <span>0</span>
                      <span>$649</span>
                      <span>$18,591</span>
                    </div>
                    <div class="eitc-row">
                      <span>1</span>
                      <span>$4,328</span>
                      <span>$49,084</span>
                    </div>
                    <div class="eitc-row">
                      <span>2</span>
                      <span>$7,152</span>
                      <span>$55,768</span>
                    </div>
                    <div class="eitc-row">
                      <span>3+</span>
                      <span>$8,046</span>
                      <span>$59,899</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Energy Credits -->
              <div class="credit-category">
                <div class="category-header">
                  <span class="category-icon">âš¡</span>
                  <span class="category-title">Energy & Home Credits</span>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you make energy-efficient home improvements?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn credit-option" data-credit="energy_home" data-value="yes">Yes</button>
                      <button class="toggle-btn credit-option" data-credit="energy_home" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="energy_home">
                    <div class="credit-checklist">
                      <label class="credit-check-item">
                        <input type="checkbox" data-item="insulation">
                        <span>Insulation, windows, or doors</span>
                        <span class="item-credit">30% of cost, max $1,200</span>
                      </label>
                      <label class="credit-check-item">
                        <input type="checkbox" data-item="hvac">
                        <span>Heat pump, AC, or water heater</span>
                        <span class="item-credit">30% of cost, max $2,000</span>
                      </label>
                      <label class="credit-check-item">
                        <input type="checkbox" data-item="solar">
                        <span>Solar panels or battery storage</span>
                        <span class="item-credit">30% of cost, no limit</span>
                      </label>
                    </div>
                    <div class="cf-field">
                      <label>Total spent on improvements</label>
                      <input type="text" class="amount-field" data-field="energy_amount" placeholder="$0">
                    </div>
                    <div class="credit-estimate">
                      <span>Estimated credit:</span>
                      <span class="ce-amount" id="energyCredit">$0</span>
                    </div>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you buy or lease an electric vehicle?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn credit-option" data-credit="ev" data-value="yes">Yes</button>
                      <button class="toggle-btn credit-option" data-credit="ev" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="ev">
                    <div class="credit-form">
                      <div class="cf-row">
                        <div class="cf-field">
                          <label>Vehicle purchase price</label>
                          <input type="text" class="amount-field" data-field="ev_price" placeholder="$0">
                        </div>
                        <div class="cf-field">
                          <label>New or used?</label>
                          <select class="amount-field" data-field="ev_type">
                            <option value="">Select...</option>
                            <option value="new">New (up to $7,500 credit)</option>
                            <option value="used">Used (up to $4,000 credit)</option>
                          </select>
                        </div>
                      </div>
                    </div>
                    <div class="credit-estimate">
                      <span>Estimated credit:</span>
                      <span class="ce-amount" id="evCredit">$0</span>
                      <span class="ce-note">(Subject to income limits and vehicle eligibility)</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Retirement Savings Credit -->
              <div class="credit-category">
                <div class="category-header">
                  <span class="category-icon">ðŸ¦</span>
                  <span class="category-title">Retirement Savings Credit</span>
                </div>

                <div class="credit-card auto-credit" id="saverCard">
                  <div class="credit-header">
                    <div class="credit-name">Saver's Credit</div>
                    <div class="credit-amount" id="saverAmount">$0</div>
                  </div>
                  <div class="credit-details">
                    <span class="credit-desc">10-50% of retirement contributions (max $2,000)</span>
                    <span class="credit-status" id="saverStatus">Based on IRA/401k contributions</span>
                  </div>
                  <div class="saver-info">
                    <p>Income limits for 2025:</p>
                    <ul>
                      <li>Single: AGI â‰¤ $38,500</li>
                      <li>HOH: AGI â‰¤ $57,750</li>
                      <li>MFJ: AGI â‰¤ $77,000</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Other Credits -->
              <div class="credit-category">
                <div class="category-header">
                  <span class="category-icon">ðŸ“‹</span>
                  <span class="category-title">Other Credits</span>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you pay foreign taxes on investments?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn credit-option" data-credit="foreign_tax" data-value="yes">Yes</button>
                      <button class="toggle-btn credit-option" data-credit="foreign_tax" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="foreign_tax">
                    <div class="cf-field">
                      <label>Foreign taxes paid (from 1099-DIV Box 7)</label>
                      <input type="text" class="amount-field" data-field="foreign_tax_amount" placeholder="$0">
                    </div>
                    <div class="credit-estimate">
                      <span>Foreign Tax Credit:</span>
                      <span class="ce-amount" id="foreignTaxCredit">$0</span>
                    </div>
                  </div>
                </div>

                <div class="question-card">
                  <div class="question-row">
                    <div class="question-text">Did you adopt a child in 2025?</div>
                    <div class="toggle-buttons">
                      <button class="toggle-btn credit-option" data-credit="adoption" data-value="yes">Yes</button>
                      <button class="toggle-btn credit-option" data-credit="adoption" data-value="no">No</button>
                    </div>
                  </div>
                  <div class="amount-input hidden" data-for="adoption">
                    <div class="cf-field">
                      <label>Qualified adoption expenses</label>
                      <input type="text" class="amount-field" data-field="adoption_amount" placeholder="$0">
                      <span class="input-hint">Max credit: $16,810 per child (2025)</span>
                    </div>
                    <div class="credit-estimate">
                      <span>Adoption Credit:</span>
                      <span class="ce-amount" id="adoptionCredit">$0</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Credits Summary -->
            <div class="credits-summary">
              <div class="cs-header">Your Tax Credits Summary</div>
              <div class="cs-list" id="creditsSummaryList">
                <div class="cs-item">
                  <span class="cs-name">Child Tax Credit</span>
                  <span class="cs-value" id="summaryCtc">$0</span>
                </div>
                <div class="cs-item">
                  <span class="cs-name">Earned Income Credit</span>
                  <span class="cs-value" id="summaryEitc">$0</span>
                </div>
                <div class="cs-item">
                  <span class="cs-name">Other Credits</span>
                  <span class="cs-value" id="summaryOtherCredits">$0</span>
                </div>
                <div class="cs-total">
                  <span class="cs-name">Total Credits</span>
                  <span class="cs-value" id="summaryTotalCredits">$0</span>
                </div>
              </div>
              <div class="cs-note">
                <span class="cs-icon">ðŸ’¡</span>
                <span>Refundable credits (CTC, EITC) can result in a refund even if you owe no tax!</span>
              </div>
            </div>

            <div class="nav-buttons">
              <button class="btn btn-secondary" id="btnBack5">Back</button>
              <button class="btn btn-primary" id="btnNext5">Continue to Review</button>
            </div>
          </div>

          <!-- ============================================================ -->
          <!-- STEP 6: COMPREHENSIVE TAX REVIEW & ANALYSIS -->
          <!-- ============================================================ -->
          <div id="step6" class="step-view hidden">
            <div class="step-header">
              <h2 class="step-title">Your Complete Tax Analysis</h2>
              <p class="step-subtitle">Professional-grade tax computation with optimization recommendations</p>
            </div>

            <!-- Review Savings Banner (Prompt 5) -->
            <div class="review-savings-banner" id="reviewSavingsBanner">
              <div class="review-savings-banner-icon">âš¡</div>
              <div class="review-savings-banner-content">
                <div class="review-savings-banner-title">BEFORE YOU FILE: We found potential savings</div>
                <div class="review-savings-banner-subtitle">Review optimization options to reduce your tax liability</div>
              </div>
              <button class="review-savings-banner-cta" onclick="openTaxOptimizer(); markOptimizerClicked();">
                Review â†’
              </button>
              <button class="review-savings-banner-dismiss" onclick="dismissReviewBanner()">Ã—</button>
            </div>

            <!-- Action Bar -->
            <div class="review-actions">
              <button class="action-btn action-btn-primary" id="btnTaxOptimizer" onclick="openTaxOptimizer('scenarios')">
                <span class="action-icon">ðŸŽ¯</span>
                <span>Tax Optimizer</span>
              </button>
              <button class="action-btn" id="btnDownloadPDF">
                <span class="action-icon">ðŸ“„</span>
                <span>Download PDF</span>
              </button>
              <button class="action-btn" id="btnPrintSummary">
                <span class="action-icon">ðŸ–¨ï¸</span>
                <span>Print</span>
              </button>
              <button class="action-btn" id="btnCompareStatuses" onclick="openTaxOptimizer('scenarios')">
                <span class="action-icon">âš–ï¸</span>
                <span>Compare Filing Options</span>
              </button>
              <button class="action-btn" id="btnCompareStates">
                <span class="action-icon">ðŸ—ºï¸</span>
                <span>State Tax Analysis</span>
              </button>
            </div>

            <!-- Main Refund/Owed Banner -->
            <div class="review-banner" id="reviewBanner">
              <div class="rb-main">
                <div class="rb-label" id="rbLabel">Your Estimated Federal Refund</div>
                <div class="rb-amount" id="rbAmount">$0</div>
                <div class="rb-breakdown">
                  <span id="rbFederal">Federal: $0</span>
                  <span class="rb-divider">|</span>
                  <span id="rbState">State: $0</span>
                </div>
              </div>
              <div class="rb-actions">
                <button class="btn btn-success btn-lg" id="btnFileNow">File Now</button>
              </div>
            </div>

            <!-- Optimization Recommendations -->
            <div class="optimization-panel" id="optimizationPanel">
              <div class="op-header">
                <span class="op-icon">ðŸ’¡</span>
                <span class="op-title">Tax Optimization Opportunities</span>
                <span class="op-potential" id="opPotential">Potential savings: $0</span>
              </div>
              <div class="op-recommendations" id="opRecommendations">
                <!-- Dynamically populated -->
              </div>
              <!-- Quick Optimizer Links -->
              <div class="op-quick-links">
                <div class="op-quick-link" onclick="openTaxOptimizer('scenarios')">
                  <span class="oql-icon">ðŸ”„</span>
                  <div class="oql-content">
                    <span class="oql-title">What-If Scenarios</span>
                    <span class="oql-desc">Compare filing options</span>
                  </div>
                  <span class="oql-arrow">â†’</span>
                </div>
                <div class="op-quick-link" onclick="openTaxOptimizer('entity')">
                  <span class="oql-icon">ðŸ¢</span>
                  <div class="oql-content">
                    <span class="oql-title">Business Entity</span>
                    <span class="oql-desc">S-Corp savings analysis</span>
                  </div>
                  <span class="oql-arrow">â†’</span>
                </div>
                <div class="op-quick-link" onclick="openTaxOptimizer('retirement')">
                  <span class="oql-icon">ðŸ’°</span>
                  <div class="oql-content">
                    <span class="oql-title">Retirement Planning</span>
                    <span class="oql-desc">Maximize contributions</span>
                  </div>
                  <span class="oql-arrow">â†’</span>
                </div>
              </div>
            </div>

            <!-- Detailed Computation Section -->
            <div class="computation-panel">
              <div class="cp-header">
                <h3>Detailed Tax Computation</h3>
                <span class="cp-badge">Tax Year 2025</span>
              </div>

              <!-- Section 1: Income -->
              <div class="cp-section">
                <div class="cps-header" data-toggle="incomeDetails">
                  <span class="cps-icon">ðŸ’°</span>
                  <span class="cps-title">Gross Income</span>
                  <span class="cps-amount" id="cpGrossIncome">$0</span>
                  <span class="cps-toggle">â–¼</span>
                </div>
                <div class="cps-details" id="incomeDetails">
                  <div class="cpd-row">
                    <span class="cpd-label">W-2 Wages, Salaries, Tips</span>
                    <span class="cpd-value" id="cpWages">$0</span>
                  </div>
                  <div class="cpd-row">
                    <span class="cpd-label">Interest Income (1099-INT)</span>
                    <span class="cpd-value" id="cpInterest">$0</span>
                  </div>
                  <div class="cpd-row">
                    <span class="cpd-label">Dividend Income (1099-DIV)</span>
                    <span class="cpd-value" id="cpDividends">$0</span>
                  </div>
                  <div class="cpd-row">
                    <span class="cpd-label">Self-Employment Income</span>
                    <span class="cpd-value" id="cpSelfEmployment">$0</span>
                  </div>
                  <div class="cpd-row">
                    <span class="cpd-label">Other Income</span>
                    <span class="cpd-value" id="cpOtherIncome">$0</span>
                  </div>
                  <div class="cpd-row total">
                    <span class="cpd-label">Total Gross Income</span>
                    <span class="cpd-value" id="cpTotalGross">$0</span>
                  </div>
                </div>
              </div>

              <!-- Section 2: Adjustments to Income -->
              <div class="cp-section">
                <div class="cps-header" data-toggle="adjustmentDetails">
                  <span class="cps-icon">ðŸ“‰</span>
                  <span class="cps-title">Adjustments to Income (Above-the-Line)</span>
                  <span class="cps-amount negative" id="cpAdjustments">-$0</span>
                  <span class="cps-toggle">â–¼</span>
                </div>
                <div class="cps-details" id="adjustmentDetails">
                  <div class="cpd-row">
                    <span class="cpd-label">Educator Expenses</span>
                    <span class="cpd-value" id="cpEducator">$0</span>
                  </div>
                  <div class="cpd-row">
                    <span class="cpd-label">HSA Contributions</span>
                    <span class="cpd-value" id="cpHSA">$0</span>
                  </div>
                  <div class="cpd-row">
                    <span class="cpd-label">Traditional IRA Contributions</span>
                    <span class="cpd-value" id="cpIRA">$0</span>
                  </div>
                  <div class="cpd-row">
                    <span class="cpd-label">Student Loan Interest</span>
                    <span class="cpd-value" id="cpStudentLoan">$0</span>
                  </div>
                  <div class="cpd-row">
                    <span class="cpd-label">Self-Employment Tax Deduction</span>
                    <span class="cpd-value" id="cpSETax">$0</span>
                  </div>
                  <div class="cpd-row total">
                    <span class="cpd-label">Total Adjustments</span>
                    <span class="cpd-value" id="cpTotalAdj">$0</span>
                  </div>
                </div>
              </div>

              <!-- AGI Line -->
              <div class="cp-agi">
                <span class="agi-label">Adjusted Gross Income (AGI)</span>
                <span class="agi-amount" id="cpAGI">$0</span>
                <span class="agi-note">Line 11 on Form 1040</span>
              </div>

              <!-- Section 3: Deductions -->
              <div class="cp-section">
                <div class="cps-header" data-toggle="deductionDetails">
                  <span class="cps-icon">âœ‚ï¸</span>
                  <span class="cps-title">Deductions</span>
                  <span class="cps-amount negative" id="cpDeductions">-$0</span>
                  <span class="cps-toggle">â–¼</span>
                </div>
                <div class="cps-details" id="deductionDetails">
                  <div class="cpd-comparison">
                    <div class="cpd-option" id="stdOption">
                      <div class="cpd-opt-header">
                        <span class="cpd-opt-icon">ðŸ“‹</span>
                        <span class="cpd-opt-name">Standard Deduction</span>
                        <span class="cpd-opt-badge" id="stdBadge">Selected</span>
                      </div>
                      <div class="cpd-opt-amount" id="cpStandardDed">$15,000</div>
                      <div class="cpd-opt-breakdown">
                        <div class="cpd-opt-row">
                          <span>Base amount (<span id="stdFilingStatus">Single</span>)</span>
                          <span id="stdBase">$15,000</span>
                        </div>
                        <div class="cpd-opt-row" id="stdAge65Row" style="display: none;">
                          <span>Age 65+ additional</span>
                          <span id="stdAge65">$0</span>
                        </div>
                        <div class="cpd-opt-row" id="stdBlindRow" style="display: none;">
                          <span>Blindness additional</span>
                          <span id="stdBlind">$0</span>
                        </div>
                      </div>
                    </div>
                    <div class="cpd-vs">VS</div>
                    <div class="cpd-option" id="itemOption">
                      <div class="cpd-opt-header">
                        <span class="cpd-opt-icon">ðŸ“</span>
                        <span class="cpd-opt-name">Itemized Deductions</span>
                        <span class="cpd-opt-badge hidden" id="itemBadge">Selected</span>
                      </div>
                      <div class="cpd-opt-amount" id="cpItemizedDed">$0</div>
                      <div class="cpd-opt-breakdown">
                        <div class="cpd-opt-row">
                          <span>Mortgage Interest</span>
                          <span id="itemMortgage">$0</span>
                        </div>
                        <div class="cpd-opt-row">
                          <span>State & Local Taxes (SALT)</span>
                          <span id="itemSALT">$0</span>
                        </div>
                        <div class="cpd-opt-row" id="saltWarning" style="display: none;">
                          <span class="warning-text">âš ï¸ SALT capped at $10,000</span>
                          <span></span>
                        </div>
                        <div class="cpd-opt-row">
                          <span>Charitable Contributions</span>
                          <span id="itemCharity">$0</span>
                        </div>
                        <div class="cpd-opt-row">
                          <span>Medical Expenses (>7.5% AGI)</span>
                          <span id="itemMedical">$0</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="cpd-recommendation" id="dedRecommendation">
                    <span class="rec-icon">âœ…</span>
                    <span class="rec-text" id="dedRecText">Standard deduction saves you more!</span>
                    <span class="rec-savings" id="dedRecSavings">+$0</span>
                  </div>
                </div>
              </div>

              <!-- Taxable Income Line -->
              <div class="cp-taxable">
                <span class="taxable-label">Taxable Income</span>
                <span class="taxable-amount" id="cpTaxableIncome">$0</span>
                <span class="taxable-note">AGI minus deductions</span>
              </div>

              <!-- Section 4: Tax Calculation -->
              <div class="cp-section">
                <div class="cps-header" data-toggle="taxCalcDetails">
                  <span class="cps-icon">ðŸ§®</span>
                  <span class="cps-title">Tax Calculation</span>
                  <span class="cps-amount" id="cpTaxBeforeCredits">$0</span>
                  <span class="cps-toggle">â–¼</span>
                </div>
                <div class="cps-details" id="taxCalcDetails">
                  <div class="cpd-brackets">
                    <div class="bracket-header">Tax Bracket Breakdown</div>
                    <div id="bracketBreakdown">
                      <!-- Dynamically populated -->
                    </div>
                  </div>
                  <div class="cpd-row">
                    <span class="cpd-label">Filing Status</span>
                    <span class="cpd-value" id="cpFilingStatus">Single</span>
                  </div>
                  <div class="cpd-row">
                    <span class="cpd-label">Marginal Tax Rate</span>
                    <span class="cpd-value" id="cpMarginalRate">22%</span>
                  </div>
                  <div class="cpd-row">
                    <span class="cpd-label">Effective Tax Rate</span>
                    <span class="cpd-value" id="cpEffectiveRate">12.5%</span>
                  </div>
                  <div class="cpd-row total">
                    <span class="cpd-label">Tax Before Credits</span>
                    <span class="cpd-value" id="cpTaxBefore">$0</span>
                  </div>
                </div>
              </div>

              <!-- Section 5: Credits -->
              <div class="cp-section">
                <div class="cps-header" data-toggle="creditDetails">
                  <span class="cps-icon">ðŸŽ</span>
                  <span class="cps-title">Tax Credits</span>
                  <span class="cps-amount negative" id="cpCredits">-$0</span>
                  <span class="cps-toggle">â–¼</span>
                </div>
                <div class="cps-details" id="creditDetails">
                  <div class="cpd-row" id="creditCTCRow">
                    <span class="cpd-label">Child Tax Credit (<span id="ctcChildCount">0</span> children)</span>
                    <span class="cpd-value" id="cpCTC">$0</span>
                  </div>
                  <div class="cpd-row" id="creditChildcareRow">
                    <span class="cpd-label">Child and Dependent Care Credit</span>
                    <span class="cpd-value" id="cpChildcare">$0</span>
                  </div>
                  <div class="cpd-row" id="creditEITCRow">
                    <span class="cpd-label">Earned Income Tax Credit</span>
                    <span class="cpd-value" id="cpEITC">$0</span>
                  </div>
                  <div class="cpd-row" id="creditEducationRow">
                    <span class="cpd-label">Education Credits (AOTC/LLC)</span>
                    <span class="cpd-value" id="cpEducation">$0</span>
                  </div>
                  <div class="cpd-row" id="creditSaverRow">
                    <span class="cpd-label">Saver's Credit</span>
                    <span class="cpd-value" id="cpSaver">$0</span>
                  </div>
                  <div class="cpd-row" id="creditEnergyRow">
                    <span class="cpd-label">Energy Credits</span>
                    <span class="cpd-value" id="cpEnergy">$0</span>
                  </div>
                  <div class="cpd-row total">
                    <span class="cpd-label">Total Credits</span>
                    <span class="cpd-value" id="cpTotalCredits">$0</span>
                  </div>
                  <div class="cpd-refundable-note">
                    <span class="note-icon">â„¹ï¸</span>
                    <span>Refundable credits: <span id="refundableAmount">$0</span> (can result in refund even if no tax owed)</span>
                  </div>
                </div>
              </div>

              <!-- Final Tax Line -->
              <div class="cp-final-tax">
                <span class="ft-label">Total Federal Tax Liability</span>
                <span class="ft-amount" id="cpFinalTax">$0</span>
              </div>

              <!-- Section 6: Payments & Withholding -->
              <div class="cp-section">
                <div class="cps-header" data-toggle="paymentDetails">
                  <span class="cps-icon">ðŸ’³</span>
                  <span class="cps-title">Payments & Withholding</span>
                  <span class="cps-amount" id="cpPayments">$0</span>
                  <span class="cps-toggle">â–¼</span>
                </div>
                <div class="cps-details" id="paymentDetails">
                  <div class="cpd-row">
                    <span class="cpd-label">Federal Income Tax Withheld (W-2)</span>
                    <span class="cpd-value" id="cpW2Withheld">$0</span>
                  </div>
                  <div class="cpd-row">
                    <span class="cpd-label">Estimated Tax Payments</span>
                    <span class="cpd-value" id="cpEstimated">$0</span>
                  </div>
                  <div class="cpd-row">
                    <span class="cpd-label">Other Withholding (1099)</span>
                    <span class="cpd-value" id="cp1099Withheld">$0</span>
                  </div>
                  <div class="cpd-row total">
                    <span class="cpd-label">Total Payments</span>
                    <span class="cpd-value" id="cpTotalPayments">$0</span>
                  </div>
                </div>
              </div>

              <!-- Final Result -->
              <div class="cp-result" id="cpResult">
                <div class="cpr-box refund" id="cprRefund">
                  <div class="cpr-label">Federal Refund</div>
                  <div class="cpr-amount" id="cprRefundAmount">$0</div>
                  <div class="cpr-explanation" id="cprRefundExpl">You overpaid by this amount</div>
                </div>
                <div class="cpr-box owed hidden" id="cprOwed">
                  <div class="cpr-label">Amount Owed</div>
                  <div class="cpr-amount" id="cprOwedAmount">$0</div>
                  <div class="cpr-explanation" id="cprOwedExpl">Due by April 15, 2026</div>
                </div>
              </div>
            </div>

            <!-- State Tax Section -->
            <div class="computation-panel state-panel" id="stateTaxPanel">
              <div class="cp-header">
                <h3>State Tax: <span id="stateNameDisplay">California</span></h3>
                <span class="cp-badge" id="stateTaxType">Progressive</span>
              </div>
              <div class="cp-state-summary">
                <div class="state-row">
                  <span>State Taxable Income</span>
                  <span id="stateTaxableIncome">$0</span>
                </div>
                <div class="state-row">
                  <span>State Tax</span>
                  <span id="stateTaxAmount">$0</span>
                </div>
                <div class="state-row">
                  <span>State Withholding</span>
                  <span id="stateWithholding">$0</span>
                </div>
                <div class="state-row result">
                  <span id="stateResultLabel">State Refund</span>
                  <span id="stateResultAmount">$0</span>
                </div>
              </div>
            </div>

            <!-- Filing Status Comparison Modal -->
            <div class="comparison-modal hidden" id="filingComparisonModal">
              <div class="modal-content">
                <div class="modal-header">
                  <h3>Filing Status Comparison</h3>
                  <button class="modal-close" id="closeFilingComparison">Ã—</button>
                </div>
                <div class="modal-body">
                  <p class="modal-intro">See how different filing statuses affect your tax liability:</p>
                  <div class="comparison-grid" id="filingComparisonGrid">
                    <!-- Dynamically populated -->
                  </div>
                  <div class="comparison-note">
                    <span class="note-icon">âš ï¸</span>
                    <span>You can only select filing statuses you qualify for based on your situation.</span>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" id="cancelFilingChange">Keep Current</button>
                  <button class="btn btn-primary" id="applyFilingChange">Apply Selected Status</button>
                </div>
              </div>
            </div>

            <!-- State Comparison Modal -->
            <div class="comparison-modal hidden" id="stateComparisonModal">
              <div class="modal-content wide">
                <div class="modal-header">
                  <h3>State Tax Comparison</h3>
                  <button class="modal-close" id="closeStateComparison">Ã—</button>
                </div>
                <div class="modal-body">
                  <p class="modal-intro">See how your tax would differ in other states:</p>
                  <div class="state-comparison-grid" id="stateComparisonGrid">
                    <!-- Dynamically populated -->
                  </div>
                  <div class="comparison-insight" id="stateInsight">
                    <!-- Dynamically populated -->
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" id="closeStateModal">Close</button>
                </div>
              </div>
            </div>

            <!-- Navigation -->
            <div class="nav-buttons">
              <button class="btn btn-secondary" id="btnBack6">Back to Credits</button>
              <button class="btn btn-success btn-lg" id="btnFinish">
                <span class="btn-icon">âœ“</span>
                Complete & File Return
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Refund Card -->
        <div class="refund-card">
          <div class="refund-label">Estimated Refund</div>
          <div class="refund-amount positive" id="refundAmount">$0</div>
          <div class="refund-breakdown">
            <div class="breakdown-row">
              <span class="breakdown-label">Federal</span>
              <span class="breakdown-value positive" id="federalRefund">$0</span>
            </div>
            <div class="breakdown-row">
              <span class="breakdown-label">State</span>
              <span class="breakdown-value" id="stateRefund">â€”</span>
            </div>
          </div>

          <!-- Inline Savings Alert (Prompt 5) -->
          <div class="inline-savings-alert" id="inlineSavingsAlert">
            <button class="inline-savings-alert-dismiss" onclick="dismissInlineSavingsAlert()">Ã—</button>
            <div class="inline-savings-alert-content">
              <div class="inline-savings-alert-icon">ðŸ’¡</div>
              <div class="inline-savings-alert-text">
                <div class="inline-savings-alert-title">You could reduce this by $0</div>
                <div class="inline-savings-alert-subtitle">See how with optimization strategies</div>
              </div>
              <button class="inline-savings-alert-cta" onclick="openTaxOptimizer(); markOptimizerClicked();">
                Show Me How â†’
              </button>
            </div>
          </div>
        </div>

        <!-- Smart Insights Sidebar -->
        <div class="smart-insights-card" id="smartInsightsCard">
          <div class="insights-header">
            <div class="insights-header-left">
              <div class="insights-icon">ðŸ§ </div>
              <div class="insights-title">Smart Insights</div>
            </div>
            <span class="insights-badge" id="insightsBadge" style="display: none;">0</span>
          </div>

          <!-- Enhanced Header with Total Potential (Prompt 3) -->
          <div class="insights-header-enhanced" id="insightsHeaderEnhanced" style="display: none;">
            <div class="insights-header-title">
              ðŸ’¡ Total Potential
            </div>
            <div class="insights-total-potential">
              <span class="amount" id="insightsTotalPotential">$0</span>
            </div>
          </div>

          <!-- Loading State -->
          <div class="insights-loading" id="insightsLoading" style="display: none;">
            <div class="spinner"></div>
            <div>Analyzing your data...</div>
          </div>

          <!-- Enhanced Empty State -->
          <div class="insights-empty insights-empty-enhanced" id="insightsEmpty">
            <div class="insights-empty-illustration"></div>
            <div class="insights-empty-title">Your Tax Savings Await</div>
            <div class="insights-empty-subtitle">
              Personalized recommendations will appear here as you enter your information
            </div>

            <div class="insights-empty-checklist" id="insightsChecklist">
              <div class="insights-empty-checklist-item" data-check="income">
                <span class="check-icon">â—‹</span>
                <span>Income information</span>
              </div>
              <div class="insights-empty-checklist-item" data-check="filing">
                <span class="check-icon">â—‹</span>
                <span>Filing status</span>
              </div>
              <div class="insights-empty-checklist-item" data-check="deductions">
                <span class="check-icon">â—‹</span>
                <span>Deductions</span>
              </div>
            </div>

            <button class="insights-get-started-btn" onclick="scrollToFirstInput()">
              Get Started
              <span>â†’</span>
            </button>

            <!-- Sample Insight Preview -->
            <div class="sample-insight-container">
              <div class="sample-insight-label">Sample Insight</div>
              <div class="sample-insight-card">
                <div class="sample-insight-title">Maximize IRA Contributions</div>
                <div class="sample-insight-desc">Most users save by contributing to retirement accounts</div>
                <div class="sample-insight-savings">Average savings: $1,540</div>
              </div>
            </div>
          </div>

          <!-- Insights Container -->
          <div id="insightsContainer" style="display: none;"></div>

          <!-- Total Potential Savings -->
          <div class="insights-total-savings" id="insightsTotalSavings" style="display: none;">
            <span class="total-savings-label">Total potential savings</span>
            <span class="total-savings-amount" id="totalSavingsAmount">$0</span>
          </div>

          <!-- Savings Meter (Prompt 8) -->
          <div class="savings-meter" id="savingsMeter" style="display: none;">
            <div class="savings-meter-header">
              <span class="savings-meter-title">Optimization Progress</span>
              <span class="savings-meter-value">$0 / $0</span>
            </div>
            <div class="savings-meter-bar">
              <div class="savings-meter-fill" style="width: 0%;"></div>
            </div>
            <div class="savings-meter-milestones">
              <span>$0</span>
              <span>$5k</span>
              <span>$10k+</span>
            </div>
          </div>
        </div>

        <!-- Legacy Tips Card (hidden by default) -->
        <div class="tips-card" id="tipsCard" style="display: none;">
          <div class="tips-header">
            <div class="tips-icon">ðŸ’¡</div>
            <div class="tips-title">Tax Saving Tips</div>
          </div>
          <div id="tipsList">
            <div class="tip-item">
              <div class="tip-icon">âœ“</div>
              <div class="tip-text">Upload your W-2 to get started. We'll find deductions automatically.</div>
            </div>
            <div class="tip-item">
              <div class="tip-icon">âœ“</div>
              <div class="tip-text">Standard deduction for single filers: <span class="tip-savings">$15,000</span></div>
            </div>
          </div>
        </div>

        <!-- Info Card -->
        <div class="info-card">
          <div class="info-header">
            <div class="info-icon">ðŸ“‹</div>
            <div class="info-title">Your Information</div>
          </div>
          <div class="info-row">
            <span class="info-label">Filing Status</span>
            <span class="info-value" id="infoStatus">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">State</span>
            <span class="info-value" id="infoState">â€”</span>
          </div>
          <div class="info-row">
            <span class="info-label">Documents</span>
            <span class="info-value" id="infoDocuments">0</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg,.tiff" style="display:none" multiple />

  <script>
    // ============ STATE MANAGEMENT ============
    const state = {
      currentStep: 1,
      currentSubstep: 'welcome', // welcome, 1a, 1b-widow, 1b-married, 1c, 1c-dependents, 1d-hoh, 1e-result, 1f-personal
      filingStatus: null,
      stateOfResidence: null,
      documents: [],
      taxData: {
        wages: 0,
        federalWithheld: 0,
        otherIncome: 0,
        stateWages: 0,
        stateWithheld: 0,
      },
      deductions: {},
      credits: {},
      // Wizard answers
      wizard: {
        maritalStatus: null,      // single, married, widowed
        spouseDeathYear: null,    // 2025, 2024, 2023, before_2023
        marriedFilingChoice: null, // joint, separate
        hasDependents: null,      // yes, no
        paidHouseholdCosts: null, // yes, no
        isReturningUser: false,
        importSource: null,
      },
      // Personal info
      personal: {
        firstName: '',
        middleInitial: '',
        lastName: '',
        ssn: '',
        dob: '',
        street: '',
        city: '',
        state: '',
        zip: '',
        age65: false,
        blind: false,
        // Spouse info (for MFJ)
        spouseFirstName: '',
        spouseMiddleInitial: '',
        spouseLastName: '',
        spouseSsn: '',
        spouseDob: '',
        spouseAge65: false,
        spouseBlind: false,
      },
      // Dependents
      dependents: [],
    };

    // ============ INPUT VALIDATION HELPERS ============

    /**
     * Validate SSN format (XXX-XX-XXXX)
     */
    function validateSSN(ssn) {
      if (!ssn) return { valid: true, message: '' }; // Optional
      const cleaned = ssn.replace(/[^0-9]/g, '');
      if (cleaned.length !== 9) {
        return { valid: false, message: 'SSN must be 9 digits' };
      }
      // IRS rules: Can't start with 000, 666, or 9xx
      if (cleaned.startsWith('000') || cleaned.startsWith('666') || cleaned.startsWith('9')) {
        return { valid: false, message: 'Invalid SSN format' };
      }
      return { valid: true, message: '', formatted: `${cleaned.slice(0,3)}-${cleaned.slice(3,5)}-${cleaned.slice(5)}` };
    }

    /**
     * Validate currency input
     */
    function validateCurrency(value, fieldName, options = {}) {
      const { min = 0, max = 999999999, required = false } = options;
      if (!value && value !== 0) {
        return required ? { valid: false, message: `${fieldName} is required` } : { valid: true };
      }
      const num = parseFloat(String(value).replace(/[,$]/g, ''));
      if (isNaN(num)) {
        return { valid: false, message: `${fieldName} must be a number` };
      }
      if (num < min) {
        return { valid: false, message: `${fieldName} cannot be negative` };
      }
      if (num > max) {
        return { valid: false, message: `${fieldName} exceeds maximum allowed (${formatCurrency(max)})` };
      }
      return { valid: true, value: num };
    }

    /**
     * Validate date format
     */
    function validateDate(dateStr, fieldName) {
      if (!dateStr) return { valid: true };
      const date = new Date(dateStr);
      if (isNaN(date.getTime())) {
        return { valid: false, message: `${fieldName} is not a valid date` };
      }
      const year = date.getFullYear();
      if (year < 1900 || year > 2025) {
        return { valid: false, message: `${fieldName} year must be between 1900 and 2025` };
      }
      return { valid: true, value: date };
    }

    /**
     * Show validation error on an input field
     */
    function showFieldError(inputId, message) {
      const input = document.getElementById(inputId);
      if (!input) return;

      // Add error styling
      input.classList.add('input-error');

      // Find or create error message element
      let errorEl = input.parentElement.querySelector('.field-error-message');
      if (!errorEl) {
        errorEl = document.createElement('div');
        errorEl.className = 'field-error-message';
        input.parentElement.appendChild(errorEl);
      }
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    /**
     * Clear validation error from an input field
     */
    function clearFieldError(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;

      input.classList.remove('input-error');
      const errorEl = input.parentElement.querySelector('.field-error-message');
      if (errorEl) {
        errorEl.style.display = 'none';
      }
    }

    /**
     * Show toast notification for user feedback
     */
    function showToast(message, type = 'info', duration = 4000) {
      // Remove existing toast
      const existing = document.querySelector('.toast-notification');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = `toast-notification toast-${type}`;
      toast.innerHTML = `
        <div class="toast-content">
          <span class="toast-icon">${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : type === 'warning' ? 'âš ' : 'â„¹'}</span>
          <span class="toast-message">${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
      `;

      document.body.appendChild(toast);

      // Animate in
      requestAnimationFrame(() => toast.classList.add('toast-visible'));

      // Auto dismiss
      if (duration > 0) {
        setTimeout(() => {
          toast.classList.remove('toast-visible');
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }
    }

    /**
     * Handle API error response with user-friendly display
     */
    function handleApiError(response) {
      if (response.error) {
        const message = response.message || 'An error occurred. Please try again.';
        showToast(message, 'error', 6000);

        // Log details for debugging
        if (response.details) {
          console.error('API Error Details:', response.details);
        }
        return true;
      }
      return false;
    }

    // ============ SMART VALIDATION SYSTEM ============
    // Implements 100+ conditional rules for field visibility and validation

    // Cache for field states to avoid redundant API calls
    let fieldStatesCache = null;
    let validationDebounceTimer = null;

    /**
     * Get current form data for validation
     */
    function getValidationContext() {
      return {
        // Personal info
        firstName: state.personal.firstName,
        lastName: state.personal.lastName,
        ssn: state.personal.ssn,
        dob: state.personal.dob,
        isBlind: state.personal.blind,

        // Spouse info
        spouseFirstName: state.personal.spouseFirstName,
        spouseLastName: state.personal.spouseLastName,
        spouseSsn: state.personal.spouseSsn,
        spouseDob: state.personal.spouseDob,
        spouseIsBlind: state.personal.spouseBlind,

        // Filing status
        filingStatus: state.filingStatus,

        // Address
        street: state.personal.street,
        city: state.personal.city,
        state: state.personal.state,
        zipCode: state.personal.zip,
        stateOfResidence: state.stateOfResidence || state.personal.state,

        // Dependents
        dependents: state.dependents,

        // Income
        wages: state.taxData.wages || 0,
        wagesSecondary: state.taxData.wagesSecondary || 0,
        interestIncome: state.taxData.interestIncome || 0,
        dividendIncome: state.taxData.dividendIncome || 0,
        capitalGainsLong: state.taxData.capitalGains || 0,
        businessIncome: state.taxData.businessIncome || 0,
        businessExpenses: state.taxData.businessExpenses || 0,
        retirementIncome: state.taxData.retirementDistributions || 0,
        socialSecurity: state.taxData.socialSecurity || 0,
        unemployment: state.taxData.unemployment || 0,
        otherIncome: state.taxData.otherIncome || 0,

        // Withholding
        federalWithheld: state.taxData.federalWithheld || 0,
        stateWithheld: state.taxData.stateWithheld || 0,

        // Deductions
        useStandardDeduction: state.deductions.useStandard !== false,
        medicalExpenses: state.deductions.medical || 0,
        stateLocalTaxes: state.deductions.salt || 0,
        mortgageInterest: state.deductions.mortgageInterest || 0,
        charitableCash: state.deductions.charitableCash || 0,
        studentLoanInterest: state.deductions.studentLoanInterest || 0,
        hsaContribution: state.deductions.hsaContribution || 0,
        iraContribution: state.deductions.iraDeduction || 0,

        // Credits
        childCareExpenses: state.credits.childCare || 0,
        educationExpenses: state.credits.educationCredit || 0,
      };
    }

    /**
     * Call validation API and update field states
     */
    async function updateFieldStates() {
      try {
        const context = getValidationContext();
        const response = await fetch('/api/validate/fields', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(context),
        });

        const data = await response.json();
        if (data.error) {
          console.error('Validation API error:', data);
          return;
        }

        // Cache the results
        fieldStatesCache = data;

        // Apply field visibility
        applyFieldVisibility(data.fields);

        // Update computed values
        updateComputedValues(data.computed);

        // Show validation messages
        displayValidationMessages(data.validation);

        // Apply smart defaults
        applySmartDefaults(data.defaults);

        return data;
      } catch (error) {
        console.error('Error calling validation API:', error);
      }
    }

    /**
     * Debounced version of updateFieldStates
     */
    function debouncedUpdateFieldStates(delay = 300) {
      clearTimeout(validationDebounceTimer);
      validationDebounceTimer = setTimeout(updateFieldStates, delay);
    }

    /**
     * Apply field visibility based on validation response
     */
    function applyFieldVisibility(fields) {
      if (!fields) return;

      // Map of field IDs to DOM element selectors
      const fieldMappings = {
        // Spouse fields
        'spouse_first_name': ['#spouseFirstName', '.spouse-info-section'],
        'spouse_last_name': ['#spouseLastName'],
        'spouse_ssn': ['#spouseSsn'],
        'spouse_dob': ['#spouseDob'],
        'spouse_is_blind': ['#spouseBlind', '.spouse-blind-group'],

        // Age-related fields - HIDDEN because auto-calculated from DOB
        'is_65_or_older': ['#age65Checkbox', '.age-65-group'],
        'spouse_is_65_or_older': ['#spouseAge65Checkbox', '.spouse-age-65-group'],

        // Business fields
        'business_expenses': ['#businessExpenses', '.business-expenses-group'],
        'self_employment_tax_info': ['.se-tax-info'],

        // Investment fields
        'qualified_dividends': ['#qualifiedDividends', '.qualified-dividends-group'],

        // Retirement fields
        'early_withdrawal_penalty': ['.early-withdrawal-group'],
        'rmd_notice': ['.rmd-notice'],

        // Social Security
        'social_security': ['#socialSecurity', '.social-security-group'],
        'ss_taxable_info': ['.ss-taxable-info'],

        // Deduction fields
        'medical_expenses': ['#medical', '.medical-group'],
        'state_local_taxes': ['#salt', '.salt-group'],
        'mortgage_interest': ['#mortgageInterest', '.mortgage-group'],
        'charitable_cash': ['#charitableCash', '.charitable-group'],

        // Credit fields
        'child_care_expenses': ['#childCare', '.child-care-group'],
        'child_care_provider_name': ['#childCareProvider', '.provider-name-group'],
        'child_care_provider_ein': ['#childCareEin', '.provider-ein-group'],
        'education_expenses': ['#educationCredit', '.education-group'],
        'student_name': ['#studentName', '.student-name-group'],
        'school_name': ['#schoolName', '.school-name-group'],

        // State tax
        'state_withholding': ['#stateWithheld', '.state-withholding-group'],
      };

      Object.entries(fields).forEach(([fieldId, fieldState]) => {
        const selectors = fieldMappings[fieldId];
        if (!selectors) return;

        selectors.forEach(selector => {
          const elements = document.querySelectorAll(selector);
          elements.forEach(el => {
            if (fieldState.visible === false) {
              el.style.display = 'none';
              el.classList.add('field-hidden');
            } else {
              el.style.display = '';
              el.classList.remove('field-hidden');
            }

            // Update required indicator
            if (fieldState.requirement === 'mandatory' || fieldState.requirement === 'conditional') {
              el.classList.add('field-required');
            } else {
              el.classList.remove('field-required');
            }

            // Update hint text
            if (fieldState.hint && el.querySelector('.input-hint')) {
              el.querySelector('.input-hint').textContent = fieldState.hint;
            }
          });
        });
      });
    }

    /**
     * Update computed values in the UI
     */
    function updateComputedValues(computed) {
      if (!computed) return;

      // Update age display - auto-calculated from DOB
      if (computed.age > 0) {
        // Auto-set the 65+ checkbox based on DOB
        const is65 = computed.is65OrOlder;
        state.personal.age65 = is65;

        // Hide the 65+ checkbox since it's auto-calculated
        const age65Elements = document.querySelectorAll('.age-65-manual');
        age65Elements.forEach(el => el.style.display = 'none');

        // Show age info instead
        const ageInfoEl = document.getElementById('calculatedAge');
        if (ageInfoEl) {
          ageInfoEl.textContent = `Age: ${computed.age}${is65 ? ' (65+ additional deduction applies)' : ''}`;
          ageInfoEl.style.display = 'block';
        }

        // If 65+, show a notification
        if (is65) {
          const ageNotice = document.getElementById('age65Notice');
          if (ageNotice) {
            ageNotice.textContent = 'âœ“ Additional standard deduction for age 65+ will be applied automatically';
            ageNotice.style.display = 'block';
          }
        }
      }

      // Same for spouse age
      if (computed.spouseAge > 0 && state.filingStatus === 'married_joint') {
        state.personal.spouseAge65 = computed.spouseIs65OrOlder;

        const spouseAge65Elements = document.querySelectorAll('.spouse-age-65-manual');
        spouseAge65Elements.forEach(el => el.style.display = 'none');
      }

      // Update income display
      if (computed.totalIncome > 0) {
        const totalIncomeEl = document.getElementById('computedTotalIncome');
        if (totalIncomeEl) {
          totalIncomeEl.textContent = formatCurrency(computed.totalIncome);
        }
      }

      // Update qualifying children count for CTC
      if (computed.numQualifyingChildren > 0) {
        const ctcNotice = document.getElementById('ctcEligibilityNotice');
        if (ctcNotice) {
          ctcNotice.innerHTML = `âœ“ ${computed.numQualifyingChildren} child(ren) may qualify for Child Tax Credit (up to $${2000 * computed.numQualifyingChildren})`;
          ctcNotice.style.display = 'block';
        }
      }
    }

    /**
     * Display validation messages in the UI
     */
    function displayValidationMessages(validation) {
      if (!validation) return;

      // Clear existing messages
      document.querySelectorAll('.validation-message').forEach(el => el.remove());

      // Show errors
      validation.errors?.forEach(error => {
        if (error.field) {
          showFieldError(error.field, error.message);
        }
      });

      // Show warnings as toasts (non-blocking)
      validation.warnings?.slice(0, 2).forEach(warning => {
        showToast(warning.message, 'warning', 5000);
      });

      // Show info messages in a subtle way
      const infoContainer = document.getElementById('validationInfo');
      if (infoContainer && validation.info?.length > 0) {
        infoContainer.innerHTML = validation.info
          .map(info => `<div class="info-notice">â„¹ ${info.message}</div>`)
          .join('');
        infoContainer.style.display = 'block';
      }
    }

    /**
     * Apply smart defaults based on validation response
     */
    function applySmartDefaults(defaults) {
      if (!defaults) return;

      // Update standard deduction recommendation
      if (defaults.standard_deduction_amount && defaults.itemized_deduction_amount) {
        const stdAmt = defaults.standard_deduction_amount;
        const itemAmt = defaults.itemized_deduction_amount;

        const deductionAdvice = document.getElementById('deductionAdvice');
        if (deductionAdvice) {
          if (stdAmt >= itemAmt) {
            deductionAdvice.innerHTML = `
              <strong>Recommendation:</strong> Standard deduction (${formatCurrency(stdAmt)}) is better than itemized (${formatCurrency(itemAmt)})
            `;
          } else {
            deductionAdvice.innerHTML = `
              <strong>Recommendation:</strong> Itemized deductions (${formatCurrency(itemAmt)}) saves you more than standard (${formatCurrency(stdAmt)})
            `;
          }
          deductionAdvice.style.display = 'block';
        }
      }
    }

    /**
     * Calculate age from date of birth
     */
    function calculateAgeFromDOB(dobString) {
      if (!dobString) return null;
      try {
        const dob = new Date(dobString);
        const taxYearEnd = new Date(2025, 11, 31);
        let age = taxYearEnd.getFullYear() - dob.getFullYear();
        const monthDiff = taxYearEnd.getMonth() - dob.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && taxYearEnd.getDate() < dob.getDate())) {
          age--;
        }
        return age;
      } catch (e) {
        return null;
      }
    }

    /**
     * Handle DOB change - auto-calculate age and update UI
     */
    function handleDOBChange(dobInput, isSpouse = false) {
      const dob = dobInput.value;
      const age = calculateAgeFromDOB(dob);

      if (age !== null) {
        if (isSpouse) {
          state.personal.spouseAge65 = age >= 65;

          // Hide manual 65+ checkbox for spouse
          document.querySelectorAll('.spouse-age-65-manual').forEach(el => el.style.display = 'none');

          // Show computed age
          const spouseAgeEl = document.getElementById('spouseCalculatedAge');
          if (spouseAgeEl) {
            spouseAgeEl.textContent = `Spouse age: ${age}${age >= 65 ? ' (65+ deduction applies)' : ''}`;
            spouseAgeEl.style.display = 'block';
          }
        } else {
          state.personal.age65 = age >= 65;

          // Hide manual 65+ checkbox
          document.querySelectorAll('.age-65-manual').forEach(el => el.style.display = 'none');

          // Show computed age
          const ageEl = document.getElementById('calculatedAge');
          if (ageEl) {
            ageEl.textContent = `Your age: ${age}${age >= 65 ? ' (65+ deduction applies)' : ''}`;
            ageEl.style.display = 'block';
          }
        }

        // Trigger full validation update
        debouncedUpdateFieldStates();
      }
    }

    /**
     * Handle filing status change - show/hide spouse fields
     */
    function handleFilingStatusChange(newStatus) {
      state.filingStatus = newStatus;

      const isMarried = newStatus === 'married_joint' || newStatus === 'married_separate';

      // Show/hide spouse section
      const spouseSection = document.querySelector('.spouse-info-section');
      if (spouseSection) {
        spouseSection.style.display = isMarried ? 'block' : 'none';
      }

      // Clear spouse data if not married
      if (!isMarried) {
        state.personal.spouseFirstName = '';
        state.personal.spouseLastName = '';
        state.personal.spouseSsn = '';
        state.personal.spouseDob = '';
        state.personal.spouseAge65 = false;
        state.personal.spouseBlind = false;
      }

      // Trigger full validation update
      debouncedUpdateFieldStates();
    }

    /**
     * Handle dependent add/remove - update CTC eligibility display
     */
    function handleDependentsChange() {
      const qualifyingChildren = state.dependents.filter(d => d.age < 17).length;

      // Update CTC notice
      const ctcNotice = document.getElementById('ctcEligibilityNotice');
      if (ctcNotice) {
        if (qualifyingChildren > 0) {
          ctcNotice.innerHTML = `âœ“ ${qualifyingChildren} child(ren) under 17 may qualify for Child Tax Credit (up to $${2000 * qualifyingChildren})`;
          ctcNotice.style.display = 'block';
        } else {
          ctcNotice.style.display = 'none';
        }
      }

      // Show/hide child care credit fields
      const hasYoungChildren = state.dependents.some(d => d.age < 13);
      const childCareSection = document.querySelector('.child-care-credit-section');
      if (childCareSection) {
        childCareSection.style.display = hasYoungChildren ? 'block' : 'none';
      }

      // Trigger full validation update
      debouncedUpdateFieldStates();
    }

    /**
     * Initialize smart validation on page load
     */
    function initSmartValidation() {
      // Add event listeners to key fields
      const dobInput = document.getElementById('dob');
      if (dobInput) {
        dobInput.addEventListener('change', (e) => handleDOBChange(e.target, false));
      }

      const spouseDobInput = document.getElementById('spouseDob');
      if (spouseDobInput) {
        spouseDobInput.addEventListener('change', (e) => handleDOBChange(e.target, true));
      }

      // Income fields - trigger validation on change
      const incomeFields = ['wages', 'interestIncome', 'dividendIncome', 'capitalGains', 'businessIncome', 'retirementDistributions', 'socialSecurity'];
      incomeFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('change', debouncedUpdateFieldStates);
          field.addEventListener('blur', debouncedUpdateFieldStates);
        }
      });

      // Run initial validation
      setTimeout(updateFieldStates, 500);
    }

    /**
     * Display recommendations from API response
     */
    function displayRecommendations(recommendations) {
      if (!recommendations || !recommendations.top_recommendations) return;

      const container = document.getElementById('recommendationsContainer');
      if (!container) return;

      let html = `
        <div class="recommendations-header">
          <h4>ðŸ’¡ Tax Optimization Tips</h4>
          ${recommendations.total_potential_savings > 0 ?
            `<span class="savings-badge">Potential savings: ${formatCurrency(recommendations.total_potential_savings)}</span>` : ''}
        </div>
        <p class="recommendations-summary">${recommendations.summary}</p>
        <div class="recommendations-list">
      `;

      for (const rec of recommendations.top_recommendations) {
        const priorityClass = rec.priority === 'high' ? 'priority-high' : rec.priority === 'medium' ? 'priority-medium' : 'priority-low';
        html += `
          <div class="recommendation-card ${priorityClass}">
            <div class="rec-header">
              <span class="rec-priority">${rec.priority.toUpperCase()}</span>
              <h5>${rec.title}</h5>
            </div>
            <p>${rec.description}</p>
            ${rec.potential_savings ? `<span class="rec-savings">Potential: ${formatCurrency(rec.potential_savings)}</span>` : ''}
          </div>
        `;
      }

      html += `</div>`;
      if (recommendations.count > 3) {
        html += `<button class="btn-see-all" onclick="loadAllRecommendations()">See all ${recommendations.count} recommendations</button>`;
      }

      container.innerHTML = html;
      container.style.display = 'block';
    }

    /**
     * Display progress indicator from API response
     */
    function displayProgress(progress) {
      if (!progress) return;

      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');

      if (progressBar) {
        progressBar.style.width = `${progress.percentage}%`;
        progressBar.setAttribute('aria-valuenow', progress.percentage);
      }

      if (progressText) {
        progressText.textContent = `${progress.completed}/${progress.total} steps complete`;
      }

      // Highlight next step if available
      if (progress.next_step) {
        const nextStepEl = document.getElementById(`step-${progress.next_step}`);
        if (nextStepEl) {
          nextStepEl.classList.add('next-step-highlight');
        }
      }
    }

    // ============ LOCAL STORAGE PERSISTENCE ============
    const STORAGE_KEY = 'taxflow_state';

    function saveStateToStorage() {
      try {
        const stateToSave = {
          filingStatus: state.filingStatus,
          stateOfResidence: state.stateOfResidence,
          taxData: state.taxData,
          deductions: state.deductions,
          credits: state.credits,
          wizard: state.wizard,
          personal: state.personal,
          dependents: state.dependents,
          currentStep: state.currentStep,
          currentSubstep: state.currentSubstep,
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
      } catch (e) {
        console.warn('Failed to save state to localStorage:', e);
      }
    }

    function loadStateFromStorage() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          Object.assign(state, parsed);
          return true;
        }
      } catch (e) {
        console.warn('Failed to load state from localStorage:', e);
      }
      return false;
    }

    function clearStateStorage() {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (e) {
        console.warn('Failed to clear localStorage:', e);
      }
    }

    // ============ DOM ELEMENTS ============
    const elements = {
      steps: document.querySelectorAll('.step'),
      stepViews: document.querySelectorAll('.step-view'),
      progressFill: document.getElementById('progressFill'),
      uploadZone: document.getElementById('uploadZone'),
      documentsList: document.getElementById('documentsList'),
      fileInput: document.getElementById('fileInput'),
      chatMessages: document.getElementById('chatMessages'),
      chatInput: document.getElementById('chatInput'),
      refundAmount: document.getElementById('refundAmount'),
      federalRefund: document.getElementById('federalRefund'),
      stateRefund: document.getElementById('stateRefund'),
      // New elements
      welcomeModal: document.getElementById('welcomeModal'),
      importModal: document.getElementById('importModal'),
      dependentsList: document.getElementById('dependentsList'),
      dependentFormTemplate: document.getElementById('dependentFormTemplate'),
    };

    // ============ STEP NAVIGATION ============
    function goToStep(stepNum) {
      state.currentStep = stepNum;

      // Update progress bar (6 steps now)
      const progress = ((stepNum - 1) / 5) * 100;
      elements.progressFill.style.width = progress + '%';

      // Update step dots
      elements.steps.forEach((step, i) => {
        step.classList.remove('active', 'completed');
        if (i + 1 < stepNum) step.classList.add('completed');
        if (i + 1 === stepNum) step.classList.add('active');
      });

      // Show current step view
      elements.stepViews.forEach(view => view.classList.add('hidden'));
      const stepEl = document.getElementById('step' + stepNum);
      if (stepEl) stepEl.classList.remove('hidden');

      // Step-specific actions
      if (stepNum === 1) {
        // Check if wizard was completed
        if (state.filingStatus) {
          // Wizard done, show personal info
          showSubstep('1f-personal');
        } else {
          // Show welcome modal for new users
          showWelcomeModal();
        }
      } else if (stepNum === 3) {
        initChat();
      } else if (stepNum === 5) {
        updateCreditsSummary();
      } else if (stepNum === 6) {
        loadSummary();
      }
    }

    // ============ WELCOME MODAL ============
    function showWelcomeModal() {
      elements.welcomeModal.classList.remove('hidden');
      document.getElementById('step1').classList.add('hidden');
    }

    function hideWelcomeModal() {
      elements.welcomeModal.classList.add('hidden');
    }

    // Welcome option click handlers
    document.querySelectorAll('.welcome-option').forEach(option => {
      option.addEventListener('click', () => {
        const type = option.dataset.type;

        if (type === 'new') {
          // New user - start wizard
          state.wizard.isReturningUser = false;
          hideWelcomeModal();
          showSubstep('1a');
        } else if (type === 'returning') {
          // Returning user - simulate import from TaxFlow
          state.wizard.isReturningUser = true;
          hideWelcomeModal();
          // Show a loading state then skip to personal info
          simulateReturningUserImport();
        } else if (type === 'import') {
          // Import from another service
          hideWelcomeModal();
          elements.importModal.classList.remove('hidden');
        }
      });
    });

    // Import modal handlers
    document.querySelectorAll('.import-option').forEach(option => {
      option.addEventListener('click', () => {
        const source = option.dataset.source;
        state.wizard.importSource = source;

        // Highlight selected option
        document.querySelectorAll('.import-option').forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');

        // Show file upload area
        document.getElementById('importUpload').classList.remove('hidden');
      });
    });

    document.getElementById('closeImport')?.addEventListener('click', () => {
      elements.importModal.classList.add('hidden');
      showWelcomeModal();
    });

    document.getElementById('skipImport')?.addEventListener('click', () => {
      elements.importModal.classList.add('hidden');
      showSubstep('1a');
    });

    document.getElementById('importFileInput')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        document.getElementById('importStatus').innerHTML =
          `<span class="import-success">âœ“ ${file.name} loaded. Analyzing...</span>`;

        // Simulate import processing
        setTimeout(() => {
          document.getElementById('importStatus').innerHTML =
            `<span class="import-success">âœ“ Import complete! Found prior year data.</span>`;
          setTimeout(() => {
            elements.importModal.classList.add('hidden');
            showSubstep('1a');
          }, 1000);
        }, 1500);
      }
    });

    function simulateReturningUserImport() {
      // Show step1 with a loading indicator
      document.getElementById('step1').classList.remove('hidden');
      hideAllSubsteps();

      // Create loading element
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'importLoading';
      loadingDiv.className = 'wizard-card';
      loadingDiv.innerHTML = `
        <div class="result-header" style="text-align: center;">
          <div class="result-icon">ðŸ”„</div>
          <h3>Importing your information from last year...</h3>
          <p style="color: var(--gray-600); margin-top: 16px;">This will just take a moment</p>
        </div>
      `;
      document.querySelector('#step1 .step-header').after(loadingDiv);

      // Simulate loading then continue to wizard
      setTimeout(() => {
        loadingDiv.remove();
        showSubstep('1a');
      }, 2000);
    }

    // ============ WIZARD SUBSTEP NAVIGATION ============
    function hideAllSubsteps() {
      document.querySelectorAll('.substep').forEach(s => s.classList.add('hidden'));
    }

    function showSubstep(substepId) {
      state.currentSubstep = substepId;
      hideAllSubsteps();

      // Ensure step1 is visible
      document.getElementById('step1').classList.remove('hidden');

      const substep = document.getElementById('step' + substepId) ||
                      document.getElementById(substepId) ||
                      document.getElementById('step' + substepId.replace('-', ''));

      if (substep) {
        substep.classList.remove('hidden');
      }
    }

    // Wizard button click handlers
    document.querySelectorAll('.wizard-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const question = btn.dataset.question;
        const value = btn.dataset.value;

        // Highlight selected button
        const parentOptions = btn.closest('.wizard-options');
        parentOptions.querySelectorAll('.wizard-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');

        // Store answer and navigate
        handleWizardAnswer(question, value);
      });
    });

    function handleWizardAnswer(question, value) {
      switch (question) {
        case 'marital':
          state.wizard.maritalStatus = value;
          if (value === 'single') {
            showSubstep('1c'); // Skip to dependents question
          } else if (value === 'married') {
            showSubstep('1b-married');
          } else if (value === 'widowed') {
            showSubstep('1b-widow');
          }
          break;

        case 'spouse_death':
          state.wizard.spouseDeathYear = value;
          showSubstep('1c'); // Go to dependents question
          break;

        case 'married_filing':
          state.wizard.marriedFilingChoice = value;
          showSubstep('1c'); // Go to dependents question
          break;

        case 'has_dependents':
          state.wizard.hasDependents = value;
          if (value === 'yes') {
            showSubstep('1c-dependents');
            // Auto-add first dependent form
            if (state.dependents.length === 0) {
              addDependent();
            }
          } else {
            // No dependents - check if HOH question needed
            if (shouldAskHOH()) {
              showSubstep('1d-hoh');
            } else {
              showFilingStatusResult();
            }
          }
          break;

        case 'paid_household':
          state.wizard.paidHouseholdCosts = value;
          showFilingStatusResult();
          break;
      }
    }

    function shouldAskHOH() {
      // Only ask HOH for single/widowed with dependents
      return (state.wizard.maritalStatus === 'single' ||
              (state.wizard.maritalStatus === 'widowed' && state.wizard.spouseDeathYear === 'before_2023')) &&
             state.wizard.hasDependents === 'yes';
    }

    // ============ FILING STATUS DETERMINATION ============
    function determineFilingStatus() {
      const w = state.wizard;

      // Married cases
      if (w.maritalStatus === 'married') {
        return w.marriedFilingChoice === 'joint' ? 'married_joint' : 'married_separate';
      }

      // Widowed cases
      if (w.maritalStatus === 'widowed') {
        if (w.spouseDeathYear === '2025') {
          return 'married_joint'; // Can file joint in year of death
        }
        if ((w.spouseDeathYear === '2024' || w.spouseDeathYear === '2023') &&
            w.hasDependents === 'yes') {
          return 'qualifying_widow'; // Qualifying Surviving Spouse
        }
        // Fall through to single/HOH
      }

      // Single or widowed before 2023
      if (w.hasDependents === 'yes' && w.paidHouseholdCosts === 'yes') {
        return 'head_of_household';
      }

      return 'single';
    }

    function showFilingStatusResult() {
      showSubstep('1e-result');

      const recommendedStatus = determineFilingStatus();
      state.filingStatus = recommendedStatus;

      const statusInfo = {
        'single': { icon: 'ðŸ‘¤', name: 'Single', deduction: 15750 },
        'married_joint': { icon: 'ðŸ‘«', name: 'Married Filing Jointly', deduction: 31500 },
        'married_separate': { icon: 'â†”ï¸', name: 'Married Filing Separately', deduction: 15750 },
        'head_of_household': { icon: 'ðŸ ', name: 'Head of Household', deduction: 23625 },
        'qualifying_widow': { icon: 'ðŸ•¯ï¸', name: 'Qualifying Surviving Spouse', deduction: 31500 },
      };

      const info = statusInfo[recommendedStatus];
      document.getElementById('recIcon').textContent = info.icon;
      document.getElementById('recName').textContent = info.name;
      document.getElementById('recBenefit').textContent = `Standard deduction: ${formatCurrency(info.deduction)}`;

      // Show comparison if there are alternatives
      showStatusComparison(recommendedStatus, statusInfo);
    }

    function showStatusComparison(recommended, statusInfo) {
      const compDiv = document.getElementById('statusComparison');
      const compList = document.getElementById('compList');
      compList.innerHTML = '';

      // Determine which other statuses to show
      const alternatives = [];
      const w = state.wizard;

      if (w.maritalStatus === 'married') {
        // Show both joint and separate
        if (recommended === 'married_joint') {
          alternatives.push('married_separate');
        } else {
          alternatives.push('married_joint');
        }
      }

      if ((w.maritalStatus === 'single' || w.maritalStatus === 'widowed') &&
          w.hasDependents === 'yes') {
        if (recommended !== 'head_of_household') {
          alternatives.push('head_of_household');
        }
        if (recommended !== 'single') {
          alternatives.push('single');
        }
      }

      if (alternatives.length > 0) {
        compDiv.classList.remove('hidden');

        alternatives.forEach(alt => {
          const info = statusInfo[alt];
          const diff = info.deduction - statusInfo[recommended].deduction;
          const diffText = diff > 0 ? `+${formatCurrency(diff)}` : formatCurrency(diff);

          compList.innerHTML += `
            <div class="comp-item">
              <span class="comp-name">${info.icon} ${info.name}</span>
              <span class="comp-diff ${diff > 0 ? 'positive' : 'negative'}">${diffText} deduction</span>
            </div>
          `;
        });
      } else {
        compDiv.classList.add('hidden');
      }
    }

    // Accept/Change status buttons
    document.getElementById('acceptStatus')?.addEventListener('click', () => {
      showSubstep('1f-personal');
      updateInfoCard();
      // Show/hide spouse section based on filing status
      updateSpouseSectionVisibility();
    });

    document.getElementById('changeStatus')?.addEventListener('click', () => {
      document.getElementById('manualStatus').classList.remove('hidden');
    });

    // Manual status selection
    document.querySelectorAll('.status-option').forEach(option => {
      option.addEventListener('click', () => {
        document.querySelectorAll('.status-option').forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');
        state.filingStatus = option.dataset.value;

        // Update recommendation display
        const statusInfo = {
          'single': { icon: 'ðŸ‘¤', name: 'Single', deduction: 15750 },
          'married_joint': { icon: 'ðŸ‘«', name: 'Married Filing Jointly', deduction: 31500 },
          'married_separate': { icon: 'â†”ï¸', name: 'Married Filing Separately', deduction: 15750 },
          'head_of_household': { icon: 'ðŸ ', name: 'Head of Household', deduction: 23625 },
          'qualifying_widow': { icon: 'ðŸ•¯ï¸', name: 'Qualifying Surviving Spouse', deduction: 31500 },
        };
        const info = statusInfo[state.filingStatus];
        document.getElementById('recIcon').textContent = info.icon;
        document.getElementById('recName').textContent = info.name;
        document.getElementById('recBenefit').textContent = `Standard deduction: ${formatCurrency(info.deduction)}`;

        // Auto-proceed to personal info
        setTimeout(() => {
          showSubstep('1f-personal');
          updateInfoCard();
          updateSpouseSectionVisibility();
        }, 300);
      });
    });

    // ============ DEPENDENT COLLECTION ============
    let dependentCounter = 0;

    function addDependent() {
      dependentCounter++;
      const newDependent = {
        id: dependentCounter,
        firstName: '',
        lastName: '',
        dob: '',
        relationship: '',
        months: 12,
        ssn: '',
        qualifiesForCTC: false,
        qualifiesForEITC: false,
      };
      state.dependents.push(newDependent);
      renderDependentForm(newDependent);
      updateDependentsSummary();
    }

    function renderDependentForm(dependent) {
      const template = elements.dependentFormTemplate;
      const clone = template.cloneNode(true);
      clone.id = `dependent-${dependent.id}`;
      clone.classList.remove('hidden');
      clone.dataset.depId = dependent.id;

      // Update title
      clone.querySelector('.df-title').textContent = `Dependent #${state.dependents.length}`;

      // Add remove handler
      clone.querySelector('.df-remove').addEventListener('click', () => {
        removeDependent(dependent.id);
      });

      // Add input handlers
      clone.querySelectorAll('input, select').forEach(input => {
        input.addEventListener('change', (e) => {
          updateDependentField(dependent.id, input.className, e.target.value);
        });
      });

      elements.dependentsList.appendChild(clone);
    }

    function removeDependent(id) {
      state.dependents = state.dependents.filter(d => d.id !== id);
      const form = document.getElementById(`dependent-${id}`);
      if (form) form.remove();

      // Renumber remaining dependents
      document.querySelectorAll('#dependentsList .dependent-form').forEach((form, i) => {
        form.querySelector('.df-title').textContent = `Dependent #${i + 1}`;
      });

      updateDependentsSummary();
    }

    function updateDependentField(id, fieldClass, value) {
      const dependent = state.dependents.find(d => d.id === id);
      if (!dependent) return;

      if (fieldClass.includes('firstname')) dependent.firstName = value;
      else if (fieldClass.includes('lastname')) dependent.lastName = value;
      else if (fieldClass.includes('dob')) {
        dependent.dob = value;
        checkDependentEligibility(dependent);
      }
      else if (fieldClass.includes('relationship')) {
        dependent.relationship = value;
        checkDependentEligibility(dependent);
      }
      else if (fieldClass.includes('months')) {
        dependent.months = parseInt(value) || 0;
        checkDependentEligibility(dependent);
      }
      else if (fieldClass.includes('ssn')) dependent.ssn = value;

      updateDependentsSummary();
    }

    function checkDependentEligibility(dependent) {
      const form = document.getElementById(`dependent-${dependent.id}`);
      if (!form) return;

      // Calculate age
      const dob = new Date(dependent.dob);
      const endOfYear = new Date('2025-12-31');
      let age = endOfYear.getFullYear() - dob.getFullYear();
      if (endOfYear < new Date(dob.setFullYear(dob.getFullYear() + age))) {
        age--;
      }

      // Check Child Tax Credit eligibility (under 17)
      const ctcEligible = dependent.dob && age < 17 && dependent.months >= 6 &&
        ['child', 'stepchild', 'foster', 'grandchild', 'sibling'].includes(dependent.relationship);

      // Check EITC eligibility (under 19, or under 24 if full-time student, or any age if disabled)
      // Note: Without student/disabled status, we conservatively only auto-qualify under 19
      const eitcEligible = dependent.dob && age < 19 && dependent.months >= 6 &&
        ['child', 'stepchild', 'foster', 'grandchild', 'sibling'].includes(dependent.relationship);

      dependent.qualifiesForCTC = ctcEligible;
      dependent.qualifiesForEITC = eitcEligible;

      // Update qualification display
      const ctcItem = form.querySelector('[data-qual="ctc"]');
      const eitcItem = form.querySelector('[data-qual="eitc"]');

      if (ctcItem) {
        if (ctcEligible) {
          ctcItem.className = 'qual-item eligible';
          ctcItem.querySelector('.qual-icon').textContent = 'âœ…';
          ctcItem.querySelector('.qual-text').textContent = 'Qualifies for Child Tax Credit ($2,200)';
        } else if (dependent.dob) {
          ctcItem.className = 'qual-item';
          ctcItem.querySelector('.qual-icon').textContent = 'âŒ';
          ctcItem.querySelector('.qual-text').textContent = age >= 17 ? 'Too old for Child Tax Credit' : 'Does not qualify for Child Tax Credit';
        }
      }

      if (eitcItem) {
        if (eitcEligible) {
          eitcItem.className = 'qual-item eligible';
          eitcItem.querySelector('.qual-icon').textContent = 'âœ…';
          eitcItem.querySelector('.qual-text').textContent = 'May qualify for Earned Income Credit';
        } else if (dependent.dob) {
          eitcItem.className = 'qual-item';
          eitcItem.querySelector('.qual-icon').textContent = 'âŒ';
          eitcItem.querySelector('.qual-text').textContent = 'Does not qualify for EITC';
        }
      }
    }

    function updateDependentsSummary() {
      const summary = document.getElementById('dependentsSummary');
      if (state.dependents.length === 0) {
        summary.classList.add('hidden');
        return;
      }

      summary.classList.remove('hidden');

      const ctcCount = state.dependents.filter(d => d.qualifiesForCTC).length;
      const eitcCount = state.dependents.filter(d => d.qualifiesForEITC).length;
      const otherCount = state.dependents.filter(d => !d.qualifiesForCTC).length;

      document.getElementById('ctcCount').textContent = ctcCount;
      document.getElementById('eitcCount').textContent = eitcCount;
      document.getElementById('otherDepCount').textContent = otherCount;
    }

    // Add dependent button handler
    document.getElementById('addDependentBtn')?.addEventListener('click', () => {
      addDependent();
    });

    // Dependents next button
    document.getElementById('dependentsNext')?.addEventListener('click', () => {
      // Validate at least one dependent has basic info
      const hasValidDependent = state.dependents.some(d => d.firstName && d.dob && d.relationship);

      if (!hasValidDependent && state.dependents.length > 0) {
        alert('Please fill in at least the name, date of birth, and relationship for each dependent.');
        return;
      }

      // Check if HOH question is needed
      if (shouldAskHOH()) {
        showSubstep('1d-hoh');
      } else {
        showFilingStatusResult();
      }
    });

    // Wizard back buttons
    document.querySelectorAll('.wizard-back').forEach(btn => {
      btn.addEventListener('click', () => {
        // Navigate back based on current substep
        const current = state.currentSubstep;
        if (current === '1c-dependents' || current === 'step1c-dependents') {
          showSubstep('1c');
        } else if (current === '1d-hoh') {
          if (state.wizard.hasDependents === 'yes') {
            showSubstep('1c-dependents');
          } else {
            showSubstep('1c');
          }
        }
      });
    });

    // ============ PERSONAL INFO FORM ============
    document.getElementById('stateSelect')?.addEventListener('change', (e) => {
      state.stateOfResidence = e.target.value;
      state.personal.state = e.target.value;
      updateInfoCard();
    });

    // Personal info field handlers
    ['firstName', 'middleInitial', 'lastName', 'ssn', 'dob', 'street', 'city', 'zipCode'].forEach(fieldId => {
      document.getElementById(fieldId)?.addEventListener('input', (e) => {
        const key = fieldId === 'zipCode' ? 'zip' : fieldId;
        state.personal[key] = e.target.value;
      });
    });

    // Age 65+ and blindness checkboxes
    document.getElementById('age65')?.addEventListener('change', (e) => {
      state.personal.age65 = e.target.checked;
      updateRefund();
    });

    document.getElementById('blind')?.addEventListener('change', (e) => {
      state.personal.blind = e.target.checked;
      updateRefund();
    });

    document.getElementById('spouseAge65')?.addEventListener('change', (e) => {
      state.personal.spouseAge65 = e.target.checked;
      updateRefund();
    });

    document.getElementById('spouseBlind')?.addEventListener('change', (e) => {
      state.personal.spouseBlind = e.target.checked;
      updateRefund();
    });

    // SSN formatting
    document.getElementById('ssn')?.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 9) value = value.slice(0, 9);
      if (value.length >= 6) {
        e.target.value = value.slice(0, 3) + '-' + value.slice(3, 5) + '-' + value.slice(5);
      } else if (value.length >= 4) {
        e.target.value = value.slice(0, 3) + '-' + value.slice(3);
      }
    });

    // Spouse SSN formatting
    document.getElementById('spouseSsn')?.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 9) value = value.slice(0, 9);
      if (value.length >= 6) {
        e.target.value = value.slice(0, 3) + '-' + value.slice(3, 5) + '-' + value.slice(5);
      } else if (value.length >= 4) {
        e.target.value = value.slice(0, 3) + '-' + value.slice(3);
      }
    });

    // Show/hide spouse section based on filing status
    function updateSpouseSectionVisibility() {
      const spouseSection = document.getElementById('spouseAgeBlind');
      if (spouseSection) {
        if (state.filingStatus === 'married_joint') {
          spouseSection.classList.remove('hidden');
        } else {
          spouseSection.classList.add('hidden');
        }
      }
    }

    // Step 1 Next button (from personal info)
    document.getElementById('btnNext1')?.addEventListener('click', () => {
      // Validate personal info
      const required = ['firstName', 'lastName', 'ssn', 'dob', 'street', 'city', 'zipCode'];
      const stateSelect = document.getElementById('stateSelect');

      for (const fieldId of required) {
        const field = document.getElementById(fieldId);
        if (!field || !field.value.trim()) {
          alert('Please fill in all required fields.');
          field?.focus();
          return;
        }
      }

      if (!stateSelect || !stateSelect.value) {
        alert('Please select your state.');
        stateSelect?.focus();
        return;
      }

      if (!state.filingStatus) {
        alert('Please complete the filing status wizard first.');
        return;
      }

      state.stateOfResidence = stateSelect.value;
      goToStep(2);
    });

    // Personal Info Next button (inside the wizard substep)
    document.getElementById('personalNext')?.addEventListener('click', () => {
      // Validate and save personal info
      const required = ['firstName', 'lastName', 'ssn', 'dob', 'street', 'city', 'zipCode'];
      const stateSelect = document.getElementById('stateSelect');

      for (const fieldId of required) {
        const field = document.getElementById(fieldId);
        if (!field || !field.value.trim()) {
          alert('Please fill in all required fields.');
          field?.focus();
          return;
        }
      }

      if (!stateSelect || !stateSelect.value) {
        alert('Please select your state.');
        stateSelect?.focus();
        return;
      }

      if (!state.filingStatus) {
        alert('Please complete the filing status wizard first.');
        showSubstep('1a');
        return;
      }

      // Validate spouse info if MFJ
      if (state.filingStatus === 'married_joint') {
        const spouseRequired = ['spouseFirstName', 'spouseLastName', 'spouseSsn', 'spouseDob'];
        for (const fieldId of spouseRequired) {
          const field = document.getElementById(fieldId);
          if (!field || !field.value.trim()) {
            alert('Please fill in all spouse information for Married Filing Jointly.');
            field?.focus();
            return;
          }
        }
      }

      // Save personal info to state
      state.personal.firstName = document.getElementById('firstName')?.value || '';
      state.personal.middleInitial = document.getElementById('middleInitial')?.value || '';
      state.personal.lastName = document.getElementById('lastName')?.value || '';
      state.personal.ssn = document.getElementById('ssn')?.value || '';
      state.personal.dob = document.getElementById('dob')?.value || '';
      state.personal.street = document.getElementById('street')?.value || '';
      state.personal.city = document.getElementById('city')?.value || '';
      state.personal.state = stateSelect.value;
      state.personal.zip = document.getElementById('zipCode')?.value || '';
      state.stateOfResidence = stateSelect.value;

      // Save age/blindness checkboxes
      state.personal.age65 = document.getElementById('age65')?.checked || false;
      state.personal.blind = document.getElementById('blind')?.checked || false;

      // Save spouse info if MFJ
      if (state.filingStatus === 'married_joint') {
        state.personal.spouseFirstName = document.getElementById('spouseFirstName')?.value || '';
        state.personal.spouseMiddleInitial = document.getElementById('spouseMiddleInitial')?.value || '';
        state.personal.spouseLastName = document.getElementById('spouseLastName')?.value || '';
        state.personal.spouseSsn = document.getElementById('spouseSsn')?.value || '';
        state.personal.spouseDob = document.getElementById('spouseDob')?.value || '';
        state.personal.spouseAge65 = document.getElementById('spouseAge65')?.checked || false;
        state.personal.spouseBlind = document.getElementById('spouseBlind')?.checked || false;
      }

      // Save to localStorage
      saveStateToStorage();

      goToStep(2);
    });

    // Personal Info Back button
    document.getElementById('personalBack')?.addEventListener('click', () => {
      showSubstep('1e-result');
    });

    // ============ STEP 2: DOCUMENTS ============
    function setupUploadZone() {
      const zone = elements.uploadZone;

      zone.addEventListener('click', () => elements.fileInput.click());

      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
      });

      zone.addEventListener('dragleave', () => {
        zone.classList.remove('dragover');
      });

      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        files.forEach(uploadFile);
      });

      elements.fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        files.forEach(uploadFile);
        e.target.value = '';
      });
    }

    async function uploadFile(file) {
      elements.uploadZone.classList.add('uploading');

      try {
        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch('/api/upload', { method: 'POST', body: formData });
        const data = await res.json();

        if (res.ok) {
          const doc = {
            id: data.document_id,
            filename: file.name,
            type: data.document_type,
            status: data.status,
            confidence: data.extraction_confidence,
            fields: data.extracted_fields,
          };

          state.documents.push(doc);
          renderDocuments();
          updateTaxData(doc);
          updateRefund();
          updateInfoCard();
        } else {
          alert('Upload failed: ' + (data.detail || 'Unknown error'));
        }
      } catch (err) {
        alert('Upload error: ' + err.message);
      } finally {
        elements.uploadZone.classList.remove('uploading');
      }
    }

    function renderDocuments() {
      elements.documentsList.innerHTML = '';

      state.documents.forEach(doc => {
        const iconClass = doc.type.toLowerCase().replace('-', '');
        const statusClass = doc.status === 'applied' ? 'applied' : 'success';

        // Get key values for preview
        let previewText = '';
        if (doc.fields) {
          const wages = doc.fields.find(f => f.field_name === 'wages');
          const withheld = doc.fields.find(f => f.field_name === 'federal_tax_withheld');
          if (wages) previewText += `Wages: ${formatCurrency(wages.normalized_value)} `;
          if (withheld) previewText += `| Withheld: ${formatCurrency(withheld.normalized_value)}`;
        }

        const html = `
          <div class="document-card" data-id="${doc.id}">
            <div class="doc-icon ${iconClass}">${doc.type.substring(0, 3)}</div>
            <div class="doc-details">
              <div class="doc-type">${doc.type.toUpperCase()}</div>
              <div class="doc-meta">${doc.filename} â€¢ ${doc.confidence?.toFixed(0) || 0}% confidence</div>
              ${previewText ? `<div class="doc-values">${previewText}</div>` : ''}
            </div>
            <span class="doc-status ${statusClass}">${doc.status}</span>
            ${doc.status !== 'applied' ? `<button class="btn-apply" onclick="applyDocument('${doc.id}')">Apply</button>` : ''}
            <button class="btn-delete" onclick="deleteDocument('${doc.id}')">ðŸ—‘</button>
          </div>
        `;
        elements.documentsList.innerHTML += html;
      });
    }

    async function applyDocument(docId) {
      try {
        const res = await fetch(`/api/documents/${docId}/apply`, { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          const doc = state.documents.find(d => d.id === docId);
          if (doc) doc.status = 'applied';
          renderDocuments();
          updateRefund();
        } else {
          alert('Failed: ' + (data.errors?.join(', ') || 'Unknown error'));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function deleteDocument(docId) {
      try {
        await fetch(`/api/documents/${docId}`, { method: 'DELETE' });
        state.documents = state.documents.filter(d => d.id !== docId);
        renderDocuments();
        recalculateTaxData();
        updateRefund();
        updateInfoCard();
      } catch (err) {
        console.error(err);
      }
    }

    function updateTaxData(doc) {
      if (!doc.fields) return;

      doc.fields.forEach(field => {
        const val = field.normalized_value;
        if (field.field_name === 'wages') state.taxData.wages += val || 0;
        if (field.field_name === 'federal_tax_withheld') state.taxData.federalWithheld += val || 0;
        if (field.field_name === 'state_wages') state.taxData.stateWages += val || 0;
        if (field.field_name === 'state_tax') state.taxData.stateWithheld += val || 0;
      });
    }

    function recalculateTaxData() {
      state.taxData = { wages: 0, federalWithheld: 0, otherIncome: 0, stateWages: 0, stateWithheld: 0 };
      state.documents.forEach(doc => updateTaxData(doc));
    }

    document.getElementById('btnBack2').addEventListener('click', () => goToStep(1));
    document.getElementById('btnNext2').addEventListener('click', () => goToStep(3));

    // ============ STEP 3: CHAT ============
    async function initChat() {
      elements.chatMessages.innerHTML = '';
      const reply = await callChat({ action: 'reset' });
      addChatMessage(reply, 'agent');
    }

    async function callChat(payload) {
      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        return data.reply || 'No response';
      } catch (err) {
        return 'Error: ' + err.message;
      }
    }

    function addChatMessage(text, who) {
      const div = document.createElement('div');
      div.className = 'message ' + who;
      div.textContent = text;
      elements.chatMessages.appendChild(div);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    document.getElementById('btnSend').addEventListener('click', async () => {
      const text = elements.chatInput.value.trim();
      if (!text) return;

      elements.chatInput.value = '';
      addChatMessage(text, 'user');

      const reply = await callChat({ action: 'message', message: text });
      addChatMessage(reply, 'agent');
    });

    elements.chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('btnSend').click();
    });

    document.getElementById('btnBack3').addEventListener('click', () => goToStep(2));
    document.getElementById('btnNext3').addEventListener('click', () => goToStep(4));

    // ============ STEP 4: DEDUCTIONS ============
    // 2025 Standard Deduction amounts (IRS Rev. Proc. 2024-40)
    const standardDeductions = {
      'single': 15750,
      'married_joint': 31500,
      'married_separate': 15750,
      'head_of_household': 23625,
      'qualifying_widow': 31500,
    };

    // Itemizable deduction fields (these contribute to itemized total)
    const itemizableFields = [
      'mortgage_amount', 'property_tax_amount', 'charity_cash_amount', 'charity_goods_amount',
      'medical_amount', 'state_tax_amount', 'local_tax_amount', 'gambling_amount',
      'casualty_amount', 'investment_interest_amount'
    ];

    // Above-the-line deduction fields (reduce AGI, always beneficial)
    const aboveLineFields = [
      'hsa_amount', 'self_health_insurance_amount', 'student_loan_amount',
      'educator_amount', 'ira_amount', 'sep_ira_amount', 'alimony_amount'
    ];

    // Setup deduction toggle buttons
    document.querySelectorAll('.deduction-option').forEach(btn => {
      btn.addEventListener('click', () => {
        const question = btn.dataset.question;
        const value = btn.dataset.value;

        // Update button states
        document.querySelectorAll(`.deduction-option[data-question="${question}"]`).forEach(b => {
          b.classList.remove('selected', 'selected-no');
        });

        if (value === 'yes') {
          btn.classList.add('selected');
        } else {
          btn.classList.add('selected-no');
        }

        state.deductions[question] = value;

        // Show/hide amount input
        const amountInput = document.querySelector(`.amount-input[data-for="${question}"]`);
        if (amountInput) {
          if (value === 'yes') {
            amountInput.classList.remove('hidden');
          } else {
            amountInput.classList.add('hidden');
            // Clear the value when hiding
            const input = amountInput.querySelector('.amount-field');
            if (input) {
              input.value = '';
              state.deductions[input.dataset.field] = 0;
            }
          }
        }

        updateDeductionSummary();
      });
    });

    // Setup amount field listeners
    document.querySelectorAll('.amount-field').forEach(input => {
      input.addEventListener('input', (e) => {
        let value = e.target.value.replace(/[^0-9.]/g, '');
        state.deductions[input.dataset.field] = parseFloat(value) || 0;
        updateDeductionSummary();
      });

      input.addEventListener('blur', (e) => {
        const value = parseFloat(e.target.value.replace(/[^0-9.]/g, '')) || 0;
        if (value > 0) {
          e.target.value = formatCurrency(value);
        }
      });

      input.addEventListener('focus', (e) => {
        const value = parseFloat(e.target.value.replace(/[^0-9.]/g, '')) || 0;
        if (value > 0) {
          e.target.value = value;
        } else {
          e.target.value = '';
        }
      });
    });

    function updateDeductionSummary() {
      // Calculate itemized total
      let itemizedTotal = 0;
      itemizableFields.forEach(field => {
        itemizedTotal += state.deductions[field] || 0;
      });

      // Apply SALT cap ($10,000) to state/local/property taxes
      const saltTotal = (state.deductions['property_tax_amount'] || 0) +
                       (state.deductions['state_tax_amount'] || 0) +
                       (state.deductions['local_tax_amount'] || 0);
      if (saltTotal > 10000) {
        const excess = saltTotal - 10000;
        itemizedTotal -= excess;
      }

      // Get standard deduction for filing status (2025: $15,750 single default)
      const standardDeduction = standardDeductions[state.filingStatus] || 15750;

      // Update display
      document.getElementById('standardDeductionAmount').textContent = formatCurrency(standardDeduction);
      document.getElementById('itemizedTotal').textContent = formatCurrency(itemizedTotal);

      // Update recommendation
      const recElement = document.getElementById('deductionRecommendation');
      const recText = recElement.querySelector('.rec-text');
      const recIcon = recElement.querySelector('.rec-icon');

      if (itemizedTotal === 0) {
        recIcon.textContent = 'ðŸ’¡';
        recText.textContent = 'Add your deductions above to see which option saves you more!';
        recText.classList.remove('better');
      } else if (itemizedTotal > standardDeduction) {
        const savings = itemizedTotal - standardDeduction;
        recIcon.textContent = 'âœ…';
        recText.innerHTML = `Itemizing saves you <strong>${formatCurrency(savings)}</strong> more! We'll use itemized deductions.`;
        recText.classList.add('better');
      } else {
        recIcon.textContent = 'âœ…';
        recText.textContent = `Standard deduction is better for you. We'll use ${formatCurrency(standardDeduction)}.`;
        recText.classList.remove('better');
      }

      // Calculate above-the-line deductions
      let aboveLineTotal = 0;
      aboveLineFields.forEach(field => {
        aboveLineTotal += state.deductions[field] || 0;
      });

      // Store totals in state
      state.deductions.itemizedTotal = itemizedTotal;
      state.deductions.aboveLineTotal = aboveLineTotal;
      state.deductions.useItemized = itemizedTotal > standardDeduction;
    }

    document.getElementById('btnBack4').addEventListener('click', () => goToStep(3));
    document.getElementById('btnNext4').addEventListener('click', () => goToStep(5));

    // ============ STEP 5: CREDITS ============
    // Setup credit toggle buttons (same pattern as deductions)
    document.querySelectorAll('.credit-option').forEach(btn => {
      btn.addEventListener('click', () => {
        const question = btn.dataset.question || btn.dataset.credit;
        const value = btn.dataset.value;

        // Update button states - support both data-question and data-credit
        const selector = btn.dataset.question
          ? `.credit-option[data-question="${question}"]`
          : `.credit-option[data-credit="${question}"]`;
        document.querySelectorAll(selector).forEach(b => {
          b.classList.remove('selected', 'selected-no');
        });

        if (value === 'yes') {
          btn.classList.add('selected');
        } else {
          btn.classList.add('selected-no');
        }

        state.credits['has_' + question] = value;

        // Show/hide amount input
        const amountInput = document.querySelector(`.amount-input[data-for="${question}"]`);
        if (amountInput) {
          if (value === 'yes') {
            amountInput.classList.remove('hidden');
          } else {
            amountInput.classList.add('hidden');
            // Clear the value when hiding
            const input = amountInput.querySelector('.amount-field');
            if (input) {
              input.value = '';
              state.credits[input.dataset.field] = 0;
            }
          }
        }

        updateCreditsSummary();
      });
    });

    // Education credit type selection (AOTC vs LLC)
    document.querySelectorAll('.cc-option[data-credit-type]').forEach(option => {
      option.addEventListener('click', () => {
        const creditType = option.dataset.creditType;

        // Update selection visual
        document.querySelectorAll('.cc-option[data-credit-type]').forEach(opt => {
          opt.classList.remove('selected');
        });
        option.classList.add('selected');

        // Store selection
        state.credits.education_credit_type = creditType;

        updateCreditsSummary();
      });
    });

    // Auto-select education credit based on student status
    const studentStatusSelect = document.querySelector('[data-field="student_status"]');
    if (studentStatusSelect) {
      studentStatusSelect.addEventListener('change', (e) => {
        const status = e.target.value;
        let recommendedType = 'aotc'; // Default to AOTC

        if (status === 'grad' || status === 'continuing') {
          recommendedType = 'llc';
        }

        // Update visual selection
        document.querySelectorAll('.cc-option[data-credit-type]').forEach(opt => {
          opt.classList.remove('selected', 'recommended');
          if (opt.dataset.creditType === recommendedType) {
            opt.classList.add('selected', 'recommended');
          }
        });

        state.credits.education_credit_type = recommendedType;
        updateCreditsSummary();
      });
    }

    // Setup credit amount field listeners
    document.querySelectorAll('.credit-field').forEach(input => {
      input.addEventListener('input', (e) => {
        let value = e.target.value.replace(/[^0-9.]/g, '');
        state.credits[input.dataset.field] = parseFloat(value) || 0;
        updateCreditsSummary();
      });

      input.addEventListener('blur', (e) => {
        const value = parseFloat(e.target.value.replace(/[^0-9.]/g, '')) || 0;
        if (value > 0) {
          e.target.value = formatCurrency(value);
        }
      });

      input.addEventListener('focus', (e) => {
        const value = parseFloat(e.target.value.replace(/[^0-9.]/g, '')) || 0;
        if (value > 0) {
          e.target.value = value;
        } else {
          e.target.value = '';
        }
      });
    });

    function updateCreditsSummary() {
      let totalCredits = 0;

      // Child Tax Credit (based on dependents)
      const ctcCount = state.dependents.filter(d => d.qualifiesForCTC).length;
      const ctcAmount = ctcCount * 2200;
      totalCredits += ctcAmount;

      // Childcare Credit
      const childcareExpenses = state.credits['childcare_amount'] || 0;
      const childcareCredit = Math.min(childcareExpenses * 0.35, 2100); // Max $6000 expenses, 35% rate
      if (childcareExpenses > 0) totalCredits += childcareCredit;

      // Education Credits
      const tuitionPaid = state.credits['tuition_paid'] || state.credits['education_amount'] || 0;
      const creditType = state.credits.education_credit_type || 'aotc';
      let educationCredit = 0;

      if (state.credits['has_education'] === 'yes' && tuitionPaid > 0) {
        if (creditType === 'aotc') {
          // AOTC: 100% of first $2,000 + 25% of next $2,000 = max $2,500
          educationCredit = Math.min(tuitionPaid, 2000) + Math.min(Math.max(0, tuitionPaid - 2000), 2000) * 0.25;
          educationCredit = Math.min(educationCredit, 2500);
        } else {
          // LLC: 20% of first $10,000 = max $2,000
          educationCredit = Math.min(tuitionPaid, 10000) * 0.20;
        }
        totalCredits += educationCredit;
      }

      // Update education credit display
      const aotcAmountEl = document.getElementById('aotcAmount');
      const llcAmountEl = document.getElementById('llcAmount');
      if (tuitionPaid > 0) {
        const aotcCalc = Math.min(tuitionPaid, 2000) + Math.min(Math.max(0, tuitionPaid - 2000), 2000) * 0.25;
        const llcCalc = Math.min(tuitionPaid, 10000) * 0.20;
        if (aotcAmountEl) aotcAmountEl.textContent = formatCurrency(Math.min(aotcCalc, 2500));
        if (llcAmountEl) llcAmountEl.textContent = formatCurrency(llcCalc);
      }

      // Energy Credits
      const energyExpenses = state.credits['energy_amount'] || 0;
      const energyCredit = energyExpenses * 0.30;
      if (energyExpenses > 0) totalCredits += energyCredit;

      // Saver's Credit (retirement contributions)
      const saverContrib = state.credits['saver_amount'] || 0;
      const saverCredit = Math.min(saverContrib * 0.50, 1000); // 50% rate up to $2000 contribution
      if (saverContrib > 0) totalCredits += saverCredit;

      // EITC (Earned Income Tax Credit)
      const eitcChildren = state.dependents.filter(d => d.qualifiesForEITC).length;
      const eitcAmount = calculateEITC(state.taxData.wages, state.taxData.wages, state.filingStatus, eitcChildren);
      totalCredits += eitcAmount;

      // Update EITC display in credits step
      const eitcAmountEl = document.getElementById('eitcAmount');
      const eitcDescEl = document.getElementById('eitcDesc');
      const eitcStatusEl = document.getElementById('eitcStatus');
      if (eitcAmountEl) {
        eitcAmountEl.textContent = formatCurrency(eitcAmount);
      }
      if (eitcDescEl && eitcAmount > 0) {
        eitcDescEl.textContent = `Based on ${eitcChildren} qualifying ${eitcChildren === 1 ? 'child' : 'children'}`;
      }
      if (eitcStatusEl) {
        eitcStatusEl.textContent = eitcAmount > 0 ? 'You qualify!' : (state.taxData.wages > 0 ? 'Income too high to qualify' : 'Enter income to calculate');
      }

      // Update the credits summary display if element exists
      const summaryEl = document.getElementById('creditsSummaryTotal');
      if (summaryEl) {
        summaryEl.textContent = formatCurrency(totalCredits);
      }

      // Store total in state
      state.credits.totalCredits = totalCredits;

      // Update refund with credits
      updateRefund();
    }

    document.getElementById('btnBack5')?.addEventListener('click', () => goToStep(4));
    document.getElementById('btnNext5')?.addEventListener('click', () => goToStep(6));

    // ============ STEP 6: COMPREHENSIVE TAX REVIEW ============

    // Tax computation state
    let taxComputation = {
      grossIncome: 0,
      adjustments: 0,
      agi: 0,
      standardDeduction: 0,
      itemizedDeduction: 0,
      deductionUsed: 0,
      useItemized: false,
      taxableIncome: 0,
      taxBeforeCredits: 0,
      totalCredits: 0,
      refundableCredits: 0,
      finalTax: 0,
      totalPayments: 0,
      refundOrOwed: 0,
      isRefund: true,
      brackets: [],
      marginalRate: 0,
      effectiveRate: 0,
      stateTax: 0,
      stateRefund: 0,
    };

    // Filing status configurations (Tax Year 2025 - IRS Rev. Proc. 2024-40)
    const filingStatusConfigs = {
      'single': {
        name: 'Single',
        icon: 'ðŸ‘¤',
        baseDeduction: 15750,
        additionalDeduction: 1950, // for age 65+ or blind
        brackets: [
          { min: 0, max: 11925, rate: 0.10 },
          { min: 11925, max: 48475, rate: 0.12 },
          { min: 48475, max: 103350, rate: 0.22 },
          { min: 103350, max: 197300, rate: 0.24 },
          { min: 197300, max: 250525, rate: 0.32 },
          { min: 250525, max: 626350, rate: 0.35 },
          { min: 626350, max: Infinity, rate: 0.37 },
        ],
      },
      'married_joint': {
        name: 'Married Filing Jointly',
        icon: 'ðŸ‘«',
        baseDeduction: 31500,
        additionalDeduction: 1550,
        brackets: [
          { min: 0, max: 23850, rate: 0.10 },
          { min: 23850, max: 96950, rate: 0.12 },
          { min: 96950, max: 206700, rate: 0.22 },
          { min: 206700, max: 394600, rate: 0.24 },
          { min: 394600, max: 501050, rate: 0.32 },
          { min: 501050, max: 751600, rate: 0.35 },
          { min: 751600, max: Infinity, rate: 0.37 },
        ],
      },
      'married_separate': {
        name: 'Married Filing Separately',
        icon: 'â†”ï¸',
        baseDeduction: 15750,
        additionalDeduction: 1550,
        brackets: [
          { min: 0, max: 11925, rate: 0.10 },
          { min: 11925, max: 48475, rate: 0.12 },
          { min: 48475, max: 103350, rate: 0.22 },
          { min: 103350, max: 197300, rate: 0.24 },
          { min: 197300, max: 250525, rate: 0.32 },
          { min: 250525, max: 375800, rate: 0.35 },
          { min: 375800, max: Infinity, rate: 0.37 },
        ],
      },
      'head_of_household': {
        name: 'Head of Household',
        icon: 'ðŸ ',
        baseDeduction: 23625,
        additionalDeduction: 1950,
        brackets: [
          { min: 0, max: 17050, rate: 0.10 },
          { min: 17050, max: 64850, rate: 0.12 },
          { min: 64850, max: 103350, rate: 0.22 },
          { min: 103350, max: 197300, rate: 0.24 },
          { min: 197300, max: 250525, rate: 0.32 },
          { min: 250525, max: 626350, rate: 0.35 },
          { min: 626350, max: Infinity, rate: 0.37 },
        ],
      },
      'qualifying_widow': {
        name: 'Qualifying Surviving Spouse',
        icon: 'ðŸ•¯ï¸',
        baseDeduction: 31500,
        additionalDeduction: 1550,
        brackets: [
          { min: 0, max: 23850, rate: 0.10 },
          { min: 23850, max: 96950, rate: 0.12 },
          { min: 96950, max: 206700, rate: 0.22 },
          { min: 206700, max: 394600, rate: 0.24 },
          { min: 394600, max: 501050, rate: 0.32 },
          { min: 501050, max: 751600, rate: 0.35 },
          { min: 751600, max: Infinity, rate: 0.37 },
        ],
      },
    };

    // State tax rates (simplified)
    const stateTaxRates = {
      'CA': { name: 'California', rate: 0.0725, type: 'Progressive' },
      'NY': { name: 'New York', rate: 0.0685, type: 'Progressive' },
      'TX': { name: 'Texas', rate: 0, type: 'No Income Tax' },
      'FL': { name: 'Florida', rate: 0, type: 'No Income Tax' },
      'WA': { name: 'Washington', rate: 0, type: 'No Income Tax' },
      'NV': { name: 'Nevada', rate: 0, type: 'No Income Tax' },
      'AK': { name: 'Alaska', rate: 0, type: 'No Income Tax' },
      'WY': { name: 'Wyoming', rate: 0, type: 'No Income Tax' },
      'SD': { name: 'South Dakota', rate: 0, type: 'No Income Tax' },
      'TN': { name: 'Tennessee', rate: 0, type: 'No Income Tax' },
      'NH': { name: 'New Hampshire', rate: 0, type: 'No Income Tax' },
      'IL': { name: 'Illinois', rate: 0.0495, type: 'Flat' },
      'PA': { name: 'Pennsylvania', rate: 0.0307, type: 'Flat' },
      'MA': { name: 'Massachusetts', rate: 0.05, type: 'Flat' },
      'NJ': { name: 'New Jersey', rate: 0.0637, type: 'Progressive' },
      'GA': { name: 'Georgia', rate: 0.055, type: 'Progressive' },
      'NC': { name: 'North Carolina', rate: 0.0475, type: 'Flat' },
      'OH': { name: 'Ohio', rate: 0.04, type: 'Progressive' },
      'AZ': { name: 'Arizona', rate: 0.025, type: 'Flat' },
      'CO': { name: 'Colorado', rate: 0.044, type: 'Flat' },
    };

    // Calculate Earned Income Tax Credit (EITC) - 2025 parameters (IRS Rev. Proc. 2024-40)
    function calculateEITC(earnedIncome, agi, filingStatus, qualifyingChildren) {
      // EITC parameters for 2025
      const eitcParams = {
        0: { maxCredit: 649, phaseInRate: 0.0765, phaseOutRate: 0.0765,
             singlePhaseOutStart: 9950, mfjPhaseOutStart: 16370, maxEarned: 8490 },
        1: { maxCredit: 4328, phaseInRate: 0.34, phaseOutRate: 0.1598,
             singlePhaseOutStart: 12730, mfjPhaseOutStart: 19150, maxEarned: 12730 },
        2: { maxCredit: 7152, phaseInRate: 0.40, phaseOutRate: 0.2106,
             singlePhaseOutStart: 12730, mfjPhaseOutStart: 19150, maxEarned: 17880 },
        3: { maxCredit: 8046, phaseInRate: 0.45, phaseOutRate: 0.2106,
             singlePhaseOutStart: 12730, mfjPhaseOutStart: 19150, maxEarned: 17880 },
      };

      // Income limits for 2025 (phaseout end)
      const incomeLimits = {
        0: { single: 18591, mfj: 25511 },
        1: { single: 49084, mfj: 56004 },
        2: { single: 55768, mfj: 62688 },
        3: { single: 59899, mfj: 66819 },
      };

      const children = Math.min(qualifyingChildren, 3); // Max 3 for EITC
      const params = eitcParams[children];
      const limits = incomeLimits[children];

      // Check income limits
      const isMFJ = filingStatus === 'married_joint';
      const incomeLimit = isMFJ ? limits.mfj : limits.single;
      const useIncome = Math.max(earnedIncome, agi); // Use larger of earned income or AGI

      if (useIncome > incomeLimit || earnedIncome === 0) {
        return 0;
      }

      // Phase-in: Credit increases as earned income increases up to max
      let credit = Math.min(earnedIncome * params.phaseInRate, params.maxCredit);

      // Phase-out: Credit decreases as income exceeds phase-out threshold
      const phaseOutStart = isMFJ ? params.mfjPhaseOutStart : params.singlePhaseOutStart;
      if (useIncome > phaseOutStart) {
        const phaseOutReduction = (useIncome - phaseOutStart) * params.phaseOutRate;
        credit = Math.max(0, credit - phaseOutReduction);
      }

      return Math.round(credit);
    }

    // Compute complete tax return
    function computeTaxReturn(filingStatus = state.filingStatus) {
      const config = filingStatusConfigs[filingStatus] || filingStatusConfigs['single'];

      // 1. Calculate Gross Income
      const grossIncome = state.taxData.wages +
                         (state.taxData.otherIncome || 0);

      // 2. Calculate Adjustments (above-the-line deductions)
      const adjustments = (state.deductions['educator_amount'] || 0) +
                         (state.deductions['hsa_amount'] || 0) +
                         (state.deductions['ira_amount'] || 0) +
                         (state.deductions['student_loan_amount'] || 0) +
                         (state.deductions['self_health_insurance_amount'] || 0);

      // 3. Calculate AGI
      const agi = Math.max(0, grossIncome - adjustments);

      // 4. Calculate Standard Deduction
      let standardDeduction = config.baseDeduction;
      if (filingStatus === 'single' || filingStatus === 'head_of_household') {
        if (state.personal.age65) standardDeduction += config.additionalDeduction;
        if (state.personal.blind) standardDeduction += config.additionalDeduction;
      } else {
        if (state.personal.age65) standardDeduction += config.additionalDeduction;
        if (state.personal.blind) standardDeduction += config.additionalDeduction;
        if (state.personal.spouseAge65) standardDeduction += config.additionalDeduction;
        if (state.personal.spouseBlind) standardDeduction += config.additionalDeduction;
      }

      // 5. Calculate Itemized Deductions
      const mortgageInterest = state.deductions['mortgage_amount'] || 0;
      const propertyTax = state.deductions['property_tax_amount'] || 0;
      const stateTaxPaid = state.deductions['state_tax_amount'] || 0;
      const localTax = state.deductions['local_tax_amount'] || 0;
      const charityCash = state.deductions['charity_cash_amount'] || 0;
      const charityGoods = state.deductions['charity_goods_amount'] || 0;
      const medical = state.deductions['medical_amount'] || 0;

      // Apply SALT cap
      const saltTotal = propertyTax + stateTaxPaid + localTax;
      const saltCapped = Math.min(saltTotal, 10000);

      // Medical expenses only deductible above 7.5% of AGI
      const medicalThreshold = agi * 0.075;
      const medicalDeductible = Math.max(0, medical - medicalThreshold);

      const itemizedDeduction = mortgageInterest + saltCapped + charityCash + charityGoods + medicalDeductible;

      // 6. Choose better deduction
      const useItemized = itemizedDeduction > standardDeduction;
      const deductionUsed = useItemized ? itemizedDeduction : standardDeduction;

      // 7. Calculate Taxable Income
      const taxableIncome = Math.max(0, agi - deductionUsed);

      // 8. Calculate Tax using brackets
      let taxBeforeCredits = 0;
      let bracketBreakdown = [];
      let marginalRate = 0.10;

      const brackets = config.brackets;
      let remainingIncome = taxableIncome;

      for (const bracket of brackets) {
        const bracketWidth = bracket.max - bracket.min;
        const incomeInBracket = Math.min(Math.max(0, remainingIncome), bracketWidth);

        if (incomeInBracket > 0) {
          const taxInBracket = incomeInBracket * bracket.rate;
          taxBeforeCredits += taxInBracket;
          marginalRate = bracket.rate;

          bracketBreakdown.push({
            rate: bracket.rate,
            income: incomeInBracket,
            tax: taxInBracket,
            max: bracket.max,
          });
        }

        remainingIncome -= incomeInBracket;
        if (remainingIncome <= 0) break;
      }

      // 9. Calculate Credits
      const ctcCount = state.dependents.filter(d => d.qualifiesForCTC).length;
      const ctcAmount = ctcCount * 2200;

      const childcareExpenses = state.credits['childcare_amount'] || 0;
      const childcareCredit = Math.min(childcareExpenses * 0.35, 2100);

      const tuitionPaid = state.credits['tuition_paid'] || state.credits['education_amount'] || 0;
      const eduCreditType = state.credits.education_credit_type || 'aotc';
      let educationCredit = 0;
      if (state.credits['has_education'] === 'yes' && tuitionPaid > 0) {
        if (eduCreditType === 'aotc') {
          educationCredit = Math.min(tuitionPaid, 2000) + Math.min(Math.max(0, tuitionPaid - 2000), 2000) * 0.25;
          educationCredit = Math.min(educationCredit, 2500);
        } else {
          educationCredit = Math.min(tuitionPaid, 10000) * 0.20;
        }
      }

      const energyExpenses = state.credits['energy_amount'] || 0;
      const energyCredit = energyExpenses * 0.30;

      const saverContrib = state.credits['saver_amount'] || 0;
      const saverCredit = Math.min(saverContrib * 0.50, 1000);

      // Calculate EITC (Earned Income Tax Credit)
      const eitcAmount = calculateEITC(state.taxData.wages, agi, filingStatus, state.dependents.filter(d => d.qualifiesForEITC).length);

      const totalCredits = ctcAmount + childcareCredit + educationCredit + energyCredit + saverCredit + eitcAmount;
      // AOTC is 40% refundable, LLC is not refundable, EITC is fully refundable
      const aotcRefundable = eduCreditType === 'aotc' ? Math.min(educationCredit * 0.40, 1000) : 0;
      const refundableCredits = Math.min(ctcAmount * 0.15, 1700) + aotcRefundable + eitcAmount;

      // 10. Calculate Final Tax
      const finalTax = Math.max(0, taxBeforeCredits - totalCredits);

      // 11. Calculate Payments
      const totalPayments = state.taxData.federalWithheld || 0;

      // 12. Calculate Refund or Amount Owed
      const refundOrOwed = totalPayments - finalTax + refundableCredits;
      const isRefund = refundOrOwed >= 0;

      // 13. Calculate Effective Rate
      const effectiveRate = grossIncome > 0 ? (finalTax / grossIncome) : 0;

      // 14. Calculate State Tax
      const stateCode = state.stateOfResidence;
      let stateTax = 0;
      let stateRefund = 0;

      if (stateCode && stateTaxRates[stateCode]) {
        const stateConfig = stateTaxRates[stateCode];
        if (stateConfig.rate > 0) {
          stateTax = agi * stateConfig.rate; // Simplified
          stateRefund = (state.taxData.stateWithheld || 0) - stateTax;
        }
      }

      // Store computation
      taxComputation = {
        grossIncome,
        adjustments,
        agi,
        standardDeduction,
        itemizedDeduction,
        deductionUsed,
        useItemized,
        taxableIncome,
        taxBeforeCredits,
        totalCredits,
        refundableCredits,
        finalTax,
        totalPayments,
        refundOrOwed: Math.abs(refundOrOwed),
        isRefund,
        brackets: bracketBreakdown,
        marginalRate,
        effectiveRate,
        stateTax,
        stateRefund,
        // Detailed breakdowns
        ctcAmount,
        childcareCredit,
        educationCredit,
        energyCredit,
        saverCredit,
        eitcAmount,
        mortgageInterest,
        saltCapped,
        saltTotal,
        charityCash,
        charityGoods,
        medicalDeductible,
      };

      return taxComputation;
    }

    // ============ BACKEND API INTEGRATION ============

    // Sync frontend state to backend for server-side calculations
    async function syncToBackend() {
      try {
        const payload = {
          filing_status: state.filingStatus,
          stateOfResidence: state.stateOfResidence,
          personal: state.personal,
          taxData: state.taxData,
          deductions: {
            medical: state.deductions['medical_amount'] || 0,
            salt: Math.min((state.deductions['property_tax_amount'] || 0) +
                          (state.deductions['state_tax_amount'] || 0) +
                          (state.deductions['local_tax_amount'] || 0), 10000),
            mortgageInterest: state.deductions['mortgage_amount'] || 0,
            charitableCash: state.deductions['charity_cash_amount'] || 0,
            charitableNonCash: state.deductions['charity_goods_amount'] || 0,
            studentLoanInterest: state.deductions['student_loan_amount'] || 0,
            educatorExpenses: state.deductions['educator_amount'] || 0,
            iraDeduction: state.deductions['ira_amount'] || 0,
            hsaContribution: state.deductions['hsa_amount'] || 0,
          },
          credits: {
            ctc: state.credits['child_tax_credit'] || 0,
            childCare: state.credits['childcare_amount'] || 0,
            educationCredit: state.credits['education_amount'] || 0,
            eitc: state.credits['eitc'] || 0,
            saverCredit: state.credits['saver_amount'] || 0,
            energyCredit: state.credits['energy_amount'] || 0,
            evCredit: state.credits['ev_credit'] || 0,
          },
          dependents: state.dependents,
        };

        const response = await fetch('/api/sync', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          console.warn('Backend sync failed:', await response.text());
          return false;
        }

        const result = await response.json();
        console.log('Backend sync successful:', result);
        return true;
      } catch (error) {
        console.warn('Backend sync error:', error);
        return false;
      }
    }

    // Get backend calculation results
    async function getBackendCalculation() {
      try {
        const response = await fetch('/api/calculate/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state_code: state.stateOfResidence }),
        });

        if (!response.ok) {
          console.warn('Backend calculation failed:', await response.text());
          return null;
        }

        return await response.json();
      } catch (error) {
        console.warn('Backend calculation error:', error);
        return null;
      }
    }

    // Get filing status comparison from backend
    async function getBackendFilingStatusComparison() {
      try {
        const response = await fetch('/api/optimize/filing-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        if (!response.ok) return null;
        return await response.json();
      } catch (error) {
        console.warn('Backend filing status comparison error:', error);
        return null;
      }
    }

    // Get optimization recommendations from backend
    async function getBackendOptimizations() {
      try {
        const response = await fetch('/api/optimize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        if (!response.ok) return null;
        return await response.json();
      } catch (error) {
        console.warn('Backend optimization error:', error);
        return null;
      }
    }

    // Load and display comprehensive summary
    async function loadSummary() {
      // First sync state to backend
      await syncToBackend();

      // Try to get backend calculation
      const backendResult = await getBackendCalculation();

      // Compute client-side as fallback
      const comp = computeTaxReturn();

      // Use backend results if available, otherwise fallback to client-side
      let federalRefundOrOwed = comp.refundOrOwed;
      let federalIsRefund = comp.isRefund;
      let stateRefundOrOwed = comp.stateRefund;
      let effectiveRate = comp.effectiveRate;
      let marginalRate = comp.marginalRate;

      if (backendResult && backendResult.federal) {
        federalRefundOrOwed = Math.abs(backendResult.federal.refund_or_owed);
        federalIsRefund = backendResult.federal.is_refund;
        effectiveRate = backendResult.rates?.effective_rate || comp.effectiveRate;
        marginalRate = backendResult.rates?.marginal_rate || comp.marginalRate;

        if (backendResult.state) {
          stateRefundOrOwed = backendResult.state.refund_or_owed;
        }

        // Update comp with backend values for downstream use
        comp.effectiveRate = effectiveRate;
        comp.marginalRate = marginalRate;
        console.log('Using backend calculation results:', backendResult);
      }

      // Update Banner
      const banner = document.getElementById('reviewBanner');
      const rbLabel = document.getElementById('rbLabel');
      const rbAmount = document.getElementById('rbAmount');
      const rbFederal = document.getElementById('rbFederal');
      const rbState = document.getElementById('rbState');

      if (federalIsRefund) {
        banner?.classList.remove('owed');
        if (rbLabel) rbLabel.textContent = 'Your Estimated Total Refund';
        const totalRefund = federalRefundOrOwed + (stateRefundOrOwed > 0 ? stateRefundOrOwed : 0);
        if (rbAmount) rbAmount.textContent = formatCurrency(totalRefund);
      } else {
        banner?.classList.add('owed');
        if (rbLabel) rbLabel.textContent = 'Your Estimated Amount Owed';
        if (rbAmount) rbAmount.textContent = formatCurrency(federalRefundOrOwed);
      }

      if (rbFederal) rbFederal.textContent = `Federal: ${federalIsRefund ? '+' : '-'}${formatCurrency(federalRefundOrOwed)}`;
      if (rbState) rbState.textContent = `State: ${stateRefundOrOwed >= 0 ? '+' : ''}${formatCurrency(stateRefundOrOwed)}`;

      // Update Income Section
      setText('cpGrossIncome', formatCurrency(comp.grossIncome));
      setText('cpWages', formatCurrency(state.taxData.wages));
      setText('cpInterest', formatCurrency(0));
      setText('cpDividends', formatCurrency(0));
      setText('cpSelfEmployment', formatCurrency(0));
      setText('cpOtherIncome', formatCurrency(state.taxData.otherIncome || 0));
      setText('cpTotalGross', formatCurrency(comp.grossIncome));

      // Update Adjustments Section
      setText('cpAdjustments', comp.adjustments > 0 ? `-${formatCurrency(comp.adjustments)}` : '$0');
      setText('cpEducator', formatCurrency(state.deductions['educator_amount'] || 0));
      setText('cpHSA', formatCurrency(state.deductions['hsa_amount'] || 0));
      setText('cpIRA', formatCurrency(state.deductions['ira_amount'] || 0));
      setText('cpStudentLoan', formatCurrency(state.deductions['student_loan_amount'] || 0));
      setText('cpSETax', formatCurrency(0));
      setText('cpTotalAdj', formatCurrency(comp.adjustments));

      // Update AGI
      setText('cpAGI', formatCurrency(comp.agi));

      // Update Deductions Section
      setText('cpDeductions', `-${formatCurrency(comp.deductionUsed)}`);
      setText('cpStandardDed', formatCurrency(comp.standardDeduction));
      setText('cpItemizedDed', formatCurrency(comp.itemizedDeduction));

      // Standard deduction breakdown
      const config = filingStatusConfigs[state.filingStatus] || filingStatusConfigs['single'];
      setText('stdFilingStatus', config.name);
      setText('stdBase', formatCurrency(config.baseDeduction));

      // Show/hide additional deduction rows
      const stdAge65Row = document.getElementById('stdAge65Row');
      const stdBlindRow = document.getElementById('stdBlindRow');
      let additionalDed = 0;
      if (state.personal.age65) additionalDed += config.additionalDeduction;
      if (state.personal.blind) additionalDed += config.additionalDeduction;
      if (state.personal.spouseAge65) additionalDed += config.additionalDeduction;
      if (state.personal.spouseBlind) additionalDed += config.additionalDeduction;

      if (additionalDed > 0) {
        if (stdAge65Row) {
          stdAge65Row.style.display = 'flex';
          setText('stdAge65', formatCurrency(additionalDed));
        }
      }

      // Itemized deduction breakdown
      setText('itemMortgage', formatCurrency(comp.mortgageInterest));
      setText('itemSALT', formatCurrency(comp.saltCapped));
      setText('itemCharity', formatCurrency(comp.charityCash + comp.charityGoods));
      setText('itemMedical', formatCurrency(comp.medicalDeductible));

      // Show SALT warning if capped
      const saltWarning = document.getElementById('saltWarning');
      if (saltWarning && comp.saltTotal > 10000) {
        saltWarning.style.display = 'flex';
      }

      // Deduction selection badges
      const stdBadge = document.getElementById('stdBadge');
      const itemBadge = document.getElementById('itemBadge');
      const stdOption = document.getElementById('stdOption');
      const itemOption = document.getElementById('itemOption');

      if (comp.useItemized) {
        stdBadge?.classList.add('hidden');
        itemBadge?.classList.remove('hidden');
        stdOption?.classList.remove('selected');
        itemOption?.classList.add('selected');
      } else {
        stdBadge?.classList.remove('hidden');
        itemBadge?.classList.add('hidden');
        stdOption?.classList.add('selected');
        itemOption?.classList.remove('selected');
      }

      // Deduction recommendation
      const diff = Math.abs(comp.standardDeduction - comp.itemizedDeduction);
      setText('dedRecText', comp.useItemized ?
        `Itemized deductions save you ${formatCurrency(diff)} more!` :
        `Standard deduction is better for you.`);
      setText('dedRecSavings', `+${formatCurrency(diff)}`);

      // Update Taxable Income
      setText('cpTaxableIncome', formatCurrency(comp.taxableIncome));

      // Update Tax Calculation
      setText('cpTaxBeforeCredits', formatCurrency(comp.taxBeforeCredits));
      setText('cpFilingStatus', config.name);
      setText('cpMarginalRate', `${(comp.marginalRate * 100).toFixed(0)}%`);
      setText('cpEffectiveRate', `${(comp.effectiveRate * 100).toFixed(1)}%`);
      setText('cpTaxBefore', formatCurrency(comp.taxBeforeCredits));

      // Render tax brackets
      renderBracketBreakdown(comp.brackets, comp.taxableIncome);

      // Update Credits Section
      setText('cpCredits', comp.totalCredits > 0 ? `-${formatCurrency(comp.totalCredits)}` : '$0');
      setText('ctcChildCount', state.dependents.filter(d => d.qualifiesForCTC).length);
      setText('cpCTC', formatCurrency(comp.ctcAmount));
      setText('cpChildcare', formatCurrency(comp.childcareCredit));
      setText('cpEITC', formatCurrency(comp.eitcAmount));
      setText('cpEducation', formatCurrency(comp.educationCredit));
      setText('cpSaver', formatCurrency(comp.saverCredit));
      setText('cpEnergy', formatCurrency(comp.energyCredit));
      setText('cpTotalCredits', formatCurrency(comp.totalCredits));
      setText('refundableAmount', formatCurrency(comp.refundableCredits));

      // Update Final Tax
      setText('cpFinalTax', formatCurrency(comp.finalTax));

      // Update Payments Section
      setText('cpPayments', formatCurrency(comp.totalPayments));
      setText('cpW2Withheld', formatCurrency(state.taxData.federalWithheld));
      setText('cpEstimated', formatCurrency(0));
      setText('cp1099Withheld', formatCurrency(0));
      setText('cpTotalPayments', formatCurrency(comp.totalPayments));

      // Update Final Result
      const cprRefund = document.getElementById('cprRefund');
      const cprOwed = document.getElementById('cprOwed');

      if (comp.isRefund) {
        cprRefund?.classList.remove('hidden');
        cprOwed?.classList.add('hidden');
        setText('cprRefundAmount', formatCurrency(comp.refundOrOwed));
        setText('cprRefundExpl', `You overpaid your taxes by ${formatCurrency(comp.refundOrOwed)}`);
      } else {
        cprRefund?.classList.add('hidden');
        cprOwed?.classList.remove('hidden');
        setText('cprOwedAmount', formatCurrency(comp.refundOrOwed));
        setText('cprOwedExpl', `Payment due by April 15, 2026`);
      }

      // Update State Tax Section (prefer backend calculation over simplified client-side)
      const stateCode = state.stateOfResidence;
      const stateConfig = stateTaxRates[stateCode];
      const stateTaxPanel = document.getElementById('stateTaxPanel');

      // Check for backend state tax data
      const hasBackendState = backendResult && backendResult.state;

      if (stateConfig || hasBackendState) {
        stateTaxPanel?.classList.remove('hidden');

        if (hasBackendState) {
          // Use accurate backend state tax calculation
          const backendState = backendResult.state;
          setText('stateNameDisplay', stateConfig?.name || backendState.state_code);
          setText('stateTaxType', stateConfig?.type || 'Calculated');
          setText('stateTaxableIncome', formatCurrency(backendState.taxable_income || comp.agi));
          setText('stateTaxAmount', formatCurrency(backendState.tax_liability || 0));
          setText('stateWithholding', formatCurrency(backendState.withholding || state.taxData.stateWithheld || 0));

          const stateResultLabel = document.getElementById('stateResultLabel');
          const stateResultAmount = document.getElementById('stateResultAmount');
          const backendStateRefund = backendState.refund_or_owed || 0;

          if (backendState.is_refund || backendStateRefund >= 0) {
            if (stateResultLabel) stateResultLabel.textContent = 'State Refund';
            if (stateResultAmount) stateResultAmount.textContent = formatCurrency(Math.abs(backendStateRefund));
          } else {
            if (stateResultLabel) stateResultLabel.textContent = 'State Amount Owed';
            if (stateResultAmount) stateResultAmount.textContent = formatCurrency(Math.abs(backendStateRefund));
          }

          // Update comp with backend state values for downstream use
          comp.stateTax = backendState.tax_liability || 0;
          comp.stateRefund = backendStateRefund;

          console.log('Using backend state tax calculation:', backendState);
        } else if (stateConfig) {
          // Fallback to simplified client-side calculation
          setText('stateNameDisplay', stateConfig.name);
          setText('stateTaxType', stateConfig.type);
          setText('stateTaxableIncome', formatCurrency(comp.agi));
          setText('stateTaxAmount', formatCurrency(comp.stateTax));
          setText('stateWithholding', formatCurrency(state.taxData.stateWithheld || 0));

          const stateResultLabel = document.getElementById('stateResultLabel');
          const stateResultAmount = document.getElementById('stateResultAmount');
          if (comp.stateRefund >= 0) {
            if (stateResultLabel) stateResultLabel.textContent = 'State Refund';
            if (stateResultAmount) stateResultAmount.textContent = formatCurrency(comp.stateRefund);
          } else {
            if (stateResultLabel) stateResultLabel.textContent = 'State Amount Owed';
            if (stateResultAmount) stateResultAmount.textContent = formatCurrency(Math.abs(comp.stateRefund));
          }
        }
      } else {
        stateTaxPanel?.classList.add('hidden');
      }

      // Generate optimization recommendations (async - uses backend when available)
      await generateOptimizations(comp);

      // Setup section toggles
      setupSectionToggles();
    }

    function setText(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    function renderBracketBreakdown(brackets, totalIncome) {
      const container = document.getElementById('bracketBreakdown');
      if (!container) return;

      let html = '';
      let maxIncome = Math.max(...brackets.map(b => b.income));

      brackets.forEach(b => {
        const percentage = maxIncome > 0 ? (b.income / maxIncome) * 100 : 0;
        html += `
          <div class="bracket-row">
            <span class="bracket-rate">${(b.rate * 100).toFixed(0)}%</span>
            <div class="bracket-bar-container">
              <div class="bracket-bar" style="width: ${percentage}%"></div>
            </div>
            <span class="bracket-income">${formatCurrency(b.income)}</span>
            <span class="bracket-tax">${formatCurrency(b.tax)}</span>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function setupSectionToggles() {
      document.querySelectorAll('.cps-header[data-toggle]').forEach(header => {
        header.addEventListener('click', () => {
          const targetId = header.dataset.toggle;
          const target = document.getElementById(targetId);
          if (target) {
            target.classList.toggle('hidden');
            header.classList.toggle('collapsed');
          }
        });
      });
    }

    // Generate optimization recommendations
    async function generateOptimizations(comp) {
      const container = document.getElementById('opRecommendations');
      const potential = document.getElementById('opPotential');
      const panel = document.getElementById('optimizationPanel');

      // Try to get backend optimizations
      const backendOpts = await getBackendOptimizations();

      let recommendations = [];
      let totalPotentialSavings = 0;

      if (backendOpts && backendOpts.recommendations && backendOpts.recommendations.length > 0) {
        // Use backend recommendations
        console.log('Using backend optimization recommendations:', backendOpts);

        totalPotentialSavings = backendOpts.total_potential_savings || 0;

        backendOpts.recommendations.forEach(rec => {
          // Map backend category to icon
          const iconMap = {
            'retirement': 'ðŸ’°',
            'health': 'ðŸ¥',
            'filing_status': 'ðŸ ',
            'deductions': 'ðŸ“',
            'credits': 'ðŸŽ¯',
            'income_timing': 'ðŸ“…',
            'general': 'ðŸ’¡'
          };

          recommendations.push({
            icon: iconMap[rec.category] || 'ðŸ’¡',
            title: rec.title || rec.recommendation,
            desc: rec.description || rec.details || '',
            savings: rec.potential_savings || rec.estimated_savings || 0,
            action: rec.action || 'Learn More',
            priority: rec.priority || 'medium'
          });
        });

        // Sort by savings (highest first)
        recommendations.sort((a, b) => (b.savings || 0) - (a.savings || 0));

      } else {
        // Fall back to client-side recommendations
        console.log('Using client-side optimization recommendations');

        // IRA contribution opportunity
        const iraContrib = state.deductions['ira_amount'] || 0;
        if (iraContrib < 7000) {
          const maxAdditional = 7000 - iraContrib;
          const savings = Math.min(maxAdditional * comp.marginalRate, maxAdditional);
          if (savings > 50) {
            recommendations.push({
              icon: 'ðŸ’°',
              title: 'Maximize IRA Contributions',
              desc: `You can contribute up to ${formatCurrency(maxAdditional)} more to a Traditional IRA and reduce your taxable income.`,
              savings,
              action: 'Learn More',
            });
            totalPotentialSavings += savings;
          }
        }

        // HSA contribution opportunity
        const hsaContrib = state.deductions['hsa_amount'] || 0;
        const hsaLimit = state.filingStatus === 'married_joint' ? 8550 : 4300;
        if (hsaContrib < hsaLimit) {
          const maxAdditional = hsaLimit - hsaContrib;
          const savings = maxAdditional * comp.marginalRate;
          if (savings > 50) {
            recommendations.push({
              icon: 'ðŸ¥',
              title: 'Contribute to HSA',
              desc: `If you have a high-deductible health plan, you can contribute up to ${formatCurrency(maxAdditional)} more.`,
              savings,
              action: 'Learn More',
            });
            totalPotentialSavings += savings;
          }
        }

        // Filing status optimization (if HOH is available but not selected)
        if (state.filingStatus === 'single' && state.wizard.hasDependents === 'yes' && state.wizard.paidHouseholdCosts === 'yes') {
          const hohTax = computeTaxForStatus('head_of_household');
          const currentTax = comp.finalTax;
          const savings = currentTax - hohTax;
          if (savings > 0) {
            recommendations.push({
              icon: 'ðŸ ',
              title: 'Consider Head of Household Status',
              desc: 'Based on your dependents, you may qualify for Head of Household which has lower tax rates.',
              savings,
              action: 'Compare',
            });
            totalPotentialSavings += savings;
          }
        }

        // Itemized vs Standard suggestion
        if (!comp.useItemized && comp.itemizedDeduction > comp.standardDeduction * 0.7) {
          const gap = comp.standardDeduction - comp.itemizedDeduction;
          recommendations.push({
            icon: 'ðŸ“',
            title: 'Track More Deductions',
            desc: `You're ${formatCurrency(gap)} away from benefiting from itemized deductions. Consider tracking charitable donations.`,
            savings: 0,
            action: 'Add Deductions',
          });
        }
      }

      // Render recommendations
      if (recommendations.length === 0) {
        panel?.classList.add('hidden');
        return;
      }

      panel?.classList.remove('hidden');
      if (potential) potential.textContent = `Potential savings: ${formatCurrency(totalPotentialSavings)}`;

      let html = '';
      recommendations.forEach(rec => {
        const priorityClass = rec.priority === 'high' ? 'style="border-left: 3px solid #22c55e;"' : '';
        html += `
          <div class="op-rec" ${priorityClass}>
            <span class="opr-icon">${rec.icon}</span>
            <div class="opr-content">
              <div class="opr-title">${rec.title}</div>
              <div class="opr-desc">${rec.desc}</div>
            </div>
            ${rec.savings > 0 ? `<span class="opr-savings">Save ${formatCurrency(rec.savings)}</span>` : ''}
          </div>
        `;
      });

      if (container) container.innerHTML = html;
    }

    function computeTaxForStatus(status) {
      const originalStatus = state.filingStatus;
      state.filingStatus = status;
      const result = computeTaxReturn(status);
      state.filingStatus = originalStatus;
      return result.finalTax;
    }

    // Filing Status Comparison Modal
    document.getElementById('btnCompareStatuses')?.addEventListener('click', () => {
      showFilingStatusComparison();
    });

    document.getElementById('closeFilingComparison')?.addEventListener('click', () => {
      document.getElementById('filingComparisonModal')?.classList.add('hidden');
    });

    document.getElementById('cancelFilingChange')?.addEventListener('click', () => {
      document.getElementById('filingComparisonModal')?.classList.add('hidden');
    });

    let selectedComparisonStatus = null;

    async function showFilingStatusComparison() {
      const modal = document.getElementById('filingComparisonModal');
      const grid = document.getElementById('filingComparisonGrid');
      if (!modal || !grid) return;

      // Show loading state
      grid.innerHTML = '<div style="text-align:center;padding:2rem;color:#666;">Loading comparison...</div>';
      modal.classList.remove('hidden');

      // Sync to backend first
      await syncToBackend();

      // Try to get backend comparison
      const backendComparison = await getBackendFilingStatusComparison();

      const currentTax = taxComputation.finalTax;
      let html = '';
      let bestStatus = state.filingStatus;
      let bestTax = currentTax;

      // Use backend data if available
      if (backendComparison && backendComparison.comparisons) {
        console.log('Using backend filing status comparison:', backendComparison);

        // Find recommended status from backend
        if (backendComparison.recommended) {
          bestStatus = backendComparison.recommended.filing_status || state.filingStatus;
          bestTax = backendComparison.recommended.tax_liability || currentTax;
        }

        // Build cards from backend comparison
        Object.keys(filingStatusConfigs).forEach(status => {
          const config = filingStatusConfigs[status];
          const isQualified = checkStatusQualification(status);

          // Find backend data for this status
          const backendData = backendComparison.comparisons.find(c =>
            c.filing_status === status ||
            c.filing_status?.toLowerCase().replace(/ /g, '_') === status
          );

          const tax = backendData ? backendData.tax_liability : (isQualified ? computeTaxForStatus(status) : null);
          const isCurrent = status === state.filingStatus;
          const diff = tax !== null ? currentTax - tax : 0;

          let badges = '';
          if (isCurrent) badges += '<span class="cc-badge current">Current</span>';
          if (status === bestStatus && isQualified) badges += '<span class="cc-badge best">Best Option</span>';
          if (!isQualified) badges += '<span class="cc-badge disabled">Not Qualified</span>';

          html += `
            <div class="comparison-card ${isCurrent ? 'current' : ''} ${!isQualified ? 'disabled' : ''}"
                 data-status="${status}">
              <span class="cc-icon">${config.icon}</span>
              <div class="cc-info">
                <div class="cc-name">${config.name}</div>
                <div class="cc-deduction">Standard deduction: ${formatCurrency(backendData?.standard_deduction || config.baseDeduction)}</div>
              </div>
              <div class="cc-result">
                <div class="cc-tax">${tax !== null ? formatCurrency(tax) : 'N/A'}</div>
                ${diff !== 0 && isQualified ? `<div class="cc-diff ${diff > 0 ? 'savings' : 'costs'}">${diff > 0 ? 'Save ' : 'Costs '}${formatCurrency(Math.abs(diff))}</div>` : ''}
              </div>
              ${badges}
            </div>
          `;
        });
      } else {
        // Fall back to client-side calculation
        console.log('Using client-side filing status comparison');

        Object.keys(filingStatusConfigs).forEach(status => {
          const config = filingStatusConfigs[status];
          const isQualified = checkStatusQualification(status);
          const tax = isQualified ? computeTaxForStatus(status) : null;

          if (tax !== null && tax < bestTax) {
            bestTax = tax;
            bestStatus = status;
          }

          const isCurrent = status === state.filingStatus;
          const diff = tax !== null ? currentTax - tax : 0;

          let badges = '';
          if (isCurrent) badges += '<span class="cc-badge current">Current</span>';
          if (status === bestStatus && isQualified) badges += '<span class="cc-badge best">Best Option</span>';
          if (!isQualified) badges += '<span class="cc-badge disabled">Not Qualified</span>';

          html += `
            <div class="comparison-card ${isCurrent ? 'current' : ''} ${!isQualified ? 'disabled' : ''}"
                 data-status="${status}">
              <span class="cc-icon">${config.icon}</span>
              <div class="cc-info">
                <div class="cc-name">${config.name}</div>
                <div class="cc-deduction">Standard deduction: ${formatCurrency(config.baseDeduction)}</div>
              </div>
              <div class="cc-result">
                <div class="cc-tax">${tax !== null ? formatCurrency(tax) : 'N/A'}</div>
                ${diff !== 0 && isQualified ? `<div class="cc-diff ${diff > 0 ? 'savings' : 'costs'}">${diff > 0 ? 'Save ' : 'Costs '}${formatCurrency(Math.abs(diff))}</div>` : ''}
              </div>
              ${badges}
            </div>
          `;
        });
      }

      grid.innerHTML = html;

      // Add click handlers
      grid.querySelectorAll('.comparison-card:not(.disabled)').forEach(card => {
        card.addEventListener('click', () => {
          grid.querySelectorAll('.comparison-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          selectedComparisonStatus = card.dataset.status;
        });
      });
    }

    function checkStatusQualification(status) {
      const w = state.wizard;

      switch (status) {
        case 'single':
          return true; // Always available as fallback
        case 'married_joint':
          return w.maritalStatus === 'married' || (w.maritalStatus === 'widowed' && w.spouseDeathYear === '2025');
        case 'married_separate':
          return w.maritalStatus === 'married';
        case 'head_of_household':
          return (w.maritalStatus === 'single' || w.maritalStatus === 'widowed') &&
                 w.hasDependents === 'yes' && w.paidHouseholdCosts === 'yes';
        case 'qualifying_widow':
          return w.maritalStatus === 'widowed' &&
                 (w.spouseDeathYear === '2024' || w.spouseDeathYear === '2023') &&
                 w.hasDependents === 'yes';
        default:
          return false;
      }
    }

    document.getElementById('applyFilingChange')?.addEventListener('click', () => {
      if (selectedComparisonStatus && selectedComparisonStatus !== state.filingStatus) {
        state.filingStatus = selectedComparisonStatus;
        loadSummary();
        updateRefund();
        updateInfoCard();
      }
      document.getElementById('filingComparisonModal')?.classList.add('hidden');
    });

    // State Tax Comparison Modal
    document.getElementById('btnCompareStates')?.addEventListener('click', () => {
      showStateComparison();
    });

    document.getElementById('closeStateComparison')?.addEventListener('click', () => {
      document.getElementById('stateComparisonModal')?.classList.add('hidden');
    });

    document.getElementById('closeStateModal')?.addEventListener('click', () => {
      document.getElementById('stateComparisonModal')?.classList.add('hidden');
    });

    function showStateComparison() {
      const modal = document.getElementById('stateComparisonModal');
      const grid = document.getElementById('stateComparisonGrid');
      const insight = document.getElementById('stateInsight');
      if (!modal || !grid) return;

      const currentState = state.stateOfResidence;
      const currentStateTax = taxComputation.stateTax;

      let html = '';
      let lowestTaxState = currentState;
      let lowestTax = currentStateTax;

      // Calculate for key states
      const compareStates = ['CA', 'NY', 'TX', 'FL', 'WA', 'IL', 'PA', 'NJ', 'GA', 'NC'];

      compareStates.forEach(stateCode => {
        const stateConfig = stateTaxRates[stateCode];
        if (!stateConfig) return;

        const stateTax = taxComputation.agi * stateConfig.rate;
        const isCurrent = stateCode === currentState;
        const diff = currentStateTax - stateTax;
        const isNoTax = stateConfig.rate === 0;

        if (stateTax < lowestTax) {
          lowestTax = stateTax;
          lowestTaxState = stateCode;
        }

        html += `
          <div class="state-card ${isCurrent ? 'current' : ''} ${isNoTax ? 'no-tax' : ''}">
            <div class="sc-name">${stateConfig.name}</div>
            <div class="sc-tax">${isNoTax ? 'No Tax' : formatCurrency(stateTax)}</div>
            ${!isCurrent && diff !== 0 ? `<div class="sc-diff ${diff > 0 ? 'savings' : 'costs'}">${diff > 0 ? 'Save ' : '+'}${formatCurrency(Math.abs(diff))}</div>` : ''}
            ${isCurrent ? '<div class="sc-diff">Current</div>' : ''}
          </div>
        `;
      });

      grid.innerHTML = html;

      // Generate insight
      if (insight) {
        const savings = currentStateTax - lowestTax;
        if (savings > 0 && lowestTaxState !== currentState) {
          insight.innerHTML = `
            <div class="insight-header">ðŸ’¡ State Tax Insight</div>
            <div class="insight-text">
              Living in ${stateTaxRates[lowestTaxState].name} instead of ${stateTaxRates[currentState]?.name || 'your current state'} would save you <strong>${formatCurrency(savings)}</strong> in state income tax per year. However, consider cost of living, job opportunities, and other factors before relocating.
            </div>
          `;
        } else {
          insight.innerHTML = `
            <div class="insight-header">ðŸ’¡ State Tax Insight</div>
            <div class="insight-text">
              ${stateTaxRates[currentState]?.rate === 0 ?
                'You\'re already in a state with no income tax! This is optimal from a state tax perspective.' :
                'Your current state has competitive tax rates. Moving to a no-income-tax state could save you ' + formatCurrency(currentStateTax) + ' annually.'}
            </div>
          `;
        }
      }

      modal.classList.remove('hidden');
    }

    // Download and Print functionality
    document.getElementById('btnDownloadPDF')?.addEventListener('click', () => {
      downloadTaxSummary();
    });

    document.getElementById('btnPrintSummary')?.addEventListener('click', () => {
      window.print();
    });

    function generatePDFSummary() {
      // Create a printable summary
      const comp = taxComputation;
      const config = filingStatusConfigs[state.filingStatus] || filingStatusConfigs['single'];

      const content = `
TAX RETURN SUMMARY - TAX YEAR 2025
Generated: ${new Date().toLocaleDateString()}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TAXPAYER INFORMATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Name: ${state.personal.firstName} ${state.personal.lastName}
Filing Status: ${config.name}
State of Residence: ${stateTaxRates[state.stateOfResidence]?.name || state.stateOfResidence}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
INCOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Wages, Salaries, Tips (W-2)    ${formatCurrency(state.taxData.wages).padStart(15)}
Other Income                   ${formatCurrency(state.taxData.otherIncome || 0).padStart(15)}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GROSS INCOME                   ${formatCurrency(comp.grossIncome).padStart(15)}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ADJUSTMENTS TO INCOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Total Adjustments             -${formatCurrency(comp.adjustments).padStart(14)}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ADJUSTED GROSS INCOME (AGI)    ${formatCurrency(comp.agi).padStart(15)}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DEDUCTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${comp.useItemized ? 'Itemized' : 'Standard'} Deduction Used  -${formatCurrency(comp.deductionUsed).padStart(14)}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TAXABLE INCOME                 ${formatCurrency(comp.taxableIncome).padStart(15)}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TAX CALCULATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Tax Before Credits             ${formatCurrency(comp.taxBeforeCredits).padStart(15)}
Total Credits                 -${formatCurrency(comp.totalCredits).padStart(14)}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOTAL FEDERAL TAX              ${formatCurrency(comp.finalTax).padStart(15)}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
PAYMENTS & WITHHOLDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Federal Withholding (W-2)      ${formatCurrency(comp.totalPayments).padStart(15)}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${comp.isRefund ? 'REFUND' : 'AMOUNT OWED'}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Federal ${comp.isRefund ? 'Refund' : 'Owed'}                  ${formatCurrency(comp.refundOrOwed).padStart(15)}
State ${comp.stateRefund >= 0 ? 'Refund' : 'Owed'}                    ${formatCurrency(Math.abs(comp.stateRefund)).padStart(15)}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOTAL ${comp.isRefund ? 'REFUND' : 'OWED'}                    ${formatCurrency(comp.refundOrOwed + (comp.stateRefund >= 0 ? comp.stateRefund : -comp.stateRefund)).padStart(15)}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TAX RATES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Marginal Tax Rate:             ${(comp.marginalRate * 100).toFixed(0)}%
Effective Tax Rate:            ${(comp.effectiveRate * 100).toFixed(1)}%

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
This is an estimate. Final amounts may vary based on
additional information and IRS processing.
Generated by TaxFlow - Tax Year 2025
      `.trim();

      // Create download
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `TaxReturn_2025_${state.personal.lastName || 'Summary'}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Try to download PDF from backend, fall back to text summary
    async function downloadTaxSummary() {
      try {
        // First sync to backend
        await syncToBackend();

        // Try backend PDF export
        const response = await fetch('/api/export/pdf', {
          method: 'GET',
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `TaxReturn_2025_${state.personal.lastName || 'Summary'}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          console.log('PDF downloaded from backend');
          return;
        }
      } catch (error) {
        console.warn('Backend PDF export failed, falling back to text:', error);
      }

      // Fall back to client-side text summary
      generatePDFSummary();
    }

    // Navigation buttons
    document.getElementById('btnBack6')?.addEventListener('click', () => goToStep(5));
    document.getElementById('btnFinish')?.addEventListener('click', async () => {
      const confirmed = confirm('Ready to complete your tax return? This will finalize your return for filing.');
      if (confirmed) {
        alert('Your tax return has been completed! In a production environment, this would submit to the IRS e-file system.');
      }
    });

    document.getElementById('btnFileNow')?.addEventListener('click', () => {
      document.getElementById('btnFinish')?.click();
    });

    // ============ REFUND CALCULATION ============
    function updateRefund() {
      // Simple estimate: withheld - estimated tax + credits
      const wages = state.taxData.wages;
      const withheld = state.taxData.federalWithheld;

      // Get correct standard deduction based on filing status (2025)
      let standardDeduction = standardDeductions[state.filingStatus] || 15750;

      // Add additional deduction for age 65+ and blindness (2025 amounts)
      if (state.filingStatus === 'single' || state.filingStatus === 'head_of_household') {
        if (state.personal.age65) standardDeduction += 1950;
        if (state.personal.blind) standardDeduction += 1950;
      } else {
        // Married filing jointly/separately or Qualifying Surviving Spouse
        if (state.personal.age65) standardDeduction += 1550;
        if (state.personal.blind) standardDeduction += 1550;
        if (state.personal.spouseAge65) standardDeduction += 1550;
        if (state.personal.spouseBlind) standardDeduction += 1550;
      }

      // Get tax brackets based on filing status
      let brackets;
      if (state.filingStatus === 'married_joint' || state.filingStatus === 'qualifying_widow') {
        brackets = [
          { limit: 23850, rate: 0.10 },
          { limit: 96950, rate: 0.12 },
          { limit: 206700, rate: 0.22 },
          { limit: 394600, rate: 0.24 },
          { limit: 501050, rate: 0.32 },
          { limit: 751600, rate: 0.35 },
          { limit: Infinity, rate: 0.37 },
        ];
      } else if (state.filingStatus === 'head_of_household') {
        brackets = [
          { limit: 17000, rate: 0.10 },
          { limit: 64850, rate: 0.12 },
          { limit: 103350, rate: 0.22 },
          { limit: 197300, rate: 0.24 },
          { limit: 250500, rate: 0.32 },
          { limit: 626350, rate: 0.35 },
          { limit: Infinity, rate: 0.37 },
        ];
      } else {
        // Single or married filing separately
        brackets = [
          { limit: 11925, rate: 0.10 },
          { limit: 48475, rate: 0.12 },
          { limit: 103350, rate: 0.22 },
          { limit: 197300, rate: 0.24 },
          { limit: 250525, rate: 0.32 },
          { limit: 626350, rate: 0.35 },
          { limit: Infinity, rate: 0.37 },
        ];
      }

      // Calculate estimated tax
      let estimatedTax = 0;
      if (wages > 0) {
        const taxableIncome = Math.max(0, wages - standardDeduction);

        let remaining = taxableIncome;
        let prevLimit = 0;
        for (const bracket of brackets) {
          const bracketAmount = Math.min(remaining, bracket.limit - prevLimit);
          estimatedTax += bracketAmount * bracket.rate;
          remaining -= bracketAmount;
          prevLimit = bracket.limit;
          if (remaining <= 0) break;
        }
      }

      // Apply credits
      const totalCredits = state.credits.totalCredits || 0;
      estimatedTax = Math.max(0, estimatedTax - totalCredits);

      const refund = withheld - estimatedTax;

      if (elements.refundAmount) {
        elements.refundAmount.textContent = formatCurrency(Math.abs(refund));
        elements.refundAmount.className = 'refund-amount ' + (refund >= 0 ? 'positive' : 'negative');
      }

      const refundLabel = document.querySelector('.refund-label');
      if (refundLabel) {
        refundLabel.textContent = refund < 0 ? 'Estimated Amount Owed' : 'Estimated Refund';
      }

      if (elements.federalRefund) {
        elements.federalRefund.textContent = formatCurrency(Math.abs(refund));
        elements.federalRefund.className = 'breakdown-value ' + (refund >= 0 ? 'positive' : 'negative');
      }

      // State refund (simplified)
      if (elements.stateRefund) {
        if (state.stateOfResidence && !['AK', 'FL', 'NV', 'NH', 'SD', 'TN', 'TX', 'WA', 'WY'].includes(state.stateOfResidence)) {
          const stateWithheld = state.taxData.stateWithheld;
          elements.stateRefund.textContent = formatCurrency(stateWithheld) + ' withheld';
        } else {
          elements.stateRefund.textContent = 'No state tax';
        }
      }
    }

    // ============ INFO CARD ============
    function updateInfoCard() {
      const statusMap = {
        'single': 'Single',
        'married_joint': 'Married (Joint)',
        'married_separate': 'Married (Separate)',
        'head_of_household': 'Head of Household',
        'qualifying_widow': 'Qualifying Surviving Spouse',
      };

      const infoStatus = document.getElementById('infoStatus');
      const infoState = document.getElementById('infoState');
      const infoDocuments = document.getElementById('infoDocuments');

      if (infoStatus) infoStatus.textContent = statusMap[state.filingStatus] || 'â€”';
      if (infoState) infoState.textContent = state.stateOfResidence || 'â€”';
      if (infoDocuments) infoDocuments.textContent = state.documents.length;
    }

    // ============ UTILITIES ============
    function formatCurrency(value) {
      if (value === null || value === undefined) return '$0';
      return '$' + Number(value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    // ============ RESET ============
    document.getElementById('btnReset').addEventListener('click', async () => {
      if (confirm('Start over? This will clear all your data.')) {
        // Reset all state
        state.currentStep = 1;
        state.currentSubstep = 'welcome';
        state.filingStatus = null;
        state.stateOfResidence = null;
        state.documents = [];
        state.taxData = { wages: 0, federalWithheld: 0, otherIncome: 0, stateWages: 0, stateWithheld: 0 };
        state.deductions = {};
        state.credits = {};
        state.wizard = {
          maritalStatus: null,
          spouseDeathYear: null,
          marriedFilingChoice: null,
          hasDependents: null,
          paidHouseholdCosts: null,
          isReturningUser: false,
          importSource: null,
        };
        state.personal = {
          firstName: '', middleInitial: '', lastName: '', ssn: '',
          dob: '', street: '', city: '', state: '', zip: '',
          age65: false, blind: false,
          spouseFirstName: '', spouseMiddleInitial: '', spouseLastName: '',
          spouseSsn: '', spouseDob: '', spouseAge65: false, spouseBlind: false,
        };
        state.dependents = [];
        dependentCounter = 0;

        // Reset UI elements
        document.querySelectorAll('.option-btn, .wizard-btn, .status-option, .deduction-option, .credit-option').forEach(b => {
          b.classList.remove('selected', 'selected-no');
        });

        const stateSelectEl = document.getElementById('stateSelect');
        if (stateSelectEl) stateSelectEl.value = '';

        // Clear forms
        document.querySelectorAll('#step1f-personal input').forEach(input => {
          if (input.type === 'checkbox') input.checked = false;
          else input.value = '';
        });

        // Clear dependent forms
        if (elements.dependentsList) elements.dependentsList.innerHTML = '';
        if (elements.documentsList) elements.documentsList.innerHTML = '';
        if (elements.chatMessages) elements.chatMessages.innerHTML = '';

        // Hide amount inputs
        document.querySelectorAll('.amount-input, .credit-amount-input').forEach(el => {
          el.classList.add('hidden');
        });

        // Reset summaries
        document.getElementById('dependentsSummary')?.classList.add('hidden');
        document.getElementById('manualStatus')?.classList.add('hidden');

        updateRefund();
        updateInfoCard();

        // Show welcome modal again
        hideAllSubsteps();
        elements.stepViews.forEach(view => view.classList.add('hidden'));
        showWelcomeModal();

        await callChat({ action: 'reset' });
      }
    });

    // ============ MOBILE NAVIGATION & GESTURES ============

    // Update mobile progress bar
    function updateMobileProgress() {
      const totalSteps = 6;
      const progress = (state.currentStep / totalSteps) * 100;
      const progressBar = document.getElementById('mobileProgressBar');
      if (progressBar) {
        progressBar.style.width = `${progress}%`;
      }
    }

    // Mobile bottom navigation handler
    function setupMobileNav() {
      const navItems = document.querySelectorAll('.mobile-bottom-nav .nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', () => {
          const step = parseInt(item.dataset.step);
          if (step && step <= state.currentStep + 1) {
            goToStep(step);
            updateMobileNavActive();
          } else {
            showToast('Complete the current step first', 'warning');
          }
        });
      });
    }

    // Update active state on mobile nav
    function updateMobileNavActive() {
      const navItems = document.querySelectorAll('.mobile-bottom-nav .nav-item');
      navItems.forEach(item => {
        const step = parseInt(item.dataset.step);
        item.classList.toggle('active', step === state.currentStep);
      });
      updateMobileProgress();
    }

    // Touch swipe gesture support
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    const swipeThreshold = 50;

    function setupSwipeGestures() {
      const container = document.querySelector('.app-container');
      if (!container) return;

      container.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
      }, { passive: true });

      container.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
      }, { passive: true });
    }

    function handleSwipe() {
      const diffX = touchEndX - touchStartX;
      const diffY = touchEndY - touchStartY;

      // Only handle horizontal swipes (ignore vertical scrolling)
      if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > swipeThreshold) {
        if (diffX > 0) {
          // Swipe right - go back
          if (state.currentStep > 1) {
            goToStep(state.currentStep - 1);
            showToast('Previous step', 'info', 1500);
          }
        } else {
          // Swipe left - go forward (if allowed)
          if (state.currentStep < 6) {
            goToStep(state.currentStep + 1);
            showToast('Next step', 'info', 1500);
          }
        }
        updateMobileNavActive();
      }
    }

    // Haptic feedback (if supported)
    function hapticFeedback(type = 'light') {
      if ('vibrate' in navigator) {
        const patterns = {
          light: [10],
          medium: [20],
          heavy: [30],
          success: [10, 50, 10],
          error: [50, 50, 50]
        };
        navigator.vibrate(patterns[type] || patterns.light);
      }
    }

    // Detect if mobile device
    function isMobile() {
      return window.innerWidth <= 600 ||
             ('ontouchstart' in window) ||
             (navigator.maxTouchPoints > 0);
    }

    // Initialize mobile features
    function initMobile() {
      if (isMobile()) {
        setupMobileNav();
        setupSwipeGestures();
        updateMobileNavActive();

        // Add haptic feedback to buttons
        document.querySelectorAll('.btn, .option-card').forEach(el => {
          el.addEventListener('touchstart', () => hapticFeedback('light'), { passive: true });
        });
      }
    }

    // ============ SMART INSIGHTS ============
    const smartInsightsState = {
      insights: [],
      dismissedIds: new Set(),
      appliedIds: new Set(),
      isLoading: false,
      lastFetchTime: 0,
      fetchCooldown: 5000, // 5 seconds between fetches
    };

    async function fetchSmartInsights() {
      // Check cooldown to prevent rapid re-fetching
      const now = Date.now();
      if (now - smartInsightsState.lastFetchTime < smartInsightsState.fetchCooldown) {
        return;
      }

      // Don't fetch if no meaningful data
      const wages = state.taxData?.wages || 0;
      const hasIncome = wages > 0 || state.documents.length > 0;

      if (!hasIncome) {
        showInsightsEmpty();
        return;
      }

      smartInsightsState.lastFetchTime = now;
      showInsightsLoading();

      try {
        const response = await fetch('/api/smart-insights', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        if (!response.ok) {
          throw new Error('Failed to fetch insights');
        }

        const data = await response.json();
        smartInsightsState.insights = data.insights || [];

        // Filter out dismissed insights
        const activeInsights = smartInsightsState.insights.filter(
          i => !smartInsightsState.dismissedIds.has(i.id)
        );

        if (activeInsights.length === 0) {
          showInsightsEmpty();
        } else {
          renderInsights(activeInsights);
        }
      } catch (error) {
        console.error('Error fetching smart insights:', error);
        // Fall back to local insights generation
        generateLocalInsights();
      }
    }

    function generateLocalInsights() {
      const insights = [];
      const comp = getLatestComputationOrNull();

      if (!comp) {
        showInsightsEmpty();
        return;
      }

      const marginalRate = comp.marginalRate || 0.22;

      // IRA contribution insight
      const iraContrib = state.deductions['ira_amount'] || 0;
      const iraLimit = 7000;
      if (iraContrib < iraLimit) {
        const additionalContrib = iraLimit - iraContrib;
        const savings = Math.round(additionalContrib * marginalRate);
        if (savings > 100) {
          insights.push({
            id: 'ira_contribution',
            type: 'retirement',
            category: 'Retirement',
            title: 'Maximize IRA Contributions',
            description: `Contributing an additional ${formatCurrency(additionalContrib)} to a Traditional IRA could reduce your taxable income.`,
            estimated_savings: savings,
            priority: 'high',
            action_type: 'apply_deduction',
            action_data: { field: 'ira_amount', value: iraLimit },
          });
        }
      }

      // HSA contribution insight
      const hsaContrib = state.deductions['hsa_amount'] || 0;
      const hsaLimit = state.filingStatus === 'married_joint' ? 8550 : 4300;
      if (hsaContrib < hsaLimit) {
        const additionalContrib = hsaLimit - hsaContrib;
        const savings = Math.round(additionalContrib * marginalRate);
        if (savings > 100) {
          insights.push({
            id: 'hsa_contribution',
            type: 'retirement',
            category: 'Healthcare',
            title: 'Maximize HSA Contributions',
            description: `If you have a high-deductible health plan, contributing ${formatCurrency(additionalContrib)} more to your HSA provides triple tax benefits.`,
            estimated_savings: savings,
            priority: 'high',
            action_type: 'apply_deduction',
            action_data: { field: 'hsa_amount', value: hsaLimit },
          });
        }
      }

      // Filing status optimization
      if (state.filingStatus === 'single' && state.wizard.hasDependents === 'yes') {
        insights.push({
          id: 'filing_status_hoh',
          type: 'filing_status',
          category: 'Filing Status',
          title: 'Consider Head of Household',
          description: 'Based on your dependents, you may qualify for Head of Household status with lower tax rates and higher standard deduction.',
          estimated_savings: 1500,
          priority: 'medium',
          action_type: 'change_filing_status',
          action_data: { status: 'head_of_household' },
        });
      }

      // 401k optimization for self-employed
      if (state.taxData.selfEmploymentIncome > 0) {
        const seIncome = state.taxData.selfEmploymentIncome;
        const current401k = state.deductions['solo_401k'] || 0;
        const maxContrib = Math.min(69000, seIncome * 0.25);
        if (current401k < maxContrib && maxContrib > 10000) {
          const savings = Math.round((maxContrib - current401k) * marginalRate);
          insights.push({
            id: 'solo_401k',
            type: 'retirement',
            category: 'Self-Employed',
            title: 'Open a Solo 401(k)',
            description: `As a self-employed individual, you could contribute up to ${formatCurrency(maxContrib)} to a Solo 401(k) and significantly reduce your tax burden.`,
            estimated_savings: savings,
            priority: 'high',
            action_type: 'open_optimizer',
            action_data: { tab: 'retirement' },
          });
        }
      }

      // Entity structure optimization for high self-employment income
      if (state.taxData.selfEmploymentIncome > 50000) {
        insights.push({
          id: 'entity_structure',
          type: 'entity',
          category: 'Business Structure',
          title: 'S-Corp Tax Savings',
          description: 'With your self-employment income level, an S-Corp election could reduce self-employment taxes through reasonable salary structuring.',
          estimated_savings: Math.round(state.taxData.selfEmploymentIncome * 0.05),
          priority: 'medium',
          action_type: 'open_optimizer',
          action_data: { tab: 'entity' },
        });
      }

      smartInsightsState.insights = insights;

      const activeInsights = insights.filter(i => !smartInsightsState.dismissedIds.has(i.id));

      if (activeInsights.length === 0) {
        showInsightsEmpty();
      } else {
        renderInsights(activeInsights);
      }
    }

    function getLatestComputationOrNull() {
      try {
        return computeTax();
      } catch (e) {
        return null;
      }
    }

    function showInsightsLoading() {
      const loading = document.getElementById('insightsLoading');
      const empty = document.getElementById('insightsEmpty');
      const container = document.getElementById('insightsContainer');
      const total = document.getElementById('insightsTotalSavings');
      const badge = document.getElementById('insightsBadge');

      if (loading) loading.style.display = 'block';
      if (empty) empty.style.display = 'none';
      if (container) container.style.display = 'none';
      if (total) total.style.display = 'none';
      if (badge) badge.style.display = 'none';
    }

    function showInsightsEmpty() {
      const loading = document.getElementById('insightsLoading');
      const empty = document.getElementById('insightsEmpty');
      const container = document.getElementById('insightsContainer');
      const total = document.getElementById('insightsTotalSavings');
      const badge = document.getElementById('insightsBadge');

      if (loading) loading.style.display = 'none';
      if (empty) empty.style.display = 'block';
      if (container) container.style.display = 'none';
      if (total) total.style.display = 'none';
      if (badge) badge.style.display = 'none';

      // Update checklist based on entered data
      updateInsightsChecklist();
    }

    function updateInsightsChecklist() {
      const checklist = document.getElementById('insightsChecklist');
      if (!checklist) return;

      // Check income
      const incomeItem = checklist.querySelector('[data-check="income"]');
      if (incomeItem) {
        const hasIncome = state.taxData.wages > 0 ||
                         state.taxData.selfEmploymentIncome > 0 ||
                         state.documents.length > 0;
        incomeItem.classList.toggle('completed', hasIncome);
        incomeItem.querySelector('.check-icon').textContent = hasIncome ? 'âœ“' : 'â—‹';
      }

      // Check filing status
      const filingItem = checklist.querySelector('[data-check="filing"]');
      if (filingItem) {
        const hasFiling = state.filingStatus !== null;
        filingItem.classList.toggle('completed', hasFiling);
        filingItem.querySelector('.check-icon').textContent = hasFiling ? 'âœ“' : 'â—‹';
      }

      // Check deductions
      const deductionsItem = checklist.querySelector('[data-check="deductions"]');
      if (deductionsItem) {
        const hasDeductions = Object.values(state.deductions).some(v => v && v > 0);
        deductionsItem.classList.toggle('completed', hasDeductions);
        deductionsItem.querySelector('.check-icon').textContent = hasDeductions ? 'âœ“' : 'â—‹';
      }
    }

    function scrollToFirstInput() {
      // Find first incomplete checklist item and scroll to relevant section
      const incomeComplete = state.taxData.wages > 0 || state.documents.length > 0;
      const filingComplete = state.filingStatus !== null;

      if (!filingComplete) {
        // Scroll to filing status wizard (step 1)
        goToStep(1);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else if (!incomeComplete) {
        // Scroll to income section (step 2)
        goToStep(2);
        const incomeSection = document.getElementById('step-2');
        if (incomeSection) {
          incomeSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      } else {
        // Scroll to deductions section (step 3)
        goToStep(3);
        const deductionsSection = document.getElementById('step-3');
        if (deductionsSection) {
          deductionsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }
    }

    function renderInsights(insights) {
      const loading = document.getElementById('insightsLoading');
      const empty = document.getElementById('insightsEmpty');
      const container = document.getElementById('insightsContainer');
      const total = document.getElementById('insightsTotalSavings');
      const badge = document.getElementById('insightsBadge');
      const totalAmount = document.getElementById('totalSavingsAmount');
      const headerEnhanced = document.getElementById('insightsHeaderEnhanced');
      const totalPotential = document.getElementById('insightsTotalPotential');

      if (loading) loading.style.display = 'none';
      if (empty) empty.style.display = 'none';
      if (container) container.style.display = 'block';

      // Sort insights by savings amount (descending)
      const sortedInsights = [...insights].sort((a, b) =>
        (b.estimated_savings || 0) - (a.estimated_savings || 0)
      );

      // Find max savings for progress bar calculation
      const maxSavings = sortedInsights.length > 0 ? (sortedInsights[0].estimated_savings || 0) : 0;

      // Update badge
      if (badge) {
        badge.textContent = sortedInsights.length;
        badge.style.display = sortedInsights.length > 0 ? 'inline-block' : 'none';
      }

      // Calculate total savings
      const totalSavings = sortedInsights.reduce((sum, i) => sum + (i.estimated_savings || 0), 0);

      // Show enhanced header with total potential
      if (headerEnhanced && totalSavings > 0) {
        headerEnhanced.style.display = 'flex';
        if (totalPotential) {
          animateCountUp(totalPotential, totalSavings);
        }
      }

      if (total && totalSavings > 0) {
        total.style.display = 'flex';
        if (totalAmount) totalAmount.textContent = formatCurrency(totalSavings);
      }

      // Render insight cards with visual hierarchy
      let html = '';
      sortedInsights.forEach((insight, index) => {
        const isApplied = smartInsightsState.appliedIds.has(insight.id);
        const savings = insight.estimated_savings || 0;

        // Determine tier based on savings amount and position
        let tierClass = '';
        if (index === 0 && savings > 500) {
          tierClass = 'tier-top';
        } else if (savings > 1000) {
          tierClass = 'tier-high';
        } else if (savings >= 100) {
          tierClass = 'tier-medium';
        } else {
          tierClass = 'tier-low';
        }

        const emoji = getInsightEmoji(insight.type);
        const progressPercent = maxSavings > 0 ? (savings / maxSavings) * 100 : 0;

        html += `
          <div class="insight-card ${tierClass}" data-insight-id="${insight.id}" data-savings="${savings}">
            <div class="insight-header">
              <div class="insight-title-row">
                <span class="insight-emoji">${emoji}</span>
                <span class="insight-title">${insight.title}</span>
              </div>
            </div>
            <div class="insight-description">${insight.description}</div>
            ${savings > 0 ? `
              <div class="insight-savings-row">
                <span class="insight-savings-amount" data-target="${savings}">+${formatCurrency(savings)}</span>
              </div>
              <div class="insight-savings-bar">
                <div class="insight-savings-fill" style="width: 0%" data-width="${progressPercent}%"></div>
              </div>
            ` : ''}
            ${isApplied ? `
              <div class="insight-applied">
                <span>âœ“</span> Applied
              </div>
            ` : `
              <div class="insight-actions">
                <button class="insight-btn insight-btn-apply" onclick="applyInsight('${insight.id}')">
                  ${tierClass === 'tier-top' ? 'See How â†’' : 'Yes, Add This'}
                </button>
                <button class="insight-btn insight-btn-dismiss" onclick="dismissInsight('${insight.id}')">
                  Not Now
                </button>
              </div>
            `}
          </div>
        `;
      });

      if (container) {
        container.innerHTML = html;

        // Animate progress bars on render
        requestAnimationFrame(() => {
          container.querySelectorAll('.insight-savings-fill').forEach(fill => {
            const width = fill.dataset.width;
            setTimeout(() => {
              fill.style.width = width;
            }, 100);
          });
        });
      }

      // Update discoverability triggers when insights change
      updateDiscoverabilityTriggers();
    }

    // Count-up animation helper
    function animateCountUp(element, targetValue) {
      const duration = 1000;
      const startValue = 0;
      const startTime = performance.now();

      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easeProgress = 1 - Math.pow(1 - progress, 3); // Ease out cubic
        const currentValue = Math.round(startValue + (targetValue - startValue) * easeProgress);
        element.textContent = formatCurrency(currentValue);

        if (progress < 1) {
          requestAnimationFrame(update);
        }
      }

      requestAnimationFrame(update);
    }

    function getInsightEmoji(type) {
      const emojis = {
        'retirement': 'ðŸ’°',
        'filing_status': 'ðŸ ',
        'entity': 'ðŸ¢',
        'deduction': 'ðŸ“',
        'credit': 'ðŸŽ',
        'healthcare': 'ðŸ¥',
      };
      return emojis[type] || 'ðŸ’¡';
    }

    async function applyInsight(insightId) {
      const insight = smartInsightsState.insights.find(i => i.id === insightId);
      if (!insight) return;

      try {
        // First try server-side apply
        const response = await fetch(`/api/smart-insights/${insightId}/apply`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ action_data: insight.action_data }),
        });

        if (response.ok) {
          // Server applied successfully
          smartInsightsState.appliedIds.add(insightId);

          // Refresh the UI
          const activeInsights = smartInsightsState.insights.filter(
            i => !smartInsightsState.dismissedIds.has(i.id)
          );
          renderInsights(activeInsights);

          // Update tax calculations
          updateRefund();
          showToast(`Applied: ${insight.title}`, 'success');
          return;
        }
      } catch (error) {
        console.log('Server apply failed, falling back to local:', error);
      }

      // Fall back to local application
      applyInsightLocally(insight);
    }

    function applyInsightLocally(insight) {
      switch (insight.action_type) {
        case 'apply_deduction':
          if (insight.action_data?.field && insight.action_data?.value !== undefined) {
            state.deductions[insight.action_data.field] = insight.action_data.value;
            // Update the corresponding input if it exists
            const input = document.getElementById(insight.action_data.field);
            if (input) {
              input.value = insight.action_data.value;
            }
          }
          break;

        case 'change_filing_status':
          if (insight.action_data?.status) {
            state.filingStatus = insight.action_data.status;
            updateInfoCard();
          }
          break;

        case 'open_optimizer':
          // Will be implemented when Tax Optimizer is created
          if (insight.action_data?.tab) {
            openTaxOptimizer(insight.action_data.tab);
          }
          break;

        default:
          console.log('Unknown action type:', insight.action_type);
      }

      smartInsightsState.appliedIds.add(insight.id);

      // Refresh the UI
      const activeInsights = smartInsightsState.insights.filter(
        i => !smartInsightsState.dismissedIds.has(i.id)
      );
      renderInsights(activeInsights);

      // Update tax calculations
      updateRefund();
      showToast(`Applied: ${insight.title}`, 'success');
    }

    async function dismissInsight(insightId) {
      smartInsightsState.dismissedIds.add(insightId);

      // Try to dismiss on server
      try {
        await fetch(`/api/smart-insights/${insightId}/dismiss`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        });
      } catch (error) {
        console.log('Server dismiss failed:', error);
      }

      // Update UI
      const activeInsights = smartInsightsState.insights.filter(
        i => !smartInsightsState.dismissedIds.has(i.id)
      );

      if (activeInsights.length === 0) {
        showInsightsEmpty();
      } else {
        renderInsights(activeInsights);
      }
    }

    function showToast(message, type = 'info') {
      // Create toast element if it doesn't exist
      let toast = document.getElementById('smartToast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'smartToast';
        toast.style.cssText = `
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          padding: 12px 24px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          z-index: 9999;
          opacity: 0;
          transition: opacity 0.3s ease;
        `;
        document.body.appendChild(toast);
      }

      toast.textContent = message;
      toast.style.background = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6';
      toast.style.color = 'white';
      toast.style.opacity = '1';

      setTimeout(() => {
        toast.style.opacity = '0';
      }, 3000);
    }

    function initSmartInsights() {
      // Initial fetch with a slight delay to allow page load
      setTimeout(() => {
        fetchSmartInsights();
      }, 1000);

      // Re-fetch when significant data changes
      // This will be called from updateRefund() and other data update functions
    }

    function refreshSmartInsights() {
      // Force a refresh of insights, bypassing cooldown
      smartInsightsState.lastFetchTime = 0;
      fetchSmartInsights();
    }

    // ============ TAX OPTIMIZER ============
    const taxOptimizerState = {
      isOpen: false,
      currentTab: 'scenarios',
      entityData: null,
      retirementLimits: {
        '401k': 23500,
        '401k_catchup': 7500,
        'IRA': 7000,
        'IRA_catchup': 1000,
        'HSA_individual': 4300,
        'HSA_family': 8550,
        'SEP_max': 69000,
      },
    };

    function openTaxOptimizer(tab = 'scenarios', showAdvanced = false) {
      const overlay = document.getElementById('taxOptimizerOverlay');
      if (overlay) {
        overlay.classList.add('active');
        taxOptimizerState.isOpen = true;

        // Pre-populate with user data if available
        populateOptimizerFromState();

        // Check if should show guided flow (first time users)
        if (shouldShowGuidedFlow() && !showAdvanced) {
          showGuidedFlow();
          return;
        }

        if (showAdvanced) {
          // Show advanced tabs view directly
          showAdvancedView();
          switchOptimizerTab(tab);
        } else {
          // Show progressive disclosure recommendation view
          showSimpleView();
          loadRecommendationData();
        }
      }
    }

    function closeTaxOptimizer() {
      const overlay = document.getElementById('taxOptimizerOverlay');
      if (overlay) {
        overlay.classList.remove('active');
        taxOptimizerState.isOpen = false;
      }
    }

    function switchOptimizerTab(tab) {
      taxOptimizerState.currentTab = tab;

      // Update tab buttons
      document.querySelectorAll('.optimizer-tab').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tab) {
          btn.classList.add('active');
        }
      });

      // Update panels
      document.querySelectorAll('.optimizer-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      const panel = document.getElementById(`panel-${tab}`);
      if (panel) {
        panel.classList.add('active');
      }
    }

    function populateOptimizerFromState() {
      // Pre-populate entity comparison with self-employment data if available
      const seIncome = state.taxData?.selfEmploymentIncome || 0;
      if (seIncome > 0) {
        const revenueInput = document.getElementById('entityGrossRevenue');
        if (revenueInput && !revenueInput.value) {
          revenueInput.value = seIncome;
        }
      }

      // Pre-populate filing status
      const entityStatus = document.getElementById('entityFilingStatus');
      if (entityStatus && state.filingStatus) {
        entityStatus.value = state.filingStatus;
      }

      // Pre-populate retirement with existing deductions
      if (state.deductions) {
        const contrib401k = document.getElementById('contrib401k');
        if (contrib401k && state.deductions['401k_amount']) {
          contrib401k.value = state.deductions['401k_amount'];
        }
        const contribIRA = document.getElementById('contribIRA');
        if (contribIRA && state.deductions['ira_amount']) {
          contribIRA.value = state.deductions['ira_amount'];
        }
        const contribHSA = document.getElementById('contribHSA');
        if (contribHSA && state.deductions['hsa_amount']) {
          contribHSA.value = state.deductions['hsa_amount'];
        }
      }

      // Update retirement calculations
      updateRetirementSavings();
    }

    // ===== Progressive Disclosure Functions (Prompt 2) =====
    const recommendationState = {
      topRecommendation: null,
      otherOpportunities: [],
      detailsExpanded: false,
    };

    function showSimpleView() {
      // Show recommendation view, hide advanced tabs
      const recommendationView = document.getElementById('optimizerRecommendationView');
      const tabsView = document.getElementById('optimizerTabs');
      const panelsContainer = document.querySelector('.optimizer-panels');

      if (recommendationView) recommendationView.classList.add('active');
      if (tabsView) tabsView.style.display = 'none';
      if (panelsContainer) panelsContainer.style.display = 'none';

      // Hide detail expansion
      hideRecommendationDetails();
    }

    function showAdvancedView() {
      // Hide recommendation view, show advanced tabs
      const recommendationView = document.getElementById('optimizerRecommendationView');
      const tabsView = document.getElementById('optimizerTabs');
      const panelsContainer = document.querySelector('.optimizer-panels');

      if (recommendationView) recommendationView.classList.remove('active');
      if (tabsView) tabsView.style.display = 'flex';
      if (panelsContainer) panelsContainer.style.display = 'block';
    }

    function showRecommendationDetails() {
      const detailView = document.getElementById('detailExpansionView');
      const recommendationHero = document.querySelector('.recommendation-hero');
      const viewToggle = document.querySelector('.optimizer-recommendation-view .view-toggle');

      if (detailView) {
        detailView.classList.add('active');
        recommendationState.detailsExpanded = true;
      }
      if (recommendationHero) recommendationHero.style.display = 'none';
      if (viewToggle) viewToggle.style.display = 'none';

      // Populate detail view with current recommendation data
      populateDetailView();
    }

    function hideRecommendationDetails() {
      const detailView = document.getElementById('detailExpansionView');
      const recommendationHero = document.querySelector('.recommendation-hero');
      const viewToggle = document.querySelector('.optimizer-recommendation-view .view-toggle');

      if (detailView) {
        detailView.classList.remove('active');
        recommendationState.detailsExpanded = false;
      }
      if (recommendationHero) recommendationHero.style.display = 'block';
      if (viewToggle) viewToggle.style.display = 'block';
    }

    function populateDetailView() {
      const rec = recommendationState.topRecommendation;
      if (!rec) return;

      // Get current tax situation
      const currentWages = state.taxData?.wages || 75000;
      const currentTax = computeTaxForStatus(state.filingStatus || 'single', currentWages);

      // Calculate optimized tax
      let optimizedTax = currentTax.totalTax;
      let savingsAmount = rec.estimated_savings || 0;

      // Update detail comparison cards
      document.getElementById('detailCurrentTax').textContent = formatCurrency(currentTax.totalTax);
      document.getElementById('detailNewTax').textContent = formatCurrency(currentTax.totalTax - savingsAmount);
      document.getElementById('detailSavingsAmount').textContent = formatCurrency(savingsAmount);

      // Breakdown details
      const currentBreakdown = document.getElementById('detailCurrentBreakdown');
      if (currentBreakdown) {
        currentBreakdown.innerHTML = `
          <div>Income: ${formatCurrency(currentWages)}</div>
          <div>Deduction: ${formatCurrency(currentTax.standardDeduction)}</div>
          <div>Taxable: ${formatCurrency(currentTax.taxableIncome)}</div>
        `;
      }

      const newBreakdown = document.getElementById('detailNewBreakdown');
      if (newBreakdown) {
        const additionalDeduction = rec.type === 'retirement' ? (rec.action_data?.value || 0) : 0;
        newBreakdown.innerHTML = `
          <div>Income: ${formatCurrency(currentWages)}</div>
          <div>Deductions: ${formatCurrency(currentTax.standardDeduction + additionalDeduction)}</div>
          <div>Taxable: ${formatCurrency(Math.max(0, currentTax.taxableIncome - additionalDeduction))}</div>
        `;
      }
    }

    async function loadRecommendationData() {
      const intro = document.getElementById('recommendationIntro');
      const card = document.getElementById('recommendationCard');
      const opportunities = document.getElementById('otherOpportunities');

      // Show loading state
      if (intro) intro.textContent = 'Analyzing your tax situation...';
      if (card) card.style.opacity = '0.5';

      try {
        // Get recommendations from insights or compute locally
        const insights = smartInsightsState.insights.filter(
          i => !smartInsightsState.dismissedIds.has(i.id) && !smartInsightsState.appliedIds.has(i.id)
        );

        // Sort by savings amount
        const sortedInsights = [...insights].sort((a, b) =>
          (b.estimated_savings || 0) - (a.estimated_savings || 0)
        );

        if (sortedInsights.length === 0) {
          // Generate local recommendations if none available
          await fetchSmartInsights();
          const newInsights = smartInsightsState.insights.filter(
            i => !smartInsightsState.dismissedIds.has(i.id)
          ).sort((a, b) => (b.estimated_savings || 0) - (a.estimated_savings || 0));

          if (newInsights.length > 0) {
            recommendationState.topRecommendation = newInsights[0];
            recommendationState.otherOpportunities = newInsights.slice(1, 4);
          } else {
            // No insights available - show placeholder
            showNoRecommendationsState();
            return;
          }
        } else {
          recommendationState.topRecommendation = sortedInsights[0];
          recommendationState.otherOpportunities = sortedInsights.slice(1, 4);
        }

        // Update UI
        updateRecommendationCard();
        updateOtherOpportunities();

        // Fade in
        if (card) card.style.opacity = '1';

      } catch (error) {
        console.error('Error loading recommendations:', error);
        showNoRecommendationsState();
      }
    }

    function updateRecommendationCard() {
      const rec = recommendationState.topRecommendation;
      if (!rec) return;

      const intro = document.getElementById('recommendationIntro');
      const title = document.getElementById('recommendationTitle');
      const savings = document.getElementById('recommendationSavings');

      if (intro) {
        intro.textContent = `Based on your ${formatCurrency(state.taxData?.wages || 0)} income, here's your top opportunity:`;
      }

      if (title) {
        title.textContent = rec.title || 'Tax Optimization Strategy';
      }

      if (savings) {
        savings.textContent = formatCurrency(rec.estimated_savings || 0);
      }
    }

    function updateOtherOpportunities() {
      const container = document.getElementById('opportunitiesList');
      if (!container) return;

      const opportunities = recommendationState.otherOpportunities;

      if (opportunities.length === 0) {
        container.innerHTML = '<div class="no-other-opportunities">No other opportunities at this time</div>';
        return;
      }

      container.innerHTML = opportunities.map((opp, index) => `
        <div class="opportunity-item" onclick="selectOpportunity(${index})">
          <span class="opportunity-icon">${getOpportunityIcon(opp.type)}</span>
          <span class="opportunity-name">${opp.title}</span>
          <span class="opportunity-savings">+${formatCurrency(opp.estimated_savings || 0)}</span>
        </div>
      `).join('');
    }

    function getOpportunityIcon(type) {
      const icons = {
        'retirement': 'ðŸ’°',
        'filing_status': 'ðŸ“‹',
        'entity': 'ðŸ¢',
        'credits': 'ðŸ’³',
        'deduction': 'ðŸ“',
      };
      return icons[type] || 'ðŸ’¡';
    }

    function selectOpportunity(index) {
      const opportunities = recommendationState.otherOpportunities;
      if (index >= 0 && index < opportunities.length) {
        // Swap with top recommendation
        const selected = opportunities[index];
        const previous = recommendationState.topRecommendation;

        recommendationState.topRecommendation = selected;
        recommendationState.otherOpportunities[index] = previous;

        // Update UI
        updateRecommendationCard();
        updateOtherOpportunities();
      }
    }

    function showNoRecommendationsState() {
      const intro = document.getElementById('recommendationIntro');
      const card = document.getElementById('recommendationCard');
      const opportunities = document.getElementById('otherOpportunities');

      if (intro) {
        intro.textContent = 'Enter more information to get personalized recommendations';
      }

      if (card) {
        card.innerHTML = `
          <div class="no-recommendations">
            <div class="no-rec-icon">ðŸ“Š</div>
            <div class="no-rec-title">No Recommendations Yet</div>
            <div class="no-rec-subtitle">Complete your tax information to see optimization opportunities</div>
            <button class="recommendation-btn-secondary" onclick="closeTaxOptimizer(); goToStep(2);">
              Add Income Information
            </button>
          </div>
        `;
        card.style.opacity = '1';
      }

      if (opportunities) {
        opportunities.style.display = 'none';
      }
    }

    async function applyRecommendation() {
      const rec = recommendationState.topRecommendation;
      if (!rec) return;

      try {
        // Apply based on action type
        if (rec.action_type === 'apply_deduction' && rec.action_data) {
          const { field, value } = rec.action_data;
          state.deductions[field] = value;

          // Update UI elements
          const input = document.querySelector(`input[data-field="${field}"]`);
          if (input) input.value = value;

          // Mark as applied
          smartInsightsState.appliedIds.add(rec.id);

          showToast(`Applied: ${rec.title}`, 'success');

          // Refresh calculations
          updateRefund();
          refreshSmartInsights();

          // Close and update
          closeTaxOptimizer();
        } else if (rec.action_type === 'change_filing_status' && rec.action_data) {
          // Navigate to filing status selection
          closeTaxOptimizer();
          goToStep(1);
          showToast('Update your filing status to apply this optimization', 'info');
        } else if (rec.action_type === 'open_optimizer' && rec.action_data) {
          // Switch to the relevant tab in advanced view
          showAdvancedView();
          switchOptimizerTab(rec.action_data.tab || 'scenarios');
        } else {
          // Generic application - mark as applied and refresh
          smartInsightsState.appliedIds.add(rec.id);
          showToast(`Strategy noted: ${rec.title}`, 'success');
          closeTaxOptimizer();
        }
      } catch (error) {
        console.error('Error applying recommendation:', error);
        showToast('Unable to apply recommendation', 'error');
      }
    }

    // ===== Goal-Based Guided Flow Functions (Prompt 4) =====
    const guidedFlowState = {
      currentStep: 'goals',
      currentQuestion: 1,
      answers: {
        employmentType: null,
        income: null,
        retirement: null,
      },
      selectedGoal: null,
      calculatedOpportunities: [],
    };

    function shouldShowGuidedFlow() {
      // Check if user has opted out
      const skipGuided = localStorage.getItem('skipGuidedFlow');
      if (skipGuided === 'true') return false;

      // Check if first time opening optimizer
      const hasUsedOptimizer = localStorage.getItem('hasUsedOptimizer');
      if (!hasUsedOptimizer) return true;

      return false;
    }

    function showGuidedFlow() {
      const overlay = document.getElementById('guidedFlowOverlay');
      if (overlay) {
        overlay.classList.add('active');
        goToGuidedStep('goals');
      }
    }

    function closeGuidedFlow() {
      const overlay = document.getElementById('guidedFlowOverlay');
      if (overlay) {
        overlay.classList.remove('active');
      }

      // Remember that user has used optimizer
      localStorage.setItem('hasUsedOptimizer', 'true');

      // Check remember checkbox
      const remember = document.getElementById('guidedFlowRemember');
      if (remember && remember.checked) {
        localStorage.setItem('skipGuidedFlow', 'true');
      }
    }

    function skipGuidedFlow() {
      closeGuidedFlow();
      showSimpleView();
      loadRecommendationData();
    }

    function goToGuidedStep(step) {
      guidedFlowState.currentStep = step;

      // Hide all steps
      document.querySelectorAll('.guided-flow-step').forEach(s => {
        s.classList.remove('active');
      });

      // Show target step
      const stepMap = {
        'goals': 'guidedFlowGoals',
        'questionnaire': 'guidedFlowQuestionnaire',
        'results': 'guidedFlowResults',
      };

      const targetStep = document.getElementById(stepMap[step]);
      if (targetStep) {
        targetStep.classList.add('active');
      }

      // Reset questionnaire if going back to goals
      if (step === 'goals') {
        resetQuestionnaire();
      }
    }

    function selectGoal(goal) {
      guidedFlowState.selectedGoal = goal;

      if (goal === 'save_money') {
        // Show questionnaire
        goToGuidedStep('questionnaire');
        showQuestion(1);
      } else if (goal === 'start_business') {
        // Go directly to entity comparison
        closeGuidedFlow();
        showAdvancedView();
        switchOptimizerTab('entity');
      } else if (goal === 'retirement') {
        // Go directly to retirement tab
        closeGuidedFlow();
        showAdvancedView();
        switchOptimizerTab('retirement');
      } else if (goal === 'compare') {
        // Go directly to what-if scenarios
        closeGuidedFlow();
        showAdvancedView();
        switchOptimizerTab('scenarios');
      }
    }

    function showQuestion(questionNum) {
      guidedFlowState.currentQuestion = questionNum;

      // Hide all questions
      for (let i = 1; i <= 3; i++) {
        const q = document.getElementById(`question${i}`);
        if (q) q.style.display = 'none';
      }

      // Show current question
      const currentQ = document.getElementById(`question${questionNum}`);
      if (currentQ) currentQ.style.display = 'block';

      // Update progress dots
      for (let i = 1; i <= 3; i++) {
        const dot = document.getElementById(`progressDot${i}`);
        if (dot) {
          dot.classList.remove('active', 'completed');
          if (i < questionNum) {
            dot.classList.add('completed');
          } else if (i === questionNum) {
            dot.classList.add('active');
          }
        }
      }

      // Update button text
      const btn = document.getElementById('questionnaireNextBtn');
      if (btn) {
        btn.textContent = questionNum === 3 ? 'Find My Savings â†’' : 'Next â†’';
        btn.disabled = !isQuestionAnswered(questionNum);
      }
    }

    function selectQuestionOption(questionNum, value) {
      // Update state
      if (questionNum === 1) {
        guidedFlowState.answers.employmentType = value;
      } else if (questionNum === 3) {
        guidedFlowState.answers.retirement = value;
      }

      // Update UI
      const question = document.getElementById(`question${questionNum}`);
      if (question) {
        question.querySelectorAll('.question-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
        event.currentTarget.querySelector('input').checked = true;
      }

      // Enable next button
      const btn = document.getElementById('questionnaireNextBtn');
      if (btn) btn.disabled = false;
    }

    function formatIncomeInput(input) {
      // Remove non-numeric characters
      let value = input.value.replace(/[^0-9]/g, '');
      if (value) {
        // Format as currency
        value = '$' + parseInt(value).toLocaleString('en-US');
        input.value = value;
        guidedFlowState.answers.income = parseInt(input.value.replace(/[^0-9]/g, ''));

        // Enable next button if value is reasonable
        const btn = document.getElementById('questionnaireNextBtn');
        if (btn && guidedFlowState.answers.income > 0) {
          btn.disabled = false;
        }
      }
    }

    function isQuestionAnswered(questionNum) {
      if (questionNum === 1) {
        return guidedFlowState.answers.employmentType !== null;
      } else if (questionNum === 2) {
        return guidedFlowState.answers.income > 0;
      } else if (questionNum === 3) {
        return guidedFlowState.answers.retirement !== null;
      }
      return false;
    }

    function nextQuestion() {
      const current = guidedFlowState.currentQuestion;

      if (current < 3) {
        showQuestion(current + 1);
      } else {
        // Calculate results and show
        calculateGuidedResults();
        goToGuidedStep('results');
      }
    }

    function resetQuestionnaire() {
      guidedFlowState.currentQuestion = 1;
      guidedFlowState.answers = {
        employmentType: null,
        income: null,
        retirement: null,
      };

      // Clear selections
      document.querySelectorAll('.question-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      document.querySelectorAll('.questionnaire-question input[type="radio"]').forEach(radio => {
        radio.checked = false;
      });
      const incomeInput = document.getElementById('q2Income');
      if (incomeInput) incomeInput.value = '';

      // Reset button
      const btn = document.getElementById('questionnaireNextBtn');
      if (btn) btn.disabled = true;
    }

    function calculateGuidedResults() {
      const { employmentType, income, retirement } = guidedFlowState.answers;
      const opportunities = [];

      // Use provided income or default
      const annualIncome = income || state.taxData?.wages || 75000;
      const marginalRate = getMarginalRate(annualIncome);

      // S-Corp opportunity for self-employed
      if (employmentType === 'self_employed' || employmentType === 'both') {
        if (annualIncome > 50000) {
          const reasonableSalary = Math.min(annualIncome * 0.6, 150000);
          const savings = Math.round((annualIncome - reasonableSalary) * 0.153 * 0.5);
          opportunities.push({
            id: 'scorp',
            title: 'S-Corp Election',
            savings: savings,
            tab: 'entity',
          });
        }
      }

      // Retirement opportunities
      if (retirement !== 'maxed') {
        // 401k opportunity
        const currentContrib = retirement === 'some' ? 10000 : 0;
        const max401k = employmentType === 'self_employed' ? 69000 : 23500;
        const additional401k = max401k - currentContrib;
        const savings401k = Math.round(additional401k * marginalRate);

        opportunities.push({
          id: '401k',
          title: 'Max 401(k) Contribution',
          savings: savings401k,
          tab: 'retirement',
        });

        // IRA opportunity
        if (retirement === 'none') {
          const iraSavings = Math.round(7000 * marginalRate);
          opportunities.push({
            id: 'ira',
            title: 'IRA Contribution',
            savings: iraSavings,
            tab: 'retirement',
          });
        }

        // HSA opportunity
        const hsaSavings = Math.round(4300 * marginalRate);
        opportunities.push({
          id: 'hsa',
          title: 'HSA Contributions',
          savings: hsaSavings,
          tab: 'retirement',
        });
      }

      // Sort by savings
      opportunities.sort((a, b) => b.savings - a.savings);
      guidedFlowState.calculatedOpportunities = opportunities.slice(0, 3);

      // Update results UI
      const totalSavings = guidedFlowState.calculatedOpportunities.reduce((sum, o) => sum + o.savings, 0);
      const amountEl = document.getElementById('guidedResultsAmount');
      if (amountEl) {
        animateCountUp(amountEl, totalSavings);
      }

      // Render opportunities list
      const listEl = document.getElementById('guidedResultsList');
      if (listEl) {
        listEl.innerHTML = guidedFlowState.calculatedOpportunities.map((opp, index) => `
          <div class="results-opportunity-item">
            <div class="results-opportunity-rank">${index + 1}</div>
            <div class="results-opportunity-name">${opp.title}</div>
            <div class="results-opportunity-savings">${formatCurrency(opp.savings)}</div>
          </div>
        `).join('');
      }

      // Update start button
      const startBtn = document.getElementById('guidedStartBtn');
      if (startBtn && guidedFlowState.calculatedOpportunities.length > 0) {
        const topOpp = guidedFlowState.calculatedOpportunities[0];
        startBtn.textContent = `Start with #1: ${topOpp.title} â†’`;
      }
    }

    function getMarginalRate(income) {
      // Simplified marginal rate lookup
      if (income <= 11925) return 0.10;
      if (income <= 48475) return 0.12;
      if (income <= 103350) return 0.22;
      if (income <= 197300) return 0.24;
      if (income <= 250525) return 0.32;
      if (income <= 626350) return 0.35;
      return 0.37;
    }

    function startTopOpportunity() {
      if (guidedFlowState.calculatedOpportunities.length === 0) return;

      const topOpp = guidedFlowState.calculatedOpportunities[0];
      closeGuidedFlow();
      showAdvancedView();
      switchOptimizerTab(topOpp.tab || 'scenarios');
    }

    // ===== Contextual Discoverability Triggers (Prompt 5) =====
    const triggerState = {
      inlineAlertDismissed: false,
      floatingNudgeShownFor: new Set(),
      optimizerClicked: false,
      reviewBannerDismissed: false,
      calculatedPotentialSavings: 0,
    };

    function calculatePotentialSavings() {
      // Calculate based on current insights
      const savings = smartInsightsState.insights
        .filter(i => !smartInsightsState.dismissedIds.has(i.id) && !smartInsightsState.appliedIds.has(i.id))
        .reduce((sum, i) => sum + (i.estimated_savings || 0), 0);

      triggerState.calculatedPotentialSavings = savings;
      return savings;
    }

    function showInlineSavingsAlert(savings, topInsight) {
      if (triggerState.inlineAlertDismissed || savings < 500) return;

      const alert = document.getElementById('inlineSavingsAlert');
      if (!alert) return;

      const titleEl = alert.querySelector('.inline-savings-alert-title');
      const subtitleEl = alert.querySelector('.inline-savings-alert-subtitle');

      if (titleEl) {
        titleEl.textContent = `You could reduce this by ${formatCurrency(savings)}`;
      }
      if (subtitleEl && topInsight) {
        subtitleEl.textContent = `See how with ${topInsight.title}`;
      }

      alert.classList.add('visible');
    }

    function dismissInlineSavingsAlert() {
      triggerState.inlineAlertDismissed = true;
      const alert = document.getElementById('inlineSavingsAlert');
      if (alert) alert.classList.remove('visible');
    }

    function showFloatingNudge(fieldId, income) {
      if (triggerState.floatingNudgeShownFor.has(fieldId)) return;
      if (income < 50000) return;

      const field = document.getElementById(fieldId);
      if (!field) return;

      // Create nudge if it doesn't exist
      let nudge = field.parentElement.querySelector('.floating-nudge');
      if (!nudge) {
        nudge = document.createElement('div');
        nudge.className = 'floating-nudge';

        // Calculate potential savings
        const savings = Math.round(income * 0.153 * 0.4 * 0.5); // Approximate S-Corp savings

        nudge.innerHTML = `
          <div class="floating-nudge-icon">ðŸ’¡</div>
          <div class="floating-nudge-text">
            With ${formatCurrency(income)} self-employment income,
            an S-Corp could save you <span class="floating-nudge-savings">${formatCurrency(savings)}/year</span>
          </div>
          <div class="floating-nudge-actions">
            <button class="floating-nudge-btn floating-nudge-btn-primary" onclick="openTaxOptimizer('entity', true); hideFloatingNudge('${fieldId}')">
              Calculate â†’
            </button>
            <button class="floating-nudge-btn floating-nudge-btn-secondary" onclick="hideFloatingNudge('${fieldId}')">
              Maybe Later
            </button>
          </div>
        `;

        field.parentElement.style.position = 'relative';
        field.parentElement.appendChild(nudge);
      }

      // Show with delay
      setTimeout(() => {
        nudge.classList.add('visible');
        triggerState.floatingNudgeShownFor.add(fieldId);
      }, 2000);
    }

    function hideFloatingNudge(fieldId) {
      const field = document.getElementById(fieldId);
      if (!field) return;

      const nudge = field.parentElement.querySelector('.floating-nudge');
      if (nudge) nudge.classList.remove('visible');
    }

    function updateOptimizerButton(savings) {
      const btn = document.getElementById('openOptimizerBtn');
      if (!btn) return;

      if (savings > 100 && !triggerState.optimizerClicked) {
        btn.classList.add('optimizer-btn-pulsing');

        // Add or update savings badge
        let badge = btn.querySelector('.optimizer-savings-badge');
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'optimizer-savings-badge';
          btn.style.position = 'relative';
          btn.appendChild(badge);
        }
        badge.textContent = formatCurrency(savings);
      } else {
        btn.classList.remove('optimizer-btn-pulsing');
        const badge = btn.querySelector('.optimizer-savings-badge');
        if (badge) badge.remove();
      }
    }

    function markOptimizerClicked() {
      triggerState.optimizerClicked = true;
      const btn = document.getElementById('openOptimizerBtn');
      if (btn) {
        btn.classList.remove('optimizer-btn-pulsing');
        const badge = btn.querySelector('.optimizer-savings-badge');
        if (badge) badge.remove();
      }
    }

    function showReviewSavingsBanner(savings) {
      if (triggerState.reviewBannerDismissed || savings < 500) return;

      const banner = document.getElementById('reviewSavingsBanner');
      if (!banner) return;

      const titleEl = banner.querySelector('.review-savings-banner-title');
      if (titleEl) {
        titleEl.textContent = `BEFORE YOU FILE: We found ${formatCurrency(savings)} in potential savings`;
      }

      banner.classList.add('visible');
    }

    function dismissReviewBanner() {
      triggerState.reviewBannerDismissed = true;
      const banner = document.getElementById('reviewSavingsBanner');
      if (banner) banner.classList.remove('visible');
    }

    function updateDiscoverabilityTriggers() {
      const savings = calculatePotentialSavings();

      // Get top insight for context
      const topInsight = smartInsightsState.insights
        .filter(i => !smartInsightsState.dismissedIds.has(i.id))
        .sort((a, b) => (b.estimated_savings || 0) - (a.estimated_savings || 0))[0];

      // Update inline alert
      showInlineSavingsAlert(savings, topInsight);

      // Update optimizer button
      updateOptimizerButton(savings);

      // Update savings meter
      updateSavingsMeter();

      // Check if on review step
      if (state.currentStep === 6) {
        showReviewSavingsBanner(savings);
      }
    }

    // ===== Before/After Feedback (Prompt 6) =====
    const feedbackState = {
      lastChange: null,
      beforeTax: 0,
      afterTax: 0,
      totalSavedThisSession: 0,
    };

    function showFeedbackToast(title, beforeTax, afterTax) {
      const toast = document.getElementById('feedbackToast');
      if (!toast) return;

      const savings = beforeTax - afterTax;
      if (savings <= 0) return;

      // Store for undo
      feedbackState.lastChange = { title, beforeTax, afterTax };
      feedbackState.totalSavedThisSession += savings;

      // Update toast content
      document.getElementById('feedbackToastTitle').textContent = title;
      document.getElementById('feedbackBefore').textContent = formatCurrency(beforeTax);
      document.getElementById('feedbackAfter').textContent = formatCurrency(afterTax);
      document.getElementById('feedbackSavings').textContent = formatCurrency(savings);

      // Show toast
      toast.classList.add('visible');

      // Check for milestone celebration
      if (feedbackState.totalSavedThisSession >= 5000) {
        setTimeout(() => showCelebration(), 500);
      }

      // Auto-hide after 8 seconds
      setTimeout(() => {
        closeFeedbackToast();
      }, 8000);
    }

    function closeFeedbackToast() {
      const toast = document.getElementById('feedbackToast');
      if (toast) toast.classList.remove('visible');
      feedbackState.lastChange = null;
    }

    function undoLastChange() {
      if (!feedbackState.lastChange) return;

      // Implementation would revert the last change
      showToast('Change reverted', 'info');
      feedbackState.totalSavedThisSession -= (feedbackState.lastChange.beforeTax - feedbackState.lastChange.afterTax);
      closeFeedbackToast();
      refreshSmartInsights();
    }

    // ===== Celebration Confetti (Prompt 8 milestone) =====
    function showCelebration() {
      const overlay = document.createElement('div');
      overlay.className = 'celebration-overlay';
      document.body.appendChild(overlay);

      const colors = ['#f59e0b', '#22c55e', '#6366f1', '#ec4899', '#3b82f6'];

      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 2 + 's';
        confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
        overlay.appendChild(confetti);
      }

      // Show milestone toast
      setTimeout(() => {
        showToast(`ðŸŽ‰ You've saved ${formatCurrency(feedbackState.totalSavedThisSession)} so far!`, 'success', 5000);
      }, 500);

      // Remove overlay after animation
      setTimeout(() => {
        overlay.remove();
      }, 5000);
    }

    // ===== Savings Meter Update (Prompt 8) =====
    function updateSavingsMeter() {
      const meter = document.getElementById('savingsMeter');
      if (!meter) return;

      const captured = feedbackState.totalSavedThisSession;
      const potential = triggerState.calculatedPotentialSavings + captured;
      const percentage = potential > 0 ? (captured / potential) * 100 : 0;

      // Show meter if there's any captured or potential savings
      if (captured > 0 || potential > 0) {
        meter.style.display = 'block';
      } else {
        meter.style.display = 'none';
        return;
      }

      const fill = meter.querySelector('.savings-meter-fill');
      const value = meter.querySelector('.savings-meter-value');

      if (fill) {
        // Animate the fill
        requestAnimationFrame(() => {
          fill.style.width = percentage + '%';
        });
      }
      if (value) value.textContent = `${formatCurrency(captured)} / ${formatCurrency(potential)}`;
    }

    // ===== Chart Rendering Utilities (Prompt 9) =====
    function renderHorizontalBarChart(containerId, data) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const maxValue = Math.max(...data.map(d => d.value));
      const bestIdx = data.findIndex(d => d.best);

      container.innerHTML = `
        <div class="h-bar-chart">
          ${data.map((item, idx) => `
            <div class="h-bar-item">
              <span class="h-bar-label">${item.label}</span>
              <div class="h-bar-track">
                <div class="h-bar-fill ${item.best ? 'best' : ''}"
                     style="width: ${(item.value / maxValue) * 100}%">
                  <span class="h-bar-value">${formatCurrency(item.value)}</span>
                </div>
              </div>
              ${item.savings ? `<span class="h-bar-savings">-${formatCurrency(item.savings)}</span>` : ''}
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderDonutChart(containerId, data, total) {
      const container = document.getElementById(containerId);
      if (!container) return;

      // Calculate conic gradient
      let cumulativePercent = 0;
      const gradientStops = data.map(item => {
        const start = cumulativePercent;
        cumulativePercent += (item.value / total) * 100;
        return `${item.color} ${start}% ${cumulativePercent}%`;
      }).join(', ');

      container.innerHTML = `
        <div class="donut-chart">
          <div class="donut-ring" style="background: conic-gradient(${gradientStops})">
            <div class="donut-center">
              <div class="donut-total">${formatCurrency(total)}</div>
              <div class="donut-label">Total</div>
            </div>
          </div>
          <div class="donut-legend">
            ${data.map(item => `
              <div class="donut-legend-item">
                <div class="donut-legend-color" style="background: ${item.color}"></div>
                <span>${item.label}: ${formatCurrency(item.value)}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // ===== What-If Scenarios Functions =====
    function updateScenarioInputs() {
      const scenarioType = document.getElementById('scenarioType')?.value;

      // Hide all input groups
      document.getElementById('filingStatusInputs').style.display = 'none';
      document.getElementById('incomeInputs').style.display = 'none';
      document.getElementById('deductionInputs').style.display = 'none';

      // Show relevant inputs
      switch (scenarioType) {
        case 'filing_status':
          document.getElementById('filingStatusInputs').style.display = 'block';
          break;
        case 'income':
          document.getElementById('incomeInputs').style.display = 'block';
          // Pre-populate with current income
          const incomeInput = document.getElementById('newIncomeAmount');
          if (incomeInput && !incomeInput.value) {
            incomeInput.value = state.taxData?.wages || 0;
          }
          break;
        case 'deduction':
          document.getElementById('deductionInputs').style.display = 'block';
          break;
        case 'retirement':
          // No additional inputs, will compare current vs max
          break;
      }
    }

    async function runScenarioComparison() {
      const scenarioType = document.getElementById('scenarioType')?.value;
      const resultsContainer = document.getElementById('scenarioResults');

      // Show loading
      resultsContainer.innerHTML = `
        <div class="insights-loading">
          <div class="spinner"></div>
          <div>Calculating scenarios...</div>
        </div>
      `;

      try {
        let results = [];
        const currentWages = state.taxData?.wages || 75000;

        switch (scenarioType) {
          case 'filing_status':
            results = await compareFilingStatuses(currentWages);
            break;
          case 'income':
            const newIncome = parseFloat(document.getElementById('newIncomeAmount')?.value) || currentWages;
            results = await compareIncomeScenarios(currentWages, newIncome);
            break;
          case 'deduction':
            const dedType = document.getElementById('deductionType')?.value;
            const dedAmount = parseFloat(document.getElementById('deductionAmount')?.value) || 0;
            results = await compareDeductionScenarios(dedType, dedAmount);
            break;
          case 'retirement':
            results = await compareRetirementScenarios();
            break;
        }

        renderScenarioResults(results);
      } catch (error) {
        console.error('Scenario comparison error:', error);
        resultsContainer.innerHTML = `
          <div class="insights-empty">
            <div class="insights-empty-icon">âŒ</div>
            <div>Error running comparison. Please try again.</div>
          </div>
        `;
      }
    }

    async function compareFilingStatuses(income) {
      const statuses = [];
      if (document.getElementById('compare_single')?.checked) statuses.push({ key: 'single', name: 'Single' });
      if (document.getElementById('compare_mfj')?.checked) statuses.push({ key: 'married_joint', name: 'Married Filing Jointly' });
      if (document.getElementById('compare_mfs')?.checked) statuses.push({ key: 'married_separate', name: 'Married Filing Separately' });
      if (document.getElementById('compare_hoh')?.checked) statuses.push({ key: 'head_of_household', name: 'Head of Household' });

      const results = statuses.map(status => {
        const tax = computeTaxForStatus(status.key, income);
        return {
          name: status.name,
          total_tax: tax.totalTax,
          effective_rate: tax.effectiveRate,
          taxable_income: tax.taxableIncome,
          standard_deduction: tax.standardDeduction,
        };
      });

      // Sort by total tax (lowest first)
      results.sort((a, b) => a.total_tax - b.total_tax);

      // Mark winner
      if (results.length > 0) {
        results[0].is_winner = true;
        const baseTax = results[results.length - 1].total_tax;
        results.forEach(r => {
          r.savings = baseTax - r.total_tax;
        });
      }

      return results;
    }

    function computeTaxForStatus(filingStatus, income) {
      // 2025 standard deductions
      const stdDeductions = {
        'single': 15000,
        'married_joint': 30000,
        'married_separate': 15000,
        'head_of_household': 22500,
      };

      // 2025 tax brackets (simplified)
      const brackets = {
        'single': [
          { min: 0, max: 11925, rate: 0.10 },
          { min: 11925, max: 48475, rate: 0.12 },
          { min: 48475, max: 103350, rate: 0.22 },
          { min: 103350, max: 197300, rate: 0.24 },
          { min: 197300, max: 250525, rate: 0.32 },
          { min: 250525, max: 626350, rate: 0.35 },
          { min: 626350, max: Infinity, rate: 0.37 },
        ],
        'married_joint': [
          { min: 0, max: 23850, rate: 0.10 },
          { min: 23850, max: 96950, rate: 0.12 },
          { min: 96950, max: 206700, rate: 0.22 },
          { min: 206700, max: 394600, rate: 0.24 },
          { min: 394600, max: 501050, rate: 0.32 },
          { min: 501050, max: 751600, rate: 0.35 },
          { min: 751600, max: Infinity, rate: 0.37 },
        ],
        'married_separate': [
          { min: 0, max: 11925, rate: 0.10 },
          { min: 11925, max: 48475, rate: 0.12 },
          { min: 48475, max: 103350, rate: 0.22 },
          { min: 103350, max: 197300, rate: 0.24 },
          { min: 197300, max: 250525, rate: 0.32 },
          { min: 250525, max: 375800, rate: 0.35 },
          { min: 375800, max: Infinity, rate: 0.37 },
        ],
        'head_of_household': [
          { min: 0, max: 17000, rate: 0.10 },
          { min: 17000, max: 64850, rate: 0.12 },
          { min: 64850, max: 103350, rate: 0.22 },
          { min: 103350, max: 197300, rate: 0.24 },
          { min: 197300, max: 250500, rate: 0.32 },
          { min: 250500, max: 626350, rate: 0.35 },
          { min: 626350, max: Infinity, rate: 0.37 },
        ],
      };

      const standardDeduction = stdDeductions[filingStatus] || 15000;
      const taxableIncome = Math.max(0, income - standardDeduction);
      const bracketList = brackets[filingStatus] || brackets['single'];

      let tax = 0;
      let remaining = taxableIncome;

      for (const bracket of bracketList) {
        if (remaining <= 0) break;
        const bracketWidth = bracket.max - bracket.min;
        const taxableInBracket = Math.min(remaining, bracketWidth);
        tax += taxableInBracket * bracket.rate;
        remaining -= taxableInBracket;
      }

      const effectiveRate = income > 0 ? (tax / income) * 100 : 0;

      return {
        totalTax: Math.round(tax),
        effectiveRate: effectiveRate.toFixed(1),
        taxableIncome: Math.round(taxableIncome),
        standardDeduction,
      };
    }

    async function compareIncomeScenarios(currentIncome, newIncome) {
      const currentStatus = state.filingStatus || 'single';
      const currentTax = computeTaxForStatus(currentStatus, currentIncome);
      const newTax = computeTaxForStatus(currentStatus, newIncome);

      const results = [
        {
          name: `Current Income: ${formatCurrency(currentIncome)}`,
          total_tax: currentTax.totalTax,
          effective_rate: currentTax.effectiveRate,
          taxable_income: currentTax.taxableIncome,
        },
        {
          name: `New Income: ${formatCurrency(newIncome)}`,
          total_tax: newTax.totalTax,
          effective_rate: newTax.effectiveRate,
          taxable_income: newTax.taxableIncome,
        },
      ];

      // Mark winner (lower tax)
      results.sort((a, b) => a.total_tax - b.total_tax);
      results[0].is_winner = true;

      const taxDiff = newTax.totalTax - currentTax.totalTax;
      results[1].tax_change = taxDiff;

      return results;
    }

    async function compareDeductionScenarios(deductionType, amount) {
      const currentStatus = state.filingStatus || 'single';
      const income = state.taxData?.wages || 75000;

      const currentTax = computeTaxForStatus(currentStatus, income);

      // Simulate adding deduction (would reduce taxable income if itemizing)
      const deductionNames = {
        'charitable': 'Charitable Donation',
        'mortgage_interest': 'Mortgage Interest',
        'state_taxes': 'State/Local Taxes',
        'medical': 'Medical Expenses',
      };

      // For simplicity, estimate tax savings based on marginal rate
      const marginalRate = getMarginalRate(currentStatus, income);
      const potentialSavings = Math.round(amount * marginalRate);

      const results = [
        {
          name: 'Current (Standard Deduction)',
          total_tax: currentTax.totalTax,
          effective_rate: currentTax.effectiveRate,
          taxable_income: currentTax.taxableIncome,
        },
        {
          name: `With ${formatCurrency(amount)} ${deductionNames[deductionType]}`,
          total_tax: currentTax.totalTax - potentialSavings,
          effective_rate: ((currentTax.totalTax - potentialSavings) / income * 100).toFixed(1),
          taxable_income: currentTax.taxableIncome - amount,
          savings: potentialSavings,
          is_winner: potentialSavings > 0,
        },
      ];

      return results;
    }

    async function compareRetirementScenarios() {
      const currentStatus = state.filingStatus || 'single';
      const income = state.taxData?.wages || 75000;
      const currentTax = computeTaxForStatus(currentStatus, income);

      const max401k = taxOptimizerState.retirementLimits['401k'];
      const maxIRA = taxOptimizerState.retirementLimits['IRA'];
      const totalMaxContrib = max401k + maxIRA;

      const marginalRate = getMarginalRate(currentStatus, income);
      const maxSavings = Math.round(totalMaxContrib * marginalRate);

      const results = [
        {
          name: 'Current (No Additional Retirement)',
          total_tax: currentTax.totalTax,
          effective_rate: currentTax.effectiveRate,
          taxable_income: currentTax.taxableIncome,
        },
        {
          name: `Max 401(k): ${formatCurrency(max401k)}`,
          total_tax: currentTax.totalTax - Math.round(max401k * marginalRate),
          effective_rate: (((currentTax.totalTax - Math.round(max401k * marginalRate)) / income) * 100).toFixed(1),
          taxable_income: currentTax.taxableIncome - max401k,
          savings: Math.round(max401k * marginalRate),
        },
        {
          name: `Max All: ${formatCurrency(totalMaxContrib)}`,
          total_tax: currentTax.totalTax - maxSavings,
          effective_rate: (((currentTax.totalTax - maxSavings) / income) * 100).toFixed(1),
          taxable_income: currentTax.taxableIncome - totalMaxContrib,
          savings: maxSavings,
          is_winner: true,
        },
      ];

      return results;
    }

    function getMarginalRate(filingStatus, income) {
      // Simplified marginal rate lookup
      const brackets = {
        'single': [[11925, 0.10], [48475, 0.12], [103350, 0.22], [197300, 0.24], [250525, 0.32], [626350, 0.35], [Infinity, 0.37]],
        'married_joint': [[23850, 0.10], [96950, 0.12], [206700, 0.22], [394600, 0.24], [501050, 0.32], [751600, 0.35], [Infinity, 0.37]],
      };

      const bracketList = brackets[filingStatus] || brackets['single'];
      for (const [threshold, rate] of bracketList) {
        if (income <= threshold) return rate;
      }
      return 0.37;
    }

    function renderScenarioResults(results) {
      const container = document.getElementById('scenarioResults');
      if (!results || results.length === 0) {
        container.innerHTML = `
          <div class="insights-empty">
            <div class="insights-empty-icon">ðŸ“Š</div>
            <div>No results to display</div>
          </div>
        `;
        return;
      }

      let html = '';
      results.forEach(result => {
        const winnerClass = result.is_winner ? 'winner' : '';
        html += `
          <div class="scenario-result-card ${winnerClass}" style="position: relative;">
            ${result.is_winner ? '<span style="position: absolute; top: -8px; right: 16px; background: var(--success); color: white; font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 4px;">BEST</span>' : ''}
            <div class="scenario-result-header">
              <div class="scenario-result-name">${result.name}</div>
              <div>
                <div class="scenario-result-tax">${formatCurrency(result.total_tax)}</div>
                ${result.savings > 0 ? `<div class="scenario-result-savings">Save ${formatCurrency(result.savings)}</div>` : ''}
              </div>
            </div>
            <div class="scenario-result-details">
              <div class="scenario-detail-item">
                <div class="scenario-detail-label">Effective Rate</div>
                <div class="scenario-detail-value">${result.effective_rate}%</div>
              </div>
              <div class="scenario-detail-item">
                <div class="scenario-detail-label">Taxable Income</div>
                <div class="scenario-detail-value">${formatCurrency(result.taxable_income)}</div>
              </div>
              <div class="scenario-detail-item">
                <div class="scenario-detail-label">Tax Owed</div>
                <div class="scenario-detail-value">${formatCurrency(result.total_tax)}</div>
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // ===== Entity Comparison Functions =====
    async function compareEntities() {
      const grossRevenue = parseFloat(document.getElementById('entityGrossRevenue')?.value) || 0;
      const expenses = parseFloat(document.getElementById('entityExpenses')?.value) || 0;
      const otherIncome = parseFloat(document.getElementById('entityOtherIncome')?.value) || 0;
      const filingStatus = document.getElementById('entityFilingStatus')?.value || 'single';

      if (grossRevenue <= 0) {
        showToast('Please enter your gross business revenue', 'error');
        return;
      }

      const resultsContainer = document.getElementById('entityResults');
      resultsContainer.innerHTML = `
        <div class="insights-loading">
          <div class="spinner"></div>
          <div>Analyzing entity structures...</div>
        </div>
      `;

      try {
        // Try API first
        const response = await fetch('/api/entity-comparison', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            gross_revenue: grossRevenue,
            business_expenses: expenses,
            other_income: otherIncome,
            filing_status: filingStatus,
          }),
        });

        if (response.ok) {
          const data = await response.json();
          taxOptimizerState.entityData = data;
          renderEntityResults(data);

          // Show salary slider
          const slider = document.getElementById('salarySliderContainer');
          if (slider) {
            slider.style.display = 'block';
            const netIncome = grossRevenue - expenses;
            document.getElementById('salarySlider').max = netIncome;
            document.getElementById('salarySliderMax').textContent = formatCurrency(netIncome).replace('$', '');

            // Set initial value to reasonable salary (60% of net or suggested)
            const reasonableSalary = data.s_corp?.reasonable_salary || Math.round(netIncome * 0.6);
            document.getElementById('salarySlider').value = reasonableSalary;
            document.getElementById('salarySliderValue').textContent = formatCurrency(reasonableSalary);
          }
          return;
        }
      } catch (error) {
        console.log('API call failed, using local calculation:', error);
      }

      // Fall back to local calculation
      const localResults = calculateEntityComparisonLocally(grossRevenue, expenses, otherIncome, filingStatus);
      taxOptimizerState.entityData = localResults;
      renderEntityResults(localResults);
    }

    function calculateEntityComparisonLocally(grossRevenue, expenses, otherIncome, filingStatus) {
      const netIncome = grossRevenue - expenses;
      const seTaxRate = 0.153; // 15.3% self-employment tax
      const seTaxableBase = netIncome * 0.9235; // 92.35% of net SE income

      // Sole Proprietorship
      const solePropSETax = Math.round(seTaxableBase * seTaxRate);
      const solePropDeduction = Math.round(solePropSETax / 2);
      const solePropAGI = netIncome + otherIncome - solePropDeduction;
      const solePropIncomeTax = computeTaxForStatus(filingStatus, solePropAGI).totalTax;
      const solePropTotal = solePropSETax + solePropIncomeTax;

      // S-Corp (using 60% as reasonable salary)
      const reasonableSalary = Math.round(netIncome * 0.6);
      const distribution = netIncome - reasonableSalary;
      const sCorpPayrollTax = Math.round(reasonableSalary * seTaxRate);
      const sCorpAGI = reasonableSalary + distribution + otherIncome;
      const sCorpIncomeTax = computeTaxForStatus(filingStatus, sCorpAGI).totalTax;
      const sCorpTotal = sCorpPayrollTax + sCorpIncomeTax;

      // LLC (same as sole prop for single-member)
      const llcTotal = solePropTotal;

      const savings = solePropTotal - sCorpTotal;

      return {
        sole_proprietorship: {
          entity_type: 'Sole Proprietorship',
          self_employment_tax: solePropSETax,
          income_tax: solePropIncomeTax,
          total_tax: solePropTotal,
        },
        s_corp: {
          entity_type: 'S-Corporation',
          reasonable_salary: reasonableSalary,
          distribution: distribution,
          payroll_tax: sCorpPayrollTax,
          income_tax: sCorpIncomeTax,
          total_tax: sCorpTotal,
        },
        llc: {
          entity_type: 'LLC (Single-Member)',
          self_employment_tax: solePropSETax,
          income_tax: solePropIncomeTax,
          total_tax: llcTotal,
        },
        recommendation: savings > 3000 ? 's_corp' : 'sole_proprietorship',
        max_savings: Math.max(0, savings),
      };
    }

    function renderEntityResults(data) {
      const container = document.getElementById('entityResults');
      const recommended = data.recommendation || 's_corp';

      const entities = [
        { key: 'sole_proprietorship', icon: 'ðŸ“‹', iconClass: 'sole-prop' },
        { key: 's_corp', icon: 'ðŸ¢', iconClass: 's-corp' },
        { key: 'llc', icon: 'ðŸ“„', iconClass: 'llc' },
      ];

      let html = '';
      entities.forEach(entity => {
        const info = data[entity.key];
        if (!info) return;

        const isRecommended = entity.key === recommended;
        const savingsVsSoleProp = data.sole_proprietorship.total_tax - info.total_tax;

        html += `
          <div class="entity-card ${isRecommended ? 'recommended' : ''}">
            <div class="entity-header">
              <div class="entity-icon ${entity.iconClass}">${entity.icon}</div>
              <div class="entity-name">${info.entity_type}</div>
            </div>

            ${entity.key === 's_corp' ? `
              <div class="entity-tax-row">
                <span class="entity-tax-label">Reasonable Salary</span>
                <span class="entity-tax-value">${formatCurrency(info.reasonable_salary || 0)}</span>
              </div>
              <div class="entity-tax-row">
                <span class="entity-tax-label">Distribution</span>
                <span class="entity-tax-value">${formatCurrency(info.distribution || 0)}</span>
              </div>
              <div class="entity-tax-row">
                <span class="entity-tax-label">Payroll Tax</span>
                <span class="entity-tax-value">${formatCurrency(info.payroll_tax || 0)}</span>
              </div>
            ` : `
              <div class="entity-tax-row">
                <span class="entity-tax-label">Self-Employment Tax</span>
                <span class="entity-tax-value">${formatCurrency(info.self_employment_tax || 0)}</span>
              </div>
            `}

            <div class="entity-tax-row">
              <span class="entity-tax-label">Income Tax</span>
              <span class="entity-tax-value">${formatCurrency(info.income_tax || 0)}</span>
            </div>

            <div class="entity-total">
              <span class="entity-total-label">Total Tax</span>
              <span class="entity-total-value">
                ${formatCurrency(info.total_tax)}
                ${savingsVsSoleProp > 0 ? `<span class="entity-savings-badge">Save ${formatCurrency(savingsVsSoleProp)}</span>` : ''}
              </span>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    async function updateSalarySlider() {
      const slider = document.getElementById('salarySlider');
      const valueDisplay = document.getElementById('salarySliderValue');
      const salary = parseInt(slider.value);

      valueDisplay.textContent = formatCurrency(salary);

      // Recalculate with new salary
      const grossRevenue = parseFloat(document.getElementById('entityGrossRevenue')?.value) || 0;
      const expenses = parseFloat(document.getElementById('entityExpenses')?.value) || 0;
      const otherIncome = parseFloat(document.getElementById('entityOtherIncome')?.value) || 0;
      const filingStatus = document.getElementById('entityFilingStatus')?.value || 'single';

      try {
        const response = await fetch('/api/entity-comparison/adjust-salary', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            gross_revenue: grossRevenue,
            business_expenses: expenses,
            owner_salary: salary,
            filing_status: filingStatus,
            other_income: otherIncome,
          }),
        });

        if (response.ok) {
          const data = await response.json();
          // Update just the S-Corp card
          updateSCorpCard(data);
        }
      } catch (error) {
        console.log('Salary adjustment API failed:', error);
      }
    }

    function updateSCorpCard(data) {
      // Find and update the S-Corp card with new values
      const sCorpInfo = data.s_corp;
      if (!sCorpInfo) return;

      // This is a simplified update - in production you'd update specific elements
      const cards = document.querySelectorAll('.entity-card');
      cards.forEach(card => {
        if (card.querySelector('.entity-name')?.textContent === 'S-Corporation') {
          const taxRows = card.querySelectorAll('.entity-tax-value');
          if (taxRows.length >= 4) {
            taxRows[0].textContent = formatCurrency(sCorpInfo.reasonable_salary || 0);
            taxRows[1].textContent = formatCurrency(sCorpInfo.distribution || 0);
            taxRows[2].textContent = formatCurrency(sCorpInfo.payroll_tax || 0);
            taxRows[3].textContent = formatCurrency(sCorpInfo.income_tax || 0);
          }
          const totalValue = card.querySelector('.entity-total-value');
          if (totalValue) {
            const savingsVsSoleProp = taxOptimizerState.entityData?.sole_proprietorship?.total_tax - sCorpInfo.total_tax;
            totalValue.innerHTML = `
              ${formatCurrency(sCorpInfo.total_tax)}
              ${savingsVsSoleProp > 0 ? `<span class="entity-savings-badge">Save ${formatCurrency(savingsVsSoleProp)}</span>` : ''}
            `;
          }
        }
      });
    }

    // ===== Retirement Planning Functions =====
    function maxContribution(accountType) {
      const limits = taxOptimizerState.retirementLimits;
      let maxAmount = 0;

      switch (accountType) {
        case '401k':
          maxAmount = limits['401k'];
          document.getElementById('contrib401k').value = maxAmount;
          break;
        case 'IRA':
          maxAmount = limits['IRA'];
          document.getElementById('contribIRA').value = maxAmount;
          break;
        case 'HSA':
          maxAmount = state.filingStatus === 'married_joint' ? limits['HSA_family'] : limits['HSA_individual'];
          document.getElementById('contribHSA').value = maxAmount;
          break;
        case 'SEP':
          const seIncome = state.taxData?.selfEmploymentIncome || 0;
          maxAmount = Math.min(limits['SEP_max'], seIncome * 0.25);
          document.getElementById('contribSEP').value = Math.round(maxAmount);
          break;
      }

      updateRetirementSavings();
    }

    function updateRetirementSavings() {
      const limits = taxOptimizerState.retirementLimits;
      const marginalRate = getMarginalRate(state.filingStatus || 'single', state.taxData?.wages || 75000);

      // 401k
      const contrib401k = parseFloat(document.getElementById('contrib401k')?.value) || 0;
      const limit401k = limits['401k'];
      const pct401k = Math.min(100, (contrib401k / limit401k) * 100);
      document.getElementById('progress401k').style.width = `${pct401k}%`;
      document.getElementById('contrib401kPct').textContent = `${Math.round(pct401k)}%`;
      const savings401k = Math.round(contrib401k * marginalRate);
      document.getElementById('savings401k').textContent = formatCurrency(savings401k);
      document.getElementById('retirement401k').classList.toggle('has-contribution', contrib401k > 0);

      // IRA
      const contribIRA = parseFloat(document.getElementById('contribIRA')?.value) || 0;
      const limitIRA = limits['IRA'];
      const pctIRA = Math.min(100, (contribIRA / limitIRA) * 100);
      document.getElementById('progressIRA').style.width = `${pctIRA}%`;
      document.getElementById('contribIRAPct').textContent = `${Math.round(pctIRA)}%`;
      const savingsIRA = Math.round(contribIRA * marginalRate);
      document.getElementById('savingsIRA').textContent = formatCurrency(savingsIRA);
      document.getElementById('retirementIRA').classList.toggle('has-contribution', contribIRA > 0);

      // HSA
      const contribHSA = parseFloat(document.getElementById('contribHSA')?.value) || 0;
      const limitHSA = state.filingStatus === 'married_joint' ? limits['HSA_family'] : limits['HSA_individual'];
      document.getElementById('hsaLimitDisplay').textContent = formatCurrency(limitHSA).replace('$', '');
      const pctHSA = Math.min(100, (contribHSA / limitHSA) * 100);
      document.getElementById('progressHSA').style.width = `${pctHSA}%`;
      document.getElementById('contribHSAPct').textContent = `${Math.round(pctHSA)}%`;
      const savingsHSA = Math.round(contribHSA * marginalRate);
      document.getElementById('savingsHSA').textContent = formatCurrency(savingsHSA);
      document.getElementById('retirementHSA').classList.toggle('has-contribution', contribHSA > 0);

      // SEP
      const contribSEP = parseFloat(document.getElementById('contribSEP')?.value) || 0;
      const seIncome = state.taxData?.selfEmploymentIncome || 0;
      const limitSEP = Math.min(limits['SEP_max'], seIncome * 0.25);
      const pctSEP = limitSEP > 0 ? Math.min(100, (contribSEP / limitSEP) * 100) : 0;
      document.getElementById('progressSEP').style.width = `${pctSEP}%`;
      document.getElementById('contribSEPPct').textContent = `${Math.round(pctSEP)}%`;
      const savingsSEP = Math.round(contribSEP * marginalRate);
      document.getElementById('savingsSEP').textContent = formatCurrency(savingsSEP);
      document.getElementById('retirementSEP').classList.toggle('has-contribution', contribSEP > 0);

      // Total
      const totalSavings = savings401k + savingsIRA + savingsHSA + savingsSEP;
      document.getElementById('totalRetirementSavings').textContent = formatCurrency(totalSavings);
    }

    // Close modal on overlay click
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('tax-optimizer-overlay')) {
        closeTaxOptimizer();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && taxOptimizerState.isOpen) {
        closeTaxOptimizer();
      }
    });

    // ============ INIT ============
    function init() {
      setupUploadZone();
      updateRefund();
      updateInfoCard();

      // Hide all step views and show welcome modal
      elements.stepViews.forEach(view => view.classList.add('hidden'));
      hideAllSubsteps();
      showWelcomeModal();

      // Initialize mobile features
      initMobile();

      // Initialize smart validation (conditional fields, auto-calculations)
      initSmartValidation();

      // Initialize Smart Insights
      initSmartInsights();
    }

    init();
  </script>

  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-bottom-nav" id="mobileBottomNav">
    <div class="nav-items">
      <div class="nav-item active" data-step="1">
        <span class="nav-icon">ðŸ‘¤</span>
        <span>Status</span>
      </div>
      <div class="nav-item" data-step="2">
        <span class="nav-icon">ðŸ“„</span>
        <span>Docs</span>
      </div>
      <div class="nav-item" data-step="3">
        <span class="nav-icon">ðŸ’°</span>
        <span>Income</span>
      </div>
      <div class="nav-item" data-step="4">
        <span class="nav-icon">ðŸ“</span>
        <span>Deductions</span>
      </div>
      <div class="nav-item" data-step="5">
        <span class="nav-icon">ðŸŽ</span>
        <span>Credits</span>
      </div>
      <div class="nav-item" data-step="6">
        <span class="nav-icon">âœ“</span>
        <span>Review</span>
      </div>
    </div>
  </nav>

  <!-- Feedback Toast (Prompt 6) -->
  <div class="feedback-toast" id="feedbackToast">
    <div class="feedback-toast-header">
      <div class="feedback-toast-icon">âœ“</div>
      <div class="feedback-toast-title" id="feedbackToastTitle">Change Applied</div>
      <button class="feedback-toast-close" onclick="closeFeedbackToast()">Ã—</button>
    </div>
    <div class="feedback-toast-comparison">
      <div class="feedback-toast-value before">
        <div class="feedback-toast-label">Before</div>
        <div class="feedback-toast-amount" id="feedbackBefore">$0</div>
      </div>
      <div class="feedback-toast-arrow">â†’</div>
      <div class="feedback-toast-value after">
        <div class="feedback-toast-label">After</div>
        <div class="feedback-toast-amount" id="feedbackAfter">$0</div>
      </div>
    </div>
    <div class="feedback-toast-savings">
      <div class="feedback-toast-savings-amount" id="feedbackSavings">$0</div>
      <div class="feedback-toast-savings-label">saved!</div>
    </div>
    <div class="feedback-toast-actions">
      <button class="feedback-toast-btn feedback-toast-btn-primary" onclick="closeFeedbackToast()">Great!</button>
      <button class="feedback-toast-btn feedback-toast-btn-secondary" onclick="undoLastChange()">Undo</button>
    </div>
  </div>

  <!-- Tax Optimizer Modal -->
  <div class="tax-optimizer-overlay" id="taxOptimizerOverlay">
    <div class="tax-optimizer-modal">
      <div class="optimizer-header">
        <div class="optimizer-header-left">
          <div class="optimizer-icon">ðŸŽ¯</div>
          <div>
            <div class="optimizer-title">Tax Optimizer</div>
            <div class="optimizer-subtitle">Explore strategies to minimize your tax burden</div>
          </div>
        </div>
        <button class="optimizer-close" onclick="closeTaxOptimizer()">&times;</button>
      </div>

      <!-- Goal-Based Guided Flow (Prompt 4) -->
      <div class="guided-flow-overlay" id="guidedFlowOverlay">
        <button class="guided-flow-close" onclick="closeGuidedFlow()">&times;</button>

        <!-- Step 1: Goal Selection -->
        <div class="guided-flow-step active" id="guidedFlowGoals">
          <div class="guided-flow-title">What's Your Tax Goal?</div>
          <div class="guided-flow-subtitle">Select your primary objective and we'll guide you to the best options</div>

          <div class="goal-cards-grid">
            <div class="goal-card" onclick="selectGoal('save_money')">
              <div class="goal-card-icon">ðŸ’°</div>
              <div class="goal-card-title">Save Money on Taxes</div>
              <div class="goal-card-desc">Find deductions & credits</div>
            </div>
            <div class="goal-card" onclick="selectGoal('start_business')">
              <div class="goal-card-icon">ðŸ¢</div>
              <div class="goal-card-title">Start a Business</div>
              <div class="goal-card-desc">Compare entity types</div>
            </div>
            <div class="goal-card" onclick="selectGoal('retirement')">
              <div class="goal-card-icon">ðŸŽ¯</div>
              <div class="goal-card-title">Plan for Retirement</div>
              <div class="goal-card-desc">Maximize contributions</div>
            </div>
            <div class="goal-card" onclick="selectGoal('compare')">
              <div class="goal-card-icon">ðŸ“Š</div>
              <div class="goal-card-title">Compare Scenarios</div>
              <div class="goal-card-desc">What-if analysis</div>
            </div>
          </div>

          <button class="guided-flow-skip" onclick="skipGuidedFlow()">Skip - Show me everything</button>

          <div class="guided-flow-remember">
            <input type="checkbox" id="guidedFlowRemember" />
            <label for="guidedFlowRemember">Don't show this again</label>
          </div>
        </div>

        <!-- Step 2: Questionnaire (for Save Money goal) -->
        <div class="guided-flow-step" id="guidedFlowQuestionnaire">
          <div class="questionnaire-header">
            <button class="questionnaire-back" onclick="goToGuidedStep('goals')">â†</button>
            <div class="questionnaire-progress">
              <div class="guided-flow-title" id="questionnaireTitle">ðŸ’° Save Money on Taxes</div>
              <div class="questionnaire-progress-dots">
                <div class="progress-dot active" id="progressDot1"></div>
                <div class="progress-dot" id="progressDot2"></div>
                <div class="progress-dot" id="progressDot3"></div>
              </div>
            </div>
            <div style="width: 24px;"></div>
          </div>

          <div class="guided-flow-subtitle">Answer 3 quick questions to find your biggest savings</div>

          <!-- Question 1 -->
          <div class="questionnaire-question" id="question1">
            <div class="question-label">1. Do you have self-employment income?</div>
            <div class="question-options">
              <div class="question-option" onclick="selectQuestionOption(1, 'self_employed')">
                <input type="radio" name="q1" id="q1_self" value="self_employed" />
                <label for="q1_self">Yes, I'm self-employed/freelance</label>
              </div>
              <div class="question-option" onclick="selectQuestionOption(1, 'w2')">
                <input type="radio" name="q1" id="q1_w2" value="w2" />
                <label for="q1_w2">No, I'm a W-2 employee</label>
              </div>
              <div class="question-option" onclick="selectQuestionOption(1, 'both')">
                <input type="radio" name="q1" id="q1_both" value="both" />
                <label for="q1_both">Both - I have W-2 and self-employment income</label>
              </div>
            </div>
          </div>

          <!-- Question 2 -->
          <div class="questionnaire-question" id="question2" style="display: none;">
            <div class="question-label">2. What's your approximate annual income?</div>
            <input type="text" class="question-input" id="q2Income" placeholder="$75,000" oninput="formatIncomeInput(this)" />
          </div>

          <!-- Question 3 -->
          <div class="questionnaire-question" id="question3" style="display: none;">
            <div class="question-label">3. Are you contributing to retirement accounts?</div>
            <div class="question-options">
              <div class="question-option" onclick="selectQuestionOption(3, 'maxed')">
                <input type="radio" name="q3" id="q3_maxed" value="maxed" />
                <label for="q3_maxed">Yes, maxing out my contributions</label>
              </div>
              <div class="question-option" onclick="selectQuestionOption(3, 'some')">
                <input type="radio" name="q3" id="q3_some" value="some" />
                <label for="q3_some">Yes, but not maxed out</label>
              </div>
              <div class="question-option" onclick="selectQuestionOption(3, 'none')">
                <input type="radio" name="q3" id="q3_none" value="none" />
                <label for="q3_none">No retirement contributions</label>
              </div>
            </div>
          </div>

          <div class="questionnaire-actions">
            <button class="questionnaire-btn questionnaire-btn-primary" id="questionnaireNextBtn" onclick="nextQuestion()" disabled>
              Next â†’
            </button>
          </div>
        </div>

        <!-- Step 3: Results -->
        <div class="guided-flow-step" id="guidedFlowResults">
          <div class="results-celebration">ðŸŽ‰</div>
          <div class="guided-flow-title">Great news!</div>
          <div class="guided-flow-subtitle">Based on your answers, we found potential savings</div>

          <div class="results-savings-card">
            <div class="results-savings-amount" id="guidedResultsAmount">$0</div>
            <div class="results-savings-label">in potential tax savings</div>
          </div>

          <div class="results-opportunities">
            <div class="results-opportunities-title">Top opportunities for you:</div>
            <div id="guidedResultsList">
              <!-- Dynamically populated -->
            </div>
          </div>

          <div class="results-actions">
            <button class="results-btn-primary" id="guidedStartBtn" onclick="startTopOpportunity()">
              Start with #1 â†’
            </button>
            <button class="results-btn-secondary" onclick="closeGuidedFlow()">
              See all opportunities
            </button>
          </div>
        </div>
      </div>

      <!-- Progressive Disclosure: Recommendation View (Prompt 2) -->
      <div class="optimizer-recommendation-view active" id="optimizerRecommendationView">
        <div class="optimizer-content">
          <div class="recommendation-hero">
            <div class="recommendation-intro" id="recommendationIntro">
              Analyzing your tax situation...
            </div>

            <div class="recommendation-card" id="recommendationCard">
              <div class="recommendation-badge">Recommended</div>
              <div class="recommendation-title" id="recommendationTitle">Loading...</div>
              <div class="recommendation-savings" id="recommendationSavings">$0</div>
              <div class="recommendation-savings-label">potential tax savings</div>

              <div class="recommendation-actions">
                <button class="recommendation-btn-primary" onclick="showRecommendationDetails()">
                  See Details
                  <span>â†’</span>
                </button>
                <button class="recommendation-btn-secondary" onclick="showAdvancedView()">
                  Compare All Options
                </button>
              </div>
            </div>

            <div class="other-opportunities" id="otherOpportunities">
              <div class="other-opportunities-title">Other Opportunities</div>
              <div id="opportunitiesList">
                <!-- Dynamically populated -->
              </div>
            </div>
          </div>
        </div>

        <!-- Detail Expansion View -->
        <div class="detail-expansion-view" id="detailExpansionView">
          <div class="optimizer-content">
            <button class="detail-back-btn" onclick="hideRecommendationDetails()">
              â† Back to Summary
            </button>

            <div class="detail-comparison" id="detailComparison">
              <div class="detail-comparison-card">
                <div class="detail-comparison-label">Current</div>
                <div class="detail-comparison-amount" id="detailCurrentTax">$0</div>
                <div class="detail-comparison-breakdown" id="detailCurrentBreakdown"></div>
              </div>

              <div class="detail-arrow">â†’</div>

              <div class="detail-comparison-card after">
                <div class="detail-comparison-label">With Optimization</div>
                <div class="detail-comparison-amount" id="detailNewTax">$0</div>
                <div class="detail-comparison-breakdown" id="detailNewBreakdown"></div>
              </div>
            </div>

            <div class="detail-savings-banner">
              <div class="detail-savings-amount" id="detailSavingsAmount">$0</div>
              <div class="detail-savings-label">total savings</div>
            </div>

            <button class="detail-apply-btn" onclick="applyRecommendation()">
              Apply This Strategy
            </button>
          </div>
        </div>

        <div class="view-toggle">
          <button class="view-toggle-btn" onclick="showAdvancedView()">
            âš™ï¸ Advanced Options
          </button>
        </div>
      </div>

      <div class="optimizer-tabs" id="optimizerTabs" style="display: none;">
        <button class="optimizer-tab active" data-tab="scenarios" onclick="switchOptimizerTab('scenarios')">
          <span class="optimizer-tab-icon">ðŸ”„</span>
          What-If Scenarios
        </button>
        <button class="optimizer-tab" data-tab="entity" onclick="switchOptimizerTab('entity')">
          <span class="optimizer-tab-icon">ðŸ¢</span>
          Business Entity
        </button>
        <button class="optimizer-tab" data-tab="retirement" onclick="switchOptimizerTab('retirement')">
          <span class="optimizer-tab-icon">ðŸ’°</span>
          Retirement Planning
        </button>
        <button class="view-toggle-btn" onclick="showSimpleView()" style="margin-left: auto;">
          â† Simple View
        </button>
      </div>

      <div class="optimizer-content" id="optimizerContent">
        <!-- What-If Scenarios Panel -->
        <div class="optimizer-panel active" id="panel-scenarios">
          <div class="scenario-builder">
            <div class="scenario-section">
              <div class="scenario-section-title">
                <span>ðŸ“</span> Build Your Scenario
              </div>
              <div class="scenario-input-group">
                <label class="scenario-label">Scenario Type</label>
                <select class="scenario-select" id="scenarioType" onchange="updateScenarioInputs()">
                  <option value="filing_status">Compare Filing Statuses</option>
                  <option value="income">What If My Income Changes?</option>
                  <option value="deduction">What If I Add a Deduction?</option>
                  <option value="retirement">What If I Max Retirement?</option>
                </select>
              </div>

              <div id="scenarioInputs">
                <!-- Dynamic inputs based on scenario type -->
                <div class="scenario-input-group" id="filingStatusInputs">
                  <label class="scenario-label">Compare These Statuses</label>
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                      <input type="checkbox" id="compare_single" checked> Single
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                      <input type="checkbox" id="compare_mfj" checked> Married Filing Jointly
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                      <input type="checkbox" id="compare_mfs"> Married Filing Separately
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                      <input type="checkbox" id="compare_hoh"> Head of Household
                    </label>
                  </div>
                </div>

                <div class="scenario-input-group" id="incomeInputs" style="display: none;">
                  <label class="scenario-label">New Income Amount</label>
                  <input type="number" class="scenario-input" id="newIncomeAmount" placeholder="e.g., 85000">
                </div>

                <div class="scenario-input-group" id="deductionInputs" style="display: none;">
                  <label class="scenario-label">Deduction Type</label>
                  <select class="scenario-select" id="deductionType">
                    <option value="charitable">Charitable Donation</option>
                    <option value="mortgage_interest">Mortgage Interest</option>
                    <option value="state_taxes">State/Local Taxes</option>
                    <option value="medical">Medical Expenses</option>
                  </select>
                  <label class="scenario-label" style="margin-top: 12px;">Amount</label>
                  <input type="number" class="scenario-input" id="deductionAmount" placeholder="e.g., 5000">
                </div>
              </div>

              <button class="scenario-compare-btn" onclick="runScenarioComparison()">
                Compare Scenarios
              </button>
            </div>

            <div class="scenario-section">
              <div class="scenario-section-title">
                <span>ðŸ“Š</span> Results
              </div>
              <div id="scenarioResults">
                <div class="insights-empty">
                  <div class="insights-empty-icon">ðŸŽ¯</div>
                  <div>Select a scenario type and click Compare to see results</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Business Entity Panel -->
        <div class="optimizer-panel" id="panel-entity">
          <div class="entity-comparison">
            <div class="entity-inputs">
              <div class="scenario-section-title">
                <span>ðŸ“‹</span> Business Information
              </div>
              <div class="scenario-input-group">
                <label class="scenario-label">Gross Business Revenue</label>
                <input type="number" class="scenario-input" id="entityGrossRevenue" placeholder="e.g., 150000" value="">
              </div>
              <div class="scenario-input-group">
                <label class="scenario-label">Business Expenses</label>
                <input type="number" class="scenario-input" id="entityExpenses" placeholder="e.g., 30000" value="">
              </div>
              <div class="scenario-input-group">
                <label class="scenario-label">Other Personal Income</label>
                <input type="number" class="scenario-input" id="entityOtherIncome" placeholder="e.g., 50000" value="0">
              </div>
              <div class="scenario-input-group">
                <label class="scenario-label">Filing Status</label>
                <select class="scenario-select" id="entityFilingStatus">
                  <option value="single">Single</option>
                  <option value="married_joint">Married Filing Jointly</option>
                  <option value="married_separate">Married Filing Separately</option>
                  <option value="head_of_household">Head of Household</option>
                </select>
              </div>
              <button class="scenario-compare-btn" onclick="compareEntities()">
                Compare Structures
              </button>

              <!-- Salary Slider (shown after comparison) -->
              <div class="salary-slider-container" id="salarySliderContainer" style="display: none;">
                <div class="salary-slider-header">
                  <span class="salary-slider-label">S-Corp Salary</span>
                  <span class="salary-slider-value" id="salarySliderValue">$60,000</span>
                </div>
                <input type="range" class="salary-slider" id="salarySlider" min="0" max="150000" value="60000" oninput="updateSalarySlider()">
                <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--gray-500); margin-top: 4px;">
                  <span>$0</span>
                  <span>Max: $<span id="salarySliderMax">150,000</span></span>
                </div>
              </div>
            </div>

            <div class="entity-results" id="entityResults">
              <div class="insights-empty" style="padding: 60px 20px;">
                <div class="insights-empty-icon">ðŸ¢</div>
                <div>Enter your business information and click Compare to see entity structure analysis</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Retirement Planning Panel -->
        <div class="optimizer-panel" id="panel-retirement">
          <div class="retirement-planning">
            <!-- 401(k) Card -->
            <div class="retirement-account-card" id="retirement401k">
              <div class="retirement-header">
                <div class="retirement-icon type-401k">ðŸ’¼</div>
                <div>
                  <div class="retirement-name">401(k) / 403(b)</div>
                  <div class="retirement-limit">2025 Limit: $23,500 (+$7,500 catch-up if 50+)</div>
                </div>
              </div>
              <div class="retirement-input-row">
                <input type="number" class="retirement-input" id="contrib401k" placeholder="0" value="0" oninput="updateRetirementSavings()">
                <button class="retirement-max-btn" onclick="maxContribution('401k')">Max Out</button>
              </div>
              <div class="retirement-progress">
                <div class="retirement-progress-bar" id="progress401k" style="width: 0%"></div>
              </div>
              <div class="retirement-progress-label">
                <span id="contrib401kPct">0%</span>
                <span>of $23,500</span>
              </div>
              <div class="retirement-savings-preview">
                <span class="retirement-savings-label">Estimated tax savings</span>
                <span class="retirement-savings-value" id="savings401k">$0</span>
              </div>
            </div>

            <!-- Traditional IRA Card -->
            <div class="retirement-account-card" id="retirementIRA">
              <div class="retirement-header">
                <div class="retirement-icon type-ira">ðŸ“ˆ</div>
                <div>
                  <div class="retirement-name">Traditional IRA</div>
                  <div class="retirement-limit">2025 Limit: $7,000 (+$1,000 catch-up if 50+)</div>
                </div>
              </div>
              <div class="retirement-input-row">
                <input type="number" class="retirement-input" id="contribIRA" placeholder="0" value="0" oninput="updateRetirementSavings()">
                <button class="retirement-max-btn" onclick="maxContribution('IRA')">Max Out</button>
              </div>
              <div class="retirement-progress">
                <div class="retirement-progress-bar" id="progressIRA" style="width: 0%"></div>
              </div>
              <div class="retirement-progress-label">
                <span id="contribIRAPct">0%</span>
                <span>of $7,000</span>
              </div>
              <div class="retirement-savings-preview">
                <span class="retirement-savings-label">Estimated tax savings</span>
                <span class="retirement-savings-value" id="savingsIRA">$0</span>
              </div>
            </div>

            <!-- HSA Card -->
            <div class="retirement-account-card" id="retirementHSA">
              <div class="retirement-header">
                <div class="retirement-icon type-hsa">ðŸ¥</div>
                <div>
                  <div class="retirement-name">Health Savings Account (HSA)</div>
                  <div class="retirement-limit">2025 Limit: $4,300 individual / $8,550 family</div>
                </div>
              </div>
              <div class="retirement-input-row">
                <input type="number" class="retirement-input" id="contribHSA" placeholder="0" value="0" oninput="updateRetirementSavings()">
                <button class="retirement-max-btn" onclick="maxContribution('HSA')">Max Out</button>
              </div>
              <div class="retirement-progress">
                <div class="retirement-progress-bar" id="progressHSA" style="width: 0%"></div>
              </div>
              <div class="retirement-progress-label">
                <span id="contribHSAPct">0%</span>
                <span>of $<span id="hsaLimitDisplay">4,300</span></span>
              </div>
              <div class="retirement-savings-preview">
                <span class="retirement-savings-label">Estimated tax savings</span>
                <span class="retirement-savings-value" id="savingsHSA">$0</span>
              </div>
            </div>

            <!-- SEP-IRA Card (for self-employed) -->
            <div class="retirement-account-card" id="retirementSEP">
              <div class="retirement-header">
                <div class="retirement-icon type-sep">ðŸª</div>
                <div>
                  <div class="retirement-name">SEP-IRA (Self-Employed)</div>
                  <div class="retirement-limit">2025 Limit: 25% of net SE income, max $69,000</div>
                </div>
              </div>
              <div class="retirement-input-row">
                <input type="number" class="retirement-input" id="contribSEP" placeholder="0" value="0" oninput="updateRetirementSavings()">
                <button class="retirement-max-btn" onclick="maxContribution('SEP')">Max Out</button>
              </div>
              <div class="retirement-progress">
                <div class="retirement-progress-bar" id="progressSEP" style="width: 0%"></div>
              </div>
              <div class="retirement-progress-label">
                <span id="contribSEPPct">0%</span>
                <span>of max allowed</span>
              </div>
              <div class="retirement-savings-preview">
                <span class="retirement-savings-label">Estimated tax savings</span>
                <span class="retirement-savings-value" id="savingsSEP">$0</span>
              </div>
            </div>

            <!-- Summary Row -->
            <div class="retirement-summary">
              <div class="retirement-summary-left">
                <h3>Total Retirement Strategy</h3>
                <p>Combined contributions and estimated tax impact</p>
              </div>
              <div class="retirement-summary-right">
                <div class="retirement-total-savings" id="totalRetirementSavings">$0</div>
                <div class="retirement-total-label">Estimated Annual Tax Savings</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
