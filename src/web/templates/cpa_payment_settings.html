<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Settings - CPA Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e3a5f',
                        secondary: '#5387c1',
                        accent: '#10b981'
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="/static/css/core/variables.css">
    <link rel="stylesheet" href="/static/css/core/reset.css">
    <link rel="stylesheet" href="/static/css/core/typography.css">
    <link rel="stylesheet" href="/static/css/unified-theme.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/cpa/dashboard" class="text-primary font-bold text-xl">CPA Dashboard</a>
                    <span class="ml-4 text-gray-400">/</span>
                    <span class="ml-4 text-gray-600">Payment Settings</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/cpa/settings" class="text-gray-600 hover:text-primary">Settings</a>
                    <a href="/logout" class="text-gray-600 hover:text-red-600">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-8">Payment Settings</h1>

        <!-- Stripe Connect Section -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <div class="flex items-start justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                        <svg class="w-6 h-6 mr-2" viewBox="0 0 28 28" fill="none">
                            <rect width="28" height="28" rx="6" fill="#635BFF"/>
                            <path d="M13.24 11.09c0-.66.54-1.01 1.43-1.01.83 0 1.89.25 2.72.69V8.22c-.91-.36-1.81-.51-2.72-.51-2.22 0-3.7 1.16-3.7 3.1 0 3.02 4.15 2.54 4.15 3.84 0 .78-.68 1.03-1.63 1.03-.94 0-2.14-.39-3.08-.91v2.59c1.05.45 2.1.64 3.08.64 2.28 0 3.85-1.13 3.85-3.1 0-3.26-4.1-2.68-4.1-3.82z" fill="#fff"/>
                        </svg>
                        Stripe Connect
                    </h2>
                    <p class="text-gray-500 mt-1">Connect your Stripe account to collect payments from clients</p>
                </div>
                <div id="stripe-status" class="flex items-center">
                    <!-- Status will be loaded dynamically -->
                </div>
            </div>

            <div id="stripe-content" class="mt-6">
                <!-- Content loaded dynamically -->
                <div class="flex justify-center py-4">
                    <svg class="animate-spin h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Payment Preferences -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Payment Preferences</h2>

            <form id="preferences-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Default Currency</label>
                    <select id="currency" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                        <option value="USD">USD - US Dollar</option>
                        <option value="CAD">CAD - Canadian Dollar</option>
                        <option value="EUR">EUR - Euro</option>
                        <option value="GBP">GBP - British Pound</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Due Days</label>
                    <input type="number" id="due-days" min="1" max="90" value="30"
                           class="w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary">
                    <p class="text-sm text-gray-500 mt-1">Number of days before invoice is due</p>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="auto-invoice" checked
                           class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                    <label for="auto-invoice" class="ml-2 text-sm text-gray-700">
                        Automatically generate invoices for completed returns
                    </label>
                </div>

                <div class="pt-4">
                    <button type="submit"
                            class="bg-primary text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        Save Preferences
                    </button>
                </div>
            </form>
        </div>

        <!-- Payment History -->
        <div class="bg-white rounded-lg shadow-sm border p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Recent Payments</h2>
                <a href="/cpa/payments" class="text-primary hover:underline text-sm">View All</a>
            </div>

            <div id="payment-history">
                <div class="text-center py-8 text-gray-500">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                    </svg>
                    <p class="mt-2">No payments yet</p>
                    <p class="text-sm">Connect Stripe to start collecting payments</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Get CPA ID from URL or session
        const urlParams = new URLSearchParams(window.location.search);
        const cpaId = urlParams.get('cpa') || (typeof currentCpaId !== 'undefined' ? currentCpaId : null);
        if (!cpaId) {
            document.querySelector('main').innerHTML = '<div style="text-align:center;padding:3rem;color:var(--gray-500);">No CPA ID provided. Please log in as a CPA to access payment settings.</div>';
        }

        // Load payment settings
        async function loadPaymentSettings() {
            try {
                const response = await fetch(`/api/cpa/payment-settings/?cpa_id=${cpaId}`);
                const data = await response.json();

                updateStripeStatus(data.stripe_connect);
                updatePreferences(data);
            } catch (error) {
                console.error('Error loading payment settings:', error);
                document.getElementById('stripe-content').innerHTML = `
                    <div class="text-red-600">Error loading payment settings. Please refresh the page.</div>
                `;
            }
        }

        function updateStripeStatus(stripeConnect) {
            const statusEl = document.getElementById('stripe-status');
            const contentEl = document.getElementById('stripe-content');

            if (stripeConnect.connected) {
                statusEl.innerHTML = `
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        Connected
                    </span>
                `;

                contentEl.innerHTML = `
                    <div class="border rounded-lg p-4 bg-gray-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-900">Account: ${stripeConnect.account_id}</p>
                                <p class="text-sm text-gray-500">Connected ${stripeConnect.connected_at ? new Date(stripeConnect.connected_at).toLocaleDateString() : 'recently'}</p>
                            </div>
                            <div class="space-x-4">
                                <a href="https://dashboard.stripe.com/" target="_blank"
                                   class="text-primary hover:underline text-sm">Stripe Dashboard</a>
                                <button onclick="disconnectStripe()"
                                        class="text-red-600 hover:underline text-sm">Disconnect</button>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-4">
                            <div class="flex items-center">
                                ${stripeConnect.charges_enabled
                                    ? '<svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>'
                                    : '<svg class="w-5 h-5 text-yellow-500 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>'}
                                <span class="text-sm text-gray-700">Charges ${stripeConnect.charges_enabled ? 'enabled' : 'pending'}</span>
                            </div>
                            <div class="flex items-center">
                                ${stripeConnect.payouts_enabled
                                    ? '<svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>'
                                    : '<svg class="w-5 h-5 text-yellow-500 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>'}
                                <span class="text-sm text-gray-700">Payouts ${stripeConnect.payouts_enabled ? 'enabled' : 'pending'}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                statusEl.innerHTML = `
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                        Not Connected
                    </span>
                `;

                contentEl.innerHTML = `
                    <div class="text-center py-6">
                        <p class="text-gray-600 mb-4">Connect your Stripe account to:</p>
                        <ul class="text-sm text-gray-500 mb-6 space-y-2">
                            <li>Accept credit card payments from clients</li>
                            <li>Automatically process payments for invoices</li>
                            <li>Get paid directly to your bank account</li>
                        </ul>
                        <button onclick="connectStripe()"
                                class="bg-[#635BFF] text-white px-6 py-3 rounded-md hover:bg-[#5147e5] transition-colors inline-flex items-center">
                            <svg class="w-5 h-5 mr-2" viewBox="0 0 28 28" fill="none">
                                <path d="M13.24 11.09c0-.66.54-1.01 1.43-1.01.83 0 1.89.25 2.72.69V8.22c-.91-.36-1.81-.51-2.72-.51-2.22 0-3.7 1.16-3.7 3.1 0 3.02 4.15 2.54 4.15 3.84 0 .78-.68 1.03-1.63 1.03-.94 0-2.14-.39-3.08-.91v2.59c1.05.45 2.1.64 3.08.64 2.28 0 3.85-1.13 3.85-3.1 0-3.26-4.1-2.68-4.1-3.82z" fill="#fff"/>
                            </svg>
                            Connect with Stripe
                        </button>
                    </div>
                `;
            }
        }

        function updatePreferences(data) {
            document.getElementById('currency').value = data.default_currency || 'USD';
            document.getElementById('due-days').value = data.invoice_due_days || 30;
            document.getElementById('auto-invoice').checked = data.auto_invoice !== false;
        }

        async function connectStripe() {
            try {
                const response = await fetch(`/api/cpa/payment-settings/stripe/connect-url?cpa_id=${cpaId}`);
                const data = await response.json();

                if (data.connect_url) {
                    window.location.href = data.connect_url;
                } else {
                    showToast('Error generating Stripe connect URL. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error connecting to Stripe:', error);
                showToast('Error connecting to Stripe. Please try again.', 'error');
            }
        }

        async function disconnectStripe() {
            if (!confirm('Are you sure you want to disconnect your Stripe account? You will no longer be able to accept card payments.')) {
                return;
            }

            try {
                const response = await fetch(`/api/cpa/payment-settings/stripe/disconnect?cpa_id=${cpaId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    location.reload();
                } else {
                    showToast('Error disconnecting Stripe. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error disconnecting Stripe:', error);
                showToast('Error disconnecting Stripe. Please try again.', 'error');
            }
        }

        // Handle preferences form
        document.getElementById('preferences-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                default_currency: document.getElementById('currency').value,
                invoice_due_days: parseInt(document.getElementById('due-days').value),
                auto_invoice: document.getElementById('auto-invoice').checked
            };

            try {
                const response = await fetch(`/api/cpa/payment-settings/?cpa_id=${cpaId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showToast('Preferences saved successfully!', 'success');
                } else {
                    showToast('Error saving preferences. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error saving preferences:', error);
                showToast('Error saving preferences. Please try again.', 'error');
            }
        });

        // Check for success/error messages from Stripe callback
        if (urlParams.get('success') === 'connected') {
            showToast('Stripe account connected successfully!', 'success');
            // Clean URL
            window.history.replaceState({}, '', window.location.pathname + '?cpa=' + cpaId);
        } else if (urlParams.get('error')) {
            showToast('Error connecting Stripe: ' + (urlParams.get('message') || urlParams.get('error')), 'error');
            window.history.replaceState({}, '', window.location.pathname + '?cpa=' + cpaId);
        }

        // Load settings on page load
        loadPaymentSettings();
    </script>
</body>
</html>
