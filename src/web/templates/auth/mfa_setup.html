<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Up Two-Factor Authentication | Jorss-Gbo</title>
    <meta name="description" content="Secure your account with two-factor authentication using an authenticator app.">
    <style>
        :root {
            --primary: var(--color-primary-500);
            --primary-light: var(--color-primary-300);
            --primary-dark: #0c1b2f;
            --bg: #f7fafc;
            --surface: var(--white);
            --text: #0c1b2f;
            --text-light: #4a5568;
            --text-muted: #718096;
            --success: #276749;
            --success-light: #c6f6d5;
            --error: #c53030;
            --error-light: #fed7d7;
            --border: var(--color-slate-200);
            --border-focus: var(--color-primary-500);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ── Header ── */
        .header {
            padding: var(--space-5) var(--space-6);

            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-2-5);

            text-decoration: none;
            color: white;
            font-weight: var(--font-bold);

            font-size: 1.25rem;
        }

        .logo img {
            height: var(--space-8);

            filter: brightness(0) invert(1);
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: var(--space-1-5);

            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: white;
        }

        .back-link svg {
            width: 18px;
            height: 18px;
        }

        /* ── Main ── */
        .main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-5);

        }

        .auth-container {
            width: 100%;
            max-width: 480px;
        }

        /* ── Card ── */
        .auth-card {
            background: var(--surface);
            border-radius: var(--radius-2xl-plus);
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .auth-header {
            padding: var(--space-10) var(--space-10) var(--space-6);

            text-align: center;
        }

        .auth-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius-2xl);

            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-5);

        }

        .auth-icon svg {
            width: var(--space-8);

            height: var(--space-8);

            color: white;
        }

        .auth-title {
            font-size: 1.75rem;
            font-weight: var(--font-bold);

            color: var(--text);
            margin-bottom: var(--space-2);

        }

        .auth-subtitle {
            font-size: 1rem;
            color: var(--text-muted);
            line-height: var(--leading-normal);

        }

        .auth-body {
            padding: 0 var(--space-10) var(--space-10);

        }

        /* ── Stepper ── */
        .stepper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            margin-bottom: var(--space-8);

        }

        .stepper-step {
            display: flex;
            align-items: center;
            gap: var(--space-2);

        }

        .stepper-dot {
            width: var(--space-8);

            height: var(--space-8);

            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: var(--font-bold);

            border: 2px solid var(--border);
            color: var(--text-muted);
            background: var(--surface);
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .stepper-dot.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .stepper-dot.completed {
            border-color: var(--success);
            background: var(--success);
            color: white;
        }

        .stepper-label {
            font-size: 0.8rem;
            font-weight: var(--font-semibold);

            color: var(--text-muted);
            transition: color 0.3s;
            white-space: nowrap;
        }

        .stepper-label.active {
            color: var(--text);
        }

        .stepper-label.completed {
            color: var(--success);
        }

        .stepper-line {
            width: var(--space-10);

            height: 2px;
            background: var(--border);
            margin: 0 var(--space-2);

            transition: background 0.3s;
            flex-shrink: 0;
        }

        .stepper-line.completed {
            background: var(--success);
        }

        /* ── Alerts ── */
        .alert {
            padding: var(--space-3) var(--space-4);

            border-radius: var(--radius-lg);

            margin-bottom: var(--space-5);

            font-size: 0.9rem;
            display: flex;
            align-items: flex-start;
            gap: var(--space-2-5);

            line-height: 1.4;
        }

        .alert-error {
            background: var(--error-light);
            color: var(--error);
        }

        .alert-success {
            background: var(--success-light);
            color: var(--success);
        }

        .alert-info {
            background: #ebf4ff;
            color: var(--primary);
        }

        .alert svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            margin-top: var(--space-px);

        }

        /* ── QR Code Area ── */
        .qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: var(--space-6);

        }

        .qr-frame {
            background: white;
            border: 2px solid var(--border);
            border-radius: var(--radius-xl);

            padding: var(--space-4);

            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--space-4);

        }

        .qr-frame img {
            width: 200px;
            height: 200px;
            display: block;
        }

        .qr-placeholder {
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }

        .qr-placeholder svg {
            width: var(--space-12);

            height: var(--space-12);

            animation: spin 1s linear infinite;
        }

        /* ── Secret Key Fallback ── */
        .secret-fallback {
            width: 100%;
            margin-bottom: var(--space-6);

        }

        .secret-fallback-label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: var(--space-2);

            text-align: center;
        }

        .secret-key-box {
            display: flex;
            align-items: center;
            gap: var(--space-2);

            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);

            padding: var(--space-2-5) var(--space-3-5);

        }

        .secret-key-value {
            flex: 1;
            font-family: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.9rem;
            font-weight: var(--font-semibold);

            color: var(--text);
            letter-spacing: 1px;
            word-break: break-all;
            user-select: all;
        }

        .btn-copy-inline {
            flex-shrink: 0;
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: var(--space-1);

            border-radius: var(--radius-base);
            transition: background 0.2s;
            display: flex;
            align-items: center;
        }

        .btn-copy-inline:hover {
            background: rgba(30,58,95,0.08);
        }

        .btn-copy-inline svg {
            width: 18px;
            height: 18px;
        }

        /* ── Form Controls ── */
        .form-group {
            margin-bottom: var(--space-5);

        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: var(--font-semibold);

            color: var(--text);
            margin-bottom: var(--space-2);

        }

        .form-input {
            width: 100%;
            padding: var(--space-3-5) var(--space-4);

            font-size: 1rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-lg-plus);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: var(--surface);
            color: var(--text);
            font-family: inherit;
        }

        .form-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .code-input {
            text-align: center;
            font-family: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 1.5rem;
            font-weight: var(--font-bold);

            letter-spacing: 8px;
            padding: var(--space-4) var(--space-5);

        }

        .form-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: var(--space-1-5);

        }

        /* ── Buttons ── */
        .btn-submit {
            width: 100%;
            padding: var(--space-4) var(--space-6);

            font-size: 1rem;
            font-weight: var(--font-semibold);

            color: white;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border: none;
            border-radius: var(--radius-lg-plus);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
            box-shadow: 0 4px 15px rgba(26, 54, 93, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);

            font-family: inherit;
        }

        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 54, 93, 0.4);
        }

        .btn-submit:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-submit:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-submit svg {
            width: var(--space-5);

            height: var(--space-5);

        }

        .btn-secondary {
            width: 100%;
            padding: var(--space-3-5) var(--space-6);

            font-size: 0.95rem;
            font-weight: var(--font-semibold);

            color: var(--text);
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg-plus);
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);

            font-family: inherit;
        }

        .btn-secondary:hover {
            border-color: var(--text-muted);
            background: var(--bg);
        }

        .btn-secondary svg {
            width: 18px;
            height: 18px;
        }

        .btn-group {
            display: flex;
            gap: var(--space-3);

            margin-top: var(--space-4);

        }

        .btn-group .btn-secondary {
            flex: 1;
        }

        .btn-spinner {
            width: var(--space-5);

            height: var(--space-5);

            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ── Backup Codes ── */
        .backup-codes-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-2);

            margin-bottom: var(--space-6);

        }

        .backup-code {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);

            padding: var(--space-2-5) var(--space-3);

            font-family: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.9rem;
            font-weight: var(--font-semibold);

            color: var(--text);
            text-align: center;
            letter-spacing: 1px;
            user-select: all;
        }

        .backup-warning {
            background: var(--color-warning-50);

            border: 1px solid #f6e05e;
            border-radius: var(--radius-lg);

            padding: var(--space-3) var(--space-4);

            margin-bottom: var(--space-5);

            display: flex;
            align-items: flex-start;
            gap: var(--space-2-5);

            font-size: 0.85rem;
            color: #744210;
            line-height: 1.4;
        }

        .backup-warning svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            margin-top: var(--space-px);

            color: #d69e2e;
        }

        /* ── Success State ── */
        .success-icon {
            width: 80px;
            height: 80px;
            background: var(--success-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-6);

        }

        .success-icon svg {
            width: var(--space-10);

            height: var(--space-10);

            color: var(--success);
        }

        /* ── Instructions ── */
        .instructions {
            margin-bottom: var(--space-6);

        }

        .instructions-title {
            font-size: 0.95rem;
            font-weight: var(--font-semibold);

            color: var(--text);
            margin-bottom: var(--space-3);

        }

        .instructions ol {
            list-style: none;
            counter-reset: step;
            padding: 0;
        }

        .instructions ol li {
            counter-increment: step;
            display: flex;
            align-items: flex-start;
            gap: var(--space-2-5);

            font-size: 0.9rem;
            color: var(--text-light);
            line-height: var(--leading-normal);

            margin-bottom: var(--space-2);

        }

        .instructions ol li::before {
            content: counter(step);
            min-width: var(--space-6);

            height: var(--space-6);

            border-radius: 50%;
            background: var(--bg);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: var(--font-bold);

            color: var(--text);
            flex-shrink: 0;
        }

        /* ── Trust Bar ── */
        .trust-bar {
            display: flex;
            justify-content: center;
            gap: var(--space-6);

            padding: var(--space-5);

            color: rgba(255,255,255,0.8);
            font-size: 0.85rem;
        }

        .trust-item {
            display: flex;
            align-items: center;
            gap: var(--space-1-5);

        }

        .trust-item svg {
            width: var(--space-4);

            height: var(--space-4);

        }

        /* ── Copied Toast ── */
        .toast {
            position: fixed;
            bottom: var(--space-8);

            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--text);
            color: white;
            padding: var(--space-2-5) var(--space-5);

            border-radius: var(--radius-lg);

            font-size: 0.9rem;
            font-weight: var(--font-medium);

            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
            z-index: 1000;
        }

        .toast.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* ── Hidden utility ── */
        [x-cloak] {
            display: none !important;
        }

        /* ── Responsive ── */
        @media (max-width: 480px) {
            .header {
                padding: var(--space-4);

            }

            .main {
                padding: var(--space-4);

            }

            .auth-header {
                padding: var(--space-8) var(--space-6) var(--space-5);

            }

            .auth-body {
                padding: 0 var(--space-6) var(--space-8);

            }

            .auth-title {
                font-size: 1.5rem;
            }

            .stepper-label {
                display: none;
            }

            .stepper-line {
                width: var(--space-8);

            }

            .backup-codes-grid {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .trust-bar {
                flex-direction: column;
                align-items: center;
                gap: var(--space-2);

            }

            .code-input {
                font-size: 1.25rem;
                letter-spacing: 4px;
            }
        }
    </style>
    <script defer src="/static/js/vendor/alpine.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <a href="/" class="logo">Jorss-Gbo</a>
        <a href="/settings" class="back-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"/>
                <polyline points="12 19 5 12 12 5"/>
            </svg>
            Back to Settings
        </a>
    </header>

    <!-- Main -->
    <main class="main">
        <div class="auth-container"
             x-data="mfaSetup()"
             x-cloak>

            <div class="auth-card">
                <!-- Card Header - changes per step -->
                <div class="auth-header">
                    <div class="auth-icon">
                        <!-- Shield-lock icon -->
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                            <rect x="9" y="10" width="6" height="5" rx="1"/>
                            <path d="M10 10V8a2 2 0 1 1 4 0v2"/>
                        </svg>
                    </div>

                    <h1 class="auth-title" x-text="stepTitle"></h1>
                    <p class="auth-subtitle" x-text="stepSubtitle"></p>
                </div>

                <div class="auth-body">
                    <!-- Stepper -->
                    <div class="stepper" x-show="step < 4">
                        <!-- Step 1 -->
                        <div class="stepper-step">
                            <div class="stepper-dot"
                                 :class="{ active: step === 1, completed: step > 1 }">
                                <template x-if="step > 1">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" width="14" height="14">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                </template>
                                <template x-if="step <= 1">
                                    <span>1</span>
                                </template>
                            </div>
                            <span class="stepper-label"
                                  :class="{ active: step === 1, completed: step > 1 }">Scan</span>
                        </div>

                        <div class="stepper-line" :class="{ completed: step > 1 }"></div>

                        <!-- Step 2 -->
                        <div class="stepper-step">
                            <div class="stepper-dot"
                                 :class="{ active: step === 2, completed: step > 2 }">
                                <template x-if="step > 2">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" width="14" height="14">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                </template>
                                <template x-if="step <= 2">
                                    <span>2</span>
                                </template>
                            </div>
                            <span class="stepper-label"
                                  :class="{ active: step === 2, completed: step > 2 }">Verify</span>
                        </div>

                        <div class="stepper-line" :class="{ completed: step > 2 }"></div>

                        <!-- Step 3 -->
                        <div class="stepper-step">
                            <div class="stepper-dot"
                                 :class="{ active: step === 3, completed: step > 3 }">
                                <template x-if="step > 3">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" width="14" height="14">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                </template>
                                <template x-if="step <= 3">
                                    <span>3</span>
                                </template>
                            </div>
                            <span class="stepper-label"
                                  :class="{ active: step === 3, completed: step > 3 }">Backup</span>
                        </div>
                    </div>

                    <!-- Error Alert -->
                    <div class="alert alert-error" x-show="error" x-cloak>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        <span x-text="error"></span>
                    </div>

                    <!-- ═══════════════════════════════════════ -->
                    <!-- STEP 1: Scan QR Code                   -->
                    <!-- ═══════════════════════════════════════ -->
                    <div x-show="step === 1">
                        <div class="instructions">
                            <p class="instructions-title">Setup instructions</p>
                            <ol>
                                <li>Download an authenticator app (Google Authenticator, Authy, or 1Password).</li>
                                <li>Scan the QR code below with your authenticator app.</li>
                                <li>If you cannot scan, enter the secret key manually.</li>
                            </ol>
                        </div>

                        <div class="qr-container">
                            <div class="qr-frame">
                                <!-- Loading state -->
                                <div class="qr-placeholder" x-show="loadingSetup">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                                    </svg>
                                </div>
                                <!-- QR image via Google Charts API from otpauth URI -->
                                <img x-show="qrUri && !loadingSetup"
                                     :src="'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(qrUri)"
                                     alt="Scan this QR code with your authenticator app"
                                     width="200"
                                     height="200">
                            </div>
                        </div>

                        <!-- Secret key fallback -->
                        <div class="secret-fallback" x-show="secret && !loadingSetup">
                            <p class="secret-fallback-label">Or enter this key manually:</p>
                            <div class="secret-key-box">
                                <span class="secret-key-value" x-text="secret"></span>
                                <button type="button"
                                        class="btn-copy-inline"
                                        @click="copyToClipboard(secret, 'Secret key copied')"
                                        title="Copy secret key">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <button type="button"
                                class="btn-submit"
                                :disabled="loadingSetup || !qrUri"
                                @click="step = 2; error = ''">
                            <span>Continue to Verification</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"/>
                                <polyline points="12 5 19 12 12 19"/>
                            </svg>
                        </button>
                    </div>

                    <!-- ═══════════════════════════════════════ -->
                    <!-- STEP 2: Verify TOTP Code                -->
                    <!-- ═══════════════════════════════════════ -->
                    <div x-show="step === 2">
                        <div class="alert alert-info" style="margin-bottom: var(--space-6);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="16" x2="12" y2="12"/>
                                <line x1="12" y1="8" x2="12.01" y2="8"/>
                            </svg>
                            <span>Enter the 6-digit code shown in your authenticator app to verify setup.</span>
                        </div>

                        <form @submit.prevent="verifyCode">
                            <div class="form-group">
                                <label class="form-label" for="totp-code">Verification Code</label>
                                <input type="text"
                                       id="totp-code"
                                       class="form-input code-input"
                                       x-model="totpCode"
                                       @input="handleCodeInput($event)"
                                       placeholder="000000"
                                       maxlength="6"
                                       inputmode="numeric"
                                       pattern="[0-9]{6}"
                                       autocomplete="one-time-code"
                                       required
                                       :disabled="loadingVerify">
                                <p class="form-hint">The code refreshes every 30 seconds.</p>
                            </div>

                            <button type="submit"
                                    class="btn-submit"
                                    :disabled="totpCode.length !== 6 || loadingVerify">
                                <template x-if="loadingVerify">
                                    <div class="btn-spinner"></div>
                                </template>
                                <template x-if="!loadingVerify">
                                    <span>Verify and Enable</span>
                                </template>
                            </button>
                        </form>

                        <div style="margin-top: var(--space-4); text-align: center;">
                            <button type="button"
                                    style="background: none; border: none; color: var(--primary); font-size: 0.9rem; font-weight: var(--font-medium); cursor: pointer; font-family: inherit; padding: var(--space-1) var(--space-2);"
                                    @click="step = 1; error = ''; totpCode = ''">
                                &larr; Back to QR code
                            </button>
                        </div>
                    </div>

                    <!-- ═══════════════════════════════════════ -->
                    <!-- STEP 3: Backup Codes                    -->
                    <!-- ═══════════════════════════════════════ -->
                    <div x-show="step === 3">
                        <div class="backup-warning">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                <line x1="12" y1="9" x2="12" y2="13"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            <div>
                                <strong>Save these backup codes now.</strong>
                                Each code can only be used once. Store them in a safe place -- you will not be able to see them again.
                            </div>
                        </div>

                        <div class="backup-codes-grid">
                            <template x-for="(code, index) in backupCodes" :key="index">
                                <div class="backup-code" x-text="code"></div>
                            </template>
                        </div>

                        <div class="btn-group">
                            <button type="button"
                                    class="btn-secondary"
                                    @click="copyBackupCodes">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                </svg>
                                Copy
                            </button>
                            <button type="button"
                                    class="btn-secondary"
                                    @click="downloadBackupCodes">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                Download
                            </button>
                        </div>

                        <button type="button"
                                class="btn-submit"
                                style="margin-top: var(--space-4);"
                                @click="step = 4">
                            <span>I've Saved My Codes</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </button>
                    </div>

                    <!-- ═══════════════════════════════════════ -->
                    <!-- STEP 4: Done / Success                  -->
                    <!-- ═══════════════════════════════════════ -->
                    <div x-show="step === 4" style="text-align: center;">
                        <div class="success-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                        </div>

                        <div class="alert alert-success" style="justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                            </svg>
                            <span>Two-factor authentication is now active on your account.</span>
                        </div>

                        <p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: var(--space-6); line-height: var(--leading-normal);">
                            You will be asked for a verification code from your authenticator app each time you sign in.
                        </p>

                        <a href="/advisor"
                           class="btn-submit"
                           style="text-decoration: none; display: inline-flex; width: 100%;">
                            Go to Dashboard
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"/>
                                <polyline points="12 5 19 12 12 19"/>
                            </svg>
                        </a>

                        <div style="margin-top: var(--space-3);">
                            <a href="/settings"
                               style="font-size: 0.9rem; color: var(--primary); text-decoration: none; font-weight: var(--font-medium);">
                                Return to Settings
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trust Bar -->
            <div class="trust-bar">
                <div class="trust-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    256-bit Encryption
                </div>
                <div class="trust-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    TOTP Standard (RFC 6238)
                </div>
            </div>
        </div>

        <!-- Clipboard Toast -->
        <div class="toast" :class="{ visible: toastVisible }" x-text="toastMessage"></div>
    </main>

    <script>
        function mfaSetup() {
            return {
                /* ── State ── */
                step: 1,
                qrUri: '',
                secret: '',
                totpCode: '',
                backupCodes: [],
                error: '',
                loadingSetup: false,
                loadingVerify: false,
                toastVisible: false,
                toastMessage: '',

                /* ── Computed-like getters ── */
                get stepTitle() {
                    switch (this.step) {
                        case 1: return 'Scan QR Code';
                        case 2: return 'Verify Setup';
                        case 3: return 'Save Backup Codes';
                        case 4: return 'You\'re All Set';
                        default: return '';
                    }
                },

                get stepSubtitle() {
                    switch (this.step) {
                        case 1: return 'Use your authenticator app to scan the code below.';
                        case 2: return 'Enter the code from your authenticator app to confirm it\'s working.';
                        case 3: return 'These one-time codes let you sign in if you lose access to your authenticator.';
                        case 4: return 'Your account is now protected with two-factor authentication.';
                        default: return '';
                    }
                },

                /* ── Lifecycle ── */
                init() {
                    this.checkExistingMfa();
                },

                /* ── API helpers ── */
                getAuthHeaders() {
                    const headers = {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    };

                    // Include auth token if present
                    const token = localStorage.getItem('auth_token');
                    if (token) {
                        headers['Authorization'] = 'Bearer ' + token;
                    }

                    // Include CSRF token if present
                    const csrfToken = this.getCookie('csrf_token');
                    if (csrfToken) {
                        headers['X-CSRF-Token'] = csrfToken;
                    }

                    return headers;
                },

                getCookie(name) {
                    const cookies = document.cookie ? document.cookie.split(';') : [];
                    for (const cookie of cookies) {
                        const [key, ...rest] = cookie.trim().split('=');
                        if (key === name) {
                            return decodeURIComponent(rest.join('='));
                        }
                    }
                    return '';
                },

                async apiFetch(url, options = {}) {
                    const response = await fetch(url, {
                        ...options,
                        headers: this.getAuthHeaders()
                    });

                    let data;
                    try {
                        data = await response.json();
                    } catch {
                        throw new Error('Unexpected server response. Please try again.');
                    }

                    if (!response.ok) {
                        throw new Error(
                            data.detail || data.message || data.error || 'Request failed. Please try again.'
                        );
                    }

                    return data;
                },

                /* ── Check if MFA is already enabled ── */
                async checkExistingMfa() {
                    try {
                        const data = await this.apiFetch('/api/mfa/status', { method: 'GET' });
                        if (data.enabled) {
                            // MFA is already active - go straight to success
                            this.step = 4;
                            return;
                        }
                    } catch {
                        // Status check failed; proceed with setup anyway
                    }

                    this.beginSetup();
                },

                /* ── Step 1: Initiate MFA setup ── */
                async beginSetup() {
                    this.loadingSetup = true;
                    this.error = '';

                    try {
                        const data = await this.apiFetch('/api/mfa/setup', { method: 'POST' });

                        this.qrUri = data.qr_uri || data.otpauth_uri || data.uri || '';
                        this.secret = data.secret || data.secret_key || '';

                        if (!this.qrUri && !this.secret) {
                            throw new Error('Setup response did not include QR data. Please contact support.');
                        }
                    } catch (err) {
                        this.error = err.message;
                    } finally {
                        this.loadingSetup = false;
                    }
                },

                /* ── Step 2: Verify TOTP code ── */
                async verifyCode() {
                    if (this.totpCode.length !== 6) return;

                    this.loadingVerify = true;
                    this.error = '';

                    try {
                        const data = await this.apiFetch('/api/mfa/verify-setup', {
                            method: 'POST',
                            body: JSON.stringify({ code: this.totpCode })
                        });

                        // Extract backup codes from response
                        this.backupCodes = data.backup_codes || data.recovery_codes || [];

                        if (this.backupCodes.length > 0) {
                            this.step = 3;
                        } else {
                            // If API didn't return backup codes, try to fetch them
                            await this.fetchBackupCodes();
                            this.step = this.backupCodes.length > 0 ? 3 : 4;
                        }
                    } catch (err) {
                        this.error = err.message;
                        this.totpCode = '';
                    } finally {
                        this.loadingVerify = false;
                    }
                },

                /* ── Fetch/regenerate backup codes ── */
                async fetchBackupCodes() {
                    try {
                        const data = await this.apiFetch('/api/mfa/regenerate-backup-codes', {
                            method: 'POST'
                        });
                        this.backupCodes = data.backup_codes || data.recovery_codes || [];
                    } catch {
                        // Non-critical; user can still proceed
                    }
                },

                /* ── Input handling: digits only ── */
                handleCodeInput(event) {
                    const cleaned = event.target.value.replace(/\D/g, '').slice(0, 6);
                    this.totpCode = cleaned;
                    event.target.value = cleaned;
                },

                /* ── Clipboard ── */
                async copyToClipboard(text, message) {
                    try {
                        await navigator.clipboard.writeText(text);
                        this.showToast(message || 'Copied to clipboard');
                    } catch {
                        // Fallback for older browsers
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        textarea.style.position = 'fixed';
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        this.showToast(message || 'Copied to clipboard');
                    }
                },

                copyBackupCodes() {
                    const text = 'Jorss-Gbo Backup Codes\n'
                        + 'Generated: ' + new Date().toLocaleDateString() + '\n'
                        + '─'.repeat(30) + '\n\n'
                        + this.backupCodes.map((code, i) => (i + 1) + '. ' + code).join('\n')
                        + '\n\nEach code can only be used once.';
                    this.copyToClipboard(text, 'Backup codes copied');
                },

                /* ── Download ── */
                downloadBackupCodes() {
                    const text = 'Jorss-Gbo - Two-Factor Authentication Backup Codes\n'
                        + 'Generated: ' + new Date().toISOString() + '\n'
                        + '================================================\n\n'
                        + this.backupCodes.map((code, i) => (i + 1) + '.  ' + code).join('\n')
                        + '\n\n'
                        + 'IMPORTANT:\n'
                        + '- Each code can only be used once.\n'
                        + '- Store these codes in a secure location.\n'
                        + '- Use a backup code if you lose access to your authenticator app.\n';

                    const blob = new Blob([text], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'jorss-gbo-backup-codes.txt';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    this.showToast('Backup codes downloaded');
                },

                /* ── Toast notification ── */
                showToast(message) {
                    this.toastMessage = message;
                    this.toastVisible = true;
                    setTimeout(() => {
                        this.toastVisible = false;
                    }, 2500);
                }
            };
        }
    </script>
</body>
</html>
