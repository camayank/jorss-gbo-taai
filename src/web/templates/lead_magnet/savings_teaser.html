{% from 'macros/icons.html' import icon %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Tax Savings Estimate | {{ cpa.firm_name or cpa.display_name }}</title>
    <meta name="description" content="See your potential tax savings and get your personalized analysis.">
    {% if cpa.favicon_url %}
    <link rel="icon" href="{{ cpa.favicon_url }}">
    {% endif %}
    <link rel="stylesheet" href="/static/css/core/variables.css">
    <link rel="stylesheet" href="/static/css/core/reset.css">
    <link rel="stylesheet" href="/static/css/core/typography.css">
    <link rel="stylesheet" href="/static/css/unified-theme.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: {{ cpa.primary_color or '#1e3a5f' }};
            --secondary-color: {{ cpa.secondary_color or '#152b47' }};
            --accent-color: {{ cpa.accent_color or '#10b981' }};
            --text-dark: var(--color-gray-800);
            --text-muted: var(--color-gray-500);
            --bg-light: var(--color-gray-50);
            --white: var(--white);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            padding: var(--space-5);
        }

        .container {
            max-width: 650px;
            margin: 0 auto;
        }

        /* Results Card */
        .results-card {
            background: var(--white);
            border-radius: 24px;
            padding: 50px var(--space-10);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .cpa-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
            margin-bottom: 30px;
        }

        .cpa-logo {
            width: 45px;
            height: 45px;
            border-radius: 10px;
        }

        .cpa-info {
            text-align: left;
        }

        .cpa-name {
            font-weight: var(--font-semibold);
            color: var(--text-dark);
        }

        .cpa-firm {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Success Icon */
        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--color-success-600) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-6);
            animation: scaleIn var(--transition-slower);
        }

        @keyframes scaleIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .success-icon svg {
            width: 40px;
            height: 40px;
            color: white;
        }

        /* Savings Display */
        .savings-section {
            margin-bottom: 30px;
        }

        .savings-label {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: var(--space-2);
        }

        .savings-amount {
            font-size: 3.5rem;
            font-weight: var(--font-bold);
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--color-success-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-2);
            animation: fadeIn var(--transition-slower) 0.2s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .savings-note {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .score-card {
            margin: 18px auto var(--space-6);
            max-width: 420px;
            border: 1px solid var(--color-gray-200);
            border-radius: 14px;
            padding: var(--space-3-5) var(--space-4);
            background: var(--color-gray-50);
        }

        .score-title {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--color-slate-500);
            margin-bottom: var(--space-2);
        }

        .score-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--color-slate-900);
            line-height: 1;
            margin-bottom: var(--space-1-5);
        }

        .score-visual-wrap {
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-2);
        }

        .score-ring-visual {
            position: relative;
            width: 176px;
            height: 176px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .score-ring-visual svg {
            width: 176px;
            height: 176px;
            transform: rotate(-90deg);
        }

        .score-ring-track {
            stroke: var(--color-info-100);
            stroke-width: 12;
            fill: none;
        }

        .score-ring-progress {
            stroke: var(--color-success-500);
            stroke-width: 12;
            fill: none;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.6s ease;
        }

        .score-ring-center {
            position: absolute;
            text-align: center;
            line-height: 1.1;
        }

        .score-ring-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--color-slate-900);
        }

        .score-ring-scale {
            font-size: 0.75rem;
            color: var(--color-slate-600);
        }

        .score-gauge-visual {
            width: min(320px, 100%);
            display: none;
            text-align: left;
            margin: var(--space-1) auto 0;
        }

        .score-gauge-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--color-slate-500);
            margin-bottom: var(--space-1);
        }

        .score-gauge-track {
            width: 100%;
            height: 16px;
            border-radius: 999px;
            overflow: hidden;
            background: linear-gradient(90deg, var(--color-error-500) 0%, #f97316 35%, #84cc16 68%, #16a34a 100%);
            position: relative;
        }

        .score-gauge-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(15, 23, 42, 0.22);
        }

        .score-gauge-value {
            margin-top: var(--space-2);
            font-weight: var(--font-bold);
            font-size: 0.95rem;
            color: var(--color-slate-900);
            text-align: center;
        }

        .score-band {
            display: inline-block;
            border-radius: 999px;
            font-size: 0.72rem;
            font-weight: var(--font-bold);
            padding: var(--space-1) var(--space-2-5);
            margin-bottom: var(--space-2);
            border: 1px solid var(--color-slate-300);
            color: var(--color-slate-700);
            background: #eef2ff;
        }

        .score-context {
            font-size: 0.82rem;
            color: var(--color-slate-600);
        }

        .score-subscores {
            margin-top: var(--space-2-5);
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            justify-content: center;
        }

        .subscore-chip {
            border: 1px solid var(--color-slate-300);
            background: var(--white);
            color: var(--color-slate-700);
            border-radius: 999px;
            padding: var(--space-1-5) var(--space-2-5);
            font-size: 0.74rem;
            font-weight: var(--font-semibold);
            cursor: pointer;
        }

        .subscore-chip:hover {
            border-color: #2563eb;
            color: var(--color-info-700);
        }

        .personalization-line {
            margin: 0 auto var(--space-5);
            max-width: 520px;
            padding: var(--space-2-5) var(--space-3-5);
            border-radius: 10px;
            background: #eef2ff;
            color: #3730a3;
            font-size: 0.83rem;
            text-align: left;
        }

        .comparison-card {
            margin: 0 auto 26px;
            max-width: 520px;
            background: var(--color-gray-50);
            border: 1px solid var(--color-slate-200);
            border-radius: 14px;
            padding: var(--space-3-5) var(--space-4);
            text-align: left;
        }

        .comparison-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--color-slate-500);
            margin-bottom: var(--space-2-5);
        }

        .comparison-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: var(--space-2-5);
            align-items: center;
            margin-bottom: var(--space-2);
            font-size: 0.84rem;
            color: var(--color-slate-700);
        }

        .comparison-track {
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: var(--color-info-100);
            overflow: hidden;
        }

        .comparison-fill {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(135deg, #2563eb, var(--color-success-500));
        }

        /* Complexity Badge */
        .complexity-badge {
            display: inline-block;
            padding: var(--space-2) var(--space-5);
            border-radius: 20px;
            font-weight: var(--font-semibold);
            font-size: 0.9rem;
            margin-bottom: var(--space-6);
        }

        .complexity-low {
            background: #dcfce7;
            color: var(--color-success-700);
        }

        .complexity-moderate {
            background: #fef9c3;
            color: #854d0e;
        }

        .complexity-high {
            background: var(--color-error-100);
            color: var(--color-error-800);
        }

        /* Insights Preview */
        .insights-preview {
            background: var(--bg-light);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            margin-bottom: 30px;
            text-align: left;
        }

        .insights-title {
            font-weight: var(--font-semibold);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .insights-count {
            background: var(--primary-color);
            color: white;
            font-size: 0.75rem;
            padding: 2px var(--space-2);
            border-radius: 10px;
        }

        .content-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1-5);
            font-size: 0.72rem;
            font-weight: var(--font-bold);
            letter-spacing: 0.05em;
            text-transform: uppercase;
            border-radius: 999px;
            padding: var(--space-1) var(--space-2-5);
            margin-bottom: var(--space-2-5);
        }

        .content-badge.free {
            background: #dcfce7;
            color: var(--color-success-700);
        }

        .content-badge.locked {
            background: var(--color-warning-100);
            color: var(--color-warning-800);
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-3) 0;
            border-bottom: 1px solid var(--color-gray-200);
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-icon {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
        }

        .insight-content {
            flex: 1;
        }

        .insight-title {
            font-weight: var(--font-semibold);
            margin-bottom: var(--space-1);
        }

        .insight-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Locked Insights Teaser */
        .locked-insights {
            background: var(--color-warning-100);
            border: 2px dashed var(--color-warning-500);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            margin-bottom: 30px;
            text-align: center;
        }

        .locked-icon {
            font-size: 2rem;
            margin-bottom: var(--space-2-5);
        }

        .locked-title {
            font-weight: var(--font-semibold);
            color: var(--color-warning-800);
            margin-bottom: var(--space-1-5);
        }

        .locked-desc {
            font-size: 0.9rem;
            color: #a16207;
        }

        .locked-strategy-list {
            margin-top: var(--space-3);
            display: grid;
            gap: var(--space-2);
        }

        .locked-strategy-item {
            border-radius: var(--radius-lg);
            border: 1px dashed rgba(146, 64, 14, 0.45);
            padding: var(--space-2) var(--space-2-5);
            font-size: 0.78rem;
            color: rgba(146, 64, 14, 0.9);
            filter: blur(2.2px);
            user-select: none;
        }

        body.gate-hard .insight-desc {
            filter: blur(1.8px);
            user-select: none;
        }

        body.gate-hard .locked-strategy-item {
            filter: blur(3px);
        }

        /* CTA Section */
        .cta-section {
            margin-bottom: var(--space-5);
        }

        .cta-title {
            font-size: 1.1rem;
            font-weight: var(--font-semibold);
            margin-bottom: var(--space-4);
        }

        .cta-button {
            display: inline-block;
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 18px var(--space-10);
            border-radius: var(--radius-xl);
            text-decoration: none;
            font-size: 1.1rem;
            font-weight: var(--font-semibold);
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.35);
        }

        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(37, 99, 235, 0.45);
        }

        .cta-subtext {
            margin-top: var(--space-3);
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Trust Indicators */
        .trust-indicators {
            display: flex;
            justify-content: center;
            gap: var(--space-6);
            flex-wrap: wrap;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--color-gray-200);
        }

        .trust-item {
            display: flex;
            align-items: center;
            gap: var(--space-1-5);
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .trust-item svg {
            width: 16px;
            height: 16px;
            color: var(--accent-color);
        }

        /* Disclaimer */
        .disclaimer {
            margin-top: var(--space-6);
            padding: var(--space-3-5) 18px;
            background: var(--color-gray-100);
            border-radius: 10px;
            font-size: 0.75rem;
            color: var(--color-gray-500);
            text-align: left;
            border-left: 3px solid var(--color-gray-300);
        }

        .disclaimer strong {
            color: var(--color-gray-700);
        }

        /* Mobile Responsive */
        @media (max-width: 640px) {
            .results-card {
                padding: 30px var(--space-5);
            }

            .savings-amount {
                font-size: 2.5rem;
            }

            .score-ring-visual {
                width: 168px;
                height: 168px;
            }

            .score-ring-visual svg {
                width: 168px;
                height: 168px;
            }

            .cpa-header {
                flex-direction: column;
            }

            .cpa-info {
                text-align: center;
            }

            .trust-indicators {
                flex-direction: column;
                gap: var(--space-3);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="results-card">
            <!-- CPA Header -->
            <div class="cpa-header">
                {% if cpa.logo_url %}
                <img src="{{ cpa.logo_url }}" alt="{{ cpa.firm_name }}" class="cpa-logo">
                {% endif %}
                <div class="cpa-info">
                    <div class="cpa-name">{{ cpa.display_name }}</div>
                    {% if cpa.firm_name %}
                    <div class="cpa-firm">{{ cpa.firm_name }}</div>
                    {% endif %}
                </div>
            </div>

            <!-- Success Icon -->
            <div class="success-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
            </div>

            <!-- Savings Display -->
            <div class="savings-section">
                <div class="savings-label" id="savingsLabel">Potential IRS Overpayment Detected</div>
                <div class="savings-amount" id="savingsAmount">$1,500 - $4,200</div>
                <div class="savings-note" id="savingsNote">Most taxpayers miss this before a CPA review</div>
            </div>

            <div class="score-card">
                <div class="score-title">Your Tax Health Score</div>
                <div class="score-visual-wrap">
                    <div class="score-ring-visual" id="scoreRingVisual">
                        <svg viewBox="0 0 176 176" aria-hidden="true">
                            <circle class="score-ring-track" cx="88" cy="88" r="70"></circle>
                            <circle class="score-ring-progress" id="scoreRingProgress" cx="88" cy="88" r="70"></circle>
                        </svg>
                        <div class="score-ring-center">
                            <div class="score-ring-number"><span id="taxHealthScore">58</span></div>
                            <div class="score-ring-scale">/100</div>
                        </div>
                    </div>
                    <div class="score-gauge-visual" id="scoreGaugeVisual">
                        <div class="score-gauge-labels">
                            <span>0</span>
                            <span>50</span>
                            <span>100</span>
                        </div>
                        <div class="score-gauge-track">
                            <div class="score-gauge-fill" id="scoreGaugeFill" style="width: 42%;"></div>
                        </div>
                        <div class="score-gauge-value"><span id="scoreGaugeValue">58</span>/100</div>
                    </div>
                </div>
                <div class="score-band" id="scoreBand">Needs Attention</div>
                <div class="score-context">
                    This reflects how optimized your current tax setup appears from initial answers.
                </div>
                <div class="score-subscores" id="scoreSubscores"></div>
            </div>

            <div class="personalization-line" id="personalizationLine">
                We are tailoring this estimate to your filing profile and state-level tax rules.
            </div>

            <div class="comparison-card">
                <div class="comparison-title">Current vs Optimized Tax Path</div>
                <div class="comparison-row">
                    <span>Current path</span>
                    <strong id="comparisonCurrent">$6,200</strong>
                </div>
                <div class="comparison-track"><div class="comparison-fill" id="comparisonCurrentFill" style="width: 100%;"></div></div>
                <div class="comparison-row" style="margin-top: 10px;">
                    <span>Optimized path</span>
                    <strong id="comparisonOptimized">$3,900</strong>
                </div>
                <div class="comparison-track"><div class="comparison-fill" id="comparisonOptimizedFill" style="width: 63%;"></div></div>
            </div>

            <!-- Complexity Badge -->
            <div class="complexity-badge complexity-moderate" id="complexityBadge">
                Moderate Complexity
            </div>

            <!-- Insights Preview -->
            <div class="insights-preview">
                <div class="content-badge free">Free Preview Unlocked</div>
                <div class="insights-title">
                    Tax Insights Found
                    <span class="insights-count" id="insightsCount">3</span>
                </div>

                <div id="insightsList">
                    <div class="insight-item">
                        <div class="insight-icon">{{ icon('banknotes') }}</div>
                        <div class="insight-content">
                            <div class="insight-title">Retirement Savings Opportunity</div>
                            <div class="insight-desc">Maximize tax-deferred contributions...</div>
                        </div>
                    </div>

                    <div class="insight-item">
                        <div class="insight-icon">{{ icon('home') }}</div>
                        <div class="insight-content">
                            <div class="insight-title">Home-Related Deductions</div>
                            <div class="insight-desc">Mortgage interest and property tax...</div>
                        </div>
                    </div>

                    <div class="insight-item">
                        <div class="insight-icon">ðŸ‘¶</div>
                        <div class="insight-content">
                            <div class="insight-title">Family Tax Credits</div>
                            <div class="insight-desc">Child tax credit optimization...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Locked Insights Teaser -->
            <div class="locked-insights">
                <div class="content-badge locked">Locked Until Contact</div>
                <div class="locked-icon">{{ icon('lock-closed') }}</div>
                <div class="locked-title" id="lockedTitle">+5 More Insights Available</div>
                <div class="locked-desc">
                    Enter your contact info to unlock your complete personalized analysis
                </div>
                <div class="locked-strategy-list" id="lockedStrategyList"></div>
            </div>

            <!-- CTA Section -->
            <div class="cta-section">
                <div class="cta-title" id="teaserCtaTitle">Get Your Full Tax Analysis</div>
                <button onclick="proceedToContact()" class="cta-button" id="teaserCtaButton">
                    Unlock My Full Report
                </button>
                <div class="cta-subtext">
                    Free. Takes 30 seconds. No obligations.
                </div>
            </div>

            <!-- Trust Indicators -->
            <div class="trust-indicators">
                <div class="trust-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    <span>256-bit Encryption</span>
                </div>
                <div class="trust-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0110 0v4"/>
                    </svg>
                    <span>Data Never Sold</span>
                </div>
                <div class="trust-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9 12l2 2 4-4"/>
                    </svg>
                    <span>Licensed CPA</span>
                </div>
            </div>

            <!-- Disclaimer -->
            <div class="disclaimer">
                <strong>Important Disclosure:</strong> This savings estimate is based on the limited
                information provided and general tax principles. Actual savings may vary significantly
                based on your complete financial situation. This estimate does not constitute tax advice.
                For personalized advice tailored to your circumstances, please consult with
                {{ cpa.display_name }} or a qualified tax professional. No CPA-client relationship is
                established until you sign an engagement letter.
            </div>
        </div>
    </div>

    <script src="/static/js/lead_magnet_analytics.js"></script>
    <script>
        const sessionId = window.LeadMagnetAnalytics
            ? window.LeadMagnetAnalytics.getSessionId('{{ session_id }}')
            : ('{{ session_id }}' || sessionStorage.getItem('assessment_session_id'));
        const heroVariant = window.LeadMagnetAnalytics
            ? window.LeadMagnetAnalytics.resolveVariant('{{ variant_id or "A" }}')
            : (sessionStorage.getItem('lm_variant_hero') || '{{ variant_id or "A" }}');
        const experimentConfig = window.LeadMagnetAnalytics
            ? window.LeadMagnetAnalytics.getExperimentConfig(heroVariant)
            : {
                variant_id: heroVariant,
                phone_capture_variant: 'optional',
                gate_aggressiveness: 'soft',
                score_visualization: 'donut',
                teaser_cta: 'unlock_report'
            };
        const previewInsightsTarget = experimentConfig.gate_aggressiveness === 'hard' ? 2 : 3;
        sessionStorage.setItem('lm_experiment_config', JSON.stringify(experimentConfig));
        let complexity = sessionStorage.getItem('tax_complexity') || 'moderate';
        let insightsPreview = parseInt(sessionStorage.getItem('insights_preview') || '3', 10);
        let scorePreview = parseInt(sessionStorage.getItem('tax_health_score') || '58', 10);
        let scoreBand = sessionStorage.getItem('tax_health_band') || 'Needs Attention';
        let proceededToContact = false;

        function trackLeadMagnetEvent(eventName, step, metadata = {}) {
            if (!sessionId || !window.LeadMagnetAnalytics) return;
            window.LeadMagnetAnalytics.trackEvent(
                sessionId,
                eventName,
                step,
                metadata,
                { defaultVariant: heroVariant }
            );
        }

        function applyVariantPresentation() {
            const scoreMode = experimentConfig.score_visualization || 'donut';
            const ringVisual = document.getElementById('scoreRingVisual');
            const gaugeVisual = document.getElementById('scoreGaugeVisual');
            const ctaTitle = document.getElementById('teaserCtaTitle');
            const ctaButton = document.getElementById('teaserCtaButton');

            if (ringVisual && gaugeVisual) {
                if (scoreMode === 'gauge') {
                    ringVisual.style.display = 'none';
                    gaugeVisual.style.display = 'block';
                } else {
                    ringVisual.style.display = 'inline-flex';
                    gaugeVisual.style.display = 'none';
                }
            }

            const unlockMode = experimentConfig.teaser_cta === 'unlock_report';
            if (ctaTitle) {
                ctaTitle.textContent = unlockMode ? 'Get Your Full Tax Analysis' : 'Get My Free Analysis';
            }
            if (ctaButton) {
                ctaButton.textContent = unlockMode ? 'Unlock My Full Report' : 'Get My Free Analysis';
            }

            document.body.classList.toggle('gate-hard', experimentConfig.gate_aggressiveness === 'hard');
        }

        function parseRange(rangeText) {
            if (!rangeText) return [1500, 4200];
            const numbers = rangeText.match(/\d[\d,]*/g) || [];
            if (numbers.length < 2) return [1500, 4200];
            return numbers.slice(0, 2).map(num => parseInt(num.replace(/,/g, ''), 10));
        }

        function updateComplexityBadge() {
            const badge = document.getElementById('complexityBadge');
            const complexityMap = {
                simple: { text: 'Simple Return', className: 'complexity-low' },
                moderate: { text: 'Moderate Complexity', className: 'complexity-moderate' },
                complex: { text: 'Complex Situation', className: 'complexity-high' },
                professional: { text: 'Professional Complexity', className: 'complexity-high' }
            };
            const config = complexityMap[(complexity || '').toLowerCase()] || complexityMap.moderate;
            badge.textContent = config.text;
            badge.className = `complexity-badge ${config.className}`;
        }

        function updateSavingsEstimate(rangeText) {
            const savingsElement = document.getElementById('savingsAmount');
            const providedRange = rangeText || sessionStorage.getItem('missed_savings_range');
            if (providedRange) {
                savingsElement.textContent = providedRange;
                return;
            }
            const fallback = {
                simple: '$500 - $1,500',
                moderate: '$1,500 - $4,200',
                complex: '$3,500 - $12,000+',
                professional: '$8,500 - $24,000+'
            };
            savingsElement.textContent = fallback[(complexity || '').toLowerCase()] || fallback.moderate;
        }

        function updateTaxHealthScore() {
            const scoreNode = document.getElementById('taxHealthScore');
            const gaugeNode = document.getElementById('scoreGaugeValue');
            const bandNode = document.getElementById('scoreBand');
            const safeScore = Number.isFinite(scorePreview) ? Math.max(0, Math.min(100, scorePreview)) : 58;
            scoreNode.textContent = safeScore;
            if (gaugeNode) gaugeNode.textContent = safeScore;
            bandNode.textContent = scoreBand;

            const circumference = 2 * Math.PI * 70;
            const ring = document.getElementById('scoreRingProgress');
            if (ring) {
                ring.style.strokeDasharray = `${circumference}`;
                const offset = circumference - (safeScore / 100) * circumference;
                ring.style.strokeDashoffset = `${offset}`;
                ring.style.stroke = safeScore >= 81 ? '#16a34a' : (safeScore >= 61 ? '#84cc16' : (safeScore >= 41 ? '#f97316' : '#dc2626'));
            }
            const gaugeFill = document.getElementById('scoreGaugeFill');
            if (gaugeFill) {
                gaugeFill.style.width = `${Math.max(0, Math.min(100, safeScore))}%`;
            }
        }

        function updateProfileAwareMessaging(tokens) {
            const labelNode = document.getElementById('savingsLabel');
            const noteNode = document.getElementById('savingsNote');
            if (!labelNode || !noteNode) return;

            const persistedState = sessionStorage.getItem('lm_state_code');
            const persistedOccupation = sessionStorage.getItem('lm_occupation_type');
            const stateCode = (tokens && tokens.state_code) || persistedState || 'US';
            const occupationType = (tokens && tokens.occupation_type) || persistedOccupation || 'w2';
            const filingStatus = ((tokens && (tokens.filing_status_label || tokens.filing_status)) || 'your filing profile').replace(/_/g, ' ');

            const occupationMap = {
                w2: 'W-2 earners',
                self_employed: 'self-employed filers',
                freelancer: 'freelancers',
                business_owner: 'business owners',
                investor: 'investors',
                retired: 'retirees'
            };
            const audience = occupationMap[occupationType] || 'taxpayers';
            const stateText = stateCode !== 'US' ? stateCode : 'your state';

            labelNode.textContent = `For ${audience} in ${stateText}, overpayment risk is often hidden.`;
            noteNode.textContent = `Using ${filingStatus} assumptions, this range highlights likely strategy gaps before a CPA review.`;
        }

        function renderSubscores(subscores) {
            const container = document.getElementById('scoreSubscores');
            if (!container) return;
            const source = subscores && typeof subscores === 'object'
                ? subscores
                : {
                    deduction_optimization: Math.max(30, scorePreview - 8),
                    timing_strategy: Math.max(30, scorePreview - 6),
                    state_tax_efficiency: Math.max(30, scorePreview - 4),
                };
            const items = Object.entries(source).sort((a, b) => Number(a[1]) - Number(b[1])).slice(0, 3);
            container.innerHTML = items.map(([key, value]) => {
                const label = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                return `<button type="button" class="subscore-chip" data-key="${key}" data-value="${value}">${label}: ${value}</button>`;
            }).join('');
            container.querySelectorAll('.subscore-chip').forEach(node => {
                node.addEventListener('click', function () {
                    trackLeadMagnetEvent('step_complete', 'score_interaction', {
                        subscore_click: node.getAttribute('data-key'),
                        subscore_value: Number(node.getAttribute('data-value') || 0),
                        location: 'teaser'
                    });
                });
            });
        }

        function updateInsightsCount(count) {
            const countElement = document.getElementById('insightsCount');
            countElement.textContent = count || insightsPreview;
        }

        function updateComparisonChart(rangeText, chartPayload) {
            if (chartPayload && chartPayload.bars && chartPayload.bars.length >= 2) {
                const current = chartPayload.bars[0].value;
                const optimized = chartPayload.bars[1].value;
                const pct = current > 0 ? Math.round((optimized / current) * 100) : 60;
                document.getElementById('comparisonCurrent').textContent = `$${current.toLocaleString()}`;
                document.getElementById('comparisonOptimized').textContent = `$${optimized.toLocaleString()}`;
                document.getElementById('comparisonCurrentFill').style.width = '100%';
                document.getElementById('comparisonOptimizedFill').style.width = `${Math.max(18, pct)}%`;
                return;
            }

            const [low, high] = parseRange(rangeText);
            const missedMid = Math.round((low + high) / 2);
            const current = Math.max(1800, Math.round(missedMid * 2.2));
            const optimized = Math.max(500, current - missedMid);
            const pct = Math.round((optimized / current) * 100);
            document.getElementById('comparisonCurrent').textContent = `$${current.toLocaleString()}`;
            document.getElementById('comparisonOptimized').textContent = `$${optimized.toLocaleString()}`;
            document.getElementById('comparisonCurrentFill').style.width = '100%';
            document.getElementById('comparisonOptimizedFill').style.width = `${Math.max(18, pct)}%`;
        }

        function renderInsights(insights) {
            if (!Array.isArray(insights) || insights.length === 0) return;
            const list = document.getElementById('insightsList');
            const visible = insights.slice(0, previewInsightsTarget);
            list.innerHTML = visible.map(insight => `
                <div class="insight-item">
                    <div class="insight-icon">{{ icon('sparkles') }}</div>
                    <div class="insight-content">
                        <div class="insight-title">${insight.title || 'Tax Optimization Insight'}</div>
                        <div class="insight-desc">${insight.description || 'Additional tax strategy available for your profile.'}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderLockedStrategies(lockedTitles, lockedCount) {
            const lockedTitle = document.getElementById('lockedTitle');
            const lockedList = document.getElementById('lockedStrategyList');
            const gateOffset = experimentConfig.gate_aggressiveness === 'hard' ? 2 : 3;
            const resolvedLockedCount = Math.max(0, Number(lockedCount || 0));
            if (lockedTitle) {
                lockedTitle.textContent = `+${resolvedLockedCount || 5} More Insights Available`;
            }
            if (!lockedList) return;
            const items = (lockedTitles || []).slice(0, experimentConfig.gate_aggressiveness === 'hard' ? 5 : 4);
            if (items.length === 0) {
                lockedList.innerHTML = `
                    <div class="locked-strategy-item">Entity structure optimization</div>
                    <div class="locked-strategy-item">Income timing sequence</div>
                    <div class="locked-strategy-item">State tax efficiency playbook</div>
                    ${gateOffset === 2 ? '<div class="locked-strategy-item">Deadline-driven deduction stack</div>' : ''}
                `;
                return;
            }
            lockedList.innerHTML = items.map(title => `<div class="locked-strategy-item">${title}</div>`).join('');
        }

        async function hydrateFromReport() {
            try {
                const response = await fetch(`/api/cpa/lead-magnet/${sessionId}/report`);
                if (!response.ok) return;
                const report = await response.json();

                if (report.complexity) {
                    complexity = report.complexity;
                    sessionStorage.setItem('tax_complexity', complexity);
                }
                if (report.savings_range) {
                    updateSavingsEstimate(report.savings_range);
                    sessionStorage.setItem('missed_savings_range', report.savings_range);
                }
                if (report.tax_health_score) {
                    scorePreview = report.tax_health_score.overall || scorePreview;
                    scoreBand = report.tax_health_score.band || scoreBand;
                    sessionStorage.setItem('tax_health_score', String(scorePreview));
                    sessionStorage.setItem('tax_health_band', scoreBand);
                    renderSubscores(report.tax_health_score.subscores || null);
                } else {
                    renderSubscores(null);
                }
                if (report.personalization && report.personalization.line) {
                    document.getElementById('personalizationLine').textContent = report.personalization.line;
                    sessionStorage.setItem('personalization_line', report.personalization.line);
                }
                if (report.personalization && report.personalization.tokens) {
                    sessionStorage.setItem('personalization_tokens', JSON.stringify(report.personalization.tokens));
                    updateProfileAwareMessaging(report.personalization.tokens);
                } else {
                    updateProfileAwareMessaging(null);
                }

                const teaserInsights = report.teaser_insights || report.insights || [];
                const lockedTitles = report.locked_strategy_titles || [];
                const totalInsights = Number(report.total_insights || teaserInsights.length || 0);
                const lockedCount = Math.max(0, totalInsights - previewInsightsTarget);
                insightsPreview = Math.min(teaserInsights.length || insightsPreview, previewInsightsTarget);

                updateComplexityBadge();
                updateTaxHealthScore();
                updateInsightsCount(insightsPreview);
                renderInsights(teaserInsights);
                renderLockedStrategies(lockedTitles, lockedCount || report.locked_count || 5);
                updateComparisonChart(report.savings_range, report.comparison_chart || null);

                sessionStorage.setItem('teaser_report_cache', JSON.stringify(report));
                return;
            } catch (error) {
                console.warn('Could not hydrate teaser from report:', error);
            }

            updateComplexityBadge();
            updateSavingsEstimate();
            updateTaxHealthScore();
            renderSubscores(null);
            updateInsightsCount(insightsPreview);
            renderLockedStrategies([], 5);
            let cachedChart = null;
            try {
                cachedChart = JSON.parse(sessionStorage.getItem('comparison_chart') || 'null');
            } catch (_) {}
            updateComparisonChart(sessionStorage.getItem('missed_savings_range'), cachedChart);
            const personalization = sessionStorage.getItem('personalization_line');
            if (personalization) {
                document.getElementById('personalizationLine').textContent = personalization;
            }
            try {
                const storedTokens = JSON.parse(sessionStorage.getItem('personalization_tokens') || 'null');
                updateProfileAwareMessaging(storedTokens);
            } catch (_) {
                updateProfileAwareMessaging(null);
            }
        }

        function proceedToContact() {
            proceededToContact = true;
            trackLeadMagnetEvent('step_complete', 'teaser', {
                complexity: complexity,
                insights_preview: insightsPreview,
                score_preview: scorePreview,
                gate_aggressiveness: experimentConfig.gate_aggressiveness,
                score_visualization: experimentConfig.score_visualization,
                teaser_cta: experimentConfig.teaser_cta,
            });
            window.location.href = `/lead-magnet/contact?session=${sessionId}`;
        }

        document.addEventListener('DOMContentLoaded', async function () {
            if (!sessionId) {
                window.location.href = '/lead-magnet/';
                return;
            }
            applyVariantPresentation();
            await hydrateFromReport();
            trackLeadMagnetEvent('step_complete', 'teaser_view', {
                complexity: complexity,
                score_preview: scorePreview,
                gate_aggressiveness: experimentConfig.gate_aggressiveness,
                score_visualization: experimentConfig.score_visualization,
                teaser_cta: experimentConfig.teaser_cta,
            });
        });

        window.addEventListener('beforeunload', function () {
            if (sessionId && !proceededToContact && window.LeadMagnetAnalytics) {
                window.LeadMagnetAnalytics.sendBeaconEvent(
                    sessionId,
                    'drop_off',
                    'teaser',
                    {
                        complexity: complexity,
                        gate_aggressiveness: experimentConfig.gate_aggressiveness,
                        score_visualization: experimentConfig.score_visualization,
                    },
                    { defaultVariant: heroVariant }
                );
            }
        });
    </script>
</body>
</html>
