{% extends "base_modern.html" %}

{% block title %}Firm Impersonation - {{ config.APP_NAME }}{% endblock %}

{% block extra_css %}
<style>
    .impersonation-page {
        padding: var(--space-6);
        max-width: 1200px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-6);
    }

    .page-title {
        font-size: var(--text-2xl);
        font-weight: var(--font-semibold);
        color: var(--color-gray-900);
    }

    .page-description {
        font-size: var(--text-sm);
        color: var(--color-gray-500);
        margin-top: var(--space-2);
    }

    /* Warning Banner */
    .warning-banner {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        padding: var(--space-4);
        background: var(--color-warning-50);
        border: 1px solid var(--color-warning-200);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-6);
    }

    .warning-icon {
        color: var(--color-warning-600);
        flex-shrink: 0;
    }

    .warning-content {
        flex: 1;
    }

    .warning-title {
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        color: var(--color-warning-800);
        margin-bottom: var(--space-1);
    }

    .warning-text {
        font-size: var(--text-sm);
        color: var(--color-warning-700);
    }

    /* Active Impersonation Banner */
    .active-impersonation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-4) var(--space-6);
        background: var(--color-error-600);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-6);
        color: white;
    }

    .active-info {
        display: flex;
        align-items: center;
        gap: var(--space-4);
    }

    .active-icon {
        width: var(--space-10);

        height: var(--space-10);

        background: rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .active-details {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
    }

    .active-label {
        font-size: var(--text-xs);
        opacity: 0.8;
    }

    .active-firm {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
    }

    .active-meta {
        font-size: var(--text-sm);
        opacity: 0.9;
    }

    .btn-end-session {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-4);
        background: white;
        color: var(--color-error-600);
        border: none;
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-end-session:hover {
        background: var(--color-gray-100);
    }

    /* Search & Filters */
    .filters-bar {
        display: flex;
        gap: var(--space-4);
        margin-bottom: var(--space-6);
        flex-wrap: wrap;
    }

    .search-input {
        flex: 1;
        min-width: 250px;
        padding: var(--space-3) var(--space-4);
        padding-left: var(--space-10);
        border: 1px solid var(--color-gray-300);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='none' stroke='%239ca3af' stroke-width='2' viewBox='0 0 24 24'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='M21 21l-4.35-4.35'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: var(--space-3) center;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--color-primary-500);
        box-shadow: 0 0 0 3px var(--color-primary-100);
    }

    .filter-select {
        padding: var(--space-2-5) var(--space-3);
        border: 1px solid var(--color-gray-300);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        background: white;
        min-width: 160px;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--color-primary-500);
    }

    /* Firms Grid */
    .firms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: var(--space-4);
    }

    .firm-card {
        background: white;
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-gray-200);
        overflow: hidden;
        transition: all 0.2s;
    }

    .firm-card:hover {
        border-color: var(--color-gray-300);
        box-shadow: var(--shadow-md);
    }

    .firm-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: var(--space-4);
        border-bottom: 1px solid var(--color-gray-100);
    }

    .firm-info {
        display: flex;
        gap: var(--space-3);
    }

    .firm-logo {
        width: var(--space-12);

        height: var(--space-12);

        border-radius: var(--radius-md);
        background: var(--color-primary-100);
        color: var(--color-primary-600);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-lg);
        font-weight: var(--font-bold);
    }

    .firm-details {
        display: flex;
        flex-direction: column;
        gap: var(--space-1);
    }

    .firm-name {
        font-size: var(--text-base);
        font-weight: var(--font-semibold);
        color: var(--color-gray-900);
    }

    .firm-id {
        font-size: var(--text-xs);
        color: var(--color-gray-500);
    }

    .firm-status {
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
    }

    .firm-status.active {
        background: var(--color-success-100);
        color: var(--color-success-700);
    }

    .firm-status.inactive {
        background: var(--color-gray-100);
        color: var(--color-gray-600);
    }

    .firm-status.suspended {
        background: var(--color-error-100);
        color: var(--color-error-700);
    }

    .firm-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        padding: var(--space-4);
        background: var(--color-gray-50);
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: var(--text-lg);
        font-weight: var(--font-bold);
        color: var(--color-gray-900);
    }

    .stat-label {
        font-size: var(--text-xs);
        color: var(--color-gray-500);
        margin-top: var(--space-1);
    }

    .firm-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-3) var(--space-4);
        font-size: var(--text-xs);
        color: var(--color-gray-500);
    }

    .firm-plan {
        display: flex;
        align-items: center;
        gap: var(--space-1);
    }

    .plan-badge {
        padding: var(--space-0-5) var(--space-2);
        border-radius: var(--radius-sm);
        font-weight: var(--font-medium);
    }

    .plan-badge.enterprise {
        background: var(--color-purple-100);
        color: var(--color-purple-700);
    }

    .plan-badge.professional {
        background: var(--color-primary-100);
        color: var(--color-primary-700);
    }

    .plan-badge.basic {
        background: var(--color-gray-100);
        color: var(--color-gray-700);
    }

    .firm-actions {
        display: flex;
        gap: var(--space-2);
        padding: var(--space-4);
        border-top: 1px solid var(--color-gray-100);
    }

    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        flex: 1;
    }

    .btn-primary {
        background: var(--color-primary-600);
        color: white;
    }

    .btn-primary:hover {
        background: var(--color-primary-700);
    }

    .btn-secondary {
        background: white;
        color: var(--color-gray-700);
        border: 1px solid var(--color-gray-300);
    }

    .btn-secondary:hover {
        background: var(--color-gray-50);
    }

    /* Impersonation Modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: var(--radius-lg);
        width: 100%;
        max-width: 480px;
        overflow: hidden;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-4) var(--space-6);
        border-bottom: 1px solid var(--color-gray-200);
    }

    .modal-title {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
        color: var(--color-gray-900);
    }

    .modal-close {
        width: var(--space-8);

        height: var(--space-8);

        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-md);
        border: none;
        background: transparent;
        cursor: pointer;
        color: var(--color-gray-500);
        transition: all 0.2s;
    }

    .modal-close:hover {
        background: var(--color-gray-100);
        color: var(--color-gray-900);
    }

    .modal-body {
        padding: var(--space-6);
    }

    .confirm-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto var(--space-4);
        background: var(--color-warning-100);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-warning-600);
    }

    .confirm-title {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
        color: var(--color-gray-900);
        text-align: center;
        margin-bottom: var(--space-2);
    }

    .confirm-text {
        font-size: var(--text-sm);
        color: var(--color-gray-600);
        text-align: center;
        margin-bottom: var(--space-4);
    }

    .confirm-firm {
        background: var(--color-gray-50);
        border-radius: var(--radius-md);
        padding: var(--space-4);
        display: flex;
        align-items: center;
        gap: var(--space-3);
        margin-bottom: var(--space-4);
    }

    .confirm-firm-logo {
        width: var(--space-10);

        height: var(--space-10);

        background: var(--color-primary-100);
        color: var(--color-primary-600);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: var(--font-bold);
    }

    .confirm-firm-name {
        font-weight: var(--font-medium);
        color: var(--color-gray-900);
    }

    .reason-input {
        width: 100%;
        padding: var(--space-3);
        border: 1px solid var(--color-gray-300);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        resize: vertical;
        min-height: 80px;
        font-family: inherit;
    }

    .reason-input:focus {
        outline: none;
        border-color: var(--color-primary-500);
        box-shadow: 0 0 0 3px var(--color-primary-100);
    }

    .reason-label {
        display: block;
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--color-gray-700);
        margin-bottom: var(--space-2);
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--space-3);
        padding: var(--space-4) var(--space-6);
        border-top: 1px solid var(--color-gray-200);
        background: var(--color-gray-50);
    }

    /* Recent Sessions */
    .recent-sessions {
        margin-top: var(--space-8);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-4);
    }

    .section-title {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
        color: var(--color-gray-900);
    }

    .sessions-table {
        background: white;
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-gray-200);
        overflow: hidden;
    }

    .sessions-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .sessions-table th {
        text-align: left;
        padding: var(--space-3) var(--space-4);
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
        color: var(--color-gray-500);
        text-transform: uppercase;
        background: var(--color-gray-50);
        border-bottom: 1px solid var(--color-gray-200);
    }

    .sessions-table td {
        padding: var(--space-3) var(--space-4);
        font-size: var(--text-sm);
        color: var(--color-gray-700);
        border-bottom: 1px solid var(--color-gray-100);
    }

    .sessions-table tr:last-child td {
        border-bottom: none;
    }

    .admin-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-0-5) var(--space-2);
        background: var(--color-purple-100);
        color: var(--color-purple-700);
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .firms-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .impersonation-page {
            padding: var(--space-4);
        }

        .page-header {
            flex-direction: column;
            gap: var(--space-4);
        }

        .filters-bar {
            flex-direction: column;
        }

        .active-impersonation {
            flex-direction: column;
            gap: var(--space-4);
            text-align: center;
        }

        .active-info {
            flex-direction: column;
        }

        .sessions-table {
            overflow-x: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="impersonation-page">
    <div class="page-header">
        <div>
            <h1 class="page-title">Firm Impersonation</h1>
            <p class="page-description">Access partner firm accounts for support and troubleshooting purposes.</p>
        </div>
    </div>

    <!-- Warning Banner -->
    <div class="warning-banner">
        <svg class="warning-icon" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
            <path d="M12 9v4M12 17h.01"/>
        </svg>
        <div class="warning-content">
            <div class="warning-title">Impersonation is logged and audited</div>
            <div class="warning-text">All impersonation sessions are recorded for security and compliance purposes. Only use this feature when necessary for legitimate support reasons.</div>
        </div>
    </div>

    <!-- Active Impersonation Banner (shown when active) -->
    <!--
    <div class="active-impersonation">
        <div class="active-info">
            <div class="active-icon">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </div>
            <div class="active-details">
                <span class="active-label">Currently impersonating</span>
                <span class="active-firm" id="activeFirmName"></span>
                <span class="active-meta">Started 15 minutes ago</span>
            </div>
        </div>
        <button class="btn-end-session">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                <path d="M16 17l5-5-5-5M21 12H9"/>
            </svg>
            End Session
        </button>
    </div>
    -->

    <!-- Search & Filters -->
    <div class="filters-bar">
        <input type="text" class="search-input" placeholder="Search firms by name, ID, or email...">
        <select class="filter-select">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="suspended">Suspended</option>
        </select>
        <select class="filter-select">
            <option value="">All Plans</option>
            <option value="enterprise">Enterprise</option>
            <option value="professional">Professional</option>
            <option value="basic">Basic</option>
        </select>
    </div>

    <!-- Firms Grid â€” populated dynamically from /api/admin/tenants -->
    <div class="firms-grid" id="firms-grid">
        <div class="firm-card" style="text-align: center; padding: 2rem; color: var(--gray-500);">
            Loading firms...
        </div>
    </div>
    <script>
    (async function loadFirms() {
        const grid = document.getElementById('firms-grid');
        try {
            const resp = await fetch('/api/admin/tenants');
            if (!resp.ok) throw new Error('Failed to load tenants');
            const firms = await resp.json();
            if (!firms.length) {
                grid.innerHTML = '<div class="firm-card" style="text-align:center;padding:2rem;color:var(--gray-500);">No firms registered yet.</div>';
                return;
            }
            grid.innerHTML = firms.map(f => {
                const initials = (f.name || 'NA').split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
                return `<div class="firm-card">
                    <div class="firm-header">
                        <div class="firm-info">
                            <div class="firm-logo">${initials}</div>
                            <div class="firm-details">
                                <div class="firm-name">${f.name || 'Unknown Firm'}</div>
                                <div class="firm-id">Firm ID: ${f.id || 'N/A'}</div>
                            </div>
                        </div>
                        <span class="firm-status ${f.status || 'active'}">${f.status || 'Active'}</span>
                    </div>
                    <div class="firm-stats">
                        <div class="stat-item"><div class="stat-value">${f.client_count || 0}</div><div class="stat-label">Clients</div></div>
                        <div class="stat-item"><div class="stat-value">${f.staff_count || 0}</div><div class="stat-label">Staff</div></div>
                        <div class="stat-item"><div class="stat-value">${f.return_count || 0}</div><div class="stat-label">Returns</div></div>
                    </div>
                    <div class="firm-meta">
                        <span>Last login: ${f.last_login || 'N/A'}</span>
                        <div class="firm-plan"><span class="plan-badge ${(f.plan || 'basic').toLowerCase()}">${f.plan || 'Basic'}</span></div>
                    </div>
                    <div class="firm-actions">
                        <button class="btn btn-secondary" onclick="viewFirmDetails('${f.id}')">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            View Details
                        </button>
                        <button class="btn btn-primary" onclick="openImpersonateModal('${f.name}', '${initials}')">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            Impersonate
                        </button>
                    </div>
                </div>`;
            }).join('');
        } catch (e) {
            grid.innerHTML = '<div class="firm-card" style="text-align:center;padding:2rem;color:var(--gray-500);">Could not load firms. Check API connectivity.</div>';
            console.warn('Failed to load firms:', e);
        }
    })();
    </script>
    </div>

    <!-- Recent Impersonation Sessions -->
    <div class="recent-sessions">
        <div class="section-header">
            <h2 class="section-title">Recent Impersonation Sessions</h2>
        </div>
        <div class="sessions-table">
            <table>
                <thead>
                    <tr>
                        <th>Admin</th>
                        <th>Firm</th>
                        <th>Reason</th>
                        <th>Started</th>
                        <th>Duration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recent-sessions-body">
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--gray-500); padding: 2rem;">
                            No impersonation sessions recorded yet.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Impersonate Confirmation Modal -->
<div class="modal-overlay" id="impersonateModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Confirm Impersonation</h3>
            <button class="modal-close" onclick="closeModal()">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="confirm-icon">
                <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                    <path d="M12 9v4M12 17h.01"/>
                </svg>
            </div>
            <div class="confirm-title">Start Impersonation Session?</div>
            <div class="confirm-text">You are about to access this firm's account. All actions will be logged and attributed to your admin account.</div>
            <div class="confirm-firm">
                <div class="confirm-firm-logo" id="modalFirmLogo"></div>
                <div class="confirm-firm-name" id="modalFirmName"></div>
            </div>
            <label class="reason-label">
                Reason for impersonation <span style="color: var(--color-error-500);">*</span>
            </label>
            <textarea class="reason-input" placeholder="Enter the reason for this impersonation session..." required></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="startImpersonation()">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                Start Impersonation
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function openImpersonateModal(firmName, firmInitials) {
        document.getElementById('modalFirmName').textContent = firmName;
        document.getElementById('modalFirmLogo').textContent = firmInitials;
        document.getElementById('impersonateModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('impersonateModal').classList.remove('active');
    }

    function startImpersonation() {
        const reason = document.querySelector('.reason-input').value;
        if (!reason.trim()) {
            showToast('Please provide a reason for the impersonation session.', 'warning');
            return;
        }
        // In production, this would make an API call to start the session
        showToast('Impersonation session started. You will be redirected to the firm dashboard.', 'info');
        closeModal();
    }

    function viewFirmDetails(firmId) {
        window.location.href = '/admin/firms/' + firmId;
    }

    // Close modal on overlay click
    document.getElementById('impersonateModal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
            closeModal();
        }
    });
</script>
{% endblock %}
