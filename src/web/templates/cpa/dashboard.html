{% extends "cpa/base.html" %}
{% from 'macros/icons.html' import icon %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block extra_styles %}
<style>
    /* Summary Cards Grid */
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-5);

        margin-bottom: var(--space-8);

    }

    .summary-card {
        background: var(--white);
        border-radius: var(--radius-2xl);

        padding: var(--space-6);

        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    }

    .summary-card-icon {
        width: var(--space-12);

        height: var(--space-12);

        border-radius: var(--radius-xl);

        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: var(--space-4);

    }

    .summary-card-icon.new { background: #eef3f9; }
    .summary-card-icon.contacted { background: var(--color-warning-100); }
    .summary-card-icon.engaged { background: var(--color-success-100); }
    .summary-card-icon.converted { background: #ede9fe; }
    .summary-card-icon.revenue { background: #fce7f3; }

    .summary-card-value {
        font-size: 2rem;
        font-weight: var(--font-bold);

        line-height: 1;
        margin-bottom: var(--space-1);

    }

    .summary-card-label {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .summary-card-trend {
        display: flex;
        align-items: center;
        gap: var(--space-1);

        margin-top: var(--space-3);

        font-size: 0.8rem;
    }

    .trend-up { color: var(--success); }
    .trend-down { color: var(--danger); }
    .trend-neutral { color: var(--text-muted); }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--space-6);

    }

    @media (max-width: 1200px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Lead List Table */
    .lead-table {
        width: 100%;
        border-collapse: collapse;
    }

    .lead-table th,
    .lead-table td {
        padding: var(--space-3) var(--space-4);

        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .lead-table th {
        font-weight: var(--font-semibold);

        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        background: var(--bg-light);
    }

    .lead-table tbody tr {
        transition: background 0.15s ease;
        cursor: pointer;
    }

    .lead-table tbody tr:hover {
        background: var(--bg-light);
    }

    .lead-name {
        font-weight: var(--font-semibold);

    }

    .lead-email {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    /* State Badge */
    .state-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);

        padding: var(--space-1) var(--space-2-5);

        border-radius: var(--radius-2xl-plus);
        font-size: 0.75rem;
        font-weight: var(--font-semibold);

    }

    .state-badge.browsing { background: var(--color-gray-100); color: var(--color-gray-500); }
    .state-badge.curious { background: #eef3f9; color: var(--color-primary-500); }
    .state-badge.evaluating { background: var(--color-warning-100); color: #b45309; }
    .state-badge.advisory_ready { background: var(--color-success-100); color: #047857; }
    .state-badge.high_leverage { background: #fce7f3; color: #be185d; }

    /* Temperature Badge */
    .temp-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);

        padding: var(--space-1) var(--space-2);

        border-radius: var(--radius-md);

        font-size: 0.75rem;
        font-weight: var(--font-semibold);

    }

    .temp-badge.hot { background: var(--color-error-100); color: #b91c1c; }
    .temp-badge.warm { background: var(--color-warning-100); color: #b45309; }
    .temp-badge.cold { background: #eef3f9; color: var(--color-primary-500); }

    /* Savings Value */
    .savings-value {
        font-weight: var(--font-semibold);

        color: var(--success);
    }

    /* Priority Queue */
    .priority-item {
        display: flex;
        align-items: center;
        gap: var(--space-3);

        padding: var(--space-4);

        border-bottom: 1px solid var(--border-color);
        transition: background 0.15s ease;
        cursor: pointer;
    }

    .priority-item:last-child {
        border-bottom: none;
    }

    .priority-item:hover {
        background: var(--bg-light);
    }

    .priority-rank {
        width: var(--space-7);

        height: var(--space-7);

        border-radius: var(--radius-lg);

        background: var(--bg-light);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: var(--font-semibold);

        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .priority-rank.top-3 {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
    }

    .priority-info {
        flex: 1;
        min-width: 0;
    }

    .priority-name {
        font-weight: var(--font-semibold);

        margin-bottom: var(--space-0-5);

    }

    .priority-meta {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .priority-value {
        text-align: right;
    }

    .priority-savings {
        font-weight: var(--font-semibold);

        color: var(--success);
    }

    .priority-time {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    /* Quick Actions */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-3);

        margin-top: var(--space-5);

    }

    .quick-action {
        display: flex;
        align-items: center;
        gap: var(--space-3);

        padding: var(--space-3-5) var(--space-4);

        background: var(--bg-light);
        border-radius: var(--radius-lg-plus);
        text-decoration: none;
        color: var(--text-dark);
        transition: all 0.15s ease;
        border: 1px solid transparent;
    }

    .quick-action:hover {
        background: var(--white);
        border-color: var(--border-color);
        transform: translateY(-1px);
    }

    .quick-action-icon {
        font-size: 1.3rem;
    }

    .quick-action-text {
        font-size: 0.9rem;
        font-weight: var(--font-medium);

    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: var(--space-12) var(--space-6);

        color: var(--text-muted);
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: var(--space-4);

    }

    .empty-state-title {
        font-size: 1.1rem;
        font-weight: var(--font-semibold);

        color: var(--text-dark);
        margin-bottom: var(--space-2);

    }

    /* Activity Feed */
    .activity-item {
        display: flex;
        gap: var(--space-3);

        padding: var(--space-3) 0;

        border-bottom: 1px solid var(--border-color);
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: var(--space-8);

        height: var(--space-8);

        border-radius: 50%;
        background: var(--bg-light);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .activity-content {
        flex: 1;
        min-width: 0;
    }

    .activity-text {
        font-size: 0.9rem;
        margin-bottom: var(--space-0-5);

    }

    .activity-text strong {
        font-weight: var(--font-semibold);

    }

    .activity-time {
        font-size: 0.75rem;
        color: var(--text-muted);
    }
</style>
{% endblock %}

{% block content %}
<!-- Welcome Banner -->
<div style="margin-bottom: var(--space-6);">
    <h2 style="font-size: 1.5rem; font-weight: var(--font-bold); margin-bottom: var(--space-1);">
        Welcome back{% if cpa.first_name %}, {{ cpa.first_name }}{% endif %}!
    </h2>
    <p style="color: var(--text-muted);">Here's what's happening with your leads today.</p>
</div>

<!-- Summary Cards -->
<div class="summary-grid">
    <a href="/cpa/leads?state=new" class="summary-card">
        <div class="summary-card-icon new">{{ icon('arrow-down-tray') }}</div>
        <div class="summary-card-value">{{ stats.new_leads or 0 }}</div>
        <div class="summary-card-label">New Leads</div>
        <div class="summary-card-trend {% if stats.new_leads_trend >= 0 %}trend-up{% else %}trend-down{% endif %}">
            {% if stats.new_leads_trend >= 0 %}‚Üë{% else %}‚Üì{% endif %}
            {{ stats.new_leads_trend|abs or 0 }}% from last week
        </div>
    </a>

    <a href="/cpa/leads?state=advisory_ready" class="summary-card">
        <div class="summary-card-icon contacted">{{ icon('star') }}</div>
        <div class="summary-card-value">{{ stats.advisory_ready or 0 }}</div>
        <div class="summary-card-label">Advisory Ready</div>
        <div class="summary-card-trend trend-neutral">
            Ready for engagement
        </div>
    </a>

    <a href="/cpa/leads?state=high_leverage" class="summary-card">
        <div class="summary-card-icon engaged">üî•</div>
        <div class="summary-card-value">{{ stats.high_leverage or 0 }}</div>
        <div class="summary-card-label">High Leverage</div>
        <div class="summary-card-trend trend-up">
            Priority follow-up
        </div>
    </a>

    <a href="/cpa/converted" class="summary-card">
        <div class="summary-card-icon converted">{{ icon('check-circle') }}</div>
        <div class="summary-card-value">{{ stats.converted or 0 }}</div>
        <div class="summary-card-label">Converted</div>
        <div class="summary-card-trend {% if stats.conversion_trend >= 0 %}trend-up{% else %}trend-down{% endif %}">
            {% if stats.conversion_rate %}{{ stats.conversion_rate }}% conversion rate{% else %}Track conversions{% endif %}
        </div>
    </a>

    <a href="/cpa/analytics" class="summary-card">
        <div class="summary-card-icon revenue">{{ icon('banknotes') }}</div>
        <div class="summary-card-value">${{ '{:,.0f}'.format(stats.total_revenue or 0) }}</div>
        <div class="summary-card-label">Est. Pipeline Value</div>
        <div class="summary-card-trend trend-neutral">
            Based on savings potential
        </div>
    </a>
</div>

<!-- Dashboard Grid -->
<div class="dashboard-grid">
    <!-- Recent Leads -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Recent Leads</h3>
            <a href="/cpa/leads" class="btn btn-secondary btn-sm">View All</a>
        </div>

        {% if leads and leads|length > 0 %}
        <table class="lead-table">
            <thead>
                <tr>
                    <th>Lead</th>
                    <th>State</th>
                    <th>Temperature</th>
                    <th>Est. Savings</th>
                    <th>Age</th>
                </tr>
            </thead>
            <tbody>
                {% for lead in leads[:10] %}
                <tr onclick="location.href='/cpa/leads/{{ lead.id }}'">
                    <td>
                        <div class="lead-name">{{ lead.name or lead.email.split('@')[0] }}</div>
                        <div class="lead-email">{{ lead.email }}</div>
                    </td>
                    <td>
                        <span class="state-badge {{ lead.state|lower|replace(' ', '_') }}">
                            {{ lead.state_display or lead.state }}
                        </span>
                    </td>
                    <td>
                        <span class="temp-badge {{ lead.temperature|lower }}">
                            {% if lead.temperature == 'hot' %}üî•{% elif lead.temperature == 'warm' %}‚òÄÔ∏è{% else %}‚ùÑÔ∏è{% endif %}
                            {{ lead.temperature|title }}
                        </span>
                    </td>
                    <td>
                        <span class="savings-value">
                            ${{ '{:,.0f}'.format(lead.estimated_savings or 0) }}
                        </span>
                    </td>
                    <td style="color: var(--text-muted); font-size: 0.85rem;">
                        {{ lead.age or 'Today' }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <div class="empty-state-title">No leads yet</div>
            <p>Share your lead magnet link to start capturing leads.</p>
            <a href="/cpa/branding" class="btn btn-primary" style="margin-top: var(--space-4);">
                Set Up Lead Magnet
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Right Column -->
    <div>
        <!-- Priority Queue -->
        <div class="card" style="margin-bottom: var(--space-6);">
            <div class="card-header">
                <h3 class="card-title">Priority Queue</h3>
            </div>
            <div class="card-body" style="padding: 0;">
                {% if priority_leads and priority_leads|length > 0 %}
                {% for lead in priority_leads[:5] %}
                <div class="priority-item" onclick="location.href='/cpa/leads/{{ lead.id }}'">
                    <div class="priority-rank {% if loop.index <= 3 %}top-3{% endif %}">{{ loop.index }}</div>
                    <div class="priority-info">
                        <div class="priority-name">{{ lead.name or lead.email.split('@')[0] }}</div>
                        <div class="priority-meta">
                            {{ lead.state_display or lead.state }} ‚Ä¢ {{ lead.complexity|title }} complexity
                        </div>
                    </div>
                    <div class="priority-value">
                        <div class="priority-savings">${{ '{:,.0f}'.format(lead.estimated_savings or 0) }}</div>
                        <div class="priority-time">{{ lead.time_in_state or 'Just now' }}</div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state" style="padding: var(--space-8) var(--space-6);">
                    <div class="empty-state-icon">{{ icon('clipboard-document-list') }}</div>
                    <div class="empty-state-title">Queue is empty</div>
                    <p>Priority leads will appear here.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Quick Actions</h3>
            </div>
            <div class="card-body">
                <div class="quick-actions">
                    <a href="/lead-magnet?cpa={{ cpa.cpa_slug or 'default' }}" target="_blank" class="quick-action">
                        <span class="quick-action-icon">{{ icon('arrow-right') }}</span>
                        <span class="quick-action-text">View Lead Magnet</span>
                    </a>
                    <a href="/cpa/branding" class="quick-action">
                        <span class="quick-action-icon">üé®</span>
                        <span class="quick-action-text">Edit Branding</span>
                    </a>
                    <a href="/cpa/analytics" class="quick-action">
                        <span class="quick-action-icon">{{ icon('chart-bar') }}</span>
                        <span class="quick-action-text">View Analytics</span>
                    </a>
                    <a href="/cpa/leads?export=csv" class="quick-action">
                        <span class="quick-action-icon">{{ icon('arrow-down-tray') }}</span>
                        <span class="quick-action-text">Export Leads</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card" style="margin-top: var(--space-6);">
            <div class="card-header">
                <h3 class="card-title">Recent Activity</h3>
            </div>
            <div class="card-body">
                {% if activities and activities|length > 0 %}
                {% for activity in activities[:5] %}
                <div class="activity-item">
                    <div class="activity-icon">
                        {% if activity.type == 'new_lead' %}{{ icon('arrow-down-tray') }}
                        {% elif activity.type == 'state_change' %}{{ icon('arrow-path') }}
                        {% elif activity.type == 'engagement' %}üí¨
                        {% elif activity.type == 'conversion' %}{{ icon('check-circle') }}
                        {% else %}{{ icon('star') }}{% endif %}
                    </div>
                    <div class="activity-content">
                        <div class="activity-text">
                            <strong>{{ activity.lead_name }}</strong> {{ activity.description }}
                        </div>
                        <div class="activity-time">{{ activity.time_ago }}</div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state" style="padding: var(--space-6);">
                    <div class="empty-state-icon">üìú</div>
                    <p>Activity will appear here as leads engage.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Auto-refresh dashboard data every 30 seconds
    setTimeout(function() {
        location.reload();
    }, 30000);

    // Lead Magnet Link Copy
    function copyLeadMagnetLink() {
        const link = '{{ request.url.scheme }}://{{ request.url.netloc }}/lead-magnet?cpa={{ cpa.cpa_slug or "default" }}';
        navigator.clipboard.writeText(link).then(function() {
            showToast('Lead magnet link copied to clipboard!', 'success');
        });
    }
</script>
{% endblock %}
