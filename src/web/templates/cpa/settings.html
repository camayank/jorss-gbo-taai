{% extends "cpa/base.html" %}
{% from 'macros/icons.html' import icon %}

{% block title %}Settings{% endblock %}
{% block page_title %}Account Settings{% endblock %}

{% block extra_styles %}
<style>
    .settings-grid { display: grid; grid-template-columns: 250px 1fr; gap: var(--space-6); }
    @media (max-width: 768px) {
        .settings-grid { grid-template-columns: 1fr; }
        .settings-nav { display: flex; overflow-x: auto; }
        .settings-nav-item { white-space: nowrap; border-bottom: none !important; border-right: 1px solid var(--border-color); }
        .settings-nav-item:last-child { border-right: none; }
    }
    .settings-nav { background: var(--white); border-radius: var(--radius-xl); border: 1px solid var(--border-color); overflow: hidden; height: fit-content; position: sticky; top: 88px; }
    .settings-nav-item { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3-5) var(--space-5); color: var(--text-muted); text-decoration: none; border-bottom: 1px solid var(--border-color); transition: all 0.15s ease; cursor: pointer; font-size: 0.9rem; }
    .settings-nav-item:last-child { border-bottom: none; }
    .settings-nav-item:hover { background: var(--bg-light); color: var(--text-dark); }
    .settings-nav-item.active { background: var(--primary-color); color: white; }
    .settings-section { background: var(--white); border-radius: var(--radius-xl); border: 1px solid var(--border-color); margin-bottom: var(--space-6); }
    .settings-section:last-child { margin-bottom: 0; }
    .settings-section-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); }
    .settings-section-title { font-weight: 600; font-size: 1.1rem; margin-bottom: var(--space-1); }
    .settings-section-desc { font-size: 0.9rem; color: var(--text-muted); }
    .settings-section-body { padding: 24px; }
    .setting-row { display: flex; justify-content: space-between; align-items: center; padding: var(--space-4) 0; border-bottom: 1px solid var(--border-color); }
    .setting-row:last-child { border-bottom: none; }
    .setting-row:first-child { padding-top: 0; }
    .setting-info h4 { font-weight: 500; margin-bottom: var(--space-1); }
    .setting-info p { font-size: 0.85rem; color: var(--text-muted); margin: 0; }
    .toggle-switch { position: relative; width: 50px; height: 26px; flex-shrink: 0; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: 0.3s; border-radius: 26px; }
    .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%; }
    input:checked + .toggle-slider { background-color: var(--primary-color); }
    input:checked + .toggle-slider:before { transform: translateX(24px); }
    .status-badge { display: inline-flex; align-items: center; gap: var(--space-1-5); padding: var(--space-1) var(--space-3); border-radius: var(--radius-2xl-plus); font-size: 0.8rem; font-weight: var(--font-medium); }
    .status-badge.enabled { background: var(--color-success-100); color: var(--color-success-800); }
    .status-badge.disabled { background: var(--color-error-100); color: var(--color-error-800); }
    .password-form { max-width: 420px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 0.85rem; font-weight: var(--font-medium); margin-bottom: var(--space-1-5); color: var(--text-dark); }
    .form-input { width: 100%; padding: var(--space-2-5) var(--space-3-5); border: 1px solid var(--border-color); border-radius: var(--radius-lg); font-size: 0.9rem; transition: border-color 0.15s ease; background: var(--white); }
    .form-input:focus { outline: none; border-color: var(--primary-color); }
    .form-input.error { border-color: var(--color-error-500); }
    .form-error { font-size: 0.8rem; color: var(--color-error-500); margin-top: var(--space-1); }
    .session-row { display: flex; align-items: center; justify-content: space-between; padding: var(--space-3-5) var(--space-4); background: var(--bg-light); border-radius: var(--radius-lg-plus); margin-bottom: var(--space-2-5); }
    .session-row:last-child { margin-bottom: 0; }
    .session-info { display: flex; align-items: center; gap: var(--space-3-5); }
    .session-icon { width: 40px; height: 40px; border-radius: var(--radius-lg-plus); background: var(--white); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; color: var(--text-muted); }
    .session-device { font-weight: 500; font-size: 0.9rem; }
    .session-meta { font-size: 0.8rem; color: var(--text-muted); }
    .session-current { font-size: 0.75rem; font-weight: var(--font-semibold); color: var(--success-color, #059669); background: var(--color-success-100); padding: 2px var(--space-2); border-radius: var(--radius-lg-plus); margin-left: var(--space-2); }
    .integrations-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--space-4); }
    .integration-card { border: 1px solid var(--border-color); border-radius: var(--radius-xl); padding: var(--space-5); display: flex; flex-direction: column; gap: var(--space-3-5); transition: border-color 0.15s ease; }
    .integration-card:hover { border-color: var(--primary-color); }
    .integration-card.connected { border-color: var(--success-color, #059669); }
    .integration-header { display: flex; align-items: center; gap: var(--space-3-5); }
    .integration-icon { width: 44px; height: 44px; border-radius: var(--radius-lg-plus); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; font-weight: var(--font-bold); flex-shrink: 0; }
    .integration-icon.quickbooks { background: #e8f5e9; color: #2ca01c; }
    .integration-icon.xero { background: #e3f2fd; color: #13b5ea; }
    .integration-icon.gcal { background: #fff3e0; color: #f4511e; }
    .integration-icon.calendly { background: #ede7f6; color: #006bff; }
    .integration-icon.zapier { background: #fff3e0; color: #ff4a00; }
    .integration-name { font-weight: 600; font-size: 0.95rem; }
    .integration-desc { font-size: 0.85rem; color: var(--text-muted); flex: 1; }
    .integration-footer { display: flex; align-items: center; justify-content: space-between; }
    .integration-status { font-size: 0.8rem; font-weight: var(--font-medium); display: flex; align-items: center; gap: var(--space-1-5); }
    .integration-status.connected { color: var(--color-success-600); }
    .integration-status.disconnected { color: var(--text-muted); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    .status-dot.connected { background: var(--color-success-600); }
    .status-dot.disconnected { background: var(--border-color); }
    .export-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3-5); }
    @media (max-width: 640px) { .export-grid { grid-template-columns: 1fr; } }
    .export-card { display: flex; align-items: center; gap: var(--space-3-5); padding: var(--space-4); background: var(--bg-light); border-radius: var(--radius-lg-plus); cursor: pointer; border: 1px solid transparent; transition: all 0.15s ease; }
    .export-card:hover { border-color: var(--primary-color); background: var(--white); }
    .export-icon { width: 42px; height: 42px; border-radius: var(--radius-lg-plus); background: var(--white); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; color: var(--primary-color); }
    .export-title { font-weight: 500; font-size: 0.9rem; }
    .export-desc { font-size: 0.8rem; color: var(--text-muted); }
    .retention-row { display: flex; align-items: center; justify-content: space-between; padding: var(--space-4) 0; }
    .retention-select { padding: 8px 14px; border: 1px solid var(--border-color); border-radius: var(--radius-lg); font-size: 0.9rem; background: var(--white); cursor: pointer; }
    .retention-select:focus { outline: none; border-color: var(--primary-color); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--space-2); padding: var(--space-2-5) var(--space-5); border-radius: var(--radius-lg); font-size: 0.9rem; font-weight: var(--font-medium); cursor: pointer; transition: all 0.15s ease; border: none; text-decoration: none; }
    .btn-primary { background: var(--primary-color); color: white; }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-secondary { background: var(--bg-light); color: var(--text-dark); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background: var(--border-color); }
    .btn-danger { background: var(--color-error-50); color: var(--color-error-600); border: 1px solid #fecaca; }
    .btn-danger:hover { background: var(--color-error-100); }
    .btn-sm { padding: 6px 14px; font-size: 0.8rem; }
    .btn-connect { background: var(--primary-color); color: white; }
    .btn-connect:hover { opacity: 0.9; }
    .btn-disconnect { background: var(--color-error-50); color: var(--color-error-600); border: 1px solid #fecaca; }
    .btn-disconnect:hover { background: var(--color-error-100); }
    .save-bar { display: flex; align-items: center; justify-content: flex-end; gap: var(--space-3); padding-top: var(--space-4); }
    .settings-toast { position: fixed; bottom: 24px; right: 24px; padding: var(--space-3-5) var(--space-6); border-radius: var(--radius-lg-plus); font-size: 0.9rem; font-weight: var(--font-medium); display: flex; align-items: center; gap: var(--space-2-5); z-index: 9999; box-shadow: 0 8px 24px rgba(0,0,0,0.15); transform: translateY(100px); opacity: 0; transition: all 0.3s ease; }
    .settings-toast.show { transform: translateY(0); opacity: 1; }
    .settings-toast.success { background: var(--color-success-800); color: white; }
    .settings-toast.error { background: var(--color-error-800); color: white; }
</style>
{% endblock %}

{% block breadcrumbs %}
<div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-6); font-size: 0.9rem;">
    <a href="/cpa/dashboard" style="color: var(--text-muted, #6b7280); text-decoration: none;">Dashboard</a>
    <span style="color: var(--text-light, #9ca3af);">&rsaquo;</span>
    <span style="color: var(--text-dark, #1f2937); font-weight: var(--font-medium);">Settings</span>
</div>
{% endblock %}

{% block content %}
<div x-data="settingsManager()" class="settings-grid">
    <!-- Left sidebar nav -->
    <nav class="settings-nav">
        <a @click.prevent="scrollTo('notifications')" :class="{ active: activeSection === 'notifications' }" class="settings-nav-item">
            <span>{{ icon('bell') }}</span> Notifications
        </a>
        <a @click.prevent="scrollTo('security')" :class="{ active: activeSection === 'security' }" class="settings-nav-item">
            <span>{{ icon('lock-closed') }}</span> Security
        </a>
        <a @click.prevent="scrollTo('integrations')" :class="{ active: activeSection === 'integrations' }" class="settings-nav-item">
            <span>{{ icon('bolt') }}</span> Integrations
        </a>
        <a @click.prevent="scrollTo('data-export')" :class="{ active: activeSection === 'data-export' }" class="settings-nav-item">
            <span>{{ icon('arrow-down-tray') }}</span> Data & Export
        </a>
        <a href="/cpa/billing" class="settings-nav-item">
            <span>{{ icon('credit-card') }}</span> Billing
        </a>
    </nav>

    <div class="settings-content">
        <!-- Notifications -->
        <section class="settings-section" id="notifications">
            <div class="settings-section-header">
                <h3 class="settings-section-title">Notification Preferences</h3>
                <p class="settings-section-desc">Manage how you receive notifications about leads and activity</p>
            </div>
            <div class="settings-section-body">
                <template x-for="item in notificationItems" :key="item.key">
                    <div class="setting-row">
                        <div class="setting-info">
                            <h4 x-text="item.label"></h4>
                            <p x-text="item.desc"></p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" x-model="settings.notifications[item.key]">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </template>
                <div class="save-bar">
                    <button class="btn btn-primary" @click="saveNotifications()">Save Preferences</button>
                </div>
            </div>
        </section>

        <!-- Security -->
        <section class="settings-section" id="security">
            <div class="settings-section-header">
                <h3 class="settings-section-title">Security Settings</h3>
                <p class="settings-section-desc">Manage your account security and authentication</p>
            </div>
            <div class="settings-section-body">
                <div class="setting-row">
                    <div class="setting-info">
                        <h4>Two-Factor Authentication</h4>
                        <p>Add an extra layer of security to your account</p>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-3);">
                        <span class="status-badge" :class="settings.twoFactorEnabled ? 'enabled' : 'disabled'" x-text="settings.twoFactorEnabled ? 'Enabled' : 'Disabled'"></span>
                        <label class="toggle-switch">
                            <input type="checkbox" x-model="settings.twoFactorEnabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="setting-row" style="flex-direction: column; align-items: stretch;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                        <div class="setting-info">
                            <h4>Change Password</h4>
                            <p>Update your account password regularly for better security</p>
                        </div>
                        <button class="btn btn-secondary btn-sm" @click="showPasswordForm = !showPasswordForm" x-text="showPasswordForm ? 'Cancel' : 'Update'"></button>
                    </div>
                    <div x-show="showPasswordForm" x-transition class="password-form">
                        <div class="form-group">
                            <label>Current Password</label>
                            <input type="password" class="form-input" :class="{ error: passwordErrors.current }" x-model="passwordForm.current" placeholder="Enter current password">
                            <div class="form-error" x-show="passwordErrors.current" x-text="passwordErrors.current"></div>
                        </div>
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" class="form-input" :class="{ error: passwordErrors.newPass }" x-model="passwordForm.newPass" placeholder="Enter new password">
                            <div class="form-error" x-show="passwordErrors.newPass" x-text="passwordErrors.newPass"></div>
                        </div>
                        <div class="form-group">
                            <label>Confirm New Password</label>
                            <input type="password" class="form-input" :class="{ error: passwordErrors.confirm }" x-model="passwordForm.confirm" placeholder="Confirm new password">
                            <div class="form-error" x-show="passwordErrors.confirm" x-text="passwordErrors.confirm"></div>
                        </div>
                        <button class="btn btn-primary" @click="changePassword()">Update Password</button>
                    </div>
                </div>
                <div class="setting-row" style="flex-direction: column; align-items: stretch;">
                    <div class="setting-info" style="margin-bottom: var(--space-4);">
                        <h4>Active Sessions</h4>
                        <p>Devices currently signed into your account</p>
                    </div>
                    <template x-for="(session, idx) in sessions" :key="idx">
                        <div class="session-row">
                            <div class="session-info">
                                <div class="session-icon">{{ icon('user-circle') }}</div>
                                <div>
                                    <div class="session-device">
                                        <span x-text="session.device"></span>
                                        <span x-show="session.current" class="session-current">This device</span>
                                    </div>
                                    <div class="session-meta" x-text="session.browser + ' \u00B7 ' + session.ip + ' \u00B7 ' + session.lastActive"></div>
                                </div>
                            </div>
                            <button x-show="!session.current" class="btn btn-danger btn-sm" @click="revokeSession(idx)">Revoke</button>
                        </div>
                    </template>
                </div>
            </div>
        </section>

        <!-- Integrations -->
        <section class="settings-section" id="integrations">
            <div class="settings-section-header">
                <h3 class="settings-section-title">Integrations</h3>
                <p class="settings-section-desc">Connect your favorite tools to streamline your workflow</p>
            </div>
            <div class="settings-section-body">
                <div class="integrations-grid">
                    <template x-for="integration in integrations" :key="integration.id">
                        <div class="integration-card" :class="{ connected: integration.connected }">
                            <div class="integration-header">
                                <div class="integration-icon" :class="integration.iconClass" x-text="integration.abbr"></div>
                                <div><div class="integration-name" x-text="integration.name"></div></div>
                            </div>
                            <div class="integration-desc" x-text="integration.desc"></div>
                            <div class="integration-footer">
                                <div class="integration-status" :class="integration.connected ? 'connected' : 'disconnected'">
                                    <span class="status-dot" :class="integration.connected ? 'connected' : 'disconnected'"></span>
                                    <span x-text="integration.connected ? 'Connected' : 'Not Connected'"></span>
                                </div>
                                <button class="btn btn-sm" :class="integration.connected ? 'btn-disconnect' : 'btn-connect'" @click="toggleIntegration(integration)" x-text="integration.connected ? 'Disconnect' : 'Connect'"></button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </section>

        <!-- Data & Export -->
        <section class="settings-section" id="data-export">
            <div class="settings-section-header">
                <h3 class="settings-section-title">Data & Export</h3>
                <p class="settings-section-desc">Export your data or configure retention policies</p>
            </div>
            <div class="settings-section-body">
                <div class="export-grid">
                    <div class="export-card" @click="exportData('clients', 'csv')">
                        <div class="export-icon">{{ icon('users') }}</div>
                        <div><div class="export-title">Export Client Data</div><div class="export-desc">Download all clients as CSV</div></div>
                    </div>
                    <div class="export-card" @click="exportData('clients', 'json')">
                        <div class="export-icon">{{ icon('document-text') }}</div>
                        <div><div class="export-title">Export Client Data (JSON)</div><div class="export-desc">Download all clients as JSON</div></div>
                    </div>
                    <div class="export-card" @click="exportData('leads', 'csv')">
                        <div class="export-icon">{{ icon('arrow-trending-up') }}</div>
                        <div><div class="export-title">Export Lead Data</div><div class="export-desc">Download all leads as CSV</div></div>
                    </div>
                    <div class="export-card" @click="exportData('activity', 'csv')">
                        <div class="export-icon">{{ icon('clipboard-document-list') }}</div>
                        <div><div class="export-title">Download Activity Log</div><div class="export-desc">Full activity history as CSV</div></div>
                    </div>
                </div>
                <div style="margin-top: var(--space-6); padding-top: var(--space-6); border-top: 1px solid var(--border-color);">
                    <div class="retention-row">
                        <div class="setting-info">
                            <h4>Data Retention Period</h4>
                            <p>How long to keep inactive lead records before archiving</p>
                        </div>
                        <select class="retention-select" x-model="settings.retentionPeriod" @change="saveRetention()">
                            <option value="6">6 Months</option>
                            <option value="12">1 Year</option>
                            <option value="24">2 Years</option>
                            <option value="36">3 Years</option>
                            <option value="60">5 Years</option>
                            <option value="0">Forever</option>
                        </select>
                    </div>
                    <div class="retention-row">
                        <div class="setting-info">
                            <h4>Auto-Archive Converted Leads</h4>
                            <p>Automatically archive leads after conversion to client</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" x-model="settings.autoArchive" @change="saveRetention()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Toast notification (inside x-data scope) -->
    <div class="settings-toast" :class="{ show: toast.show, success: toast.type === 'success', error: toast.type === 'error' }" x-text="toast.message"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('settingsManager', () => ({
        activeSection: 'notifications',
        showPasswordForm: false,
        settings: {
            notifications: {
                newLeadAlerts: true, hotLeadAlerts: true, weeklySummary: true,
                emailNotifications: true, smsNotifications: false, returnStatusUpdates: true
            },
            twoFactorEnabled: false, retentionPeriod: '24', autoArchive: true
        },
        notificationItems: [
            { key: 'newLeadAlerts', label: 'New Lead Alerts', desc: 'Get notified when a new lead enters your pipeline' },
            { key: 'hotLeadAlerts', label: 'Hot Lead Alerts', desc: 'Immediate notification when a lead becomes advisory-ready' },
            { key: 'weeklySummary', label: 'Weekly Summary', desc: 'Receive a weekly digest of your pipeline activity' },
            { key: 'emailNotifications', label: 'Email Notifications', desc: 'Send notifications to your email address' },
            { key: 'smsNotifications', label: 'SMS Notifications', desc: 'Receive text message alerts for urgent items' },
            { key: 'returnStatusUpdates', label: 'Return Status Updates', desc: 'Notify when a tax return changes status' }
        ],
        passwordForm: { current: '', newPass: '', confirm: '' },
        passwordErrors: { current: '', newPass: '', confirm: '' },
        sessions: [
            { device: 'MacBook Pro', browser: 'Chrome 121', ip: '192.168.1.42', lastActive: 'Active now', current: true },
            { device: 'iPhone 15', browser: 'Safari Mobile', ip: '10.0.0.87', lastActive: '2 hours ago', current: false },
            { device: 'Windows Desktop', browser: 'Firefox 122', ip: '172.16.0.15', lastActive: '3 days ago', current: false }
        ],
        integrations: [
            { id: 'quickbooks', name: 'QuickBooks', abbr: 'QB', iconClass: 'quickbooks', desc: 'Sync client financial data, invoices, and payments with QuickBooks Online.', connected: true },
            { id: 'xero', name: 'Xero', abbr: 'XO', iconClass: 'xero', desc: 'Connect Xero accounting to import financial records and reconcile data.', connected: false },
            { id: 'gcal', name: 'Google Calendar', abbr: 'GC', iconClass: 'gcal', desc: 'Sync appointments and client meetings with your Google Calendar.', connected: false },
            { id: 'calendly', name: 'Calendly', abbr: 'CL', iconClass: 'calendly', desc: 'Let clients book advisory sessions directly through Calendly.', connected: false },
            { id: 'zapier', name: 'Zapier', abbr: 'ZP', iconClass: 'zapier', desc: 'Automate workflows by connecting to 5,000+ apps via Zapier.', connected: false }
        ],
        toast: { show: false, message: '', type: 'success' },
        _toastTimer: null,

        scrollTo(sectionId) {
            this.activeSection = sectionId;
            const el = document.getElementById(sectionId);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        },

        showToast(message, type = 'success') {
            clearTimeout(this._toastTimer);
            this.toast = { show: true, message, type };
            this._toastTimer = setTimeout(() => { this.toast.show = false; }, 3000);
        },

        saveNotifications() {
            this.showToast('Notification preferences saved successfully');
        },

        changePassword() {
            this.passwordErrors = { current: '', newPass: '', confirm: '' };
            let valid = true;
            if (!this.passwordForm.current) { this.passwordErrors.current = 'Current password is required'; valid = false; }
            if (!this.passwordForm.newPass) { this.passwordErrors.newPass = 'New password is required'; valid = false; }
            else if (this.passwordForm.newPass.length < 8) { this.passwordErrors.newPass = 'Password must be at least 8 characters'; valid = false; }
            if (!this.passwordForm.confirm) { this.passwordErrors.confirm = 'Please confirm your new password'; valid = false; }
            else if (this.passwordForm.newPass !== this.passwordForm.confirm) { this.passwordErrors.confirm = 'Passwords do not match'; valid = false; }
            if (valid) {
                this.passwordForm = { current: '', newPass: '', confirm: '' };
                this.showPasswordForm = false;
                this.showToast('Password updated successfully');
            }
        },

        revokeSession(idx) {
            const name = this.sessions[idx].device;
            if (confirm('Revoke session on ' + name + '?')) {
                this.sessions.splice(idx, 1);
                this.showToast('Session on ' + name + ' has been revoked');
            }
        },

        toggleIntegration(integration) {
            if (integration.connected) {
                if (confirm('Disconnect ' + integration.name + '?')) {
                    integration.connected = false;
                    this.showToast(integration.name + ' disconnected');
                }
            } else {
                integration.connected = true;
                this.showToast(integration.name + ' connected successfully');
            }
        },

        exportData(type, format) {
            const labels = { clients: 'Client', leads: 'Lead', activity: 'Activity Log' };
            this.showToast(labels[type] + ' export (' + format.toUpperCase() + ') started');
        },

        saveRetention() { this.showToast('Data retention settings saved'); },

        init() {
            const sections = ['notifications', 'security', 'integrations', 'data-export'];
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => { if (entry.isIntersecting) this.activeSection = entry.target.id; });
            }, { rootMargin: '-20% 0px -60% 0px' });
            this.$nextTick(() => {
                sections.forEach(id => { const el = document.getElementById(id); if (el) observer.observe(el); });
            });
        }
    }));
});
</script>
{% endblock %}
