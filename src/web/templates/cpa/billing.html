{% extends "cpa/base.html" %}
{% from 'macros/icons.html' import icon %}

{% block title %}Billing{% endblock %}
{% block page_title %}Billing & Subscription{% endblock %}

{% block extra_styles %}
<style>
    .billing-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-6);

        margin-bottom: var(--space-8);

    }

    @media (max-width: 768px) {
        .billing-grid {
            grid-template-columns: 1fr;
        }
    }

    .plan-card {
        background: var(--white);
        border-radius: var(--radius-2xl);

        border: 2px solid var(--primary-color);
        overflow: hidden;
    }

    .plan-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: var(--space-6);

        text-align: center;
    }

    .plan-name {
        font-size: 1.5rem;
        font-weight: var(--font-bold);

        margin-bottom: var(--space-1);

    }

    .plan-status {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1-5);

        padding: var(--space-1) var(--space-3);

        background: rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-2xl-plus);
        font-size: 0.85rem;
    }

    .plan-body {
        padding: var(--space-6);

    }

    .plan-price {
        text-align: center;
        margin-bottom: var(--space-6);

    }

    .plan-price-amount {
        font-size: 2.5rem;
        font-weight: var(--font-bold);

        color: var(--text-dark);
    }

    .plan-price-period {
        color: var(--text-muted);
    }

    .plan-features {
        list-style: none;
        margin-bottom: var(--space-6);

    }

    .plan-features li {
        display: flex;
        align-items: center;
        gap: var(--space-2-5);

        padding: var(--space-2-5) 0;

        border-bottom: 1px solid var(--border-color);
    }

    .plan-features li:last-child {
        border-bottom: none;
    }

    .plan-features .check {
        color: var(--success);
    }

    .usage-card {
        background: var(--white);
        border-radius: var(--radius-2xl);

        border: 1px solid var(--border-color);
        padding: var(--space-6);

    }

    .usage-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-5);

    }

    .usage-title {
        font-weight: var(--font-semibold);

        font-size: 1.1rem;
    }

    .usage-period {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .usage-bar-container {
        background: var(--bg-light);
        border-radius: var(--radius-lg);

        height: var(--space-3);

        overflow: hidden;
        margin-bottom: var(--space-3);

    }

    .usage-bar {
        height: 100%;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: var(--radius-lg);

        transition: width 0.5s ease;
    }

    .usage-stats {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
    }

    .usage-current {
        font-weight: var(--font-semibold);

        color: var(--primary-color);
    }

    .usage-limit {
        color: var(--text-muted);
    }

    .billing-section {
        background: var(--white);
        border-radius: var(--radius-xl);

        border: 1px solid var(--border-color);
        margin-bottom: var(--space-6);

    }

    .billing-section-header {
        padding: var(--space-5) var(--space-6);

        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .billing-section-title {
        font-weight: var(--font-semibold);

        font-size: 1.1rem;
    }

    .billing-section-body {
        padding: var(--space-6);

    }

    .payment-method {
        display: flex;
        align-items: center;
        gap: var(--space-4);

        padding: var(--space-4);

        background: var(--bg-light);
        border-radius: var(--radius-xl);

    }

    .card-icon {
        width: var(--space-12);

        height: var(--space-8);

        background: linear-gradient(135deg, #1a1f71, #00579f);
        border-radius: var(--radius-md);

        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.75rem;
    }

    .card-details {
        flex: 1;
    }

    .card-number {
        font-weight: var(--font-medium);

    }

    .card-expiry {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    .invoice-table {
        width: 100%;
        border-collapse: collapse;
    }

    .invoice-table th {
        text-align: left;
        padding: var(--space-3) 0;

        font-weight: var(--font-semibold);

        font-size: 0.85rem;
        color: var(--text-muted);
        border-bottom: 2px solid var(--border-color);
    }

    .invoice-table td {
        padding: var(--space-4) 0;

        border-bottom: 1px solid var(--border-color);
    }

    .invoice-status {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1-5);

        padding: var(--space-1) var(--space-2-5);

        border-radius: var(--radius-2xl-plus);
        font-size: 0.8rem;
        font-weight: var(--font-medium);

    }

    .invoice-status.paid {
        background: var(--color-success-100);
        color: var(--color-success-800);
    }

    .invoice-status.pending {
        background: var(--color-warning-100);
        color: var(--color-warning-800);
    }
</style>
{% endblock %}

{% block content %}
<div class="billing-grid">
    <div class="plan-card">
        <div class="plan-header">
            <div class="plan-name">{{ billing.plan }}</div>
            <span class="plan-status">{{ icon('check') }} {{ billing.status|capitalize }}</span>
        </div>
        <div class="plan-body">
            <div class="plan-price">
                <span class="plan-price-amount">${{ billing.amount }}</span>
                <span class="plan-price-period">/month</span>
            </div>
            <ul class="plan-features">
                <li><span class="check">{{ icon('check') }}</span> Up to {{ billing.leads_limit }} leads/month</li>
                <li><span class="check">{{ icon('check') }}</span> Lead scoring & prioritization</li>
                <li><span class="check">{{ icon('check') }}</span> Custom branding</li>
                <li><span class="check">{{ icon('check') }}</span> Analytics dashboard</li>
                <li><span class="check">{{ icon('check') }}</span> Email notifications</li>
            </ul>
            <button class="btn btn-secondary" style="width: 100%;">Change Plan</button>
        </div>
    </div>

    <div class="usage-card">
        <div class="usage-header">
            <div class="usage-title">Leads Usage</div>
            <div class="usage-period">This Month</div>
        </div>
        <div class="usage-bar-container">
            <div class="usage-bar" style="width: {{ (billing.leads_this_month / billing.leads_limit * 100)|int }}%;"></div>
        </div>
        <div class="usage-stats">
            <span class="usage-current">{{ billing.leads_this_month }} leads used</span>
            <span class="usage-limit">{{ billing.leads_limit }} limit</span>
        </div>
        <div style="margin-top: var(--space-6); padding-top: var(--space-6); border-top: 1px solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-3);">
                <span style="color: var(--text-muted);">Next billing date</span>
                <span style="font-weight: var(--font-medium);">{{ billing.next_billing }}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--text-muted);">Amount due</span>
                <span style="font-weight: var(--font-medium);">${{ billing.amount }}</span>
            </div>
        </div>
    </div>
</div>

<div class="billing-section">
    <div class="billing-section-header">
        <h3 class="billing-section-title">Payment Method</h3>
    </div>
    <div class="billing-section-body">
        <div class="payment-method">
            <div class="card-icon" style="background: linear-gradient(135deg, #5469d4, #7c3aed);">M</div>
            <div class="card-details">
                <div class="card-number" style="font-weight: var(--font-medium);">Payments via Mercury</div>
                <div class="card-expiry">Billing is managed through your Mercury wallet. Contact support for payment questions.</div>
            </div>
        </div>
    </div>
</div>

<div class="billing-section">
    <div class="billing-section-header">
        <h3 class="billing-section-title">Billing History</h3>
    </div>
    <div class="billing-section-body">
        {% if invoices and invoices|length > 0 %}
        <table class="invoice-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for inv in invoices %}
                <tr>
                    <td>{{ inv.date }}</td>
                    <td>{{ inv.description }}</td>
                    <td>${{ inv.amount }}</td>
                    <td><span class="invoice-status {{ inv.status }}">{{ icon('check') if inv.status == 'paid' else icon('clock') }} {{ inv.status|capitalize }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="text-align: center; padding: var(--space-8); color: var(--text-muted);">
            <p>No billing history yet. Invoices will appear here as payments are processed.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
