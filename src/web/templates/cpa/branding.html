{% extends "cpa/base.html" %}

{% block title %}Branding{% endblock %}
{% block page_title %}Lead Magnet Branding{% endblock %}

{% block extra_styles %}
<style>
    .branding-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: var(--space-8);

    }

    @media (max-width: 1200px) {
        .branding-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Form Cards */
    .form-card {
        background: var(--white);
        border-radius: var(--radius-2xl);

        border: 1px solid var(--border-color);
        margin-bottom: var(--space-6);

    }

    .form-card-header {
        padding: var(--space-5) var(--space-6);

        border-bottom: 1px solid var(--border-color);
    }

    .form-card-title {
        font-weight: var(--font-semibold);

        font-size: 1.1rem;
    }

    .form-card-body {
        padding: var(--space-6);

    }

    .form-group {
        margin-bottom: var(--space-5);

    }

    .form-label {
        display: block;
        font-weight: var(--font-medium);

        margin-bottom: var(--space-2);

        font-size: 0.9rem;
    }

    .form-input {
        width: 100%;
        padding: var(--space-3) var(--space-4);

        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg-plus);
        font-size: 0.95rem;
        transition: all 0.15s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-help {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: var(--space-1-5);

    }

    /* Color Picker */
    .color-picker-group {
        display: flex;
        gap: var(--space-4);

        flex-wrap: wrap;
    }

    .color-picker-item {
        flex: 1;
        min-width: 140px;
    }

    .color-input-wrapper {
        display: flex;
        align-items: center;
        gap: var(--space-3);

    }

    .color-preview {
        width: var(--space-12);

        height: var(--space-12);

        border-radius: var(--radius-lg-plus);
        border: 2px solid var(--border-color);
        cursor: pointer;
    }

    .color-input {
        opacity: 0;
        position: absolute;
        width: var(--space-12);

        height: var(--space-12);

        cursor: pointer;
    }

    .color-hex {
        flex: 1;
        padding: var(--space-2-5) var(--space-3-5);

        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);

        font-family: monospace;
        font-size: 0.9rem;
    }

    /* Logo Upload */
    .logo-upload {
        border: 2px dashed var(--border-color);
        border-radius: var(--radius-xl);

        padding: var(--space-8);

        text-align: center;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .logo-upload:hover {
        border-color: var(--primary-color);
        background: var(--bg-light);
    }

    .logo-upload-icon {
        font-size: 2.5rem;
        margin-bottom: var(--space-3);

    }

    .logo-upload-text {
        color: var(--text-muted);
        margin-bottom: var(--space-2);

    }

    .logo-upload-hint {
        font-size: 0.8rem;
        color: var(--text-light);
    }

    .logo-preview {
        display: flex;
        align-items: center;
        gap: var(--space-4);

        padding: var(--space-4);

        background: var(--bg-light);
        border-radius: var(--radius-xl);

    }

    .logo-preview img {
        width: 80px;
        height: 80px;
        border-radius: var(--radius-xl);

        object-fit: cover;
    }

    .logo-preview-actions {
        display: flex;
        gap: var(--space-2);

    }

    /* Preview Card */
    .preview-card {
        background: var(--white);
        border-radius: var(--radius-2xl);

        border: 1px solid var(--border-color);
        overflow: hidden;
        position: sticky;
        top: 88px;
    }

    .preview-header {
        padding: var(--space-4) var(--space-5);

        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .preview-title {
        font-weight: var(--font-semibold);

    }

    .preview-body {
        padding: 0;
    }

    .preview-iframe {
        width: 100%;
        height: 500px;
        border: none;
    }

    /* Link Share */
    .link-share {
        display: flex;
        gap: var(--space-3);

        align-items: center;
    }

    .link-input {
        flex: 1;
        padding: var(--space-3) var(--space-4);

        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg-plus);
        font-size: 0.9rem;
        background: var(--bg-light);
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: var(--space-3);

        padding-top: var(--space-5);

        border-top: 1px solid var(--border-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="branding-grid">
    <!-- Branding Forms -->
    <div>
        <!-- Lead Magnet Link -->
        <div class="form-card">
            <div class="form-card-header">
                <h3 class="form-card-title">Your Lead Magnet Link</h3>
            </div>
            <div class="form-card-body">
                <div class="form-group">
                    <label class="form-label">Shareable Link</label>
                    <div class="link-share">
                        <input type="text" class="link-input" id="leadMagnetLink" readonly
                               value="{{ request.url.scheme }}://{{ request.url.netloc }}/lead-magnet?cpa={{ cpa.cpa_slug or 'default' }}">
                        <button class="btn btn-primary" onclick="copyLink()">Copy Link</button>
                    </div>
                    <p class="form-help">Share this link on your website, email, or social media to capture leads</p>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">CPA Slug</label>
                    <input type="text" class="form-input" name="cpa_slug"
                           value="{{ cpa.cpa_slug or '' }}"
                           placeholder="john-smith-cpa" style="max-width: 300px;">
                    <p class="form-help">This creates your unique URL: /lead-magnet?cpa=your-slug</p>
                </div>
            </div>
        </div>

        <!-- Brand Colors -->
        <div class="form-card">
            <div class="form-card-header">
                <h3 class="form-card-title">Brand Colors</h3>
            </div>
            <div class="form-card-body">
                <div class="color-picker-group">
                    <div class="color-picker-item">
                        <label class="form-label">Primary Color</label>
                        <div class="color-input-wrapper">
                            <div style="position: relative;">
                                <input type="color" class="color-input" id="primaryColor"
                                       value="{{ cpa.primary_color or '#1e3a5f' }}"
                                       onchange="updateColorPreview('primary', this.value)">
                                <div class="color-preview" id="primaryPreview"
                                     style="background: {{ cpa.primary_color or '#1e3a5f' }}"
                                     onclick="document.getElementById('primaryColor').click()"></div>
                            </div>
                            <input type="text" class="color-hex" id="primaryHex"
                                   value="{{ cpa.primary_color or '#1e3a5f' }}"
                                   onchange="updateColorFromHex('primary', this.value)">
                        </div>
                    </div>

                    <div class="color-picker-item">
                        <label class="form-label">Secondary Color</label>
                        <div class="color-input-wrapper">
                            <div style="position: relative;">
                                <input type="color" class="color-input" id="secondaryColor"
                                       value="{{ cpa.secondary_color or '#152b47' }}"
                                       onchange="updateColorPreview('secondary', this.value)">
                                <div class="color-preview" id="secondaryPreview"
                                     style="background: {{ cpa.secondary_color or '#152b47' }}"
                                     onclick="document.getElementById('secondaryColor').click()"></div>
                            </div>
                            <input type="text" class="color-hex" id="secondaryHex"
                                   value="{{ cpa.secondary_color or '#152b47' }}"
                                   onchange="updateColorFromHex('secondary', this.value)">
                        </div>
                    </div>

                    <div class="color-picker-item">
                        <label class="form-label">Accent Color</label>
                        <div class="color-input-wrapper">
                            <div style="position: relative;">
                                <input type="color" class="color-input" id="accentColor"
                                       value="{{ cpa.accent_color or '#10b981' }}"
                                       onchange="updateColorPreview('accent', this.value)">
                                <div class="color-preview" id="accentPreview"
                                     style="background: {{ cpa.accent_color or '#10b981' }}"
                                     onclick="document.getElementById('accentColor').click()"></div>
                            </div>
                            <input type="text" class="color-hex" id="accentHex"
                                   value="{{ cpa.accent_color or '#10b981' }}"
                                   onchange="updateColorFromHex('accent', this.value)">
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="resetColors()">Reset to Default</button>
                    <button type="button" class="btn btn-primary" onclick="saveColors()">Save Colors</button>
                </div>
            </div>
        </div>

        <!-- Logo & Images -->
        <div class="form-card">
            <div class="form-card-header">
                <h3 class="form-card-title">Logo & Images</h3>
            </div>
            <div class="form-card-body">
                <div class="form-group">
                    <label class="form-label">Firm Logo</label>
                    {% if cpa.logo_url %}
                    <div class="logo-preview">
                        <img src="{{ cpa.logo_url }}" alt="Logo">
                        <div>
                            <p style="font-weight: var(--font-medium); margin-bottom: var(--space-2);">Current Logo</p>
                            <div class="logo-preview-actions">
                                <button class="btn btn-secondary btn-sm" onclick="changeLogo()">Change</button>
                                <button class="btn btn-secondary btn-sm" onclick="removeLogo()">Remove</button>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="logo-upload" onclick="document.getElementById('logoInput').click()">
                        <input type="file" id="logoInput" hidden accept="image/*" onchange="uploadLogo(this)">
                        <div class="logo-upload-icon">üñºÔ∏è</div>
                        <p class="logo-upload-text">Click to upload your logo</p>
                        <p class="logo-upload-hint">PNG, JPG, or WebP ‚Ä¢ Max 5MB ‚Ä¢ Recommended: 200x200px</p>
                    </div>
                    {% endif %}
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Favicon</label>
                    <input type="text" class="form-input" name="favicon_url"
                           value="{{ cpa.favicon_url or '' }}"
                           placeholder="https://example.com/favicon.ico">
                    <p class="form-help">Browser tab icon (32x32px recommended)</p>
                </div>
            </div>
        </div>

        <!-- Welcome Message -->
        <div class="form-card">
            <div class="form-card-header">
                <h3 class="form-card-title">Welcome Message</h3>
            </div>
            <div class="form-card-body">
                <div class="form-group">
                    <label class="form-label">Headline</label>
                    <input type="text" class="form-input" name="headline"
                           value="{{ cpa.headline or '' }}"
                           placeholder="Discover Your Tax Savings Potential">
                </div>

                <div class="form-group">
                    <label class="form-label">Tagline</label>
                    <input type="text" class="form-input" name="tagline"
                           value="{{ cpa.tagline or '' }}"
                           placeholder="Get a free personalized tax analysis in under 5 minutes">
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Welcome Message</label>
                    <textarea class="form-input" name="welcome_message" rows="3"
                              placeholder="Welcome! I'm here to help you maximize your tax savings...">{{ cpa.welcome_message or '' }}</textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveBranding()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Preview -->
    <div>
        <div class="preview-card">
            <div class="preview-header">
                <span class="preview-title">Live Preview</span>
                <a href="/lead-magnet?cpa={{ cpa.cpa_slug or 'default' }}" target="_blank" class="btn btn-secondary btn-sm">
                    Open in New Tab ‚Üó
                </a>
            </div>
            <div class="preview-body">
                <iframe src="/lead-magnet?cpa={{ cpa.cpa_slug or 'default' }}" class="preview-iframe" id="previewFrame"></iframe>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function copyLink() {
        const linkInput = document.getElementById('leadMagnetLink');
        navigator.clipboard.writeText(linkInput.value).then(function() {
            showToast('Link copied to clipboard!', 'success');
        });
    }

    function updateColorPreview(type, value) {
        document.getElementById(type + 'Preview').style.background = value;
        document.getElementById(type + 'Hex').value = value;
        refreshPreview();
    }

    function updateColorFromHex(type, value) {
        if (/^#[0-9A-F]{6}$/i.test(value)) {
            document.getElementById(type + 'Color').value = value;
            document.getElementById(type + 'Preview').style.background = value;
            refreshPreview();
        }
    }

    function resetColors() {
        updateColorPreview('primary', '#1e3a5f');
        updateColorPreview('secondary', '#152b47');
        updateColorPreview('accent', '#10b981');
    }

    function getAuthHeaders(json = true) {
        const headers = {};
        const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
        if (token) headers['Authorization'] = 'Bearer ' + token;
        const csrf = document.querySelector('meta[name="csrf-token"]');
        if (csrf) headers['X-CSRFToken'] = csrf.content;
        if (json) headers['Content-Type'] = 'application/json';
        return headers;
    }

    async function saveColors() {
        const colors = {
            primary_color: document.getElementById('primaryColor').value,
            secondary_color: document.getElementById('secondaryColor').value,
            accent_color: document.getElementById('accentColor').value
        };

        try {
            const response = await fetch('/api/cpa/branding/my-branding', {
                method: 'PATCH',
                headers: getAuthHeaders(),
                body: JSON.stringify(colors),
                credentials: 'same-origin'
            });

            if (response.status === 401) { window.location.href = '/cpa/login'; return; }
            if (!response.ok) throw new Error('Failed to save colors');

            showNotification('Colors saved successfully!', 'success');
            refreshPreview();
        } catch (error) {
            console.error('Save colors error:', error);
            showNotification('Error saving colors: ' + error.message, 'error');
        }
    }

    async function saveBranding() {
        const data = {};
        document.querySelectorAll('.form-card input[name], .form-card textarea[name]').forEach(el => {
            if (el.name && el.value) data[el.name] = el.value;
        });

        try {
            const response = await fetch('/api/cpa/branding/my-branding', {
                method: 'PATCH',
                headers: getAuthHeaders(),
                body: JSON.stringify(data),
                credentials: 'same-origin'
            });

            if (response.status === 401) { window.location.href = '/cpa/login'; return; }
            if (!response.ok) throw new Error('Failed to save branding');

            showNotification('Branding settings saved!', 'success');
            refreshPreview();
        } catch (error) {
            console.error('Save branding error:', error);
            showNotification('Error saving branding: ' + error.message, 'error');
        }
    }

    function refreshPreview() {
        const iframe = document.getElementById('previewFrame');
        if (iframe) {
            iframe.src = iframe.src;
        }
    }

    function changeLogo() {
        document.getElementById('logoInput').click();
    }

    async function uploadLogo(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];

        // Validate file
        if (!file.type.startsWith('image/')) {
            showNotification('Please select an image file', 'error');
            return;
        }
        if (file.size > 5 * 1024 * 1024) {
            showNotification('File size must be under 5MB', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('logo', file);

        try {
            showNotification('Uploading logo...', 'info');

            const response = await fetch('/api/cpa/branding/my-branding/firm-logo', {
                method: 'POST',
                headers: getAuthHeaders(false),
                body: formData,
                credentials: 'same-origin'
            });

            if (!response.ok) throw new Error('Failed to upload logo');

            const result = await response.json();

            // Update logo preview
            const logoPreview = document.querySelector('.logo-preview img, .logo-preview');
            if (result.logo_url && logoPreview) {
                if (logoPreview.tagName === 'IMG') {
                    logoPreview.src = result.logo_url;
                } else {
                    logoPreview.innerHTML = `<img src="${result.logo_url}" alt="Logo" style="max-width: 100%; max-height: 100%;">`;
                }
            }

            showNotification('Logo uploaded successfully!', 'success');
            refreshPreview();
        } catch (error) {
            console.error('Upload logo error:', error);
            showNotification('Error uploading logo: ' + error.message, 'error');
        }
    }

    async function removeLogo() {
        if (!confirm('Remove your logo? This action cannot be undone.')) return;

        try {
            const response = await fetch('/api/cpa/branding/my-branding/firm-logo', {
                method: 'DELETE',
                headers: getAuthHeaders(),
                credentials: 'same-origin'
            });

            if (!response.ok) throw new Error('Failed to remove logo');

            // Reset logo preview
            const logoPreview = document.querySelector('.logo-preview');
            if (logoPreview) {
                logoPreview.innerHTML = '<span class="placeholder-text">Your Logo</span>';
            }

            showNotification('Logo removed', 'success');
            refreshPreview();
        } catch (error) {
            console.error('Remove logo error:', error);
            showNotification('Error removing logo: ' + error.message, 'error');
        }
    }

    function showNotification(message, type) {
        // Remove existing notifications
        document.querySelectorAll('.notification-toast').forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = 'notification-toast notification-' + type;
        notification.textContent = message;
        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => notification.classList.add('show'), 10);

        // Remove after delay
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
</script>
{% endblock %}
