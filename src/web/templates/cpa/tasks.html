{% extends "cpa/base.html" %}
{% from 'macros/icons.html' import icon %}

{% block title %}Tasks{% endblock %}
{% block page_title %}{{ page_title|default('Task Management') }}{% endblock %}

{% block extra_styles %}
<style>
    .tasks-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-6);

        flex-wrap: wrap;
        gap: var(--space-3);

    }
    .tasks-filters { display: flex; gap: var(--space-2); flex-wrap: wrap; }
    .filter-btn {
        padding: var(--space-2) var(--space-4);

        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);

        background: var(--white);
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
        color: var(--text-dark);
    }
    .filter-btn:hover, .filter-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    .task-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-4);

        margin-bottom: var(--space-6);

    }
    .stat-card {
        background: var(--white);
        border-radius: var(--radius-xl);

        padding: var(--space-5);

        border: 1px solid var(--border-color);
    }
    .stat-value {
        font-size: 2rem;
        font-weight: var(--font-bold);

        color: var(--primary-color);
    }
    .stat-label {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: var(--space-1);

    }
    .task-list {
        background: var(--white);
        border-radius: var(--radius-xl);

        border: 1px solid var(--border-color);
    }
    .task-item {
        display: flex;
        align-items: center;
        padding: var(--space-4) var(--space-5);

        border-bottom: 1px solid var(--border-color);
        gap: var(--space-4);

        transition: background 0.15s;
    }
    .task-item:last-child { border-bottom: none; }
    .task-item:hover { background: var(--bg-light); }
    .task-item.completed .task-title { text-decoration: line-through; color: var(--text-muted); }
    .task-checkbox {
        width: 22px; height: 22px; min-width: 22px;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);

        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.15s;
        background: var(--white);
        color: transparent;
    }
    .task-checkbox:hover { border-color: var(--primary-color); }
    .task-checkbox.done {
        background: var(--success-color);
        border-color: var(--success-color);
        color: white;
    }
    .task-content { flex: 1; min-width: 0; }
    .task-title { font-weight: 500; margin-bottom: var(--space-1); }
    .task-desc {
        font-size: 0.85rem;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .task-meta {
        display: flex;
        align-items: center;
        gap: var(--space-4);

        flex-shrink: 0;
        flex-wrap: wrap;
    }
    .task-priority {
        padding: var(--space-1) var(--space-2-5);

        border-radius: var(--radius-2xl-plus);
        font-size: 0.75rem;
        font-weight: var(--font-semibold);

        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    .priority-high { background: var(--color-error-100); color: var(--color-error-600); }
    .priority-medium { background: var(--color-warning-100); color: #d97706; }
    .priority-low { background: var(--color-success-100); color: var(--color-success-600); }
    .task-due {
        font-size: 0.85rem;
        color: var(--text-muted);
        white-space: nowrap;
    }
    .task-due.overdue { color: var(--color-error-600); font-weight: var(--font-semibold); }
    .task-assignee {
        display: flex; align-items: center; gap: var(--space-1-5);
        font-size: 0.85rem; color: var(--text-muted);
    }
    .assignee-avatar {
        width: 24px; height: 24px; border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color, #6366f1));
        display: flex; align-items: center; justify-content: center;
        color: white; font-weight: var(--font-semibold); font-size: 0.65rem;
    }
    .task-client {
        font-size: 0.8rem;
        color: var(--text-muted);
        background: var(--bg-light);
        padding: var(--space-0-5) var(--space-2);

        border-radius: var(--radius-base);
    }
    .task-actions {
        display: flex; gap: var(--space-1); flex-shrink: 0;
    }
    .task-actions button {
        background: none; border: none; cursor: pointer;
        padding: var(--space-1-5); border-radius: var(--radius-md);

        color: var(--text-muted); transition: all 0.15s;
        display: flex; align-items: center;
    }
    .task-actions button:hover { background: var(--bg-light); color: var(--text-dark); }
    .task-actions button.delete-btn:hover { color: var(--color-error-600); }
    .empty-state {
        text-align: center;
        padding: 60px var(--space-5);

        color: var(--text-muted);
    }
    .empty-state svg { width: 48px; height: 48px; margin-bottom: var(--space-3); opacity: 0.4; }
    .empty-state h3 { font-size: 1.1rem; color: var(--text-dark); margin-bottom: var(--space-1-5); }
    .add-task-btn {
        background: var(--primary-color); color: white; border: none;
        padding: var(--space-2-5) var(--space-5); border-radius: var(--radius-lg); cursor: pointer;

        font-weight: var(--font-medium); display: inline-flex; align-items: center; gap: var(--space-2);
        font-size: 0.9rem; transition: all 0.15s;
    }
    .add-task-btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
    /* Modal */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.45);
        z-index: 100; display: flex; align-items: center; justify-content: center;
        padding: var(--space-4);

    }
    .modal {
        background: var(--white); border-radius: var(--radius-xl);
        width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    }
    .modal-header {
        display: flex; align-items: center; justify-content: space-between;
        padding: var(--space-5) var(--space-6); border-bottom: 1px solid var(--border-color);

    }
    .modal-header h2 { font-size: 1.1rem; font-weight: var(--font-semibold); }
    .modal-close {
        background: none; border: none; cursor: pointer;
        color: var(--text-muted); padding: var(--space-1); border-radius: var(--radius-md);
        display: flex; transition: all 0.15s;
    }
    .modal-close:hover { background: var(--bg-light); color: var(--text-dark); }
    .modal-body { padding: 24px; }
    .form-group { margin-bottom: 16px; }
    .form-group label {
        display: block; font-size: 0.85rem; font-weight: var(--font-medium);
        color: var(--text-dark); margin-bottom: var(--space-1-5);
    }
    .form-group input, .form-group select, .form-group textarea {
        width: 100%; padding: var(--space-2-5) var(--space-3); border: 1px solid var(--border-color);
        border-radius: var(--radius-lg); font-size: 0.9rem; font-family: inherit;

        background: var(--white); transition: border-color 0.15s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        outline: none; border-color: var(--primary-color);
    }
    .form-group textarea { resize: vertical; min-height: 72px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); }
    .modal-footer {
        padding: var(--space-4) var(--space-6); border-top: 1px solid var(--border-color);

        display: flex; justify-content: flex-end; gap: var(--space-2);
    }
    .btn-cancel {
        padding: var(--space-2-5) var(--space-5); border-radius: var(--radius-lg); border: 1px solid var(--border-color);

        background: var(--white); cursor: pointer; font-size: 0.9rem;
        color: var(--text-dark); transition: all 0.15s;
    }
    .btn-cancel:hover { background: var(--bg-light); }
    .btn-save {
        padding: var(--space-2-5) var(--space-5); border-radius: var(--radius-lg); border: none;

        background: var(--primary-color); color: white; cursor: pointer;
        font-size: 0.9rem; font-weight: var(--font-medium); transition: all 0.15s;
    }
    .btn-save:hover { background: var(--primary-hover); }
    /* Toast */
    .toast {
        position: fixed; bottom: 24px; right: 24px; z-index: 200;
        background: var(--color-gray-800); color: white; padding: var(--space-3-5) var(--space-5);
        border-radius: var(--radius-lg-plus); font-size: 0.9rem; box-shadow: 0 var(--radius-lg) var(--radius-3xl) rgba(0,0,0,0.2);

        display: flex; align-items: center; gap: var(--space-2-5);
        transform: translateY(100px); opacity: 0;
        transition: all 0.3s ease;
    }
    .toast.visible { transform: translateY(0); opacity: 1; }
    .toast svg { color: var(--color-success-400); }
    @media (max-width: 768px) {
        .task-stats { grid-template-columns: repeat(2, 1fr); }
        .task-meta { gap: 8px; }
        .task-client, .task-assignee { display: none; }
        .form-row { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-6); font-size: 0.9rem;">
    <a href="/cpa/dashboard" style="color: var(--text-muted, #6b7280); text-decoration: none;">Dashboard</a>
    <span style="color: var(--text-light, #9ca3af);">&rsaquo;</span>
    <span style="color: var(--text-dark, #1f2937); font-weight: var(--font-medium);">Tasks</span>
</div>
{% endblock %}

{% block content %}
<div x-data="taskManager()">
    <!-- Header -->
    <div class="tasks-header">
        <div class="tasks-filters">
            <template x-for="f in filters" :key="f.key">
                <button class="filter-btn" :class="{ active: activeFilter === f.key }"
                    @click="activeFilter = f.key" x-text="f.label"></button>
            </template>
        </div>
        <button class="add-task-btn" @click="openAdd()">
            {{ icon('plus') }} Add Task
        </button>
    </div>

    <!-- Stats -->
    <div class="task-stats">
        <div class="stat-card">
            <div class="stat-value" x-text="tasks.length"></div>
            <div class="stat-label">Total Tasks</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" x-text="tasks.filter(t => !t.completed).length"></div>
            <div class="stat-label">In Progress</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" x-text="tasks.filter(t => isDueToday(t) && !t.completed).length"></div>
            <div class="stat-label">Due Today</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: var(--success-color)" x-text="tasks.filter(t => t.completed).length"></div>
            <div class="stat-label">Completed</div>
        </div>
    </div>

    <!-- Task List -->
    <div class="task-list">
        <template x-if="filteredTasks().length === 0">
            <div class="empty-state">
                {{ icon('clipboard-list', 'xl') }}
                <h3>No tasks match this filter</h3>
                <p>Try a different filter or create a new task.</p>
            </div>
        </template>
        <template x-for="task in filteredTasks()" :key="task.id">
            <div class="task-item" :class="{ completed: task.completed }">
                <div class="task-checkbox" :class="{ done: task.completed }"
                     @click="toggleComplete(task.id)">
                    <template x-if="task.completed">
                        {{ icon('check', 'sm') }}
                    </template>
                </div>
                <div class="task-content">
                    <div class="task-title" x-text="task.title"></div>
                    <div class="task-desc" x-text="task.description"></div>
                </div>
                <div class="task-meta">
                    <span class="task-client" x-text="task.client"></span>
                    <span class="task-priority" :class="'priority-' + task.priority" x-text="task.priority"></span>
                    <span class="task-due" :class="{ overdue: isOverdue(task) && !task.completed }"
                          x-text="formatDue(task.dueDate)"></span>
                    <span class="task-assignee">
                        <span class="assignee-avatar" x-text="task.assignedTo.charAt(0)"></span>
                        <span x-text="task.assignedTo.split(' ')[0]"></span>
                    </span>
                </div>
                <div class="task-actions">
                    <button @click="openEdit(task)" title="Edit">{{ icon('pencil', 'sm') }}</button>
                    <button class="delete-btn" @click="deleteTask(task.id)" title="Delete">{{ icon('trash', 'sm') }}</button>
                </div>
            </div>
        </template>
    </div>

    <!-- Modal -->
    <template x-if="showModal">
        <div class="modal-overlay" @click.self="showModal = false" @keydown.escape.window="showModal = false">
            <div class="modal" @click.stop>
                <div class="modal-header">
                    <h2 x-text="editingId ? 'Edit Task' : 'Add New Task'"></h2>
                    <button class="modal-close" @click="showModal = false">{{ icon('x-mark') }}</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="taskTitle">Title</label>
                        <input id="taskTitle" type="text" x-model="form.title" placeholder="e.g. Review Q4 financials">
                    </div>
                    <div class="form-group">
                        <label for="taskDesc">Description</label>
                        <textarea id="taskDesc" x-model="form.description" placeholder="Details about this task..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskPriority">Priority</label>
                            <select id="taskPriority" x-model="form.priority">
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskDue">Due Date</label>
                            <input id="taskDue" type="date" x-model="form.dueDate">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskAssign">Assign To</label>
                            <select id="taskAssign" x-model="form.assignedTo">
                                <template x-for="m in teamMembers" :key="m">
                                    <option :value="m" x-text="m"></option>
                                </template>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskClient">Client</label>
                            <select id="taskClient" x-model="form.client">
                                <template x-for="c in clientList" :key="c">
                                    <option :value="c" x-text="c"></option>
                                </template>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel" @click="showModal = false">Cancel</button>
                    <button class="btn-save" @click="saveTask()" x-text="editingId ? 'Update Task' : 'Create Task'"></button>
                </div>
            </div>
        </div>
    </template>

    <!-- Toast -->
    <div class="toast" :class="{ visible: toast.show }">
        {{ icon('check-circle', 'sm') }}
        <span x-text="toast.message"></span>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function taskManager() {
    const today = new Date(); today.setHours(0,0,0,0);
    const fmt = (d) => d.toISOString().split('T')[0];
    const addDays = (d, n) => { const r = new Date(d); r.setDate(r.getDate() + n); return r; };

    return {
        activeFilter: 'all',
        showModal: false,
        editingId: null,
        toast: { show: false, message: '' },
        currentUser: '',
        filters: [
            { key: 'all', label: 'All Tasks' },
            { key: 'mine', label: 'My Tasks' },
            { key: 'today', label: 'Due Today' },
            { key: 'overdue', label: 'Overdue' }
        ],
        teamMembers: [],
        clientList: [],
        form: { title: '', description: '', priority: 'medium', dueDate: '', assignedTo: '', client: '' },
        tasks: [],

        isDueToday(task) {
            return task.dueDate === fmt(today);
        },
        isOverdue(task) {
            return new Date(task.dueDate + 'T00:00:00') < today;
        },
        filteredTasks() {
            let list = this.tasks;
            if (this.activeFilter === 'mine') list = list.filter(t => t.assignedTo === this.currentUser);
            else if (this.activeFilter === 'today') list = list.filter(t => this.isDueToday(t) && !t.completed);
            else if (this.activeFilter === 'overdue') list = list.filter(t => this.isOverdue(t) && !t.completed);
            return list.sort((a, b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                const pri = { high: 0, medium: 1, low: 2 };
                return pri[a.priority] - pri[b.priority] || new Date(a.dueDate) - new Date(b.dueDate);
            });
        },
        formatDue(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            const diff = Math.round((d - today) / 86400000);
            const label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            if (diff < 0) return label + ' (overdue)';
            if (diff === 0) return 'Today';
            if (diff === 1) return 'Tomorrow';
            return label;
        },
        toggleComplete(id) {
            const task = this.tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                this.showToast(task.completed ? 'Task marked complete' : 'Task reopened');
            }
        },
        openAdd() {
            this.editingId = null;
            this.form = { title: '', description: '', priority: 'medium', dueDate: fmt(addDays(today, 7)), assignedTo: this.currentUser, client: this.clientList[0] };
            this.showModal = true;
        },
        openEdit(task) {
            this.editingId = task.id;
            this.form = { title: task.title, description: task.description, priority: task.priority, dueDate: task.dueDate, assignedTo: task.assignedTo, client: task.client };
            this.showModal = true;
        },
        saveTask() {
            if (!this.form.title.trim()) return;
            if (this.editingId) {
                const task = this.tasks.find(t => t.id === this.editingId);
                if (task) Object.assign(task, { ...this.form });
                this.showToast('Task updated');
            } else {
                this.tasks.push({ id: Date.now(), ...this.form, completed: false });
                this.showToast('Task created');
            }
            this.showModal = false;
        },
        deleteTask(id) {
            this.tasks = this.tasks.filter(t => t.id !== id);
            this.showToast('Task deleted');
        },
        showToast(msg) {
            this.toast.message = msg;
            this.toast.show = true;
            setTimeout(() => { this.toast.show = false; }, 2500);
        }
    };
}
</script>
{% endblock %}
