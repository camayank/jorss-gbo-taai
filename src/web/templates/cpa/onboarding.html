{% extends "cpa/base.html" %}
{% from 'macros/icons.html' import icon %}

{% block title %}Launch Setup{% endblock %}
{% block page_title %}Launch Setup Wizard{% endblock %}

{% block extra_styles %}
<style>
    .wizard-summary {
        background: linear-gradient(135deg, var(--color-accent-700), #115e59);
        color: var(--white);
        border-radius: var(--radius-2xl);

        padding: var(--space-6);

        margin-bottom: var(--space-6);

    }

    .wizard-summary h2 {
        margin: 0 0 var(--space-2) 0;

        font-size: 1.4rem;
        font-weight: var(--font-bold);

    }

    .wizard-summary p {
        margin: 0 0 var(--space-4) 0;

        opacity: 0.9;
    }

    .progress-row {
        display: flex;
        align-items: center;
        gap: var(--space-3);

    }

    .progress-track {
        flex: 1;
        height: var(--space-2-5);

        background: rgba(255, 255, 255, 0.25);
        border-radius: var(--radius-full);
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: var(--color-warning-200);

        border-radius: var(--radius-full);
        transition: width 0.3s ease;
    }

    .progress-label {
        font-size: 0.9rem;
        font-weight: var(--font-semibold);

        white-space: nowrap;
    }

    .step-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 18px;
    }

    .step-card {
        background: var(--white);
        border: 1px solid #dbe6f2;
        border-radius: 14px;
        padding: var(--space-5);

        display: flex;
        flex-direction: column;
        gap: var(--space-3-5);

    }

    .step-card.complete {
        border-color: #16a34a;
        box-shadow: 0 8px 24px rgba(22, 163, 74, 0.12);
    }

    .step-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-3);

    }

    .step-title {
        margin: 0;
        font-size: 1.05rem;
        font-weight: var(--font-bold);

        color: var(--color-slate-900);
    }

    .status-chip {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1-5);

        font-size: 0.8rem;
        font-weight: var(--font-bold);

        border-radius: var(--radius-full);
        padding: 5px var(--space-2-5);

        border: 1px solid var(--color-slate-300);
        color: var(--color-slate-600);
        background: #f8fafc;
    }

    .status-chip.complete {
        border-color: #16a34a;
        background: #dcfce7;
        color: #166534;
    }

    .step-description {
        margin: 0;
        color: var(--color-slate-600);
        font-size: 0.92rem;
    }

    .step-checks {
        margin: 0;
        padding: 0;
        list-style: none;
        display: grid;
        gap: var(--space-2);

    }

    .step-checks li {
        display: flex;
        align-items: center;
        gap: var(--space-2);

        color: var(--color-slate-800);
        font-size: 0.9rem;
    }

    .check-done {
        color: #16a34a;
    }

    .check-pending {
        color: var(--color-warning-500);
    }

    .step-actions {
        display: flex;
        gap: var(--space-2-5);

        flex-wrap: wrap;
    }

    .action-btn {
        display: inline-flex;
        align-items: center;
        gap: 7px;
        border-radius: 10px;
        border: 1px solid var(--color-slate-300);
        color: var(--color-slate-900);
        text-decoration: none;
        padding: 9px var(--space-3);

        font-size: 0.88rem;
        font-weight: var(--font-semibold);

        background: var(--white);
    }

    .action-btn.primary {
        border-color: var(--color-accent-700);
        background: var(--color-accent-700);
        color: var(--white);
    }

    .embed-box {
        border: 1px solid var(--color-slate-200);
        background: #f8fafc;
        border-radius: var(--radius-xl);

        padding: var(--space-3-5);

    }

    .embed-box pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
        font-size: 0.82rem;
        color: var(--color-slate-900);
    }

    .embed-meta {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2-5);

        align-items: center;
    }

    @media (max-width: 640px) {
        .wizard-summary {
            padding: 18px;
        }
    }
</style>
{% endblock %}

{% block content %}
<section class="wizard-summary">
    <h2>Complete Launch Setup</h2>
    <p>Finish all three steps to make your white-label lead funnel production-ready for CPA outreach.</p>
    <div class="progress-row">
        <div class="progress-track">
            <div class="progress-fill" style="width: {{ onboarding.progress }}%;"></div>
        </div>
        <div class="progress-label">{{ onboarding.completed_steps }}/{{ onboarding.total_steps }} complete</div>
    </div>
</section>

<section class="step-grid">
    <article class="step-card {% if onboarding.step1_complete %}complete{% endif %}">
        <div class="step-header">
            <h3 class="step-title">Step 1: Firm Profile & Branding</h3>
            <span class="status-chip {% if onboarding.step1_complete %}complete{% endif %}">
                {% if onboarding.step1_complete %}{{ icon('check') }} Complete{% else %}Pending{% endif %}
            </span>
        </div>
        <p class="step-description">Set client-facing identity details used in the widget and report exports.</p>
        <ul class="step-checks">
            <li>
                <span class="{% if cpa.firm_name %}check-done{% else %}check-pending{% endif %}">
                    {{ icon('check-circle' if cpa.firm_name else 'exclamation-triangle') }}
                </span>
                Firm name
            </li>
            <li>
                <span class="{% if cpa.email %}check-done{% else %}check-pending{% endif %}">
                    {{ icon('check-circle' if cpa.email else 'exclamation-triangle') }}
                </span>
                Contact email
            </li>
            <li>
                <span class="{% if cpa.logo_url %}check-done{% else %}check-pending{% endif %}">
                    {{ icon('check-circle' if cpa.logo_url else 'exclamation-triangle') }}
                </span>
                Logo / visual branding
            </li>
        </ul>
        <div class="step-actions">
            <a class="action-btn primary" href="/cpa/profile">{{ icon('pencil') }} Update Profile</a>
            <a class="action-btn" href="/cpa/branding">{{ icon('sparkles') }} Branding</a>
        </div>
    </article>

    <article class="step-card {% if onboarding.step2_complete %}complete{% endif %}">
        <div class="step-header">
            <h3 class="step-title">Step 2: Lead Routing & Booking</h3>
            <span class="status-chip {% if onboarding.step2_complete %}complete{% endif %}">
                {% if onboarding.step2_complete %}{{ icon('check') }} Complete{% else %}Pending{% endif %}
            </span>
        </div>
        <p class="step-description">Configure where warm leads go and how prospects can book a consultation.</p>
        <ul class="step-checks">
            <li>
                <span class="{% if cpa.email %}check-done{% else %}check-pending{% endif %}">
                    {{ icon('check-circle' if cpa.email else 'exclamation-triangle') }}
                </span>
                Routing email
            </li>
            <li>
                <span class="{% if cpa.booking_link %}check-done{% else %}check-pending{% endif %}">
                    {{ icon('check-circle' if cpa.booking_link else 'exclamation-triangle') }}
                </span>
                Calendar booking link
            </li>
            <li>
                <span class="check-done">{{ icon('check-circle') }}</span>
                Lead notifications enabled
            </li>
        </ul>
        <div class="step-actions">
            <a class="action-btn primary" href="/cpa/profile">{{ icon('calendar') }} Set Booking Link</a>
            <a class="action-btn" href="/cpa/settings">{{ icon('cog-6-tooth') }} Notifications</a>
        </div>
    </article>

    <article class="step-card {% if onboarding.step3_complete %}complete{% endif %}">
        <div class="step-header">
            <h3 class="step-title">Step 3: Embed & Verify</h3>
            <span class="status-chip {% if onboarding.step3_complete %}complete{% endif %}">
                {% if onboarding.step3_complete %}{{ icon('check') }} Complete{% else %}Pending{% endif %}
            </span>
        </div>
        <p class="step-description">Install the widget snippet on your website and validate first lead capture.</p>

        <div class="embed-box">
            <pre id="embedSnippet">{{ onboarding.embed_snippet }}</pre>
        </div>
        <div class="embed-meta">
            <a class="action-btn primary" href="#" onclick="copyEmbedSnippet(event)">{{ icon('clipboard-document-list') }} Copy Snippet</a>
            <a class="action-btn" href="{{ onboarding.landing_url }}" target="_blank" rel="noopener">{{ icon('arrow-up-tray') }} Open Test Link</a>
        </div>

        <ul class="step-checks">
            <li>
                <span class="check-done">{{ icon('check-circle') }}</span>
                Embed snippet generated for slug: <strong>{{ cpa.cpa_slug or 'default' }}</strong>
            </li>
            <li>
                <span class="{% if onboarding.step3_complete %}check-done{% else %}check-pending{% endif %}">
                    {{ icon('check-circle' if onboarding.step3_complete else 'exclamation-triangle') }}
                </span>
                Verification by first captured lead (current: {{ onboarding.lead_count }})
            </li>
        </ul>
    </article>
</section>

<script>
    function copyEmbedSnippet(event) {
        event.preventDefault();
        const snippet = document.getElementById('embedSnippet').textContent || '';
        navigator.clipboard.writeText(snippet).then(() => {
            const btn = event.currentTarget;
            const original = btn.innerHTML;
            btn.innerHTML = 'Copied';
            setTimeout(() => { btn.innerHTML = original; }, 1200);
        }).catch(() => {});
    }
</script>
{% endblock %}
