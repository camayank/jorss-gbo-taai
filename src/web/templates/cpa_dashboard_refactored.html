{% from 'macros/icons.html' import icon %}
<!DOCTYPE html>
<html lang="en" data-theme="cpa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1e40af">
  <meta name="description" content="CA4CPA GLOBAL LLC - Tax Advisory Intelligence">
  <meta name="csrf-token" content="{{ request.state.csrf_token if request and request.state and request.state.csrf_token else (csrf_token() if csrf_token else '') }}">
  <title>CA4CPA GLOBAL | Tax Advisory Dashboard</title>

  <!-- Preconnect for performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Core CSS -->
  <link rel="stylesheet" href="/static/css/core/variables.css">
  <link rel="stylesheet" href="/static/css/core/reset.css">
  <link rel="stylesheet" href="/static/css/core/typography.css">
  <link rel="stylesheet" href="/static/css/core/layout.css">
  <link rel="stylesheet" href="/static/css/core/animations.css">

  <!-- Component CSS -->
  <link rel="stylesheet" href="/static/css/components/buttons.css">
  <link rel="stylesheet" href="/static/css/components/cards.css">
  <link rel="stylesheet" href="/static/css/components/forms.css">
  <link rel="stylesheet" href="/static/css/components/modals.css">
  <link rel="stylesheet" href="/static/css/components/tables.css">
  <link rel="stylesheet" href="/static/css/components/navigation.css">
  <link rel="stylesheet" href="/static/css/components/toast.css">

  <!-- Theme CSS -->
  <link rel="stylesheet" href="/static/css/themes/cpa.css">

  <!-- Page-specific CSS -->
  <link rel="stylesheet" href="/static/css/pages/cpa-dashboard.css">

  <!-- Alpine.js cloak -->
  <style>[x-cloak] { display: none !important; }</style>
</head>
<body class="has-mobile-header">
  <!-- Mobile Header -->
  <header class="mobile-header">
    <button class="hamburger-btn" id="hamburger-btn" onclick="toggleSidebar()" aria-label="Toggle navigation menu">
      {{ icon('bars-3') }}
    </button>
    <div class="mobile-logo">
      <div class="mobile-logo-icon">CA</div>
      <span class="mobile-logo-text">CA4CPA GLOBAL</span>
    </div>
    <div style="width: 40px;"></div>
  </header>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="logo-mark" style="background: linear-gradient(135deg, #1e40af, #3b82f6);">CA</div>
          <div>
            <div class="logo-text">CA4CPA GLOBAL</div>
            <div class="logo-subtitle">Tax Advisory Intelligence</div>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav" aria-label="Main navigation">
        <div class="nav-section" role="group" aria-labelledby="nav-advisory-label">
          <div class="nav-section-label" id="nav-advisory-label">Advisory Intelligence</div>
          <a class="nav-item active" data-view="dashboard" onclick="switchView('dashboard')" role="button" tabindex="0">
            {{ icon('chart-bar') }}
            <span>Dashboard</span>
          </a>
          <a class="nav-item" data-view="insights" onclick="switchView('insights')" role="button" tabindex="0">
            {{ icon('light-bulb') }}
            <span>CPA Review Signals</span>
            <span class="nav-badge" id="insights-badge" aria-label="0 signals">0</span>
          </a>
          <a class="nav-item" data-view="scenarios" onclick="switchView('scenarios')" role="button" tabindex="0">
            {{ icon('calculator') }}
            <span>Scenario Workspace</span>
          </a>
          <a class="nav-item" data-view="advisory-tools" onclick="switchView('advisory-tools')" role="button" tabindex="0">
            {{ icon('beaker') }}
            <span>Analysis Workspace</span>
          </a>
        </div>
        <div class="nav-section" role="group" aria-labelledby="nav-leads-label">
          <div class="nav-section-label" id="nav-leads-label">Lead Management</div>
          <a class="nav-item" data-view="pipeline" onclick="switchView('pipeline')" role="button" tabindex="0">
            {{ icon('arrow-trending-up') }}
            <span>Lead Pipeline</span>
            <span class="nav-badge" id="pipeline-badge" aria-label="0 leads">0</span>
          </a>
          <a class="nav-item" data-view="intake" onclick="switchView('intake')" role="button" tabindex="0">
            {{ icon('user-plus') }}
            <span>Intake</span>
          </a>
        </div>
        <div class="nav-section" role="group" aria-labelledby="nav-engagements-label">
          <div class="nav-section-label" id="nav-engagements-label">Engagements</div>
          <a class="nav-item" data-view="clients" onclick="switchView('clients')" role="button" tabindex="0">
            {{ icon('users') }}
            <span>Engaged Clients</span>
          </a>
          <a class="nav-item" data-view="documents" onclick="switchView('documents')" role="button" tabindex="0">
            {{ icon('document-text') }}
            <span>Document Center</span>
          </a>
          <a class="nav-item" data-view="review" onclick="switchView('review')" role="button" tabindex="0">
            {{ icon('check-circle') }}
            <span>Review Queue</span>
            <span class="nav-badge alert" id="review-badge">0</span>
          </a>
        </div>
        <div class="nav-section">
          <div class="nav-section-label">Compliance</div>
          <a class="nav-item" data-view="risks" onclick="switchView('risks')">
            {{ icon('exclamation-triangle') }}
            <span>Complexity & Risks</span>
            <span class="nav-badge alert" id="risk-badge">0</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard View -->
      <div class="view active" id="view-dashboard">
        <div class="page-header">
          <div>
            <h1 class="page-title">Advisory Intelligence Dashboard</h1>
            <p class="page-subtitle">Tax Year 2025 | CPA-led advisory leverage identification</p>
          </div>
          <div class="header-actions">
            <button class="btn btn-ghost" onclick="refreshData()">
              {{ icon('arrow-path') }} Refresh
            </button>
            <button class="btn btn-primary" onclick="switchView('clients')">
              {{ icon('plus') }} Add Client
            </button>
          </div>
        </div>

        <!-- Advisory Surface Indicator -->
        <div class="advisory-surface-card">
          <div>
            <h2>Advisory Surface Identified</h2>
            <div style="font-size:32px;font-weight:700;" id="advisory-surface-level">Analyzing...</div>
            <div style="font-size:13px;opacity:0.85;margin-top:8px;">
              <strong id="leads-ready-count">0</strong> leads ready for CPA review
            </div>
          </div>
          <div style="display:flex;gap:32px;text-align:center;">
            <div>
              <div style="font-size:24px;font-weight:700;" id="stat-high-leverage">0</div>
              <div style="font-size:11px;opacity:0.85;margin-top:4px;">High Leverage</div>
            </div>
            <div>
              <div style="font-size:24px;font-weight:700;" id="stat-needs-review">0</div>
              <div style="font-size:11px;opacity:0.85;margin-top:4px;">Needs Review</div>
            </div>
            <div>
              <div style="font-size:24px;font-weight:700;" id="stat-complexity">0</div>
              <div style="font-size:11px;opacity:0.85;margin-top:4px;">Complex Cases</div>
            </div>
          </div>
        </div>

        <!-- Advisory Opportunity Areas -->
        <div class="optimization-grid">
          <div class="opt-card" onclick="filterByCategory('retirement')">
            <div class="opt-icon retirement">401k</div>
            <div class="opt-label">Retirement</div>
            <div class="opt-value" id="opt-retirement-level">—</div>
            <div class="opt-count"><span id="opt-retirement-count">0</span> signals</div>
          </div>
          <div class="opt-card" onclick="filterByCategory('deductions')">
            <div class="opt-icon deductions">§</div>
            <div class="opt-label">Deductions</div>
            <div class="opt-value" id="opt-deductions-level">—</div>
            <div class="opt-count"><span id="opt-deductions-count">0</span> signals</div>
          </div>
          <div class="opt-card" onclick="filterByCategory('credits')">
            <div class="opt-icon credits">{{ icon('check') }}</div>
            <div class="opt-label">Credits</div>
            <div class="opt-value" id="opt-credits-level">—</div>
            <div class="opt-count"><span id="opt-credits-count">0</span> signals</div>
          </div>
          <div class="opt-card" onclick="filterByCategory('qbi')">
            <div class="opt-icon qbi">199A</div>
            <div class="opt-label">QBI (Sec 199A)</div>
            <div class="opt-value" id="opt-qbi-level">—</div>
            <div class="opt-count"><span id="opt-qbi-count">0</span> signals</div>
          </div>
          <div class="opt-card" onclick="filterByCategory('investment')">
            <div class="opt-icon investment">TLH</div>
            <div class="opt-label">Investment</div>
            <div class="opt-value" id="opt-investment-level">—</div>
            <div class="opt-count"><span id="opt-investment-count">0</span> signals</div>
          </div>
        </div>
        <div style="font-size:11px;color:var(--color-gray-500);text-align:center;margin:-16px 0 24px 0;">Advisory Opportunity Areas — CPA Review Required</div>

        <!-- Two Column Layout -->
        <div class="dashboard-grid">
          <!-- Left: CPA Review Signals -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">CPA Review Signals</div>
                <div class="card-subtitle">Areas requiring professional review</div>
              </div>
              <button class="btn btn-ghost btn-sm" onclick="switchView('insights')">View All</button>
            </div>
            <div class="card-body no-padding scrollable" id="top-insights">
              <div class="empty-state">
                <div class="empty-icon">{{ icon('banknotes') }}</div>
                <div class="empty-title">Loading insights...</div>
              </div>
            </div>
          </div>

          <!-- Right: High Leverage Leads -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">High Leverage Leads</div>
                <div class="card-subtitle">Prioritized by advisory surface</div>
              </div>
            </div>
            <div class="card-body no-padding scrollable" id="high-value-clients">
              <div class="empty-state">
                <div class="empty-icon">{{ icon('users') }}</div>
                <div class="empty-title">No leads yet</div>
                <button class="btn btn-primary btn-sm" onclick="switchView('pipeline')">View Pipeline</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Insights View -->
      <div class="view" id="view-insights">
        <div class="page-header">
          <div>
            <h1 class="page-title">CPA Review Signals</h1>
            <p class="page-subtitle">All areas requiring professional review and attention</p>
          </div>
        </div>
        <div class="card">
          <div class="card-body no-padding scrollable" id="insights-list">
            <div class="empty-state">
              <div class="empty-icon">{{ icon('light-bulb') }}</div>
              <div class="empty-title">Loading insights...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Clients View -->
      <div class="view" id="view-clients">
        <div class="page-header">
          <div>
            <h1 class="page-title">Engaged Clients</h1>
            <p class="page-subtitle">All active client engagements</p>
          </div>
          <div class="header-actions">
            <button class="btn btn-primary" onclick="openSmartOnboarding()">
              {{ icon('plus') }} Add Client
            </button>
          </div>
        </div>
        <div class="card">
          <div class="card-body no-padding scrollable" id="clients-list">
            <div class="empty-state">
              <div class="empty-icon">{{ icon('users') }}</div>
              <div class="empty-title">Loading clients...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pipeline View -->
      <div class="view" id="view-pipeline">
        <div class="page-header">
          <div>
            <h1 class="page-title">Lead Pipeline</h1>
            <p class="page-subtitle">Track and manage prospective clients</p>
          </div>
        </div>
        <div class="pipeline-container">
          <div class="pipeline-column" id="pipeline-new">
            <div class="pipeline-column-header">
              <span class="pipeline-column-title">New Leads</span>
              <span class="pipeline-column-count">0</span>
            </div>
            <div class="pipeline-cards"></div>
          </div>
          <div class="pipeline-column" id="pipeline-contacted">
            <div class="pipeline-column-header">
              <span class="pipeline-column-title">Contacted</span>
              <span class="pipeline-column-count">0</span>
            </div>
            <div class="pipeline-cards"></div>
          </div>
          <div class="pipeline-column" id="pipeline-qualified">
            <div class="pipeline-column-header">
              <span class="pipeline-column-title">Qualified</span>
              <span class="pipeline-column-count">0</span>
            </div>
            <div class="pipeline-cards"></div>
          </div>
          <div class="pipeline-column" id="pipeline-engaged">
            <div class="pipeline-column-header">
              <span class="pipeline-column-title">Engaged</span>
              <span class="pipeline-column-count">0</span>
            </div>
            <div class="pipeline-cards"></div>
          </div>
        </div>
      </div>

      <!-- Review Queue View -->
      <div class="view" id="view-review">
        <div class="page-header">
          <div>
            <h1 class="page-title">Review Queue</h1>
            <p class="page-subtitle">Returns and documents pending CPA review</p>
          </div>
        </div>
        <div class="card">
          <div class="card-body no-padding scrollable" id="review-queue-list">
            <div class="empty-state">
              <div class="empty-icon">{{ icon('check-circle') }}</div>
              <div class="empty-title">No items pending review</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Scenarios View -->
      <div class="view" id="view-scenarios">
        <div class="page-header">
          <div>
            <h1 class="page-title">Scenario Workspace</h1>
            <p class="page-subtitle">Compare tax scenarios and planning strategies</p>
          </div>
        </div>
        <div class="empty-state">
          <div class="empty-icon">{{ icon('calculator') }}</div>
          <div class="empty-title">Scenario workspace coming soon</div>
        </div>
      </div>

      <!-- Advisory Tools View -->
      <div class="view" id="view-advisory-tools">
        <div class="page-header">
          <div>
            <h1 class="page-title">Analysis Workspace</h1>
            <p class="page-subtitle">Advanced tax analysis tools</p>
          </div>
        </div>
        <div class="empty-state">
          <div class="empty-icon">{{ icon('beaker') }}</div>
          <div class="empty-title">Analysis workspace coming soon</div>
        </div>
      </div>

      <!-- Documents View -->
      <div class="view" id="view-documents">
        <div class="page-header">
          <div>
            <h1 class="page-title">Document Center</h1>
            <p class="page-subtitle">Client document management</p>
          </div>
        </div>
        <div class="empty-state">
          <div class="empty-icon">{{ icon('document-text') }}</div>
          <div class="empty-title">Document center coming soon</div>
        </div>
      </div>

      <!-- Intake View -->
      <div class="view" id="view-intake">
        <div class="page-header">
          <div>
            <h1 class="page-title">Client Intake</h1>
            <p class="page-subtitle">Start new client onboarding</p>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">New Client Intake</div>
          </div>
          <div class="card-body">
            <form id="intake-form" class="form-grid">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="intake-first-name">First Name</label>
                  <input type="text" id="intake-first-name" class="form-input" required>
                </div>
                <div class="form-group">
                  <label class="form-label" for="intake-last-name">Last Name</label>
                  <input type="text" id="intake-last-name" class="form-input" required>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label" for="intake-email">Email</label>
                <input type="email" id="intake-email" class="form-input" required>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label" for="intake-tax-year">Tax Year</label>
                  <select id="intake-tax-year" class="form-select">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label" for="intake-filing-status">Filing Status</label>
                  <select id="intake-filing-status" class="form-select">
                    <option value="single">Single</option>
                    <option value="married_filing_jointly">Married Filing Jointly</option>
                    <option value="married_filing_separately">Married Filing Separately</option>
                    <option value="head_of_household">Head of Household</option>
                  </select>
                </div>
              </div>
              <div class="form-actions">
                <button type="button" class="btn btn-ghost" onclick="switchView('dashboard')">Cancel</button>
                <button type="submit" class="btn btn-primary">Start Intake</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Risks View -->
      <div class="view" id="view-risks">
        <div class="page-header">
          <div>
            <h1 class="page-title">Complexity & Risks</h1>
            <p class="page-subtitle">Compliance risks and complex situations</p>
          </div>
        </div>
        <div class="empty-state">
          <div class="empty-icon">{{ icon('exclamation-triangle') }}</div>
          <div class="empty-title">No risks identified</div>
        </div>
      </div>
    </main>
  </div>

  <!-- Insight Detail Panel -->
  <div class="detail-panel" id="insight-detail-panel">
    <div class="panel-header">
      <span class="panel-title">Insight Details</span>
      <button class="panel-close" onclick="closePanel()" aria-label="Close panel">
        {{ icon('x-mark') }}
      </button>
    </div>
    <div class="panel-body">
      <!-- Populated by JavaScript -->
    </div>
    <div class="panel-footer">
      <button class="btn btn-primary" onclick="implementInsight()">Mark as Reviewed</button>
    </div>
  </div>

  <!-- Client Detail Panel -->
  <div class="detail-panel" id="client-detail-panel">
    <div class="panel-header">
      <span class="panel-title">Client Details</span>
      <button class="panel-close" onclick="closePanel()" aria-label="Close panel">
        {{ icon('x-mark') }}
      </button>
    </div>
    <div class="panel-body">
      <!-- Populated by JavaScript -->
    </div>
    <div class="panel-footer">
      <button class="btn btn-ghost" onclick="closePanel()">Close</button>
      <button class="btn btn-primary" onclick="openClientWorkspace()">Open Workspace</button>
    </div>
  </div>

  <!-- Command Palette -->
  <div class="command-palette-backdrop" id="command-palette-backdrop" onclick="if(event.target === this) closeCommandPalette()">
    <div class="command-palette">
      <input type="text" class="command-palette-input" id="command-palette-input"
             placeholder="Search commands, clients..."
             autocomplete="off">
      <div class="command-palette-results" id="command-palette-results"></div>
      <div class="command-palette-hint">
        <span><kbd>↑↓</kbd> Navigate</span>
        <span><kbd>↵</kbd> Select</span>
        <span><kbd>Esc</kbd> Close</span>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Core JavaScript -->
  <script src="/static/js/core/utils.js" type="module"></script>
  <script src="/static/js/core/api.js" type="module"></script>

  <!-- Page-specific JavaScript -->
  <script src="/static/js/pages/cpa-dashboard.js" type="module"></script>
</body>
</html>
