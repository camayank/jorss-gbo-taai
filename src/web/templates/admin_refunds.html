<!DOCTYPE html>
<html lang="en" data-theme="admin">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Refund Management - TaxFlow Admin</title>
  <link rel="stylesheet" href="/static/css/core/variables.css">
  <link rel="stylesheet" href="/static/css/core/reset.css">
  <link rel="stylesheet" href="/static/css/core/typography.css">
  <link rel="stylesheet" href="/static/css/core/layout.css">
  <link rel="stylesheet" href="/static/css/components/buttons.css">
  <link rel="stylesheet" href="/static/css/components/cards.css">
  <link rel="stylesheet" href="/static/css/components/forms.css">
  <link rel="stylesheet" href="/static/css/components/tables.css">
  <link rel="stylesheet" href="/static/css/components/navigation.css">
  <link rel="stylesheet" href="/static/css/unified-theme.css">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--gray-900, var(--color-slate-900)); color: var(--gray-100, var(--color-gray-100)); min-height: 100vh; }
    .app-layout { display: flex; min-height: 100vh; }
    .sidebar { width: var(--sidebar-width, 260px); background: linear-gradient(180deg, var(--color-slate-900) 0%, var(--color-slate-800) 100%); display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; }
    .sidebar-header { padding: var(--space-5); border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar-logo { display: flex; align-items: center; gap: var(--space-3); text-decoration: none; color: white; }
    .sidebar-logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--color-info-500) 0%, var(--color-purple-500) 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: var(--font-bold); font-size: var(--text-lg); }
    .sidebar-logo-text { font-weight: var(--font-bold); font-size: var(--text-lg); }
    .sidebar-logo-badge { font-size: 10px; background: var(--color-warning-500); color: var(--color-slate-900); padding: 2px var(--space-1-5); border-radius: 4px; font-weight: var(--font-semibold); margin-left: -var(--space-2); margin-top: -var(--space-3); }
    .sidebar-nav { flex: 1; padding: var(--space-4) var(--space-3); overflow-y: auto; }
    .nav-section { margin-bottom: var(--space-6); }
    .nav-section-title { font-size: 10px; font-weight: var(--font-semibold); text-transform: uppercase; letter-spacing: 1px; color: rgba(255,255,255,0.4); padding: 0 var(--space-3); margin-bottom: var(--space-2); }
    .nav-item { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-2-5) var(--space-3); border-radius: var(--radius-lg); text-decoration: none; color: rgba(255,255,255,0.7); font-size: var(--text-sm); font-weight: var(--font-medium); transition: all 0.15s ease; margin-bottom: 2px; }
    .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
    .nav-item.active { background: var(--color-info-500); color: white; }
    .nav-item-icon { font-size: var(--text-lg); opacity: 0.9; }
    .nav-item-badge { margin-left: auto; background: var(--color-error-500); color: white; font-size: 11px; font-weight: var(--font-semibold); padding: 2px var(--space-1-5); border-radius: 10px; }
    .sidebar-footer { padding: var(--space-4); border-top: 1px solid rgba(255,255,255,0.1); }
    .user-card { display: flex; align-items: center; gap: var(--space-3); padding: var(--space-2); border-radius: var(--radius-lg); cursor: pointer; }
    .user-card:hover { background: rgba(255,255,255,0.1); }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--color-info-500); display: flex; align-items: center; justify-content: center; color: white; font-weight: var(--font-semibold); font-size: var(--text-sm); }
    .user-name { font-size: 13px; font-weight: var(--font-semibold); color: white; }
    .user-role { font-size: 11px; color: var(--color-warning-500); font-weight: var(--font-medium); }
    .main-content { flex: 1; margin-left: var(--sidebar-width, 260px); background: var(--color-slate-900); min-height: 100vh; }
    .header { height: var(--header-height, 64px); background: var(--color-slate-800); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; padding: 0 var(--space-6); position: sticky; top: 0; z-index: 50; }
    .header-title { font-size: var(--text-xl); font-weight: var(--font-semibold); color: var(--color-gray-100); }
    .header-subtitle { font-size: 13px; color: rgba(255,255,255,0.5); }
    .header-actions { display: flex; align-items: center; gap: var(--space-3); }
    .header-search { position: relative; }
    .header-search input { width: 260px; padding: var(--space-2) var(--space-3) var(--space-2) 36px; border: 1px solid rgba(255,255,255,0.15); border-radius: var(--radius-lg); font-size: var(--text-sm); outline: none; background: rgba(255,255,255,0.05); color: var(--color-gray-100); }
    .header-search input::placeholder { color: rgba(255,255,255,0.4); }
    .header-search input:focus { border-color: var(--color-info-500); box-shadow: 0 0 0 3px rgba(99,102,241,0.2); }
    .header-search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.4); }
    .page-content { padding: var(--space-6); }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6); }
    .stat-card { background: var(--color-slate-800); border-radius: var(--radius-xl); padding: var(--space-5); border: 1px solid rgba(255,255,255,0.1); }
    .stat-card .stat-label { font-size: var(--text-xs); color: rgba(255,255,255,0.5); margin-bottom: var(--space-2); text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card .stat-value { font-size: 28px; font-weight: var(--font-bold); }
    .stat-card.highlight { background: linear-gradient(135deg, var(--color-info-500) 0%, var(--color-purple-500) 100%); border: none; }
    .stat-card.highlight .stat-label { color: rgba(255,255,255,0.8); }
    .filter-bar { display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-5); background: var(--color-slate-800); padding: var(--space-4); border-radius: var(--radius-xl); border: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; }
    .filter-bar select, .filter-bar input { padding: var(--space-2) var(--space-3); border-radius: var(--radius-lg); font-size: 13px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); color: var(--color-gray-100); outline: none; font-family: inherit; }
    .filter-bar select:focus, .filter-bar input:focus { border-color: var(--color-info-500); box-shadow: 0 0 0 2px rgba(99,102,241,0.2); }
    .filter-bar select option { background: var(--color-slate-800); color: var(--color-gray-100); }
    .filter-spacer { flex: 1; }
    .btn { padding: var(--space-2) var(--space-4); border-radius: var(--radius-lg); font-size: 13px; font-weight: var(--font-semibold); border: none; cursor: pointer; transition: all 0.15s ease; display: inline-flex; align-items: center; gap: var(--space-1-5); font-family: inherit; }
    .btn-primary { background: var(--color-info-500); color: white; }
    .btn-primary:hover { background: var(--color-info-600); }
    .btn-success { background: var(--color-success-500); color: white; }
    .btn-success:hover { background: var(--color-success-600); }
    .btn-danger { background: var(--color-error-500); color: white; }
    .btn-danger:hover { background: var(--color-error-600); }
    .btn-warning { background: var(--color-warning-500); color: var(--color-slate-900); }
    .btn-warning:hover { background: var(--color-warning-600); }
    .btn-ghost { background: transparent; color: rgba(255,255,255,0.6); border: 1px solid rgba(255,255,255,0.15); }
    .btn-ghost:hover { background: rgba(255,255,255,0.05); color: white; }
    .btn-sm { padding: 5px var(--space-2-5); font-size: var(--text-xs); }
    .btn:disabled { opacity: 0.4; cursor: default; }
    .table-container { background: var(--color-slate-800); border-radius: var(--radius-xl); border: 1px solid rgba(255,255,255,0.1); overflow: hidden; }
    .table-header-bar { display: flex; justify-content: space-between; align-items: center; padding: var(--space-4) var(--space-5); border-bottom: 1px solid rgba(255,255,255,0.1); }
    .table-title { font-size: var(--text-base); font-weight: var(--font-semibold); }
    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; padding: var(--space-3) var(--space-4); font-size: 11px; font-weight: var(--font-semibold); text-transform: uppercase; letter-spacing: 0.5px; color: rgba(255,255,255,0.5); border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); }
    tbody td { padding: var(--space-3-5) var(--space-4); font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); color: rgba(255,255,255,0.8); }
    tbody tr:hover { background: rgba(255,255,255,0.03); }
    .amount-cell { font-weight: var(--font-semibold); font-variant-numeric: tabular-nums; }
    .badge { display: inline-flex; align-items: center; gap: var(--space-1); padding: var(--space-1) var(--space-2-5); border-radius: var(--radius-md); font-size: 11px; font-weight: var(--font-semibold); }
    .badge-pending { background: rgba(245,158,11,0.15); color: var(--color-warning-500); }
    .badge-approved { background: rgba(99,102,241,0.15); color: var(--color-purple-500); }
    .badge-rejected { background: rgba(239,68,68,0.15); color: var(--color-error-500); }
    .badge-processed { background: rgba(16,185,129,0.15); color: var(--color-success-500); }
    .badge-dot { width: 6px; height: 6px; border-radius: 50%; }
    .badge-pending .badge-dot { background: var(--color-warning-500); }
    .badge-approved .badge-dot { background: var(--color-purple-500); }
    .badge-rejected .badge-dot { background: var(--color-error-500); }
    .badge-processed .badge-dot { background: var(--color-success-500); }
    .pagination { display: flex; align-items: center; justify-content: space-between; padding: var(--space-3-5) var(--space-5); border-top: 1px solid rgba(255,255,255,0.1); }
    .pagination-info { font-size: 13px; color: rgba(255,255,255,0.5); }
    .pagination-controls { display: flex; gap: var(--space-1); }
    .page-btn { width: 32px; height: 32px; border-radius: var(--radius-md); border: 1px solid rgba(255,255,255,0.15); background: transparent; color: rgba(255,255,255,0.6); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 13px; font-family: inherit; }
    .page-btn:hover { background: rgba(255,255,255,0.05); color: white; }
    .page-btn.active { background: var(--color-info-500); color: white; border-color: var(--color-info-500); }
    .page-btn:disabled { opacity: 0.3; cursor: default; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 200; display: flex; align-items: center; justify-content: center; }
    .modal { background: var(--color-slate-800); border-radius: var(--radius-2xl); width: 480px; max-width: 90vw; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: var(--space-5) var(--space-6); border-bottom: 1px solid rgba(255,255,255,0.1); }
    .modal-title { font-size: var(--text-lg); font-weight: var(--font-semibold); }
    .modal-close { width: 32px; height: 32px; border-radius: var(--radius-lg); border: none; background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); cursor: pointer; font-size: var(--text-lg); display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { background: rgba(255,255,255,0.1); color: white; }
    .modal-body { padding: var(--space-6); }
    .modal-footer { display: flex; justify-content: flex-end; gap: var(--space-2-5); padding: var(--space-4) var(--space-6); border-top: 1px solid rgba(255,255,255,0.1); }
    .form-group { margin-bottom: var(--space-4); }
    .form-label { display: block; font-size: 13px; font-weight: var(--font-medium); margin-bottom: var(--space-1-5); color: rgba(255,255,255,0.7); }
    .form-input, .form-textarea { width: 100%; padding: var(--space-2-5) var(--space-3); border-radius: var(--radius-lg); font-size: var(--text-sm); border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); color: var(--color-gray-100); outline: none; font-family: inherit; }
    .form-input:focus, .form-textarea:focus { border-color: var(--color-info-500); box-shadow: 0 0 0 2px rgba(99,102,241,0.2); }
    .form-textarea { resize: vertical; min-height: 80px; }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 300; display: flex; flex-direction: column; gap: var(--space-2); }
    .toast { padding: var(--space-3) var(--space-5); border-radius: 10px; font-size: 13px; font-weight: var(--font-medium); box-shadow: 0 10px 25px rgba(0,0,0,0.3); display: flex; align-items: center; gap: var(--space-2); animation: slideIn var(--transition-slow); }
    .toast-success { background: var(--color-success-800); color: var(--color-success-100); border: 1px solid rgba(16,185,129,0.3); }
    .toast-error { background: var(--color-error-800); color: var(--color-error-100); border: 1px solid rgba(239,68,68,0.3); }
    .toast-info { background: var(--color-primary-500); color: var(--color-info-100); border: 1px solid rgba(99,102,241,0.3); }
    @keyframes slideIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
    .empty-state { text-align: center; padding: var(--space-12) var(--space-5); color: rgba(255,255,255,0.4); }
    .empty-state-icon { font-size: 48px; margin-bottom: var(--space-3); }
    .empty-state-text { font-size: 15px; }
    .confirm-bar { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: var(--radius-lg); padding: var(--space-3) var(--space-4); margin-top: var(--space-3); display: flex; align-items: center; justify-content: space-between; }
    .confirm-bar-text { font-size: 13px; color: var(--color-warning-500); }
    .refund-detail { background: rgba(255,255,255,0.03); border-radius: var(--radius-lg); padding: var(--space-3-5); margin-bottom: var(--space-4); border: 1px solid rgba(255,255,255,0.06); }
    .refund-detail-row { display: flex; justify-content: space-between; margin-bottom: var(--space-1-5); }
    .refund-detail-row:last-child { margin-bottom: 0; }
    .refund-detail-label { color: rgba(255,255,255,0.5); font-size: var(--text-xs); }
    .refund-detail-value { font-size: 13px; }
  </style>
</head>
<body>
<div x-data="refundManager()" class="app-layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <a href="/admin" class="sidebar-logo">
        <div class="sidebar-logo-icon">TF</div>
        <div>
          <span class="sidebar-logo-text">TaxFlow</span>
          <span class="sidebar-logo-badge">ADMIN</span>
        </div>
      </a>
    </div>
    <nav class="sidebar-nav" aria-label="Main navigation">
      <div class="nav-section">
        <div class="nav-section-title">Platform</div>
        <a href="/admin" class="nav-item"><span class="nav-item-icon">&#128202;</span> Dashboard</a>
        <a href="/admin/firms" class="nav-item"><span class="nav-item-icon">&#127970;</span> CPA Firms</a>
        <a href="/admin/refunds" class="nav-item active">
          <span class="nav-item-icon">&#128176;</span> Refunds
          <span class="nav-item-badge" x-show="stats.pending > 0" x-text="stats.pending"></span>
        </a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">System</div>
        <a href="/admin/features" class="nav-item"><span class="nav-item-icon">&#128273;</span> API Keys</a>
        <a href="/admin/rbac" class="nav-item"><span class="nav-item-icon">&#128065;</span> Impersonation</a>
        <a href="/admin/health" class="nav-item"><span class="nav-item-icon">&#9881;</span> System</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Quick Links</div>
        <a href="/hub" class="nav-item"><span class="nav-item-icon">&#127968;</span> System Hub</a>
        <a href="/docs" class="nav-item" target="_blank"><span class="nav-item-icon">&#128196;</span> API Docs</a>
      </div>
    </nav>
    <div class="sidebar-footer">
      <div class="user-card">
        <div class="user-avatar">SA</div>
        <div class="user-info">
          <div class="user-name">Super Admin</div>
          <div class="user-role">Platform Admin</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="header">
      <div>
        <h1 class="header-title">Refund Management</h1>
        <p class="header-subtitle">Review, approve, and process subscription refunds</p>
      </div>
      <div class="header-actions">
        <div class="header-search">
          <span class="header-search-icon">&#128269;</span>
          <input type="text" placeholder="Search refunds..." x-model="searchQuery" @input.debounce.300ms="applyFilters()">
        </div>
        <button class="btn btn-primary" @click="openCreateModal()">+ New Refund</button>
      </div>
    </header>

    <div class="page-content">
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card highlight">
          <div class="stat-label">Total Requests</div>
          <div class="stat-value" x-text="stats.total"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label" style="color:#fbbf24">Pending</div>
          <div class="stat-value" style="color:#fbbf24" x-text="stats.pending"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label" style="color:#818cf8">Approved</div>
          <div class="stat-value" style="color:#818cf8" x-text="stats.approved"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label" style="color:#34d399">Processed</div>
          <div class="stat-value" style="color:#34d399" x-text="stats.processed"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label" style="color:#f87171">Rejected</div>
          <div class="stat-value" style="color:#f87171" x-text="stats.rejected"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Amount Requested</div>
          <div class="stat-value" x-text="'$' + stats.totalRequested.toLocaleString()"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label" style="color:#34d399">Amount Processed</div>
          <div class="stat-value" style="color:#34d399" x-text="'$' + stats.totalProcessed.toLocaleString()"></div>
        </div>
      </div>

      <!-- Filter Bar -->
      <div class="filter-bar">
        <select x-model="filters.status" @change="applyFilters()">
          <option value="">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
          <option value="processed">Processed</option>
        </select>
        <input type="text" placeholder="Filter by firm..." x-model="filters.firm" @input.debounce.300ms="applyFilters()">
        <input type="date" x-model="filters.dateFrom" @change="applyFilters()" title="From date" style="color-scheme:dark">
        <input type="date" x-model="filters.dateTo" @change="applyFilters()" title="To date" style="color-scheme:dark">
        <div class="filter-spacer"></div>
        <button class="btn btn-ghost btn-sm" @click="resetFilters()">Clear Filters</button>
      </div>

      <!-- Refunds Table -->
      <div class="table-container">
        <div class="table-header-bar">
          <span class="table-title">Refund Requests (<span x-text="filteredRefunds.length"></span>)</span>
        </div>
        <template x-if="paginatedRefunds.length > 0">
          <div>
            <table>
              <thead>
                <tr>
                  <th>ID</th><th>Firm</th><th>Amount</th><th>Reason</th><th>Status</th><th>Requested</th><th>Decided</th><th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="r in paginatedRefunds" :key="r.id">
                  <tr>
                    <td style="font-family:monospace;font-size:12px" x-text="r.id"></td>
                    <td>
                      <div style="font-weight:600" x-text="r.firm_name"></div>
                      <div style="font-size:11px;color:rgba(255,255,255,0.4)" x-text="'ID: '+r.firm_id"></div>
                    </td>
                    <td class="amount-cell" x-text="'$'+r.amount.toLocaleString(undefined,{minimumFractionDigits:2})"></td>
                    <td style="max-width:200px">
                      <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap" x-text="r.reason" :title="r.reason"></div>
                    </td>
                    <td>
                      <span class="badge" :class="'badge-'+r.status">
                        <span class="badge-dot"></span>
                        <span x-text="r.status.charAt(0).toUpperCase()+r.status.slice(1)"></span>
                      </span>
                    </td>
                    <td style="white-space:nowrap" x-text="formatDate(r.created_at)"></td>
                    <td style="white-space:nowrap" x-text="r.decided_at ? formatDate(r.decided_at) : '---'"></td>
                    <td>
                      <div style="display:flex;gap:6px">
                        <template x-if="r.status==='pending'">
                          <div style="display:flex;gap:6px">
                            <button class="btn btn-success btn-sm" @click="openDecisionModal(r,'approved')">Approve</button>
                            <button class="btn btn-danger btn-sm" @click="openDecisionModal(r,'rejected')">Reject</button>
                          </div>
                        </template>
                        <template x-if="r.status==='approved'">
                          <button class="btn btn-warning btn-sm" @click="processRefund(r)">Process</button>
                        </template>
                        <template x-if="r.status==='rejected'||r.status==='processed'">
                          <span style="font-size:12px;color:rgba(255,255,255,0.3)">No actions</span>
                        </template>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            <div class="pagination">
              <div class="pagination-info" x-text="paginationInfo"></div>
              <div class="pagination-controls">
                <button class="page-btn" :disabled="currentPage===1" @click="currentPage--">&laquo;</button>
                <template x-for="p in totalPages" :key="p">
                  <button class="page-btn" :class="{active:p===currentPage}" @click="currentPage=p" x-text="p"></button>
                </template>
                <button class="page-btn" :disabled="currentPage===totalPages" @click="currentPage++">&raquo;</button>
              </div>
            </div>
          </div>
        </template>
        <template x-if="paginatedRefunds.length===0">
          <div class="empty-state">
            <div class="empty-state-icon">&#128230;</div>
            <div class="empty-state-text">No refund requests match your filters.</div>
          </div>
        </template>
      </div>
    </div>
  </main>

  <!-- Decision Modal -->
  <template x-if="showDecisionModal">
    <div class="modal-overlay" @click.self="closeDecisionModal()">
      <div class="modal">
        <div class="modal-header">
          <span class="modal-title" x-text="decisionType==='approved' ? 'Approve Refund' : 'Reject Refund'"></span>
          <button class="modal-close" @click="closeDecisionModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="refund-detail">
            <div class="refund-detail-row">
              <span class="refund-detail-label">Refund</span>
              <span class="refund-detail-value" style="font-family:monospace;font-size:12px" x-text="selectedRefund?.id"></span>
            </div>
            <div class="refund-detail-row">
              <span class="refund-detail-label">Firm</span>
              <span class="refund-detail-value" x-text="selectedRefund?.firm_name"></span>
            </div>
            <div class="refund-detail-row">
              <span class="refund-detail-label">Amount</span>
              <span class="refund-detail-value" style="font-weight:600;font-size:15px" x-text="selectedRefund ? '$'+selectedRefund.amount.toLocaleString(undefined,{minimumFractionDigits:2}) : ''"></span>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Decision Notes</label>
            <textarea class="form-textarea" x-model="decisionNotes" placeholder="Add notes about this decision..." rows="3"></textarea>
          </div>
          <template x-if="!confirmStep">
            <div class="confirm-bar">
              <span class="confirm-bar-text" x-text="decisionType==='approved' ? 'Click Confirm to approve this refund.' : 'Click Confirm to reject this refund.'"></span>
              <button class="btn btn-sm" :class="decisionType==='approved' ? 'btn-success' : 'btn-danger'" @click="confirmStep=true">Confirm</button>
            </div>
          </template>
        </div>
        <div class="modal-footer" x-show="confirmStep">
          <button class="btn btn-ghost" @click="closeDecisionModal()">Cancel</button>
          <button class="btn" :class="decisionType==='approved' ? 'btn-success' : 'btn-danger'" @click="submitDecision()" x-text="decisionType==='approved' ? 'Yes, Approve Refund' : 'Yes, Reject Refund'"></button>
        </div>
      </div>
    </div>
  </template>

  <!-- Create Refund Modal -->
  <template x-if="showCreateModal">
    <div class="modal-overlay" @click.self="closeCreateModal()">
      <div class="modal">
        <div class="modal-header">
          <span class="modal-title">Create Refund Request</span>
          <button class="modal-close" @click="closeCreateModal()">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Firm ID *</label>
            <input class="form-input" type="text" x-model="createForm.firm_id" placeholder="e.g., firm_101">
          </div>
          <div class="form-group">
            <label class="form-label">Subscription ID *</label>
            <input class="form-input" type="text" x-model="createForm.subscription_id" placeholder="e.g., sub_abc123">
          </div>
          <div class="form-group">
            <label class="form-label">Amount ($) *</label>
            <input class="form-input" type="number" step="0.01" min="0" x-model.number="createForm.amount" placeholder="0.00">
          </div>
          <div class="form-group">
            <label class="form-label">Reason *</label>
            <textarea class="form-textarea" x-model="createForm.reason" placeholder="Describe the reason for this refund..." rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" @click="closeCreateModal()">Cancel</button>
          <button class="btn btn-primary" @click="submitCreate()" :disabled="!createFormValid">Create Refund</button>
        </div>
      </div>
    </div>
  </template>

  <!-- Toasts -->
  <div class="toast-container">
    <template x-for="t in toasts" :key="t.id">
      <div class="toast" :class="'toast-'+t.type" x-text="t.message"></div>
    </template>
  </div>
</div>

<script>
function refundManager() {
  return {
    refunds: [], filteredRefunds: [], searchQuery: '', currentPage: 1, perPage: 10,
    filters: { status: '', firm: '', dateFrom: '', dateTo: '' },
    stats: { total: 0, pending: 0, approved: 0, processed: 0, rejected: 0, totalRequested: 0, totalProcessed: 0 },
    showDecisionModal: false, showCreateModal: false,
    selectedRefund: null, decisionType: '', decisionNotes: '', confirmStep: false,
    createForm: { firm_id: '', subscription_id: '', amount: null, reason: '' },
    toasts: [], toastCounter: 0,

    get paginatedRefunds() {
      const s = (this.currentPage - 1) * this.perPage;
      return this.filteredRefunds.slice(s, s + this.perPage);
    },
    get totalPages() { return Math.max(1, Math.ceil(this.filteredRefunds.length / this.perPage)); },
    get paginationInfo() {
      const t = this.filteredRefunds.length;
      if (!t) return 'No results';
      const s = (this.currentPage - 1) * this.perPage + 1;
      return `Showing ${s}-${Math.min(this.currentPage * this.perPage, t)} of ${t}`;
    },
    get createFormValid() {
      return this.createForm.firm_id && this.createForm.subscription_id && this.createForm.amount > 0 && this.createForm.reason;
    },

    init() { this.loadMockData(); this.computeStats(); this.applyFilters(); },

    loadMockData() {
      this.refunds = [
        { id: 'ref_001', firm_id: 'firm_101', firm_name: 'Anderson & Partners CPA', subscription_id: 'sub_a1b2c3', amount: 299.00, reason: 'Duplicate charge on annual plan renewal', status: 'pending', created_at: '2025-06-10T14:30:00Z', decided_at: null, notes: '' },
        { id: 'ref_002', firm_id: 'firm_102', firm_name: 'Baker Tax Associates', subscription_id: 'sub_d4e5f6', amount: 149.50, reason: 'Service downtime exceeding SLA - May 2025', status: 'approved', created_at: '2025-06-08T09:15:00Z', decided_at: '2025-06-09T11:00:00Z', notes: 'SLA breach confirmed by ops' },
        { id: 'ref_003', firm_id: 'firm_103', firm_name: 'Chen Financial Group', subscription_id: 'sub_g7h8i9', amount: 599.00, reason: 'Client onboarding failure - features not delivered', status: 'rejected', created_at: '2025-06-05T16:45:00Z', decided_at: '2025-06-07T10:20:00Z', notes: 'Features delivered; training offered' },
        { id: 'ref_004', firm_id: 'firm_104', firm_name: 'Davis & Morgan LLC', subscription_id: 'sub_j0k1l2', amount: 75.00, reason: 'Prorated refund for mid-cycle downgrade', status: 'processed', created_at: '2025-05-28T08:00:00Z', decided_at: '2025-05-29T14:00:00Z', notes: 'Standard proration' },
        { id: 'ref_005', firm_id: 'firm_105', firm_name: 'Ellis Wright CPAs', subscription_id: 'sub_m3n4o5', amount: 450.00, reason: 'Billing error - charged for inactive users', status: 'pending', created_at: '2025-06-12T11:20:00Z', decided_at: null, notes: '' },
        { id: 'ref_006', firm_id: 'firm_101', firm_name: 'Anderson & Partners CPA', subscription_id: 'sub_p6q7r8', amount: 199.00, reason: 'Cancellation within 30-day trial period', status: 'processed', created_at: '2025-05-20T13:10:00Z', decided_at: '2025-05-21T09:00:00Z', notes: 'Within trial window' },
        { id: 'ref_007', firm_id: 'firm_106', firm_name: 'Franklin Patel Tax Services', subscription_id: 'sub_s9t0u1', amount: 350.00, reason: 'Integration issues with existing accounting software', status: 'pending', created_at: '2025-06-14T15:50:00Z', decided_at: null, notes: '' },
        { id: 'ref_008', firm_id: 'firm_107', firm_name: 'Greenfield Advisors', subscription_id: 'sub_v2w3x4', amount: 89.99, reason: 'Accidental double subscription purchase', status: 'approved', created_at: '2025-06-11T10:05:00Z', decided_at: '2025-06-12T08:30:00Z', notes: 'Verified duplicate in billing' },
      ];
    },

    computeStats() {
      const r = this.refunds;
      this.stats = {
        total: r.length,
        pending: r.filter(x => x.status === 'pending').length,
        approved: r.filter(x => x.status === 'approved').length,
        processed: r.filter(x => x.status === 'processed').length,
        rejected: r.filter(x => x.status === 'rejected').length,
        totalRequested: r.reduce((s, x) => s + x.amount, 0),
        totalProcessed: r.filter(x => x.status === 'processed').reduce((s, x) => s + x.amount, 0)
      };
    },

    applyFilters() {
      let res = [...this.refunds];
      if (this.filters.status) res = res.filter(r => r.status === this.filters.status);
      if (this.filters.firm) {
        const q = this.filters.firm.toLowerCase();
        res = res.filter(r => r.firm_name.toLowerCase().includes(q) || r.firm_id.toLowerCase().includes(q));
      }
      if (this.searchQuery) {
        const q = this.searchQuery.toLowerCase();
        res = res.filter(r => r.id.includes(q) || r.firm_name.toLowerCase().includes(q) || r.reason.toLowerCase().includes(q));
      }
      if (this.filters.dateFrom) { const d = new Date(this.filters.dateFrom); res = res.filter(r => new Date(r.created_at) >= d); }
      if (this.filters.dateTo) { const d = new Date(this.filters.dateTo); d.setHours(23,59,59); res = res.filter(r => new Date(r.created_at) <= d); }
      this.filteredRefunds = res;
      this.currentPage = 1;
    },

    resetFilters() { this.filters = { status: '', firm: '', dateFrom: '', dateTo: '' }; this.searchQuery = ''; this.applyFilters(); },

    formatDate(iso) {
      if (!iso) return '---';
      return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    },

    openDecisionModal(refund, type) {
      this.selectedRefund = refund; this.decisionType = type;
      this.decisionNotes = ''; this.confirmStep = false; this.showDecisionModal = true;
    },
    closeDecisionModal() { this.showDecisionModal = false; this.selectedRefund = null; this.confirmStep = false; },
    submitDecision() {
      if (!this.selectedRefund) return;
      const ref = this.refunds.find(r => r.id === this.selectedRefund.id);
      if (ref) { ref.status = this.decisionType; ref.decided_at = new Date().toISOString(); ref.notes = this.decisionNotes; }
      this.addToast('success', `Refund ${this.selectedRefund.id} has been ${this.decisionType}.`);
      this.closeDecisionModal(); this.computeStats(); this.applyFilters();
    },

    processRefund(refund) {
      const r = this.refunds.find(x => x.id === refund.id);
      if (r) r.status = 'processed';
      this.addToast('success', `Refund ${refund.id} has been processed.`);
      this.computeStats(); this.applyFilters();
    },

    openCreateModal() { this.createForm = { firm_id: '', subscription_id: '', amount: null, reason: '' }; this.showCreateModal = true; },
    closeCreateModal() { this.showCreateModal = false; },
    submitCreate() {
      if (!this.createFormValid) return;
      const id = 'ref_' + String(this.refunds.length + 1).padStart(3, '0');
      this.refunds.unshift({
        id, firm_id: this.createForm.firm_id, firm_name: this.createForm.firm_id,
        subscription_id: this.createForm.subscription_id, amount: parseFloat(this.createForm.amount),
        reason: this.createForm.reason, status: 'pending', created_at: new Date().toISOString(), decided_at: null, notes: ''
      });
      this.addToast('success', `Refund ${id} created successfully.`);
      this.closeCreateModal(); this.computeStats(); this.applyFilters();
    },

    addToast(type, message) {
      const id = ++this.toastCounter;
      this.toasts.push({ id, type, message });
      setTimeout(() => { this.toasts = this.toasts.filter(t => t.id !== id); }, 4000);
    }
  };
}
</script>
</body>
</html>
