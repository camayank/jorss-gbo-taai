{% from 'macros/icons.html' import icon %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenant Management | Platform Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #1a202c;
        }

        .header-actions button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .header-actions button:hover {
            background: #4338ca;
        }

        /* Main Layout */
        .container {
            display: flex;
            height: calc(100vh - 81px);
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .sidebar-section h3 {
            font-size: 0.875rem;
            text-transform: uppercase;
            color: #718096;
            margin-bottom: 10px;
        }

        .tenant-list {
            list-style: none;
        }

        .tenant-item {
            padding: 12px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 6px;
            transition: background 0.2s;
        }

        .tenant-item:hover {
            background: #f7fafc;
        }

        .tenant-item.active {
            background: #edf2f7;
            border-left: 3px solid #4f46e5;
        }

        .tenant-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .tenant-meta {
            font-size: 0.75rem;
            color: #718096;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .status-badge.active {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-badge.trial {
            background: #feebc8;
            color: #744210;
        }

        .status-badge.suspended {
            background: #fed7d7;
            color: #742a2a;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: #718096;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            font-size: 1.25rem;
            margin-bottom: 20px;
            color: #1a202c;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Color Picker */
        .color-picker-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-picker-group input[type="color"] {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .color-picker-group input[type="text"] {
            flex: 1;
        }

        /* Theme Preview */
        .theme-preview {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }

        .theme-preview-header {
            padding: 20px;
            color: white;
            text-align: center;
        }

        .theme-preview-body {
            padding: 20px;
            background: white;
        }

        .preview-button {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        /* Feature Toggles */
        .feature-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .feature-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f7fafc;
            border-radius: 6px;
        }

        .feature-toggle label {
            font-weight: 500;
            color: #4a5568;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e0;
            transition: .4s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4f46e5;
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 0.875rem;
            color: #718096;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
        }

        .stat-limit {
            font-size: 0.75rem;
            color: #a0aec0;
            margin-top: 4px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background: #4338ca;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .form-row,
            .stats-grid,
            .feature-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- SECURITY: Include centralized security utilities -->
    <script src="/static/js/security-utils.js"></script>
    <!-- Header -->
    <div class="header">
        <h1>{{ icon('building-office') }} Tenant Management</h1>
        <div class="header-actions">
            <button onclick="openCreateTenantModal()" aria-label="Create new tenant">{{ icon('plus') }} Create New Tenant</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar: Tenant List -->
        <div class="sidebar">
            <div class="sidebar-section">
                <h3>Filter</h3>
                <select id="statusFilter" onchange="filterTenants()">
                    <option value="">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="trial">Trial</option>
                    <option value="suspended">Suspended</option>
                </select>
            </div>

            <div class="sidebar-section">
                <h3>Tenants</h3>
                <ul class="tenant-list" id="tenantList">
                    <li class="loading">
                        <div class="spinner"></div>
                        Loading tenants...
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div id="noSelection" class="loading">
                <p>Select a tenant from the sidebar to view details</p>
            </div>

            <div id="tenantDetails" style="display: none;">
                <!-- Stats Overview -->
                <div class="stats-grid" id="statsGrid">
                    <!-- Populated dynamically -->
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('info')">{{ icon('clipboard-document-list') }} Info</div>
                    <div class="tab" onclick="switchTab('branding')">ðŸŽ¨ Branding</div>
                    <div class="tab" onclick="switchTab('features')">{{ icon('cog-6-tooth') }} Features</div>
                    <div class="tab" onclick="switchTab('domain')">{{ icon('globe-alt') }} Custom Domain</div>
                </div>

                <!-- Tab: Info -->
                <div id="tab-info" class="tab-content active">
                    <div class="card">
                        <h2>Tenant Information</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tenantName">Tenant Name</label>
                                <input type="text" id="tenantName" />
                            </div>
                            <div class="form-group">
                                <label for="tenantStatus">Status</label>
                                <select id="tenantStatus">
                                    <option value="active">Active</option>
                                    <option value="trial">Trial</option>
                                    <option value="suspended">Suspended</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="adminEmail">Admin Email</label>
                                <input type="email" id="adminEmail" />
                            </div>
                            <div class="form-group">
                                <label for="subscriptionTier">Subscription Tier</label>
                                <select id="subscriptionTier">
                                    <option value="free">Free</option>
                                    <option value="starter">Starter</option>
                                    <option value="professional">Professional</option>
                                    <option value="enterprise">Enterprise</option>
                                    <option value="white_label">White Label</option>
                                </select>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="saveBasicInfo()">Save Changes</button>
                    </div>
                </div>

                <!-- Tab: Branding -->
                <div id="tab-branding" class="tab-content">
                    <div class="card">
                        <h2>Visual Branding</h2>

                        <div class="form-group">
                            <label for="platformName">Platform Name</label>
                            <input type="text" id="platformName" placeholder="e.g., TaxPro Online" />
                        </div>

                        <div class="form-group">
                            <label for="companyName">Company Name</label>
                            <input type="text" id="companyName" placeholder="e.g., Smith & Associates, CPAs" />
                        </div>

                        <div class="form-group">
                            <label for="tagline">Tagline</label>
                            <input type="text" id="tagline" placeholder="e.g., Professional Tax Filing Made Simple" />
                        </div>

                        <h3 style="margin: 30px 0 15px;">Theme Colors</h3>

                        <div class="form-group">
                            <label for="themePreset">Theme Preset</label>
                            <select id="themePreset" onchange="applyThemePreset()">
                                <option value="custom">Custom</option>
                                <option value="professional_blue">Professional Blue</option>
                                <option value="modern_green">Modern Green</option>
                                <option value="corporate_gray">Corporate Gray</option>
                                <option value="boutique_purple">Boutique Purple</option>
                                <option value="classic_navy">Classic Navy</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="primaryColor">Primary Color</label>
                                <div class="color-picker-group">
                                    <input type="color" id="primaryColor" onchange="updateColorInput('primary')" />
                                    <input type="text" id="primaryColorText" value="#4f46e5" oninput="updateColorPicker('primary')" aria-label="Primary color hex value" />
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="secondaryColor">Secondary Color</label>
                                <div class="color-picker-group">
                                    <input type="color" id="secondaryColor" onchange="updateColorInput('secondary')" />
                                    <input type="text" id="secondaryColorText" value="#7c3aed" oninput="updateColorPicker('secondary')" aria-label="Secondary color hex value" />
                                </div>
                            </div>
                        </div>

                        <!-- Live Preview -->
                        <h3 style="margin: 30px 0 15px;">Live Preview</h3>
                        <div class="theme-preview" id="themePreview">
                            <div class="theme-preview-header" id="previewHeader">
                                <h2 id="previewPlatformName">Tax Filing Platform</h2>
                                <p id="previewTagline">Professional Tax Filing Made Simple</p>
                            </div>
                            <div class="theme-preview-body">
                                <button class="preview-button" id="previewPrimary">Primary Button</button>
                                <button class="preview-button" id="previewSecondary">Secondary Button</button>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="saveBranding()">Save Branding</button>
                            <button class="btn btn-secondary" onclick="resetBranding()">Reset to Defaults</button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Features -->
                <div id="tab-features" class="tab-content">
                    <div class="card">
                        <h2>Feature Flags</h2>

                        <h3 style="margin-bottom: 15px;">Core Features</h3>
                        <div class="feature-list" id="coreFeatures">
                            <!-- Populated dynamically -->
                        </div>

                        <h3 style="margin: 30px 0 15px;">Advanced Features</h3>
                        <div class="feature-list" id="advancedFeatures">
                            <!-- Populated dynamically -->
                        </div>

                        <h3 style="margin: 30px 0 15px;">Usage Limits</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Max Returns Per Month</label>
                                <input type="number" id="maxReturns" placeholder="Unlimited if empty" />
                            </div>
                            <div class="form-group">
                                <label>Max CPAs</label>
                                <input type="number" id="maxCPAs" placeholder="Unlimited if empty" />
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="saveFeatures()">Save Features</button>
                    </div>
                </div>

                <!-- Tab: Custom Domain -->
                <div id="tab-domain" class="tab-content">
                    <div class="card">
                        <h2>Custom Domain</h2>

                        <div class="form-group">
                            <label>Domain</label>
                            <input type="text" id="customDomain" placeholder="e.g., tax.yourfirm.com" />
                        </div>

                        <div id="domainVerification" style="display: none; background: #fff5f5; padding: 15px; border-radius: 6px; margin: 20px 0;">
                            <h4 style="color: #c53030; margin-bottom: 10px;">{{ icon('exclamation-triangle') }} Domain Not Verified</h4>
                            <p style="font-size: 0.875rem; color: #742a2a;">Add this TXT record to your DNS:</p>
                            <code style="display: block; background: white; padding: 10px; margin: 10px 0; border-radius: 4px;">
                                tax-domain-verification=<span id="verificationToken"></span>
                            </code>
                            <button class="btn btn-primary" onclick="verifyDomain()">Verify Now</button>
                        </div>

                        <button class="btn btn-primary" onclick="saveDomain()">Save Domain</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Tenant Modal -->
    <div id="createTenantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Tenant</h2>
                <button class="close-btn" onclick="closeCreateTenantModal()" aria-label="Close modal">&times;</button>
            </div>

            <div class="form-group">
                <label>Tenant Name *</label>
                <input type="text" id="newTenantName" placeholder="e.g., Smith Tax Services" />
            </div>

            <div class="form-group">
                <label>Admin Email *</label>
                <input type="email" id="newAdminEmail" placeholder="admin@example.com" />
            </div>

            <div class="form-group">
                <label>Subscription Tier</label>
                <select id="newSubscriptionTier">
                    <option value="free">Free</option>
                    <option value="starter">Starter</option>
                    <option value="professional" selected>Professional</option>
                    <option value="enterprise">Enterprise</option>
                    <option value="white_label">White Label</option>
                </select>
            </div>

            <div class="form-group">
                <label>Theme Preset</label>
                <select id="newThemePreset">
                    <option value="professional_blue">Professional Blue</option>
                    <option value="modern_green">Modern Green</option>
                    <option value="corporate_gray">Corporate Gray</option>
                    <option value="boutique_purple">Boutique Purple</option>
                    <option value="classic_navy">Classic Navy</option>
                </select>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="createTenant()">Create Tenant</button>
                <button class="btn btn-secondary" onclick="closeCreateTenantModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // SECURITY: HTML Escaping to Prevent XSS
        // =================================================================
        const HTML_ENTITIES = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#x27;',
            '/': '&#x2F;',
            '`': '&#x60;',
            '=': '&#x3D;'
        };

        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/[&<>"'`=\/]/g, char => HTML_ENTITIES[char]);
        }

        // Sanitize ID (alphanumeric and underscore only)
        function sanitizeId(id) {
            if (!id) return '';
            return String(id).replace(/[^a-zA-Z0-9_-]/g, '');
        }

        // Validate status against whitelist
        function validateStatus(status) {
            const validStatuses = ['active', 'trial', 'suspended', 'cancelled'];
            return validStatuses.includes(status) ? status : 'unknown';
        }

        // Validate subscription tier against whitelist
        function validateTier(tier) {
            const validTiers = ['free', 'starter', 'professional', 'enterprise', 'white_label'];
            return validTiers.includes(tier) ? tier : 'unknown';
        }

        // Safely display number
        function safeNumber(num, fallback = '-') {
            const n = Number(num);
            return isNaN(n) ? escapeHtml(fallback) : n;
        }

        // =================================================================
        // State
        // =================================================================
        let currentTenantId = null;
        let tenants = [];

        // Load tenants on page load
        window.addEventListener('DOMContentLoaded', loadTenants);

        async function loadTenants() {
            try {
                // SECURITY: Use secureFetch with timeout handling
                const response = await SecurityUtils.secureFetch('/api/admin/tenants/');
                tenants = await response.json();

                const tenantList = document.getElementById('tenantList');
                tenantList.innerHTML = '';

                tenants.forEach(tenant => {
                    const li = document.createElement('li');
                    li.className = 'tenant-item';
                    // SECURITY: Store tenant_id in data attribute for safe retrieval
                    li.dataset.tenantId = sanitizeId(tenant.tenant_id);

                    // SECURITY: Escape all user-controlled strings
                    const safeName = escapeHtml(tenant.tenant_name);
                    const safeStatus = validateStatus(tenant.status);
                    const safeTier = escapeHtml(tenant.subscription_tier);
                    const safeCpas = safeNumber(tenant.total_cpas, '0');
                    const safeClients = safeNumber(tenant.total_clients, '0');

                    li.innerHTML = `
                        <div class="tenant-name">
                            ${safeName}
                            <span class="status-badge ${safeStatus}">${safeStatus}</span>
                        </div>
                        <div class="tenant-meta">
                            ${safeTier} â€¢ ${safeCpas} CPAs â€¢ ${safeClients} clients
                        </div>
                    `;

                    // SECURITY: Use event listener instead of inline onclick
                    li.addEventListener('click', function() {
                        selectTenant(this.dataset.tenantId);
                    });

                    tenantList.appendChild(li);
                });

            } catch (error) {
                console.error('Failed to load tenants:', error);
                document.getElementById('tenantList').innerHTML = '<li style="padding: 20px; color: red;">Failed to load tenants</li>';
            }
        }

        async function selectTenant(tenantId) {
            // SECURITY: Sanitize tenantId
            currentTenantId = sanitizeId(tenantId);

            // Update sidebar selection
            document.querySelectorAll('.tenant-item').forEach(item => {
                item.classList.remove('active');
                // Find item with matching tenant ID and mark active
                if (item.dataset.tenantId === currentTenantId) {
                    item.classList.add('active');
                }
            });

            // Show tenant details
            document.getElementById('noSelection').style.display = 'none';
            document.getElementById('tenantDetails').style.display = 'block';

            // Load tenant data
            try {
                const response = await SecurityUtils.secureFetch(`/api/admin/tenants/${encodeURIComponent(tenantId)}`);
                const tenant = await response.json();

                // SECURITY: Escape all values before inserting into HTML
                const safeReturns = safeNumber(tenant.total_returns, '0');
                const safeCpas = safeNumber(tenant.total_cpas, '0');
                const safeClients = safeNumber(tenant.total_clients, '0');
                const safeStorage = safeNumber(tenant.storage_used_gb?.toFixed(1), '0');
                const safeMaxReturns = tenant.features?.max_returns_per_month ? safeNumber(tenant.features.max_returns_per_month) : 'âˆž';
                const safeMaxCpas = tenant.features?.max_cpas ? safeNumber(tenant.features.max_cpas) : 'âˆž';
                const safeMaxStorage = tenant.features?.max_storage_gb ? safeNumber(tenant.features.max_storage_gb) : 'âˆž';

                // Populate stats
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Total Returns</div>
                        <div class="stat-value">${safeReturns}</div>
                        <div class="stat-limit">Limit: ${safeMaxReturns}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">CPAs</div>
                        <div class="stat-value">${safeCpas}</div>
                        <div class="stat-limit">Limit: ${safeMaxCpas}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Clients</div>
                        <div class="stat-value">${safeClients}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Storage</div>
                        <div class="stat-value">${safeStorage} GB</div>
                        <div class="stat-limit">Limit: ${safeMaxStorage} GB</div>
                    </div>
                `;

                // Populate forms
                document.getElementById('tenantName').value = tenant.tenant_name;
                document.getElementById('tenantStatus').value = tenant.status;
                document.getElementById('adminEmail').value = tenant.admin_email;
                document.getElementById('subscriptionTier').value = tenant.subscription_tier;

                // Branding
                document.getElementById('platformName').value = tenant.branding.platform_name;
                document.getElementById('companyName').value = tenant.branding.company_name;
                document.getElementById('tagline').value = tenant.branding.tagline;
                document.getElementById('primaryColorText').value = tenant.branding.primary_color;
                document.getElementById('primaryColor').value = tenant.branding.primary_color;
                document.getElementById('secondaryColorText').value = tenant.branding.secondary_color;
                document.getElementById('secondaryColor').value = tenant.branding.secondary_color;

                updatePreview();

                // Features
                populateFeatures(tenant.features);

                // Domain
                if (tenant.custom_domain) {
                    document.getElementById('customDomain').value = tenant.custom_domain;
                }

            } catch (error) {
                console.error('Failed to load tenant details:', error);
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.currentTarget.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function updateColorInput(type) {
            const colorPicker = document.getElementById(`${type}Color`);
            const colorText = document.getElementById(`${type}ColorText`);
            colorText.value = colorPicker.value;
            updatePreview();
        }

        function updateColorPicker(type) {
            const colorPicker = document.getElementById(`${type}Color`);
            const colorText = document.getElementById(`${type}ColorText`);
            colorPicker.value = colorText.value;
            updatePreview();
        }

        function updatePreview() {
            const platformName = document.getElementById('platformName').value;
            const tagline = document.getElementById('tagline').value;
            const primaryColor = document.getElementById('primaryColorText').value;
            const secondaryColor = document.getElementById('secondaryColorText').value;

            document.getElementById('previewPlatformName').textContent = platformName || 'Tax Filing Platform';
            document.getElementById('previewTagline').textContent = tagline || 'Professional Tax Filing Made Simple';
            document.getElementById('previewHeader').style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${secondaryColor} 100%)`;
            document.getElementById('previewPrimary').style.background = primaryColor;
            document.getElementById('previewSecondary').style.background = secondaryColor;
        }

        async function saveBranding() {
            try {
                // SECURITY: Use secureFetch with CSRF token for state-changing operation
                const response = await SecurityUtils.secureFetch(`/api/admin/tenants/${encodeURIComponent(currentTenantId)}/branding`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        platform_name: document.getElementById('platformName').value,
                        company_name: document.getElementById('companyName').value,
                        tagline: document.getElementById('tagline').value,
                        primary_color: document.getElementById('primaryColorText').value,
                        secondary_color: document.getElementById('secondaryColorText').value,
                    })
                });

                if (response.ok) {
                    alert('Branding saved successfully!');
                } else {
                    alert('Failed to save branding');
                }

            } catch (error) {
                console.error('Error saving branding:', error);
                alert('Error saving branding');
            }
        }

        function populateFeatures(features) {
            const coreFeatures = document.getElementById('coreFeatures');
            const advancedFeatures = document.getElementById('advancedFeatures');

            // Core features
            coreFeatures.innerHTML = `
                ${createFeatureToggle('Express Lane', 'express_lane_enabled', features.express_lane_enabled)}
                ${createFeatureToggle('Smart Tax', 'smart_tax_enabled', features.smart_tax_enabled)}
                ${createFeatureToggle('AI Chat', 'ai_chat_enabled', features.ai_chat_enabled)}
                ${createFeatureToggle('Guided Forms', 'guided_forms_enabled', features.guided_forms_enabled)}
            `;

            // Advanced features
            advancedFeatures.innerHTML = `
                ${createFeatureToggle('Scenario Explorer', 'scenario_explorer_enabled', features.scenario_explorer_enabled)}
                ${createFeatureToggle('Tax Projections', 'tax_projections_enabled', features.tax_projections_enabled)}
                ${createFeatureToggle('QuickBooks Integration', 'quickbooks_integration', features.quickbooks_integration)}
                ${createFeatureToggle('Custom Domain', 'custom_domain_enabled', features.custom_domain_enabled)}
            `;

            // Limits
            document.getElementById('maxReturns').value = features.max_returns_per_month || '';
            document.getElementById('maxCPAs').value = features.max_cpas || '';
        }

        function createFeatureToggle(label, id, checked) {
            // SECURITY: Escape label and sanitize id to prevent XSS
            const safeLabel = escapeHtml(label);
            const safeId = sanitizeId(id);
            // Validate checked as boolean
            const isChecked = checked === true;

            return `
                <div class="feature-toggle">
                    <label>${safeLabel}</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="${safeId}" ${isChecked ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                </div>
            `;
        }

        // Focus trap state for accessibility
        let tenantModalPreviousFocus = null;
        let tenantModalFocusTrap = null;

        function openCreateTenantModal() {
            const modal = document.getElementById('createTenantModal');
            modal.classList.add('show');

            // Store previous focus
            tenantModalPreviousFocus = document.activeElement;

            // Set up focus trap
            const focusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            if (firstFocusable) {
                setTimeout(() => firstFocusable.focus(), 50);
            }

            tenantModalFocusTrap = (e) => {
                if (e.key === 'Tab') {
                    if (e.shiftKey && document.activeElement === firstFocusable) {
                        e.preventDefault();
                        lastFocusable.focus();
                    } else if (!e.shiftKey && document.activeElement === lastFocusable) {
                        e.preventDefault();
                        firstFocusable.focus();
                    }
                }
                if (e.key === 'Escape') {
                    closeCreateTenantModal();
                }
            };

            document.addEventListener('keydown', tenantModalFocusTrap);
        }

        function closeCreateTenantModal() {
            document.getElementById('createTenantModal').classList.remove('show');

            // Clean up focus trap
            if (tenantModalFocusTrap) {
                document.removeEventListener('keydown', tenantModalFocusTrap);
                tenantModalFocusTrap = null;
            }
            if (tenantModalPreviousFocus) {
                tenantModalPreviousFocus.focus();
                tenantModalPreviousFocus = null;
            }
        }

        async function createTenant() {
            try {
                // SECURITY: Use secureFetch with CSRF token for state-changing operation
                const response = await SecurityUtils.secureFetch('/api/admin/tenants/', {
                    method: 'POST',
                    body: JSON.stringify({
                        tenant_name: document.getElementById('newTenantName').value,
                        admin_email: document.getElementById('newAdminEmail').value,
                        subscription_tier: document.getElementById('newSubscriptionTier').value,
                        theme_preset: document.getElementById('newThemePreset').value,
                    })
                });

                if (response.ok) {
                    alert('Tenant created successfully!');
                    closeCreateTenantModal();
                    loadTenants();
                } else {
                    alert('Failed to create tenant');
                }

            } catch (error) {
                console.error('Error creating tenant:', error);
                alert('Error creating tenant');
            }
        }

        // Listen for input changes on branding fields
        ['platformName', 'tagline'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePreview);
        });
    </script>
</body>
</html>
