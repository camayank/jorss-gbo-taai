{% from 'macros/icons.html' import icon %}
<!DOCTYPE html>
<html lang="en" data-theme="advisor">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token() if csrf_token else '' }}">
  <title>Premium Tax Advisory | Individual Tax Strategy</title>

  <!-- Preconnect for performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Core CSS -->
  <link rel="stylesheet" href="/static/css/core/variables.css">
  <link rel="stylesheet" href="/static/css/core/reset.css">
  <link rel="stylesheet" href="/static/css/core/typography.css">
  <link rel="stylesheet" href="/static/css/core/layout.css">
  <link rel="stylesheet" href="/static/css/core/animations.css">

  <!-- Component CSS -->
  <link rel="stylesheet" href="/static/css/components/buttons.css">
  <link rel="stylesheet" href="/static/css/components/cards.css">
  <link rel="stylesheet" href="/static/css/components/forms.css">
  <link rel="stylesheet" href="/static/css/components/modals.css">
  <link rel="stylesheet" href="/static/css/components/toast.css">

  <!-- Theme CSS -->
  <link rel="stylesheet" href="/static/css/themes/advisor.css">

  <!-- Page-specific CSS -->
  <link rel="stylesheet" href="/static/css/pages/advisor.css">

  <style>
    /* Critical inline styles for advisor-specific UI */
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--color-primary-500);
      color: white;
      padding: 8px;
      z-index: 100;
    }

    .skip-link:focus {
      top: 0;
    }

    .offline-banner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: var(--space-3);
      background: var(--color-warning-500);
      color: white;
      text-align: center;
      z-index: 1000;
    }

    .offline-banner.visible {
      display: block;
    }

    /* Consent Modal */
    .consent-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
    }

    .consent-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .consent-content {
      background: white;
      border-radius: var(--radius-xl);
      max-width: 500px;
      width: 90%;
      padding: var(--space-8);
      box-shadow: var(--shadow-xl);
    }

    .consent-item {
      display: flex;
      gap: var(--space-3);
      padding: var(--space-3) 0;
      font-size: var(--text-sm);
    }

    .consent-item.warning {
      background: var(--color-warning-100);
      padding: var(--space-3);
      border-radius: var(--radius-lg);
      margin: var(--space-4) 0;
    }

    .consent-checkbox {
      display: flex;
      gap: var(--space-2);
      margin: var(--space-4) 0;
      font-size: var(--text-sm);
      cursor: pointer;
    }

    .consent-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: var(--space-6);
    }

    .consent-link {
      font-size: var(--text-sm);
      color: var(--color-primary-600);
    }

    .consent-btn {
      padding: var(--space-3) var(--space-6);
      background: var(--color-primary-600);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      font-weight: var(--font-semibold);
      cursor: pointer;
    }

    .consent-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Header */
    .advisor-header {
      padding: var(--space-5) var(--space-8);
      background: var(--color-primary-900);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .clear-chat-btn {
      padding: var(--space-2) var(--space-4);
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-lg);
      color: white;
      font-size: var(--text-sm);
      cursor: pointer;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-full);
      color: white;
      font-size: var(--text-sm);
    }

    /* Journey Stepper */
    .journey-stepper {
      display: flex;
      justify-content: center;
      gap: var(--space-8);
      padding: var(--space-4);
      background: var(--color-gray-50);
      border-bottom: 1px solid var(--color-gray-200);
    }

    .journey-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-2);
      opacity: 0.5;
    }

    .journey-step.active {
      opacity: 1;
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--color-gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .journey-step.active .step-icon {
      background: var(--color-primary-500);
      color: white;
    }

    .step-label {
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
    }

    .phase-indicator {
      text-align: center;
      padding: var(--space-2);
      font-size: var(--text-sm);
      color: var(--color-gray-600);
    }

    /* AI Disclaimer Banner */
    .ai-disclaimer-banner {
      padding: var(--space-3) var(--space-4);
      background: var(--color-gray-50);
      border-bottom: 1px solid var(--color-gray-200);
      font-size: var(--text-xs);
    }

    .disclaimer-item {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-2);
    }

    .disclaimer-item:last-child {
      margin-bottom: 0;
    }

    /* Side Panel */
    .side-panel {
      width: 320px;
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    @media (max-width: 1024px) {
      .side-panel {
        display: none;
      }
    }

    .panel-card {
      background: white;
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-xl);
      overflow: hidden;
    }

    .panel-header {
      padding: var(--space-4);
      background: var(--color-gray-50);
      border-bottom: 1px solid var(--color-gray-200);
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .upload-zone {
      padding: var(--space-8);
      text-align: center;
      border: 2px dashed var(--color-gray-300);
      margin: var(--space-4);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .upload-zone:hover {
      border-color: var(--color-primary-400);
      background: var(--color-primary-50);
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      margin-top: var(--space-4);
    }

    .quick-action {
      padding: var(--space-3) var(--space-4);
      background: var(--color-gray-100);
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .quick-action:hover {
      background: var(--color-primary-50);
      border-color: var(--color-primary-200);
    }

    .quick-action.primary {
      background: var(--color-primary-500);
      color: white;
      border-color: var(--color-primary-500);
    }

    .quick-action.primary:hover {
      background: var(--color-primary-600);
    }

    /* Input Area */
    .input-area {
      padding: var(--space-4) var(--space-6);
      border-top: 1px solid var(--color-gray-200);
      background: var(--color-gray-50);
      display: flex;
      gap: var(--space-3);
    }

    .input-wrapper {
      flex: 1;
    }

    .input-box {
      display: flex;
      align-items: center;
      background: white;
      border: 1px solid var(--color-gray-300);
      border-radius: var(--radius-xl);
      padding: var(--space-2) var(--space-3);
    }

    .input-box:focus-within {
      border-color: var(--color-primary-500);
      box-shadow: 0 0 0 3px var(--color-primary-100);
    }

    .input-box textarea {
      flex: 1;
      border: none;
      outline: none;
      resize: none;
      font-size: var(--text-sm);
      padding: var(--space-2);
      max-height: 120px;
    }

    .action-btns {
      display: flex;
      gap: var(--space-2);
    }

    .icon-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      border-radius: 50%;
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .icon-btn:hover {
      background: var(--color-gray-100);
    }

    /* Insight Card */
    .insight-card {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
    }

    .insight-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
      margin-bottom: var(--space-2);
    }

    .savings-amount {
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      color: var(--color-success-500);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
      padding: var(--space-4);
    }

    /* Message Styles */
    .message {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--color-primary-600), var(--color-primary-800));
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .message.user .avatar {
      background: var(--color-gray-300);
      color: var(--color-gray-700);
    }

    .bubble {
      max-width: 80%;
      padding: var(--space-4);
      background: white;
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-xl);
      font-size: var(--text-sm);
      line-height: 1.6;
    }

    .message.user .bubble {
      background: var(--color-primary-600);
      color: white;
      border-color: var(--color-primary-600);
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
    }

    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--color-gray-200);
      border-top-color: var(--color-primary-500);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      margin-top: var(--space-4);
      font-weight: var(--font-semibold);
    }

    .loading-subtext {
      color: var(--color-gray-500);
      font-size: var(--text-sm);
    }
  </style>
</head>
<body>
  <!-- Skip link for keyboard navigation -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Offline Detection Banner -->
  <div class="offline-banner" id="offlineBanner" role="alert" aria-live="assertive">
    {{ icon('exclamation-triangle') }} You're offline. Your messages will be sent when connection is restored.
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay" role="alert" aria-live="polite">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Analyzing your tax situation...</div>
    <div class="loading-subtext" id="loadingSubtext">This may take a few moments</div>
  </div>

  <div class="bg-animated" aria-hidden="true"></div>

  <header class="advisor-header" role="banner">
    <div>
      <div class="advisor-logo">JORSS-GBO Tax Advisory</div>
      <div class="advisor-logo-subtitle">AI-Powered Wealth Strategy</div>
    </div>
    <div class="header-right">
      <button class="clear-chat-btn" onclick="clearConversation()" title="Start new conversation" aria-label="Start new conversation">
        {{ icon('arrow-path') }} New Chat
      </button>
      <div class="connection-status" id="connectionStatus" role="status" aria-live="polite">
        <span class="status-dot" id="connectionDot"></span>
        <span id="connectionText">Connected</span>
      </div>
    </div>
  </header>

  <!-- Data Collection Consent Modal -->
  <div class="consent-modal" id="consentModal" role="dialog" aria-modal="true" aria-labelledby="consentTitle">
    <div class="consent-content">
      <h2 id="consentTitle">{{ icon('clipboard-document-list') }} Before We Begin</h2>
      <div class="consent-body">
        <p><strong>This AI assistant will collect personal tax information to provide guidance.</strong></p>

        <div class="consent-item">
          <span class="consent-icon">{{ icon('lock-closed') }}</span>
          <span><strong>Data Security:</strong> All information is encrypted (AES-256) in transit and at rest.</span>
        </div>

        <div class="consent-item">
          <span class="consent-icon">{{ icon('clock') }}</span>
          <span><strong>Data Retention:</strong> Your session data is automatically deleted after 30 days of inactivity.</span>
        </div>

        <div class="consent-item">
          <span class="consent-icon">{{ icon('x-circle') }}</span>
          <span><strong>No Selling:</strong> We never sell or share your personal information with third parties.</span>
        </div>

        <div class="consent-item warning">
          <span class="consent-icon">{{ icon('exclamation-triangle') }}</span>
          <span><strong>IRS Circular 230 Notice:</strong> This AI provides general guidance only, NOT professional tax advice. For complex tax situations, always consult a licensed CPA, EA, or tax attorney.</span>
        </div>

        <label class="consent-checkbox">
          <input type="checkbox" id="dataConsent" required onchange="document.getElementById('acceptConsentBtn').disabled = !this.checked;">
          <span>I understand and consent to the collection of my tax information for advisory purposes.</span>
        </label>
      </div>

      <div class="consent-actions">
        <a href="/privacy" target="_blank" class="consent-link">Privacy Policy</a>
        <a href="/terms" target="_blank" class="consent-link">Terms of Service</a>
        <button class="consent-btn" id="acceptConsentBtn" disabled onclick="acceptConsent();">
          {{ icon('check') }} Accept & Continue
        </button>
      </div>
    </div>
  </div>

  <main class="advisor-main" id="main-content" role="main">
    <div class="chat-panel">
      <!-- AI Disclaimer Banner -->
      <div class="ai-disclaimer-banner" role="alert">
        <div class="disclaimer-item">
          <span class="disclaimer-icon">{{ icon('chat-bubble-left-right') }}</span>
          <span><strong>AI Assistant:</strong> I provide estimates and general guidance, not professional tax advice. Always verify with a licensed CPA or tax professional.</span>
        </div>
        <div class="disclaimer-item">
          <span class="disclaimer-icon">{{ icon('lock-closed') }}</span>
          <span><strong>Privacy:</strong> Your data is encrypted and never sold. <a href="/privacy" style="color: var(--color-primary-600);">Privacy Policy</a></span>
        </div>
      </div>

      <!-- Journey Progress Stepper -->
      <div class="journey-stepper" id="journeyStepper" role="navigation" aria-label="Tax advisory progress">
        <div class="journey-step active" data-step="1" id="step-1">
          <div class="step-icon">{{ icon('clipboard-document-list') }}</div>
          <div class="step-label">Profile</div>
        </div>
        <div class="journey-step" data-step="2" id="step-2">
          <div class="step-icon">{{ icon('banknotes') }}</div>
          <div class="step-label">Income</div>
        </div>
        <div class="journey-step" data-step="3" id="step-3">
          <div class="step-icon">{{ icon('sparkles') }}</div>
          <div class="step-label">Analysis</div>
        </div>
        <div class="journey-step" data-step="4" id="step-4">
          <div class="step-icon">{{ icon('chart-bar') }}</div>
          <div class="step-label">Report</div>
        </div>
      </div>

      <!-- Current Phase Label -->
      <div class="phase-indicator" id="phaseIndicator">
        <span class="phase-label" id="currentPhaseLabel">Getting Started</span>
      </div>

      <div class="messages" id="messages" role="log" aria-live="polite" aria-label="Conversation with AI tax advisor">
        <!-- Welcome message -->
        <div class="message ai" role="article" aria-label="AI assistant message">
          <div class="avatar" aria-hidden="true">{{ icon('building-office') }}</div>
          <div class="bubble">
            <div style="margin-bottom: 16px;">
              <span style="font-size: 24px; font-weight: 700; color: var(--color-primary-600);">Welcome to Your Tax Advisory Session</span>
            </div>
            I'm your AI-powered tax strategist, trained on thousands of tax scenarios to help you <strong>maximize savings</strong> and <strong>minimize liability</strong>.
            <div class="insight-card" style="margin: 16px 0; background: var(--color-primary-50); border-color: var(--color-primary-200);">
              <div class="insight-header">
                <span>{{ icon('chart-bar') }}</span>
                <span>Average Client Savings</span>
              </div>
              <div class="savings-amount">$4,200 - $12,500</div>
              <div style="font-size: 13px; color: var(--color-gray-600); margin-top: 8px;">per year through strategic tax planning</div>
            </div>
            <strong>How would you like to begin?</strong>
            <div class="quick-actions" id="initialQuickActions" role="group" aria-label="Quick response options">
              <button class="quick-action primary" data-action="no_manual" aria-label="Start guided analysis">Start Guided Analysis â†’</button>
              <button class="quick-action" data-action="yes_upload" aria-label="Upload tax documents">Upload Documents</button>
              <button class="quick-action" data-action="what_docs" aria-label="Learn more about the process">Learn More</button>
            </div>
          </div>
        </div>
      </div>

      <div class="input-area" role="form" aria-label="Send a message to AI advisor">
        <div class="input-wrapper">
          <label for="userInput" class="sr-only">Type your message or question about taxes</label>
          <div class="input-box">
            <textarea
              id="userInput"
              placeholder="Share your questions or financial situation with me..."
              rows="1"
              onkeydown="handleKeyDown(event)"
              aria-label="Type your message or question about taxes"
            ></textarea>
            <div class="action-btns">
              <button class="icon-btn" onclick="uploadDocument()" title="Upload Document" aria-label="Upload a tax document">
                {{ icon('paper-clip') }}
              </button>
              <button class="icon-btn" onclick="addVoiceInput()" title="Voice Input" aria-label="Use voice input">
                {{ icon('microphone') }}
              </button>
            </div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="sendMessage()" id="sendBtn">Send</button>
      </div>
    </div>

    <div class="side-panel">
      <div class="panel-card">
        <div class="panel-header">{{ icon('chart-bar') }} Advisory Progress</div>
        <div style="padding: var(--space-4);">
          <div class="progress-bar" style="height: 8px; background: var(--color-gray-200); border-radius: var(--radius-full); overflow: hidden;">
            <div class="progress-fill" id="progressFill" style="width: 0%; height: 100%; background: var(--color-primary-500);"></div>
          </div>
          <div style="text-align: center; font-size: 13px; color: var(--color-gray-600); margin-top: var(--space-2);">
            <span id="progressText">Not started</span>
          </div>
        </div>
        <div class="stats-grid" id="statsGrid">
          <!-- Stats will be populated dynamically -->
        </div>
      </div>

      <div class="panel-card">
        <div class="panel-header">{{ icon('light-bulb') }} Strategic Recommendations</div>
        <div id="insights" style="padding: var(--space-4); font-size: 14px; color: var(--color-gray-600);">
          I'll share personalized recommendations as we review your financial situation...
        </div>
      </div>

      <div class="panel-card" id="uploadPanel">
        <div class="panel-header">{{ icon('folder') }} Quick Upload</div>
        <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
          <div style="font-size: 32px; margin-bottom: 8px;">{{ icon('document-text') }}</div>
          <div style="font-size: 14px; margin-bottom: 4px;">Drop documents here</div>
          <div style="font-size: 12px; color: var(--color-gray-500);">or click to browse</div>
        </div>
        <input type="file" id="fileInput" style="display: none" onchange="handleFileSelect(event)" accept=".pdf,.jpg,.jpeg,.png" multiple aria-label="Upload tax documents">
      </div>
    </div>
  </main>

  <!-- Core JavaScript -->
  <script src="/static/js/core/utils.js" type="module"></script>
  <script src="/static/js/core/api.js" type="module"></script>

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>

  <script>
    // Import utilities from module
    import('/static/js/core/utils.js').then(({ escapeHtml, formatCurrency, showToast, debounce }) => {
      window.escapeHtml = escapeHtml;
      window.formatCurrency = formatCurrency;
      window.showToast = showToast;
      window.debounce = debounce;
    });

    import('/static/js/core/api.js').then(({ api, getCSRFToken }) => {
      window.api = api;
      window.getCSRFToken = getCSRFToken;
    });

    // State
    let sessionId = null;
    let conversationHistory = [];
    let currentStep = 1;

    // Check consent
    function checkConsent() {
      const hasConsent = localStorage.getItem('tax_advisor_consent');
      if (!hasConsent) {
        document.getElementById('consentModal').classList.add('active');
      }
    }

    function acceptConsent() {
      localStorage.setItem('tax_advisor_consent', 'true');
      document.getElementById('consentModal').classList.remove('active');
      initSession();
    }

    // Initialize session
    async function initSession() {
      try {
        const response = await fetch('/api/advisor/session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': window.getCSRFToken?.() || '',
          },
        });
        const data = await response.json();
        if (data.session_id) {
          sessionId = data.session_id;
          localStorage.setItem('advisor_session_id', sessionId);
        }
      } catch (e) {
        console.error('Session init error:', e);
      }
    }

    // Handle keyboard input
    function handleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    // Send message
    async function sendMessage() {
      const input = document.getElementById('userInput');
      const message = input.value.trim();
      if (!message) return;

      // Add user message
      addMessage(message, 'user');
      input.value = '';

      // Disable send button
      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = true;

      try {
        // Show typing indicator
        showTypingIndicator();

        const response = await fetch('/api/advisor/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': window.getCSRFToken?.() || '',
          },
          body: JSON.stringify({
            session_id: sessionId,
            message: message,
          }),
        });

        const data = await response.json();
        hideTypingIndicator();

        if (data.response) {
          addMessage(data.response, 'ai');
        }

        // Update progress if provided
        if (data.progress) {
          updateProgress(data.progress);
        }

      } catch (e) {
        hideTypingIndicator();
        addMessage('Sorry, there was an error processing your request. Please try again.', 'ai');
      }

      sendBtn.disabled = false;
    }

    // Add message to chat
    function addMessage(content, type) {
      const messagesContainer = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.innerHTML = type === 'ai' ? '{{ icon("building-office") }}' : '{{ icon("user") }}';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = type === 'ai' ? content : window.escapeHtml?.(content) || content;

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(bubble);
      messagesContainer.appendChild(messageDiv);

      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Typing indicator
    function showTypingIndicator() {
      const messagesContainer = document.getElementById('messages');
      const indicator = document.createElement('div');
      indicator.className = 'message ai';
      indicator.id = 'typingIndicator';
      indicator.innerHTML = `
        <div class="avatar">{{ icon("building-office") }}</div>
        <div class="bubble" style="padding: 12px;">
          <div style="display: flex; gap: 4px;">
            <div class="typing-dot" style="animation: typingBounce 1.4s ease-in-out infinite;"></div>
            <div class="typing-dot" style="animation: typingBounce 1.4s ease-in-out 0.2s infinite;"></div>
            <div class="typing-dot" style="animation: typingBounce 1.4s ease-in-out 0.4s infinite;"></div>
          </div>
        </div>
      `;
      messagesContainer.appendChild(indicator);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function hideTypingIndicator() {
      const indicator = document.getElementById('typingIndicator');
      if (indicator) indicator.remove();
    }

    // Update progress
    function updateProgress(progress) {
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      if (progressFill) progressFill.style.width = `${progress}%`;
      if (progressText) progressText.textContent = `${progress}% complete`;

      // Update step indicators
      const step = Math.ceil(progress / 25);
      if (step !== currentStep) {
        currentStep = step;
        document.querySelectorAll('.journey-step').forEach((el, i) => {
          el.classList.toggle('active', i < step);
        });
      }
    }

    // Clear conversation
    function clearConversation() {
      if (confirm('Start a new conversation? This will clear the current chat.')) {
        document.getElementById('messages').innerHTML = '';
        conversationHistory = [];
        currentStep = 1;
        updateProgress(0);
        initSession();
        location.reload();
      }
    }

    // Upload document
    function uploadDocument() {
      document.getElementById('fileInput').click();
    }

    async function handleFileSelect(event) {
      const files = event.target.files;
      if (!files.length) return;

      for (const file of files) {
        window.showToast?.(`Uploading ${file.name}...`, 'info') || console.log(`Uploading ${file.name}`);

        const formData = new FormData();
        formData.append('file', file);
        formData.append('session_id', sessionId);

        try {
          const response = await fetch('/api/advisor/upload', {
            method: 'POST',
            headers: {
              'X-CSRF-Token': window.getCSRFToken?.() || '',
            },
            body: formData,
          });

          const data = await response.json();
          if (data.success) {
            window.showToast?.(`${file.name} uploaded successfully`, 'success');
            if (data.extracted_data) {
              addMessage(`I've analyzed ${file.name} and extracted relevant tax information.`, 'ai');
            }
          } else {
            window.showToast?.(`Failed to upload ${file.name}`, 'error');
          }
        } catch (e) {
          window.showToast?.(`Error uploading ${file.name}`, 'error');
        }
      }

      event.target.value = '';
    }

    // Voice input placeholder
    function addVoiceInput() {
      window.showToast?.('Voice input coming soon', 'info') || alert('Voice input coming soon');
    }

    // Quick action handlers
    document.querySelectorAll('.quick-action').forEach(btn => {
      btn.addEventListener('click', () => {
        const action = btn.dataset.action;
        if (action === 'no_manual') {
          document.getElementById('userInput').value = "I'd like to start the guided tax analysis";
          sendMessage();
        } else if (action === 'yes_upload') {
          uploadDocument();
        } else if (action === 'what_docs') {
          document.getElementById('userInput').value = "What documents do I need for tax planning?";
          sendMessage();
        }
        // Hide quick actions after use
        const quickActions = document.getElementById('initialQuickActions');
        if (quickActions) quickActions.style.display = 'none';
      });
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      checkConsent();

      // Check for existing session
      const existingSession = localStorage.getItem('advisor_session_id');
      if (existingSession) {
        sessionId = existingSession;
      }

      // Online/offline detection
      window.addEventListener('online', () => {
        document.getElementById('offlineBanner').classList.remove('visible');
        document.getElementById('connectionDot').style.background = 'var(--color-success-500)';
        document.getElementById('connectionText').textContent = 'Connected';
      });

      window.addEventListener('offline', () => {
        document.getElementById('offlineBanner').classList.add('visible');
        document.getElementById('connectionDot').style.background = 'var(--color-warning-500)';
        document.getElementById('connectionText').textContent = 'Offline';
      });
    });
  </script>
</body>
</html>
